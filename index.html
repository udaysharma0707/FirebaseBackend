<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Tile & Sanitaryware Inventory</title>

<!-- PWA Manifest -->
<link rel="manifest" href="manifest.json">

<!-- Theme Color -->
<meta name="theme-color" content="#1976D2">

<!-- Apple Touch Icon -->
<link rel="apple-touch-icon" href="icon-192.png">

<!-- Apple Mobile Web App Capable -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Inventory">

<!-- Firebase SDK -->
<script type="module">
  // Import Firebase modules
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
  import { 
    getAuth, 
    signInWithEmailAndPassword, 
    createUserWithEmailAndPassword, 
    onAuthStateChanged, 
    signOut,
    // ✅ NEW: Add these for password change
    EmailAuthProvider,
    reauthenticateWithCredential,
    updatePassword
  } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
  import { 
    getFirestore, 
    collection, 
    doc, 
    addDoc, 
    getDoc, 
    getDocs, 
    setDoc, 
    updateDoc, 
    deleteDoc, 
    query, 
    where, 
    orderBy, 
    limit 
  } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';
  
  // Your Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyAZ5gxZQIMVthFPlPh7pumEVZujBCqnWcY",
  authDomain: "tileinventoryapp.firebaseapp.com",
  projectId: "tileinventoryapp",
  storageBucket: "tileinventoryapp.firebasestorage.app",
  messagingSenderId: "593200886238",
  appId: "1:593200886238:web:ca118d33b30a667fb56d4f"
  };
  
  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  
  // Make available globally
  window.auth = auth;
  window.db = db;
  window.firebaseImports = {
    collection, 
    doc, 
    addDoc, 
    getDoc, 
    getDocs, 
    setDoc, 
    updateDoc, 
    deleteDoc, 
    query, 
    where, 
    orderBy, 
    limit,
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    onAuthStateChanged,
    signOut,
    // ✅ NEW: Make password functions available globally
    EmailAuthProvider,
    reauthenticateWithCredential,
    updatePassword
  };
  
  console.log("✅ Firebase SDK loaded successfully!");
  
 // Auth state handler
onAuthStateChanged(auth, async (user) => {
  if (user) {
    console.log('✅ User signed in:', user.email);
    window.currentUser = {
      email: user.email,
      uid: user.uid
    };
    
    showApp();
    
    // ✅ Load settings first
    if (typeof loadAddProductModalSettings === 'function') {
      await loadAddProductModalSettings();
    }
    
    // Then sync data
    if (typeof syncFromFirestore === 'function') {
      setTimeout(() => syncFromFirestore(), 500);
    }
  } else {
    console.log('❌ No user signed in');
    window.currentUser = null;
    showAuthScreen();
  }
});

  
  function showApp() {
    const authScreen = document.getElementById('authScreen');
    const loginPage = document.getElementById('loginPage');
    const mainApp = document.getElementById('mainApp');
    
    if (authScreen) authScreen.style.display = 'none';
    if (loginPage) loginPage.style.display = 'none';
    if (mainApp) mainApp.style.display = 'block';
  }
  
  function showAuthScreen() {
    const authScreen = document.getElementById('authScreen');
    const loginPage = document.getElementById('loginPage');
    const mainApp = document.getElementById('mainApp');
    
    if (authScreen) authScreen.style.display = 'block';
    if (loginPage) loginPage.style.display = 'block';
    if (mainApp) mainApp.style.display = 'none';
  }
</script>

  
  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">

  <!-- âœ… html2canvas for image generation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- Ã¢Å“â€¦ ADD THIS LINE -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- ✅ NEW: Link to External CSS File -->
  <link rel="stylesheet" href="styles.css">

 <script src="customers.js"></script>
  <script src="brand-manager.js"></script>
<!-- ✅ Bulk Edit Module -->
<script src="bulk-edit.js"></script>





  
  
</head>
<body class="loading">

<!-- ==========================================
     SIDEBAR MENU (Zoho-style)
     ========================================== -->
<!-- Hamburger Menu Button - ABOVE NAVBAR -->
<button class="sidebar-toggle-btn" id="sidebarToggleBtn" onclick="toggleSidebar()" 
        style="top: 110px !important; z-index: 9999 !important;">
  <i class="bi bi-list"></i>
</button>



<!-- Sidebar Overlay -->
<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

<!-- Sidebar Menu -->
<nav class="sidebar-menu" id="sidebarMenu">
  
  <!-- Sidebar Header -->
  <div class="sidebar-header">
    <i class="bi bi-boxes" style="font-size: 32px;"></i>
    <div class="d-flex align-items-center">
       <input type="checkbox" class="translation-exclusion-checkbox me-2" data-i18n-key="menu" onclick="handleTranslationCheckboxClick(event)">
       <h4 data-i18n="menu" class="mb-0 translation-exclusion-label">Menu</h4>
    </div>
  </div>
  
  <!-- Home -->
  <div class="sidebar-item" onclick="return runIfNotExclusionMode(event, () => navigateTo('dashboard'))">
    <div class="d-flex align-items-center w-100">
        <input type="checkbox" class="translation-exclusion-checkbox me-2" data-i18n-key="home" onclick="handleTranslationCheckboxClick(event)">
        <i class="bi bi-house-door"></i>
        <span data-i18n="home" class="translation-exclusion-label">Home</span>
    </div>
  </div>
  
  <!-- GENERAL Section -->
  <div class="sidebar-section-title">
      <div class="d-flex align-items-center">
        <input type="checkbox" class="translation-exclusion-checkbox me-2" data-i18n-key="general" onclick="handleTranslationCheckboxClick(event)">
        <span data-i18n="general" class="translation-exclusion-label">GENERAL</span>
      </div>
  </div>
  
 
  
  <div class="sidebar-item" onclick="return runIfNotExclusionMode(event, () => navigateTo('allProducts'))">
    <div class="d-flex align-items-center w-100">
        <input type="checkbox" class="translation-exclusion-checkbox me-2" data-i18n-key="allProducts" onclick="handleTranslationCheckboxClick(event)">
        <i class="bi bi-box"></i>
        <span data-i18n="allProducts" class="translation-exclusion-label">All Products</span>
    </div>
  </div>

  <div class="sidebar-item" onclick="return runIfNotExclusionMode(event, () => navigateTo('productGroups'))">
    <div class="d-flex align-items-center w-100">
        <input type="checkbox" class="translation-exclusion-checkbox me-2" data-i18n-key="productsInGroup" onclick="handleTranslationCheckboxClick(event)">
        <i class="bi bi-collection"></i>
        <span data-i18n="productsInGroup" class="translation-exclusion-label">Products in Group</span>
    </div>
  </div>
  
  
  
  <!-- SALES Section -->
  <div class="sidebar-section-title">
      <div class="d-flex align-items-center">
        <input type="checkbox" class="translation-exclusion-checkbox me-2" data-i18n-key="sales" onclick="handleTranslationCheckboxClick(event)">
        <span data-i18n="sales" class="translation-exclusion-label">SALES</span>
      </div>
  </div>
  
  

  <!-- ✅ Invoice Customer Sidebar Item -->
<div class="sidebar-item" onclick="return runIfNotExclusionMode(event, () => navigateToInvoiceCustomers())">
  <div class="d-flex align-items-center w-100">
      <input type="checkbox" class="translation-exclusion-checkbox me-2" data-i18n-key="invoiceCustomer" onclick="handleTranslationCheckboxClick(event)">
      <i class="bi bi-receipt-cutoff"></i>
      <span data-i18n="invoiceCustomer" class="translation-exclusion-label">Customer</span>
  </div>
</div>


  <!-- ✅ Generate Invoice (Sidebar) - WITH FEATURE FLAG -->
<div class="sidebar-item" 
data-feature-flag="enableInvoiceGeneration"
onclick="return runIfNotExclusionMode(event, generateInvoice)">
<div class="d-flex align-items-center w-100">
 <input type="checkbox" class="translation-exclusion-checkbox me-2" data-i18n-key="generateInvoice" onclick="handleTranslationCheckboxClick(event)">
 <i class="bi bi-file-earmark-plus"></i>
 <span data-i18n="generateInvoice" class="translation-exclusion-label" data-custom-rename-key="generateInvoice">Generate Invoice</span>
</div>
</div>

<!-- ✅ View Invoices (Sidebar) - WITH FEATURE FLAG -->
<div class="sidebar-item" 
data-feature-flag="enableInvoiceViewing"
onclick="return runIfNotExclusionMode(event, viewSavedInvoices)">
<div class="d-flex align-items-center w-100">
 <input type="checkbox" class="translation-exclusion-checkbox me-2" data-i18n-key="viewInvoices" onclick="handleTranslationCheckboxClick(event)">
 <i class="bi bi-receipt-cutoff"></i>
 <span data-i18n="viewInvoices" class="translation-exclusion-label" data-custom-rename-key="viewInvoices">View Invoices</span>
</div>
</div>



  <!-- MANAGEMENT Section -->
  <div class="sidebar-section-title">
      <div class="d-flex align-items-center">
        <input type="checkbox" class="translation-exclusion-checkbox me-2" data-i18n-key="management" onclick="handleTranslationCheckboxClick(event)">
        <span data-i18n="management" class="translation-exclusion-label">MANAGEMENT</span>
      </div>
  </div>

  <!-- Categories -->
  <div class="sidebar-item" onclick="return runIfNotExclusionMode(event, () => navigateTo('categories'))">
    <div class="d-flex align-items-center w-100">
        <input type="checkbox" class="translation-exclusion-checkbox me-2" data-i18n-key="categories" onclick="handleTranslationCheckboxClick(event)">
        <i class="bi bi-grid-3x3-gap"></i>
        <span data-i18n="categories" class="translation-exclusion-label">Categories</span>
    </div>
  </div>

  <!-- Unit Types -->
  <div class="sidebar-item" onclick="return runIfNotExclusionMode(event, () => navigateTo('unitTypes'))">
    <div class="d-flex align-items-center w-100">
        <input type="checkbox" class="translation-exclusion-checkbox me-2" data-i18n-key="unitTypes" onclick="handleTranslationCheckboxClick(event)">
        <i class="bi bi-card-text"></i>
        <span data-i18n="unitTypes" class="translation-exclusion-label">Unit Types</span>
    </div>
  </div>

  <div class="sidebar-item" onclick="return runIfNotExclusionMode(event, () => navigateTo('brands'))">
    <div class="d-flex align-items-center w-100">
        <input type="checkbox" class="translation-exclusion-checkbox me-2" data-i18n-key="brands" onclick="handleTranslationCheckboxClick(event)">
        <i class="bi bi-tag"></i>
        <span data-i18n="brands" class="translation-exclusion-label">Brands</span>
    </div>
  </div>

  <!-- Sizes -->
  <div class="sidebar-item" onclick="return runIfNotExclusionMode(event, () => navigateTo('sizes'))">
    <div class="d-flex align-items-center w-100">
        <input type="checkbox" class="translation-exclusion-checkbox me-2" data-i18n-key="sizes" onclick="handleTranslationCheckboxClick(event)">
        <i class="bi bi-rulers"></i>
        <span data-i18n="sizes" class="translation-exclusion-label">Sizes</span>
    </div>
  </div>
  
 
  
  
 
  
  <div class="sidebar-item" onclick="return runIfNotExclusionMode(event, () => navigateToVendors())">

    <div class="d-flex align-items-center w-100">
        <input type="checkbox" class="translation-exclusion-checkbox me-2" data-i18n-key="vendor" onclick="handleTranslationCheckboxClick(event)">
        <i class="bi bi-building"></i>
        <span data-i18n="vendor" class="translation-exclusion-label">Vendor</span>
    </div>
  </div>
  
  
  
  

  
  
  
  <!-- Settings -->
<div class="sidebar-section-title">
  <div class="d-flex align-items-center">
    <input type="checkbox" class="translation-exclusion-checkbox me-2" data-i18n-key="system" onclick="handleTranslationCheckboxClick(event)">
    <span data-i18n="system" class="translation-exclusion-label">SYSTEM</span>
  </div>
</div>

<!-- ✅ Changed to navigateTo like other items -->
<div class="sidebar-item" onclick="return runIfNotExclusionMode(event, () => navigateTo('settings'))">
  <div class="d-flex align-items-center w-100">
    <input type="checkbox" class="translation-exclusion-checkbox me-2" data-i18n-key="settings" onclick="handleTranslationCheckboxClick(event)">
    <i class="bi bi-gear"></i>
    <span data-i18n="settings" class="translation-exclusion-label">Settings</span>
  </div>
</div>

  

</nav>



<div id="authScreen" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); z-index: 9999;">
  <div class="container d-flex justify-content-center align-items-center" style="min-height: 100vh;">
    <div class="card shadow-lg" style="max-width: 420px; width: 100%; border-radius: 15px;">
      <div class="card-body text-center p-5">
        <div class="mb-4">
          <i class="bi bi-building" style="font-size: 4rem; color: #0d6efd;"></i>
        </div>
        <h2 class="mb-3">Tile & Sanitaryware Inventory</h2>
        <p class="text-muted mb-4">Sign in to access inventory</p>
        
        <!-- Ã¢Å“â€¦ NEW: Email + Password Form -->
        <form id="emailAuthForm" onsubmit="handleEmailPasswordAuth(event)">
          <div class="mb-3">
            <input 
              type="email" 
              id="userEmailInput" 
              class="form-control form-control-lg" 
              placeholder="Email address" 
              required
              autocomplete="email"
              style="border-radius: 10px; text-align: center;"
            >
          </div>
          
          <!-- Ã¢Å“â€¦ NEW: Password Input with Toggle -->
          <div class="mb-3 position-relative">
            <input 
              type="password" 
              id="userPasswordInput" 
              class="form-control form-control-lg" 
              placeholder="Password" 
              required
              autocomplete="current-password"
              style="border-radius: 10px; text-align: center; padding-right: 45px;"
            >
            <button 
              type="button" 
              class="btn btn-link position-absolute" 
              onclick="togglePasswordVisibility()"
              style="right: 10px; top: 50%; transform: translateY(-50%); text-decoration: none; color: #6c757d;"
            >
              <i id="passwordToggleIcon" class="bi bi-eye"></i>
            </button>
          </div>
          
          <button type="submit" id="loginButton" class="btn btn-primary btn-lg w-100" style="border-radius: 10px;">
            <i class="bi bi-box-arrow-in-right me-2"></i>Sign In
          </button>
        </form>
        
        <div class="text-muted mt-4" style="font-size: 0.875rem;">
          <i class="bi bi-lock-fill me-1"></i> Secure access with password
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ✅ MONTHLY BACKUP REMINDER POPUP (WITH TRANSLATION) -->
<div id="backupReminderModal" class="backup-reminder-overlay">
  <div class="backup-reminder-container">
    <div class="backup-reminder-content">
      
      <!-- Header -->
      <div class="backup-reminder-header">
        <i class="bi bi-calendar-check" style="font-size: 2.5rem; color: #25D366;"></i>
        <h4 style="margin: 12px 0 8px 0; color: #333; font-weight: 700;" data-i18n="monthlyBackupReminder">Monthly Backup Reminder</h4>
        <p style="color: #666; font-size: 0.9rem; margin: 0;" data-i18n="timeToBackup">It's time to backup your inventory data</p>
      </div>
      
      <!-- Body -->
      <div class="backup-reminder-body">
        <div style="background: #f8f9fa; padding: 16px; border-radius: 10px; margin-bottom: 16px;">
          <div style="display: flex; align-items: start; margin-bottom: 12px;">
            <i class="bi bi-shield-check" style="color: #25D366; font-size: 1.5rem; margin-right: 12px;"></i>
            <div>
              <strong style="color: #333; display: block; margin-bottom: 4px;" data-i18n="protectYourData">Protect Your Data</strong>
              <span style="color: #666; font-size: 0.85rem;" data-i18n="downloadBackupMessage">Download a backup to keep your inventory safe</span>
            </div>
          </div>
          
          <div style="display: flex; align-items: start;">
            <i class="bi bi-clock-history" style="color: #0d6efd; font-size: 1.5rem; margin-right: 12px;"></i>
            <div>
              <strong style="color: #333; display: block; margin-bottom: 4px;" data-i18n="quickAndEasy">Quick & Easy</strong>
              <span style="color: #666; font-size: 0.85rem;" data-i18n="backupTimeMessage">Takes less than 30 seconds to complete</span>
            </div>
          </div>
        </div>
        
        <!-- Last Backup Info -->
        <div id="lastBackupInfo" style="text-align: center; margin-bottom: 16px; padding: 10px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">
          <small style="color: #856404;">
            <i class="bi bi-info-circle me-1"></i>
            <span id="lastBackupText" data-i18n="noBackupFound">No backup found this month</span>
          </small>
        </div>
        
        <!-- Checkbox -->
        <div style="margin-bottom: 0;">
          <label style="display: flex; align-items: center; cursor: pointer; padding: 8px; border-radius: 8px; transition: background 0.2s;" 
                 onmouseover="this.style.background='#f8f9fa'" 
                 onmouseout="this.style.background='transparent'">
            <input type="checkbox" id="dontShowAgainCheckbox" style="width: 18px; height: 18px; margin-right: 10px; cursor: pointer;">
            <span style="color: #666; font-size: 0.9rem;" data-i18n="dontShowAgainThisMonth">Don't show this notification this month again</span>
          </label>
        </div>
      </div>
      
      <!-- Footer - Action Buttons -->
      <div class="backup-reminder-footer">
        
        <!-- Cancel Button -->
        <button 
          onclick="cancelBackupReminder()" 
          class="btn-backup-cancel"
        >
          <i class="bi bi-x-circle" style="margin-right: 8px;"></i>
          <span data-i18n="cancel">Cancel</span>
        </button>
        
        <!-- Backup Button -->
        <button 
          onclick="startBackupFromReminder()" 
          class="btn-backup-download"
        >
          <i class="bi bi-cloud-download" style="margin-right: 8px;"></i>
          <span data-i18n="backupNow">Backup Now</span>
        </button>
        
      </div>
      
    </div>
  </div>
</div>

<!-- Sync indicator -->
<div id="syncIndicator" class="sync-indicator">
  <i class="bi bi-arrow-repeat"></i> 
  <span id="syncText" data-i18n="syncing">Syncing...</span>
</div>

<!-- ✅ RESPONSIVE NAVBAR - With Feature Flags -->
<nav id="mainNavbar" class="navbar navbar-dark sticky-top" 
     style="background: linear-gradient(135deg, #198754 0%, #157347 100%); padding-left: 10px !important;">
  <div class="container-fluid">
    <div class="w-100 text-center">
      
      <!-- Row 1: App Name + Language Switcher -->
      <div class="d-flex align-items-center justify-content-between gap-2">
        <span class="navbar-brand mb-0 h1">
          <i class="bi bi-boxes"></i> 
          <span data-i18n="appTitle" data-custom-rename-key="appTitle">Tile & Sanitaryware Inventory</span>
        </span>
        
        <div class="d-flex align-items-center gap-2">
          <!-- Language Switcher Button -->
          <div class="dropdown" id="languageSwitcherDropdown">
            <button class="btn btn-sm text-white d-flex align-items-center" 
                    type="button" 
                    id="languageDropdown" 
                    data-bs-toggle="dropdown" 
                    aria-expanded="false"
                    style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); border-radius: 8px; padding: 6px 12px; font-size: 0.85rem; backdrop-filter: blur(10px);">
              <i class="bi bi-translate me-2" style="font-size: 1rem;"></i>
              <span id="currentLanguageLabel" style="font-weight: 600;">EN</span>
              <i class="bi bi-chevron-down ms-2" style="font-size: 0.7rem;"></i>
            </button>
            
            <ul class="dropdown-menu dropdown-menu-end shadow" 
                aria-labelledby="languageDropdown" 
                style="border-radius: 10px; min-width: 200px; border: none; right: 0 !important; left: auto !important;">
              <li>
                <button type="button" class="dropdown-item d-flex align-items-center" onclick="changeLanguageAndClose('en')" style="padding: 10px 16px;">
                  <i class="bi bi-check-circle-fill me-2" id="langEnCheck" style="font-size: 1rem; color: #198754;"></i>
                  <div>
                    <div style="font-weight: 600; color: #333;">English</div>
                    <div style="font-size: 0.75rem; color: #666;">Default Language</div>
                  </div>
                </button>
              </li>
              <li><hr class="dropdown-divider" style="margin: 0;"></li>
              <li>
                <button type="button" class="dropdown-item d-flex align-items-center" onclick="changeLanguageAndClose('hi')" style="padding: 10px 16px;">
                  <i class="bi bi-circle me-2" id="langHiCheck" style="font-size: 1rem; color: #ccc;"></i>
                  <div>
                    <div style="font-weight: 600; color: #333;">हिंदी</div>
                    <div style="font-size: 0.75rem; color: #666;">Hindi</div>
                  </div>
                </button>
              </li>
              <li><hr class="dropdown-divider" style="margin: 0;"></li>
              <li>
                <button type="button" class="dropdown-item d-flex align-items-center" onclick="toggleTranslationExclusionModeAndClose()" style="padding: 10px 16px;">
                  <i class="bi bi-gear me-2" style="font-size: 1rem; color: #0d6efd;"></i>
                  <div>
                    <div style="font-weight: 600; color: #333;">Do Not Translate</div>
                    <div style="font-size: 0.75rem; color: #666;">Select items to keep in English</div>
                  </div>
                </button>
              </li>
              <li>
                <button type="button" class="dropdown-item d-flex align-items-center" onclick="toggleCustomTextNameModeAndClose()" style="padding: 10px 16px;">
                  <i class="bi bi-pencil-square me-2" style="font-size: 1rem; color: #fd7e14;"></i>
                  <div>
                    <div style="font-weight: 600; color: #333;">Custom Text Names</div>
                    <div style="font-size: 0.75rem; color: #666;">Rename navbar items</div>
                  </div>
                </button>
              </li>
            </ul>
          </div>
          
          <!-- Desktop: User Dropdown (inline) -->
          <div class="dropdown d-none d-md-block">
            <button class="btn text-white text-decoration-none d-flex align-items-center p-2" 
                    type="button" 
                    id="userDropdown" 
                    data-bs-toggle="dropdown" 
                    aria-expanded="false"
                    style="background: linear-gradient(135deg, #25D366 0%, #1FAD5D 100%); border: none; border-radius: 10px; font-weight: 600; box-shadow: 0 2px 8px rgba(37, 211, 102, 0.2);">
              <i class="bi bi-person-circle me-2" style="font-size: 1.5rem;"></i>
              <span id="userName" class="me-2">Loading...</span>
              <i class="bi bi-chevron-down" style="font-size: 0.8rem;"></i>
            </button>
            
            <ul class="dropdown-menu dropdown-menu-end shadow" aria-labelledby="userDropdown" style="border-radius: 10px; min-width: 250px; border: none;">
              <li>
                <div class="dropdown-header" style="background: linear-gradient(135deg, #25D366 0%, #1FAD5D 100%); border-radius: 10px 10px 0 0; color: white; padding: 12px;">
                  <div class="d-flex align-items-center">
                    <i class="bi bi-person-circle me-2" style="font-size: 2rem;"></i>
                    <div>
                      <strong id="userEmailDropdown" style="font-size: 0.9rem;">user@example.com</strong>
                      <div style="font-size: 0.75rem; opacity: 0.9;">
                        <input type="checkbox" class="translation-exclusion-checkbox" data-i18n-key="signedIn" onclick="handleTranslationCheckboxClick(event)">
                        <span data-i18n="signedIn" class="translation-exclusion-label" data-custom-rename-key="signedIn">Signed In</span>
                      </div>
                    </div>
                  </div>
                </div>
              </li>
              <li><hr class="dropdown-divider" style="margin: 0;"></li>
              
              <li>
                <button id="backupButton" class="dropdown-item d-flex align-items-center" onclick="return runIfNotExclusionMode(event, sendBackupEmail)" style="padding: 12px 16px; background: none; border: none; width: 100%; text-align: left; cursor: pointer;">
                  <input type="checkbox" class="translation-exclusion-checkbox" data-i18n-key="backupData" onclick="handleTranslationCheckboxClick(event)">
                  <i class="bi bi-cloud-download me-2" style="color: #198754 !important;"></i>
                  <span style="color: #198754 !important; font-weight: 500;" data-i18n="backupData" class="translation-exclusion-label" data-custom-rename-key="backupData">Backup Data</span>
                </button>
              </li>
              
              <li>
                <button class="dropdown-item d-flex align-items-center" onclick="return runIfNotExclusionMode(event, function(){ document.getElementById('restoreFileInput').click(); })" style="padding: 12px 16px; background: none; border: none; width: 100%; text-align: left; cursor: pointer;">
                  <input type="checkbox" class="translation-exclusion-checkbox" data-i18n-key="restoreData" onclick="handleTranslationCheckboxClick(event)">
                  <i class="bi bi-cloud-upload me-2" style="color: #0d6efd !important;"></i>
                  <span style="color: #0d6efd !important; font-weight: 500;" data-i18n="restoreData" class="translation-exclusion-label" data-custom-rename-key="restoreData">Restore Data</span>
                </button>
              </li>
              
              <li><hr class="dropdown-divider" style="margin: 0;"></li>
              
              <li>
                <button class="dropdown-item d-flex align-items-center" onclick="return runIfNotExclusionMode(event, openChangePasswordModal)" style="padding: 12px 16px; background: none; border: none; width: 100%; text-align: left; cursor: pointer;">
                  <input type="checkbox" class="translation-exclusion-checkbox" data-i18n-key="changePassword" onclick="handleTranslationCheckboxClick(event)">
                  <i class="bi bi-key me-2" style="color: #198754 !important;"></i>
                  <span style="color: #198754 !important; font-weight: 500;" data-i18n="changePassword" class="translation-exclusion-label" data-custom-rename-key="changePassword">Change Password</span>
                </button>
              </li>

              <li>
                <button class="dropdown-item d-flex align-items-center" onclick="return runIfNotExclusionMode(event, openResetDataModal)" style="padding: 12px 16px; background: none; border: none; width: 100%; text-align: left; cursor: pointer;">
                  <input type="checkbox" class="translation-exclusion-checkbox" data-i18n-key="resetData" onclick="handleTranslationCheckboxClick(event)">
                  <i class="bi bi-trash3 me-2" style="color: #dc3545 !important;"></i>
                  <span style="color: #dc3545 !important; font-weight: 500;" data-i18n="resetData" class="translation-exclusion-label" data-custom-rename-key="resetData">Reset Data</span>
                </button>
              </li>
              
              <li>
                <button class="dropdown-item d-flex align-items-center" onclick="return runIfNotExclusionMode(event, signOut)" style="padding: 12px 16px; background: none; border: none; width: 100%; text-align: left; cursor: pointer;">
                  <input type="checkbox" class="translation-exclusion-checkbox" data-i18n-key="signOut" onclick="handleTranslationCheckboxClick(event)">
                  <i class="bi bi-box-arrow-right me-2" style="color: #198754 !important;"></i>
                  <span style="color: #198754 !important; font-weight: 500;" data-i18n="signOut" class="translation-exclusion-label" data-custom-rename-key="signOut">Sign Out</span>
                </button>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <!-- ✅ FIXED: Row 2 - Translation Control Buttons (Below language dropdown) -->
<div id="translationControlButtons" style="display: none;" class="mt-2">
  <div class="d-flex gap-1 justify-content-end">
    <button type="button" class="btn btn-sm btn-success" onclick="saveTranslationExclusions()" style="padding: 4px 10px; border-radius: 6px; font-weight: 600; font-size: 0.75rem;">
      <i class="bi bi-check-lg"></i> Save
    </button>
    <button type="button" class="btn btn-sm btn-secondary" onclick="cancelTranslationExclusions()" style="padding: 4px 10px; border-radius: 6px; font-weight: 600; font-size: 0.75rem;">
      <i class="bi bi-x-lg"></i> Cancel
    </button>
  </div>
</div>

      <!-- ✅ NEW: Row 3 - Custom Text Mode Indicator (Below translation buttons) -->
      <div id="customTextModeIndicator" class="mt-2" style="display: none;">
        <div class="d-flex align-items-center justify-content-end gap-2 px-2 py-1" style="background: rgba(253, 126, 20, 0.2); border-radius: 8px; border: 1px solid rgba(253, 126, 20, 0.4);">
          <i class="bi bi-cursor-text" style="color: #fd7e14; font-size: 0.9rem;"></i>
          <span style="font-size: 0.75rem; color: #fd7e14; font-weight: 600;" data-i18n="clickAnyTextToRename">Click any text to rename</span>
          <button type="button" class="btn btn-sm" onclick="exitCustomTextNameMode()" style="padding: 3px 8px; border-radius: 6px; font-size: 0.7rem; background: #fd7e14; color: white; border: none;">
            <i class="bi bi-x-lg"></i> <span data-i18n="exit">Exit</span>
          </button>
        </div>
      </div>
      
    </div>
    
    <!-- Mobile Only: User Dropdown -->
    <div class="d-md-none mt-2">
      <div class="dropdown">
        <button class="btn text-white text-decoration-none d-flex align-items-center p-2 w-100 justify-content-center" 
                type="button" 
                id="userDropdownMobile" 
                data-bs-toggle="dropdown" 
                aria-expanded="false"
                style="background: linear-gradient(135deg, #25D366 0%, #1FAD5D 100%); border: none; border-radius: 10px; font-weight: 600; box-shadow: 0 2px 8px rgba(37, 211, 102, 0.2);">
          <i class="bi bi-person-circle me-2" style="font-size: 1.3rem;"></i>
          <span id="userNameMobile" class="me-2">Loading...</span>
          <i class="bi bi-chevron-down" style="font-size: 0.8rem;"></i>
        </button>
        
        <ul class="dropdown-menu dropdown-menu-center shadow w-100" aria-labelledby="userDropdownMobile" style="border-radius: 10px; border: none;">
          <li>
            <div class="dropdown-header" style="background: linear-gradient(135deg, #25D366 0%, #1FAD5D 100%); border-radius: 10px 10px 0 0; color: white; padding: 12px;">
              <div class="d-flex align-items-center">
                <i class="bi bi-person-circle me-2" style="font-size: 2rem;"></i>
                <div>
                  <strong id="userEmailDropdownMobile" style="font-size: 0.9rem;">user@example.com</strong>
                  <div style="font-size: 0.75rem; opacity: 0.9;">
                    <input type="checkbox" class="translation-exclusion-checkbox" data-i18n-key="signedIn" onclick="handleTranslationCheckboxClick(event)">
                    <span data-i18n="signedIn" class="translation-exclusion-label" data-custom-rename-key="signedIn">Signed In</span>
                  </div>
                </div>
              </div>
            </div>
          </li>
          <li><hr class="dropdown-divider" style="margin: 0;"></li>
          
          <li>
            <button id="backupButtonMobile" class="dropdown-item d-flex align-items-center" onclick="return runIfNotExclusionMode(event, sendBackupEmail)" style="padding: 12px 16px; background: none; border: none; width: 100%; text-align: left; cursor: pointer;">
              <input type="checkbox" class="translation-exclusion-checkbox" data-i18n-key="backupData" onclick="handleTranslationCheckboxClick(event)">
              <i class="bi bi-cloud-download me-2" style="color: #198754 !important;"></i>
              <span style="color: #198754 !important; font-weight: 500;" data-i18n="backupData" class="translation-exclusion-label" data-custom-rename-key="backupData">Backup Data</span>
            </button>
          </li>
          
          <li>
            <button class="dropdown-item d-flex align-items-center" onclick="return runIfNotExclusionMode(event, function(){ document.getElementById('restoreFileInput').click(); })" style="padding: 12px 16px; background: none; border: none; width: 100%; text-align: left; cursor: pointer;">
              <input type="checkbox" class="translation-exclusion-checkbox" data-i18n-key="restoreData" onclick="handleTranslationCheckboxClick(event)">
              <i class="bi bi-cloud-upload me-2" style="color: #0d6efd !important;"></i>
              <span style="color: #0d6efd !important; font-weight: 500;" data-i18n="restoreData" class="translation-exclusion-label" data-custom-rename-key="restoreData">Restore Data</span>
            </button>
          </li>
          
          <li><hr class="dropdown-divider" style="margin: 0;"></li>
          
          <li>
            <button class="dropdown-item d-flex align-items-center" onclick="return runIfNotExclusionMode(event, openChangePasswordModal)" style="padding: 12px 16px; background: none; border: none; width: 100%; text-align: left; cursor: pointer;">
              <input type="checkbox" class="translation-exclusion-checkbox" data-i18n-key="changePassword" onclick="handleTranslationCheckboxClick(event)">
              <i class="bi bi-key me-2" style="color: #198754 !important;"></i>
              <span style="color: #198754 !important; font-weight: 500;" data-i18n="changePassword" class="translation-exclusion-label" data-custom-rename-key="changePassword">Change Password</span>
            </button>
          </li>

          <li>
            <button class="dropdown-item d-flex align-items-center" onclick="return runIfNotExclusionMode(event, openResetDataModal)" style="padding: 12px 16px; background: none; border: none; width: 100%; text-align: left; cursor: pointer;">
              <input type="checkbox" class="translation-exclusion-checkbox" data-i18n-key="resetData" onclick="handleTranslationCheckboxClick(event)">
              <i class="bi bi-trash3 me-2" style="color: #dc3545 !important;"></i>
              <span style="color: #dc3545 !important; font-weight: 500;" data-i18n="resetData" class="translation-exclusion-label" data-custom-rename-key="resetData">Reset Data</span>
            </button>
          </li>
          
          <li>
            <button class="dropdown-item d-flex align-items-center" onclick="return runIfNotExclusionMode(event, signOut)" style="padding: 12px 16px; background: none; border: none; width: 100%; text-align: left; cursor: pointer;">
              <input type="checkbox" class="translation-exclusion-checkbox" data-i18n-key="signOut" onclick="handleTranslationCheckboxClick(event)">
              <i class="bi bi-box-arrow-right me-2" style="color: #198754 !important;"></i>
              <span style="color: #198754 !important; font-weight: 500;" data-i18n="signOut" class="translation-exclusion-label" data-custom-rename-key="signOut">Sign Out</span>
            </button>
          </li>
        </ul>
      </div>
    </div>
    
    <input type="file" id="restoreFileInput" accept=".json" style="display: none;" onchange="handleRestoreFile(event)">
    
  </div>
</nav>

<!-- Custom Text Rename Modal -->
<div class="modal fade" id="customTextRenameModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius: 15px; border: none; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
      <div class="modal-header" style="background: linear-gradient(135deg, #fd7e14 0%, #fd9843 100%); color: white; border-radius: 15px 15px 0 0; border: none;">
        <h5 class="modal-title">
          <i class="bi bi-pencil-square me-2"></i>
          Rename Text
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" style="padding: 30px;">
        <div class="mb-3">
          <label for="customTextInput" class="form-label fw-bold">New Text Name:</label>
          <input type="text" class="form-control form-control-lg" id="customTextInput" 
                 placeholder="Enter new name" 
                 style="border-radius: 10px; border: 2px solid #dee2e6; padding: 12px;">
          <div class="form-text">Current: <span id="currentTextPreview" style="font-weight: 600; color: #198754;"></span></div>
        </div>
      </div>
      <div class="modal-footer" style="border: none; padding: 20px 30px;">
        <button type="button" class="btn btn-warning text-white" onclick="resetSingleCustomText()" style="border-radius: 10px; padding: 10px 20px; font-weight: 600;">
          <i class="bi bi-arrow-counterclockwise me-1"></i> Reset to Default
        </button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="border-radius: 10px; padding: 10px 20px; font-weight: 600;">
          <i class="bi bi-x-lg me-1"></i> Cancel
        </button>
        <button type="button" class="btn btn-success" onclick="saveCustomTextRename()" style="border-radius: 10px; padding: 10px 20px; font-weight: 600;">
          <i class="bi bi-check-lg me-1"></i> Save
        </button>
      </div>
    </div>
  </div>
</div>









<!-- ✅ SPACER -->
<div style="height: 20px; background: transparent;"></div>

<!-- Summary - 2 Cards (Side-by-Side on ALL screens) -->
<div class="row g-2 mb-3">
  
  <!-- 1. Total Products Card (with Qty in Hand, In Stock, Low Stock) -->
  <div class="col-md-6 col-6">
    <div class="card summary-card shadow-sm h-100">
      <div class="card-body p-2">
        <!-- Icon and Title -->
        <div class="text-center mb-1">
          <i class="bi bi-box-seam" style="font-size:2rem; color: var(--primary-green);"></i>
        </div>
        <div class="text-center mb-1">
          <h2 id="totalProducts" style="font-size:1.8rem; color: var(--primary-green); font-weight: 700; margin: 0;">0</h2>
          
          <!-- ✅ EXCLUSION CHECKBOX ADDED -->
          <div class="d-flex justify-content-center align-items-center gap-1">
             <input type="checkbox" class="translation-exclusion-checkbox me-1" data-i18n-key="totalProducts" onclick="handleTranslationCheckboxClick(event)">
             <p class="text-muted mb-0" style="font-size:0.7rem;" data-i18n="totalProducts" class="translation-exclusion-label">Total Products</p>
          </div>
        </div>
        
        <!-- Divider -->
        <hr style="margin: 6px 0; border-top: 1px solid rgba(25, 135, 84, 0.15);">
        
        <!-- Qty in Hand -->
        <div class="d-flex justify-content-between align-items-center px-1 mb-2">
          <div class="d-flex align-items-center">
            <!-- ✅ EXCLUSION CHECKBOX ADDED -->
            <input type="checkbox" class="translation-exclusion-checkbox me-1" data-i18n-key="qtyInHand" onclick="handleTranslationCheckboxClick(event)">
            <i class="bi bi-layers me-1" style="color: var(--primary-green); font-size: 1rem;"></i>
            <span class="text-muted translation-exclusion-label" style="font-size:0.7rem;" data-i18n="qtyInHand">Qty in Hand</span>
          </div>
          <span class="fw-bold" id="quantityInHand" style="font-size:1rem; color: var(--primary-green);">0</span>
        </div>
        
        <!-- In Stock Items -->
        <div class="d-flex justify-content-between align-items-center px-1 mb-2">
          <div class="d-flex align-items-center">
             <!-- ✅ EXCLUSION CHECKBOX ADDED -->
            <input type="checkbox" class="translation-exclusion-checkbox me-1" data-i18n-key="inStockItems" onclick="handleTranslationCheckboxClick(event)">
            <i class="bi bi-check-circle me-1" style="color: #28a745; font-size: 1rem;"></i>
            <span class="text-muted translation-exclusion-label" style="font-size:0.7rem;" data-i18n="inStockItems">In Stock Items</span>
          </div>
          <span class="fw-bold" id="inStockItems" style="font-size:1rem; color: #28a745;">0</span>
        </div>
        
        <!-- Low Stock Items -->
        <div class="d-flex justify-content-between align-items-center px-1">
          <div class="d-flex align-items-center">
            <!-- ✅ EXCLUSION CHECKBOX ADDED -->
            <input type="checkbox" class="translation-exclusion-checkbox me-1" data-i18n-key="lowStockItems" onclick="handleTranslationCheckboxClick(event)">
            <i class="bi bi-exclamation-triangle me-1" style="color: #DC2626; font-size: 1rem;"></i>
            <span class="text-muted translation-exclusion-label" style="font-size:0.7rem;" data-i18n="lowStockItems">Low Stock Items</span>
          </div>
          <span class="fw-bold" id="lowStock" style="font-size:1rem; color: #DC2626;">0</span>
        </div>
      </div>
    </div>
  </div>
  
  <!-- 2. Quick Actions Card - WITH FLIP ANIMATION -->
  <div class="col-md-6 col-6">
    <div class="flip-card h-100" onclick="toggleQuickActionsFlip(event)">

      <div class="flip-card-inner" id="flipCardInner">
        
        <!-- FRONT SIDE: Quick Create (DEFAULT VISIBLE) -->
        <div class="flip-card-front">
          <div class="card summary-card shadow-sm h-100" style="border: none;">
            <div class="card-body p-0 d-flex flex-column justify-content-center align-items-center" style="min-height: 140px; cursor: pointer;">
              <i class="bi bi-plus-circle" style="font-size: 3rem; color: #666;"></i>
              
               <!-- ✅ EXCLUSION CHECKBOX ADDED -->
               <div class="d-flex align-items-center mt-2">
                 <input type="checkbox" class="translation-exclusion-checkbox me-1" data-i18n-key="quickCreate" onclick="handleTranslationCheckboxClick(event)">
                 <h5 class="mb-0 translation-exclusion-label" style="color: #333; font-weight: 600;" data-i18n="quickCreate">Quick Create</h5>
               </div>
               
               <!-- ✅ EXCLUSION CHECKBOX ADDED -->
               <div class="d-flex align-items-center mt-1">
                 <input type="checkbox" class="translation-exclusion-checkbox me-1" data-i18n-key="clickToFlip" onclick="handleTranslationCheckboxClick(event)">
                 <p class="text-muted mb-0 translation-exclusion-label" style="font-size: 0.75rem;" data-i18n="clickToFlip">Click to flip</p>
               </div>
            </div>
          </div>
        </div>
        
        <!-- BACK SIDE: 4 Action Buttons (HIDDEN BY DEFAULT) -->
        <div class="flip-card-back">
          <div class="card summary-card shadow-sm h-100" style="border: none;">
            <div class="card-body p-0 position-relative" style="min-height: 140px;">
              
              <!-- 2x2 Grid Buttons with NO spacing -->
              <div class="row g-0 h-100">
                <!-- Top Left: Instant Products -->
                <div class="col-6 position-relative">
                  <button class="btn tile-action-button-plain border-end border-bottom" onclick="event.stopPropagation(); runIfNotExclusionMode(event, openInstantProductsModal)">
                    <i class="bi bi-lightning-charge d-block" style="font-size: 1.5rem;"></i>
                    <!-- ✅ EXCLUSION CHECKBOX ADDED -->
                    <div class="d-flex flex-column align-items-center mt-1">
                         <input type="checkbox" class="translation-exclusion-checkbox mb-1" data-i18n-key="instantProducts" onclick="handleTranslationCheckboxClick(event)">
                         <span class="d-block translation-exclusion-label" style="font-size: 0.65rem;" data-i18n="instantProducts">Instant Products</span>
                    </div>
                  </button>
                </div>
                
                <!-- Top Right: Add Product -->
                <div class="col-6 position-relative">
                  <button class="btn tile-action-button-plain border-bottom" onclick="event.stopPropagation(); runIfNotExclusionMode(event, showAddProduct)">
                    <i class="bi bi-plus-circle d-block" style="font-size: 1.5rem;"></i>
                    <!-- ✅ EXCLUSION CHECKBOX ADDED -->
                    <div class="d-flex flex-column align-items-center mt-1">
                         <input type="checkbox" class="translation-exclusion-checkbox mb-1" data-i18n-key="addProduct" onclick="handleTranslationCheckboxClick(event)">
                         <span class="d-block translation-exclusion-label" style="font-size: 0.65rem;" data-i18n="addProduct">Add Product</span>
                    </div>
                  </button>
                </div>
                
                <!-- Bottom Left: Record Purchase -->
                <!-- Bottom Left: Record Purchase -->
<div id="recordPurchaseContainer" class="col-6 position-relative">
  <button class="btn tile-action-button-plain border-end" onclick="event.stopPropagation(); runIfNotExclusionMode(event, openRecordPurchaseModal)">

                    <i class="bi bi-bag-plus d-block" style="font-size: 1.5rem;"></i>
                    <!-- ✅ EXCLUSION CHECKBOX ADDED -->
                     <div class="d-flex flex-column align-items-center mt-1">
                         <input type="checkbox" class="translation-exclusion-checkbox mb-1" data-i18n-key="recordPurchase" onclick="handleTranslationCheckboxClick(event)">
                         <span class="d-block translation-exclusion-label" style="font-size: 0.65rem;" data-i18n="recordPurchase">Record Purchase</span>
                    </div>
                  </button>
                </div>
                
                <!-- Bottom Right: Record Sale -->
<div class="col-6 position-relative" data-feature-flag="enableSalesRecording">
  <button class="btn tile-action-button-plain" onclick="event.stopPropagation(); runIfNotExclusionMode(event, openSalesModal)">
    <i class="bi bi-cart d-block" style="font-size: 1.5rem;"></i>
    <div class="d-flex flex-column align-items-center mt-1">
         <input type="checkbox" class="translation-exclusion-checkbox mb-1" data-i18n-key="recordSale" onclick="handleTranslationCheckboxClick(event)">
         <span class="d-block translation-exclusion-label" style="font-size: 0.65rem;" data-i18n="recordSale">Record Sale</span>
    </div>
  </button>
</div>

              </div>
              
            </div>
          </div>
        </div>
        
      </div>
    </div>
  </div>
  
</div>


<style>
  /* ==========================================
     MOBILE NAVBAR COLLAPSIBLE ANIMATION
     ========================================== */
  
  #mobileInvoiceSection {
    transition: all 0.3s ease;
    overflow: hidden;
  }
  
  #navbarToggleIcon {
    transition: transform 0.3s ease;
  }
  
  /* ==========================================
     FLIP CARD ANIMATION
     ========================================== */
  
  .flip-card {
    background-color: transparent;
    perspective: 1000px;
    cursor: pointer;
  }
  
  .flip-card-inner {
    position: relative;
    width: 100%;
    height: 100%;
    text-align: center;
    transition: transform 0.6s;
    transform-style: preserve-3d;
  }
  
  /* Flip when class is added */
  .flip-card-inner.flipped {
    transform: rotateY(180deg);
  }
  
  /* Position both sides absolutely */
  .flip-card-front,
  .flip-card-back {
    position: absolute;
    width: 100%;
    height: 100%;
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
    top: 0;
    left: 0;
  }
  
  /* Front visible by default */
  .flip-card-front {
    z-index: 2;
    transform: rotateY(0deg);
  }
  
  /* Back hidden initially */
  .flip-card-back {
    transform: rotateY(180deg);
    z-index: 1;
  }
  
  /* ==========================================
     TILE ACTION BUTTONS (Plain Style)
     ========================================== */
  .tile-action-button-plain {
    background: white;
    color: #333;
    font-weight: 600;
    border: none;
    border-radius: 0;
    padding: 10px 4px;
    box-shadow: none;
    transition: all 0.2s ease;
    width: 100%;
    height: 100%;
    min-height: 70px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    text-align: center;
  }
  
  .tile-action-button-plain:hover {
    background: #f0f0f0;
    color: #000;
  }
  
  .tile-action-button-plain:active {
    background: #e0e0e0;
  }
  
  .tile-action-button-plain i {
    color: #666;
  }
  
  /* Border styling for grid lines */
  .border-end {
    border-right: 1px solid #ddd !important;
  }
  
  .border-bottom {
    border-bottom: 1px solid #ddd !important;
  }
  
  /* Remove card border for flip card */
  .flip-card .summary-card {
    border: none !important;
  }
  
  /* ==========================================
     Summary Cards Styling
     ========================================== */
  .summary-card {
    transition: all 0.3s ease;
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid #e0e0e0;
  }
  
  .summary-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1) !important;
  }
  
  /* Disable hover on flip card parent */
  .flip-card:hover .summary-card {
    transform: none;
  }
  
  /* ==========================================
     Navbar Responsive Adjustments
     ========================================== */
  
  @media (max-width: 767px) {
    .navbar {
      padding: 0.5rem 1rem;
    }
    
    .navbar-brand {
      font-size: 0.9rem;
    }
    
    .tile-action-button-plain {
      min-height: 60px;
      padding: 8px 2px;
    }
    
    .tile-action-button-plain i {
      font-size: 1.2rem !important;
    }
    
    .tile-action-button-plain span {
      font-size: 0.6rem !important;
    }
    
    .flip-card-front .card-body,
    .flip-card-back .card-body {
      min-height: 120px !important;
    }
  }
  
  @media (min-width: 768px) {
    .navbar-brand {
      font-size: 1.25rem;
    }
    
    .navbar-action-btn {
      min-width: 130px;
    }
  }
  
  /* ==========================================
     Mobile Action Buttons (Navbar)
     ========================================== */
  .mobile-action-btn {
    min-height: 60px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }
  
  .mobile-action-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 3px 10px rgba(37, 211, 102, 0.3) !important;
  }
  
  /* ==========================================
     User Dropdown Styling
     ========================================== */
  .dropdown-menu {
    border: none;
    box-shadow: 0 8px 24px rgba(0,0,0,0.15);
  }
  
  .dropdown-item:hover {
    background-color: #f8f9fa;
  }
  
  .dropdown-menu[aria-labelledby="userDropdown"] .dropdown-item,
  .dropdown-menu[aria-labelledby="userDropdownMobile"] .dropdown-item {
    color: #198754 !important;
  }
  
  .dropdown-menu[aria-labelledby="userDropdown"] .dropdown-item i,
  .dropdown-menu[aria-labelledby="userDropdownMobile"] .dropdown-item i {
    color: #198754 !important;
  }
  
  .dropdown-menu[aria-labelledby="userDropdown"] .dropdown-item span,
  .dropdown-menu[aria-labelledby="userDropdownMobile"] .dropdown-item span {
    color: #198754 !important;
    font-weight: 500;
  }
  
  /* Blue color for Restore option */
  .dropdown-menu .dropdown-item i.bi-cloud-upload {
    color: #0d6efd !important;
  }
  
  .dropdown-menu .dropdown-item span:has(+ i.bi-cloud-upload) {
    color: #0d6efd !important;
  }
  </style>

<!-- ==========================================
     VIEW SELECTOR - BUTTON GROUP (GREEN THEME)
     ========================================== -->
     <div class="row mb-3">
      <div class="col-12">
        <div class="btn-group w-100" role="group" aria-label="View selector">
          
          <!-- Inventory Button -->
          <button type="button" 
                  class="btn btn-outline-success view-btn active" 
                  id="inventory-btn"
                  onclick="handleViewSwitchClick(event, 'inventory')">
            <div class="d-flex justify-content-center align-items-center">
              <input type="checkbox" class="translation-exclusion-checkbox me-2" data-i18n-key="inventory" onclick="handleTranslationCheckboxClick(event)">
              <i class="bi bi-grid-3x3-gap"></i>
              <span data-i18n="inventory" class="ms-2 translation-exclusion-label">Inventory</span>
            </div>
          </button>
    <!-- Recent Sales Button -->
<button type="button" 
class="btn btn-outline-success view-btn" 
id="sales-btn"
data-feature-flag="enableRecentSalesView"
onclick="handleViewSwitchClick(event, 'sales')">
<div class="d-flex justify-content-center align-items-center">
<input type="checkbox" class="translation-exclusion-checkbox me-2" data-i18n-key="recentSales" onclick="handleTranslationCheckboxClick(event)">
<i class="bi bi-cash-coin"></i>
<span data-i18n="recentSales" class="ms-2 translation-exclusion-label">Recent Sales</span>
</div>
</button>

    
          <!-- Recent Purchases Button -->
          <button type="button" 
                  class="btn btn-outline-success view-btn" 
                  id="purchases-btn"
                  onclick="handleViewSwitchClick(event, 'purchases')">
            <div class="d-flex justify-content-center align-items-center">
              <input type="checkbox" class="translation-exclusion-checkbox me-2" data-i18n-key="recentPurchases" onclick="handleTranslationCheckboxClick(event)">
              <i class="bi bi-cart-check"></i>
              <span data-i18n="recentPurchases" class="ms-2 translation-exclusion-label">Recent Purchases</span>
            </div>
          </button>
    
        </div>
      </div>
    </div>
    
    
    

<!-- ==========================================
     INVENTORY SECTION (Products + Bulk Edit)
     ========================================== -->
<div id="inventorySection">
<!-- ==========================================
     🔥 BULK EDIT TOOLBAR - MOBILE OPTIMIZED
     ========================================== -->

<!-- ✅ WRAPPER ADDED -->
<div id="bulkEditToolbar" style="margin-bottom: 20px;">

  <!-- Main Dropdown Button - WITH ID FOR CONSISTENT WIDTH -->
  <div id="bulkEditDropdownWrapper" class="dropdown" style="margin-bottom: 12px; display: block;">
    <button class="btn btn-primary dropdown-toggle" 
            type="button" 
            id="bulkEditDropdown" 
            data-bs-toggle="dropdown" 
            aria-expanded="false" 
            style="font-weight: 600; width: 100%;">
      <i class="bi bi-pencil-square"></i> <span data-i18n="editProductsInBulk">Edit Products in Bulk</span>
    </button>
    <ul class="dropdown-menu shadow" aria-labelledby="bulkEditDropdown" style="min-width: 250px;">
      <li>
        <button type="button" class="dropdown-item d-flex justify-content-between align-items-center" onclick="showCategoryBulkEdit();">
          <span><i class="bi bi-tag"></i> <span data-i18n="updateCategory">Update Category</span></span>
          <i class="bi bi-chevron-right text-muted"></i>
        </button>
      </li>
      <li><hr class="dropdown-divider"></li>
      <li>
        <button type="button" class="dropdown-item d-flex justify-content-between align-items-center" onclick="showUnitTypeBulkEdit();">
          <span><i class="bi bi-card-text"></i> <span data-i18n="updateUnitType">Update Unit Type</span></span>
          <i class="bi bi-chevron-right text-muted"></i>
        </button>
      </li>
      <li><hr class="dropdown-divider"></li>
      <li>
        <button type="button" class="dropdown-item d-flex justify-content-between align-items-center" onclick="showStockAdjustmentEdit();">
          <span><i class="bi bi-boxes"></i> <span data-i18n="updateStock">Update Stock</span></span>
          <i class="bi bi-chevron-right text-muted"></i>
        </button>
      </li>
      <li>
        <button type="button" class="dropdown-item d-flex justify-content-between align-items-center" onclick="showSellingPriceBulkEdit();">
          <span><i class="bi bi-currency-rupee"></i> <span data-i18n="updateSellingPrice">Update Selling Price</span></span>
          <i class="bi bi-chevron-right text-muted"></i>
        </button>
      </li>
      <li>
        <button type="button" class="dropdown-item d-flex justify-content-between align-items-center" onclick="showStockStatusBulkEdit();">
          <span><i class="bi bi-circle-fill"></i> <span data-i18n="updateStockStatus">Update Stock Status</span></span>
          <i class="bi bi-chevron-right text-muted"></i>
        </button>
      </li>
      <li>
        <button type="button" class="dropdown-item d-flex justify-content-between align-items-center" onclick="showBrandBulkEdit();">
          <span><i class="bi bi-award"></i> <span data-i18n="updateBrand">Update Brand</span></span>
          <i class="bi bi-chevron-right text-muted"></i>
        </button>
      </li>
      <li>
        <button type="button" class="dropdown-item d-flex justify-content-between align-items-center" onclick="showSizeBulkEdit();">
          <span><i class="bi bi-rulers"></i> <span data-i18n="updateSize">Update Size</span></span>
          <i class="bi bi-chevron-right text-muted"></i>
        </button>
      </li>
    </ul>
  </div>

  <!-- ✅ BRAND INPUT CONTAINER - MOBILE OPTIMIZED -->
  <div id="brandInputContainer" style="display: none;">
    <!-- Input Field with Dropdown -->
    <div style="position: relative; margin-bottom: 12px;">
      <input 
        id="bulkBrandInput" 
        type="text" 
        class="form-control" 
        placeholder="e.g., Somany"
        data-i18n-placeholder="brandPlaceholder"
        autocomplete="off"
        onfocus="showBulkBrandSuggestions()"
        oninput="filterBulkBrandSuggestions(this.value); updateBulkBrandMode(this.value);"
        style="padding-right: 40px; font-size: 15px; font-weight: 600;">
      
      <!-- Save Brand Button (Inside Input) -->
      <button 
        id="saveBulkBrandInsideBtn" 
        onclick="saveNewBrandFromBulkField()" 
        style="
          position: absolute;
          right: 5px;
          top: 50%;
          transform: translateY(-50%);
          border: none;
          background: #28a745;
          color: white;
          border-radius: 5px;
          padding: 6px 12px;
          cursor: pointer;
          display: none;
          font-size: 14px;
          font-weight: 600;
          z-index: 10;
        ">
        💾
      </button>
      
      <!-- ✅ Brand Suggestions Dropdown - FIXED MAX HEIGHT -->
      <div id="brandSuggestionsDropdown" style="
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 0 0 8px 8px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        margin-bottom: 10px;
      "></div>
    </div>
    
    <!-- ✅ Buttons Stacked Vertically for Mobile -->
    <div style="display: flex; flex-direction: column; gap: 8px;">
      <!-- Update Brand Button - Compact -->
      <button id="updateBrandBtn" class="btn btn-success" style="display: none; font-weight: 600; color: white; font-size: 14px; padding: 10px 16px;" onclick="applyBulkBrandUpdate()">
        <i class="bi bi-check-circle"></i> <span data-i18n="update">Update</span> (<span id="selectedCountBrand" style="font-weight: 700;">0</span>)
      </button>
      
      <!-- Cancel Button -->
      <button id="cancelBulkEditBrandBtn" class="btn btn-secondary" style="display: none; font-weight: 600; font-size: 14px; padding: 10px 16px;" onclick="cancelBulkEdit()">
        <i class="bi bi-x-circle"></i> <span data-i18n="cancel">Cancel</span>
      </button>
    </div>
  </div>

  <!-- Selling Price Input Container -->
  <div id="sellingPriceInputContainer" style="display: none; margin-bottom: 12px;">
    <label style="font-size: 14px; font-weight: 600; color: #495057; margin-bottom: 8px; display: block;" data-i18n="enterSellingPriceToUpdate">Enter Selling Price to Update</label>
    <div class="input-group" style="margin-bottom: 12px;">
      <span class="input-group-text">₹</span>
      <input type="number" id="sellingPriceInput" class="form-control" placeholder="400" min="0" step="0.01" style="font-weight: 600; font-size: 15px;">
    </div>
  </div>
    
  <button id="updateSellingPriceBtn" class="btn btn-success" style="display: none; font-weight: 600; color: white; width: 100%; margin-bottom: 8px;" onclick="applyBulkSellingPriceUpdate()">
    <i class="bi bi-currency-rupee"></i> <span data-i18n="updateSellingPrice">Update Selling Price</span> (<span id="selectedCountSellingPrice" style="font-weight: 700;">0</span>)
  </button>

  <!-- ✅ SIZE INPUT CONTAINER - MOBILE OPTIMIZED -->
  <div id="sizeInputContainer" style="display: none;">
    <div style="position: relative; margin-bottom: 12px;">
      <input 
        id="bulkSizeInput" 
        type="text" 
        class="form-control" 
        placeholder="e.g., 2x2 feet"
        data-i18n-placeholder="sizePlaceholder"
        autocomplete="off"
        onfocus="showBulkSizeSuggestions()"
        oninput="filterBulkSizeSuggestions(this.value); updateBulkSizeMode(this.value); checkAndShowSaveBulkSizeButton(this.value);"
        style="padding-right: 40px; font-size: 15px; font-weight: 600;">
      
      <!-- Save Size Button -->
      <button 
        id="saveBulkSizeInsideBtn" 
        onclick="saveNewSizeFromBulkField()" 
        style="
          position: absolute;
          right: 5px;
          top: 50%;
          transform: translateY(-50%);
          border: none;
          background: #007bff;
          color: white;
          border-radius: 5px;
          padding: 6px 12px;
          cursor: pointer;
          display: none;
          font-size: 14px;
          font-weight: 600;
          z-index: 10;
        ">
        💾
      </button>
      
      <!-- ✅ Size Suggestions Dropdown - FIXED MAX HEIGHT -->
      <div id="sizeSuggestionsDropdown" style="
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-radius: 0 0 8px 8px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      "></div>
    </div>
    
    <!-- Buttons Stacked -->
    <div style="display: flex; flex-direction: column; gap: 8px;">
      <button id="updateSizeBtn" class="btn btn-success" style="display: none; font-weight: 600; color: white; font-size: 14px; padding: 10px 16px;" onclick="applyBulkSizeUpdate()">
        <i class="bi bi-check-circle"></i> <span data-i18n="update">Update</span> (<span id="selectedCountSize" style="font-weight: 700;">0</span>)
      </button>
      
      <button id="cancelBulkEditSizeBtn" class="btn btn-secondary" style="display: none; font-weight: 600; font-size: 14px; padding: 10px 16px;" onclick="cancelBulkEdit()">
        <i class="bi bi-x-circle"></i> <span data-i18n="cancel">Cancel</span>
      </button>
    </div>
  </div>

  <!-- Stock Adjustment Container -->
  <div id="stockAdjustmentContainer" style="display: none; margin-bottom: 12px;">
    <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap; margin-bottom: 12px;">
      <div class="input-group" style="flex: 1; min-width: 120px; max-width: 180px;">
        <input type="number" id="stockAdjustmentInput" class="form-control" placeholder="10" min="1" step="1" value="10" style="font-weight: 600; font-size: 15px;">
      </div>
      <div class="dropdown" style="flex: 1;">
        <button class="btn btn-outline-primary dropdown-toggle" type="button" id="stockOperationBtn" data-bs-toggle="dropdown" aria-expanded="false" style="font-weight: 600; width: 100%; font-size: 14px;">
          <i class="bi bi-dash-circle"></i> <span data-i18n="reduceBy">Reduce by</span>
        </button>
        <ul class="dropdown-menu" aria-labelledby="stockOperationBtn">
          <li><button class="dropdown-item" onclick="setStockOperation('add')"><i class="bi bi-plus-circle text-success"></i> <span data-i18n="addBy">Add by</span></button></li>
          <li><button class="dropdown-item" onclick="setStockOperation('reduce')"><i class="bi bi-dash-circle text-danger"></i> <span data-i18n="reduceBy">Reduce by</span></button></li>
        </ul>
      </div>
    </div>
    <small class="text-muted" style="display: block; margin-bottom: 8px;" data-i18n="clickToSelect"><i class="bi bi-info-circle"></i> Click on products to select them</small>
  </div>

  <!-- Stock Status Dropdown -->
  <div class="dropdown" id="stockStatusSelectionDropdown" style="display: none; margin-bottom: 12px;">
    <button class="btn btn-outline-primary dropdown-toggle" type="button" id="stockStatusDropdownBtn" data-bs-toggle="dropdown" aria-expanded="false" style="font-weight: 600; width: 100%; font-size: 14px;">
      <i class="bi bi-circle-fill"></i> <span id="selectedStockStatusText" data-i18n="selectStockStatus">Select Stock Status</span>
    </button>
    <ul class="dropdown-menu" aria-labelledby="stockStatusDropdownBtn">
      <li><button class="dropdown-item" onclick="selectBulkStockStatus('GOOD')"><span style="color: #28a745;">🟢</span> <span data-i18n="good">Good</span></button></li>
      <li><button class="dropdown-item" onclick="selectBulkStockStatus('MEDIUM')"><span style="color: #ffc107;">🟡</span> <span data-i18n="medium">Medium</span></button></li>
      <li><button class="dropdown-item" onclick="selectBulkStockStatus('LOW')"><span style="color: #dc3545;">🔴</span> <span data-i18n="low">Low</span></button></li>
      <li><button class="dropdown-item" onclick="selectBulkStockStatus('URGENT')"><span style="color: #6f42c1;">🔵</span> <span data-i18n="urgent">Urgent</span></button></li>
    </ul>
  </div>
  
  <button id="updateStockStatusBtn" class="btn btn-success" style="display: none; font-weight: 600; width: 100%; margin-bottom: 8px; font-size: 14px; padding: 10px;" onclick="applyBulkStockStatusUpdate()">
    <i class="bi bi-check-circle"></i> <span data-i18n="update">Update</span> (<span id="selectedCountStockStatus">0</span>)
  </button>

  <!-- Category Dropdown -->
  <div id="categorySelectionDropdown" class="dropdown" style="display: none; margin-bottom: 12px;">
    <button class="btn btn-outline-primary dropdown-toggle" type="button" id="categoryDropdownBtn" data-bs-toggle="dropdown" aria-expanded="false" style="font-weight: 600; width: 100%; font-size: 14px;">
      <i class="bi bi-funnel"></i> <span id="selectedCategoryText" data-i18n="selectCategory">Select Category</span>
    </button>
    <ul class="dropdown-menu shadow" aria-labelledby="categoryDropdownBtn" id="bulkCategoryDropdownMenu">
      <li><a class="dropdown-item text-muted" href="javascript:void(0);">Loading categories...</a></li>
    </ul>
  </div>

  <button id="updateCategoryBtn" class="btn btn-success" style="display: none; font-weight: 600; width: 100%; margin-bottom: 8px; font-size: 14px; padding: 10px;" onclick="applyBulkCategoryUpdate()">
    <i class="bi bi-check-circle"></i> <span data-i18n="update">Update</span> (<span id="selectedCount" style="font-weight: 700;">0</span>)
  </button>

  <!-- Unit Type Dropdown -->
  <div id="unitTypeSelectionDropdown" class="dropdown" style="display: none; margin-bottom: 12px;">
    <button class="btn btn-outline-info dropdown-toggle" type="button" id="unitTypeDropdownBtn" data-bs-toggle="dropdown" aria-expanded="false" style="font-weight: 600; width: 100%; font-size: 14px;">
      <i class="bi bi-card-text"></i> <span id="selectedUnitTypeText">Select Unit Type</span>
    </button>
    <ul class="dropdown-menu shadow" aria-labelledby="unitTypeDropdownBtn" id="bulkUnitTypeDropdownMenu">
      <li><a class="dropdown-item text-muted" href="javascript:void(0);">Loading unit types...</a></li>
    </ul>
  </div>

  <button id="updateUnitTypeBtn" class="btn btn-info" style="display: none; font-weight: 600; color: white; width: 100%; margin-bottom: 8px; font-size: 14px; padding: 10px;" onclick="applyBulkUnitTypeUpdate()">
    <i class="bi bi-check-circle"></i> <span data-i18n="update">Update</span> (<span id="selectedCountUnitType" style="font-weight: 700;">0</span>)
  </button>

  <!-- ✅ UNIVERSAL CANCEL BUTTON -->
  <button id="cancelBulkEditBtn" class="btn btn-secondary" style="display: none; width: 100%; font-weight: 600; font-size: 14px; padding: 10px;" onclick="cancelBulkEdit()">
    <i class="bi bi-x-circle"></i> <span data-i18n="cancel">Cancel</span>
  </button>

  <button id="updateStockChangesBtn" class="btn btn-primary" style="display: none; font-weight: 600; width: 100%; margin-bottom: 8px; font-size: 14px; padding: 10px;" onclick="updateStockChanges()">
    <i class="bi bi-check-circle"></i> <span data-i18n="update">Update</span>
  </button>

  <div id="bulkEditInfoText" style="display: none; color: #6c757d; font-size: 13px; font-weight: 500; text-align: center; margin-top: 8px;">
    <i class="bi bi-info-circle"></i> <span data-i18n="clickToSelect">Click on products to select them</span>
  </div>

<!-- ✅ CLOSE WRAPPER -->
</div>



    <!-- Controls Row -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <!-- Sort Button -->
  <button type="button" 
          class="btn btn-outline-success btn-sm" 
          onclick="return runIfNotExclusionMode(event, openSortOptionsModal)"
          data-i18n-title="sortProducts"
          title="Sort Products">
      <div class="d-flex align-items-center">
          <input type="checkbox" class="translation-exclusion-checkbox me-2" data-i18n-key="sort" onclick="handleTranslationCheckboxClick(event)">
          <i class="bi bi-sort-down"></i> 
          <span data-i18n="sort" class="ms-1 translation-exclusion-label">Sort</span>
      </div>
  </button>
</div>

<!-- Search Bar -->
<div class="row mb-3">
<div class="col-12">
  <!-- Checkbox for the placeholder text -->
  <div class="d-flex align-items-center mb-1 translation-exclusion-label" style="font-size: 0.8rem; color: #666;">
      <input type="checkbox" class="translation-exclusion-checkbox me-2" data-i18n-key="searchPlaceholder" onclick="handleTranslationCheckboxClick(event)">
      <span class="translation-exclusion-label"></span>
  </div>
  <input type="text" 
         id="productSearch" 
         class="form-control" 
         data-i18n-placeholder="searchPlaceholder"
         placeholder="🔍 Search..." 
         onkeyup="handleSearch()"
         style="max-width: 100%; font-size: 15px; padding: 12px 16px; border-radius: 10px;">
</div>
</div>



    

<!-- ==========================================
     PRODUCTS TABLE SECTION (INVENTORY VIEW)
     ========================================== -->
     <div id="productsSection">
      <!-- Products table (desktop) & mobile list -->
      <div class="row mb-4">
        <div class="col-12 desktop-table">
          <div class="table-explorer">
            <table class="table table-sm table-striped mb-0">
              <thead>
                <tr>
                  <th style="width:80px">
                      <input type="checkbox" class="translation-exclusion-checkbox" data-i18n-key="photo" onclick="handleTranslationCheckboxClick(event)">
                      <span data-i18n="photo" class="translation-exclusion-label">Photo</span>
                  </th>
                  <th>
                      <input type="checkbox" class="translation-exclusion-checkbox" data-i18n-key="product" onclick="handleTranslationCheckboxClick(event)">
                      <span data-i18n="product" class="translation-exclusion-label">Product</span>
                  </th>
                  <th>
                      <input type="checkbox" class="translation-exclusion-checkbox" data-i18n-key="category" onclick="handleTranslationCheckboxClick(event)">
                      <span data-i18n="category" class="translation-exclusion-label">Category</span>
                  </th>
                  <th>
                      <input type="checkbox" class="translation-exclusion-checkbox" data-i18n-key="brand" onclick="handleTranslationCheckboxClick(event)">
                      <span data-i18n="brand" class="translation-exclusion-label">Brand</span>
                  </th>
                  <th>
                      <input type="checkbox" class="translation-exclusion-checkbox" data-i18n-key="size" onclick="handleTranslationCheckboxClick(event)">
                      <span data-i18n="size" class="translation-exclusion-label">Size</span>
                  </th>
                  <th style="width:140px">
                      <input type="checkbox" class="translation-exclusion-checkbox" data-i18n-key="stock" onclick="handleTranslationCheckboxClick(event)">
                      <span data-i18n="stock" class="translation-exclusion-label">Stock</span>
                  </th>
                  <th style="width:140px">
                      <input type="checkbox" class="translation-exclusion-checkbox" data-i18n-key="price" onclick="handleTranslationCheckboxClick(event)">
                      <span data-i18n="price" class="translation-exclusion-label">Price</span>
                  </th>
                  <th style="width:150px">
                      <input type="checkbox" class="translation-exclusion-checkbox" data-i18n-key="actions" onclick="handleTranslationCheckboxClick(event)">
                      <span data-i18n="actions" class="translation-exclusion-label">Actions</span>
                  </th>
                </tr>
              </thead>
              <tbody id="productsTableBody"></tbody>
            </table>
          </div>
        </div>
        <div class="col-12 mobile-list" id="mobileProductsList" style="margin-top:6px;"></div>
      </div>
    </div>
    
    <!-- ==========================================
         SALES SECTION 
         ========================================== -->
    <div id="salesSection" style="display: none;">
      <div class="row">
        <div class="col-12">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center">
                <input type="checkbox" class="translation-exclusion-checkbox me-2" data-i18n-key="recentSales" onclick="handleTranslationCheckboxClick(event)">
                <h4 class="mb-0 translation-exclusion-label" data-i18n="recentSales">Recent Sales</h4>
            </div>
            <button class="btn btn-outline-danger btn-sm" onclick="return runIfNotExclusionMode(event, openClearSalesPopup)">
                <div class="d-flex align-items-center">
                    <input type="checkbox" class="translation-exclusion-checkbox me-2" data-i18n-key="clearSales" onclick="handleTranslationCheckboxClick(event)">
                    <i class="bi bi-trash"></i> 
                    <span data-i18n="clearSales" class="ms-1 translation-exclusion-label">Clear Sales</span>
                </div>
            </button>
          </div>
          <div class="table-responsive">
            <table class="table table-striped">
              <thead class="table-primary">
                <tr>
                  <th><input type="checkbox" class="translation-exclusion-checkbox" data-i18n-key="dateAndTime" onclick="handleTranslationCheckboxClick(event)"><span data-i18n="dateAndTime" class="translation-exclusion-label">Date & Time</span></th>
                  <th><input type="checkbox" class="translation-exclusion-checkbox" data-i18n-key="product" onclick="handleTranslationCheckboxClick(event)"><span data-i18n="product" class="translation-exclusion-label">Product</span></th>
                  <th><input type="checkbox" class="translation-exclusion-checkbox" data-i18n-key="quantity" onclick="handleTranslationCheckboxClick(event)"><span data-i18n="quantity" class="translation-exclusion-label">Quantity</span></th>
                  <th><input type="checkbox" class="translation-exclusion-checkbox" data-i18n-key="unit" onclick="handleTranslationCheckboxClick(event)"><span data-i18n="unit" class="translation-exclusion-label">Unit</span></th>
                  <th><input type="checkbox" class="translation-exclusion-checkbox" data-i18n-key="amount" onclick="handleTranslationCheckboxClick(event)"><span data-i18n="amount" class="translation-exclusion-label">Amount</span></th>
                </tr>
              </thead>
              <tbody id="salesList"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    
    <!-- ==========================================
         PURCHASES SECTION (HIDDEN BY DEFAULT)
         ========================================== -->
    <div id="purchasesSection" style="display: none;">
      <div class="row">
        <div class="col-12">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <div class="d-flex align-items-center">
                <input type="checkbox" class="translation-exclusion-checkbox me-2" data-i18n-key="recentPurchases" onclick="handleTranslationCheckboxClick(event)">
                <h4 class="mb-0 translation-exclusion-label" data-i18n="recentPurchases">Recent Purchases</h4>
            </div>
            <button class="btn btn-outline-success btn-sm" onclick="return runIfNotExclusionMode(event, loadRecentPurchases)">
                <div class="d-flex align-items-center">
                    <input type="checkbox" class="translation-exclusion-checkbox me-2" data-i18n-key="refresh" onclick="handleTranslationCheckboxClick(event)">
                    <i class="bi bi-arrow-clockwise"></i> 
                    <span data-i18n="refresh" class="ms-1 translation-exclusion-label">Refresh</span>
                </div>
            </button>
          </div>
          <div class="table-responsive">
            <table class="table table-striped table-hover">
              <thead class="table-success">
                <tr>
                  <th class="d-none d-lg-table-cell"><input type="checkbox" class="translation-exclusion-checkbox" data-i18n-key="serialNo" onclick="handleTranslationCheckboxClick(event)"><span data-i18n="serialNo" class="translation-exclusion-label">Serial No.</span></th>
                  <th class="d-none d-lg-table-cell"><input type="checkbox" class="translation-exclusion-checkbox" data-i18n-key="dateAndTime" onclick="handleTranslationCheckboxClick(event)"><span data-i18n="dateAndTime" class="translation-exclusion-label">Date & Time</span></th>
                  <th class="d-none d-lg-table-cell"><input type="checkbox" class="translation-exclusion-checkbox" data-i18n-key="photo" onclick="handleTranslationCheckboxClick(event)"><span data-i18n="photo" class="translation-exclusion-label">Photo</span></th>
                  <th class="d-none d-lg-table-cell"><input type="checkbox" class="translation-exclusion-checkbox" data-i18n-key="products" onclick="handleTranslationCheckboxClick(event)"><span data-i18n="products" class="translation-exclusion-label">Products</span></th>
                  <th class="d-none d-lg-table-cell"><input type="checkbox" class="translation-exclusion-checkbox" data-i18n-key="vendor" onclick="handleTranslationCheckboxClick(event)"><span data-i18n="vendor" class="translation-exclusion-label">Vendor</span></th>
                  <th class="d-none d-lg-table-cell"><input type="checkbox" class="translation-exclusion-checkbox" data-i18n-key="totalAmount" onclick="handleTranslationCheckboxClick(event)"><span data-i18n="totalAmount" class="translation-exclusion-label">Total Amount</span></th>
                  <th class="d-none d-lg-table-cell"><input type="checkbox" class="translation-exclusion-checkbox" data-i18n-key="paymentMode" onclick="handleTranslationCheckboxClick(event)"><span data-i18n="paymentMode" class="translation-exclusion-label">Payment Mode</span></th>
                  <th class="d-none d-lg-table-cell"><input type="checkbox" class="translation-exclusion-checkbox" data-i18n-key="otherInfo" onclick="handleTranslationCheckboxClick(event)"><span data-i18n="otherInfo" class="translation-exclusion-label">Other Info</span></th>
                  
                  <!-- Mobile headers -->
                  <th class="d-table-cell d-lg-none"><input type="checkbox" class="translation-exclusion-checkbox" data-i18n-key="date" onclick="handleTranslationCheckboxClick(event)"><span data-i18n="date" class="translation-exclusion-label">Date</span></th>
                  <th class="d-table-cell d-lg-none"><input type="checkbox" class="translation-exclusion-checkbox" data-i18n-key="vendor" onclick="handleTranslationCheckboxClick(event)"><span data-i18n="vendor" class="translation-exclusion-label">Vendor</span></th>
                  <th class="d-table-cell d-lg-none"><input type="checkbox" class="translation-exclusion-checkbox" data-i18n-key="amount" onclick="handleTranslationCheckboxClick(event)"><span data-i18n="amount" class="translation-exclusion-label">Amount</span></th>
                  <th class="d-table-cell d-lg-none"><input type="checkbox" class="translation-exclusion-checkbox" data-i18n-key="photo" onclick="handleTranslationCheckboxClick(event)"><span data-i18n="photo" class="translation-exclusion-label">Photo</span></th>
                </tr>
              </thead>
              <tbody id="purchasesList">
                 <tr>
                   <td colspan="8" style="text-align: center; padding: 20px; color: #999;">
                     <div class="d-flex justify-content-center align-items-center">
                        <input type="checkbox" class="translation-exclusion-checkbox me-2" data-i18n-key="loadingPurchases" onclick="handleTranslationCheckboxClick(event)">
                        <i class="bi bi-hourglass-split"></i> 
                        <span data-i18n="loadingPurchases" class="ms-1 translation-exclusion-label">Loading purchases...</span>
                     </div>
                   </td>
                 </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
    




 <!-- ✅✅✅ ALL PRODUCTS PAGE ✅✅✅ -->
<div class="page-view" id="allProductsPage">
  <!-- Header -->
  <div class="page-header">
    <button class="back-btn" onclick="goBackHome()">
      <i class="bi bi-arrow-left"></i> Back
    </button>
    <h3><i class="bi bi-box"></i> All Products</h3>
    <button class="btn btn-success" onclick="openAddProduct()">
      <i class="bi bi-plus-lg"></i> Add
    </button>
  </div>
  
    
    <!-- Products List Container -->
    <div id="allProductsList">
      <!-- Product cards will be rendered here by JavaScript -->
      <div style="text-align:center; padding:40px;">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-3">Loading products...</p>
      </div>
    </div>
    
    <!-- Empty State -->
    <div id="allProductsEmptyState" style="display:none; text-align:center; padding:60px 20px;">
      <i class="bi bi-box" style="font-size:64px; color:#ccc;"></i>
      <h4 style="margin-top:20px;">No Products Yet</h4>
      <p>Add your first product to get started</p>
      <button class="btn btn-primary mt-3" onclick="openAddProduct()">
        <i class="bi bi-plus-lg"></i> Add First Product
      </button>
    </div>
  </div>
</div>


<!-- ✅ NEW: Product Groups Page -->
<div class="page-view" id="productGroupsPage">
  <div class="page-header">
       <button class="back-btn" onclick="navigateTo('dashboard')">
      <i class="bi bi-arrow-left"></i> Back
    </button>

    <h3>Products in Group</h3>
    <button class="btn btn-success" onclick="openCreateGroupModal()">
      <i class="bi bi-plus-lg"></i> Create
    </button>
  </div>
  
  <!-- Groups List -->
  <div id="productGroupsList">
    <!-- Groups will be rendered here -->
  </div>
  
  <!-- Empty State -->
  <div id="groupsEmptyState" style="display:none; text-align:center; padding:60px 20px;">
    <i class="bi bi-collection" style="font-size:64px; color:#ccc;"></i>
    <h4 style="margin-top:20px; color:#666;">No Product Groups Yet</h4>
    <p style="color:#999;">Create your first product group to manage variants</p>
    <button class="btn btn-primary mt-3" onclick="openCreateGroupModal()">
      <i class="bi bi-plus-lg"></i> Create First Group
    </button>
  </div>
</div>




<!-- ✅✅✅ UNIT TYPES PAGE ✅✅✅ -->
<div class="page-view" id="unitTypesPage">
  <!-- Header -->
  <div class="page-header">
    <button class="back-btn" onclick="navigateTo('dashboard')">
      <i class="bi bi-arrow-left"></i> Back
    </button>
    <h3><i class="bi bi-card-text"></i> Unit Types</h3>
    <button class="btn btn-success" onclick="openAddUnitTypeModal()">
      <i class="bi bi-plus-lg"></i> Add
    </button>
  </div>
  
  <!-- Search Box -->
  <div class="container-fluid" style="padding: 20px;">
    <input 
      type="text" 
      class="form-control mb-3" 
      id="searchUnitTypesInput" 
      placeholder="🔍 Search unit types..." 
      onkeyup="filterUnitTypes(this.value)"
      style="max-width: 600px; margin: 0 auto;"
    >
    
    <!-- Unit Types List Container -->
    <div id="unitTypesListContainer">
      <!-- Unit type cards will be rendered here by JavaScript -->
      <div style="text-align:center; padding:40px;">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-3">Loading unit types...</p>
      </div>
    </div>
    
    <!-- Empty State -->
    <div id="unitTypesEmptyState" style="display:none; text-align:center; padding:60px 20px;">
      <i class="bi bi-card-text" style="font-size:64px; color:#ccc;"></i>
      <h4 style="margin-top:20px;">No Unit Types Yet</h4>
      <p>Add your first unit type to get started</p>
      <button class="btn btn-primary mt-3" onclick="openAddUnitTypeModal()">
        <i class="bi bi-plus-lg"></i> Add First Unit Type
      </button>
    </div>
  </div>
</div>


<!-- ✅✅✅ ADD UNIT TYPES MODAL ✅✅✅ -->
<div class="modal fade" id="addUnitTypesModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title">
          <i class="bi bi-plus-circle"></i> Add New Unit Types
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
  
        <!-- Instructions -->
        <div class="alert alert-warning" style="font-size: 14px;">
          <i class="bi bi-info-circle"></i>
          Enter unit type names below. Press <strong>Enter</strong> or <strong>Comma (,)</strong> after each unit type, or click <strong>Add to List</strong>.
        </div>
        
        <!-- Input Field -->
        <input 
          id="unitTypeInput" 
          type="text" 
          class="form-control form-control-lg mb-2" 
          placeholder="e.g., Box, Piece, Square Feet, Meter..."
          onkeydown="handleUnitTypeInputKeydown(event)"
          oninput="window.lastUnitTypeInput = this.value"
          autocomplete="off"
          style="color: #212529; background-color: #fff;"
        >
        
        <!-- Add to List Button -->
        <button 
          type="button"
          class="btn btn-warning w-100"
          onmousedown="event.preventDefault(); (function(){
            var val = window.lastUnitTypeInput ? window.lastUnitTypeInput.trim() : document.getElementById('unitTypeInput').value.trim();
            console.log('✅ Button clicked, value:', val);
            if(!val || val.length === 0) { 
              alert('⚠️ Please enter a unit type'); 
              return; 
            }
            if(typeof pendingUnitTypes === 'undefined') {
              pendingUnitTypes = [];
            }
            if(pendingUnitTypes.includes(val)) { 
              alert('⚠️ Unit type already in list!'); 
              return; 
            }
            pendingUnitTypes.push(val);
            if(typeof updateUnitTypePreviewList === 'function') {
              updateUnitTypePreviewList();
            }
            console.log('✅ Added:', val);
            
            // Clear input
            document.querySelectorAll('#unitTypeInput').forEach(function(inp){
              inp.value = '';
              inp.setAttribute('value', '');
              window.lastUnitTypeInput = '';
              inp.dispatchEvent(new Event('input', { bubbles: true }));
            });
            console.log('🧹 Input cleared');
            
            setTimeout(function(){ 
              document.getElementById('unitTypeInput').focus(); 
            }, 50);
          })()"
          style="padding: 10px; font-size: 16px;"
        >
          <i class="bi bi-plus-lg"></i> Add to List
        </button>
        
        <!-- Preview Section -->
        <div style="margin-top: 20px;">
          <p style="font-weight: 600; margin-bottom: 10px; font-size: 14px; color: #333;" id="unitTypePreviewCount">
            📝 Unit Types to Save (0):
          </p>
          <div id="unitTypePreviewList" style="
            background: #f8f9fa; 
            border: 1px solid #e0e0e0;
            border-radius: 8px; 
            max-height: 250px; 
            overflow-y: auto;
            min-height: 80px; 
            padding: 10px;
          ">
            <div style="padding: 15px; color: #999; text-align: center; font-size: 14px;">
              No unit types added yet
            </div>
          </div>
        </div>
        
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle"></i> Cancel
        </button>
        <button type="button" class="btn btn-warning" onclick="saveAllUnitTypes()">
          <i class="bi bi-check-circle"></i> Save All Unit Types
        </button>
      </div>
    </div>
  </div>
</div>


<!-- ✅✅✅ CATEGORIES PAGE ✅✅✅ -->
<div class="page-view" id="categoriesPage">
  <!-- Header -->
  <div class="page-header">
    <button class="back-btn" onclick="navigateTo('dashboard')">
      <i class="bi bi-arrow-left"></i> Back
    </button>
    <h3><i class="bi bi-grid-3x3-gap"></i> Categories</h3>
    <button class="btn btn-success" onclick="openAddCategoryModal()">
      <i class="bi bi-plus-lg"></i> Add
    </button>
  </div>
  
  <!-- Search Box -->
  <div class="container-fluid" style="padding: 20px;">
    <input 
      type="text" 
      class="form-control mb-3" 
      id="searchCategoriesInput" 
      placeholder="🔍 Search categories..." 
      onkeyup="filterCategories(this.value)"
      style="max-width: 600px; margin: 0 auto;"
    >
    
    <!-- Categories List Container -->
    <div id="categoriesListContainer">
      <!-- Category cards will be rendered here by JavaScript -->
      <div style="text-align:center; padding:40px;">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-3">Loading categories...</p>
      </div>
    </div>
    
    <!-- Empty State -->
    <div id="categoriesEmptyState" style="display:none; text-align:center; padding:60px 20px;">
      <i class="bi bi-grid-3x3-gap" style="font-size:64px; color:#ccc;"></i>
      <h4 style="margin-top:20px;">No Categories Yet</h4>
      <p>Add your first category to get started</p>
      <button class="btn btn-primary mt-3" onclick="openAddCategoryModal()">
        <i class="bi bi-plus-lg"></i> Add First Category
      </button>
    </div>
  </div>
</div>

<!-- ✅ Add Categories Modal -->
<div class="modal fade" id="addCategoriesModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title">
          <i class="bi bi-plus-circle"></i> Add New Categories
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
  
        <!-- Instructions -->
        <div class="alert alert-info" style="font-size: 14px;">
          <i class="bi bi-info-circle"></i>
          Enter category names below. Press <strong>Enter</strong> or <strong>Comma (,)</strong> after each category, or click <strong>Add to List</strong>.
        </div>
        
        <!-- Input Field -->
        <input 
          id="categoryInput" 
          type="text" 
          class="form-control form-control-lg mb-2" 
          placeholder="e.g., Kitchen Tiles, Bathroom Tiles, Floor Tiles..."
          onkeydown="handleCategoryInputKeydown(event)"
          oninput="window.lastCategoryInput = this.value"
          autocomplete="off"
          style="color: #212529; background-color: #fff;"
        >
        
        <!-- Add to List Button -->
        <button 
          type="button"
          class="btn btn-info w-100"
          onmousedown="event.preventDefault(); (function(){
            var val = window.lastCategoryInput ? window.lastCategoryInput.trim() : document.getElementById('categoryInput').value.trim();
            console.log('✅ Button clicked, value:', val);
            if(!val || val.length === 0) { 
              alert('⚠️ Please enter a category'); 
              return; 
            }
            if(typeof pendingCategories === 'undefined') {
              pendingCategories = [];
            }
            if(pendingCategories.includes(val)) { 
              alert('⚠️ Category already in list!'); 
              return; 
            }
            pendingCategories.push(val);
            if(typeof updateCategoryPreviewList === 'function') {
              updateCategoryPreviewList();
            }
            console.log('✅ Added:', val);
            
            // Clear input
            document.querySelectorAll('#categoryInput').forEach(function(inp){
              inp.value = '';
              inp.setAttribute('value', '');
              window.lastCategoryInput = '';
              inp.dispatchEvent(new Event('input', { bubbles: true }));
            });
            console.log('🧹 Input cleared');
            
            setTimeout(function(){ 
              document.getElementById('categoryInput').focus(); 
            }, 50);
          })()"
          style="padding: 10px; font-size: 16px;"
        >
          <i class="bi bi-plus-lg"></i> Add to List
        </button>
        
        <!-- Preview Section -->
        <div style="margin-top: 20px;">
          <p style="font-weight: 600; margin-bottom: 10px; font-size: 14px; color: #333;" id="categoryPreviewCount">
            📝 Categories to Save (0):
          </p>
          <div id="categoryPreviewList" style="
            background: #f8f9fa; 
            border: 1px solid #e0e0e0;
            border-radius: 8px; 
            max-height: 250px; 
            overflow-y: auto;
            min-height: 80px; 
            padding: 10px;
          ">
            <div style="padding: 15px; color: #999; text-align: center; font-size: 14px;">
              No categories added yet
            </div>
          </div>
        </div>
        
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle"></i> Cancel
        </button>
        <button type="button" class="btn btn-info" onclick="saveAllCategories()">
          <i class="bi bi-check-circle"></i> Save All Categories
        </button>
      </div>
    </div>
  </div>
</div>


 <!-- ✅✅✅ BRANDS PAGE ✅✅✅ -->
<div class="page-view" id="brandsPage">
  <!-- Header -->
  <div class="page-header">
    <button class="back-btn" onclick="goBackHome()">
      <i class="bi bi-arrow-left"></i> Back
    </button>
    <h3><i class="bi bi-tags"></i> Brands</h3>
    <button class="btn btn-success" onclick="openAddBrandModal()">
      <i class="bi bi-plus-lg"></i> Add
    </button>
  </div>
  
  <!-- Search Box -->
  <div class="container-fluid" style="padding: 20px;">
    <input 
      type="text" 
      class="form-control mb-3" 
      id="searchBrandsInput" 
      placeholder="🔍 Search brands..." 
      onkeyup="filterBrands(this.value)"
      style="max-width: 600px; margin: 0 auto;"
    >
    
    <!-- Brands List Container -->
    <div id="brandsListContainer">
      <!-- Brand cards will be rendered here by JavaScript -->
      <div style="text-align:center; padding:40px;">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-3">Loading brands...</p>
      </div>
    </div>
    
    <!-- Empty State -->
    <div id="brandsEmptyState" style="display:none; text-align:center; padding:60px 20px;">
      <i class="bi bi-tags" style="font-size:64px; color:#ccc;"></i>
      <h4 style="margin-top:20px;">No Brands Yet</h4>
      <p>Add your first brand to get started</p>
      <button class="btn btn-primary mt-3" onclick="openAddBrandModal()">
        <i class="bi bi-plus-lg"></i> Add First Brand
      </button>
    </div>
  </div>
</div>

<!-- ✅ Add Brands Modal (WORKING VERSION) -->
<div class="modal fade" id="addBrandsModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">
          <i class="bi bi-plus-circle"></i> Add New Brands
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
  
        <!-- Instructions -->
        <div class="alert alert-info" style="font-size: 14px;">
          <i class="bi bi-info-circle"></i>
          Enter brand names below. Press <strong>Enter</strong> or <strong>Comma (,)</strong> after each brand, or click <strong>Add to List</strong>.
        </div>
        
        <!-- Input Field with stored value -->
        <input 
          id="brandInput" 
          type="text" 
          class="form-control form-control-lg mb-2" 
          placeholder="e.g., Samsung, Apple, Sony..."
          onkeydown="handleBrandInputKeydown(event)"
          oninput="window.lastBrandInput = this.value"
          autocomplete="off"
          style="color: #212529; background-color: #fff;"
        >
        
        <!-- Add to List Button (FIXED with working clear) -->
        <button 
          type="button"
          class="btn btn-success w-100"
          onmousedown="event.preventDefault(); (function(){
            var val = window.lastBrandInput ? window.lastBrandInput.trim() : document.getElementById('brandInput').value.trim();
            console.log('✅ Button clicked, value:', val);
            if(!val || val.length === 0) { 
              alert('⚠️ Please enter a brand name'); 
              return; 
            }
            if(typeof pendingBrands === 'undefined') {
              pendingBrands = [];
            }
            if(pendingBrands.includes(val)) { 
              alert('⚠️ Brand already in list!'); 
              return; 
            }
            pendingBrands.push(val);
            if(typeof updateBrandPreviewList === 'function') {
              updateBrandPreviewList();
            }
            console.log('✅ Added:', val);
            
            // ✅ Use WORKING clear method
            document.querySelectorAll('#brandInput').forEach(function(inp){
              inp.value = '';
              inp.setAttribute('value', '');
              window.lastBrandInput = '';
              inp.dispatchEvent(new Event('input', { bubbles: true }));
            });
            console.log('🧹 Input cleared');
            
            setTimeout(function(){ 
              document.getElementById('brandInput').focus(); 
            }, 50);
          })()"
          style="padding: 10px; font-size: 16px;"
        >
          <i class="bi bi-plus-lg"></i> Add to List
        </button>
        
        <!-- Preview Section -->
        <div style="margin-top: 20px;">
          <p style="font-weight: 600; margin-bottom: 10px; font-size: 14px; color: #333;" id="previewCount">
            📝 Brands to Save (0):
          </p>
          <div id="brandPreviewList" style="
            background: #f8f9fa; 
            border: 1px solid #e0e0e0;
            border-radius: 8px; 
            max-height: 250px; 
            overflow-y: auto;
            min-height: 80px; 
            padding: 10px;
          ">
            <div style="padding: 15px; color: #999; text-align: center; font-size: 14px;">
              No brands added yet
            </div>
          </div>
        </div>
        
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle"></i> Cancel
        </button>
        <button type="button" class="btn btn-success" onclick="saveAllBrands()">
          <i class="bi bi-check-circle"></i> Save All Brands
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ✅✅✅ SIZES PAGE ✅✅✅ -->
<div class="page-view" id="sizesPage">
  <!-- Header -->
  <div class="page-header">
    <button class="back-btn" onclick="navigateTo('dashboard')">
      <i class="bi bi-arrow-left"></i> Back
    </button>
    <h3><i class="bi bi-rulers"></i> Sizes</h3>
    <button class="btn btn-success" onclick="openAddSizeModal()">
      <i class="bi bi-plus-lg"></i> Add
    </button>
  </div>
  
  <!-- Search Box -->
  <div class="container-fluid" style="padding: 20px;">
    <input 
      type="text" 
      class="form-control mb-3" 
      id="searchSizesInput" 
      placeholder="🔍 Search sizes..." 
      onkeyup="filterSizes(this.value)"
      style="max-width: 600px; margin: 0 auto;"
    >
    
    <!-- Sizes List Container -->
    <div id="sizesListContainer">
      <!-- Size cards will be rendered here by JavaScript -->
      <div style="text-align:center; padding:40px;">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-3">Loading sizes...</p>
      </div>
    </div>
    
    <!-- Empty State -->
    <div id="sizesEmptyState" style="display:none; text-align:center; padding:60px 20px;">
      <i class="bi bi-rulers" style="font-size:64px; color:#ccc;"></i>
      <h4 style="margin-top:20px;">No Sizes Yet</h4>
      <p>Add your first size to get started</p>
      <button class="btn btn-primary mt-3" onclick="openAddSizeModal()">
        <i class="bi bi-plus-lg"></i> Add First Size
      </button>
    </div>
  </div>
</div>


<!-- ✅ Add Sizes Modal -->
<div class="modal fade" id="addSizesModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <i class="bi bi-plus-circle"></i> Add New Sizes
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
  
        <!-- Instructions -->
        <div class="alert alert-info" style="font-size: 14px;">
          <i class="bi bi-info-circle"></i>
          Enter size names below. Press <strong>Enter</strong> or <strong>Comma (,)</strong> after each size, or click <strong>Add to List</strong>.
        </div>
        
        <!-- Input Field -->
        <input 
          id="sizeInput" 
          type="text" 
          class="form-control form-control-lg mb-2" 
          placeholder="e.g., 2x2 feet, 600x600 mm, Standard..."
          onkeydown="handleSizeInputKeydown(event)"
          oninput="window.lastSizeInput = this.value"
          autocomplete="off"
          style="color: #212529; background-color: #fff;"
        >
        
        <!-- Add to List Button -->
        <button 
          type="button"
          class="btn btn-primary w-100"
          onmousedown="event.preventDefault(); (function(){
            var val = window.lastSizeInput ? window.lastSizeInput.trim() : document.getElementById('sizeInput').value.trim();
            console.log('✅ Button clicked, value:', val);
            if(!val || val.length === 0) { 
              alert('⚠️ Please enter a size'); 
              return; 
            }
            if(typeof pendingSizes === 'undefined') {
              pendingSizes = [];
            }
            if(pendingSizes.includes(val)) { 
              alert('⚠️ Size already in list!'); 
              return; 
            }
            pendingSizes.push(val);
            if(typeof updateSizePreviewList === 'function') {
              updateSizePreviewList();
            }
            console.log('✅ Added:', val);
            
            // Clear input
            document.querySelectorAll('#sizeInput').forEach(function(inp){
              inp.value = '';
              inp.setAttribute('value', '');
              window.lastSizeInput = '';
              inp.dispatchEvent(new Event('input', { bubbles: true }));
            });
            console.log('🧹 Input cleared');
            
            setTimeout(function(){ 
              document.getElementById('sizeInput').focus(); 
            }, 50);
          })()"
          style="padding: 10px; font-size: 16px;"
        >
          <i class="bi bi-plus-lg"></i> Add to List
        </button>
        
        <!-- Preview Section -->
        <div style="margin-top: 20px;">
          <p style="font-weight: 600; margin-bottom: 10px; font-size: 14px; color: #333;" id="sizePreviewCount">
            📝 Sizes to Save (0):
          </p>
          <div id="sizePreviewList" style="
            background: #f8f9fa; 
            border: 1px solid #e0e0e0;
            border-radius: 8px; 
            max-height: 250px; 
            overflow-y: auto;
            min-height: 80px; 
            padding: 10px;
          ">
            <div style="padding: 15px; color: #999; text-align: center; font-size: 14px;">
              No sizes added yet
            </div>
          </div>
        </div>
        
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle"></i> Cancel
        </button>
        <button type="button" class="btn btn-primary" onclick="saveAllSizes()">
          <i class="bi bi-check-circle"></i> Save All Sizes
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ==========================================
     ⚙️ SETTINGS PAGE
     ========================================== -->
     <div class="page-view" id="settingsPage">
      <!-- Header -->
      <div class="page-header">
        <button class="back-btn" onclick="navigateToHome()">
          <i class="bi bi-arrow-left"></i> Back
        </button>
        <h3><i class="bi bi-gear-fill"></i> Settings</h3>
        <div style="width: 60px;"></div> <!-- Spacer for alignment -->
      </div>
      
      <!-- Settings Content -->
      <div class="container-fluid" style="padding: 20px;">
        
        <!-- Settings Categories -->
        <div class="row g-3">
          
          <!-- Add Product Modal Settings -->
          <div class="col-md-6 col-lg-4">
            <div class="card h-100" style="border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s; cursor: pointer;" onmouseover="this.style.boxShadow='0 4px 16px rgba(0,0,0,0.15)'" onmouseout="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'" onclick="openAddProductModalSettings()">
              <div class="card-body" style="padding: 25px;">
                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                  <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                    <i class="bi bi-box-seam" style="font-size: 1.5rem; color: white;"></i>
                  </div>
                  <div>
                    <h5 class="card-title mb-1" style="font-weight: 700;" data-i18n="addProductModalSettings">Add Product Modal Settings</h5>
                    <p class="card-text text-muted mb-0" style="font-size: 0.9rem;" data-i18n="customizeFields">Customize which fields to show/hide</p>
                  </div>
                </div>
                <div class="text-end">
                  <i class="bi bi-chevron-right" style="font-size: 1.5rem; color: #667eea;"></i>
                </div>
              </div>
            </div>
          </div>
    
          <!-- Invoice Settings (Placeholder for future) -->
          <div class="col-md-6 col-lg-4">
            <div class="card h-100" style="border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s; opacity: 0.6;" onmouseover="this.style.boxShadow='0 4px 16px rgba(0,0,0,0.15)'" onmouseout="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'">
              <div class="card-body" style="padding: 25px;">
                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                  <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                    <i class="bi bi-receipt" style="font-size: 1.5rem; color: white;"></i>
                  </div>
                  <div>
                    <h5 class="card-title mb-1" style="font-weight: 700;" data-i18n="invoiceSettings">Invoice Settings</h5>
                    <p class="card-text text-muted mb-0" style="font-size: 0.9rem;" data-i18n="comingSoon">Coming Soon</p>
                  </div>
                </div>
                <div class="text-end">
                  <i class="bi bi-lock" style="font-size: 1.5rem; color: #999;"></i>
                </div>
              </div>
            </div>
          </div>
    
          <!-- Backup & Restore -->
          <div class="col-md-6 col-lg-4">
            <div class="card h-100" style="border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s; opacity: 0.6;" onmouseover="this.style.boxShadow='0 4px 16px rgba(0,0,0,0.15)'" onmouseout="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'">
              <div class="card-body" style="padding: 25px;">
                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                  <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                    <i class="bi bi-cloud-arrow-up" style="font-size: 1.5rem; color: white;"></i>
                  </div>
                  <div>
                    <h5 class="card-title mb-1" style="font-weight: 700;" data-i18n="backupRestore">Backup & Restore</h5>
                    <p class="card-text text-muted mb-0" style="font-size: 0.9rem;" data-i18n="comingSoon">Coming Soon</p>
                  </div>
                </div>
                <div class="text-end">
                  <i class="bi bi-lock" style="font-size: 1.5rem; color: #999;"></i>
                </div>
              </div>
            </div>
          </div>
    
          <!-- Language Settings -->
          <div class="col-md-6 col-lg-4">
            <div class="card h-100" style="border: none; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: all 0.3s; opacity: 0.6;" onmouseover="this.style.boxShadow='0 4px 16px rgba(0,0,0,0.15)'" onmouseout="this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'">
              <div class="card-body" style="padding: 25px;">
                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                  <div style="width: 50px; height: 50px; background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                    <i class="bi bi-translate" style="font-size: 1.5rem; color: white;"></i>
                  </div>
                  <div>
                    <h5 class="card-title mb-1" style="font-weight: 700;" data-i18n="languageSettings">Language Settings</h5>
                    <p class="card-text text-muted mb-0" style="font-size: 0.9rem;" data-i18n="comingSoon">Coming Soon</p>
                  </div>
                </div>
                <div class="text-end">
                  <i class="bi bi-lock" style="font-size: 1.5rem; color: #999;"></i>
                </div>
              </div>
            </div>
          </div>
    
        </div>
    
      </div>
    </div>
<!-- ==========================================
     📦 ADD PRODUCT MODAL SETTINGS - FRESH
     ========================================== -->
     <div class="modal fade" id="addProductModalSettingsModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
        <div class="modal-content">
          
          <!-- Header -->
          <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <h5 class="modal-title">
              <i class="bi bi-gear-fill"></i> Configure Add Product Fields
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          
          <!-- Body -->
          <div class="modal-body" style="padding: 25px;">
            
            <p style="color: #6c757d; font-size: 0.95rem; margin-bottom: 20px;">
              <i class="bi bi-info-circle-fill" style="color: #17a2b8;"></i>
              Choose which fields to display in the Add Product form:
            </p>
            
            <!-- Checkbox 1: Category -->
            <label style="display: flex; align-items: center; padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 12px; cursor: pointer; border-left: 4px solid #667eea;">
              <input type="checkbox" id="showCategoryField" style="width: 24px; height: 24px; margin-right: 12px; cursor: pointer; flex-shrink: 0;">
              <span style="font-size: 1rem; font-weight: 500;">
                <i class="bi bi-tag" style="color: #667eea;"></i> Category
              </span>
            </label>
            
            <!-- Checkbox 2: Unit Type -->
            <label style="display: flex; align-items: center; padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 12px; cursor: pointer; border-left: 4px solid #667eea;">
              <input type="checkbox" id="showUnitTypeField" style="width: 24px; height: 24px; margin-right: 12px; cursor: pointer; flex-shrink: 0;">
              <span style="font-size: 1rem; font-weight: 500;">
                <i class="bi bi-card-text" style="color: #667eea;"></i> Unit Type
              </span>
            </label>
            
            <!-- Checkbox 3: Selling Price -->
            <label style="display: flex; align-items: center; padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 12px; cursor: pointer; border-left: 4px solid #28a745;">
              <input type="checkbox" id="showSellingPriceField" style="width: 24px; height: 24px; margin-right: 12px; cursor: pointer; flex-shrink: 0;">
              <span style="font-size: 1rem; font-weight: 500;">
                <i class="bi bi-currency-rupee" style="color: #28a745;"></i> Selling Price
              </span>
            </label>
            
            <!-- Checkbox 4: Brand -->
            <label style="display: flex; align-items: center; padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 12px; cursor: pointer; border-left: 4px solid #ffc107;">
              <input type="checkbox" id="showBrandField" style="width: 24px; height: 24px; margin-right: 12px; cursor: pointer; flex-shrink: 0;">
              <span style="font-size: 1rem; font-weight: 500;">
                <i class="bi bi-award" style="color: #ffc107;"></i> Brand
              </span>
            </label>
            
            <!-- Checkbox 5: Size -->
            <label style="display: flex; align-items: center; padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 12px; cursor: pointer; border-left: 4px solid #17a2b8;">
              <input type="checkbox" id="showSizeField" style="width: 24px; height: 24px; margin-right: 12px; cursor: pointer; flex-shrink: 0;">
              <span style="font-size: 1rem; font-weight: 500;">
                <i class="bi bi-rulers" style="color: #17a2b8;"></i> Size
              </span>
            </label>
            
            <!-- Checkbox 6: Pieces per Box -->
            <label style="display: flex; align-items: center; padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 12px; cursor: pointer; border-left: 4px solid #6c757d;">
              <input type="checkbox" id="showPiecesPerBoxField" style="width: 24px; height: 24px; margin-right: 12px; cursor: pointer; flex-shrink: 0;">
              <span style="font-size: 1rem; font-weight: 500;">
                <i class="bi bi-box" style="color: #6c757d;"></i> Pieces per Box
              </span>
            </label>
            
            <!-- Checkbox 7: SFT per Box -->
            <label style="display: flex; align-items: center; padding: 15px; background: #f8f9fa; border-radius: 8px; margin-bottom: 12px; cursor: pointer; border-left: 4px solid #dc3545;">
              <input type="checkbox" id="showSftPerBoxField" style="width: 24px; height: 24px; margin-right: 12px; cursor: pointer; flex-shrink: 0;">
              <span style="font-size: 1rem; font-weight: 500;">
                <i class="bi bi-bounding-box" style="color: #dc3545;"></i> SFT per Box
              </span>
            </label>
            
            <!-- Info Alert -->
            <div class="alert alert-info" style="margin-top: 20px; border-left: 4px solid #17a2b8;">
              <i class="bi bi-info-circle"></i>
              <strong>Always Visible:</strong> Product Name, Photo, Stock Status, and Stock Quantity
            </div>
            
          </div>
          
          <!-- Footer -->
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              <i class="bi bi-x-circle"></i> Cancel
            </button>
            <button type="button" class="btn btn-primary" onclick="saveAddProductModalSettings()">
              <i class="bi bi-check-circle"></i> Apply Settings
            </button>
          </div>
          
        </div>
      </div>
    </div>
    
    

    
            </div>
    
          </div>
        </div>
      </div>
    </div>
    

<!-- ✅✅✅ INVOICE CUSTOMERS PAGE ✅✅✅ -->
<div class="page-view" id="invoiceCustomersPage">
  <!-- Header -->
  <div class="page-header">
    <button class="back-btn" onclick="goBackHome()">
      <i class="bi bi-arrow-left"></i> Back
    </button>
    <h3><i class="bi bi-receipt-cutoff"></i> Customers</h3>
    <button class="btn btn-success" onclick="openAddInvoiceCustomerModal()">
      <i class="bi bi-plus-lg"></i> Add
    </button>
  </div>
  
  <!-- Search Box -->
  <div class="container-fluid" style="padding: 20px;">
    <input 
      type="text" 
      class="form-control mb-3" 
      id="searchInvoiceCustomersInput" 
      placeholder="🔍 Search invoice customers..." 
      onkeyup="filterInvoiceCustomers(this.value)"
      style="max-width: 600px; margin: 0 auto;"
    >
    
    <!-- Invoice Customers List Container -->
    <div id="invoiceCustomersListContainer">
      <!-- Invoice customer cards will be rendered here by JavaScript -->
      <div style="text-align:center; padding:40px;">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-3">Loading invoice customers...</p>
      </div>
    </div>
    
    <!-- Empty State -->
    <div id="invoiceCustomersEmptyState" style="display:none; text-align:center; padding:60px 20px;">
      <i class="bi bi-receipt-cutoff" style="font-size:64px; color:#ccc;"></i>
      <h4 style="margin-top:20px;">No Invoice Customers Yet</h4>
      <p>Add your first invoice customer to get started</p>
      <button class="btn btn-primary mt-3" onclick="openAddInvoiceCustomerModal()">
        <i class="bi bi-plus-lg"></i> Add First Invoice Customer
      </button>
    </div>
  </div>
</div>


<!-- ✅ Add Invoice Customers Modal -->
<div class="modal fade" id="addInvoiceCustomersModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">
          <i class="bi bi-plus-circle"></i> Add New Invoice Customers
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
  
        <!-- Instructions -->
        <div class="alert alert-info" style="font-size: 14px;">
          <i class="bi bi-info-circle"></i>
          Enter customer names below. Press <strong>Enter</strong> or <strong>Comma (,)</strong> after each customer, or click <strong>Add to List</strong>.
        </div>
        
        <!-- Input Field -->
        <input 
          id="invoiceCustomerInput" 
          type="text" 
          class="form-control form-control-lg mb-2" 
          placeholder="e.g., John Builders, ABC Construction..."
          onkeydown="handleInvoiceCustomerInputKeydown(event)"
          oninput="window.lastInvoiceCustomerInput = this.value"
          autocomplete="off"
          style="color: #212529; background-color: #fff;"
        >
        
        <!-- Add to List Button -->
        <button 
          type="button"
          class="btn btn-success w-100"
          onclick="addInvoiceCustomerToList()"
          style="padding: 10px; font-size: 16px;"
        >
          <i class="bi bi-plus-lg"></i> Add to List
        </button>
        
        <!-- Preview Section -->
        <div style="margin-top: 20px;">
          <p style="font-weight: 600; margin-bottom: 10px; font-size: 14px; color: #333;" id="invoiceCustomerPreviewCount">
            📝 Customers to Save (0):
          </p>
          <div id="invoiceCustomerPreviewList" style="
            background: #f8f9fa; 
            border: 1px solid #e0e0e0;
            border-radius: 8px; 
            max-height: 250px; 
            overflow-y: auto;
            min-height: 80px; 
            padding: 10px;
          ">
            <div style="padding: 15px; color: #999; text-align: center; font-size: 14px;">
              No customers added yet
            </div>
          </div>
        </div>
        
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle"></i> Cancel
        </button>
        <button type="button" class="btn btn-success" onclick="saveAllInvoiceCustomers()">
          <i class="bi bi-check-circle"></i> Save All Customers
        </button>
      </div>
    </div>
  </div>
</div>



<!-- ✅✅✅ VENDORS PAGE ✅✅✅ -->
<div class="page-view" id="vendorsPage">
  <!-- Header -->
  <div class="page-header">
    <button class="back-btn" onclick="goBackHome()">
      <i class="bi bi-arrow-left"></i> Back
    </button>
    <h3><i class="bi bi-building"></i> Vendors</h3>
    <button class="btn btn-success" onclick="openAddVendorModal()">
      <i class="bi bi-plus-lg"></i> Add
    </button>
  </div>
  
  <!-- Search Box -->
  <div class="container-fluid" style="padding: 20px;">
    <input 
      type="text" 
      class="form-control mb-3" 
      id="searchVendorsInput" 
      placeholder="🔍 Search vendors..." 
      onkeyup="filterVendors(this.value)"
      style="max-width: 600px; margin: 0 auto;"
    >
    
    <!-- Vendors List Container -->
    <div id="vendorsListContainer">
      <!-- Vendor cards will be rendered here by JavaScript -->
      <div style="text-align:center; padding:40px;">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-3">Loading vendors...</p>
      </div>
    </div>
    
    <!-- Empty State -->
    <div id="vendorsEmptyState" style="display:none; text-align:center; padding:60px 20px;">
      <i class="bi bi-building" style="font-size:64px; color:#ccc;"></i>
      <h4 style="margin-top:20px;">No Vendors Yet</h4>
      <p>Add your first vendor to get started</p>
      <button class="btn btn-primary mt-3" onclick="openAddVendorModal()">
        <i class="bi bi-plus-lg"></i> Add First Vendor
      </button>
    </div>
  </div>
</div>


<!-- ✅ Add Vendors Modal -->
<div class="modal fade" id="addVendorsModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">
          <i class="bi bi-plus-circle"></i> Add New Vendors
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
  
        <!-- Instructions -->
        <div class="alert alert-info" style="font-size: 14px;">
          <i class="bi bi-info-circle"></i>
          Enter vendor names below. Press <strong>Enter</strong> or <strong>Comma (,)</strong> after each vendor, or click <strong>Add to List</strong>.
        </div>
        
        <!-- Input Field -->
        <input 
          id="vendorInput" 
          type="text" 
          class="form-control form-control-lg mb-2" 
          placeholder="e.g., ABC Suppliers, XYZ Traders..."
          onkeydown="handleVendorInputKeydown(event)"
          oninput="window.lastVendorInput = this.value"
          autocomplete="off"
          style="color: #212529; background-color: #fff;"
        >
        
        <!-- Add to List Button -->
        <button 
          type="button"
          class="btn btn-success w-100"
          onclick="addVendorToList()"
          style="padding: 10px; font-size: 16px;"
        >
          <i class="bi bi-plus-lg"></i> Add to List
        </button>
        
        <!-- Preview Section -->
        <div style="margin-top: 20px;">
          <p style="font-weight: 600; margin-bottom: 10px; font-size: 14px; color: #333;" id="vendorPreviewCount">
            📝 Vendors to Save (0):
          </p>
          <div id="vendorPreviewList" style="
            background: #f8f9fa; 
            border: 1px solid #e0e0e0;
            border-radius: 8px; 
            max-height: 250px; 
            overflow-y: auto;
            min-height: 80px; 
            padding: 10px;
          ">
            <div style="padding: 15px; color: #999; text-align: center; font-size: 14px;">
              No vendors added yet
            </div>
          </div>
        </div>
        
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle"></i> Cancel
        </button>
        <button type="button" class="btn btn-success" onclick="saveAllVendors()">
          <i class="bi bi-check-circle"></i> Save All Vendors
        </button>
      </div>
    </div>
  </div>
</div>






    
  <!--  Sales Modal -->
<div class="modal fade" id="clearSalesModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Clear Sales History</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">Clear sales records between specific dates:</p>
                
                <div class="mb-3">
                    <label class="form-label">From Date:</label>
                    <input type="date" class="form-control" id="clearFromDate" required>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">To Date:</label>
                    <input type="date" class="form-control" id="clearToDate" required>
                </div>
                
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Note:</strong> This will clear sales from display only. 
                    Google Sheets data remains unchanged.
                </div>
                
                <div id="clearSalesCount" class="alert alert-info" style="display: none;">
                    <i class="bi bi-info-circle"></i>
                    Found <strong id="salesCountNumber">0</strong> sales records in this date range.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="clearSalesInDateRange()">
                    <i class="bi bi-trash"></i> Clear Sales
                </button>
            </div>
        </div>
    </div>
</div>


  <!-- INVOICE MODAL -->
<div class="modal fade" id="invoiceModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <i class="bi bi-receipt"></i> Create Invoice
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      
      <div class="modal-body">
        <form id="invoiceForm">
          
          <!-- ✅ Customer Name with Autocomplete -->
<div class="mb-3" style="position: relative;">
  <label class="form-label">Customer Name *</label>
  
  <div style="position: relative;">
    <input 
      type="text" 
      class="form-control" 
      id="invoiceCustomerName" 
      required 
      placeholder="Type to search customers..."
      autocomplete="off"
      oninput="filterInvoiceCustomerSuggestions(this.value); checkAndShowSaveInvoiceCustomerButton(this.value)"
      onfocus="showInvoiceCustomerSuggestions()"
      onblur="setTimeout(() => hideInvoiceCustomerSuggestions(), 200)"
      style="padding-right: 40px;">
    
    <!-- 💾 Save Customer Button -->
    <button 
      id="saveInvoiceCustomerInsideBtn" 
      type="button"
      onclick="saveNewInvoiceCustomerFromInvoiceField()"
      title="Save this customer"
      style="
        display: none;
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        background: #28a745;
        color: white;
        border: none;
        padding: 6px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        transition: all 0.2s;
        z-index: 10;
      "
      onmouseover="this.style.background='#218838'"
      onmouseout="this.style.background='#28a745'">
      💾
    </button>
  </div>
  
  <!-- Customer Suggestions Dropdown -->
  <div id="invoiceCustomerSuggestionsDropdown" style="
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-top: none;
    border-radius: 0 0 8px 8px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1050;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    margin-top: -1px;
  ">
    <!-- Suggestions rendered here -->
  </div>
</div>

          
          <!-- Invoice Details Row -->
          <div class="row mb-3">
            <div class="col-md-3">
              <label class="form-label">Invoice Number *</label>
              <div class="input-group">
                <input type="text" class="form-control" id="invoiceNumber" required readonly>
                <button class="btn btn-outline-secondary" type="button" 
                        onclick="regenerateInvoiceNumber()" title="Regenerate">
                  <i class="bi bi-arrow-clockwise"></i>
                </button>
              </div>
            </div>
            
            <div class="col-md-3">
              <label class="form-label">Invoice Date *</label>
              <input type="date" class="form-control" id="invoiceDate" required>
            </div>
            
            <div class="col-md-3">
              <label class="form-label">Payment Terms</label>
              <select class="form-select" id="paymentTerms" onchange="calculateDueDate()">
                <option value="0" selected>Due on Receipt</option>
                <option value="7">Net 7</option>
                <option value="15">Net 15</option>
                <option value="30">Net 30</option>
                <option value="45">Net 45</option>
                <option value="60">Net 60</option>
              </select>
            </div>
            
            <div class="col-md-3">
              <label class="form-label">Due Date</label>
              <input type="date" class="form-control" id="invoiceDueDate">
            </div>
          </div>
          
                       <!-- Invoice Items (Purchase-Style Layout) -->
          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6 class="mb-0">
                <i class="bi bi-list-check"></i> Invoice Items
              </h6>
              <div>
                <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="addInvoiceRow()">
                  <i class="bi bi-plus-circle"></i> Add Row
                </button>
                <button type="button" class="btn btn-sm btn-outline-success" onclick="openBulkAddModal()">
                  <i class="bi bi-collection"></i> Add Items in Bulk
                </button>
              </div>
            </div>
            
            <!-- Items Container (No Table, Pure Grid like Purchase) -->
            <div id="invoiceItemsBody" style="
              display: flex;
              flex-direction: column;
              gap: 8px;
              padding: 10px;
              background: #f8f9fa;
              border-radius: 8px;
              border: 1px solid #dee2e6;
              max-height: 400px;
              overflow-y: auto;
            ">
              <!-- Rows populated dynamically by JavaScript -->
            </div>
          </div>



          
          
          <!-- Totals Section -->
          <div class="row">
            <div class="col-md-6"></div>
            <div class="col-md-6">
              <table class="table table-sm">
                <tr>
                  <td class="text-end"><strong>Sub Total:</strong></td>
                  <td class="text-end" style="width: 150px" id="invoiceSubtotal">₹0.00</td>
                </tr>
                <tr>
                  <td class="text-end">
                    <span class="me-2">Discount:</span>
                    <input type="number" class="form-control form-control-sm d-inline-block" 
                           style="width: 70px" id="invoiceDiscount" value="0" min="0" 
                           oninput="calculateInvoiceTotal()">
                    <select class="form-select form-select-sm d-inline-block" 
                            style="width: 60px" id="invoiceDiscountType" 
                            onchange="calculateInvoiceTotal()">
                      <option value="amount">₹</option>
                      <option value="percent">%</option>
                    </select>
                  </td>
                  <td class="text-end text-danger" id="invoiceDiscountAmount">-₹0.00</td>
                </tr>
                <tr>
                  <td class="text-end">
                    <span class="me-2">Tax (GST):</span>
                    <select class="form-select form-select-sm d-inline-block" 
                            style="width: 90px" id="invoiceTaxRate" 
                            onchange="calculateInvoiceTotal()">
                      <option value="0" selected>No Tax</option>
                      <option value="5">5%</option>
                      <option value="12">12%</option>
                      <option value="18">18%</option>
                      <option value="28">28%</option>
                    </select>
                  </td>
                  <td class="text-end" id="invoiceTaxAmount">₹0.00</td>
                </tr>
                <tr class="table-success fw-bold">
                  <td class="text-end"><h5 class="mb-0">Total (₹):</h5></td>
                  <td class="text-end"><h5 class="mb-0" id="invoiceGrandTotal">₹0.00</h5></td>
                </tr>
              </table>
            </div>
          </div>
          
          <!-- Customer Notes -->
          <div class="mb-3">
            <label class="form-label">Customer Notes</label>
            <textarea class="form-control" id="invoiceNotes" rows="2" 
                      placeholder="Add notes for customer (e.g., delivery instructions, thank you message)">Thanks for your business.</textarea>
            <small class="text-muted">Optional message to include on the invoice</small>
          </div>
          
          <!-- Terms & Conditions -->
          <div class="mb-3">
            <label class="form-label">
              Terms & Conditions
              <button type="button" class="btn btn-sm btn-link p-0" onclick="loadDefaultTerms()">
                <i class="bi bi-arrow-clockwise"></i> Use Default
              </button>
            </label>
            <textarea class="form-control" id="invoiceTerms" rows="4" 
                      placeholder="Enter payment terms and conditions"></textarea>
          </div>
          
        </form>
      </div>
      
      <div class="modal-footer">
  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
    <i class="bi bi-x-circle"></i> Close
  </button>
  <button type="button" class="btn btn-info" onclick="previewInvoice()">
    <i class="bi bi-eye"></i> Preview
  </button>
  
  <!-- âœ… FIXED: Share Invoice Dropdown with proper attributes -->
  <div class="btn-group" role="group">
    <button type="button" class="btn btn-primary dropdown-toggle" 
            data-bs-toggle="dropdown" 
            aria-expanded="false">
      <i class="bi bi-share"></i> Share Invoice
    </button>
    <ul class="dropdown-menu">
      <li>
        <a class="dropdown-item" href="javascript:void(0);" onclick="shareInvoiceAsImage()">
          <i class="bi bi-image"></i> Share as Image (Recommended)
        </a>
      </li>
      <li>
        <a class="dropdown-item" href="javascript:void(0);" onclick="shareInvoiceAsPDF()">
          <i class="bi bi-file-pdf"></i> Share as PDF
        </a>
      </li>
      <li><hr class="dropdown-divider"></li>

 <!-- âœ… NEW: Share image on specific WhatsApp number -->
  <li>
    <a class="dropdown-item" href="javascript:void(0);" onclick="shareImageToWhatsAppNumber()">
      <i class="bi bi-whatsapp text-success"></i> Share Image on WhatsApp
    </a>
  </li>
      
      <li>
        <a class="dropdown-item" href="javascript:void(0);" onclick="shareViaWhatsApp()">
          <i class="bi bi-whatsapp text-success"></i> WhatsApp (Text)
        </a>
      </li>
      <li>
        <a class="dropdown-item" href="javascript:void(0);" onclick="shareViaEmail()">
          <i class="bi bi-envelope"></i> Email (Text)
        </a>
      </li>
      <li>
        <a class="dropdown-item" href="javascript:void(0);" onclick="shareViaSMS()">
          <i class="bi bi-phone"></i> SMS (Text)
        </a>
      </li>
    </ul>
  </div>
  
  <button type="button" class="btn btn-success" onclick="saveInvoice()">
    <i class="bi bi-save"></i> Save Invoice
  </button>
</div>
      
    </div>
  </div>
</div>

<!-- VIEW INVOICES MODAL -->
<div class="modal fade" id="viewInvoicesModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">
          <i class="bi bi-receipt-cutoff"></i> Saved Invoices
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      
      <div class="modal-body">
        <div id="invoicesListContainer">
          <!-- Populated by JavaScript -->
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- Add/Edit Product Modal -->
<div class="modal fade" id="productModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 id="modalTitle" class="modal-title" data-i18n="addNewProduct">Add New Product</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      
      <div class="modal-body">
        <form id="productForm">
          <input type="hidden" id="productId">
          
          <!-- ✅ PHOTO UPLOAD SECTION (TOP) -->
          <div class="row mb-3">
            <div class="col-12">
              <label class="form-label" data-i18n="productPhoto">Product Photo</label>
              
              <!-- Upload Area -->
              <div 
                id="productPhotoUploadArea"
                onclick="document.getElementById('productPhotoFileInput').click()"
                style="
                  border: 2px dashed #2196F3;
                  border-radius: 10px;
                  padding: 25px;
                  cursor: pointer;
                  transition: all 0.3s ease;
                  background: #f8f9ff;
                  text-align: center;
                ">
                <div style="font-size: 2.5rem; margin-bottom: 10px;">📷</div>
                <div style="color: #666; font-size: 0.95rem; font-weight: 500;" data-i18n="clickToUpload">Click to upload or take photo</div>
                <div style="color: #999; font-size: 0.85rem; margin-top: 5px;" data-i18n="imageFormat">JPG, PNG (Max 5MB)</div>
              </div>
              
              <!-- Hidden File Input -->
              <input 
                type="file" 
                id="productPhotoFileInput" 
                accept="image/*" 
                style="display:none" 
                onchange="handleProductPhotoSelect(event)">
              
              <!-- Photo Preview -->
              <div id="productPhotoPreviewContainer" style="display: none; margin-top: 15px;">
                <div style="text-align: center;">
                  <img id="productPhotoPreviewImage" style="
                    max-width: 100%;
                    max-height: 200px;
                    border-radius: 8px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                    margin-bottom: 12px;
                    object-fit: cover;
                  ">
                </div>
                <div style="display: flex; gap: 8px; justify-content: center;">
                  <button type="button" class="btn btn-sm btn-warning" onclick="clearProductPhotoSelection()">
                    <i class="bi bi-arrow-counterclockwise"></i> <span data-i18n="changePhoto">Change Photo</span>
                  </button>
                  <button type="button" class="btn btn-sm btn-secondary" onclick="removeProductPhoto()">
                    <i class="bi bi-trash"></i> <span data-i18n="remove">Remove</span>
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- ESSENTIAL FIELDS -->
          <hr>
          
          <!-- Product Name & Category -->
<div class="row mb-3">
  <div class="col-md-8" id="productNameContainer">
    <label class="form-label" data-i18n="productName">Product Name *</label>
    <input id="productName" class="form-control" required/>
  </div>
  
  <!-- ✅ Category with data-field -->
  <div class="col-md-4" id="categoryContainer" data-field="category">
    <label class="form-label" data-i18n="category">Category</label>
    <select id="category" class="form-select">
      <option value="" data-i18n="selectCategory">Select Category</option>
    </select>
  </div>
</div>

<!-- Unit Type, Price, Current Stock -->
<div class="row mb-3">
  <!-- ✅ Unit Type with data-field -->
  <div class="col-md-4" id="unitTypeContainer" data-field="unitType">
    <label class="form-label" data-i18n="unitType">Unit Type</label>
    <select id="unitType" class="form-select">
      <option value="" data-i18n="selectUnitType">Select Unit Type</option>
    </select>
  </div>
  
  <!-- ✅ Selling Price with data-field -->
  <div class="col-md-4" id="priceContainer" data-field="sellingPrice">
    <label class="form-label" data-i18n="sellingPrice">Selling Price</label>
    <input id="price" class="form-control" type="number" step="0.01" placeholder="0"/>
  </div>
  
  <div class="col-md-4" id="stockContainer">
    <label class="form-label" data-i18n="currentStock">Current Stock *</label>
    <input id="productCurrentStock" class="form-control" type="number" min="0" max="9999" data-i18n-placeholder="orSelectStatus" placeholder="Or select status below"/>
    <small class="text-muted" data-i18n="stockOrStatusRequired">Stock qty OR status required</small>
  </div>
</div>

<!-- ✅ Stock Status Selection (ONE OF TWO REQUIRED) -->
<div class="row mb-3">
  <div class="col-md-12">
    <label class="form-label" data-i18n="stockStatus">Stock Status *</label>
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px;">
      <!-- Good -->
      <button type="button" class="btn stock-btn" 
              id="stockBtn-good" 
              onclick="selectStockStatus('good')"
              style="background: #28a745; color: white; padding: 10px; border-radius: 6px; font-weight: bold; border: 2px solid transparent; font-size: 12px;">
        🟢 <span data-i18n="good">Good</span>
      </button>
      
      <!-- Medium -->
      <button type="button" class="btn stock-btn" 
              id="stockBtn-medium" 
              onclick="selectStockStatus('medium')"
              style="background: #ffc107; color: black; padding: 10px; border-radius: 6px; font-weight: bold; border: 2px solid transparent; font-size: 12px;">
        🟡 <span data-i18n="medium">Medium</span>
      </button>
      
      <!-- Low -->
      <button type="button" class="btn stock-btn" 
              id="stockBtn-low" 
              onclick="selectStockStatus('low')"
              style="background: #dc3545; color: white; padding: 10px; border-radius: 6px; font-weight: bold; border: 2px solid transparent; font-size: 12px;">
        🔴 <span data-i18n="low">Low</span>
      </button>
      
      <!-- Urgent -->
      <button type="button" class="btn stock-btn" 
              id="stockBtn-urgent" 
              onclick="selectStockStatus('urgent')"
              style="background: #6f42c1; color: white; padding: 10px; border-radius: 6px; font-weight: bold; border: 2px solid transparent; font-size: 12px;">
        🔵 <span data-i18n="urgent">Urgent</span>
      </button>
    </div>
    
    <!-- Hidden input to track selected status -->
    <input type="hidden" id="selectedStockStatus" value="">
    
    <!-- ✅ Helper text -->
    <small class="text-muted" style="display: block; margin-top: 8px;">
      <i class="bi bi-info-circle"></i> <span data-i18n="stockOrStatusRequired">Either stock quantity or status is required</span>
    </small>
  </div>
</div>

<!-- ✅ MINIMUM STOCK (MOVED HERE - BELOW STOCK STATUS) -->
<div class="row mb-3">
  <div class="col-md-12">
    <label class="form-label" data-i18n="minimumStock">Minimum Stock</label>
    <input id="minStock" class="form-control" type="number" value="5" style="max-width: 200px;"/>
    <small class="text-muted"></small>
  </div>
</div>

<!-- ✅ ADVANCED OPTIONS (EXPANDABLE) -->
<div style="margin-bottom: 15px;">
  <button 
    type="button" 
    class="btn btn-link btn-sm" 
    onclick="toggleAdvancedOptions()"
    style="padding: 0; text-decoration: none;">
    <i class="bi bi-chevron-down" id="advOptionsIcon"></i>
    <span style="color: #007bff; font-weight: 500;" data-i18n="advancedOptions">+ Advanced Options</span>
  </button>
</div>

<!-- Advanced Options Container (Hidden by default) -->
<div id="advancedOptionsContainer" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #007bff; margin-bottom: 15px;">
  
  <!-- Brand & Size -->
  <div class="row mb-3">
    
    <!-- ✅ Brand Field with data-field -->
    <div class="col-md-6" id="brandContainer" style="position: relative;" data-field="brand">
      <label class="form-label" data-i18n="brand">Brand</label>
      
      <!-- Input Field Container -->
      <div style="position: relative;">
        <input 
          id="brand" 
          class="form-control" 
          type="text"
          autocomplete="off"
          oninput="filterBrandSuggestions(this.value); checkAndShowSaveBrandButton(this.value)"
          onfocus="showBrandSuggestions()"
          onblur="setTimeout(() => hideBrandSuggestions(), 200)"
          data-i18n-placeholder="typeToSearchBrands"
          placeholder="Type to search brands..."
          style="padding-right: 40px;">
        
        <!-- 💾 Save Brand Button -->
        <button id="saveBrandInsideBtn" 
          type="button"
          onclick="saveNewBrandFromProductField()"
          data-i18n-title="saveThisBrand"
          style="
            display: none;
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: #28a745;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s;
            z-index: 10;
          "
          onmouseover="this.style.background='#218838'"
          onmouseout="this.style.background='#28a745'"
          title="Save this brand">
          💾
        </button>
      </div>
      
      <!-- Brand Suggestions Dropdown -->
      <div id="addProductBrandSuggestionsDropdown" style="
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 8px 8px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        margin-top: -1px;
      ">
        <!-- Suggestions rendered here -->
      </div>
    </div>
    
    <!-- ✅ Size Field with data-field -->
    <div class="col-md-6" id="sizeContainer" style="position: relative;" data-field="size">
      <label class="form-label" data-i18n="size">Size</label>
      
      <!-- Input Field Container -->
      <div style="position: relative;">
        <input 
          id="size" 
          class="form-control" 
          type="text"
          autocomplete="off"
          oninput="filterSizeSuggestions(this.value); checkAndShowSaveSizeButton(this.value)"
          onfocus="showSizeSuggestions()"
          onblur="setTimeout(() => hideSizeSuggestions(), 200)"
          data-i18n-placeholder="typeToSearchSizes"
          placeholder="Type to search sizes..."
          style="padding-right: 40px;">
        
        <!-- 💾 Save Size Button -->
        <button id="saveSizeInsideBtn" 
          type="button"
          onclick="saveNewSizeFromProductField()"
          data-i18n-title="saveThisSize"
          style="
            display: none;
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: #007bff;
            color: white;
            border: none;
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s;
            z-index: 10;
          "
          onmouseover="this.style.background='#0056b3'"
          onmouseout="this.style.background='#007bff'"
          title="Save this size">
          💾
        </button>
      </div>
      
      <!-- Size Suggestions Dropdown -->
      <div id="addProductSizeSuggestionsDropdown" style="
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 1px solid #ddd;
        border-top: none;
        border-radius: 0 0 8px 8px;
        max-height: 200px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        margin-top: -1px;
      ">
        <!-- Suggestions rendered here -->
      </div>
    </div>

  </div>
  <!-- ✅ END of Brand & Size Row -->
  
  <!-- Pieces per Box & SFT per Box -->
  <div class="row mb-0">
    <!-- ✅ Pieces per Box with data-field -->
    <div class="col-md-6" id="piecesPerBoxContainer" data-field="piecesPerBox">
      <label class="form-label" data-i18n="piecesPerBox">Pieces per Box</label>
      <input id="piecesPerBox" class="form-control" type="number" value="1"/>
    </div>
    
    <!-- ✅ SFT per Box with data-field -->
    <div class="col-md-6" id="sftPerBoxContainer" data-field="sftPerBox">
      <label class="form-label" data-i18n="sftPerBox">SFT per Box</label>
      <input id="sftPerBox" class="form-control" type="number" step="0.01"/>
    </div>
  </div>
  
</div>
</form>
</div>

<div class="modal-footer">
  <button class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="cancel">Cancel</button>
  <button class="btn btn-primary" onclick="saveProduct()" data-i18n="saveProduct">Save Product</button>
</div>
</div>
</div>
</div>





  <!-- SALES MODAL (grid) - WITH TRANSLATION -->
<div class="modal fade" id="salesModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title" data-i18n="recordNewSale">Record New Sale</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">

        <!-- ✅ NEW: Multi-Select Product Picker -->
        <div class="mb-3">
          <label class="form-label fw-bold">
            <i class="bi bi-lightning-charge-fill text-warning"></i> <span data-i18n="quickAddProducts">Quick Add Products (Multi-Select)</span>
          </label>
          <div class="multi-select-dropdown">
            <button type="button" class="form-control text-start multi-select-toggle" id="multiSelectToggle" onclick="toggleMultiSelect()">
              <span id="multiSelectLabel" data-i18n="clickToSelectMultiple">Click to select multiple products...</span>
              <i class="bi bi-chevron-down float-end"></i>
            </button>
            <div class="multi-select-options" id="multiSelectOptions">
              <input type="text" class="form-control form-control-sm mb-2" 
                     data-i18n-placeholder="searchProducts"
                     placeholder="🔍 Search products..." 
                     id="multiSelectSearch" 
                     oninput="filterMultiSelectOptions()">
              <div class="multi-select-list" id="multiSelectList">
                <!-- Checkboxes populated by JS -->
              </div>
            </div>
          </div>
          <small class="text-muted" data-i18n="selectMultipleToAutoFill">Select multiple products to auto-fill rows below</small>
        </div>

        <!-- NEW: Buttons at TOP -->
        <div class="mb-3 text-end">
          <button class="btn btn-outline-primary btn-sm me-2" onclick="addMoreRows()">
            <i class="bi bi-plus-circle"></i> <span data-i18n="addMoreRows">Add More Rows</span>
          </button>

          <!-- ✅ NEW: Add Products in Bulk Button (EXACTLY LIKE INVOICE) -->
          <button class="btn btn-outline-success btn-sm" onclick="openBulkAddModalForSale()">
            <i class="bi bi-collection"></i> <span data-i18n="addProductsInBulk">Add Products in Bulk</span>
          </button>
          
          <button class="btn btn-outline-success btn-sm" onclick="openCustomProductPopup()">
            <i class="bi bi-pencil-square"></i> <span data-i18n="addCustomProduct">Add Custom Product</span>
          </button>
        </div>

        <div class="table-responsive">
          <table class="table table-sm grid-table mb-0">
            <thead>
              <tr>
                <th class="grid-row-number" data-i18n="hashSymbol">#</th>
                <th data-i18n="productName">Product Name</th>
                <th style="width:130px" data-i18n="size">Size</th>
                <th style="width:90px" data-i18n="qty">Qty</th>
                <th style="width:110px" data-i18n="unit">Unit</th>
                <th style="width:120px" data-i18n="price">Price</th>
                <th style="width:140px" data-i18n="total">Total</th>
                <th style="width:60px"></th>
              </tr>
            </thead>
            <tbody id="product-grid-body"></tbody>
          </table>
        </div>

        <!-- Keep Add buttons only here (below grid) -->
        <div class="mt-3 d-flex justify-content-between align-items-center">
          <div>
            <button class="btn btn-outline-primary btn-sm" onclick="addMoreRows()">
              <i class="bi bi-plus-circle"></i> <span data-i18n="addMoreRows">Add More Rows</span>
            </button>
            <button class="btn btn-outline-success btn-sm ms-2" onclick="openCustomProductPopup()">
              <i class="bi bi-pencil-square"></i> <span data-i18n="addCustomProduct">Add Custom Product</span>
            </button>
          </div>
          <div class="text-end" style="min-width:320px;">
            <table class="table table-borderless mb-0">
              <tr>
                <td class="text-end small-muted"><strong data-i18n="subtotal">Subtotal:</strong></td>
                <td id="subtotal" class="text-end">₹0.00</td>
              </tr>
              <tr style="font-size:1.25rem;color:#28a745">
                <td class="text-end"><strong data-i18n="grandTotal">GRAND TOTAL:</strong></td>
                <td id="grandTotal" class="text-end">₹0.00</td>
              </tr>
            </table>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="cancel">Cancel</button>
        <button class="btn btn-info" onclick="generateInvoice()">
          <i class="bi bi-receipt"></i> <span data-i18n="generateInvoice">Generate Invoice</span>
        </button>
        <button class="btn btn-success" onclick="completeSale()" data-i18n="completeSale">Complete Sale</button>
      </div>

    </div>
  </div>
</div>


  <!-- CUSTOM PRODUCT MODAL (NEW fields) -->
  <div class="modal fade" id="customProductModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Add Custom Product</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <form id="customProductForm">
        <div class="mb-3"><label class="form-label">Product Name *</label><input id="customName" class="form-control" required/></div>
        <div class="mb-3"><label class="form-label">Size</label><input id="customSize" class="form-control" placeholder="e.g., 3x3 feet or Standard"/></div>
        <div class="row">
        
          <div class="col-md-6 mb-3"><label class="form-label">Unit Type *</label><select id="customUnit" class="form-select"><option>Box</option><option>Piece</option><option>SFT</option></select></div>
        </div>
        <div class="mb-3"><label class="form-label">Unit Price *</label><input id="customPrice" type="number" class="form-control" min="0.01" step="0.01" value="0"/></div>
         <div class="col-md-6 mb-3"><label class="form-label">Quantity (for this sale) *</label><input id="customQty" type="number" class="form-control" min="1" value="1"/></div>


        <div class="mb-3"><label class="form-label">Total</label><div id="customTotal" class="fw-bold">₹0.00</div></div>
      </form>
    </div>

<!-- INVOICE MODAL -->
<div class="modal fade" id="invoiceModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Create Invoice</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      
      <div class="modal-body">
        <form id="invoiceForm">
          
          <!-- Customer Name -->
          <div class="mb-3">
            <label class="form-label">Customer Name *</label>
            <input type="text" class="form-control" id="invoiceCustomerName" required placeholder="Enter customer name">
          </div>
          
          <!-- Invoice Details Row -->
          <div class="row mb-3">
            <div class="col-md-3">
              <label class="form-label">Invoice Number *</label>
              <div class="input-group">
                <input type="text" class="form-control" id="invoiceNumber" required readonly>
                <button class="btn btn-outline-secondary" type="button" onclick="regenerateInvoiceNumber()" title="Regenerate">
                  <i class="bi bi-arrow-clockwise"></i>
                </button>
              </div>
            </div>
            
            <div class="col-md-3">
              <label class="form-label">Invoice Date *</label>
              <input type="date" class="form-control" id="invoiceDate" required>
            </div>
            
            <div class="col-md-3">
              <label class="form-label">Payment Terms</label>
              <select class="form-select" id="paymentTerms" onchange="calculateDueDate()">
                <option value="0" selected>Due on Receipt</option>
                <option value="7">Net 7</option>
                <option value="15">Net 15</option>
                <option value="30">Net 30</option>
                <option value="45">Net 45</option>
                <option value="60">Net 60</option>
              </select>
            </div>
            
            <div class="col-md-3">
              <label class="form-label">Due Date</label>
              <input type="date" class="form-control" id="invoiceDueDate">
            </div>
          </div>
          
          <!-- Items Table -->
          <div class="mb-3">
            <h6>Invoice Items</h6>
            <div class="table-responsive">
              <table class="table table-bordered table-sm">
                <thead class="table-light">
                  <tr>
                    <th style="width: 40%">Item Details</th>
                    <th style="width: 15%">Quantity</th>
                    <th style="width: 15%">Rate</th>
                    <th style="width: 20%">Amount</th>
                    <th style="width: 10%"></th>
                  </tr>
                </thead>
                <tbody id="invoiceItemsBody">
                  <!-- Populated by JavaScript -->
                </tbody>
              </table>
            </div>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addInvoiceRow()">
              <i class="bi bi-plus-circle"></i> Add Row
            </button>
          </div>
          
          <!-- Totals Section -->
          <div class="row">
            <div class="col-md-7"></div>
            <div class="col-md-5">
              <table class="table table-sm">
                <tr>
                  <td class="text-end"><strong>Sub Total:</strong></td>
                  <td class="text-end" id="invoiceSubtotal">₹0.00</td>
                </tr>
                <tr>
                  <td class="text-end">
                    Discount:
                    <input type="number" class="form-control form-control-sm d-inline-block" 
                           style="width: 80px" id="invoiceDiscount" value="0" min="0" 
                           oninput="calculateInvoiceTotal()">
                    <select class="form-select form-select-sm d-inline-block" 
                            style="width: 60px" id="invoiceDiscountType" 
                            onchange="calculateInvoiceTotal()">
                      <option value="amount">₹</option>
                      <option value="percent">%</option>
                    </select>
                  </td>
                  <td class="text-end text-danger" id="invoiceDiscountAmount">-₹0.00</td>
                </tr>
                <tr>
                  <td class="text-end">
                    Tax:
                    <select class="form-select form-select-sm d-inline-block" 
                            style="width: 100px" id="invoiceTaxRate" 
                            onchange="calculateInvoiceTotal()">
                      <option value="0" selected>No Tax</option>
                      <option value="5">GST 5%</option>
                      <option value="12">GST 12%</option>
                      <option value="18">GST 18%</option>
                      <option value="28">GST 28%</option>
                    </select>
                  </td>
                  <td class="text-end" id="invoiceTaxAmount">₹0.00</td>
                </tr>
                <tr class="table-success">
                  <td class="text-end"><h5>Total (₹):</h5></td>
                  <td class="text-end"><h5 id="invoiceGrandTotal">₹0.00</h5></td>
                </tr>
              </table>
            </div>
          </div>
          
          <!-- Customer Notes -->
          <div class="mb-3">
            <label class="form-label">Customer Notes</label>
            <textarea class="form-control" id="invoiceNotes" rows="2" 
                      placeholder="Add notes for customer...">Thanks for your business.</textarea>
          </div>
          
          <!-- Terms & Conditions -->
          <div class="mb-3">
            <label class="form-label">
              Terms & Conditions
              <button type="button" class="btn btn-sm btn-link" onclick="loadDefaultTerms()">Use Default</button>
            </label>
            <textarea class="form-control" id="invoiceTerms" rows="3" 
                      placeholder="Enter terms and conditions"></textarea>
          </div>
          
        </form>
      </div>
      
      <div class="modal-footer">
  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
    <i class="bi bi-x-circle"></i> Close
  </button>
  <button type="button" class="btn btn-info" onclick="previewInvoice()">
    <i class="bi bi-eye"></i> Preview
  </button>
  
  <!-- âœ… NEW: Share Invoice Dropdown -->
  <div class="btn-group">
    <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">
      <i class="bi bi-share"></i> Share Invoice
    </button>
    <ul class="dropdown-menu">
      <li>
        <a class="dropdown-item" href="#" onclick="shareInvoiceAsImage(); return false;">
          <i class="bi bi-image"></i> Share as Image (Recommended)
        </a>
      </li>
      <li>
        <a class="dropdown-item" href="#" onclick="shareInvoiceAsPDF(); return false;">
          <i class="bi bi-file-pdf"></i> Share as PDF
        </a>
      </li>
      <li><hr class="dropdown-divider"></li>
      <li>
        <a class="dropdown-item" href="#" onclick="shareViaWhatsApp(); return false;">
          <i class="bi bi-whatsapp text-success"></i> WhatsApp (Text)
        </a>
      </li>
      <li>
        <a class="dropdown-item" href="#" onclick="shareViaEmail(); return false;">
          <i class="bi bi-envelope"></i> Email (Text)
        </a>
      </li>
      <li>
        <a class="dropdown-item" href="#" onclick="shareViaSMS(); return false;">
          <i class="bi bi-phone"></i> SMS (Text)
        </a>
      </li>
    </ul>
  </div>
  
  <button type="button" class="btn btn-success" onclick="saveInvoice()">
    <i class="bi bi-save"></i> Save Invoice
  </button>
</div>

      
    </div>
  </div>
</div>

    
    <div class="modal-footer">
      <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      <button class="btn btn-success" onclick="addCustomProductToGrid()">Add to Sale</button>
    </div>
  </div></div></div>




<!-- ==========================================
     PRODUCT GROUPS - CREATE GROUP MODAL (MOBILE-OPTIMIZED)
     ========================================== -->

<div class="fullscreen-modal" id="createGroupModal">
  <div class="modal-header-mobile">
    <button class="btn-cancel-modal" onclick="closeCreateGroupModal()">
      ✕ Cancel
    </button>
    <h3>New Item Group</h3>
    <div style="width: 80px;"></div> <!-- Spacer for centering -->
  </div>
  
  <form id="createGroupForm" class="mobile-form" onsubmit="handleCreateGroup(event)">
    
    <!-- Basic Information Section -->
    <div class="form-section">
      <div class="section-title">Basic Information</div>
      
      <label class="form-label">
        Item Group Name <span class="required">*</span>
      </label>
      <input 
        type="text" 
        id="groupName" 
        name="groupName"
        placeholder="e.g., T-Shirts, Tiles, Sanitaryware" 
        required
        autocomplete="off">
      
      <label class="form-label">Description</label>
      <textarea 
        id="groupDescription" 
        name="groupDescription"
        placeholder="Optional: Add a description for this group"
        rows="3"></textarea>
      
      <label class="form-label">Manufacturer / Brand</label>
      <input 
        type="text" 
        id="groupManufacturer" 
        name="groupManufacturer"
        placeholder="e.g., Nike, Somany"
        autocomplete="off">
      
      <label class="form-label">Category</label>
      <select id="groupCategory" name="groupCategory">
        <option value="">Select Category</option>
        <option value="Tiles">Tiles</option>
        <option value="Sanitaryware">Sanitaryware</option>
        <option value="Accessories">Accessories</option>
        <option value="Apparel">Apparel</option>
        <option value="Custom">Custom</option>
      </select>
    </div>
    
    <!-- Attributes Section -->
    <div class="form-section">
      <div class="section-title">Create Attributes & Options</div>
      <div class="section-description">
        Add attributes like Size, Color, Material, etc. Each combination will create a variant.
      </div>
      
      <div id="attributesContainer">
        <!-- Attribute rows will be added here dynamically -->
      </div>
      
      <button type="button" class="btn-add-more" onclick="addAttributeRow()">
        ➕ Add Attribute
      </button>
    </div>
    
    <!-- Variant Preview Section -->
    <div class="form-section">
      <div class="variant-preview-section">
        <div class="variant-count-badge">
          <span id="variantCount">0</span> Variants Will Be Created
        </div>
        <div class="variant-preview-list" id="variantPreviewContainer">
          <div class="variant-preview-item">
            Add attributes to see preview...
          </div>
        </div>
      </div>
    </div>
    
    <!-- Fixed Bottom Actions -->
    <div class="form-actions-bottom">
      <button type="button" class="btn-secondary-bottom" onclick="closeCreateGroupModal()">
        Cancel
      </button>
      <button type="submit" class="btn-primary-bottom" id="btnSaveGroup">
        💾 Save & Generate
      </button>
    </div>
    
  </form>
</div>


<!-- ==========================================
     PRODUCT GROUPS - EDIT VARIANT MODAL (MOBILE-OPTIMIZED)
     ========================================== -->

<div class="fullscreen-modal" id="editVariantModal">
  <div class="modal-header-mobile">
    <button class="btn-cancel-modal" onclick="closeEditVariantModal()">
      ✕ Cancel
    </button>
    <h3>Edit Variant</h3>
    <div style="width: 80px;"></div>
  </div>
  
  <form id="editVariantForm" class="mobile-form" onsubmit="handleUpdateVariant(event)">
    <input type="hidden" id="editVariantId">
    <input type="hidden" id="editVariantGroupId">
    
    <!-- Variant Info (Read-only) -->
    <div class="form-section">
      <div class="section-title">Variant Information</div>
      
      <label class="form-label">Variant Name</label>
      <input 
        type="text" 
        id="editVariantName" 
        readonly
        style="background: #f5f5f5; color: #666;">
      
      <label class="form-label">Attributes</label>
      <div id="editVariantAttributes" style="padding: 12px; background: #f5f5f5; border-radius: 8px; font-size: 14px; color: #666;">
        <!-- Attributes will be displayed here -->
      </div>
    </div>
    
    <!-- Pricing Section -->
    <div class="form-section">
      <div class="section-title">Pricing</div>
      
      <label class="form-label">Cost Price</label>
      <input 
        type="number" 
        id="editVariantCostPrice" 
        name="costPrice"
        placeholder="0.00"
        step="0.01"
        min="0">
      
      <label class="form-label">Selling Price <span class="required">*</span></label>
      <input 
        type="number" 
        id="editVariantSellingPrice" 
        name="sellingPrice"
        placeholder="0.00"
        step="0.01"
        min="0"
        required>
    </div>
    
    <!-- Inventory Section -->
    <div class="form-section">
      <div class="section-title">Inventory</div>
      
      <label class="form-label">Stock Quantity <span class="required">*</span></label>
      <input 
        type="number" 
        id="editVariantStock" 
        name="stock"
        placeholder="0"
        min="0"
        required>
      
      <label class="form-label">Minimum Stock Alert</label>
      <input 
        type="number" 
        id="editVariantMinStock" 
        name="minStock"
        placeholder="0"
        min="0">
      
      <label class="form-label">Unit Type</label>
      <select id="editVariantUnitType" name="unitType">
        <option value="Piece">Piece</option>
        <option value="Box">Box</option>
        <option value="SFT">SFT</option>
        <option value="Set">Set</option>
        <option value="Unit">Unit</option>
      </select>
    </div>
    
    <!-- Fixed Bottom Actions -->
    <div class="form-actions-bottom">
      <button type="button" class="btn-secondary-bottom" onclick="closeEditVariantModal()">
        Cancel
      </button>
      <button type="submit" class="btn-primary-bottom">
        💾 Save Changes
      </button>
    </div>
    
  </form>
</div>


<!-- ==========================================
     SUCCESS MESSAGE OVERLAY
     ========================================== -->

<div class="success-overlay" id="successOverlay">
  <div style="font-size: 32px; margin-bottom: 8px;">✅</div>
  <div id="successMessage">Success!</div>
</div>

  

  <!-- Hidden file input for import -->
  <input type="file" id="fileInput" accept=".json" style="display:none" onchange="handleFileImport(event)">



    <!-- âœ… NEW: Photo Product Modal -->
<div class="modal fade" id="photoProductModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">ðŸ“• Add Product by Photo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        
        <!-- Photo Upload Area -->
        <div class="upload-area" id="photoUploadArea" onclick="document.getElementById('photoFileInput').click()">
          <div class="upload-icon">ðŸ“•</div>
          <div class="upload-text">Click to take photo or select from gallery</div>
        </div>
        
        <!-- Hidden file inputs -->
        <input type="file" id="photoFileInput" accept="image/*" style="display:none" onchange="handlePhotoSelect(event)">
        <input type="file" id="photoCameraInput" accept="image/*" capture="environment" style="display:none" onchange="handlePhotoSelect(event)">
        
        <!-- Photo Preview -->
        <div id="photoPreviewContainer" class="preview-container">
          <img id="photoPreviewImage" class="preview-image" alt="Product Photo">
          <button type="button" class="btn btn-sm btn-warning" onclick="clearPhotoSelection()">Change Photo</button>
        </div>
        
        <!-- Loading Spinner -->
        <div id="photoLoadingSpinner" class="loading-spinner">
          <div class="spinner"></div>
          <p>Uploading photo...</p>
        </div>
        
        <!-- Product Details Form -->
        <div class="mb-3">
          <label class="form-label">Product Name <span class="text-danger">*</span></label>
          <input type="text" id="photoProductName" class="form-control" placeholder="e.g., White Marble Tile" required>
        </div>
        
        <div class="row">
          <div class="col-6 mb-3">
            <label class="form-label">Brand</label>
            <input type="text" id="photoProductBrand" class="form-control" placeholder="Optional">
          </div>
          <div class="col-6 mb-3">
            <label class="form-label">Size</label>
            <input type="text" id="photoProductSize" class="form-control" placeholder="e.g., 2x2">
          </div>
        </div>
        
        <div class="row">
          <div class="col-6 mb-3">
            <label class="form-label">Current Stock</label>
            <input type="number" id="photoProductStock" class="form-control" min="0" placeholder="0">
          </div>
          <div class="col-6 mb-3">
            <label class="form-label">Unit Price (₹)</label>
            <input type="number" id="photoProductPrice" class="form-control" min="0" step="0.01" placeholder="0.00">
          </div>
        </div>
        
        <div class="alert alert-info">
          <small><i class="bi bi-info-circle"></i> Only products with stock and price can be sold.</small>
        </div>
        
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="savePhotoProduct()">
          <i class="bi bi-check-circle"></i> Save Product
        </button>
      </div>
    </div>
  </div>
</div>

<!-- âœ… NEW: View Photo Modal (Enlarged View) -->
<div class="modal fade" id="viewPhotoModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="viewPhotoModalTitle">Product Photo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="viewPhotoModalBody">
        <!-- Content will be dynamically loaded -->
      </div>
    </div>
  </div>
</div>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script src="brand-manager.js"></script>

  <script>

// ==========================================
// FIREBASE AUTHENTICATION
// ==========================================

let currentUser = null;
let userEmail = null;

/**
 * ==========================================
 * IMMEDIATE FEATURE FLAGS LOAD (Prevents Flash)
 * ==========================================
 * Loads feature flags from localStorage IMMEDIATELY (synchronously)
 * This prevents the flash of enabled buttons on page load
 */
 (function immediateLoadFeatureFlags() {
    try {
        const stored = localStorage.getItem('featureFlags');
        if (stored) {
            window.featureFlags = JSON.parse(stored);
            console.log('⚡ Loaded feature flags immediately (sync):', window.featureFlags);
        } else {
            window.featureFlags = {
                enableInvoiceGeneration: true,
                enableInvoiceViewing: true,
                enableSalesRecording: true,
                enableRecentSalesView: true,        // ✅ NEW
                enableAdvancedReports: false,
                enableWhatsAppIntegration: false,
                maxProducts: 1000,
                updatedAt: new Date().toISOString()
            };
            console.log('⚡ Using default feature flags:', window.featureFlags);
        }
    } catch (e) {
        console.warn('⚠️ Failed immediate load:', e);
        window.featureFlags = {
            enableInvoiceGeneration: true,
            enableInvoiceViewing: true,
            enableSalesRecording: true,
            enableRecentSalesView: true,        // ✅ NEW
            enableAdvancedReports: false,
            enableWhatsAppIntegration: false,
            maxProducts: 1000,
            updatedAt: new Date().toISOString()
        };
    }
})();


// Default settings
let addProductModalSettings = {
  showCategory: true,
  showUnitType: true,
  showSellingPrice: true,
  showBrand: true,
  showSize: true,
  showPiecesPerBox: true,
  showSftPerBox: true
};
/**
 * ==========================================
 * AUTOFILL MODE - GLOBAL STATE INITIALIZATION
 * ==========================================
 */

// ✅ Initialize global state FIRST
if (!window.autofillMode) {
  window.autofillMode = {
    active: false,
    currentField: null,
    currentRow: null,
    isUserScrolling: false,
    scrollTimeout: null
  };
}

console.log('✅ Autofill mode state initialized:', window.autofillMode);


/**
 * ==========================================
 * ADJUST FLIP CARD LAYOUT BASED ON VISIBILITY
 * ==========================================
 * Makes Record Purchase full-width when Record Sale is hidden
 */
 function adjustFlipCardLayout() {
    const recordPurchaseContainer = document.getElementById('recordPurchaseContainer');
    const recordSaleContainer = document.querySelector('[data-feature-flag="enableSalesRecording"]');
    
    if (!recordPurchaseContainer || !recordSaleContainer) {
        console.log('⚠️ Flip card containers not found');
        return;
    }
    
    // ✅ FIX: Get the button element from container
    const recordPurchaseButton = recordPurchaseContainer.querySelector('button');
    
    // Check if Record Sale is hidden
    const isRecordSaleHidden = recordSaleContainer.classList.contains('d-none') || 
                                recordSaleContainer.style.display === 'none';
    
    if (isRecordSaleHidden) {
        // ✅ Record Sale is HIDDEN - Expand Record Purchase to full width
        console.log('📐 Expanding Record Purchase to full width');
        
        recordPurchaseContainer.classList.remove('col-6');
        recordPurchaseContainer.classList.add('col-12');
        
        // Remove right border since it's now full width
        if (recordPurchaseButton) {
            recordPurchaseButton.classList.remove('border-end');
        }
        
    } else {
        // ❌ Record Sale is VISIBLE - Keep normal 50/50 layout
        console.log('📐 Keeping Record Purchase at 50% width');
        
        recordPurchaseContainer.classList.remove('col-12');
        recordPurchaseContainer.classList.add('col-6');
        
        // Restore right border for grid line
        if (recordPurchaseButton) {
            recordPurchaseButton.classList.add('border-end');
        }
    }
}


/**
 * ==========================================
 * SWITCH TO INVENTORY VIEW
 * ==========================================
 * Switches to inventory view when a hidden tab is active
 * ✅ Re-attaches product click handlers
 */
 function switchToInventoryView() {
    console.log('📍 Switching to Inventory view (hidden tab was active)');
    
    const inventoryBtn = document.getElementById('inventory-btn');
    const salesBtn = document.getElementById('sales-btn');
    const purchasesBtn = document.getElementById('purchases-btn');
    
    const inventorySection = document.getElementById('inventorySection');
    const salesSection = document.getElementById('salesSection');
    const purchasesSection = document.getElementById('purchasesSection');
    
    // Deactivate all buttons
    if (inventoryBtn) inventoryBtn.classList.remove('active');
    if (salesBtn) salesBtn.classList.remove('active');
    if (purchasesBtn) purchasesBtn.classList.remove('active');
    
    // Hide all sections
    if (inventorySection) inventorySection.style.display = 'none';
    if (salesSection) salesSection.style.display = 'none';
    if (purchasesSection) purchasesSection.style.display = 'none';
    
    // Activate inventory
    if (inventoryBtn) inventoryBtn.classList.add('active');
    if (inventorySection) inventorySection.style.display = 'block';
    
    // ✅ RE-ATTACH PRODUCT CLICK HANDLERS
    setTimeout(() => {
        reattachProductClickHandlers();
        console.log('✅ Product click handlers re-attached');
    }, 100);
}

/**
 * ==========================================
 * RE-ATTACH PRODUCT CLICK HANDLERS
 * ==========================================
 * Re-attaches click handlers to product cards after view switch
 */
 function reattachProductClickHandlers() {
    console.log('🔗 Re-attaching product click handlers...');
    
    // ✅ DESKTOP - Table rows
    const tableRows = document.querySelectorAll('#productsTableBody tr[data-product-id]');
    tableRows.forEach(row => {
        const productId = row.getAttribute('data-product-id');
        
        // Remove any existing onclick to prevent duplicates
        row.onclick = null;
        
        // Re-attach onclick handler
        row.onclick = function(event) {
            // Ignore clicks on buttons
            if (event.target.closest('.btn')) {
                return;
            }
            
            // Check if bulk edit mode is active
            if (bulkEditMode && bulkEditMode.active) {
                // In bulk edit mode, handle selection
                if (event.target.closest('.btn')) return;
                event.stopPropagation();
                event.preventDefault();
                toggleProductSelectionDesktop(productId, row);
                return;
            }
            
            // Normal mode - show product details
            event.preventDefault();
            showProductDetails(productId);
        };
    });
    
    // ✅ MOBILE - Product cards
    const mobileCards = document.querySelectorAll('.mobile-item[data-product-id]');
    mobileCards.forEach(card => {
        const productId = card.getAttribute('data-product-id');
        
        // Remove any existing onclick to prevent duplicates
        card.onclick = null;
        
        // Re-attach onclick handler
        card.onclick = function(event) {
            // Ignore clicks on buttons
            if (event.target.closest('.btn')) {
                return;
            }
            
            // Check if bulk edit mode is active
            if (bulkEditMode && bulkEditMode.active) {
                // In bulk edit mode, handle selection
                if (event.target.closest('.btn')) return;
                event.stopPropagation();
                event.preventDefault();
                toggleProductSelectionMobile(productId, card);
                return;
            }
            
            // Normal mode - show product details
            event.preventDefault();
            showProductDetails(productId);
        };
    });
    
    console.log(`✅ Re-attached handlers: ${tableRows.length} rows, ${mobileCards.length} mobile cards`);
}



/**
 * ==========================================
 * TRANSLATION EXCLUSION - GLOBAL VARIABLES
 * ==========================================
 * ⚠️ MUST BE DECLARED FIRST - Before any other code
 */

// Initialize translation exclusions Set
if (!window.translationExclusions) {
  window.translationExclusions = new Set();
}

// Initialize exclusion mode flag
var isTranslationExclusionMode = false;

console.log('✅ Translation exclusion variables initialized');


// ==========================================
// ✅ TRANSLATIONS - COMPLETE WITH BULK EDIT
// ==========================================

var translations = {
  en: {
    // Navbar
    appTitle: "Tile & Sanitaryware Inventory",
    generateInvoice: "Generate Invoice",
    viewInvoices: "View Invoices",
    signOut: "Sign Out",
    backupData: "Backup Data",
    restoreData: "Restore Data",
    changePassword: "Change Password",
    resetData: "Reset Data",
    signedIn: "Signed In",

    // Instant Products Preview
  skipped: "Skipped",
  entering: "ENTERING",

  // saveProductToSheet
  notAuthenticated: 'Not authenticated',
  duplicateProductFound: 'Duplicate product found',
  
  
  
  // saveProduct
  fillRequiredFields: 'Fill required fields',
  savingProduct: 'Saving product...',
  saved: 'Saved',
  saveFailedReverted: 'Save failed - reverted locally.',
  saveFailed: 'Save failed',
  saveFailedCheckConsole: 'Save failed - reverted locally. Check console for details.',
  
  // saveVariantData
  saving: 'Saving...',
  userNotAuthenticated: 'User not authenticated',
  variantIdMissing: 'Variant ID is missing. Please close and reopen the edit form.',
  groupIdMissing: 'Group ID is missing. Please close and reopen the edit form.',
  invalidSellingPrice: 'Invalid selling price',
  invalidStockValue: 'Invalid stock value',
  variantUpdatedSuccess: '✅ Variant updated successfully!',
  errorPrefix: 'Error',
  checkConsole: 'Please check the console for details.',
  
  // deleteProduct
  confirmDeleteProduct: 'Are you sure you want to delete this product?',
  deleting: 'Deleting...',
  deleted: 'Deleted',
  deleteFailedReverted: 'Delete failed - reverted locally.',
  deleteFailed: 'Delete failed',

  // Save Instant Products
  pleaseAddAtLeastOneProduct: '⚠️ Please add at least one product',
  savingProducts: 'Saving products...',
  errorNotAuthenticated: '❌ Error: Not authenticated. Please sign in again.',
  uncategorized: 'Uncategorized',
  notApplicable: 'N/A',
  piece: 'Piece',
  productsAddedSuccess: '✅ Success!\n\n{count} product(s) added with stock!',
  partialSuccess: '⚠️ Partial Success\n\n✅ Saved: {saved}\n❌ Failed: {failed}\n\nFailed products:\n{list}',
  
  // Stock Badge
  outOfStock: 'OUT OF STOCK',
  inStock: 'IN STOCK',
  
  // Edit Product
  productNotFound: '❌ Product not found',
  
  // Sales Modal
  recordNewSale: "Record New Sale",
  quickAddProducts: "Quick Add Products (Multi-Select)",
  clickToSelectMultiple: "Click to select multiple products...",
  searchProducts: "🔍 Search products...",
  selectMultipleToAutoFill: "Select multiple products to auto-fill rows below",
  addMoreRows: "Add More Rows",
  addProductsInBulk: "Add Products in Bulk",
  addCustomProduct: "Add Custom Product",
  hashSymbol: "#",
  qty: "Qty",
  total: "Total",
  subtotal: "Subtotal:",
  grandTotal: "GRAND TOTAL:",
  completeSale: "Complete Sale",
    
    // Dashboard
    totalProducts: "Total Products",
    qtyInHand: "Qty in Hand",
    inStockItems: "In Stock Items",
    lowStockItems: "Low Stock Items",
    inventory: "Inventory",
    recentPurchases: "Recent Purchases",
    recentSales: "Recent Sales",
    recordSale: "Record Sale",
    quickCreate: "Quick Create",
    clickToFlip: "Click to flip",
    instantProducts: "Instant Products",
    addProduct: "Add Product",
    recordPurchase: "Record Purchase",
    
    // Product Management
    editProduct: "Edit Product",
    productName: "Product Name",
    brand: "Brand",
    size: "Size",
    category: "Category",
    unitType: "Unit Type",
    quantity: "Quantity",
    price: "Price",
    
    // Bulk Edit - NEW
    editProductsInBulk: "Edit Products in Bulk",
    updateCategory: "Update Category",
    updateUnitType: "Update Unit Type",
    updateStock: "Update Stock",
    updateSellingPrice: "Update Selling Price",
    updateStockStatus: "Update Stock Status",
    updateBrand: "Update Brand",
    updateSize: "Update Size",
    enterSellingPriceToUpdate: "Enter Selling Price to Update",
    enterBrandToUpdate: "Enter Brand to Update",
    selectStockStatus: "Select Stock Status",
    good: "Good",
    medium: "Medium",
    low: "Low",
    urgent: "Urgent",
    selectCategory: "Select Category",
    selectUnitType: "Select Unit Type",
    clickToSelect: "Click on products to select them",
    selected: "selected",
    addBy: "Add by",
    reduceBy: "Reduce by",
    update: "Update",
    sort: "Sort",
    sortProducts: "Sort Products",
    searchPlaceholder: "🔍 Search...",
    
    // Common
    save: "Save",
    cancel: "Cancel",
    delete: "Delete",
    edit: "Edit",
    close: "Close",
    search: "Search",
    loading: "Loading...",
    success: "Success!",

    // Products Table
  photo: "Photo",
  product: "Product",
  stock: "Stock",
  actions: "Actions",
  
  // Sales
  clearSales: "Clear Sales",
  dateAndTime: "Date & Time",
  unit: "Unit",
  amount: "Amount",
  
  // Purchases
  refresh: "Refresh",
  serialNo: "Serial No.",
  products: "Products",
  vendor: "Vendor",
  totalAmount: "Total Amount",
  paymentMode: "Payment Mode",
  otherInfo: "Other Info",
  date: "Date",
  loadingPurchases: "Loading purchases...",
  
  // Product Modal
  addNewProduct: "Add New Product",
  productPhoto: "Product Photo",
  clickToUpload: "Click to upload or take photo",
  imageFormat: "JPG, PNG (Max 5MB)",
  changePhoto: "Change Photo",
  remove: "Remove",
  sellingPrice: "Selling Price",
  currentStock: "Current Stock (Optional)",
  leaveEmpty: "Leave empty",
  forExactQuantity: "For exact quantity",
  stockStatus: "Stock Status",
  minimumStock: "Minimum Stock",
  advancedOptions: "+ Advanced Options",
  typeToSearchBrands: "Type to search brands...",
  saveThisBrand: "Save this brand",
  typeToSearchSizes: "Type to search sizes...",
  saveThisSize: "Save this size",
  piecesPerBox: "Pieces per Box",
  sftPerBox: "SFT per Box",
  saveProduct: "Save Product",

  // Sidebar Menu
  menu: "Menu",
  home: "Home",
  general: "GENERAL",
  addUsers: "Add Users",
  allProducts: "All Products",
  productsInGroup: "Products in Group",
  inventoryAdjustments: "Inventory Adjustments",
  sales: "SALES",
  customer: "Customer",
  invoices: "Invoices",
  management: "MANAGEMENT",
  categories: "Categories",
  unitTypes: "Unit Types",
  brands: "Brands",
  sizes: "Sizes",
  salesReceipts: "Sales Receipts",
  salesOrder: "Sales Order",
  packages: "Packages",
  shipment: "Shipment",
  customerPayment: "Customer Payment",
  creditNotes: "Credit Notes",
  purchases: "PURCHASES",
  vendor: "Vendor",
  expenses: "Expenses",
  bills: "Bills",
  purchaseOrders: "Purchase Orders",
  purchaseReceives: "Purchase Receives",
  vendorPayment: "Vendor Payment",
  vendorCredits: "Vendor Credits",
  system: "SYSTEM",
  settings: "Settings",
  
  // Backup Reminder Modal
  monthlyBackupReminder: "Monthly Backup Reminder",
  timeToBackup: "It's time to backup your inventory data",
  protectYourData: "Protect Your Data",
  downloadBackupMessage: "Download a backup to keep your inventory safe",
  quickAndEasy: "Quick & Easy",
  backupTimeMessage: "Takes less than 30 seconds to complete",
  noBackupFound: "No backup found this month",
  dontShowAgainThisMonth: "Don't show this notification this month again",
  backupNow: "Backup Now",
  syncing: "Syncing...",

  // Instant Products Modal
  productNames: "Product Names",
  stockEntry: "Stock Entry",
  instantProductPlaceholder: "e.g., Tilecleaner, Grout, Adhesive...",
  skip: "Skip",
  addToList: "Add to List",
  productsToSave: "📝 Products to Save",
  noProductsAddedYet: "No products added yet",
  saveAll: "Save All",
  
  // Record Purchase Modal
  photoOptional: "📷 Photo (Optional)",
  tapOrPastePhoto: "Tap or paste photo",
  vendorName: "🏢 Vendor Name",
  vendorNamePlaceholder: "Vendor name",
  productsPurchased: "📦 Products Purchased",
  row: "Row",
  bulk: "Bulk",
  addPaymentDetails: "+ Add payment details",
  paymentModeOptional: "💳 Payment Mode (Optional)",
  cash: "Cash",
  online: "Online",
  credit: "Credit",
  notes: "📝 Notes",
  optional: "Optional",
  submit: "Submit",

  // Instant Products Mode Switching
  pleaseAddProductsFirst: '⚠️ Please add products first before entering stock',
  setStock: 'Set Stock',
  enterStockQuantity: 'Enter stock quantity...',
  
  // Change Password Modal
  currentPassword: 'Current Password',
  enterCurrentPasswordToContinue: 'Enter your current password to continue',
  enterCurrentPassword: 'Enter current password',
  continue: 'Continue',
  chooseNewPassword: 'Choose a new password (minimum 6 characters)',
  newPassword: 'New Password',
  confirmNewPassword: 'Confirm New Password',
  enterNewPassword: 'Enter new password',
  reEnterNewPassword: 'Re-enter new password',

    
    // Reset Data Modal
    resetAllData: "Reset All Data",
    resetWarning: "WARNING: This action cannot be undone!",
    resetMessage: "All your inventory data will be permanently deleted:",
    productsAndStock: "Products & Stock",
    groupsAndBrands: "Groups & Brands",
    customersAndSales: "Customers & Sales",
    invoicesAndRecords: "Invoices & Records",
    enterPasswordToConfirm: "Enter your password to confirm:",
    yourCurrentPassword: "Your current password",
    allDataCleared: "All your data has been cleared. You can start fresh now.",
    gotIt: "Got it",
  },
  
  hi: {
    // Navbar
    appTitle: "टाइल और सेनेटरीवेयर इन्वेंटरी",
    generateInvoice: "बिल बनाएं",
    viewInvoices: "बिल देखें",
    signOut: "साइन आउट",
    backupData: "डेटा बैकअप",
    restoreData: "डेटा पुनर्स्थापित करें",
    changePassword: "पासवर्ड बदलें",
    resetData: "डेटा रीसेट करें",
    signedIn: "साइन इन किया गया",

    // Instant Products Preview
  skipped: "छोड़ा गया",
  entering: "दर्ज कर रहे हैं",
  

  // saveProductToSheet
  notAuthenticated: 'प्रमाणित नहीं',
  duplicateProductFound: 'डुप्लिकेट उत्पाद मिला',
  
  // saveProduct
  fillRequiredFields: 'आवश्यक फ़ील्ड भरें',
  savingProduct: 'उत्पाद सहेजा जा रहा है...',
  saved: 'सहेजा गया',
  saveFailedReverted: 'सहेजना विफल - स्थानीय रूप से वापस किया गया।',
  saveFailed: 'सहेजना विफल',
  saveFailedCheckConsole: 'सहेजना विफल - स्थानीय रूप से वापस किया गया। विवरण के लिए कंसोल देखें।',
  
  // saveVariantData
  saving: 'सहेज रहे हैं...',
  userNotAuthenticated: 'उपयोगकर्ता प्रमाणित नहीं',
  variantIdMissing: 'वेरिएंट आईडी गायब है। कृपया संपादन फ़ॉर्म बंद करें और फिर से खोलें।',
  groupIdMissing: 'समूह आईडी गायब है। कृपया संपादन फ़ॉर्म बंद करें और फिर से खोलें।',
  invalidSellingPrice: 'अमान्य बिक्री मूल्य',
  invalidStockValue: 'अमान्य स्टॉक मान',
  variantUpdatedSuccess: '✅ वेरिएंट सफलतापूर्वक अपडेट किया गया!',
  errorPrefix: 'त्रुटि',
  checkConsole: 'कृपया विवरण के लिए कंसोल देखें।',
  
  // deleteProduct
  confirmDeleteProduct: 'क्या आप वाकई इस उत्पाद को हटाना चाहते हैं?',
  deleting: 'हटाया जा रहा है...',
  deleted: 'हटाया गया',
  deleteFailedReverted: 'हटाना विफल - स्थानीय रूप से वापस किया गया।',
  deleteFailed: 'हटाना विफल',

  // Save Instant Products
  pleaseAddAtLeastOneProduct: '⚠️ कृपया कम से कम एक उत्पाद जोड़ें',
  savingProducts: 'उत्पाद सहेजे जा रहे हैं...',
  errorNotAuthenticated: '❌ त्रुटि: प्रमाणित नहीं। कृपया फिर से साइन इन करें।',
  uncategorized: '',
  notApplicable: '',
  piece: 'पीस',
  productsAddedSuccess: '✅ सफल!\n\n{count} उत्पाद स्टॉक के साथ जोड़े गए!',
  partialSuccess: '⚠️ आंशिक सफलता\n\n✅ सहेजे गए: {saved}\n❌ विफल: {failed}\n\nविफल उत्पाद:\n{list}',
  
  // Stock Badge
  outOfStock: 'स्टॉक में नहीं',
  inStock: 'स्टॉक में',
  
  // Edit Product
  productNotFound: '❌ उत्पाद नहीं मिला',
  
  // Sales Modal
  recordNewSale: "नई बिक्री रिकॉर्ड करें",
  quickAddProducts: "त्वरित उत्पाद जोड़ें (बहु-चयन)",
  clickToSelectMultiple: "एकाधिक उत्पाद चुनने के लिए क्लिक करें...",
  searchProducts: "🔍 उत्पाद खोजें...",
  selectMultipleToAutoFill: "नीचे पंक्तियाँ स्वतः भरने के लिए एकाधिक उत्पाद चुनें",
  addMoreRows: "अधिक पंक्तियाँ जोड़ें",
  addProductsInBulk: "थोक में उत्पाद जोड़ें",
  addCustomProduct: "कस्टम उत्पाद जोड़ें",
  hashSymbol: "#",
  qty: "मात्रा",
  total: "कुल",
  subtotal: "उप-योग:",
  grandTotal: "कुल योग:",
  completeSale: "बिक्री पूर्ण करें",
    
    // Dashboard
    totalProducts: "कुल उत्पाद",
    qtyInHand: "उपलब्ध मात्रा",
    inStockItems: "स्टॉक में वस्तुएं",
    lowStockItems: "कम स्टॉक वाली वस्तुएं",
    inventory: "इन्वेंटरी",
    recentPurchases: "हालिया खरीद",
    recentSales: "हाल की बिक्री",
    recordSale: "बिक्री रिकॉर्ड करें",
    quickCreate: "त्वरित बनाएं",
    clickToFlip: "पलटने के लिए क्लिक करें",
    instantProducts: "त्वरित उत्पाद",
    addProduct: "उत्पाद जोड़ें",
    recordPurchase: "खरीद रिकॉर्ड करें",
    
    // Product Management
    editProduct: "उत्पाद संपादित करें",
    productName: "उत्पाद का नाम",
    brand: "ब्रांड",
    size: "साइज़",
    category: "श्रेणी",
    unitType: "इकाई प्रकार",
    quantity: "मात्रा",
    price: "कीमत",
    
    // Bulk Edit - NEW
    editProductsInBulk: "थोक में उत्पाद संपादित करें",
    updateCategory: "श्रेणी अपडेट करें",
    updateUnitType: "इकाई प्रकार अपडेट करें",
    updateStock: "स्टॉक अपडेट करें",
    updateSellingPrice: "बिक्री मूल्य अपडेट करें",
    updateStockStatus: "स्टॉक स्थिति अपडेट करें",
    updateBrand: "ब्रांड अपडेट करें",
    updateSize: "साइज़ अपडेट करें",
    enterSellingPriceToUpdate: "अपडेट करने के लिए बिक्री मूल्य दर्ज करें",
    enterBrandToUpdate: "अपडेट करने के लिए ब्रांड दर्ज करें",
    selectStockStatus: "स्टॉक स्थिति चुनें",
    good: "अच्छा",
    medium: "मध्यम",
    low: "कम",
    urgent: "तत्काल",
    selectCategory: "श्रेणी चुनें",
    selectUnitType: "इकाई प्रकार चुनें",
    clickToSelect: "चयन करने के लिए उत्पादों पर क्लिक करें",
    selected: "चयनित",
    addBy: "जोड़ें",
    reduceBy: "घटाएं",
    update: "अपडेट करें",
    sort: "क्रमबद्ध करें",
    sortProducts: "उत्पाद क्रमबद्ध करें",
    searchPlaceholder: "🔍 खोजें...",
    
    // Common
    save: "सहेजें",
    cancel: "रद्द करें",
    delete: "हटाएं",
    edit: "संपादित करें",
    close: "बंद करें",
    search: "खोजें",
    loading: "लोड हो रहा है...",
    success: "सफल!",

     // Products Table
  photo: "फ़ोटो",
  product: "उत्पाद",
  stock: "स्टॉक",
  actions: "कार्य",
  
  // Sales
  clearSales: "बिक्री साफ़ करें",
  dateAndTime: "तिथि और समय",
  unit: "इकाई",
  amount: "राशि",
  
  // Purchases
  refresh: "रिफ्रेश करें",
  serialNo: "क्रम संख्या",
  products: "उत्पाद",
  vendor: "विक्रेता",
  totalAmount: "कुल राशि",
  paymentMode: "भुगतान विधि",
  otherInfo: "अन्य जानकारी",
  date: "तिथि",
  loadingPurchases: "खरीद लोड हो रही है...",
  
  // Product Modal
  addNewProduct: "नया उत्पाद जोड़ें",
  productPhoto: "उत्पाद फ़ोटो",
  clickToUpload: "अपलोड या फ़ोटो लेने के लिए क्लिक करें",
  imageFormat: "JPG, PNG (अधिकतम 5MB)",
  changePhoto: "फ़ोटो बदलें",
  remove: "हटाएं",
  sellingPrice: "बिक्री मूल्य",
  currentStock: "वर्तमान स्टॉक (वैकल्पिक)",
  leaveEmpty: "खाली छोड़ें",
  forExactQuantity: "सटीक मात्रा के लिए",
  stockStatus: "स्टॉक स्थिति",
  minimumStock: "न्यूनतम स्टॉक",
  advancedOptions: "+ उन्नत विकल्प",
  typeToSearchBrands: "ब्रांड खोजने के लिए टाइप करें...",
  saveThisBrand: "इस ब्रांड को सहेजें",
  typeToSearchSizes: "साइज़ खोजने के लिए टाइप करें...",
  saveThisSize: "इस साइज़ को सहेजें",
  piecesPerBox: "प्रति बॉक्स टुकड़े",
  sftPerBox: "प्रति बॉक्स SFT",
  saveProduct: "उत्पाद सहेजें",

  // Sidebar Menu
  menu: "मेनू",
  home: "होम",
  general: "सामान्य",
  addUsers: "उपयोगकर्ता जोड़ें",
  allProducts: "सभी उत्पाद",
  productsInGroup: "समूह में उत्पाद",
  inventoryAdjustments: "इन्वेंटरी समायोजन",
  sales: "बिक्री",
  customer: "ग्राहक",
  invoices: "बिल",
  management: "प्रबंधन",
  categories: "श्रेणियाँ",
  unitTypes: "इकाई प्रकार",
  brands: "ब्रांड",
  sizes: "साइज़",
  salesReceipts: "बिक्री रसीद",
  salesOrder: "बिक्री आदेश",
  packages: "पैकेज",
  shipment: "शिपमेंट",
  customerPayment: "ग्राहक भुगतान",
  creditNotes: "क्रेडिट नोट",
  purchases: "खरीद",
  vendor: "विक्रेता",
  expenses: "खर्चे",
  bills: "बिल",
  purchaseOrders: "खरीद आदेश",
  purchaseReceives: "खरीद प्राप्तियाँ",
  vendorPayment: "विक्रेता भुगतान",
  vendorCredits: "विक्रेता क्रेडिट",
  system: "सिस्टम",
  settings: "सेटिंग्स",
  
  // Backup Reminder Modal
  monthlyBackupReminder: "मासिक बैकअप अनुस्मारक",
  timeToBackup: "अपने इन्वेंटरी डेटा का बैकअप लेने का समय है",
  protectYourData: "अपने डेटा की सुरक्षा करें",
  downloadBackupMessage: "अपनी इन्वेंटरी को सुरक्षित रखने के लिए बैकअप डाउनलोड करें",
  quickAndEasy: "त्वरित और आसान",
  backupTimeMessage: "पूरा होने में 30 सेकंड से कम समय लगता है",
  noBackupFound: "इस महीने कोई बैकअप नहीं मिला",
  dontShowAgainThisMonth: "यह सूचना इस महीने फिर से न दिखाएं",
  backupNow: "अभी बैकअप लें",
  syncing: "Syncing...",

  // Instant Products Modal
  productNames: "उत्पाद नाम",
  stockEntry: "स्टॉक प्रविष्टि",
  instantProductPlaceholder: "उदा., टाइलक्लीनर, ग्राउट, एडहेसिव...",
  skip: "छोड़ें",
  addToList: "सूची में जोड़ें",
  productsToSave: "📝 सहेजने के लिए उत्पाद",
  noProductsAddedYet: "अभी तक कोई उत्पाद नहीं जोड़ा गया",
  saveAll: "सभी सहेजें",
  
  // Record Purchase Modal
  photoOptional: "📷 फ़ोटो (वैकल्पिक)",
  tapOrPastePhoto: "फ़ोटो टैप या पेस्ट करें",
  vendorName: "🏢 विक्रेता का नाम",
  vendorNamePlaceholder: "विक्रेता का नाम",
  productsPurchased: "📦 खरीदे गए उत्पाद",
  row: "पंक्ति",
  bulk: "थोक",
  addPaymentDetails: "+ भुगतान विवरण जोड़ें",
  paymentModeOptional: "💳 भुगतान विधि (वैकल्पिक)",
  cash: "नकद",
  online: "ऑनलाइन",
  credit: "क्रेडिट",
  notes: "📝 नोट्स",
  optional: "वैकल्पिक",
  submit: "जमा करें",

  // Instant Products Mode Switching
  pleaseAddProductsFirst: '⚠️ कृपया पहले स्टॉक दर्ज करने से पहले उत्पाद जोड़ें',
  setStock: 'स्टॉक सेट करें',
  enterStockQuantity: 'स्टॉक मात्रा दर्ज करें...',
  
  // Change Password Modal
  currentPassword: 'वर्तमान पासवर्ड',
  enterCurrentPasswordToContinue: 'जारी रखने के लिए अपना वर्तमान पासवर्ड दर्ज करें',
  enterCurrentPassword: 'वर्तमान पासवर्ड दर्ज करें',
  continue: 'जारी रखें',
  chooseNewPassword: 'नया पासवर्ड चुनें (न्यूनतम 6 वर्ण)',
  newPassword: 'नया पासवर्ड',
  confirmNewPassword: 'नए पासवर्ड की पुष्टि करें',
  enterNewPassword: 'नया पासवर्ड दर्ज करें',
  reEnterNewPassword: 'नया पासवर्ड फिर से दर्ज करें',

    
    // Reset Data Modal
    resetAllData: "सभी डेटा रीसेट करें",
    resetWarning: "चेतावनी: यह कार्रवाई पूर्ववत नहीं की जा सकती!",
    resetMessage: "आपका सभी इन्वेंटरी डेटा स्थायी रूप से हटा दिया जाएगा:",
    productsAndStock: "उत्पाद और स्टॉक",
    groupsAndBrands: "समूह और ब्रांड",
    customersAndSales: "ग्राहक और बिक्री",
    invoicesAndRecords: "बिल और रिकॉर्ड",
    enterPasswordToConfirm: "पुष्टि करने के लिए अपना पासवर्ड दर्ज करें:",
    yourCurrentPassword: "आपका वर्तमान पासवर्ड",
    allDataCleared: "आपका सभी डेटा साफ़ कर दिया गया है। अब आप नए सिरे से शुरू कर सकते हैं।",
    gotIt: "समझ गया",
  }
};

var currentLanguage = localStorage.getItem('appLanguage') || 'en';

console.log('✅ Translations loaded');


// ==========================================
// ✅ TRANSLATION FUNCTIONS
// ==========================================

function changeLanguage(lang) {
  console.log('🌐 Changing to: ' + lang);
  
  currentLanguage = lang;
  localStorage.setItem('appLanguage', lang);
  
  translatePage();
  updateLanguageLabel(lang);
  updateLanguageCheckmarks(lang);
  showLanguageToast(lang);
}

function translatePage() {
  var lang = currentLanguage;
  
  console.log('🔄 Translating to ' + lang);
  
  // Translate elements with data-i18n
  var elements = document.querySelectorAll('[data-i18n]');
  for (var i = 0; i < elements.length; i++) {
    var element = elements[i];
    var key = element.getAttribute('data-i18n');
    var translation = translations[lang][key];
    
    if (translation) {
      if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
        element.placeholder = translation;
      } else {
        element.textContent = translation;
      }
    }
  }
  
  // Translate placeholders
  var placeholders = document.querySelectorAll('[data-i18n-placeholder]');
  for (var i = 0; i < placeholders.length; i++) {
    var element = placeholders[i];
    var key = element.getAttribute('data-i18n-placeholder');
    var translation = translations[lang][key];
    
    if (translation) {
      element.placeholder = translation;
    }
  }
  
  console.log('✅ Translated to ' + lang);
}

function updateLanguageLabel(lang) {
  var label = document.getElementById('currentLanguageLabel');
  if (label) {
    label.textContent = lang === 'hi' ? 'हिं' : 'EN';
  }
}

function updateLanguageCheckmarks(lang) {
  var enCheck = document.getElementById('langEnCheck');
  var hiCheck = document.getElementById('langHiCheck');
  
  if (enCheck && hiCheck) {
    if (lang === 'en') {
      enCheck.className = 'bi bi-check-circle-fill me-2';
      enCheck.style.color = '#198754';
      hiCheck.className = 'bi bi-circle me-2';
      hiCheck.style.color = '#ccc';
    } else {
      enCheck.className = 'bi bi-circle me-2';
      enCheck.style.color = '#ccc';
      hiCheck.className = 'bi bi-check-circle-fill me-2';
      hiCheck.style.color = '#198754';
    }
  }
}

function showLanguageToast(lang) {
  var message = lang === 'hi' 
    ? '✅ भाषा हिंदी में बदली गई' 
    : '✅ Language changed to English';
  
  var container = document.getElementById('languageToastContainer');
  if (!container) {
    container = document.createElement('div');
    container.id = 'languageToastContainer';
    container.style.cssText = 'position: fixed; top: 80px; right: 20px; z-index: 99999;';
    document.body.appendChild(container);
  }
  
  var toast = document.createElement('div');
  toast.className = 'alert alert-success alert-dismissible fade show';
  toast.style.cssText = 'min-width: 250px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-radius: 10px;';
  toast.innerHTML = '<i class="bi bi-translate me-2"></i>' + message + '<button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>';
  
  container.appendChild(toast);
  
  setTimeout(function() {
    toast.remove();
  }, 3000);
}

// Auto-translate on page load
setTimeout(function() {
  var savedLang = localStorage.getItem('appLanguage') || 'en';
  currentLanguage = savedLang;
  translatePage();
  updateLanguageLabel(savedLang);
  updateLanguageCheckmarks(savedLang);
  console.log('✅ i18n initialized: ' + savedLang);
}, 100);


/**
 * ==========================================
 * SIZE MANAGEMENT SYSTEM - FIREBASE VERSION
 * ==========================================
 */

// Global size cache
let sizeAutocompleteCache = [];
let sizeCacheLoaded = false;
let sizesCache = [];
let pendingSizes = [];

var bulkEditMode = {
  active: false,
  field: null,
  value: null,
  selectedProducts: []
};

console.log('✅ bulkEditMode initialized');

// Category Management
var categoryAutocompleteCache = [];
var categoryCacheLoaded = false;
var categoriesCache = [];
var pendingCategories = [];

// Unit Type Management
var unitTypeAutocompleteCache = [];
var unitTypeCacheLoaded = false;
var unitTypesCache = [];
var pendingUnitTypes = [];

    
 // ==========================================
// FIREBASE CONFIGURATION
// ==========================================
// Firebase imports are in <head> section - no need to redeclare here
// Access via: window.db, window.auth, window.firebaseImports

// Get current user ID (for multi-tenancy)
function getCurrentUserId() {
  const user = window.auth.currentUser;
  return user ? user.uid : null;
}

// Get tenant collection path
function getTenantCollection(collectionName) {
  const userId = getCurrentUserId();
  if (!userId) {
    throw new Error('User not authenticated');
  }
  return `tenants/${userId}/${collectionName}`;
}


    
  let cachedProducts = [];
  let cachedSales = [];

 // ✅ NEW: Product Groups cache
let cachedProductGroups = [];
let cachedGroupVariants = [];

// ✅ NEW: Page state management
let currentPage = 'home'; // home, allProducts, productGroups, groupDetail
let currentGroupId = null; // For group detail view

// ✅ PRODUCT PHOTO VARIABLES
let productPhotoBase64 = null;
let productPhotoFileName = null;








let deletedSaleIds = []; // NEW: Track manually deleted sales

// NEW: Load deleted IDs from localStorage on page load
try {
    const stored = localStorage.getItem('deletedSaleIds');
    if (stored) {
        deletedSaleIds = JSON.parse(stored);
        console.log('ÃƒÆ’Ã‚Â°Ãƒâ€¦Ã‚Â¸ÃƒÂ¢Ã¢â€šÂ¬Ã…â€œÃƒâ€šÃ‚Â Loaded', deletedSaleIds.length, 'deleted sale IDs from localStorage');
    }
} catch (e) {
    console.warn('Could not load deletedSaleIds from localStorage', e);
}
    
  let hasInitialLoaded = false;

  // Keep custom products added into the current sale (persist across grid re-builds)
  let customProductsInSale = []; // { id, name, size, unitType, price, quantity, isPersistedToInventory:false/true, tempProductId }




/**
 * Handle Email + Password Sign In
 */
async function handleEmailPasswordAuth(event) {
  event.preventDefault();
  
  const emailInput = document.getElementById('userEmailInput');
  const passwordInput = document.getElementById('userPasswordInput');
  const signInBtn = document.getElementById('signInBtn');
  
  const email = emailInput?.value?.trim();
  const password = passwordInput?.value;
  
  // Validation
  if (!email || !password) {
    alert('Please enter both email and password');
    return;
  }
  
  // Disable button during login
  if (signInBtn) {
    signInBtn.disabled = true;
    signInBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Signing in...';
  }
  
  try {
    console.log('🔐 Attempting to sign in with:', email);
    
    // Use Firebase Auth from window.firebaseImports
    const { signInWithEmailAndPassword } = window.firebaseImports;
    const userCredential = await signInWithEmailAndPassword(window.auth, email, password);
    
    console.log('✅ Sign in successful!', userCredential.user.email);
    
    // Auth state listener will handle showing the app automatically
    // No need to manually call showApp() here
    
  } catch (error) {
    console.error('❌ Sign in error:', error);
    
    // User-friendly error messages
    let errorMessage = 'Login failed. Please try again.';
    
    if (error.code === 'auth/wrong-password') {
      errorMessage = 'Incorrect password. Please try again.';
    } else if (error.code === 'auth/user-not-found') {
      errorMessage = 'No account found with this email. Please sign up first.';
    } else if (error.code === 'auth/invalid-email') {
      errorMessage = 'Invalid email address.';
    } else if (error.code === 'auth/too-many-requests') {
      errorMessage = 'Too many failed attempts. Please try again later.';
    } else if (error.code === 'auth/invalid-credential') {
      errorMessage = 'Invalid email or password. Please check and try again.';
    }
    
    alert(errorMessage);
    
    // Re-enable button
    if (signInBtn) {
      signInBtn.disabled = false;
      signInBtn.innerHTML = '<i class="bi bi-box-arrow-in-right me-2"></i>Sign In';
    }
  }
}


    /**
 * Handle Sign Up (Create Account)
 */
async function handleSignUp(event) {
  event.preventDefault();
  
  const emailInput = document.getElementById('signUpEmailInput');
  const passwordInput = document.getElementById('signUpPasswordInput');
  const signUpBtn = document.getElementById('signUpBtn');
  
  const email = emailInput?.value?.trim();
  const password = passwordInput?.value;
  
  // Validation
  if (!email || !password) {
    alert('Please enter both email and password');
    return;
  }
  
  if (password.length < 6) {
    alert('Password must be at least 6 characters long');
    return;
  }
  
  // Disable button
  if (signUpBtn) {
    signUpBtn.disabled = true;
    signUpBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creating account...';
  }
  
  try {
    console.log('📝 Creating account for:', email);
    
    const { createUserWithEmailAndPassword } = window.firebaseImports;
    const userCredential = await createUserWithEmailAndPassword(window.auth, email, password);
    
    console.log('✅ Account created successfully!', userCredential.user.email);
    alert('Account created successfully! Welcome!');
    
    // Auth state listener will handle showing the app automatically
    
  } catch (error) {
    console.error('❌ Sign up error:', error);
    
    let errorMessage = 'Failed to create account.';
    
    if (error.code === 'auth/email-already-in-use') {
      errorMessage = 'An account with this email already exists. Please sign in instead.';
    } else if (error.code === 'auth/invalid-email') {
      errorMessage = 'Invalid email address.';
    } else if (error.code === 'auth/weak-password') {
      errorMessage = 'Password is too weak. Please use at least 6 characters.';
    }
    
    alert(errorMessage);
    
    // Re-enable button
    if (signUpBtn) {
      signUpBtn.disabled = false;
      signUpBtn.innerHTML = '<i class="bi bi-person-plus me-2"></i>Sign Up';
    }
  }
}




  /***********************
   * Helpers
   ***********************/
  function showSyncIndicator(msg='Syncing...', hideAfterMs=null) {
    const el = document.getElementById('syncIndicator');
    document.getElementById('syncText').textContent = msg;
    el.style.display = 'block';
    if (hideAfterMs) setTimeout(()=> el.style.display = 'none', hideAfterMs);
  }
  function hideSyncIndicator(){ document.getElementById('syncIndicator').style.display='none'; }

  function safeParseResponse(res) {
    return res.text().then(txt => {
      try { return { ok: res.ok, json: JSON.parse(txt), text: txt }; }
      catch(e) { return { ok: res.ok, json: null, text: txt }; }
    });
  }
  function formatCurrency(n){ return '₹' + Number(n||0).toLocaleString('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2}); }
  function generateId(){ return 'TMP_' + Date.now().toString(36) + Math.random().toString(36).substr(2); }
  function escapeHtml(s){ if (s===null||s===undefined) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
/**
 * ==========================================
 * LOAD FEATURE FLAGS FROM FIRESTORE
 * ==========================================
 * Checks Firestore for updates and syncs with localStorage
 */
 async function loadFeatureFlags() {
    try {
        console.log("🔄 Checking Firestore for feature flag updates...");
        
        const user = window.auth?.currentUser;
        if (!user) {
            console.log("ℹ️ No user logged in, using cached feature flags.");
            return;
        }

        const { doc, getDoc, setDoc } = window.firebaseImports;
        const settingsRef = doc(window.db, 'tenants', user.uid, 'settings', 'featureFlags');
        const snap = await getDoc(settingsRef);

        if (snap.exists()) {
            const remoteData = snap.data();
            let needsUpdate = false;
            
            // ✅ Ensure new flags exist in remote data (backward compatibility)
            if (remoteData.enableSalesRecording === undefined) {
                remoteData.enableSalesRecording = true;
                needsUpdate = true;
                console.log('📝 Adding missing enableSalesRecording flag to Firestore');
            }
            
            // ✅ NEW: Check for Recent Sales View flag
            if (remoteData.enableRecentSalesView === undefined) {
                remoteData.enableRecentSalesView = true;
                needsUpdate = true;
                console.log('📝 Adding missing enableRecentSalesView flag to Firestore');
            }
            
            // Update Firestore if missing flags were added
            if (needsUpdate) {
                await setDoc(settingsRef, remoteData);
            }
            
            // Check if remote data differs from local
            const localDataStr = JSON.stringify(window.featureFlags);
            const remoteDataStr = JSON.stringify(remoteData);
            
            if (localDataStr !== remoteDataStr) {
                console.log("🔄 Remote feature flags differ from local, updating...");
                console.log("Old:", window.featureFlags);
                console.log("New:", remoteData);
                
                window.featureFlags = remoteData;
                localStorage.setItem('featureFlags', JSON.stringify(window.featureFlags));
                
                console.log(`✅ Updated feature flags:`, window.featureFlags);
                
                // ✅ Re-apply visibility with new flags
                applyFeatureFlagVisibility();
            } else {
                console.log("✅ Feature flags are up to date");
            }
        } else {
            // Create default flags for new user
            console.log("📝 Creating default feature flags in Firestore");
            const defaultFlags = {
                enableInvoiceGeneration: true,
                enableInvoiceViewing: true,
                enableSalesRecording: true,
                enableRecentSalesView: true,        // ✅ NEW
                enableAdvancedReports: false,
                enableWhatsAppIntegration: false,
                maxProducts: 1000,
                updatedAt: new Date().toISOString()
            };
            
            await setDoc(settingsRef, defaultFlags);
            window.featureFlags = defaultFlags;
            localStorage.setItem('featureFlags', JSON.stringify(window.featureFlags));
        }
        
    } catch (e) {
        console.warn('⚠️ Failed to check Firestore for updates:', e);
        // Continue with localStorage data (already loaded)
    }
}

function getDefaultFeatureFlags() {
    return {
        // Invoice Features
        enableInvoiceGeneration: true,
        enableInvoiceViewing: true,
        
        // Sales Features
        enableSalesRecording: true,
        enableRecentSalesView: true,        // ✅ NEW
        
        // Future features
        enableAdvancedReports: false,
        enableWhatsAppIntegration: false,
        
        // Limits
        maxProducts: 1000,
        
        updatedAt: new Date().toISOString()
    };
}

/**
 * Check if a feature is enabled for current user
 */
function isFeatureEnabled(featureName) {
    if (!window.featureFlags) {
        console.warn('⚠️ Feature flags not loaded yet, defaulting to true');
        return true; // Default to enabled if not loaded
    }
    
    const enabled = window.featureFlags[featureName] === true;
    console.log(`🚩 Feature "${featureName}": ${enabled ? '✅ ENABLED' : '❌ DISABLED'}`);
    return enabled;
}
/**
 * ==========================================
 * APPLY FEATURE FLAG VISIBILITY
 * ==========================================
 * Called from syncFromFirestore to update UI based on feature flags
 */
 function applyFeatureFlagVisibility() {
    console.log("🎯 Applying feature flag visibility...");
    
    // Show/Hide Invoice Generation buttons
    const invoiceGenButtons = document.querySelectorAll('[data-feature-flag="enableInvoiceGeneration"]');
    invoiceGenButtons.forEach(button => {
        if (isFeatureEnabled('enableInvoiceGeneration')) {
            button.style.display = '';
            button.style.opacity = '1';
            button.style.visibility = 'visible';
            button.style.pointerEvents = 'auto';
            button.classList.remove('d-none');
            
            const textElements = button.querySelectorAll('span, i');
            textElements.forEach(el => {
                el.style.opacity = '1';
                el.style.visibility = 'visible';
            });
        } else {
            button.style.display = 'none';
            button.style.opacity = '0';
            button.style.visibility = 'hidden';
            button.style.pointerEvents = 'none';
            button.classList.add('d-none');
        }
    });
    
    // Show/Hide Invoice Viewing buttons
    const invoiceViewButtons = document.querySelectorAll('[data-feature-flag="enableInvoiceViewing"]');
    invoiceViewButtons.forEach(button => {
        if (isFeatureEnabled('enableInvoiceViewing')) {
            button.style.display = '';
            button.style.opacity = '1';
            button.style.visibility = 'visible';
            button.style.pointerEvents = 'auto';
            button.classList.remove('d-none');
            
            const textElements = button.querySelectorAll('span, i');
            textElements.forEach(el => {
                el.style.opacity = '1';
                el.style.visibility = 'visible';
            });
        } else {
            button.style.display = 'none';
            button.style.opacity = '0';
            button.style.visibility = 'hidden';
            button.style.pointerEvents = 'none';
            button.classList.add('d-none');
        }
    });
    
    // Show/Hide Record Sale buttons
    const recordSaleButtons = document.querySelectorAll('[data-feature-flag="enableSalesRecording"]');
    recordSaleButtons.forEach(button => {
        if (isFeatureEnabled('enableSalesRecording')) {
            button.style.display = '';
            button.style.opacity = '1';
            button.style.visibility = 'visible';
            button.style.pointerEvents = 'auto';
            button.classList.remove('d-none');
            
            const textElements = button.querySelectorAll('span, i');
            textElements.forEach(el => {
                el.style.opacity = '1';
                el.style.visibility = 'visible';
            });
        } else {
            button.style.display = 'none';
            button.style.opacity = '0';
            button.style.visibility = 'hidden';
            button.style.pointerEvents = 'none';
            button.classList.add('d-none');
        }
    });
    
    // ✅ NEW: Show/Hide Recent Sales View button
    const recentSalesButtons = document.querySelectorAll('[data-feature-flag="enableRecentSalesView"]');
    recentSalesButtons.forEach(button => {
        if (isFeatureEnabled('enableRecentSalesView')) {
            button.style.display = '';
            button.style.opacity = '1';
            button.style.visibility = 'visible';
            button.style.pointerEvents = 'auto';
            button.classList.remove('d-none');
            
            const textElements = button.querySelectorAll('span, i');
            textElements.forEach(el => {
                el.style.opacity = '1';
                el.style.visibility = 'visible';
            });
        } else {
            button.style.display = 'none';
            button.style.opacity = '0';
            button.style.visibility = 'hidden';
            button.style.pointerEvents = 'none';
            button.classList.add('d-none');
            
            // ✅ Switch to inventory if sales view is currently active
            if (button.classList.contains('active')) {
                switchToInventoryView();
            }
        }
    });
    
    console.log("✅ Feature flag visibility applied");
    
    // ✅ Adjust flip card layout based on visibility
    adjustFlipCardLayout();
}




  
/**
 * ==========================================
 * SYNC FROM FIRESTORE - KEEP LATEST VERSION
 * ==========================================
 */
 async function syncFromFirestore() {
  const user = window.auth.currentUser;
  
  if (!user) {
    console.warn('⚠️ No user authenticated');
    showAuthScreen();
    return;
  }

  showSyncIndicator('Refreshing...');
  
  try {
    const { collection, getDocs, query, orderBy } = window.firebaseImports;
    const userId = user.uid;
    
    console.log('🔄 Syncing data for user:', userId);
    
    // ✅ Fetch products from Firestore
    const productsRef = collection(window.db, 'tenants', userId, 'products');
    const productsSnap = await getDocs(productsRef);
    
    // ✅ STEP 1: Collect all products
    const allProducts = [];
    productsSnap.forEach((doc) => {
      allProducts.push({
        id: doc.id,
        ...doc.data()
      });
    });
    
    console.log(`📦 Fetched ${allProducts.length} products from Firestore`);
    
    // ✅ STEP 2: Remove duplicates - KEEP LATEST BY updatedAt
    const uniqueProductsMap = new Map();
    
    allProducts.forEach(product => {
      const existingProduct = uniqueProductsMap.get(product.id);
      
      if (!existingProduct) {
        uniqueProductsMap.set(product.id, product);
      } else {
        const existingTime = existingProduct.updatedAt ? new Date(existingProduct.updatedAt).getTime() : 0;
        const newTime = product.updatedAt ? new Date(product.updatedAt).getTime() : 0;
        
        if (newTime > existingTime) {
          console.log('🔄 Replacing old product with newer version:', product.name);
          uniqueProductsMap.set(product.id, product);
        }
      }
    });
    
    // ✅ STEP 3: Convert map back to array
    cachedProducts = Array.from(uniqueProductsMap.values());
    
    console.log(`✅ Loaded ${cachedProducts.length} unique products (kept latest versions)`);
    
    // ✅ STEP 4: Check for duplicate names with different IDs
    const nameMap = {};
    cachedProducts.forEach(product => {
      const name = product.name?.toLowerCase().trim();
      if (name) {
        if (!nameMap[name]) {
          nameMap[name] = [];
        }
        nameMap[name].push({
          id: product.id,
          name: product.name,
          stock: product.stock,
          updatedAt: product.updatedAt
        });
      }
    });
    
    // ✅ STEP 5: For duplicate names, keep only the latest one
    const idsToRemove = [];
    
    Object.keys(nameMap).forEach(name => {
      if (nameMap[name].length > 1) {
        console.warn(`⚠️ Found ${nameMap[name].length} products with name "${name}"`);
        
        const sorted = nameMap[name].sort((a, b) => {
          const timeA = a.updatedAt ? new Date(a.updatedAt).getTime() : 0;
          const timeB = b.updatedAt ? new Date(b.updatedAt).getTime() : 0;
          return timeB - timeA;
        });
        
        const toKeep = sorted[0];
        console.log(`✅ Keeping latest:`, toKeep.id, '| Updated:', toKeep.updatedAt);
        
        for (let i = 1; i < sorted.length; i++) {
          console.log(`🗑️ Marking for removal:`, sorted[i].id, '| Updated:', sorted[i].updatedAt);
          idsToRemove.push(sorted[i].id);
        }
      }
    });
    
    // ✅ STEP 6: Remove old duplicates from cache
    if (idsToRemove.length > 0) {
      console.log(`🗑️ Removing ${idsToRemove.length} old duplicate products from cache`);
      cachedProducts = cachedProducts.filter(p => !idsToRemove.includes(p.id));
    }
    
    // Sort products by name
    cachedProducts.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
    
    console.log(`✅ Final: ${cachedProducts.length} unique products loaded`);
    
    // ✅ Save to cache
    try {
      localStorage.setItem('inventory_products_cache', JSON.stringify(cachedProducts));
      console.log('💾 Products saved to cache');
    } catch (cacheError) {
      console.warn('⚠️ Failed to save products cache:', cacheError);
    }
    
    // ✅ Fetch sales from Firestore
    try {
      const salesRef = collection(window.db, 'tenants', userId, 'sales');
      
      try {
        const salesQuery = query(salesRef, orderBy('date', 'desc'));
        const salesSnap = await getDocs(salesQuery);
        
        let allSales = [];
        salesSnap.forEach((doc) => {
          allSales.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        let deletedSaleIds = JSON.parse(localStorage.getItem('deletedSaleIds') || '[]');
        cachedSales = allSales.filter(sale => !deletedSaleIds.includes(sale.id));
        
        console.log(`📊 Loaded ${allSales.length} sales, showing ${cachedSales.length}`);
        
      } catch (orderError) {
        console.warn('⚠️ OrderBy failed, fetching all sales:', orderError.message);
        
        const salesSnap = await getDocs(salesRef);
        
        let allSales = [];
        salesSnap.forEach((doc) => {
          allSales.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        allSales.sort((a, b) => {
          const dateA = a.date ? new Date(a.date).getTime() : 0;
          const dateB = b.date ? new Date(b.date).getTime() : 0;
          return dateB - dateA;
        });
        
        let deletedSaleIds = JSON.parse(localStorage.getItem('deletedSaleIds') || '[]');
        cachedSales = allSales.filter(sale => !deletedSaleIds.includes(sale.id));
        
        console.log(`📊 Loaded ${allSales.length} sales (sorted in JS), showing ${cachedSales.length}`);
      }
      
      try {
        localStorage.setItem('inventory_sales_cache', JSON.stringify(cachedSales));
      } catch (e) {
        console.warn('⚠️ Failed to save sales cache:', e);
      }
      
    } catch (salesError) {
      console.error('❌ Failed to load sales:', salesError.message);
      cachedSales = [];
    }
    
    hasInitialLoaded = true;
    
    // ✅ Render
    try {
      renderProducts();
    } catch (e) {
      console.error('❌ Failed to render products:', e.message);
    }
    
    try {
      renderSales();
    } catch (e) {
      console.error('❌ Failed to render sales:', e.message);
    }
    
    try {
      updateSummaryFromCache();
    } catch (e) {
      console.error('❌ Failed to update summary:', e.message);
    }
    
    try {
      if (typeof loadRecentSales === 'function') {
        loadRecentSales();
      }
    } catch (e) {
      console.error('❌ Failed to load recent sales:', e.message);
    }
// ✅ Load all preferences (Translation Exclusions + Custom Text Names + Feature Flags)
try {
  // Initialize data structures
  if (!window.translationExclusions) window.translationExclusions = new Set();
  if (!window.customTextNames) window.customTextNames = {};
  if (!window.featureFlags) window.featureFlags = getDefaultFeatureFlags();

  // 1. Load Translation Exclusions
  await loadTranslationExclusions();

  // 2. Load Custom Text Names
  await loadCustomTextNamesFromFirestore();

  // 3. Load Feature Flags (NEW)
  await loadFeatureFlags();

  // 4. Re-sync checkbox UI if exclusion mode is open
  if (window.isTranslationExclusionMode) {
    document.querySelectorAll('.translation-exclusion-checkbox').forEach(cb => {
      const key = cb.getAttribute('data-i18n-key');
      cb.checked = key ? window.translationExclusions.has(key) : false;
    });
  }

  // 5. Apply translations
  translatePage();
  
  // 6. Apply feature flag visibility (NEW)
  applyFeatureFlagVisibility();
  // Remove loading state
document.body.classList.remove('loading');
document.body.classList.add('loaded');
      
} catch (e) {
  console.warn('⚠️ Failed to load preferences:', e);
  // Ensure data structures exist even on error
  if (!window.translationExclusions) window.translationExclusions = new Set();
  if (!window.customTextNames) window.customTextNames = {};
  if (!window.featureFlags) window.featureFlags = getDefaultFeatureFlags();
  translatePage();
  applyFeatureFlagVisibility(); // ADD THIS LINE
}

    
    showSyncIndicator('Synced!', 900);
    
  } catch (err) {
    console.error('❌ Sync error:', err.message);
    showSyncIndicator('Sync failed', 1500);
    
    try {
      cachedProducts = JSON.parse(localStorage.getItem('inventory_products_cache') || '[]');
      cachedSales = JSON.parse(localStorage.getItem('inventory_sales_cache') || '[]');
      
      const uniqueMap = new Map();
      cachedProducts.forEach(p => {
        if (!uniqueMap.has(p.id)) {
          uniqueMap.set(p.id, p);
        }
      });
      cachedProducts = Array.from(uniqueMap.values());
      
      renderProducts();
      renderSales();
    } catch (e) {
      console.error('Failed to load from cache:', e);
    }
  }
}


    
// Manual refresh function
async function manualRefresh() {
  const btn = document.getElementById('refreshBtn');
  const icon = document.getElementById('refreshIcon');
  btn.disabled = true;
  icon.className = 'bi bi-arrow-clockwise spinner-border spinner-border-sm';
  await syncFromFirestore();
  icon.className = 'bi bi-arrow-clockwise';
  btn.disabled = false;
}


 /***********************
   * Load sale product select helper (if needed elsewhere)
   ***********************/
  function loadProductsForSaleFromCache(){
    // not used directly now (we populate selects per-row), but keep for compatibility
  }




    

/**
 * Fallback function to load products and sales from Firestore
 * ✅ FIREBASE VERSION
 */
async function fallbackGetProductsAndSales() {
  const user = window.auth.currentUser;
  
  if (!user) {
    console.warn('No user authenticated, skipping fallback load');
    return;
  }
  
  try {
    const { collection, getDocs } = window.firebaseImports;
    
    // Load products
    try {
      const productsRef = collection(window.db, 'tenants', user.uid, 'products');
      const productsSnapshot = await getDocs(productsRef);
      
      const products = [];
      productsSnapshot.forEach((doc) => {
        products.push({
          id: doc.id,
          ...doc.data()
        });
      });
      
      cachedProducts = products;
      console.log('✅ Fallback: Loaded', products.length, 'products from Firestore');
    } catch (e) {
      console.warn('❌ Fallback products failed:', e);
    }
    
    // Load sales
    try {
      const salesRef = collection(window.db, 'tenants', user.uid, 'sales');
      const salesSnapshot = await getDocs(salesRef);
      
      const sales = [];
      salesSnapshot.forEach((doc) => {
        sales.push({
          id: doc.id,
          ...doc.data()
        });
      });
      
      cachedSales = sales;
      console.log('✅ Fallback: Loaded', sales.length, 'sales from Firestore');
    } catch (e) {
      console.warn('❌ Fallback sales failed:', e);
    }
    
    hasInitialLoaded = true;
    renderProducts();
    renderSales();
    
  } catch (error) {
    console.error('❌ Fallback load failed:', error);
  }
}
/**
 * Manual refresh button handler
 * ✅ FIREBASE VERSION
 */
async function manualRefresh() {
  const btn = document.getElementById('refreshBtn');
  const icon = document.getElementById('refreshIcon');
  
  if (!btn || !icon) {
    console.warn('Refresh button or icon not found');
    return;
  }
  
  // Disable button and show spinner
  btn.disabled = true;
  icon.className = 'bi bi-arrow-clockwise spinner-border spinner-border-sm';
  
  try {
    // Sync from Firestore (calls syncFromFirestore which you already converted)
    if (typeof syncFromFirestore === 'function') {
      await syncFromFirestore();
    } else if (typeof syncFromGoogleSheets === 'function') {
      // Fallback to renamed function if exists
      await syncFromGoogleSheets();
    } else {
      console.warn('No sync function found, calling fallback');
      await fallbackGetProductsAndSales();
    }
    
    console.log('✅ Manual refresh complete');
    
  } catch (error) {
    console.error('❌ Manual refresh failed:', error);
    alert('Refresh failed: ' + error.message);
  } finally {
    // Re-enable button and remove spinner
    icon.className = 'bi bi-arrow-clockwise';
    btn.disabled = false;
  }
}

/***********************
 * Rendering
 ***********************/
function categoryIconColor(cat){
  if(!cat) return '#6c757d';
  const c = cat.toLowerCase();
  if(c.includes('tile')) return '#0d6efd';
  if(c.includes('sanitary')) return '#198754';
  if(c.includes('access')) return '#fd7e14';
  return '#6c757d';
}
/**
 * Stock Badge HTML - WITH TRANSLATION
 */
 function stockBadgeHtml(stock, minStock) {
  const lang = window.currentLanguage || 'en';
  const translations = window.translations[lang];
  
  const baseStyle = `
    padding: 4px 12px;
    border-radius: 3px;
    font-weight: 500;
    font-size: 0.8rem;
    display: inline-block;
    letter-spacing: 0.5px;
    border-left: 3px solid;
  `;
  
  if (typeof stock === 'string') {
    const statusUpper = stock.toUpperCase();
    
    // ✅ GOOD - Even more green
    if (statusUpper === 'GOOD') {
      const goodText = translations.good || 'GOOD';
      return `<span style="background: #a5d6a7; color: #1b5e20; border-color: #2e7d32; ${baseStyle}">${goodText.toUpperCase()}</span>`;
    }
    
    if (statusUpper === 'MEDIUM') {
      const mediumText = translations.medium || 'MEDIUM';
      return `<span style="background: #fff3cd; color: #856404; border-color: #f57c00; ${baseStyle}">${mediumText.toUpperCase()}</span>`;
    }
    
    if (statusUpper === 'LOW') {
      const lowText = translations.low || 'LOW';
      return `<span style="background: #ffe5e5; color: #8b1a1a; border-color: #d32f2f; ${baseStyle}">${lowText.toUpperCase()}</span>`;
    }
    
    if (statusUpper === 'URGENT') {
      const urgentText = translations.urgent || 'URGENT';
      return `<span style="background: #e3e8f0; color: #1a237e; border-color: #3949ab; ${baseStyle}">${urgentText.toUpperCase()}</span>`;
    }
  }
  
  minStock = (typeof minStock === 'number') ? minStock : Number(minStock) || 5;
  stock = Number(stock) || 0;
  
  if (stock === 0) {
    const outOfStockText = translations.outOfStock || 'OUT OF STOCK';
    return `<span style="background: #e3e8f0; color: #1a237e; border-color: #3949ab; ${baseStyle}">${outOfStockText.toUpperCase()}</span>`;
  }
  
  if (stock <= minStock) {
    const lowText = translations.low || 'LOW';
    return `<span style="background: #ffe5e5; color: #8b1a1a; border-color: #d32f2f; ${baseStyle}">${lowText.toUpperCase()} (${stock})</span>`;
  }
  
  // ✅ IN STOCK - Even more green
  const inStockText = translations.inStock || 'IN STOCK';
  return `<span style="background: #a5d6a7; color: #1b5e20; border-color: #2e7d32; ${baseStyle}">${inStockText.toUpperCase()} (${stock})</span>`;
}
/**
 * Render products with custom order (HIDE EMPTY FIELDS)
 */
 function renderProducts() {
  const tbody = document.getElementById('productsTableBody');
  
  if (!hasInitialLoaded) {
    tbody.innerHTML = `<tr><td colspan="8" class="text-center py-4"><div class="spinner-border"></div><div class="mt-2 text-muted">Loading inventory…</div></td></tr>`;
  } else if (!cachedProducts || cachedProducts.length === 0) {
    tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted py-4">No products yet</td></tr>`;
  } else {
    // Load custom order and get ordered products
    loadProductOrder();
    const orderedProducts = getOrderedProducts();
    
    console.log(`🎨 Rendering ${orderedProducts.length} products (custom order: ${productOrder.length > 0 ? 'YES' : 'NO'})`);
    
    let html = '';
    orderedProducts.forEach((p, index) => {
      
      // ✅ Price display - only show if has value
      let priceText = '<span class="text-muted">-</span>';
      if (shouldDisplayField(p.price, 'price')) {
        const unitType = shouldDisplayField(p.unitType) ? p.unitType : '';
        priceText = `<strong>₹${parseFloat(p.price).toFixed(2)}</strong>${unitType ? '/' + unitType : ''}`;
      }
      
      // Variant badge
      const variantBadge = p.isGroupVariant ? 
        `<span style="background: #667eea; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; margin-left: 6px;">📦 GROUP</span>` : 
        '';
      
      // Photo thumbnail HTML
      const photoHtml = (p.imageUrl && p.imageUrl !== '' && p.imageUrl !== 'uploading...') ? 
        `<img src="${p.imageUrl}" 
             class="photo-thumbnail-small" 
             alt="Photo" 
             onclick="event.stopPropagation(); viewPhotoProduct('${p.id}')"
             style="cursor:pointer; width:60px; height:60px; object-fit:cover; border-radius:8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">` : 
        `<div style="width:60px; height:60px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius:8px; display:flex; align-items:center; justify-content:center;">
          <i class="bi bi-image" style="font-size:1.8rem; color:white;"></i>
         </div>`;
      
      const isSelected = bulkEditMode.active && bulkEditMode.selectedProducts.includes(p.id);
      const rowClass = isSelected ? 'product-selected' : '';
      
      // ✅ Conditional field displays
      const categoryDisplay = shouldDisplayField(p.category) 
        ? escapeHtml(p.category) 
        : '<span class="text-muted">-</span>';
      
      const brandDisplay = shouldDisplayField(p.brand) 
        ? escapeHtml(p.brand) 
        : '<span class="text-muted">-</span>';
      
      const sizeDisplay = shouldDisplayField(p.size) 
        ? `<strong>${escapeHtml(p.size)}</strong>` 
        : '<span class="text-muted">-</span>';
      
      // ✅ MAKE ROW CLICKABLE - Add onclick to tr
      html += `<tr class="${rowClass}" 
                   data-product-id="${p.id}" 
                   data-product-index="${index}"
                   onclick="showProductDetails('${p.id}')"
                   style="cursor: pointer; transition: background-color 0.2s;"
                   onmouseover="if(!this.classList.contains('product-selected')) this.style.backgroundColor='#f8f9fa'"
                   onmouseout="if(!this.classList.contains('product-selected')) this.style.backgroundColor=''">
        <td style="text-align: center;">${photoHtml}</td>
        <td><strong>${escapeHtml(p.name)}</strong>${variantBadge}</td>
        <td>${categoryDisplay}</td>
        <td>${brandDisplay}</td>
        <td>${sizeDisplay}</td>
        <td data-field="stock">${stockBadgeHtml(p.stock, p.minStock)}</td>
        <td>${priceText}</td>
        <td onclick="event.stopPropagation()">
          <button class="btn btn-sm btn-primary btn-action-sm me-1" onclick="editProduct('${p.id}', ${p.isGroupVariant})"><i class="bi bi-pencil"></i> Edit</button>
          <button class="btn btn-sm btn-danger btn-action-sm" onclick="deleteProduct('${p.id}', ${p.isGroupVariant})"><i class="bi bi-trash"></i> Delete</button>
        </td>
      </tr>`;
    });
    tbody.innerHTML = html;
    
    if (bulkEditMode.active) {
      enableProductSelectionDesktop();
    }
  }
  
  // ✅ MOBILE LIST - Make cards clickable (HIDE EMPTY FIELDS)
  const container = document.getElementById('mobileProductsList');
  if (!hasInitialLoaded) { 
    container.innerHTML = `<div class="mobile-item text-center"><div class="spinner-border"></div><div class="mt-2 text-muted">Loading inventory…</div></div>`; 
  } else if (!cachedProducts || cachedProducts.length === 0) { 
    container.innerHTML = `<div class="mobile-item text-center text-muted">No products yet</div>`; 
  } else {
    loadProductOrder();
    const orderedProducts = getOrderedProducts();
    
    let html = '';
    orderedProducts.forEach((p, index) => {
      const variantBadge = p.isGroupVariant ? 
        `<span style="background: #667eea; color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; display: inline-block; margin-top: 6px;">📦 Group Variant</span>` : 
        '';
      
      const mobilePhoto = (p.imageUrl && p.imageUrl !== '' && p.imageUrl !== 'uploading...') ? 
        `<img src="${p.imageUrl}" 
             alt="Photo" 
             onclick="event.stopPropagation(); viewPhotoProduct('${p.id}')"
             style="cursor:pointer; width:70px; height:70px; object-fit:cover; border-radius:12px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">` : 
        `<div style="width:70px; height:70px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius:12px; display:flex; align-items:center; justify-content:center;">
          <i class="bi bi-image" style="font-size:2.2rem; color:white;"></i>
         </div>`;
      
      const isSelected = bulkEditMode.active && bulkEditMode.selectedProducts.includes(p.id);
      const cardClass = isSelected ? 'product-selected' : '';
      
      // ✅ Build info line (only non-empty fields)
      let infoLine = [];
      if (shouldDisplayField(p.category)) infoLine.push(escapeHtml(p.category));
      if (shouldDisplayField(p.brand)) infoLine.push(escapeHtml(p.brand));
      const infoLineHTML = infoLine.length > 0 
        ? `<div class="small-muted">${infoLine.join(' • ')}</div>` 
        : '';
      
      // ✅ Size line
      const sizeLineHTML = shouldDisplayField(p.size) 
        ? `<div class="small-muted"><strong>${escapeHtml(p.size)}</strong></div>` 
        : '';
      
      // ✅ Price line
      let priceLineHTML = '';
      if (shouldDisplayField(p.price, 'price')) {
        const unitType = shouldDisplayField(p.unitType) ? p.unitType : '';
        priceLineHTML = `<div style="margin-top:8px;"><strong>₹${parseFloat(p.price).toFixed(2)}</strong>${unitType ? '/' + unitType : ''}</div>`;
      }
      
      // ✅ MAKE CARD CLICKABLE - Add onclick to mobile-item div
      html += `<div class="mobile-item ${cardClass} d-flex align-items-start justify-content-between" 
                    data-product-id="${p.id}" 
                    data-product-index="${index}"
                    onclick="showProductDetails('${p.id}')"
                    style="gap:1rem; position:relative; cursor: pointer; transition: background-color 0.2s;">
        
        <div class="selection-indicator" style="display: ${isSelected ? 'flex' : 'none'};">
          <i class="bi bi-check-circle-fill"></i>
        </div>
        
        <div style="display:flex;gap:1rem;align-items:flex-start;flex:1;">
          <div style="flex-shrink:0;">${mobilePhoto}</div>
          <div style="flex:1;">
            <div style="font-weight:600;font-size:1rem;margin-bottom:4px;">${escapeHtml(p.name)}</div>
            ${variantBadge}
            ${infoLineHTML}
            ${sizeLineHTML}
            ${priceLineHTML}
            <div style="margin-top:8px;" data-field="stock">${stockBadgeHtml(p.stock, p.minStock)}</div>
          </div>
        </div>
        <div style="text-align:right;flex-shrink:0;" onclick="event.stopPropagation()">
          <div style="display:flex;flex-direction:column;gap:8px;">
            <button class="btn btn-sm btn-primary btn-action-sm" onclick="editProduct('${p.id}', ${p.isGroupVariant})"><i class="bi bi-pencil"></i> Edit</button>
            <button class="btn btn-sm btn-danger btn-action-sm" onclick="deleteProduct('${p.id}', ${p.isGroupVariant})"><i class="bi bi-trash"></i> Delete</button>
          </div>
        </div>
      </div>`;
    });
    container.innerHTML = html;
    
    if (bulkEditMode.active) {
      enableProductSelectionMobile();
    }
  }
  
  updateSummaryFromCache();
  loadProductsForSaleFromCache();
  
  console.log('✅ Products rendered (empty fields hidden)');
}



  function renderSales(){
    const tbody = document.getElementById('salesList');
    
    if(!hasInitialLoaded){ tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4"><div class="spinner-border"></div><div class="mt-2 text-muted">Loading salesÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â‚¬Å¡Ã‚Â¬Ãƒâ€šÃ‚Â¦</div></td></tr>`; return; }
    
    if(!cachedSales || cachedSales.length===0){ tbody.innerHTML=`<tr><td colspan="5" class="text-center text-muted py-4">No sales recorded yet</td></tr>`; return; }
    
    let html = '';
    
    const recent = (cachedSales || []).slice(0,100);
    recent.forEach(sale => {
      const d = new Date(sale.date||'');
      const formatted = d && !isNaN(d) ? (d.toLocaleDateString('en-IN') + ' ' + d.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'})) : sale.date;
      html += `<tr><td>${formatted}</td><td>${escapeHtml(sale.productName)}</td><td>${sale.quantity}</td><td>${escapeHtml(sale.unitType)}</td><td class="text-success fw-bold">₹${parseFloat(sale.totalAmount||0).toFixed(2)}</td></tr>`;
    });
    tbody.innerHTML = html;
    updateSummaryFromCache();
  }
/**
 * ==========================================
 * UPDATE SUMMARY - WITH IN STOCK & LOW STOCK COUNTS
 * ==========================================
 */
 function updateSummaryFromCache() {
  // ✅ Count ONLY regular products (not variants)
  const regularProducts = cachedProducts.filter(p => !p.isGroupVariant);
  const totalProductsEl = document.getElementById('totalProducts');
  if (totalProductsEl) {
    totalProductsEl.textContent = regularProducts.length;
  }
  
  // ✅ IN STOCK ITEMS - Items with Good/Medium status OR stock > minStock
  const inStockCount = cachedProducts.filter(p => {
    const stockValue = p.stock;
    const stockType = typeof stockValue;
    
    // CHECK 1: If stock is TEXT status
    if (stockType === 'string') {
      const stockText = stockValue.toString().toUpperCase().trim();
      
      // ✅ COUNT Good and Medium
      if (stockText === 'GOOD' || stockText === 'MEDIUM') {
        return true;
      }
      
      // Try parsing as number if it's a numeric string
      const parsedStock = parseFloat(stockValue);
      if (!isNaN(parsedStock)) {
        const minStock = Number(p.minStock) || 5;
        return parsedStock > minStock; // Count if above minimum
      }
      
      return false;
    }
    
    // CHECK 2: If stock is NUMBER, check if > minStock
    if (stockType === 'number') {
      const stock = Number(stockValue);
      const minStock = Number(p.minStock) || 5;
      
      // Count if stock is above minimum stock level
      return !isNaN(stock) && stock > minStock;
    }
    
    return false;
  }).length;
  
  const inStockEl = document.getElementById('inStockItems');
  if (inStockEl) {
    inStockEl.textContent = inStockCount;
  }
  
  // ✅ LOW STOCK ITEMS - Items with Low/Urgent status OR stock <= minStock
  const lowStockCount = cachedProducts.filter(p => {
    const stockValue = p.stock;
    const stockType = typeof stockValue;
    
    // CHECK 1: If stock is TEXT status (Good/Medium/Low/Urgent)
    if (stockType === 'string') {
      const stockText = stockValue.toString().toUpperCase().trim();
      
      // ❌ EXCLUDE Good and Medium
      if (stockText === 'GOOD' || stockText === 'MEDIUM') {
        return false;
      }
      
      // ✅ COUNT Low and Urgent
      if (stockText === 'LOW' || stockText === 'URGENT') {
        return true;
      }
      
      // Try parsing as number if it's a numeric string
      const parsedStock = parseFloat(stockValue);
      if (!isNaN(parsedStock)) {
        const minStock = Number(p.minStock) || 5;
        return parsedStock <= minStock && parsedStock >= 0;
      }
      
      return false;
    }
    
    // CHECK 2: If stock is NUMBER, compare with minStock
    if (stockType === 'number') {
      const stock = Number(stockValue);
      const minStock = Number(p.minStock) || 5;
      
      // Count if stock is 0 (out of stock) OR stock <= minStock
      return !isNaN(stock) && stock >= 0 && stock <= minStock;
    }
    
    // Unknown type - don't count
    return false;
  }).length;
  
  const lowStockEl = document.getElementById('lowStock');
  if (lowStockEl) {
    lowStockEl.textContent = lowStockCount;
  }
  
  // ✅ Products in Group (count ONLY variants)
  const variantProducts = cachedProducts.filter(p => p.isGroupVariant);
  const productsInGroupEl = document.getElementById('productsInGroup');
  if (productsInGroupEl) {
    productsInGroupEl.textContent = variantProducts.length;
  }
  
  // ✅ Inventory Summary - Total stock across ALL products
  const quantityInHandEl = document.getElementById('quantityInHand');
  if (quantityInHandEl) {
    const totalStock = cachedProducts.reduce((sum, p) => {
      const stockValue = p.stock;
      const stockType = typeof stockValue;
      
      // If numeric, add to total
      if (stockType === 'number') {
        const stock = Number(stockValue);
        return sum + (stock >= 0 ? stock : 0);
      }
      
      // If string that's a number, parse and add
      if (stockType === 'string') {
        const parsedStock = parseFloat(stockValue);
        if (!isNaN(parsedStock) && parsedStock >= 0) {
          return sum + parsedStock;
        }
      }
      
      // Text status (Good/Medium/Low/Urgent) - don't add to numeric total
      return sum;
    }, 0);
    quantityInHandEl.textContent = totalStock;
  }
  
  const quantityToBeReceivedEl = document.getElementById('quantityToBeReceived');
  if (quantityToBeReceivedEl) {
    quantityToBeReceivedEl.textContent = '0'; // TODO: Calculate from purchase orders
  }
  
  console.log('✅ Summary updated - In Stock:', inStockCount, 'Low Stock:', lowStockCount);
}




  /***********************
   * Utility: build product selects including custom in-sale items
   ***********************/
  function populateProductSelectForRow(rowIndex){
    const sel = document.getElementById(`product-${rowIndex}`);
    if(!sel) return;
    const current = sel.value;
    sel.innerHTML = `<option value="">-- Select Product --</option>`;
    // Add cachedProducts first
    (cachedProducts || []).forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.id;
      opt.dataset.size = p.size || '';
      opt.dataset.unit = p.unitType || '';
      opt.dataset.price = p.price;
      opt.dataset.stock = p.stock;
      opt.text = `${p.name} (Stock: ${p.stock} ${p.unitType})`;
      sel.appendChild(opt);
    });
    // Add custom in-sale products (those not in cachedProducts yet)
    (customProductsInSale || []).forEach(cp => {
      // If a matching id already exists in cachedProducts skip
      if((cachedProducts||[]).find(p => p.id === cp.tempId)) return;
      const opt = document.createElement('option');
      opt.value = cp.tempId;
      opt.dataset.size = cp.size || '';
      opt.dataset.unit = cp.unitType || '';
      opt.dataset.price = cp.price;
      opt.dataset.stock = cp.quantity; // treat its available stock as sale-qty (or 9999)
      opt.text = `${cp.name} (Custom)`;
      sel.appendChild(opt);
    });
    if(current) sel.value = current;
  }
/**
 * ==========================================
 * SAVE PRODUCT TO FIRESTORE - WITH TRANSLATION
 * ==========================================
 */
 async function saveProductToSheet(product, isUpdate = false) {
  const lang = window.currentLanguage || 'en';
  const translations = window.translations[lang];
  
  console.log('💾 saveProductToSheet called');
  console.log('   - Is update:', isUpdate);
  console.log('   - Product ID:', product.id);
  
  try {
    const user = window.auth?.currentUser;
    if (!user) {
      console.error('❌ No user signed in');
      return { success: false, error: translations.notAuthenticated || 'Not authenticated' };
    }
    
    const { doc, setDoc, collection, getDocs, query, where } = window.firebaseImports;
    const userId = user.uid;
    
    // ✅ CHECK FOR DUPLICATES BEFORE SAVING
    if (isUpdate) {
      console.log('🔍 Checking for duplicate products...');
      
      const productsRef = collection(window.db, 'tenants', userId, 'products');
      const snapshot = await getDocs(productsRef);
      
      let duplicateFound = false;
      snapshot.forEach(doc => {
        const data = doc.data();
        // Check if another document has same name but different ID
        if (data.name === product.name && doc.id !== product.id) {
          console.warn('⚠️ Found duplicate product with different ID:', doc.id);
          duplicateFound = true;
        }
      });
      
      if (duplicateFound) {
        console.error('❌ Duplicate product exists - aborting save');
        return { success: false, error: translations.duplicateProductFound || 'Duplicate product found' };
      }
    }
    
    // ✅ Create product reference with the product ID
    const productRef = doc(window.db, 'tenants', userId, 'products', product.id);
    
    // ✅ Prepare clean product data with proper defaults for optional fields
    const productData = {
      id: product.id,
      name: product.name,
      category: product.category || '', // ✅ Optional - empty string default
      brand: product.brand || '',
      size: product.size || '',
      unitType: product.unitType || 'Piece', // ✅ Optional - default to 'Piece'
      piecesPerBox: product.piecesPerBox || 1,
      sftPerBox: product.sftPerBox || 0,
      price: product.price || 0, // ✅ Optional - default to 0
      stock: product.stock,
      minStock: product.minStock || 5,
      imageUrl: product.imageUrl || '',
      stockStatus: product.stockStatus || 'exact',
      stockValue: product.stockValue !== null && product.stockValue !== undefined 
        ? product.stockValue 
        : null,
      updatedAt: new Date().toISOString(),
      isGroupVariant: product.isGroupVariant || false,
      groupId: product.groupId || '',
      variantId: product.variantId || ''
    };
    
    console.log('📤 Saving to Firestore:', productData);
    console.log('   - Category:', productData.category || '(empty)');
    console.log('   - Unit Type:', productData.unitType);
    console.log('   - Price:', productData.price);
    console.log('   - Stock:', productData.stock);
    
    // ✅ Use setDoc to create or update
    await setDoc(productRef, productData);
    
    console.log('✅ Product saved to Firestore successfully');
    console.log('   - Document ID:', product.id);
    console.log('   - Updated stock:', productData.stock);
    
    return { 
      success: true, 
      id: product.id 
    };
    
  } catch (error) {
    console.error('❌ Error saving product to Firestore:', error);
    return { 
      success: false, 
      error: error.message 
    };
  }
}




/**
 * ==========================================
 * SAVE SALE TO FIRESTORE - FINAL VERSION
 * ==========================================
 */
async function saveSaleToSheet(item) {
  const user = window.auth.currentUser;
  
  if (!user) {
    showAuthError('Please sign in to save sale');
    return null;
  }
  
  try {
    const { collection, addDoc, doc, updateDoc, getDoc } = window.firebaseImports;
    const userId = user.uid;
    
    // ✅ Save sale
    const salesRef = collection(window.db, 'tenants', userId, 'sales');
    const docRef = await addDoc(salesRef, {
      ...item,
      date: item.date || new Date().toISOString(), // Ensure date exists
      createdAt: new Date().toISOString(),
      userId: userId
    });
    
    console.log('✅ Sale saved:', docRef.id);
    
    // ✅ UPDATE PRODUCT STOCK (if product ID exists)
    if (item.productId) {
      try {
        const productRef = doc(window.db, 'tenants', userId, 'products', item.productId);
        const productSnap = await getDoc(productRef);
        
        if (productSnap.exists()) {
          const currentStock = productSnap.data().stock || 0;
          const newStock = currentStock - (item.quantity || 0);
          
          await updateDoc(productRef, {
            stock: Math.max(0, newStock) // Don't go negative
          });
          
          console.log(`✅ Stock updated: ${item.productId} (${currentStock} → ${newStock})`);
        } else {
          console.warn(`⚠️ Product ${item.productId} not found, skipping stock update`);
        }
      } catch (stockError) {
        console.warn('⚠️ Could not update stock:', stockError.message);
        // ✅ Don't fail the sale if stock update fails
      }
    }
    
    // ✅ AUTO-RELOAD SALES LIST (for homepage Recent Sales)
    setTimeout(() => {
      if (typeof loadRecentSales === 'function') {
        loadRecentSales();
      }
    }, 500);
    
    // ✅ ALSO UPDATE CACHED SALES (for main sales page)
    setTimeout(() => {
      if (typeof syncFromFirestore === 'function') {
        syncFromFirestore();
      }
    }, 1000);
    
    return { success: true, id: docRef.id };
    
  } catch (error) {
    console.error('❌ Error saving sale:', error);
    return { success: false, error: error.message };
  }
}

    
    // ==========================================
// HELPER: Delay function
// ==========================================
function delay(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

// ==========================================
// HELPER: Success Toast Notification
// ==========================================
// Show success toast notification
function showSuccessToast(message) {
  showToast(message, 'success');
}

// Show error toast notification
function showErrorToast(message) {
  showToast(message, 'error');
}

// Universal toast function
function showToast(message, type = 'success') {
  // Remove existing toasts
  const existingToasts = document.querySelectorAll('.toast-notification');
  existingToasts.forEach(toast => toast.remove());
  
  // Create toast element
  const toast = document.createElement('div');
  toast.className = 'toast-notification';
  toast.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 16px 24px;
    border-radius: 8px;
    color: white;
    font-weight: 600;
    font-size: 16px;
    z-index: 999999;
    animation: slideInRight 0.3s ease-out;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    max-width: 400px;
    ${type === 'success' ? 'background: #4caf50;' : 'background: #f44336;'}
  `;
  toast.textContent = message;
  
  // Add animation
  const style = document.createElement('style');
  style.textContent = `
    @keyframes slideInRight {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }
  `;
  
  if (!document.querySelector('#toast-animations')) {
    style.id = 'toast-animations';
    document.head.appendChild(style);
  }
  
  // Append to body
  document.body.appendChild(toast);
  
  // Auto remove after 4 seconds
  setTimeout(() => {
    toast.style.animation = 'slideOutRight 0.3s ease-in';
    setTimeout(() => toast.remove(), 300);
  }, 4000);
  
  // Click to dismiss
  toast.addEventListener('click', () => {
    toast.style.animation = 'slideOutRight 0.3s ease-in';
    setTimeout(() => toast.remove(), 300);
  });
}


// ==========================================
// HELPER: Update sync indicator
// ==========================================
function updateSyncIndicator(active) {
  const indicator = document.getElementById('backgroundSyncStatus');
  if (indicator) {
    indicator.style.display = active ? 'flex' : 'none';
  }
}





// ==========================================
// DELETE PRODUCT FROM FIRESTORE
// ==========================================

async function deleteProductFromSheet(id) {
  const user = window.auth.currentUser;
  
  if (!user) {
    showAuthError('Please sign in to delete product');
    return false;
  }
  
  try {
    const { collection, doc, deleteDoc } = window.firebaseImports;
    const userId = user.uid;
    
    const productDoc = doc(window.db, 'tenants', userId, 'products', id);
    await deleteDoc(productDoc);
    
    console.log('✅ Product deleted:', id);
    return true;
    
  } catch (error) {
    console.error('❌ Error deleting product:', error);
    return false;
  }
}

/**
 * Toggle Advanced Options in Product Modal
 */
function toggleAdvancedOptions() {
  const container = document.getElementById('advancedOptionsContainer');
  const icon = document.getElementById('advOptionsIcon');
  
  if (container.style.display === 'none') {
    container.style.display = 'block';
    icon.style.transform = 'rotate(180deg)';
    icon.style.transition = 'transform 0.3s ease';
    console.log('📂 Advanced options opened');
  } else {
    container.style.display = 'none';
    icon.style.transform = 'rotate(0deg)';
    icon.style.transition = 'transform 0.3s ease';
    console.log('📂 Advanced options closed');
  }
}
/**
 * ==========================================
 * BACKGROUND QUEUE PROCESSOR - FIXED (NO AUTO-SYNC)
 * ==========================================
 */
const backgroundSaveQueue = [];
let isProcessingQueue = false;
let backgroundSyncActive = false;

async function processBackgroundSaveQueue() {
  if (isProcessingQueue) {
    console.log('⏳ Queue processor already running');
    return;
  }
  
  if (backgroundSaveQueue.length === 0) {
    console.log('✅ Queue empty, processor stopping');
    backgroundSyncActive = false;
    updateSyncIndicator(false);
    return;
  }
  
  isProcessingQueue = true;
  backgroundSyncActive = true;
  updateSyncIndicator(true);
  
  console.log(`🔄 Processing ${backgroundSaveQueue.length} items in background queue...`);
  
  while (backgroundSaveQueue.length > 0) {
    const item = backgroundSaveQueue[0];
    
    console.log(`📤 Background saving: "${item.productName}" (${backgroundSaveQueue.length} remaining)`);
    
    let saved = false;
    for (let attempt = 1; attempt <= 3; attempt++) {
      try {
        const response = await saveSaleToSheet(item);
        
        if (response && response.success) {
          console.log(`✅ Background saved: "${item.productName}"`);
          saved = true;
          break;
        }
        
        if (attempt < 3) {
          console.log(`⚠️ Retry ${attempt}/3 for "${item.productName}" in ${attempt}s...`);
          await delay(1000 * attempt);
        }
        
      } catch (error) {
        console.error(`❌ Attempt ${attempt}/3 failed for "${item.productName}":`, error);
        
        if (attempt < 3) {
          await delay(1000 * attempt);
        }
      }
    }
    
    if (saved) {
      backgroundSaveQueue.shift();
    } else {
      console.error(`❌ PERMANENT FAILURE: Could not save "${item.productName}" after 3 attempts`);
      backgroundSaveQueue.shift();
      
      try {
        const failedItems = JSON.parse(localStorage.getItem('failedSales') || '[]');
        failedItems.push({
          item: item,
          timestamp: new Date().toISOString(),
          error: 'Max retries exceeded'
        });
        localStorage.setItem('failedSales', JSON.stringify(failedItems));
        console.log('💾 Failed item saved to localStorage for recovery');
      } catch (e) {
        console.error('Could not save to localStorage:', e);
      }
    }
    
    if (backgroundSaveQueue.length > 0) {
      await delay(500);
    }
  }
  
  isProcessingQueue = false;
  backgroundSyncActive = false;
  updateSyncIndicator(false);
  
  console.log('✅ Background queue processing complete!');
  
  // ✅ REMOVED AUTO-SYNC - DON'T SYNC AFTER EVERY QUEUE PROCESS
  // Only sync when user manually refreshes or on initial load
}

    
/**
 * Load products from Firestore (with custom order support)
 */
 async function loadProducts() {
  console.log('📦 Loading products from Firestore...');
  
  const user = window.auth.currentUser;
  
  if (!user) {
    console.error('❌ No user authenticated');
    alert('Please sign in first');
    showAuthScreen();
    return;
  }
  
  try {
    const { collection, getDocs } = window.firebaseImports;
    const userId = user.uid;
    
    const productsRef = collection(window.db, 'tenants', userId, 'products');
    const productsSnap = await getDocs(productsRef);
    
    cachedProducts = [];
    productsSnap.forEach((doc) => {
      const data = doc.data();
      cachedProducts.push({
        id: doc.id,
        ...data,
        stockStatus: data.stockStatus || 'medium',
        stockValue: data.stockValue || 0
      });
    });
    
    console.log('✅ Loaded', cachedProducts.length, 'products from Firestore');
    
    if (cachedProducts.length > 0) {
      console.log('📊 Sample product:', cachedProducts[0]);
    }
    
    // Cache locally
    try {
      localStorage.setItem('inventory_products_cache', JSON.stringify(cachedProducts));
      console.log('💾 Products cached to localStorage');
    } catch (e) {
      console.warn('⚠️ Cache save failed:', e);
    }
    
    // ✅ CRITICAL: Render with custom order
    renderProducts();
    
  } catch (err) {
    console.error('❌ Error loading products:', err);
    
    // Fallback to cache
    try {
      cachedProducts = JSON.parse(localStorage.getItem('inventory_products_cache') || '[]');
      console.log('📂 Loaded', cachedProducts.length, 'products from cache');
      renderProducts();
    } catch (e) {
      console.error('Failed to load from cache:', e);
      cachedProducts = [];
      renderProducts();
    }
  }
}
/***********************
 * Product CRUD UI - FIREBASE VERSION
 ***********************/
 let editingProductId = null;

 async function showAddProduct() { 
  editingProductId = null; 
  document.getElementById('modalTitle').textContent = 'Add New Product'; 
  document.getElementById('productForm').reset(); 
  document.getElementById('productId').value = ''; 
  
  // Clear variant flags
  const form = document.getElementById('productForm');
  form.dataset.isVariant = 'false';
  form.dataset.groupId = '';
  form.dataset.variantId = '';
  
  // ✅ Populate dropdowns from cache
  await populateCategoryDropdown();
  await populateUnitTypeDropdown(); // ✅ NEW
  
  // Reset photo preview
  if (document.getElementById('productPhotoPreviewContainer')) {
    document.getElementById('productPhotoPreviewContainer').style.display = 'none';
  }
  if (document.getElementById('productPhotoUploadArea')) {
    document.getElementById('productPhotoUploadArea').style.display = 'block';
  }
  
  // Clear photo data
  window.editingProductImageUrl = '';
  productPhotoBase64 = null;
  productPhotoFileName = null;
  
  // Make fields editable
  document.getElementById('productName').readOnly = false;
  document.getElementById('brand').readOnly = false;
  document.getElementById('size').readOnly = false;
  
  document.getElementById('productName').style.background = '';
  document.getElementById('brand').style.background = '';
  document.getElementById('size').style.background = '';
  
  new bootstrap.Modal(document.getElementById('productModal')).show();
  console.log('✅ Add Product modal opened');
}

async function editProduct(id, isVariant = false) {
  const lang = window.currentLanguage || 'en';
  const translations = window.translations[lang];
  
  console.log('✏️ Editing product ID:', id, 'Is variant:', isVariant);
  
  const p = (cachedProducts||[]).find(x => x.id === id);
  if (!p) { 
    alert(translations.productNotFound || '❌ Product not found'); 
    return; 
  }
  
  console.log('📦 Found product:', p);
  
  // CHECK IF THIS IS A VARIANT
  if (isVariant || p.isGroupVariant) {
    await openEditVariantModalFromProduct(p);
    return;
  }
  
  // Set editingProductId
  editingProductId = id;
  console.log('✅ Set editingProductId to:', editingProductId);
  
  document.getElementById('modalTitle').textContent = translations.editProduct || 'Edit Product';
  document.getElementById('productId').value = id;
  
  // ✅ Populate dropdowns BEFORE setting values
  await populateCategoryDropdown();
  await populateUnitTypeDropdown();
  
  // Fill form fields
  document.getElementById('productName').value = p.name || '';
  document.getElementById('category').value = p.category || '';
  document.getElementById('brand').value = p.brand || '';
  document.getElementById('size').value = p.size || '';
  document.getElementById('unitType').value = p.unitType || 'Box';
  document.getElementById('piecesPerBox').value = p.piecesPerBox || 1;
  document.getElementById('sftPerBox').value = p.sftPerBox || '';
  document.getElementById('price').value = p.price || '';
  document.getElementById('minStock').value = p.minStock || 5;
  
  window.editingProductImageUrl = p.imageUrl || '';
  
  // Make fields editable
  document.getElementById('productName').readOnly = false;
  document.getElementById('brand').readOnly = false;
  document.getElementById('size').readOnly = false;
  
  document.getElementById('productName').style.background = '';
  document.getElementById('brand').style.background = '';
  document.getElementById('size').style.background = '';
  
  // Stock handling
  resetStockSelection();
  document.getElementById('productCurrentStock').value = '';
  
  const stockValue = p.stock;
  const stockType = typeof stockValue;
  
  if (stockType === 'number' && !isNaN(stockValue) && stockValue >= 0) {
    document.getElementById('productCurrentStock').value = stockValue;
  } 
  else if (stockType === 'string' && stockValue) {
    const parsedNumber = parseFloat(stockValue);
    
    if (!isNaN(parsedNumber) && parsedNumber >= 0) {
      document.getElementById('productCurrentStock').value = parsedNumber;
    } else {
      const statusLower = stockValue.toString().toLowerCase().trim();
      
      if (['good', 'medium', 'low', 'urgent'].includes(statusLower)) {
        selectStockStatus(statusLower);
      }
    }
  }
  
  // Photo handling
  if (p.imageUrl) {
    document.getElementById('productPhotoPreviewImage').src = p.imageUrl;
    document.getElementById('productPhotoPreviewContainer').style.display = 'block';
    document.getElementById('productPhotoUploadArea').style.display = 'none';
  } else {
    document.getElementById('productPhotoPreviewContainer').style.display = 'none';
    document.getElementById('productPhotoUploadArea').style.display = 'block';
  }
  
  productPhotoBase64 = null;
  productPhotoFileName = null;
  
  new bootstrap.Modal(document.getElementById('productModal')).show();
  console.log('✅ Edit modal opened for product:', editingProductId);
}


/**
 * Open edit modal for variant
 */
async function openEditVariantModalFromProduct(variant) {
  console.log('📝 Opening variant edit modal:', variant);
  
  editingProductId = variant.id || variant.variantId;
  
  const form = document.getElementById('productForm');
  form.dataset.isVariant = 'true';
  form.dataset.groupId = variant.groupId || '';
  form.dataset.variantId = variant.variantId || variant.id;
  
  document.getElementById('modalTitle').textContent = 'Edit Variant';
  document.getElementById('productId').value = variant.variantId || variant.id;
  
  // ✅ Populate category dropdown BEFORE setting value
  await populateCategoryDropdown();
  
  document.getElementById('productName').value = variant.name || variant.variantName;
  document.getElementById('category').value = variant.category || '';
  document.getElementById('brand').value = variant.brand || '';
  document.getElementById('size').value = variant.size || '';
  document.getElementById('unitType').value = variant.unitType || 'Box';
  document.getElementById('price').value = variant.price || variant.sellingPrice || 0;
  document.getElementById('minStock').value = variant.minStock || 0;
  document.getElementById('piecesPerBox').value = variant.piecesPerBox || 1;
  document.getElementById('sftPerBox').value = variant.sftPerBox || '';
  
  document.getElementById('productCurrentStock').value = variant.stock || 0;
  
  // Make name/brand/size readonly for variants
  document.getElementById('productName').readOnly = true;
  document.getElementById('brand').readOnly = true;
  document.getElementById('size').readOnly = true;
  
  document.getElementById('productName').style.background = '#f0f0f0';
  document.getElementById('brand').style.background = '#f0f0f0';
  document.getElementById('size').style.background = '#f0f0f0';
  
  // Photo handling for variant
  if (variant.imageUrl) {
    document.getElementById('productPhotoPreviewImage').src = variant.imageUrl;
    document.getElementById('productPhotoPreviewContainer').style.display = 'block';
    document.getElementById('productPhotoUploadArea').style.display = 'none';
  } else {
    document.getElementById('productPhotoPreviewContainer').style.display = 'none';
    document.getElementById('productPhotoUploadArea').style.display = 'block';
  }
  
  window.editingProductImageUrl = variant.imageUrl || '';
  productPhotoBase64 = null;
  productPhotoFileName = null;
  
  new bootstrap.Modal(document.getElementById('productModal')).show();
  console.log('✅ Variant edit modal opened');
}


// ✅ Make functions global
window.showAddProduct = showAddProduct;
window.editProduct = editProduct;
window.openEditVariantModalFromProduct = openEditVariantModalFromProduct;

console.log('✅ Product CRUD UI functions loaded');

async function saveProduct() {
  const lang = window.currentLanguage || 'en';
  const translations = window.translations[lang];
  
  console.log('💾 saveProduct called. Editing ID:', editingProductId);
  
  // ✅ CHECK IF THIS IS A VARIANT EDIT
  const form = document.getElementById('productForm');
  const isVariant = form.dataset.isVariant === 'true';
  
  if (isVariant) {
    console.log('📝 Saving as variant');
    await saveVariantData();
    return;
  }
  
  // ✅ GET FORM VALUES
  const name = document.getElementById('productName').value.trim();
  const category = document.getElementById('category').value || ''; // ✅ Optional
  const brand = document.getElementById('brand').value.trim() || '';
  const size = document.getElementById('size').value.trim() || '';
  const unitType = document.getElementById('unitType').value || 'Piece'; // ✅ Optional with default
  const piecesPerBox = parseInt(document.getElementById('piecesPerBox').value) || 1;
  const sftPerBox = parseFloat(document.getElementById('sftPerBox').value) || 0;
  const priceInput = document.getElementById('price').value.trim();
  const price = priceInput ? parseFloat(priceInput) : 0; // ✅ Optional with default 0
  
  // ✅ GET STOCK DATA (validates stock status OR quantity)
  const stockData = getStockData();
  if (!stockData) {
    alert(translations.stockOrStatusRequired || '⚠️ Please provide either stock quantity or select a stock status!');
    return;
  }
  
  const minStock = parseInt(document.getElementById('minStock').value) || 5;
  
  console.log('🔍 Form data:', { name, category, brand, unitType, price, stockData, editingProductId });
  
  // ✅ VALIDATION: Only product name is mandatory now
  if (!name) {
    console.error('❌ Validation failed: Product name missing');
    alert(translations.productNameRequired || '⚠️ Product name is required!');
    document.getElementById('productName').focus();
    return;
  }
  
  // ✅ DETERMINE IF EDITING OR CREATING NEW
  const isEditing = !!editingProductId;
  let productId;
  
  if (isEditing) {
    // ✅ EDITING: Use existing ID
    productId = editingProductId;
    console.log('✏️ Editing existing product:', productId);
  } else {
    // ✅ NEW: Generate new ID
    productId = Date.now().toString(36) + Math.random().toString(36).substr(2);
    console.log('➕ Creating new product:', productId);
  }
  
  // ✅ CREATE PRODUCT OBJECT
  const product = {
    id: productId,
    name: name,
    category: category,
    brand: brand,
    size: size,
    unitType: unitType,
    piecesPerBox: piecesPerBox,
    sftPerBox: sftPerBox,
    price: price,
    stock: stockData.stockStatus === 'exact' 
      ? stockData.stockValue 
      : stockData.stockStatus.toUpperCase(),
    minStock: minStock,
    imageUrl: window.editingProductImageUrl || '',
    stockStatus: stockData.stockStatus,
    stockValue: stockData.stockValue || null,
    updatedAt: new Date().toISOString()
  };
  
  console.log('📦 Product object:', product);
  
  // ✅ UPDATE LOCAL CACHE FIRST
  const idx = cachedProducts.findIndex(p => p.id === productId);
  const previous = idx !== -1 ? Object.assign({}, cachedProducts[idx]) : null;
  
  if (idx !== -1) {
    // ✅ EDITING: Update existing product
    console.log('🔄 Updating existing product in cache at index:', idx);
    cachedProducts[idx] = product;
  } else {
    // ✅ NEW: Add new product
    console.log('➕ Adding new product to cache');
    cachedProducts.push(product);
  }
  
  // ✅ CLOSE MODAL EARLY
  const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
  if (modal) modal.hide();
  
  // ✅ RENDER IMMEDIATELY WITH LOCAL DATA
  renderProducts();
  
  // ✅ Refresh brand cache (if function exists)
  if (typeof refreshBrandAutocompleteCache === 'function') {
    refreshBrandAutocompleteCache();
  }
  
  showSyncIndicator(translations.savingProduct || 'Saving product...');
  
  // ✅ UPLOAD PHOTO FIRST (if available)
  if (productPhotoBase64) {
    console.log('📷 Uploading product photo...');
    
    if (typeof uploadProductPhotoToFirebase === 'function') {
      const photoUrl = await uploadProductPhotoToFirebase(productId, productPhotoBase64);
      
      if (photoUrl) {
        product.imageUrl = photoUrl;
        const localIdx = cachedProducts.findIndex(p => p.id === productId);
        if (localIdx !== -1) {
          cachedProducts[localIdx].imageUrl = photoUrl;
          renderProducts();
        }
      }
    }
  }
  
  // ✅ SAVE PRODUCT TO FIRESTORE
  try {
    console.log('💾 Saving to Firestore. Is editing:', isEditing, 'ID:', productId);
    const resp = await saveProductToSheet(product, isEditing);
    console.log('📥 saveProductToSheet response:', resp);
    
    if (resp && resp.success) {
      console.log('✅ Product saved successfully to Firestore');
      console.log('   - Product ID:', productId);
      console.log('   - Stock value:', product.stock);
      
      // ✅ CRITICAL: Force update cache with final saved data
      const cacheIdx = cachedProducts.findIndex(p => p.id === productId);
      if (cacheIdx !== -1) {
        // Create a clean copy with all data
        cachedProducts[cacheIdx] = {
          ...product,
          id: productId // Ensure ID is preserved
        };
        console.log('✅ Updated product in cache at index:', cacheIdx);
        console.log('   - Cached stock:', cachedProducts[cacheIdx].stock);
      }
      
      // ✅ SAVE TO LOCALSTORAGE IMMEDIATELY
      try {
        localStorage.setItem('inventory_products_cache', JSON.stringify(cachedProducts));
        console.log('💾 Cache saved to localStorage with', cachedProducts.length, 'products');
      } catch (cacheError) {
        console.warn('⚠️ Failed to save cache:', cacheError);
      }
      
      // ✅ Force UI update with cached data
      renderProducts();
      
      showSyncIndicator(translations.saved || 'Saved', 900);
      
      if (typeof resetStockSelection === 'function') {
        resetStockSelection();
      }
      
    } else {
      console.error('⚠️ Save failed:', resp);
      
      // ✅ REVERT TO PREVIOUS STATE
      if (previous && idx !== -1) {
        cachedProducts[idx] = previous;
      } else if (!previous && idx !== -1) {
        cachedProducts.splice(idx, 1);
      }
      
      renderProducts();
      
      try {
        localStorage.setItem('inventory_products_cache', JSON.stringify(cachedProducts));
      } catch (error) {
        console.warn('⚠️ Cache revert failed:', error);
      }
      
      alert(translations.saveFailedReverted || 'Save failed - reverted locally.');
      showSyncIndicator(translations.saveFailed || 'Save failed', 2000);
    }
  } catch (err) {
    console.error('❌ Error in saveProduct:', err);
    console.error('   - Error message:', err.message);
    console.error('   - Error stack:', err.stack);
    
    // ✅ REVERT TO PREVIOUS STATE
    if (previous && idx !== -1) {
      cachedProducts[idx] = previous;
      console.log('↩️ Reverted to previous product state');
    } else if (!isEditing) {
      // Only remove if it was a new product
      const removeIdx = cachedProducts.findIndex(p => p.id === productId);
      if (removeIdx !== -1) {
        cachedProducts.splice(removeIdx, 1);
        console.log('🗑️ Removed unsaved product from cache');
      }
    }
    
    renderProducts();
    
    try {
      localStorage.setItem('inventory_products_cache', JSON.stringify(cachedProducts));
    } catch (error) {
      console.warn('⚠️ Cache revert failed:', error);
    }
    
    alert(translations.saveFailedCheckConsole || 'Save failed - reverted locally. Check console for details.');
    showSyncIndicator(translations.saveFailed || 'Save failed', 2000);
  }
  
  // ✅ CLEAR TEMPORARY VARIABLES
  editingProductId = null;
  window.editingProductImageUrl = '';
  productPhotoBase64 = null;
  productPhotoFileName = null;
  
  console.log('✅ saveProduct completed');
}


// ✅ Save Variant Data - WITH TRANSLATION
async function saveVariantData() {
  const lang = window.currentLanguage || 'en';
  const translations = window.translations[lang];
  
  console.log('💾 Saving variant to Firestore...');
  
  const submitBtn = document.querySelector('#productModal .btn-primary');
  const originalText = submitBtn ? submitBtn.innerHTML : translations.saveProduct || 'Save Product';
  
  if (submitBtn) {
    submitBtn.disabled = true;
    submitBtn.innerHTML = '⏳ ' + (translations.saving || 'Saving...');
  }
  
  try {
    const user = window.auth.currentUser;
    
    if (!user) {
      throw new Error(translations.userNotAuthenticated || 'User not authenticated');
    }
    
    const form = document.getElementById('productForm');
    
    // Get variant ID
    let variantId = document.getElementById('productId')?.value;
    if (!variantId || variantId === '') {
      variantId = form.dataset.variantId;
    }
    
    const groupId = form.dataset.groupId;
    
    console.log('🔍 Debug info:', {
      variantId: variantId,
      groupId: groupId
    });
    
    // Validation
    if (!variantId || variantId === '' || variantId === 'undefined') {
      throw new Error(translations.variantIdMissing || 'Variant ID is missing. Please close and reopen the edit form.');
    }
    
    if (!groupId || groupId === '' || groupId === 'undefined') {
      throw new Error(translations.groupIdMissing || 'Group ID is missing. Please close and reopen the edit form.');
    }
    
    // Get field values
    const getFieldValue = (id, defaultValue = 0) => {
      const field = document.getElementById(id);
      return field ? (field.value || defaultValue) : defaultValue;
    };
    
    const sellingPrice = parseFloat(getFieldValue('price', 0));
    const stock = parseInt(getFieldValue('productCurrentStock', 0));
    const minStock = parseInt(getFieldValue('minStock', 0));
    const unitType = getFieldValue('unitType', 'Piece');
    
    if (isNaN(sellingPrice) || sellingPrice < 0) {
      throw new Error(translations.invalidSellingPrice || 'Invalid selling price');
    }
    
    if (isNaN(stock) || stock < 0) {
      throw new Error(translations.invalidStockValue || 'Invalid stock value');
    }
    
    // ✅ PREPARE UPDATE DATA FOR FIRESTORE
    const updateData = {
      sellingPrice: sellingPrice,
      stock: stock,
      minStock: minStock,
      unitType: unitType,
      updatedAt: new Date().toISOString()
    };
    
    console.log('📤 Updating variant in Firestore:', updateData);
    
    const { collection, doc, updateDoc } = window.firebaseImports;
    const userId = user.uid;
    
    // Update variant in Firestore
    const variantRef = doc(window.db, 'tenants', userId, 'variants', variantId);
    await updateDoc(variantRef, updateData);
    
    console.log('✅ Variant updated successfully');
    
    // Update local cache
    if (typeof cachedGroupVariants !== 'undefined') {
      const variantIndex = cachedGroupVariants.findIndex(v => v.variantId === variantId);
      if (variantIndex !== -1) {
        cachedGroupVariants[variantIndex] = {
          ...cachedGroupVariants[variantIndex],
          ...updateData
        };
      }
    }
    
    // Show success message
    const successMsg = translations.variantUpdatedSuccess || '✅ Variant updated successfully!';
    if (typeof showSuccessToast === 'function') {
      showSuccessToast(successMsg);
    } else {
      alert(successMsg);
    }
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
    if (modal) modal.hide();
    
    // Clear flags
    form.dataset.isVariant = 'false';
    form.dataset.groupId = '';
    form.dataset.variantId = '';
    
    // Reset readonly fields
    const resetField = (id) => {
      const field = document.getElementById(id);
      if (field) {
        field.readOnly = false;
        field.style.background = '';
        field.style.color = '';
      }
    };
    
    resetField('productName');
    resetField('brand');
    resetField('size');
    
    // Refresh variants list
    setTimeout(() => {
      if (typeof loadGroupVariants === 'function') {
        loadGroupVariants(groupId);
      }
    }, 500);
    
  } catch (error) {
    console.error('❌ Error updating variant:', error);
    const errorMsg = translations.errorPrefix || 'Error';
    alert(`${errorMsg}: ${error.message}\n\n${translations.checkConsole || 'Please check the console for details.'}`);
  } finally {
    if (submitBtn) {
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalText;
    }
  }
}

function deleteProduct(id) {
  const lang = window.currentLanguage || 'en';
  const translations = window.translations[lang];
  
  const confirmMsg = translations.confirmDeleteProduct || 'Are you sure you want to delete this product?';
  if (!confirm(confirmMsg)) {
    return;
  }
  
  const prev = cachedProducts.slice();
  cachedProducts = cachedProducts.filter(p => p.id !== id);
  renderProducts();
  
  // Also update photo grid if currently viewing it
  if (document.getElementById('btnPhotoView')?.classList.contains('active')) {
    if (typeof showPhotoProducts === 'function') {
      showPhotoProducts();
    }
  }
  
  showSyncIndicator(translations.deleting || 'Deleting...');
  
  deleteProductFromSheet(id).then(success => {
    if (success) {
      console.log('✅ Product deleted successfully');
      showSyncIndicator(translations.deleted || 'Deleted', 900);
      
      // Update cache
      try {
        localStorage.setItem('inventory_products_cache', JSON.stringify(cachedProducts));
      } catch (e) {
        console.warn('Cache update failed:', e);
      }
    } else {
      console.error('❌ Delete failed, reverting...');
      cachedProducts = prev;
      renderProducts();
      
      if (document.getElementById('btnPhotoView')?.classList.contains('active')) {
        if (typeof showPhotoProducts === 'function') {
          showPhotoProducts();
        }
      }
      
      alert(translations.deleteFailedReverted || 'Delete failed - reverted locally.');
      showSyncIndicator(translations.deleteFailed || 'Delete failed', 2000);
    }
  }).catch(err => {
    console.error('❌ Delete error:', err);
    cachedProducts = prev;
    renderProducts();
    alert(translations.deleteFailedReverted || 'Delete failed - reverted locally.');
    showSyncIndicator(translations.deleteFailed || 'Delete failed', 2000);
  });
}



    

/**
 * ==========================================
 * PRODUCT PHOTO UPLOAD FUNCTIONS
 * ==========================================
 */

/**
 * Handle product photo selection
 */
function handleProductPhotoSelect(event) {
  const file = event.target.files[0];
  if (!file || !file.type.startsWith('image/')) {
    alert('Please select a valid image file');
    return;
  }
  
  productPhotoFileName = `product_${Date.now()}.jpg`;
  
  const reader = new FileReader();
  reader.onload = (e) => {
    const img = new Image();
    img.onload = () => {
      // Compress image
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      
      const maxWidth = 1920;
      const maxHeight = 1080;
      let width = img.width;
      let height = img.height;
      
      if (width > height) {
        if (width > maxWidth) {
          height = (maxWidth / width) * height;
          width = maxWidth;
        }
      } else {
        if (height > maxHeight) {
          width = (maxHeight / height) * width;
          height = maxHeight;
        }
      }
      
      canvas.width = width;
      canvas.height = height;
      ctx.drawImage(img, 0, 0, width, height);
      
      productPhotoBase64 = canvas.toDataURL('image/jpeg', 0.7);
      
      // Show preview
      document.getElementById('productPhotoPreviewImage').src = productPhotoBase64;
      document.getElementById('productPhotoPreviewContainer').style.display = 'block';
      
      console.log('✅ Product photo selected and compressed');
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

/**
 * Clear product photo selection
 */
function clearProductPhotoSelection() {
  document.getElementById('productPhotoFileInput').value = '';
  document.getElementById('productPhotoPreviewContainer').style.display = 'none';
  productPhotoBase64 = null;
  productPhotoFileName = null;
}

/**
 * Remove product photo
 */
function removeProductPhoto() {
  clearProductPhotoSelection();
  window.editingProductImageUrl = '';
}

/**
 * Upload product photo to Firebase Storage
 */
async function uploadProductPhotoToFirebase(productId, photoBase64) {
  try {
    if (!photoBase64) {
      console.log('⚠️ No photo to upload');
      return null;
    }
    
    console.log('📤 Uploading product photo to Firebase Storage...');
    
    // Note: Firebase Storage requires additional import
    // For now, we'll store base64 in Firestore (quick solution)
    // Later, you can upgrade to Firebase Storage for better performance
    
    // Option 1: Store base64 directly in product document (simple but not recommended for production)
    const user = window.auth.currentUser;
    if (!user) {
      console.error('User not authenticated');
      return null;
    }
    
    // For production, you should use Firebase Storage instead
    // This is a temporary solution
    console.log('✅ Photo prepared for Firestore (base64)');
    return photoBase64; // Return base64 to store in product document
    
    // TODO: Implement Firebase Storage upload for production
    // const storage = getStorage();
    // const storageRef = ref(storage, `products/${user.uid}/${productId}.jpg`);
    // const uploadTask = await uploadString(storageRef, photoBase64, 'data_url');
    // const downloadURL = await getDownloadURL(uploadTask.ref);
    // return downloadURL;
    
  } catch (error) {
    console.error('❌ Photo upload error:', error);
    return null;
  }
}

// Keep backward compatibility
async function uploadProductPhotoToBackend(productId, photoBase64) {
  return await uploadProductPhotoToFirebase(productId, photoBase64);
}

/**
 * ==========================================
 * RECORD PURCHASE - FIREBASE VERSION
 * ==========================================
 */

// Global variables - NO CHANGES NEEDED
let purchasePhotoBase64 = null;
let purchaseProductRowCounter = 0;

/**
 * Initialize purchases on page load
 * ✅ Pre-loads unit types cache
 */
 document.addEventListener('DOMContentLoaded', function() {
  console.log('🔄 Initializing purchases module...');
  
  // Auto-load purchases and unit types when user is authenticated
  const checkAndLoad = setInterval(() => {
    if (window.auth && window.auth.currentUser) {
      clearInterval(checkAndLoad);
      console.log('👤 User authenticated, loading purchases...');
      
      // ✅ PRE-LOAD UNIT TYPES CACHE
      loadUnitTypesCache().then(() => {
        console.log('✅ Unit types cache ready for purchase modal');
      });
      
      // Check if we're on purchases page
      const purchasesPage = document.getElementById('purchasesPage');
      if (purchasesPage && purchasesPage.style.display !== 'none') {
        loadRecentPurchases();
      }
    }
  }, 500);
  
  // Stop checking after 10 seconds
  setTimeout(() => clearInterval(checkAndLoad), 10000);
});

/**
 * Submit purchase entry to Firestore
 * ✅ UPDATED: Products are now optional
 * ✅ Confirms with user before submitting without products
 */
 async function submitPurchaseEntry() {
  console.log('📤 submitPurchaseEntry called');
  
  // ✅ Exit autofill mode silently before submission
  if (window.autofillMode && window.autofillMode.active) {
    exitAutofillModeSilently();
  }
  
  const user = window.auth.currentUser;
  if (!user) {
    alert('Please sign in first');
    return;
  }
  
  try {
    // Get form values
    const vendorName = document.getElementById('purchaseVendorName')?.value?.trim();
    const totalAmount = parseFloat(document.getElementById('purchaseTotalAmount')?.value || 0);
    const otherInfo = document.getElementById('purchaseOtherInfo')?.value?.trim() || '';
    
    if (!vendorName) {
      alert('❌ Please enter vendor name');
      return;
    }
    
    // Get products
    const productRows = document.querySelectorAll('.purchase-product-row');
    
    const products = [];
    for (const row of productRows) {
      const name = row.querySelector('[data-field="name"]')?.value?.trim();
      const qty = parseFloat(row.querySelector('[data-field="qty"]')?.value || 0);
      const rate = parseFloat(row.querySelector('[data-field="rate"]')?.value || 0);
      const unit = row.querySelector('[data-field="unit"]')?.value || 'Box';
      const amount = qty * rate;
      
      // Only add products with names
      if (name) {
        products.push({
          name: name,
          qty: qty || 0,
          rate: rate || 0,
          unit: unit,
          amount: amount.toFixed(2)
        });
      }
    }
    
    // ✅ NEW: Confirm if submitting without products
    if (products.length === 0) {
      const shouldSubmit = confirm(
        '⚠️ No products added!\n\n' +
        'Do you want to submit this purchase entry without any products?\n\n' +
        'Vendor: ' + vendorName + '\n' +
        (totalAmount > 0 ? 'Amount: ₹' + totalAmount : 'Amount: Not specified')
      );
      
      if (!shouldSubmit) {
        console.log('❌ User cancelled submission without products');
        return;
      }
      
      console.log('✅ User confirmed submission without products');
    }
    
    // Get payment modes
    const paymentModes = {};
    const cashCheckbox = document.getElementById('purchasePaymentCash');
    const onlineCheckbox = document.getElementById('purchasePaymentOnline');
    const creditCheckbox = document.getElementById('purchasePaymentCredit');
    
    if (cashCheckbox?.checked) {
      paymentModes.cash = parseFloat(document.getElementById('purchasePaymentCashAmount')?.value || 0);
    }
    if (onlineCheckbox?.checked) {
      paymentModes.online = parseFloat(document.getElementById('purchasePaymentOnlineAmount')?.value || 0);
    }
    if (creditCheckbox?.checked) {
      paymentModes.credit = parseFloat(document.getElementById('purchasePaymentCreditAmount')?.value || 0);
    }
    
    // Build purchase data
    const purchaseData = {
      vendorName: vendorName,
      products: products,
      totalAmount: totalAmount,
      paymentModes: paymentModes,
      otherInfo: otherInfo,
      photoBase64: window.purchasePhotoBase64 || '',
      date: new Date().toISOString(),
      userId: user.uid,
      userEmail: user.email
    };
    
    console.log('📦 Submitting purchase to Firestore:', purchaseData);
    
    // Disable submit button
    const submitBtn = document.querySelector('#recordPurchaseModal button[onclick*="submitPurchaseEntry"]') || 
                      document.getElementById('submitPurchaseBtn');
    const originalBtnHTML = submitBtn?.innerHTML || 'Submit';
    
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Submitting...';
    }
    
    // Save to Firestore
    const { collection, addDoc } = window.firebaseImports;
    const purchasesRef = collection(window.db, 'tenants', user.uid, 'purchases');
    
    const docRef = await addDoc(purchasesRef, purchaseData);
    
    console.log('✅ Purchase saved to Firestore:', docRef.id);
    
    // ✅ UPDATED: Success message handles zero products
    let successMessage = '✅ Purchase recorded successfully!\n\nVendor: ' + vendorName;
    
    if (products.length > 0) {
      const productWord = products.length === 1 ? 'product' : 'products';
      successMessage += '\n' + products.length + ' ' + productWord + ' added';
    } else {
      successMessage += '\nNo products added';
    }
    
    if (totalAmount > 0) {
      successMessage += '\nTotal: ₹' + totalAmount;
    }
    
    alert(successMessage);
    
    // Close modal
    const modal = document.getElementById('recordPurchaseModal');
    if (modal) {
      const bsModal = bootstrap.Modal.getInstance(modal);
      if (bsModal) bsModal.hide();
    }
    
    // Reset form
    document.getElementById('purchaseVendorName').value = '';
    document.getElementById('purchaseTotalAmount').value = '';
    document.getElementById('purchaseOtherInfo').value = '';
    document.querySelectorAll('.purchase-product-row').forEach(row => row.remove());
    window.purchasePhotoBase64 = '';
    
    // Clear photo preview
    const photoImg = document.getElementById('purchasePhotoImg');
    const photoPreview = document.getElementById('purchasePhotoPreview');
    if (photoImg) photoImg.style.display = 'none';
    if (photoPreview) {
      const placeholder = photoPreview.querySelector('p');
      const icon = photoPreview.querySelector('i');
      if (placeholder) placeholder.style.display = 'block';
      if (icon) icon.style.display = 'block';
    }
    
    // Reload purchases list
    setTimeout(async () => {
      console.log('🔄 Reloading purchases list...');
      if (typeof loadRecentPurchases === 'function') {
        await loadRecentPurchases();
      }
    }, 500);
    
  } catch (error) {
    console.error('❌ Submit error:', error);
    alert('❌ Failed to record purchase:\n' + error.message);
  } finally {
    const submitBtn = document.querySelector('#recordPurchaseModal button[onclick*="submitPurchaseEntry"]') || 
                      document.getElementById('submitPurchaseBtn');
    if (submitBtn) {
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i class="bi bi-check-circle"></i> Submit';
    }
  }
}

/**
 * Open Record Purchase Modal (SAFE VERSION)
 * ✅ Loads unit types from cache before opening
 * ✅ Resets quick items list
 * ✅ NO INITIAL ROW - User adds rows manually
 */
 async function openRecordPurchaseModal() {
  console.log('📦 Opening Record Purchase Modal');
  
  try {
    // ✅ LOAD UNIT TYPES IF NOT ALREADY LOADED
    if ((!window.unitTypesCache || window.unitTypesCache.length === 0) && !window.unitTypeCacheLoaded) {
      console.log('📥 Loading unit types for purchase modal...');
      await loadUnitTypesCache();
    }
    
    // Reset form fields
    const vendorNameInput = document.getElementById('purchaseVendorName');
    const totalAmountInput = document.getElementById('purchaseTotalAmount');
    const otherInfoInput = document.getElementById('purchaseOtherInfo');
    const productRowsContainer = document.getElementById('purchaseProductRows');
    
    if (vendorNameInput) vendorNameInput.value = '';
    if (totalAmountInput) totalAmountInput.value = '';
    if (otherInfoInput) otherInfoInput.value = '';
    if (productRowsContainer) productRowsContainer.innerHTML = '';
    
    // Reset payment modes
    const cashCheckbox = document.getElementById('purchasePaymentCash');
    const onlineCheckbox = document.getElementById('purchasePaymentOnline');
    const creditCheckbox = document.getElementById('purchasePaymentCredit');
    
    if (cashCheckbox) cashCheckbox.checked = false;
    if (onlineCheckbox) onlineCheckbox.checked = false;
    if (creditCheckbox) creditCheckbox.checked = false;
    
    const cashAmount = document.getElementById('purchasePaymentCashAmount');
    const onlineAmount = document.getElementById('purchasePaymentOnlineAmount');
    const creditAmount = document.getElementById('purchasePaymentCreditAmount');
    
    if (cashAmount) cashAmount.value = '';
    if (onlineAmount) onlineAmount.value = '';
    if (creditAmount) creditAmount.value = '';
    
    // Clear photo (safe)
    clearPurchasePhoto();
    
    // Reset counters
    window.purchaseProductRowCounter = 0;
    
    // ✅ RESET QUICK ITEMS
    resetQuickItems();
    
    // ✅ REMOVED: Don't add initial product row
    // User will add rows manually using "Row" button
    
    console.log('✅ Purchase modal ready with', window.unitTypesCache?.length || 0, 'unit types');
    
    // Show modal
    const modal = document.getElementById('recordPurchaseModal');
    if (modal) {
      const bsModal = new bootstrap.Modal(modal);
      bsModal.show();
    } else {
      console.error('❌ Modal element not found: recordPurchaseModal');
      alert('❌ Error: Modal not found. Please refresh the page.');
    }
    
  } catch (error) {
    console.error('❌ Error opening modal:', error);
    alert('❌ Failed to open modal: ' + error.message);
  }
}
/**
 * Close Record Purchase Modal
 * ✅ Clean up autofill mode SILENTLY
 */
 function closeRecordPurchaseModal() {
  console.log('🚪 Closing Record Purchase Modal');
  
  // ✅ Exit autofill mode SILENTLY if active
  if (window.autofillMode && window.autofillMode.active) {
    console.log('🔄 Auto-exiting autofill mode on modal close');
    exitAutofillModeSilently();
  }
  
  const modal = bootstrap.Modal.getInstance(document.getElementById('recordPurchaseModal'));
  if (modal) {
    modal.hide();
  }
}
/**
 * Add product row (FIXED: Dynamic Unit Types from Cache)
 * ✅ Uses unit types from unitTypesCache
 * ✅ Mobile-friendly keyboard attributes
 * ✅ Wrapped qty/rate fields for inline buttons
 * ✅ Enter key navigation support
 */
 function addPurchaseProductRow(product = null) {
  purchaseProductRowCounter++;
  const rowId = `purchaseRow${purchaseProductRowCounter}`;
  const container = document.getElementById('purchaseProductRows');

  const productName = product ? (product.size ? `${product.name} (${product.size})` : product.name) : '';
  const qty = product ? product.qty : '';
  const rate = product ? product.price : '';
  const unit = product ? product.unitType : 'Box';
  const amount = product ? (product.qty * product.price).toFixed(2) : '0.00';

  const rowDiv = document.createElement('div');
  rowDiv.id = rowId;
  rowDiv.className = 'purchase-product-row';

  // ✅ BUILD UNIT TYPE OPTIONS FROM CACHE
  const unitOptions = generateUnitTypeOptions(unit);

  rowDiv.innerHTML = `
  <input type="text" class="form-control" placeholder="Product name"
         value="${escapeHtml(productName)}" data-field="name">
  
  <!-- ✅ QTY FIELD - REMOVED inputmode="decimal" -->
  <div class="input-field-wrapper" style="position: relative;">
    <input type="number" 
           class="form-control" 
           placeholder="Qty" 
           min="1"
           value="${qty}" 
           oninput="calculatePurchaseRowAmount('${rowId}')" 
           data-field="qty"
           autocomplete="off"
           style="padding-right: 42px;">
    <div class="inline-buttons-container" style="display: none;"></div>
  </div>
  
  <!-- ✅ RATE FIELD - REMOVED inputmode="decimal" -->
  <div class="input-field-wrapper" style="position: relative;">
    <input type="number" 
           class="form-control" 
           placeholder="Rate" 
           min="0" 
           step="0.01"
           value="${rate}" 
           oninput="calculatePurchaseRowAmount('${rowId}')" 
           data-field="rate"
           autocomplete="off"
           style="padding-right: 42px;">
    <div class="inline-buttons-container" style="display: none;"></div>
  </div>
  
  <select class="form-select" data-field="unit">
    ${unitOptions}
  </select>
  <input type="number" class="form-control" placeholder="Amount" readonly
         value="${amount}" data-field="amount"
         style="background: #e8f5e9; font-weight: 600; color: #2e7d32;">
  <button type="button" class="btn btn-danger purchase-remove-btn"
      onclick="removePurchaseProductRow('${rowId}')"
      style="font-size:22px;padding:0;min-width:36px;height:36px;">
    ×
  </button>
`;


  container.appendChild(rowDiv);
  
  // ✅ ADD ENTER KEY LISTENER TO QTY AND RATE FIELDS
  const qtyField = rowDiv.querySelector('[data-field="qty"]');
  const rateField = rowDiv.querySelector('[data-field="rate"]');
  
  [qtyField, rateField].forEach(field => {
    if (!field) return;
    
    // ✅ KEYBOARD ENTER KEY EVENT
    field.addEventListener('keydown', function(e) {
      if (e.key === 'Enter' || e.keyCode === 13) {
        e.preventDefault(); // Prevent form submission
        console.log('⌨️ Enter key pressed on field');
        
        // Update current field if autofill mode is active
        if (window.autofillMode && window.autofillMode.active) {
          window.autofillMode.currentField = this;
        }
        
        // Trigger enter action (same as clicking button)
        autofillEnter(this);
      }
    });
    
    // ✅ UPDATE CURRENT FIELD ON FOCUS (for autofill mode)
    field.addEventListener('focus', function(e) {
      if (window.autofillMode && window.autofillMode.active) {
        window.autofillMode.currentField = this;
        console.log('🎯 Field focused:', this.placeholder);
      }
    }, { passive: true });
  });
  
  // ✅ If autofill mode is active, add handlers to new row
  if (window.autofillMode && window.autofillMode.active) {
    setTimeout(() => {
      addAutofillButtons();
    }, 50);
  }
  
  console.log('✅ Added purchase product row with Enter key support');
}

/**
 * Toggle payment section
 */
function togglePaymentSection() {
  const section = document.getElementById('paymentSection');
  section.classList.toggle('show');
}

/**
 * Trigger photo input (for click or paste)
 */
function triggerPhotoInput() {
  document.getElementById('purchasePhotoInput').click();
}

/**
 * Handle paste event for photo
 */
document.addEventListener('DOMContentLoaded', function() {
  const photoPreview = document.getElementById('purchasePhotoPreview');
  
  if (photoPreview) {
    // Handle paste event
    photoPreview.addEventListener('paste', function(e) {
      const items = e.clipboardData.items;
      for (let i = 0; i < items.length; i++) {
        if (items[i].type.indexOf('image') !== -1) {
          const blob = items[i].getAsFile();
          const reader = new FileReader();
          reader.onload = function(event) {
            purchasePhotoBase64 = event.target.result;
            document.getElementById('purchasePhotoImg').src = event.target.result;
            document.getElementById('purchasePhotoImg').style.display = 'block';
            photoPreview.querySelector('p').style.display = 'none';
            photoPreview.querySelector('i').style.display = 'none';
            document.getElementById('clearPurchasePhotoBtn').style.display = 'inline-block';
            console.log('✅ Photo pasted');
          };
          reader.readAsDataURL(blob);
        }
      }
    });
  }
});





/**
 * Load recent purchases from Firestore
 */
async function loadRecentPurchases() {
  console.log('📦 Loading recent purchases from Firestore...');
  
  const user = window.auth.currentUser;
  if (!user) {
    console.error('User not authenticated');
    return;
  }
  
  const tbody = document.getElementById('purchasesList');
  tbody.innerHTML = `
    <tr>
      <td colspan="8" style="text-align: center; padding: 20px; color: #999;">
        <span class="spinner-border spinner-border-sm"></span> Loading purchases...
      </td>
    </tr>
  `;
  
  try {
    const { collection, getDocs, query, orderBy } = window.firebaseImports;
    
    const purchasesRef = collection(window.db, 'tenants', user.uid, 'purchases');
    const q = query(purchasesRef, orderBy('date', 'desc'));
    const snapshot = await getDocs(q);
    
    const purchases = [];
    snapshot.forEach((doc) => {
      purchases.push({
        purchaseId: doc.id,
        ...doc.data()
      });
    });
    
    console.log(`✅ Loaded ${purchases.length} purchases`);
    
    displayPurchases(purchases);
    
  } catch (error) {
    console.error('❌ Error loading purchases:', error.message);
    tbody.innerHTML = `
      <tr>
        <td colspan="8" style="text-align: center; padding: 20px; color: #dc3545;">
          <i class="bi bi-exclamation-triangle"></i> Failed to load purchases<br>
          <small style="color: #666;">${error.message}</small>
        </td>
      </tr>
    `;
  }
}

/**
 * ==========================================
 * DISPLAY PURCHASES - HANDLES EMPTY PRODUCTS
 * ✅ UPDATED: Shows "No products" when products array is empty
 * ==========================================
 */
 function displayPurchases(purchases) {
  const tbody = document.getElementById('purchasesList');
  
  if (!purchases || purchases.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="8" style="text-align: center; padding: 20px; color: #999;">
          <i class="bi bi-inbox"></i> No purchases yet. Click "Record Purchase" to add one!
        </td>
      </tr>
    `;
    return;
  }
  
  let html = '';
  
  purchases.forEach((purchase, index) => {
    // ✅ Format products - Handle empty products array
    let productsStr = '';
    let productsHtml = '';
    
    if (Array.isArray(purchase.products) && purchase.products.length > 0) {
      const cleanProducts = purchase.products
        .map(p => {
          const name = (p.name || '').replace(/\(N\/A\)/gi, '').trim();
          if (!name) return null;
          
          const qty = p.qty || 0;
          return qty > 0 ? `${name} (${qty})` : name;
        })
        .filter(p => p);
      
      productsStr = cleanProducts.join(', ') || 'No products';
      
      productsHtml = purchase.products
        .map(p => {
          const name = (p.name || '').replace(/\(N\/A\)/gi, '').trim();
          if (!name) return '';
          
          const qty = p.qty || 0;
          const qtyText = qty > 0 ? `<span style="color: #666; font-size: 0.85em;">(Qty: ${qty})</span>` : '';
          
          return `<div style="padding: 4px 0; color: #333;">• ${escapeHtml(name)} ${qtyText}</div>`;
        })
        .filter(h => h)
        .join('') || '<div style="color: #999;">No product details</div>';
        
    } else if (typeof purchase.products === 'string') {
      productsStr = purchase.products.replace(/\(N\/A\)/gi, '').trim() || 'No products';
      productsHtml = `<div style="padding: 4px 0; color: #333;">${escapeHtml(productsStr)}</div>`;
    } else {
      // ✅ No products at all
      productsStr = 'No products';
      productsHtml = '<div style="color: #999; font-style: italic;">No products added</div>';
    }
    
    // ✅ Date formatting
    let dateOnly = '-';
    let dateTimeFull = '-';
    
    if (purchase.date) {
      try {
        const date = new Date(purchase.date);
        if (!isNaN(date.getTime())) {
          dateTimeFull = date.toLocaleString('en-IN', {
            day: '2-digit',
            month: 'short',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
          
          const day = date.getDate();
          const month = date.toLocaleString('en-IN', { month: 'short' });
          dateOnly = `${day}-${month}`;
        }
      } catch (e) {
        console.error('Invalid date:', purchase.date);
      }
    }
    
    const hasPhoto = purchase.photoBase64 && purchase.photoBase64.length > 0;
    const vendorName = escapeHtml(purchase.vendorName || 'Vendor');
    const totalAmountDisplay = purchase.totalAmount > 0 ? `₹${Number(purchase.totalAmount).toFixed(2)}` : '-';
    
    // ✅ DESKTOP ROW
    html += `
      <tr class="d-none d-lg-table-row" onclick="viewPurchaseDetail(${index})" style="cursor: pointer; background: white !important;">
        <td style="text-align: center; font-weight: 600; background: white !important;">${index + 1}</td>
        <td style="white-space: nowrap; background: white !important;">${dateTimeFull}</td>
        <td style="text-align: center; background: white !important;">
          ${hasPhoto ? `
            <img 
              src="${purchase.photoBase64}" 
              onclick="event.stopPropagation(); openPurchasePhotoLightbox(${index})" 
              style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; cursor: pointer; transition: transform 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" 
              alt="Photo">
          ` : '<span style="color: #999;">No photo</span>'}
        </td>
        <td style="max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; background: white !important; ${productsStr === 'No products' ? 'color: #999; font-style: italic;' : ''}" title="${escapeHtml(productsStr)}">${escapeHtml(productsStr)}</td>
        <td style="background: white !important;">${vendorName}</td>
        <td style="font-weight: 600; color: #28a745; background: white !important;">${totalAmountDisplay}</td>
        <td style="font-size: 0.9rem; background: white !important;">${formatPaymentModes(purchase.paymentModes) || 'Not specified'}</td>
        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; background: white !important;" title="${escapeHtml(purchase.otherInfo || '')}">${escapeHtml(purchase.otherInfo || '')}</td>
      </tr>
    `;
    
    // ✅ MOBILE ROWS
    const topBorder = index === 0 ? 'none' : '12px solid #e5e5e5';
    
    html += `
      <tr class="d-table-row d-lg-none purchase-tile-main-${index}" 
          onclick="viewPurchaseDetail(${index})" 
          style="cursor: pointer; background: white !important; border-top: ${topBorder}; border-bottom: none !important;">
        <td style="font-size: 0.85rem; font-weight: 600; padding: 12px 8px 2px 8px; background: white !important; border: none !important;">${dateOnly}</td>
        <td style="font-size: 0.85rem; max-width: 100px; overflow: hidden; text-overflow: ellipsis; padding: 12px 8px 2px 8px; background: white !important; border: none !important;" 
            title="${vendorName}">${vendorName}</td>
        <td style="font-size: 0.85rem; font-weight: 600; color: #28a745; padding: 12px 8px 2px 8px; background: white !important; border: none !important;">${totalAmountDisplay}</td>
        <td style="text-align: center; padding: 12px 8px 2px 8px; background: white !important; border: none !important;">
          ${hasPhoto ? `
            <img 
              src="${purchase.photoBase64}" 
              onclick="event.stopPropagation(); openPurchasePhotoLightbox(${index})" 
              style="width: 40px; height: 40px; object-fit: cover; border-radius: 6px; cursor: pointer; box-shadow: 0 1px 3px rgba(0,0,0,0.1);" 
              alt="Photo">
          ` : ''}
        </td>
      </tr>
      
      <tr class="d-table-row d-lg-none purchase-tile-products-${index}" 
          onclick="viewPurchaseDetail(${index})" 
          style="cursor: pointer; background: white !important; border: none !important; border-top: none !important; border-bottom: none !important;">
        <td colspan="4" style="padding: 2px 12px 16px 12px; font-size: 0.8rem; line-height: 1.5; background: white !important; border: none !important;">
          <div style="color: #28a745; font-weight: 600; margin-bottom: 6px; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px;">
            <i class="bi bi-box-seam"></i> Products
          </div>
          ${productsHtml}
        </td>
      </tr>
    `;
  });
  
  tbody.innerHTML = html;
  window.currentPurchases = purchases;
  
  setTimeout(() => {
    forceRemoveBorders();
  }, 50);
  
  console.log('✅ Displayed', purchases.length, 'purchases');
}



/**
 * Force remove all borders between purchase rows
 */
function forceRemoveBorders() {
  const tbody = document.getElementById('purchasesList');
  if (!tbody) return;
  
  const allRows = tbody.querySelectorAll('tr');
  const allCells = tbody.querySelectorAll('td');
  
  allRows.forEach(row => {
    row.style.setProperty('background', 'white', 'important');
    row.style.setProperty('background-color', 'white', 'important');
    
    if (row.className.includes('purchase-tile-products')) {
      row.style.setProperty('border', 'none', 'important');
      row.style.setProperty('border-top', 'none', 'important');
      row.style.setProperty('border-bottom', 'none', 'important');
    }
    
    if (row.className.includes('purchase-tile-main')) {
      row.style.setProperty('border-bottom', 'none', 'important');
    }
  });
  
  allCells.forEach(cell => {
    cell.style.setProperty('background', 'white', 'important');
    cell.style.setProperty('background-color', 'white', 'important');
    
    const parentRow = cell.parentElement;
    if (parentRow && parentRow.className.includes('purchase-tile')) {
      cell.style.setProperty('border', 'none', 'important');
      cell.style.setProperty('border-top', 'none', 'important');
      cell.style.setProperty('border-bottom', 'none', 'important');
    }
  });
}


// Helper function
function formatPaymentModes(modes) {
  if (!modes || typeof modes !== 'object') return '';
  const parts = [];
  if (modes.cash && modes.cash > 0) parts.push(`Cash: ₹${modes.cash}`);
  if (modes.online && modes.online > 0) parts.push(`Online: ₹${modes.online}`);
  if (modes.credit && modes.credit > 0) parts.push(`Credit: ₹${modes.credit}`);
  return parts.join(', ') || '';
}



   /**
 * ==========================================
 * OPEN PURCHASE PHOTO LIGHTBOX - FIXED
 * ==========================================
 */
function openPurchasePhotoLightbox(purchaseIndex) {
  const purchase = window.currentPurchases[purchaseIndex];
  
  if (!purchase) {
    alert('❌ Purchase not found');
    return;
  }
  
  // ✅ Check for photo in photoBase64 field
  if (!purchase.photoBase64 || purchase.photoBase64.length === 0) {
    alert('❌ No photo available for this purchase');
    return;
  }
  
  console.log('📸 Opening purchase photo lightbox');
  
  // Create or get lightbox modal
  let lightbox = document.getElementById('purchasePhotoLightboxModal');
  
  if (!lightbox) {
    lightbox = document.createElement('div');
    lightbox.id = 'purchasePhotoLightboxModal';
    lightbox.className = 'modal fade';
    lightbox.setAttribute('tabindex', '-1');
    lightbox.innerHTML = `
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content" style="background: transparent; border: none;">
          <div class="modal-header" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border: none; color: white;">
            <h5 class="modal-title" id="purchasePhotoLightboxTitle">
              <i class="bi bi-camera"></i> Purchase Photo
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body text-center" style="padding: 20px; background: #fff;">
            <img 
              id="purchasePhotoLightboxImg" 
              src="" 
              style="width: 100%; max-height: 65vh; object-fit: contain; border-radius: 8px;" 
              alt="Purchase Photo"
              onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
            <div id="purchasePhotoLoadError" style="display:none; padding: 40px; color: #dc3545;">
              <i class="bi bi-exclamation-triangle" style="font-size: 3rem;"></i>
              <p style="margin-top: 15px;">Failed to load photo</p>
            </div>
          </div>
          <div class="modal-footer" style="border-top: 1px solid #dee2e6; background: #f8f9fa;">
            <strong style="color: #495057;">Vendor:</strong>
            <span id="purchasePhotoVendorName" style="margin-left: 10px; color: #6c757d;">-</span>
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(lightbox);
  }
  
  // ✅ Update modal content
  document.getElementById('purchasePhotoLightboxTitle').innerHTML = `
    <i class="bi bi-camera"></i> ${escapeHtml(purchase.vendorName || 'Purchase Photo')}
  `;
  
  const imgElement = document.getElementById('purchasePhotoLightboxImg');
  imgElement.style.display = 'block';
  imgElement.src = purchase.photoBase64; // ✅ Use photoBase64 field
  
  document.getElementById('purchasePhotoVendorName').textContent = purchase.vendorName || '-';
  document.getElementById('purchasePhotoLoadError').style.display = 'none';
  
  // Show modal
  const bsLightbox = new bootstrap.Modal(lightbox);
  bsLightbox.show();
}
/**
 * View purchase detail - shows TIME and INDIVIDUAL ITEM TOTALS
 * ✅ UPDATED: Handles purchases with no products
 */
 function viewPurchaseDetail(index) {
  const purchase = window.currentPurchases[index];
  
  if (!purchase) {
    alert('❌ Purchase not found');
    return;
  }
  
  // ✅ Format date WITH TIME for detail view
  let dateTimeFull = '-';
  if (purchase.date) {
    try {
      const date = new Date(purchase.date);
      if (!isNaN(date.getTime())) {
        const day = date.getDate();
        const month = date.toLocaleString('en-IN', { month: 'short' });
        const year = date.getFullYear();
        const hours = date.getHours();
        const minutes = date.getMinutes().toString().padStart(2, '0');
        const ampm = hours >= 12 ? 'PM' : 'AM';
        const hour12 = hours % 12 || 12;
        
        dateTimeFull = `${day} ${month} ${year}, ${hour12}:${minutes} ${ampm}`;
      }
    } catch (e) {
      console.error('Invalid date:', purchase.date);
    }
  }
  
  // ✅ Format products with INDIVIDUAL TOTALS - Handle empty array
  let productsHtml = '-';
  if (Array.isArray(purchase.products) && purchase.products.length > 0) {
    const productRows = purchase.products
      .map(p => {
        let productName = (p.name || p.product || 'Unknown Product').replace(/\(N\/A\)/gi, '').trim();
        const qty = p.qty || 0;
        const rate = p.rate || p.price || 0;
        const itemTotal = qty * rate;
        
        const qtyDisplay = qty > 0 ? qty : '-';
        const rateDisplay = rate > 0 ? `₹${Number(rate).toFixed(2)}` : '-';
        const amountDisplay = itemTotal > 0 ? `₹${Number(itemTotal).toFixed(2)}` : '-';
        
        return `
          <tr style="border-bottom: 1px solid #f0f0f0;">
            <td style="padding: 8px 10px;">${escapeHtml(productName)}</td>
            <td style="padding: 8px 10px; text-align: center;">${qtyDisplay}</td>
            <td style="padding: 8px 10px; text-align: right;">${rateDisplay}</td>
            <td style="padding: 8px 10px; text-align: right; font-weight: 600; color: #28a745;">${amountDisplay}</td>
          </tr>
        `;
      })
      .join('');
    
    productsHtml = `
      <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
        <thead>
          <tr style="background: #f8f9fa; border-bottom: 2px solid #dee2e6;">
            <th style="padding: 10px; text-align: left; font-weight: 600; color: #495057;">Product</th>
            <th style="padding: 10px; text-align: center; font-weight: 600; color: #495057;">Qty</th>
            <th style="padding: 10px; text-align: right; font-weight: 600; color: #495057;">Rate</th>
            <th style="padding: 10px; text-align: right; font-weight: 600; color: #495057;">Amount</th>
          </tr>
        </thead>
        <tbody>
          ${productRows}
        </tbody>
      </table>
    `;
  } else if (typeof purchase.products === 'string') {
    const cleanProducts = purchase.products.replace(/\(N\/A\)/gi, '').trim();
    productsHtml = escapeHtml(cleanProducts);
  } else {
    // ✅ No products added
    productsHtml = '<div style="color: #999; font-style: italic; padding: 10px;">No products added</div>';
  }
  
  const modalContent = `
    <div style="padding: 20px;">
      ${purchase.photoBase64 ? `
        <img src="${purchase.photoBase64}" 
             style="width:100%; max-height:300px; object-fit:cover; border-radius:8px; margin-bottom:20px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);" 
             alt="Purchase Photo" />
      ` : ''}
      
      <table style="width:100%; border-collapse: collapse;">
        <tr style="border-bottom: 1px solid #eee;">
          <td style="padding: 12px 10px; font-weight: 600; width: 40%;">Date & Time:</td>
          <td style="padding: 12px 10px;">${dateTimeFull}</td>
        </tr>
        
        <tr style="border-bottom: 1px solid #eee;">
          <td style="padding: 12px 10px; font-weight: 600;">Vendor:</td>
          <td style="padding: 12px 10px;">${escapeHtml(purchase.vendorName || 'Not specified')}</td>
        </tr>
        
        <tr style="border-bottom: 1px solid #eee;">
          <td colspan="2" style="padding: 12px 10px;">
            <div style="font-weight: 600; margin-bottom: 8px;">Products:</div>
            ${productsHtml}
          </td>
        </tr>
        
        ${purchase.totalAmount > 0 ? `
        <tr style="border-bottom: 1px solid #eee; background: #f8f9fa;">
          <td style="padding: 12px 10px; font-weight: 600;">Total Amount:</td>
          <td style="padding: 12px 10px; font-size: 20px; color: #28a745; font-weight: 700;">
            ₹${Number(purchase.totalAmount).toFixed(2)}
          </td>
        </tr>
        ` : ''}
        
        ${formatPaymentModes(purchase.paymentModes) ? `
        <tr style="border-bottom: 1px solid #eee;">
          <td style="padding: 12px 10px; font-weight: 600;">Payment Mode:</td>
          <td style="padding: 12px 10px;">${formatPaymentModes(purchase.paymentModes)}</td>
        </tr>
        ` : ''}
        
        ${purchase.otherInfo ? `
        <tr style="border-bottom: 1px solid #eee;">
          <td style="padding: 12px 10px; font-weight: 600;">Other Info:</td>
          <td style="padding: 12px 10px;">${escapeHtml(purchase.otherInfo)}</td>
        </tr>
        ` : ''}
      </table>
      
      <div style="margin-top: 20px; text-align: right;">
        <button class="btn btn-secondary" onclick="closePurchaseDetailModal()">
          <i class="bi bi-x-circle"></i> Close
        </button>
      </div>
    </div>
  `;
  
  // Show in modal
  const modalEl = document.getElementById('purchaseDetailModal');
  if (modalEl) {
    document.getElementById('purchaseDetailModalBody').innerHTML = modalContent;
    const modal = new bootstrap.Modal(modalEl);
    modal.show();
  } else {
    createTempPurchaseDetailModal(modalContent);
  }
}




function closePurchaseDetailModal() {
  const modalEl = document.getElementById('purchaseDetailModal');
  if (modalEl) {
    const modal = bootstrap.Modal.getInstance(modalEl);
    if (modal) modal.hide();
  }
}


function createTempPurchaseDetailModal(content) {
  let tempModal = document.getElementById('tempPurchaseDetailModal');
  if (tempModal) tempModal.remove();
  
  const modalHTML = `
    <div class="modal fade" id="tempPurchaseDetailModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title">
              <i class="bi bi-bag-check"></i> Purchase Details
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">${content}</div>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHTML);
  const modal = new bootstrap.Modal(document.getElementById('tempPurchaseDetailModal'));
  modal.show();
  
  document.getElementById('tempPurchaseDetailModal').addEventListener('hidden.bs.modal', function() {
    this.remove();
  });
}



/**
 * Confirm delete purchase - FIREBASE VERSION
 */
async function confirmDeletePurchase(purchaseId) {
  if (!confirm('Are you sure you want to delete this purchase? This cannot be undone.')) {
    return;
  }
  
  const user = window.auth.currentUser;
  if (!user) {
    alert('Please sign in first');
    return;
  }
  
  try {
    const { doc, deleteDoc } = window.firebaseImports;
    
    const purchaseDoc = doc(window.db, 'tenants', user.uid, 'purchases', purchaseId);
    await deleteDoc(purchaseDoc);
    
    alert('✅ Purchase deleted successfully!');
    
    // Close detail modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('purchaseDetailModal'));
    if (modal) modal.hide();
    
    // Reload list
    await loadRecentPurchases();
    
  } catch (error) {
    console.error('❌ Error deleting purchase:', error);
    alert('❌ Failed to delete purchase: ' + error.message);
  }
}

/**
 * Remove product row
 */
function removePurchaseProductRow(rowId) {
  const row = document.getElementById(rowId);
  if (row) {
    row.remove();
    console.log('❌ Removed product row:', rowId);
  }
}

/**
 * Calculate row amount
 */
function calculatePurchaseRowAmount(rowId) {
  const row = document.getElementById(rowId);
  if (!row) return;
  
  const qtyInput = row.querySelector('[data-field="qty"]');
  const rateInput = row.querySelector('[data-field="rate"]');
  const amountInput = row.querySelector('[data-field="amount"]');
  
  const qty = parseFloat(qtyInput.value) || 0;
  const rate = parseFloat(rateInput.value) || 0;
  const amount = qty * rate;
  
  amountInput.value = amount.toFixed(2);
}
/**
 * ==========================================
 * HANDLE PHOTO UPLOAD WITH COMPRESSION
 * ==========================================
 */
function handlePurchasePhotoUpload(input) {
  const file = input.files[0];
  
  if (!file) {
    console.log('⚠️ No file selected');
    return;
  }
  
  console.log('📷 Photo selected:', file.name, file.size, 'bytes');
  
  // Check file type
  if (!file.type.startsWith('image/')) {
    alert('❌ Please select an image file.');
    input.value = '';
    return;
  }
  
  // ✅ COMPRESS IMAGE IF TOO LARGE
  const reader = new FileReader();
  
  reader.onload = function(e) {
    const img = new Image();
    
    img.onload = function() {
      // ✅ COMPRESS TO MAX 800px WIDTH
      const MAX_WIDTH = 800;
      const MAX_HEIGHT = 800;
      let width = img.width;
      let height = img.height;
      
      // Calculate new dimensions
      if (width > height) {
        if (width > MAX_WIDTH) {
          height = height * (MAX_WIDTH / width);
          width = MAX_WIDTH;
        }
      } else {
        if (height > MAX_HEIGHT) {
          width = width * (MAX_HEIGHT / height);
          height = MAX_HEIGHT;
        }
      }
      
      // Create canvas and compress
      const canvas = document.createElement('canvas');
      canvas.width = width;
      canvas.height = height;
      
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, width, height);
      
      // Convert to base64 with compression (0.7 quality = 70%)
      const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7);
      
      // Check if still too large
      const sizeInBytes = (compressedBase64.length * 3) / 4;
      const sizeInKB = (sizeInBytes / 1024).toFixed(0);
      const sizeInMB = (sizeInBytes / (1024 * 1024)).toFixed(2);
      
      console.log(`✅ Photo compressed: ${file.size} → ${sizeInBytes} bytes (${sizeInKB} KB)`);
      
      // If still > 1MB, compress more
      if (sizeInBytes > 1000000) {
        console.warn('⚠️ Photo still too large, compressing further...');
        const extraCompressed = canvas.toDataURL('image/jpeg', 0.5);
        const newSize = (extraCompressed.length * 3) / 4;
        
        if (newSize > 1000000) {
          alert('❌ Photo is too large even after compression!\n\nPlease use a smaller photo (< 2MB original size).');
          input.value = '';
          return;
        }
        
        window.purchasePhotoBase64 = extraCompressed;
        console.log(`✅ Extra compression applied: ${newSize} bytes`);
      } else {
        window.purchasePhotoBase64 = compressedBase64;
      }
      
      // ✅ SHOW MOBILE-OPTIMIZED PHOTO PREVIEW
      const previewContainer = document.getElementById('purchasePhotoPreview');
      if (previewContainer) {
        previewContainer.innerHTML = `
          <div style="position: relative; width: 100%; max-width: 300px;">
            <img 
              src="${window.purchasePhotoBase64}" 
              onclick="viewPurchasePhotoPreview(); event.stopPropagation();"
              style="
                width: 100%; 
                height: auto;
                max-height: 200px; 
                object-fit: cover; 
                border-radius: 8px; 
                box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                cursor: pointer;
                transition: transform 0.2s;
              "
              onmouseover="this.style.transform='scale(1.02)'"
              onmouseout="this.style.transform='scale(1)'"
              title="Click to view full size"
              alt="Purchase Photo Preview">
            <div style="
              position: absolute;
              top: 8px;
              right: 8px;
              background: rgba(220, 53, 69, 0.9);
              color: white;
              width: 32px;
              height: 32px;
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
              cursor: pointer;
              font-size: 1.2rem;
              font-weight: bold;
              box-shadow: 0 2px 6px rgba(0,0,0,0.3);
              transition: all 0.2s;
            "
            onclick="clearPurchasePhoto(); event.stopPropagation();"
            onmouseover="this.style.background='rgba(220, 53, 69, 1)'; this.style.transform='scale(1.1)'"
            onmouseout="this.style.background='rgba(220, 53, 69, 0.9)'; this.style.transform='scale(1)'"
            title="Remove photo">
              ✕
            </div>
          </div>
          <div style="
            margin-top: 10px; 
            color: #28a745; 
            font-size: 0.85rem; 
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
          ">
            <i class="bi bi-check-circle-fill"></i>
            <span>${file.name} (${sizeInKB} KB)</span>
          </div>
        `;
        
        previewContainer.style.border = '2px solid #28a745';
        previewContainer.style.background = '#f0f9f4';
        previewContainer.style.padding = '15px';
      }
    };
    
    img.src = e.target.result;
  };
  
  reader.onerror = function(error) {
    console.error('❌ Error reading photo:', error);
    alert('❌ Failed to read photo. Please try again.');
  };
  
  reader.readAsDataURL(file);
}


/**
 * View purchase photo preview in lightbox
 */
/**
 * View purchase photo preview in full screen (Mobile-Optimized)
 */
function viewPurchasePhotoPreview() {
  if (!window.purchasePhotoBase64) {
    alert('❌ No photo available');
    return;
  }
  
  // Create full-screen overlay
  const overlay = document.createElement('div');
  overlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.95);
    z-index: 99999;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px;
  `;
  
  // Header
  const header = document.createElement('div');
  header.style.cssText = `
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    padding: 15px 20px;
    font-size: 1.1rem;
    font-weight: 600;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  `;
  header.innerHTML = '<i class="bi bi-camera"></i> Photo Preview';
  overlay.appendChild(header);
  
  // Image
  const img = document.createElement('img');
  img.src = window.purchasePhotoBase64;
  img.style.cssText = `
    max-width: 95%;
    max-height: 80vh;
    object-fit: contain;
    border-radius: 8px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    margin-top: 60px;
  `;
  overlay.appendChild(img);
  
  // Close button
  const closeBtn = document.createElement('button');
  closeBtn.innerHTML = '✕';
  closeBtn.style.cssText = `
    position: absolute;
    top: 70px;
    right: 15px;
    background: white;
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    font-size: 1.6rem;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 100000;
    transition: transform 0.2s;
  `;
  closeBtn.onmouseover = () => closeBtn.style.transform = 'scale(1.1)';
  closeBtn.onmouseout = () => closeBtn.style.transform = 'scale(1)';
  closeBtn.onclick = () => document.body.removeChild(overlay);
  overlay.appendChild(closeBtn);
  
  // Close on background click
  overlay.onclick = (e) => {
    if (e.target === overlay) {
      document.body.removeChild(overlay);
    }
  };
  
  // Add to body
  document.body.appendChild(overlay);
  
  console.log('📸 Opened photo preview');
}



    
/**
 * Clear photo
 */
/**
 * Clear photo (SAFE VERSION - checks if elements exist)
/**
 * Clear photo and reset preview area
 */
/**
 * Clear photo and reset preview (Mobile-Optimized)
 */
function clearPurchasePhoto() {
  console.log('🗑️ Clearing purchase photo');
  
  try {
    // Reset photo base64
    window.purchasePhotoBase64 = null;
    
    // Clear file input
    const photoInput = document.getElementById('purchasePhotoInput');
    if (photoInput) {
      photoInput.value = '';
    }
    
    // Reset preview container to original state
    const previewContainer = document.getElementById('purchasePhotoPreview');
    if (previewContainer) {
      previewContainer.innerHTML = `
        <i class="bi bi-camera" style="font-size: 2rem; color: #999;"></i>
        <p style="color: #999; margin: 8px 0 0 0; font-size: 0.9rem;">Tap or paste photo</p>
      `;
      
      previewContainer.style.border = '2px dashed #ccc';
      previewContainer.style.background = '#f8f9fa';
      previewContainer.style.padding = '20px';
      previewContainer.onclick = () => triggerPhotoInput();
    }
    
    // Hide remove button
    const removeBtn = document.getElementById('clearPurchasePhotoBtn');
    if (removeBtn) {
      removeBtn.style.display = 'none';
    }
    
    console.log('✅ Photo cleared');
  } catch (e) {
    console.log('⚠️ Error clearing photo:', e.message);
  }
}


/**
 * Open camera
 */
function openPurchaseCamera() {
  const input = document.getElementById('purchasePhotoInput');
  input.setAttribute('capture', 'environment');
  input.click();
}



/**
 * ==========================================
 * BULK ADD PRODUCTS FOR PURCHASE 
 * ==========================================
 */
let selectedBulkProductsPurchase = {};

function openBulkAddModalForPurchase() {
  console.log('📦 Opening Bulk Add Modal for Purchase');
  
  // ✅ ALWAYS RESET COMPLETELY
  document.getElementById('bulkSearchInputPurchase').value = '';
  selectedBulkProductsPurchase = {};
  
  // Render products
  renderBulkProductsListPurchase('');
  
  // ✅ Clear selected items panel
  const selectedContainer = document.getElementById('bulkSelectedItemsPurchase');
  if (selectedContainer) {
    selectedContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">No items selected</div>';
  }
  
  // ✅ Reset counters
  updateBulkCountersPurchase();
  
  // Show modal
  const modal = new bootstrap.Modal(document.getElementById('bulkAddModalForPurchase'));
  modal.show();
  
  console.log('✅ Modal opened with clean state');
}

function filterBulkProductsPurchase(query) {
  renderBulkProductsListPurchase(query);
}

function renderBulkProductsListPurchase(searchQuery) {
  const container = document.getElementById('bulkProductsListPurchase');
  if (!container) return;
  
  const products = cachedProducts || [];
  let filtered = products;
  
  if (searchQuery && searchQuery.trim().length > 0) {
    const query = searchQuery.toLowerCase();
    filtered = products.filter(product => {
      const name = (product.name || '').toLowerCase();
      const brand = (product.brand || '').toLowerCase();
      const category = (product.category || '').toLowerCase();
      return name.includes(query) || brand.includes(query) || category.includes(query);
    });
  }
  
  if (filtered.length === 0) {
    container.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">No products found</div>';
    return;
  }
  
  let html = '';
  filtered.forEach(product => {
    const isSelected = selectedBulkProductsPurchase[product.id];
    const displayName = product.size ? `${product.name} (${product.size})` : product.name;
    const priceText = product.price ? `₹${product.price}` : 'N/A';
    
    html += `
      <div onclick="toggleBulkProductSelectionPurchase('${product.id}')"
           style="
             padding: 12px;
             border-bottom: 1px solid #f0f0f0;
             cursor: pointer;
             transition: background-color 0.2s;
             display: flex;
             justify-content: space-between;
             align-items: center;
             ${isSelected ? 'background-color: #e3f2fd;' : 'background-color: white;'}
           "
           onmouseover="this.style.backgroundColor='#f5f5f5'"
           onmouseout="this.style.backgroundColor='${isSelected ? '#e3f2fd' : 'white'}'">
        <div style="flex: 1;">
          <strong>${escapeHtml(displayName)}</strong>
          <div style="font-size: 0.85rem; color: #666;">${priceText}</div>
        </div>
        <div>${isSelected ? '✓' : ''}</div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

function toggleBulkProductSelectionPurchase(productId) {
  const product = cachedProducts.find(p => p.id === productId);
  if (!product) return;
  
  if (selectedBulkProductsPurchase[productId]) {
    delete selectedBulkProductsPurchase[productId];
  } else {
    selectedBulkProductsPurchase[productId] = {
      id: product.id,
      name: product.name,
      size: product.size || '',
      price: product.price || 0,
      unitType: product.unitType || 'Pieces',
      qty: 1
    };
  }
  
  renderBulkProductsListPurchase(document.getElementById('bulkSearchInputPurchase').value);
  renderBulkSelectedItemsPurchase();
}

function renderBulkSelectedItemsPurchase() {
  const container = document.getElementById('bulkSelectedItemsPurchase');
  if (!container) return;
  
  const selectedArray = Object.values(selectedBulkProductsPurchase);
  
  if (selectedArray.length === 0) {
    container.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">No items selected</div>';
    updateBulkCountersPurchase();
    return;
  }
  
  let html = '';
  selectedArray.forEach(product => {
    const displayName = product.size ? `${product.name} (${product.size})` : product.name;
    
    html += `
      <div style="padding: 12px; border-bottom: 1px solid #ddd;">
        <div style="margin-bottom: 8px;">
          <strong>${escapeHtml(displayName)}</strong>
          <div style="font-size: 0.85rem; color: #666;">₹${product.price}</div>
        </div>
        
        <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px;">
          <div style="display: flex; align-items: center; gap: 4px;">
            <button type="button" onclick="updateBulkQtyPurchase('${product.id}', -1)"
                    style="padding: 6px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">−</button>
            <input type="number" value="${product.qty}" min="1"
                   style="width: 50px; text-align: center; padding: 6px; border: 1px solid #ddd; border-radius: 4px;"
                   onchange="updateBulkQtyDirectPurchase('${product.id}', this.value)">
            <button type="button" onclick="updateBulkQtyPurchase('${product.id}', 1)"
                    style="padding: 6px 10px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">+</button>
          </div>
          <button type="button" onclick="toggleBulkProductSelectionPurchase('${product.id}')"
                  style="padding: 6px 10px; font-size: 16px; cursor: pointer; color: #dc3545; background: none; border: none;">✕</button>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
  updateBulkCountersPurchase();
}

function updateBulkQtyPurchase(productId, change) {
  if (selectedBulkProductsPurchase[productId]) {
    const newQty = Math.max(1, selectedBulkProductsPurchase[productId].qty + change);
    selectedBulkProductsPurchase[productId].qty = newQty;
    renderBulkSelectedItemsPurchase();
  }
}

function updateBulkQtyDirectPurchase(productId, value) {
  if (selectedBulkProductsPurchase[productId]) {
    const newQty = Math.max(1, parseInt(value) || 1);
    selectedBulkProductsPurchase[productId].qty = newQty;
    renderBulkSelectedItemsPurchase();
  }
}

function updateBulkCountersPurchase() {
  const selectedArray = Object.values(selectedBulkProductsPurchase);
  const selectedCount = selectedArray.length;
  const totalQty = selectedArray.reduce((sum, p) => sum + p.qty, 0);
  
  document.getElementById('bulkSelectedCountPurchase').textContent = selectedCount;
  document.getElementById('bulkTotalQtyPurchase').textContent = totalQty;
}
/**
 * ✅ ADD BULK PRODUCTS - MERGE DUPLICATES & AUTO-CLOSE (FIXED: Dynamic Unit Types)
 */
 function addBulkProductsToPurchase() {
  const selectedArray = Object.values(selectedBulkProductsPurchase);
  
  if (selectedArray.length === 0) {
    alert('❌ Please select at least one product');
    return;
  }
  
  console.log('📦 Adding', selectedArray.length, 'products to purchase');
  
  const container = document.getElementById('purchaseProductRows');
  if (!container) return;
  
  // GET ALL EXISTING ROWS
  const existingRows = container.querySelectorAll('.purchase-product-row');
  
  selectedArray.forEach(product => {
    const productName = product.size ? `${product.name} (${product.size})` : product.name;
    
    // CHECK IF PRODUCT ALREADY EXISTS
    let existingRow = null;
    existingRows.forEach(row => {
      const nameInput = row.querySelector('input[data-field="name"]');
      if (nameInput && nameInput.value.trim() === productName) {
        existingRow = row;
      }
    });
    
    if (existingRow) {
      // PRODUCT EXISTS - MERGE QUANTITY
      const qtyInput = existingRow.querySelector('input[data-field="qty"]');
      if (qtyInput) {
        const currentQty = parseFloat(qtyInput.value) || 0;
        const newQty = currentQty + product.qty;
        qtyInput.value = newQty;
        
        // Trigger amount recalculation
        const rowId = existingRow.id;
        if (rowId && typeof calculatePurchaseRowAmount === 'function') {
          calculatePurchaseRowAmount(rowId);
        }
        
        console.log(`✅ Merged: ${productName} - Updated qty to ${newQty}`);
      }
    } else {
      // NEW PRODUCT - ADD TO TOP
      purchaseProductRowCounter++;
      const rowId = `purchaseRow${purchaseProductRowCounter}`;
      
      const rowDiv = document.createElement('div');
      rowDiv.id = rowId;
      rowDiv.className = 'purchase-product-row';

      // ✅ BUILD UNIT TYPE OPTIONS DYNAMICALLY
      const unitType = product.unitType || 'Box';
      const unitOptions = generateUnitTypeOptions(unitType);

      rowDiv.innerHTML = `
        <input type="text" class="form-control" placeholder="Product name"
               value="${escapeHtml(productName)}" data-field="name">
        <input type="number" class="form-control" placeholder="Qty" min="1"
               value="${product.qty}" oninput="calculatePurchaseRowAmount('${rowId}')" data-field="qty">
        <input type="number" class="form-control" placeholder="Rate" min="0" step="0.01"
               value="${product.price}" oninput="calculatePurchaseRowAmount('${rowId}')" data-field="rate">
        <select class="form-select" data-field="unit">
          ${unitOptions}
        </select>
        <input type="number" class="form-control" placeholder="Amount" readonly
               value="${(product.qty * product.price).toFixed(2)}" data-field="amount"
               style="background: #e8f5e9; font-weight: 600; color: #2e7d32;">
        <button type="button" class="btn btn-danger purchase-remove-btn"
            onclick="removePurchaseProductRow('${rowId}')"
            style="font-size:22px;padding:0;min-width:36px;height:36px;">
          ×
        </button>
      `;

      container.insertBefore(rowDiv, container.firstChild);
      console.log(`✅ Added new: ${productName} - Qty ${product.qty} - Unit: ${unitType}`);
    }
  });
  
  // CLEAR SELECTIONS & CLOSE MODAL
  selectedBulkProductsPurchase = {};
  
  const modal = bootstrap.Modal.getInstance(document.getElementById('bulkAddModalForPurchase'));
  if (modal) {
    modal.hide();
  }
  
  console.log('✅ Products added/merged successfully! Modal closed.');
}

/**
 * ✅ HELPER: Generate Unit Type Options Dynamically from Cache
 * Uses unitTypesCache if available, otherwise falls back to defaults
 */
 function generateUnitTypeOptions(selectedUnit) {
  // Default unit types (fallback)
  const defaultUnits = ['Box', 'Piece', 'SFT', 'Kg', 'Liters', 'Meter'];
  
  // Use unitTypesCache if available, otherwise use defaults
  let availableUnits = [];
  
  if (window.unitTypesCache && Array.isArray(window.unitTypesCache) && window.unitTypesCache.length > 0) {
    console.log('✅ Using', window.unitTypesCache.length, 'unit types from cache');
    availableUnits = [...window.unitTypesCache];
  } else {
    console.log('⚠️ No unit types in cache, using defaults');
    availableUnits = [...defaultUnits];
  }
  
  // Ensure selected unit is in the list
  if (selectedUnit && !availableUnits.includes(selectedUnit)) {
    availableUnits.push(selectedUnit);
  }
  
  // Sort alphabetically
  availableUnits.sort((a, b) => a.localeCompare(b));
  
  // Build options HTML
  let optionsHTML = '';
  availableUnits.forEach(unit => {
    const isSelected = unit === selectedUnit ? 'selected' : '';
    optionsHTML += `<option value="${escapeHtml(unit)}" ${isSelected}>${escapeHtml(unit)}</option>`;
  });
  
  return optionsHTML;
}

// ✅ Make helper function global
window.generateUnitTypeOptions = generateUnitTypeOptions;


/**
 * ==========================================
 * LOAD UNIT TYPES CACHE FROM FIRESTORE
 * ==========================================
 * Loads unit types into global cache for use in dropdowns
 */
 async function loadUnitTypesCache() {
  // Check if already loaded
  if (window.unitTypeCacheLoaded && window.unitTypesCache && window.unitTypesCache.length > 0) {
    console.log('✅ Unit types already loaded:', window.unitTypesCache.length);
    return;
  }
  
  const user = window.auth?.currentUser;
  if (!user) {
    console.warn('⚠️ User not authenticated, cannot load unit types');
    return;
  }
  
  try {
    console.log('📥 Loading unit types from Firestore...');
    
    const { collection, getDocs } = window.firebaseImports;
    const unitTypesRef = collection(window.db, 'tenants', user.uid, 'unitTypes');
    const snapshot = await getDocs(unitTypesRef);
    
    const unitTypes = [];
    snapshot.forEach((doc) => {
      const data = doc.data();
      const unitTypeName = data.name || data.unitTypeName;
      if (unitTypeName) {
        unitTypes.push(unitTypeName);
      }
    });
    
    // Sort alphabetically
    unitTypes.sort((a, b) => a.localeCompare(b));
    
    // Update global cache
    window.unitTypesCache = unitTypes;
    window.unitTypeAutocompleteCache = unitTypes;
    window.unitTypeCacheLoaded = true;
    
    console.log('✅ Loaded', unitTypes.length, 'unit types into cache:', unitTypes);
    
  } catch (error) {
    console.error('❌ Error loading unit types:', error);
    
    // Fallback to defaults on error
    window.unitTypesCache = ['Box', 'Piece', 'SFT', 'Kg', 'Liters', 'Meter'];
    window.unitTypeCacheLoaded = false;
  }
}

// ✅ Make function globally accessible
window.loadUnitTypesCache = loadUnitTypesCache;



/**
 * Toggle checkmark visibility for payment modes
 */
function togglePaymentModeCheckmark(checkbox, checkmarkId) {
  const checkmark = document.getElementById(checkmarkId);
  if (checkmark) {
    if (checkbox.checked) {
      checkmark.style.display = 'block';
      console.log('✓ Checkmark shown for', checkmarkId);
    } else {
      checkmark.style.display = 'none';
      console.log('✗ Checkmark hidden for', checkmarkId);
    }
  }
}


/**
 * Toggle collapsible sections on mobile
 */
function toggleSection(sectionId) {
  // Only work on mobile
  if (window.innerWidth > 767) return;
  
  const section = document.getElementById(sectionId);
  const icon = document.getElementById(sectionId + 'Icon');
  
  if (section && icon) {
    section.classList.toggle('open');
    icon.classList.toggle('open');
    console.log('📱 Toggled section:', sectionId);
  }
}









    
    

  /***********************
   * SALES GRID: create rows, populate selects, mobile behavior
   ***********************/
  function openSalesModal(){
  initSalesGrid();
  populateMultiSelect(); // ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ NEW: Populate multi-select
  new bootstrap.Modal(document.getElementById('salesModal')).show();
}

// âœ… CORRECTED: Multi-Select Functions with Photo Support
function populateMultiSelect() {
    const container = document.getElementById('multiSelectList');
    if (!container) return;
    
    let html = '';
    
    cachedProducts
        .filter(p => {
            // Include photo products ONLY if they have stock AND price
            if (p.imageUrl && p.imageUrl !== '' && p.imageUrl !== 'uploading...') {
                const hasStockAndPrice = p.stock > 0 && p.price > 0;
                console.log(`Photo product "${p.name}": stock=${p.stock}, price=${p.price}, showing=${hasStockAndPrice}`);
                return hasStockAndPrice;
            }
            // Include regular products with stock
            return p.stock > 0;
        })
        .forEach(product => {
            // Add photo thumbnail if available
            const photoHTML = (product.imageUrl && product.imageUrl !== 'uploading...') ? 
                `<img src="${product.imageUrl}" 
                     class="photo-thumbnail-small" 
                     alt="${escapeHtml(product.name)}" 
                     style="width:40px; height:40px; object-fit:cover; border-radius:4px; border:2px solid #e0e0e0; margin-right:8px; vertical-align:middle;"
                     onerror="this.style.display='none'; console.error('Failed to load image for: ${escapeHtml(product.name)}');">` : '';
            
            html += `
                <div class="multi-select-item">
                    <div class="form-check">
                        <input class="form-check-input multi-select-checkbox" type="checkbox" 
                               id="multi-${product.id}" 
                               value="${product.id}"
                               onchange="onMultiSelectChange()">
                        ${photoHTML}
                        <label class="form-check-label" for="multi-${product.id}">
                            ${escapeHtml(product.name)} 
                            <small class="text-muted">(Stock: ${product.stock} ${product.unitType})</small>
                        </label>
                    </div>
                </div>
            `;
        });
    
    container.innerHTML = html || '<small class="text-muted">No products available</small>';
    
    // Debug: Log how many products are shown
    console.log(`Multi-select populated with ${cachedProducts.filter(p => p.stock > 0).length} products`);
}



function toggleMultiSelect() {
    const options = document.getElementById('multiSelectOptions');
    options.classList.toggle('show');
}

function filterMultiSelectOptions() {
    const searchTerm = document.getElementById('multiSelectSearch').value.toLowerCase();
    const items = document.querySelectorAll('.multi-select-item');
    
    items.forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(searchTerm) ? '' : 'none';
    });
}

function onMultiSelectChange() {
    const checkedProducts = [];
    
    // Get all checked checkboxes
    document.querySelectorAll('.multi-select-checkbox:checked').forEach(checkbox => {
        const productId = checkbox.value;
        const product = cachedProducts.find(p => p.id === productId);
        if (product) {
            checkedProducts.push(product);
        }
    });
    
    // Update label
    const label = document.getElementById('multiSelectLabel');
    if (checkedProducts.length === 0) {
        label.innerHTML = 'Click to select multiple products...';
    } else {
        label.innerHTML = `<strong>${checkedProducts.length} product${checkedProducts.length > 1 ? 's' : ''} selected</strong>`;
    }
    
    // Auto-populate rows
    ensureEnoughRows(checkedProducts.length);
    populateRowsWithSelectedProducts(checkedProducts);
}

function ensureEnoughRows(needed) {
    const currentRows = document.querySelectorAll('#product-grid-body tr').length;
    if (needed > currentRows) {
        const rowsToAdd = needed - currentRows;
        for (let i = 0; i < rowsToAdd; i++) {
            const currentCount = document.querySelectorAll('#product-grid-body tr').length;
            appendEmptyRow(currentCount + 1);
        }
        updateRowNumbers();
    }
}

function populateRowsWithSelectedProducts(products) {
    products.forEach((product, index) => {
        const rowIndex = index + 1;
        
        // Select product in dropdown
        const select = document.getElementById(`product-${rowIndex}`);
        if (select) {
            select.value = product.id;
            onProductSelect(rowIndex); // Trigger auto-fill
        }
    });
    
    updateGrandTotal();
}

// Close multi-select when clicking outside
document.addEventListener('click', function(e) {
    const dropdown = document.querySelector('.multi-select-dropdown');
    const options = document.getElementById('multiSelectOptions');
    if (dropdown && !dropdown.contains(e.target) && options) {
        options.classList.remove('show');
    }
});



    
  function initSalesGrid(){
    const body = document.getElementById('product-grid-body');
    body.innerHTML = '';
    for(let i=1;i<=3;i++) appendEmptyRow(i);
    updateRowNumbers();
    updateGrandTotal();
  }

  function appendEmptyRow(index){
    const tbody = document.getElementById('product-grid-body');
    const tr = document.createElement('tr');
    tr.className = 'product-row';
    tr.dataset.custom = 'false';
    tr.innerHTML = `
      <td class="grid-row-number"></td>
      <td>
        <select class="form-select product-select" id="product-${index}" onchange="onProductSelect(${index})">
          <option value="">-- Select Product --</option>
        </select>
      </td>
      <td><input type="text" class="form-control size-input readonly-input" id="size-${index}" readonly /></td>
      <td><input type="number" class="form-control qty-input" id="qty-${index}" min="1" disabled placeholder="Enter quantity" oninput="onQtyChange(${index})"></td>

      <td><input type="text" class="form-control unit-input readonly-input" id="unit-${index}" readonly /></td>
      <td><input type="number" class="form-control price-input readonly-input" id="price-${index}" readonly /></td>
      <td><div id="total-${index}" class="fw-bold">₹0.00</div></td>
      <td><button class="btn btn-sm btn-outline-danger" onclick="removeRow(this)"><i class="bi bi-x"></i></button></td>
    `;
    tbody.appendChild(tr);
    populateProductSelectForRow(index);
  }

  function addMoreRows(){
    const currentCount = document.querySelectorAll('#product-grid-body .product-row').length;
    for(let i=1;i<=3;i++) appendEmptyRow(currentCount+i);
    updateRowNumbers();
  }

 function removeRow(btn) {
  const tr = btn.closest('tr')
  if(!tr) return
  
  // ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ FIX: Don't actually delete the row - just clear/reset it
  const select = tr.querySelector('.product-select')
  const sizeEl = tr.querySelector('.size-input')
  const qtyEl = tr.querySelector('.qty-input')
  const unitEl = tr.querySelector('.unit-input')
  const priceEl = tr.querySelector('.price-input')
  const totalEl = tr.querySelector('[id^="total-"]')
  
  // If custom product, remove from array
  if(select && select.value && select.value.startsWith('CUST_TMP_')) {
    customProductsInSale = customProductsInSale.filter(c => c.tempId !== select.value)
  }
  
  // Reset all fields to empty/default state
  if(select) {
    select.value = ''
    select.disabled = false
  }
  if(sizeEl) sizeEl.value = ''
  if(unitEl) unitEl.value = ''
  if(priceEl) priceEl.value = ''
  if(qtyEl) {
    qtyEl.value = ''
    qtyEl.disabled = true // Disable until product selected
    qtyEl.removeAttribute('max')
  }
  if(totalEl) totalEl.textContent = formatCurrency(0)
  
  // ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ CRITICAL: Get row index and re-attach event listener
  const rowIndex = Array.from(tr.parentNode.children).indexOf(tr) + 1;
  
  if(select) {
    // Re-populate select options
    populateProductSelectForRow(rowIndex);
    
    // Re-attach onchange handler
    select.onchange = function() {
      onProductSelect(rowIndex);
    };
  }
  
  updateGrandTotal()
}


  function updateRowNumbers(){
    const rows = document.querySelectorAll('#product-grid-body .product-row');
    rows.forEach((r,i)=>{
      const idx = i+1;
      r.querySelector('.grid-row-number').textContent = idx;
      // update element ids to keep consistent
      const sel = r.querySelector('.product-select'); if(sel) sel.id = `product-${idx}`;
      const sizeEl = r.querySelector('.size-input'); if(sizeEl) sizeEl.id = `size-${idx}`;
      const qtyEl = r.querySelector('.qty-input'); if(qtyEl){ qtyEl.id = `qty-${idx}`; qtyEl.setAttribute('oninput', `onQtyChange(${idx})`); }
      const unitEl = r.querySelector('.unit-input'); if(unitEl) unitEl.id = `unit-${idx}`;
      const priceEl = r.querySelector('.price-input'); if(priceEl) priceEl.id = `price-${idx}`;
      const totalEl = r.querySelector('[id^=total-]'); if(totalEl) totalEl.id = `total-${idx}`;
      // ensure options refreshed (keeps custom options)
      populateProductSelectForRow(idx);
    });
  }


    // ========== NEW: Sort sales by date (newest first) ==========
function sortSalesByDateDescending() {
    cachedSales.sort((a, b) => {
        const dateA = new Date(a.date);
        const dateB = new Date(b.date);
        return dateB - dateA; // Newest first
    });
    console.log('ÃƒÆ’Ã‚Â°Ãƒâ€¦Ã‚Â¸ÃƒÂ¢Ã¢â€šÂ¬Ã‚ÂÃƒÂ¢Ã¢â€šÂ¬Ã…Â¾ Sales sorted: newest first');
}

  /***********************
   * Row interactions
   ***********************/
  function onProductSelect(rowIndex){
    const sel = document.getElementById(`product-${rowIndex}`);
    const sizeEl = document.getElementById(`size-${rowIndex}`);
    const unitEl = document.getElementById(`unit-${rowIndex}`);
    const priceEl = document.getElementById(`price-${rowIndex}`);
    const qtyEl = document.getElementById(`qty-${rowIndex}`);
    if(!sel) return;
    const val = sel.value;
    if(!val){
      if(sizeEl) sizeEl.value=''; if(unitEl) unitEl.value=''; if(priceEl) priceEl.value=''; if(qtyEl){ qtyEl.value=''; qtyEl.disabled=true; qtyEl.removeAttribute('max'); }
      document.getElementById(`total-${rowIndex}`).textContent = formatCurrency(0);
      updateGrandTotal(); return;
    }
    // if this value is a custom temporary product
    if(val.startsWith('CUST_TMP_')){
      const cp = customProductsInSale.find(c => c.tempId === val);
      if(cp){
        sizeEl.value = cp.size || 'N/A';
        unitEl.value = cp.unitType;
        priceEl.value = cp.price;
        qtyEl.disabled = false;
        qtyEl.max = cp.quantity || '';
        qtyEl.value = cp.quantity || '';
        document.getElementById(`total-${rowIndex}`).textContent = formatCurrency(cp.price * (cp.quantity||0));
        updateGrandTotal();
      }
      return;
    }
    // Normal product from cachedProducts
    const product = (cachedProducts || []).find(p => p.id === val);
    if(!product){ sizeEl.value=''; unitEl.value=''; priceEl.value=''; if(qtyEl){ qtyEl.disabled=true; qtyEl.value=''; } return; }
    sizeEl.value = product.size || 'N/A';
    unitEl.value = product.unitType || '';
    priceEl.value = product.price || 0;
    qtyEl.disabled = false;
    qtyEl.value = '';
    qtyEl.max = product.stock || '';
    document.getElementById(`total-${rowIndex}`).textContent = formatCurrency(0);
    updateGrandTotal();
  }

  function onQtyChange(rowIndex){
    const qtyEl = document.getElementById(`qty-${rowIndex}`);
    if(!qtyEl) return;
    const qty = Number(qtyEl.value || 0);
    const max = Number(qtyEl.max || Infinity);
    if(qty > max){
      alert(`ÃƒÂ¢Ã‚ÂÃ…â€™ Quantity exceeds available stock (${max}). Adjusting to max.`);
      qtyEl.value = max;
    }
    updateRowTotal(rowIndex);
    updateGrandTotal();
  }

  function updateRowTotal(rowIndex){
    const price = Number(document.getElementById(`price-${rowIndex}`).value || 0);
    const qty = Number(document.getElementById(`qty-${rowIndex}`).value || 0);
    const total = price * qty;
    const el = document.getElementById(`total-${rowIndex}`);
    if(el) el.textContent = formatCurrency(total);
    return total;
  }

  function updateGrandTotal(){
    let grand = 0;
    const rows = document.querySelectorAll('#product-grid-body .product-row');
    rows.forEach((r,i)=>{
      const idx = i+1;
      const sel = document.getElementById(`product-${idx}`);
      if(!sel) return;
      if(!sel.value && r.dataset.custom!=='true') return;
      const qty = Number(document.getElementById(`qty-${idx}`)?.value || 0);
      const price = Number(document.getElementById(`price-${idx}`)?.value || 0);
      const line = qty * price;
      grand += line;
      const totalEl = document.getElementById(`total-${idx}`);
      if(totalEl) totalEl.textContent = formatCurrency(line);
    });
    document.getElementById('grandTotal').textContent = formatCurrency(grand);
    document.getElementById('subtotal').textContent = formatCurrency(grand);
  }

  /***********************
   * CUSTOM PRODUCT: open, validate, add to grid (and optionally inventory)
   ***********************/
function openCustomProductPopup() {
  document.getElementById('customProductForm').reset();
  document.getElementById('customTotal').textContent = '₹0.00';
  new bootstrap.Modal(document.getElementById('customProductModal'), {backdrop: 'static'}).show();
  setTimeout(() => document.getElementById('customName').focus(), 200);
}

  function updateCustomTotalDisplay(){
    const qty = Number(document.getElementById('customQty').value || 0);
    const price = Number(document.getElementById('customPrice').value || 0);
    document.getElementById('customTotal').textContent = formatCurrency(qty * price);
  }
  // Attach in case DOM ready
  document.addEventListener('input', (e)=>{
    if(e.target && (e.target.id==='customQty' || e.target.id==='customPrice')) updateCustomTotalDisplay();
  });

function validateCustomProduct() {
  const name = document.getElementById('customName').value.trim();
  const qty = Number(document.getElementById('customQty').value || 0);
  const price = Number(document.getElementById('customPrice').value || 0);
  
  if (!name || name.length < 2) {
    alert('ÃƒÂ¢Ã‚ÂÃ…â€™ Product name required (min 2 chars)');
    return false;
  }
  
  if (!qty || qty < 1) {
    alert('ÃƒÂ¢Ã‚ÂÃ…â€™ Quantity must be at least 1');
    return false;
  }
  
  if (!price || price <= 0) {
    alert('ÃƒÂ¢Ã‚ÂÃ…â€™ Unit price must be greater than 0');
    return false;
  }
  
  return true;
}


function addCustomProductToGrid() {
  if (!validateCustomProduct()) return;
  
  const name = document.getElementById('customName').value.trim();
  const size = document.getElementById('customSize').value.trim() || 'N/A';
  const qty = Number(document.getElementById('customQty').value || 0);
  const unitType = document.getElementById('customUnit').value || 'Box';
  const price = Number(document.getElementById('customPrice').value || 0);
  
  const tempId = 'CUST_TMP_' + Date.now().toString(36); // Unique temp id
  
  // Store in persistent array
  const cp = {
    tempId: tempId,
    name: name,
    size: size,
    unitType: unitType,
    price: price,
    quantity: qty
  };
  
  customProductsInSale.push(cp);
  
  // Find first empty row or append new row
  let idx = findFirstEmptyRowIndex();
  if (!idx) {
    const count = document.querySelectorAll('#product-grid-body .product-row').length;
    appendEmptyRow(count + 1);
    updateRowNumbers();
    idx = count + 1;
  }
  
  // Populate row with custom data
  populateRowWithCustom(idx, cp);
  updateGrandTotal();
  
  // Close modal
  const modal = bootstrap.Modal.getInstance(document.getElementById('customProductModal'));
  if (modal) modal.hide();
  
  // Show success
  alert(`ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ Custom product "${name}" added to sale!`);
}


function populateRowWithCustom(rowIndex, cp){
    const sel = document.getElementById(`product-${rowIndex}`);
    if(!sel) return;
    // ensure select contains this option (populateProductSelectForRow will add it)
    populateProductSelectForRow(rowIndex);
    // create or update option
    let opt = Array.from(sel.options).find(o=>o.value===cp.tempId);
    if(!opt){
      opt = document.createElement('option');
      opt.value = cp.tempId;
      opt.text = `${cp.name} (Custom)`;
      opt.dataset.size = cp.size;
      opt.dataset.unit = cp.unitType;
      opt.dataset.price = cp.price;
      opt.dataset.stock = cp.quantity;
      sel.appendChild(opt);
    }
    sel.value = cp.tempId;
    document.getElementById(`size-${rowIndex}`).value = cp.size;
    document.getElementById(`unit-${rowIndex}`).value = cp.unitType;
    document.getElementById(`price-${rowIndex}`).value = cp.price;
    
    // ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ FIX: Make quantity editable for custom products
    const qtyEl = document.getElementById(`qty-${rowIndex}`);
    qtyEl.disabled = false;  // ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ Keep enabled
    qtyEl.readOnly = false;  // ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ Not read-only
    qtyEl.value = cp.quantity;
    qtyEl.max = cp.quantity; // Can increase up to this amount
    
    // ÃƒÂ¢Ã…â€œÃ¢â‚¬Â¦ NEW: Add event listener to update total when quantity changes
    qtyEl.addEventListener('input', function() {
        const newQty = parseFloat(this.value) || 0;
        const price = parseFloat(document.getElementById(`price-${rowIndex}`).value) || 0;
        const total = newQty * price;
        document.getElementById(`total-${rowIndex}`).textContent = formatCurrency(total);
        updateGrandTotal();
    });
    
    // Set initial total
    document.getElementById(`total-${rowIndex}`).textContent = formatCurrency(cp.price * cp.quantity);
}



  function findFirstEmptyRowIndex(){
    const rows = document.querySelectorAll('#product-grid-body .product-row');
    for(let i=0;i<rows.length;i++){
      const idx = i+1;
      const sel = document.getElementById(`product-${idx}`);
      if(!sel || !sel.value) return idx;
    }
    return null;
  }


/**
 * ==========================================
 * COMPLETE SALE - SAFE VERSION WITH AUTO-RELOAD
 * ==========================================
 */
async function completeSale() {
  const user = window.auth.currentUser;
  if (!user) {
    alert('Please sign in first');
    return;
  }
  
  // Collect valid sale items from the form
  const saleItems = [];
  const rows = document.querySelectorAll('#product-grid-body .product-row');
  const saleId = 'SALE_' + Date.now().toString(36);
  
  rows.forEach((r, i) => {
    const idx = i + 1;
    const sel = document.getElementById(`product-${idx}`);
    const qtyEl = document.getElementById(`qty-${idx}`);
    
    if (!sel || !sel.value || !qtyEl || !qtyEl.value || Number(qtyEl.value) <= 0) {
      return;
    }
    
    const productId = sel.value;
    const quantity = Number(qtyEl.value);
    const unitPrice = Number(document.getElementById(`price-${idx}`).value || 0);
    const totalAmount = quantity * unitPrice;
    const size = document.getElementById(`size-${idx}`).value || 'N/A';
    const unitType = document.getElementById(`unit-${idx}`).value || '';
    
    const isCustom = productId.startsWith('CUST_TMP_');
    let productName = '';
    
    if (isCustom) {
      const cp = customProductsInSale.find(c => c.tempId === productId);
      productName = cp ? cp.name : 'Custom Product';
    } else {
      const prod = cachedProducts.find(p => p.id === productId);
      productName = prod ? prod.name : 'Unknown Product';
    }
    
    saleItems.push({
      saleId: saleId,
      productId: isCustom ? '' : productId,
      productName: productName,
      size: size,
      quantity: quantity,
      unitType: unitType,
      unitPrice: unitPrice,
      totalAmount: totalAmount,
      isCustomProduct: isCustom
    });
  });
  
  // Validation
  if (saleItems.length === 0) {
    alert('⚠️ No products selected. Please add at least one product to complete the sale.');
    return;
  }
  
  const totalAmount = saleItems.reduce((sum, item) => sum + item.totalAmount, 0);
  
  if (!confirm(`📦 Complete sale with ${saleItems.length} item(s)?\n\nTotal: ${formatCurrency(totalAmount)}`)) {
    return;
  }
  
  console.log(`✅ Sale confirmed: ${saleItems.length} items, total ${formatCurrency(totalAmount)}`);
  
  // ==========================================
  // ✅ STEP 1: INSTANT UI UPDATES (< 100ms)
  // ==========================================
  
  saleItems.forEach(item => {
    const newSale = {
      id: generateId(),
      saleId: item.saleId,
      productId: item.productId,
      productName: item.productName,
      size: item.size,
      quantity: item.quantity,
      unitType: item.unitType,
      unitPrice: item.unitPrice,
      totalAmount: item.totalAmount,
      date: new Date().toISOString(),
      isCustomProduct: item.isCustomProduct,
      userId: user.uid
    };
    cachedSales.unshift(newSale);
    
    // Update stock locally (for non-custom products)
    if (!item.isCustomProduct && item.productId) {
      const prod = cachedProducts.find(p => p.id === item.productId);
      if (prod) {
        prod.stock = Math.max(0, prod.stock - item.quantity);
      }
    }
  });
  
  // Re-render UI immediately
  try {
    renderProducts();
  } catch (e) {
    console.error('❌ Failed to render products:', e.message);
  }
  
  try {
    renderSales();
  } catch (e) {
    console.error('❌ Failed to render sales:', e.message);
  }
  
  try {
    updateSummaryFromCache();
  } catch (e) {
    console.error('❌ Failed to update summary:', e.message);
  }
  
  // Close modal immediately
  const modal = bootstrap.Modal.getInstance(document.getElementById('salesModal'));
  if (modal) modal.hide();
  
  // Reset custom products array
  customProductsInSale = [];
  
  // Show success toast notification
  showSuccessToast(`✅ Sale completed! ${saleItems.length} item(s) recorded.`);
  
  console.log(`✅ UI updated instantly - ${saleItems.length} items displayed`);
  
  // ==========================================
  // 🔄 STEP 2: BACKGROUND SAVE TO FIRESTORE
  // ==========================================
  
  (async () => {
    try {
      const { collection, addDoc, doc, updateDoc, getDoc } = window.firebaseImports;
      const salesRef = collection(window.db, 'tenants', user.uid, 'sales');
      
      // ✅ Save each sale item to Firestore
      console.log('📤 Saving sales to Firestore...');
      
      const savePromises = saleItems.map(item => {
        return addDoc(salesRef, {
          ...item,
          date: new Date().toISOString(), // ✅ Ensure date field
          createdAt: new Date().toISOString(),
          userId: user.uid
        });
      });
      
      await Promise.all(savePromises);
      
      console.log(`✅ ${saleItems.length} sales saved to Firestore`);
      
      // ✅ Update product stock in Firestore (SAFE VERSION)
      console.log('📦 Updating product stock in Firestore...');
      
      for (const item of saleItems) {
        if (!item.isCustomProduct && item.productId) {
          try {
            // ✅ Check if product exists first
            const productRef = doc(window.db, 'tenants', user.uid, 'products', item.productId);
            const productSnap = await getDoc(productRef);
            
            if (productSnap.exists()) {
              const prod = cachedProducts.find(p => p.id === item.productId);
              if (prod) {
                await updateDoc(productRef, {
                  stock: Math.max(0, prod.stock), // Don't go negative
                  updatedAt: new Date().toISOString()
                });
                console.log(`✅ Stock updated for ${item.productId}`);
              }
            } else {
              console.warn(`⚠️ Product ${item.productId} not found, skipping stock update`);
            }
          } catch (stockError) {
            console.warn(`⚠️ Could not update stock for ${item.productId}:`, stockError.message);
            // ✅ Continue with other products
          }
        }
      }
      
      console.log('✅ Product stock updated in Firestore');
      
      // ✅ AUTO-RELOAD RECENT SALES (for homepage)
      setTimeout(() => {
        if (typeof loadRecentSales === 'function') {
          loadRecentSales();
          console.log('✅ Recent sales reloaded');
        }
      }, 500);
      
      console.log('✅ 1 sales saved to Firestore in background');
      
    } catch (error) {
      console.error('❌ Background save error:', error.message);
      // ✅ Show subtle warning but don't block user
      showWarningToast('⚠️ Sale saved locally, syncing in background...');
    }
  })(); // ✅ IIFE - runs in background without blocking UI
}


    // ==========================================
// SUCCESS TOAST NOTIFICATION
// ==========================================

function showSuccessToast(message) {
  // Remove existing toast if any
  const existingToast = document.getElementById('successToast');
  if (existingToast) {
    existingToast.remove();
  }
  
  // Create toast element
  const toast = document.createElement('div');
  toast.id = 'successToast';
  toast.className = 'toast-notification';
  toast.innerHTML = `
    <div class="d-flex align-items-center">
      <i class="bi bi-check-circle-fill text-success me-2" style="font-size: 1.5rem;"></i>
      <div>${message}</div>
    </div>
  `;
  
  document.body.appendChild(toast);
  
  // Show toast
  setTimeout(() => {
    toast.classList.add('show');
  }, 100);
  
  // Hide after 3 seconds
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => {
      toast.remove();
    }, 300);
  }, 3000);
}

  
  


  



/**
 * ==========================================
 * STOCK STATUS SELECTION SYSTEM (FRONTEND)
 * ==========================================
 */

let selectedStockStatus = '';

/**
 * Select stock status (Good/Medium/Low/Urgent)
 */
function selectStockStatus(status) {
  console.log('📊 Selected stock status:', status);
  
  selectedStockStatus = status;
  document.getElementById('selectedStockStatus').value = status;
  
  // Clear exact quantity when status selected
  document.getElementById('productCurrentStock').value = '';
  
  // Update button styling
  document.querySelectorAll('.stock-btn').forEach(btn => {
    btn.style.border = '2px solid transparent';
    btn.style.opacity = '0.7';
  });
  
  // Highlight selected button
  const selectedBtn = document.getElementById(`stockBtn-${status}`);
  if (selectedBtn) {
    selectedBtn.style.border = '2px solid white';
    selectedBtn.style.opacity = '1';
  }
}



    /**
 * Stock Status Selection Handler
 */
function selectStockStatus(status) {
  console.log('📊 Selected stock status:', status);
  
  selectedStockStatus = status;
  document.getElementById('selectedStockStatus').value = status;
  
  // Clear exact quantity when status selected
  document.getElementById('productCurrentStock').value = '';
  
  // Update button styling
  document.querySelectorAll('.stock-btn').forEach(btn => {
    btn.style.border = '2px solid transparent';
    btn.style.opacity = '0.7';
  });
  
  // Highlight selected button
  const selectedBtn = document.getElementById(`stockBtn-${status}`);
  if (selectedBtn) {
    selectedBtn.style.border = '2px solid white';
    selectedBtn.style.opacity = '1';
  }
  
  console.log('✅ Stock status set to:', status);
}

/**
 * Get stock data before saving
 */
/**
 * Get stock status - can be from buttons OR exact quantity
 */
/**
 * Get stock data - MANDATORY: user must choose either exact quantity OR status
 */
function getStockData() {
  const statusSelected = document.getElementById('selectedStockStatus')?.value || '';
  const exactStockInput = document.getElementById('productCurrentStock')?.value || '';
  
  console.log('🔍 getStockData called');
  console.log('📊 Status selected:', statusSelected);
  console.log('📊 Exact stock input:', exactStockInput);
  
  // ✅ CHECK 1: If exact number entered, use it
  if (exactStockInput && exactStockInput.trim() !== '') {
    const exactStock = parseInt(exactStockInput);
    
    if (!isNaN(exactStock) && exactStock >= 0) {
      console.log('✅ Using exact stock:', exactStock);
      return {
        stockStatus: 'exact',
        stockValue: exactStock
      };
    } else {
      alert('⚠️ Invalid stock quantity. Please enter a valid number (0 or greater).');
      return null;
    }
  }
  
  // ✅ CHECK 2: If status button selected, use it
  if (statusSelected && ['good', 'medium', 'low', 'urgent'].includes(statusSelected)) {
    console.log('✅ Using status:', statusSelected);
    return {
      stockStatus: statusSelected,
      stockValue: null
    };
  }
  
  // ❌ ERROR: User didn't choose anything
  alert('⚠️ Stock information required!\n\nPlease either:\n1️⃣ Enter an exact quantity (e.g., 30)\n2️⃣ OR select a status (Good/Medium/Low/Urgent)');
  return null;
}




/**
 * ==========================================
 * HELPER FUNCTIONS - STOCK DISPLAY
 * ==========================================
 */

/**
 * Parse stock data from product (handles new & old formats)
 */
function parseProductStockData(product) {
  // ✅ NEW: Column J has TEXT status directly
  const stockText = (product.stock || 'MEDIUM').toString().toUpperCase();
  
  if (['GOOD', 'MEDIUM', 'LOW', 'URGENT'].includes(stockText)) {
    return {
      stockStatus: stockText.toLowerCase(),
      stockValue: 0,
      displayStatus: stockText.toLowerCase()
    };
  }
  
  // Fallback
  return { stockStatus: 'medium', stockValue: 0, displayStatus: 'medium' };
}



    
/**
 * Convert stock status to display badge
 */
function getStockBadge(stockStatus, stockValue) {
  if (stockStatus === 'exact' && stockValue) {
    return { 
      icon: '📦', 
      text: `In Stock (${stockValue})`, 
      color: '#17a2b8',
      bgColor: '#d1ecf1'
    };
  }
  
  const badges = {
    'good': { 
      icon: '🟢', 
      text: 'Good Stock', 
      color: '#155724', 
      bgColor: '#d4edda' 
    },
    'medium': { 
      icon: '🟡', 
      text: 'Medium Stock', 
      color: '#856404', 
      bgColor: '#fff3cd' 
    },
    'low': { 
      icon: '🔴', 
      text: 'Low Stock', 
      color: '#721c24', 
      bgColor: '#f8d7da' 
    },
    'urgent': { 
      icon: '🔵', 
      text: 'Urgent', 
      color: '#664399', 
      bgColor: '#e2d5f0' 
    }
  };
  
  return badges[stockStatus] || { 
    icon: '⚪', 
    text: 'Unknown', 
    color: '#6c757d',
    bgColor: '#e2e3e5'
  };
}

/**
 * Reset stock selection when opening modal
 */
function resetStockSelection() {
  selectedStockStatus = '';
  document.getElementById('selectedStockStatus').value = '';
  document.getElementById('productCurrentStock').value = '';
  document.querySelectorAll('.stock-btn').forEach(btn => {
    btn.style.border = '2px solid transparent';
    btn.style.opacity = '0.7';
  });
}







/**
 * ==========================================
 * COMPLETE BACKUP - DOWNLOAD ONLY (FIXED)
 * ==========================================
 */

/**
 * Download complete backup (ALL DATA)
 */
 async function sendBackupEmail() {
  console.log('📧 Creating complete backup...');
  
  // Get button (try both desktop and mobile, or use event target)
  const button = document.getElementById('backupButton') || 
                 document.getElementById('backupButtonMobile') ||
                 event?.target?.closest('button');
  
  const originalButtonHTML = button ? button.innerHTML : '';
  
  try {
    // Disable button if found
    if (button) {
      button.disabled = true;
      button.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creating backup...';
    }
    
    // Show loading indicator
    console.log('⏳ Starting backup process...');
    
    // Get current user
    const user = window.auth?.currentUser;
    if (!user) {
      alert('⚠️ Please sign in first to create a backup.');
      if (button) {
        button.disabled = false;
        button.innerHTML = originalButtonHTML;
      }
      return;
    }
    
    const userId = user.uid;
    const userEmail = user.email;
    
    console.log('✅ User authenticated:', userEmail);
    console.log('📥 Fetching all data...');
    
    // Get Firebase functions
    const { collection, getDocs } = window.firebaseImports;
    
    // ✅ Fetch ALL collections with progress updates
    console.log('📥 [1/6] Fetching brands...');
    const brandsRef = collection(window.db, 'tenants', userId, 'brands');
    const brandsSnapshot = await getDocs(brandsRef);
    
    console.log('📥 [2/6] Fetching invoices...');
    const invoicesRef = collection(window.db, 'tenants', userId, 'invoices');
    const invoicesSnapshot = await getDocs(invoicesRef);
    
    console.log('📥 [3/6] Fetching productGroups...');
    const productGroupsRef = collection(window.db, 'tenants', userId, 'productGroups');
    const productGroupsSnapshot = await getDocs(productGroupsRef);
    
    console.log('📥 [4/6] Fetching products...');
    const productsRef = collection(window.db, 'tenants', userId, 'products');
    const productsSnapshot = await getDocs(productsRef);
    
    console.log('📥 [5/6] Fetching purchases...');
    const purchasesRef = collection(window.db, 'tenants', userId, 'purchases');
    const purchasesSnapshot = await getDocs(purchasesRef);
    
    console.log('📥 [6/6] Fetching sales...');
    const salesRef = collection(window.db, 'tenants', userId, 'sales');
    const salesSnapshot = await getDocs(salesRef);
    
    // Build complete backup data
    const backupData = {
      version: '1.0',
      generatedAt: new Date().toISOString(),
      generatedBy: userEmail,
      tenantId: userId,
      brands: [],
      invoices: [],
      productGroups: [],
      products: [],
      purchases: [],
      sales: []
    };
    
    // Extract brands
    brandsSnapshot.forEach(doc => {
      backupData.brands.push({ id: doc.id, ...doc.data() });
    });
    
    // Extract invoices
    invoicesSnapshot.forEach(doc => {
      backupData.invoices.push({ id: doc.id, ...doc.data() });
    });
    
    // Extract productGroups
    productGroupsSnapshot.forEach(doc => {
      backupData.productGroups.push({ id: doc.id, ...doc.data() });
    });
    
    // Extract products
    productsSnapshot.forEach(doc => {
      backupData.products.push({ id: doc.id, ...doc.data() });
    });
    
    // Extract purchases
    purchasesSnapshot.forEach(doc => {
      backupData.purchases.push({ id: doc.id, ...doc.data() });
    });
    
    // Extract sales
    salesSnapshot.forEach(doc => {
      backupData.sales.push({ id: doc.id, ...doc.data() });
    });
    
    console.log('✅ Complete data collected:', {
      brands: backupData.brands.length,
      invoices: backupData.invoices.length,
      productGroups: backupData.productGroups.length,
      products: backupData.products.length,
      purchases: backupData.purchases.length,
      sales: backupData.sales.length
    });
    
    // Create JSON file
    const backupJSON = JSON.stringify(backupData, null, 2);
    const blob = new Blob([backupJSON], { type: 'application/json' });
    const today = new Date().toISOString().split('T')[0];
    const timestamp = new Date().toTimeString().slice(0, 5).replace(':', '-');
    const filename = `TileInventory_Backup_${userEmail.replace('@', '_at_')}_${today}_${timestamp}.json`;
    
    // Download file
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    console.log('✅ Backup file downloaded:', filename);
    
    // Calculate total items
    const totalItems = 
      backupData.brands.length + 
      backupData.invoices.length + 
      backupData.productGroups.length + 
      backupData.products.length + 
      backupData.purchases.length + 
      backupData.sales.length;
    
    // ✅ Success message
    alert(
      '✅ Backup Downloaded Successfully!\n\n' +
      `📁 File: ${filename}\n\n` +
      '📊 Data Summary:\n' +
      `🏷️  Brands: ${backupData.brands.length}\n` +
      `🧾 Invoices: ${backupData.invoices.length}\n` +
      `📁 Product Groups: ${backupData.productGroups.length}\n` +
      `📦 Products: ${backupData.products.length}\n` +
      `🛒 Purchases: ${backupData.purchases.length}\n` +
      `💰 Sales: ${backupData.sales.length}\n\n` +
      `✅ Total: ${totalItems} items backed up\n\n` +
      '💾 Backup saved to your Downloads folder!'
    );
    
    // Reset button
    if (button) {
      button.disabled = false;
      button.innerHTML = originalButtonHTML;
    }
    
  } catch (error) {
    console.error('❌ Backup error:', error);
    console.error('Error details:', error.stack);
    
    // User-friendly error message
    let errorMessage = 'Backup failed. ';
    
    if (error.message.includes('auth')) {
      errorMessage += 'Please sign in and try again.';
    } else if (error.message.includes('permission')) {
      errorMessage += 'Permission denied. Check your access rights.';
    } else if (error.message.includes('network')) {
      errorMessage += 'Network error. Check your internet connection.';
    } else {
      errorMessage += error.message;
    }
    
    alert('❌ ' + errorMessage);
    
    // Reset button
    if (button) {
      button.disabled = false;
      button.innerHTML = originalButtonHTML;
    }
  }
}

console.log('✅ Backup function loaded');



/**
 * ==========================================
 * RESTORE WITH PASSWORD VERIFICATION
 * ==========================================
 */

/**
 * Handle restore file selection - Now asks for password first
 */
function handleRestoreFile(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  console.log('📂 File selected:', file.name);
  
  // Validate file type
  if (!file.name.endsWith('.json')) {
    alert('❌ Invalid file type. Please select a JSON backup file.');
    return;
  }
  
  // ✅ Ask for password BEFORE reading file
  showPasswordVerificationDialog(file);
  
  // Reset file input
  event.target.value = '';
}

/**
 * Show password verification dialog
 */
function showPasswordVerificationDialog(file) {
  // Get current user
  const user = window.auth?.currentUser;
  if (!user) {
    alert('Please sign in first');
    return;
  }
  
  const userEmail = user.email;
  
  // Create password prompt
  const password = prompt(
    `🔐 Password Verification Required\n\n` +
    `To restore backup, please enter your current password for:\n` +
    `${userEmail}\n\n` +
    `Enter password:`
  );
  
  // User cancelled
  if (password === null) {
    console.log('❌ Restore cancelled by user');
    return;
  }
  
  // User entered empty password
  if (password.trim() === '') {
    alert('❌ Password cannot be empty');
    return;
  }
  
  // Verify password and proceed
  verifyPasswordAndRestore(password, file);
}

/**
 * Verify password with Firebase Auth
 */
async function verifyPasswordAndRestore(password, file) {
  console.log('🔐 Verifying password...');
  
  try {
    const user = window.auth?.currentUser;
    if (!user) {
      alert('Please sign in first');
      return;
    }
    
    // Get Firebase auth functions
    const { EmailAuthProvider, reauthenticateWithCredential } = window.firebaseImports;
    
    // Create credential
    const credential = EmailAuthProvider.credential(user.email, password);
    
    // Show loading
    const restoreButton = document.getElementById('restoreButton');
    if (restoreButton) {
      restoreButton.disabled = true;
      restoreButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Verifying...';
    }
    
    // ✅ Verify password by re-authenticating
    await reauthenticateWithCredential(user, credential);
    
    console.log('✅ Password verified successfully');
    
    // Password correct - proceed with restore
    proceedWithRestore(file);
    
  } catch (error) {
    console.error('❌ Password verification failed:', error);
    
    // Reset button
    const restoreButton = document.getElementById('restoreButton');
    if (restoreButton) {
      restoreButton.disabled = false;
      restoreButton.innerHTML = '<i class="bi bi-cloud-upload"></i> Restore';
    }
    
    // Show error message
    if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
      alert('❌ Incorrect password. Restore cancelled.');
    } else if (error.code === 'auth/too-many-requests') {
      alert('❌ Too many failed attempts. Please try again later.');
    } else {
      alert('❌ Password verification failed: ' + error.message);
    }
  }
}

/**
 * Proceed with restore after password verification
 */
function proceedWithRestore(file) {
  console.log('📂 Reading backup file...');
  
  const reader = new FileReader();
  
  reader.onload = function(e) {
    try {
      const backupData = JSON.parse(e.target.result);
      console.log('✅ Backup file parsed successfully');
      
      // Validate backup data
      if (!validateBackupData(backupData)) {
        alert('❌ Invalid backup file format. Please select a valid backup file.');
        
        // Reset button
        const restoreButton = document.getElementById('restoreButton');
        if (restoreButton) {
          restoreButton.disabled = false;
          restoreButton.innerHTML = '<i class="bi bi-cloud-upload"></i> Restore';
        }
        return;
      }
      
      // Show confirmation dialog
      showRestoreConfirmation(backupData);
      
    } catch (error) {
      console.error('❌ Error parsing backup file:', error);
      alert('❌ Failed to read backup file. Please ensure it\'s a valid JSON file.');
      
      // Reset button
      const restoreButton = document.getElementById('restoreButton');
      if (restoreButton) {
        restoreButton.disabled = false;
        restoreButton.innerHTML = '<i class="bi bi-cloud-upload"></i> Restore';
      }
    }
  };
  
  reader.onerror = function() {
    alert('❌ Failed to read file. Please try again.');
    
    // Reset button
    const restoreButton = document.getElementById('restoreButton');
    if (restoreButton) {
      restoreButton.disabled = false;
      restoreButton.innerHTML = '<i class="bi bi-cloud-upload"></i> Restore';
    }
  };
  
  reader.readAsText(file);
}

/**
 * Validate backup data structure (ALL COLLECTIONS)
 */
function validateBackupData(data) {
  console.log('🔍 Validating complete backup data...');
  
  if (!data || typeof data !== 'object') {
    console.error('❌ Data is not an object');
    return false;
  }
  
  if (!data.tenantId || !data.generatedBy) {
    console.error('❌ Missing tenant info');
    return false;
  }
  
  // Check all collections exist and are arrays
  const collections = ['brands', 'invoices', 'productGroups', 'products', 'purchases', 'sales'];
  
  for (const collectionName of collections) {
    if (!Array.isArray(data[collectionName])) {
      console.error(`❌ ${collectionName} is not an array`);
      return false;
    }
  }
  
  console.log('✅ Complete backup data is valid');
  console.log('   Collections:', {
    brands: data.brands.length,
    invoices: data.invoices.length,
    productGroups: data.productGroups.length,
    products: data.products.length,
    purchases: data.purchases.length,
    sales: data.sales.length
  });
  
  return true;
}

/**
 * Show restore confirmation dialog (ALL COLLECTIONS)
 */
function showRestoreConfirmation(backupData) {
  const totalItems = 
    (backupData.brands?.length || 0) +
    (backupData.invoices?.length || 0) +
    (backupData.productGroups?.length || 0) +
    (backupData.products?.length || 0) +
    (backupData.purchases?.length || 0) +
    (backupData.sales?.length || 0);
  
  const message = 
    `📦 Restore Complete Backup?\n\n` +
    `Backup Information:\n` +
    `• Generated: ${new Date(backupData.generatedAt).toLocaleString('en-IN')}\n` +
    `• From: ${backupData.generatedBy}\n\n` +
    `Data to Restore:\n` +
    `• 🏷️ Brands: ${backupData.brands?.length || 0}\n` +
    `• 🧾 Invoices: ${backupData.invoices?.length || 0}\n` +
    `• 📁 Product Groups: ${backupData.productGroups?.length || 0}\n` +
    `• 📦 Products: ${backupData.products?.length || 0}\n` +
    `• 🛒 Purchases: ${backupData.purchases?.length || 0}\n` +
    `• 💰 Sales: ${backupData.sales?.length || 0}\n` +
    `━━━━━━━━━━━━━━━━━━━━━━\n` +
    `📊 Total: ${totalItems} items\n\n` +
    `⚠️ WARNING: This will ADD new items and UPDATE existing ones.\n` +
    `Existing data will NOT be deleted.\n\n` +
    `Do you want to continue?`;
  
  if (confirm(message)) {
    restoreBackupData(backupData);
  } else {
    console.log('❌ Restore cancelled by user');
    
    // Reset button
    const restoreButton = document.getElementById('restoreButton');
    if (restoreButton) {
      restoreButton.disabled = false;
      restoreButton.innerHTML = '<i class="bi bi-cloud-upload"></i> Restore';
    }
  }
}

/**
 * ==========================================
 * COMPLETE RESTORE - ALL COLLECTIONS
 * ==========================================
 */

/**
 * Restore complete backup data to Firestore
 */
async function restoreBackupData(backupData) {
  console.log('🔄 Starting complete restore process...');
  
  const restoreButton = document.getElementById('restoreButton');
  
  try {
    // Update button
    if (restoreButton) {
      restoreButton.disabled = true;
      restoreButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Restoring...';
    }
    
    // Get current user
    const user = window.auth?.currentUser;
    if (!user) {
      alert('Please sign in first');
      return;
    }
    
    const userId = user.uid;
    const userEmail = user.email;
    
    // Security check
    if (backupData.generatedBy !== userEmail) {
      const confirmRestore = confirm(
        `⚠️ WARNING:\n\n` +
        `This backup was created by: ${backupData.generatedBy}\n` +
        `You are signed in as: ${userEmail}\n\n` +
        `Are you sure you want to restore this backup?`
      );
      
      if (!confirmRestore) {
        console.log('❌ Restore cancelled - different user');
        if (restoreButton) {
          restoreButton.disabled = false;
          restoreButton.innerHTML = '<i class="bi bi-cloud-upload"></i> Restore';
        }
        return;
      }
    }
    
    // Get Firebase functions
    const { doc, setDoc } = window.firebaseImports;
    
    let successCount = 0;
    let errorCount = 0;
    
    // ✅ Restore Brands
    console.log('🏷️ Restoring brands...');
    if (backupData.brands && Array.isArray(backupData.brands)) {
      for (const brand of backupData.brands) {
        try {
          const brandRef = doc(window.db, 'tenants', userId, 'brands', brand.id);
          await setDoc(brandRef, brand);
          successCount++;
          console.log(`✅ Restored brand: ${brand.name || brand.id}`);
        } catch (error) {
          console.error(`❌ Failed to restore brand:`, error);
          errorCount++;
        }
      }
    }
    
    // ✅ Restore Invoices
    console.log('🧾 Restoring invoices...');
    if (backupData.invoices && Array.isArray(backupData.invoices)) {
      for (const invoice of backupData.invoices) {
        try {
          const invoiceRef = doc(window.db, 'tenants', userId, 'invoices', invoice.id);
          await setDoc(invoiceRef, invoice);
          successCount++;
          console.log(`✅ Restored invoice: ${invoice.id}`);
        } catch (error) {
          console.error(`❌ Failed to restore invoice:`, error);
          errorCount++;
        }
      }
    }
    
    // ✅ Restore Product Groups
    console.log('📁 Restoring product groups...');
    if (backupData.productGroups && Array.isArray(backupData.productGroups)) {
      for (const group of backupData.productGroups) {
        try {
          const groupRef = doc(window.db, 'tenants', userId, 'productGroups', group.id);
          await setDoc(groupRef, group);
          successCount++;
          console.log(`✅ Restored product group: ${group.name || group.id}`);
        } catch (error) {
          console.error(`❌ Failed to restore product group:`, error);
          errorCount++;
        }
      }
    }
    
    // ✅ Restore Products
    console.log('📦 Restoring products...');
    if (backupData.products && Array.isArray(backupData.products)) {
      for (const product of backupData.products) {
        try {
          const productRef = doc(window.db, 'tenants', userId, 'products', product.id);
          await setDoc(productRef, product);
          successCount++;
          console.log(`✅ Restored product: ${product.name || product.id}`);
        } catch (error) {
          console.error(`❌ Failed to restore product:`, error);
          errorCount++;
        }
      }
    }
    
    // ✅ Restore Purchases
    console.log('🛒 Restoring purchases...');
    if (backupData.purchases && Array.isArray(backupData.purchases)) {
      for (const purchase of backupData.purchases) {
        try {
          const purchaseRef = doc(window.db, 'tenants', userId, 'purchases', purchase.id);
          await setDoc(purchaseRef, purchase);
          successCount++;
          console.log(`✅ Restored purchase: ${purchase.id}`);
        } catch (error) {
          console.error(`❌ Failed to restore purchase:`, error);
          errorCount++;
        }
      }
    }
    
    // ✅ Restore Sales
    console.log('💰 Restoring sales...');
    if (backupData.sales && Array.isArray(backupData.sales)) {
      for (const sale of backupData.sales) {
        try {
          const saleRef = doc(window.db, 'tenants', userId, 'sales', sale.id);
          await setDoc(saleRef, sale);
          successCount++;
          console.log(`✅ Restored sale: ${sale.id}`);
        } catch (error) {
          console.error(`❌ Failed to restore sale:`, error);
          errorCount++;
        }
      }
    }
    
    console.log('✅ Complete restore finished!');
    console.log(`   - Success: ${successCount}`);
    console.log(`   - Errors: ${errorCount}`);
    
    // Show success message
    const totalExpected = 
      (backupData.brands?.length || 0) +
      (backupData.invoices?.length || 0) +
      (backupData.productGroups?.length || 0) +
      (backupData.products?.length || 0) +
      (backupData.purchases?.length || 0) +
      (backupData.sales?.length || 0);
    
    alert(
      `✅ Restore Complete!\n\n` +
      `Successfully restored:\n` +
      `🏷️ Brands: ${backupData.brands?.length || 0}\n` +
      `🧾 Invoices: ${backupData.invoices?.length || 0}\n` +
      `📁 Product Groups: ${backupData.productGroups?.length || 0}\n` +
      `📦 Products: ${backupData.products?.length || 0}\n` +
      `🛒 Purchases: ${backupData.purchases?.length || 0}\n` +
      `💰 Sales: ${backupData.sales?.length || 0}\n\n` +
      `📊 Total: ${successCount} of ${totalExpected} items\n` +
      `${errorCount > 0 ? `⚠️ ${errorCount} items failed\n` : ''}` +
      `\n✅ Page will refresh in 2 seconds...`
    );
    
    // Reload page to show restored data
    setTimeout(() => {
      location.reload();
    }, 2000);
    
  } catch (error) {
    console.error('❌ Restore error:', error);
    alert('❌ Restore failed: ' + error.message);
    
    if (restoreButton) {
      restoreButton.disabled = false;
      restoreButton.innerHTML = '<i class="bi bi-cloud-upload"></i> Restore';
    }
  }
}

console.log('✅ Backup & Restore System Loaded');




/**
 * ==========================================
 * SEARCH PRODUCTS - NAME ONLY WITH PRIORITY
 * ==========================================
 * Priority 1: Products starting with search term
 * Priority 2: Products containing search term
 */
 function searchProducts() {
    const searchInput = document.getElementById('productSearch');
    
    if (!searchInput) {
        console.error('❌ Search input not found');
        return;
    }
    
    const searchTerm = searchInput.value.toLowerCase().trim();
    
    // If empty, display all products
    if (!searchTerm) {
        displayAllProducts();
        return;
    }
    
    // ✅ Filter products by name ONLY
    const filteredProducts = cachedProducts.filter(product => {
        const name = (product.name || '').toLowerCase();
        return name.includes(searchTerm);
    });
    
    // ✅ Sort by priority:
    // 1. Products starting with search term (highest priority)
    // 2. Products containing search term (lower priority)
    const sortedProducts = filteredProducts.sort((a, b) => {
        const nameA = (a.name || '').toLowerCase();
        const nameB = (b.name || '').toLowerCase();
        
        const aStartsWith = nameA.startsWith(searchTerm);
        const bStartsWith = nameB.startsWith(searchTerm);
        
        // If A starts with term but B doesn't, A comes first
        if (aStartsWith && !bStartsWith) return -1;
        
        // If B starts with term but A doesn't, B comes first
        if (!aStartsWith && bStartsWith) return 1;
        
        // If both start (or both don't start), maintain alphabetical order
        return nameA.localeCompare(nameB);
    });
    
    console.log(`🔍 Search: "${searchTerm}" - Found ${sortedProducts.length} products (name only)`);
    
    // Display filtered and sorted products
    displayProducts(sortedProducts);
}
/**
 * ==========================================
 * DISPLAY PRODUCTS - DESKTOP & MOBILE (HIDE EMPTY FIELDS)
 * ==========================================
 */
 function displayProducts(products) {
    const tbody = document.getElementById('productsTableBody');
   
    if (!tbody) {
        console.error('❌ Products table body not found');
        return;
    }
   
    // Show "no products" message if empty
    if (!products || products.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-4 text-muted">
                    <i class="bi bi-search" style="font-size: 3rem; opacity: 0.3;"></i>
                    <p class="mb-0 mt-2">No products found matching your search</p>
                    <button class="btn btn-sm btn-outline-primary mt-2" onclick="displayAllProducts()">
                        <i class="bi bi-arrow-clockwise"></i> Show All Products
                    </button>
                </td>
            </tr>
        `;
       
        // Clear mobile list too
        const mobileContainer = document.getElementById('mobileProductsList');
        if (mobileContainer) {
            mobileContainer.innerHTML = `
                <div class="mobile-item text-center text-muted">
                    <i class="bi bi-search" style="font-size: 2.5rem; opacity: 0.3;"></i>
                    <p class="mb-0 mt-2">No products found</p>
                    <button class="btn btn-sm btn-outline-primary mt-2" onclick="displayAllProducts()">
                        <i class="bi bi-arrow-clockwise"></i> Show All
                    </button>
                </div>
            `;
        }
       
        return;
    }
   
    // ✅ DESKTOP TABLE
    let html = '';
    products.forEach(product => {
        const stockBadge = stockBadgeHtml(product.stock, product.minStock);
       
        // Product photo or placeholder
        const photoHtml = product.imageUrl
            ? `<img src="${product.imageUrl}" alt="${escapeHtml(product.name)}"
                    style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"
                    onclick="viewProductImage('${product.imageUrl}')">`
            : `<div style="width: 60px; height: 60px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <i class="bi bi-image" style="font-size: 1.8rem; color: white;"></i>
               </div>`;
       
        // ✅ Conditional field display
        const categoryDisplay = shouldDisplayField(product.category) 
            ? escapeHtml(product.category) 
            : '<span class="text-muted">-</span>';
        
        const brandDisplay = shouldDisplayField(product.brand) 
            ? escapeHtml(product.brand) 
            : '<span class="text-muted">-</span>';
        
        const sizeDisplay = shouldDisplayField(product.size) 
            ? `<strong>${escapeHtml(product.size)}</strong>` 
            : '<span class="text-muted">-</span>';
        
        // ✅ Price and unit type - only show if price has value
        let priceDisplay = '<span class="text-muted">-</span>';
        if (shouldDisplayField(product.price, 'price')) {
            const unitType = shouldDisplayField(product.unitType) ? product.unitType : '';
            priceDisplay = `<strong>₹${parseFloat(product.price).toFixed(2)}</strong>${unitType ? '/' + unitType : ''}`;
        }
       
        html += `
            <tr data-product-id="${product.id}">
                <td>${photoHtml}</td>
                <td><strong>${escapeHtml(product.name)}</strong></td>
                <td>${categoryDisplay}</td>
                <td>${brandDisplay}</td>
                <td>${sizeDisplay}</td>
                <td>${stockBadge}</td>
                <td>${priceDisplay}</td>
                <td>
                    <button class="btn btn-sm btn-primary btn-action-sm me-1" onclick="editProduct('${product.id}')">
                        <i class="bi bi-pencil"></i> Edit
                    </button>
                    <button class="btn btn-sm btn-danger btn-action-sm" onclick="deleteProduct('${product.id}')">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </td>
            </tr>
        `;
    });
   
    tbody.innerHTML = html;
   
    // ✅ MOBILE LIST
    const mobileContainer = document.getElementById('mobileProductsList');
    if (!mobileContainer) {
        console.warn('⚠️ Mobile products list container not found');
        return;
    }
   
    let mobileHtml = '';
    products.forEach(p => {
        const stockBadge = stockBadgeHtml(p.stock, p.minStock);
       
        // Mobile photo
        const mobilePhoto = p.imageUrl
            ? `<img src="${p.imageUrl}" alt="${escapeHtml(p.name)}"
                    style="width: 70px; height: 70px; object-fit: cover; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); cursor: pointer;"
                    onclick="viewProductImage('${p.imageUrl}')">`
            : `<div style="width: 70px; height: 70px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
                <i class="bi bi-image" style="font-size: 2.2rem; color: white;"></i>
               </div>`;
        
        // ✅ Build product info line (only show non-empty fields)
        let infoLine = [];
        if (shouldDisplayField(p.category)) infoLine.push(escapeHtml(p.category));
        if (shouldDisplayField(p.brand)) infoLine.push(escapeHtml(p.brand));
        const infoLineHTML = infoLine.length > 0 
            ? `<div class="small-muted">${infoLine.join(' • ')}</div>` 
            : '';
        
        // ✅ Size line (only if has value)
        const sizeLineHTML = shouldDisplayField(p.size) 
            ? `<div class="small-muted"><strong>${escapeHtml(p.size)}</strong></div>` 
            : '';
        
        // ✅ Price line (only if has value)
        let priceLineHTML = '';
        if (shouldDisplayField(p.price, 'price')) {
            const unitType = shouldDisplayField(p.unitType) ? p.unitType : '';
            priceLineHTML = `<div style="margin-top:8px;"><strong>₹${parseFloat(p.price).toFixed(2)}</strong>${unitType ? '/' + unitType : ''}</div>`;
        }
       
        mobileHtml += `
            <div class="mobile-item d-flex align-items-start justify-content-between" style="gap: 1rem; position: relative;" data-product-id="${p.id}">
                <!-- Selection Indicator (hidden by default) -->
                <div class="selection-indicator" style="display: none; position: absolute; top: 10px; left: 10px; background: #25D366; color: white; width: 30px; height: 30px; border-radius: 50%; display: none; align-items: center; justify-content: center; font-weight: bold; z-index: 10; box-shadow: 0 2px 8px rgba(37, 211, 102, 0.5);">
                    <i class="bi bi-check" style="font-size: 1.2rem;"></i>
                </div>
               
                <div style="display:flex;gap:1rem;align-items:flex-start;flex:1;">
                    <div style="flex-shrink:0;">
                        ${mobilePhoto}
                    </div>
                    <div style="flex:1;">
                        <div style="font-weight:600;font-size:1rem;margin-bottom:4px;">${escapeHtml(p.name)}</div>
                        ${infoLineHTML}
                        ${sizeLineHTML}
                        ${priceLineHTML}
                        <div style="margin-top:8px;">${stockBadge}</div>
                    </div>
                </div>
                <div style="text-align:right;flex-shrink:0;">
                    <div style="display:flex;flex-direction:column;gap:8px;">
                        <button class="btn btn-sm btn-primary btn-action-sm" onclick="editProduct('${p.id}')" style="white-space:nowrap;">
                            <i class="bi bi-pencil"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-danger btn-action-sm" onclick="deleteProduct('${p.id}')" style="white-space:nowrap;">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
   
    mobileContainer.innerHTML = mobileHtml;
   
    console.log(`✅ Displayed ${products.length} products (empty fields hidden)`);
   
    // ✅ CRITICAL FIX: Re-enable bulk edit selection if active
    if (bulkEditMode.active) {
        console.log('🔄 Re-enabling bulk edit selection after display update');
        enableProductSelection();
    }
}

/**
 * Display all products (WITH CUSTOM ORDER SUPPORT)
 */
function displayAllProducts() {
    if (!cachedProducts || cachedProducts.length === 0) {
        console.warn('⚠️ No products in cache to display');
        displayProducts([]);
        return;
    }
    
    console.log(`📦 Displaying all ${cachedProducts.length} products`);
    
    // ✅ Load custom order from localStorage
    loadProductOrder();
    
    // ✅ Get products in custom order (or default if no custom order)
    const orderedProducts = getOrderedProducts();
    
    console.log(`✅ Products ordered: ${orderedProducts.length} (custom order: ${productOrder.length > 0 ? 'YES' : 'NO'})`);
    
    // Display ordered products
    displayProducts(orderedProducts);
    
    // Clear search input
    const searchInput = document.getElementById('productSearch');
    if (searchInput) {
        searchInput.value = '';
    }
}



    // Open Clear Sales popup
function openClearSalesPopup() {
    // Set default dates (last 30 days to today)
    const today = new Date();
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(today.getDate() - 30);
    
    document.getElementById('clearFromDate').value = formatDateForInput(thirtyDaysAgo);
    document.getElementById('clearToDate').value = formatDateForInput(today);
    
    // Reset count display
    document.getElementById('clearSalesCount').style.display = 'none';
    
    // Add event listeners to count on date change
    document.getElementById('clearFromDate').addEventListener('change', updateClearSalesCount);
    document.getElementById('clearToDate').addEventListener('change', updateClearSalesCount);
    
    // Open modal
    const modal = new bootstrap.Modal(document.getElementById('clearSalesModal'));
    modal.show();
    
    // Initial count
    updateClearSalesCount();
}

// Format date for input field (YYYY-MM-DD)
function formatDateForInput(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// Update count of sales in selected date range
function updateClearSalesCount() {
    const fromDate = new Date(document.getElementById('clearFromDate').value);
    const toDate = new Date(document.getElementById('clearToDate').value);
    
    if (!fromDate || !toDate) return;
    
    if (fromDate > toDate) {
        alert('ÃƒÂ¢Ã‚ÂÃ…â€™ "From Date" cannot be after "To Date"');
        return;
    }
    
    // Count sales in range
    const salesInRange = cachedSales.filter(sale => {
        const saleDate = new Date(sale.date);
        return saleDate >= fromDate && saleDate <= toDate;
    });
    
    // Display count
    const countDiv = document.getElementById('clearSalesCount');
    const countNumber = document.getElementById('salesCountNumber');
    
    countNumber.textContent = salesInRange.length;
    countDiv.style.display = salesInRange.length > 0 ? 'block' : 'none';
}

// Clear sales in date range
function clearSalesInDateRange() {
    const fromDate = new Date(document.getElementById('clearFromDate').value);
    const toDate = new Date(document.getElementById('clearToDate').value);
    
    if (!fromDate || !toDate) {
        alert('ÃƒÂ¢Ã‚ÂÃ…â€™ Please select both From and To dates');
        return;
    }
    
    // Set time to start/end of day for accurate comparison
    fromDate.setHours(0, 0, 0, 0);
    toDate.setHours(23, 59, 59, 999);
    
    if (fromDate > toDate) {
        alert('ÃƒÂ¢Ã‚ÂÃ…â€™ "From Date" cannot be after "To Date"');
        return;
    }
    
    // Find sales in date range
    const salesInRange = cachedSales.filter(sale => {
        const saleDate = new Date(sale.date);
        return saleDate >= fromDate && saleDate <= toDate;
    });
    
    if (salesInRange.length === 0) {
        alert('ÃƒÆ’Ã‚Â¢ÃƒÂ¢Ã¢â€šÂ¬Ã…Â¾Ãƒâ€šÃ‚Â¹ÃƒÆ’Ã‚Â¯Ãƒâ€šÃ‚Â¸Ãƒâ€šÃ‚Â No sales found in the selected date range');
        return;
    }
    
    // Confirm deletion
    const fromStr = fromDate.toLocaleDateString('en-IN');
    const toStr = toDate.toLocaleDateString('en-IN');
    const confirmMsg = `Are you sure you want to hide ${salesInRange.length} sales records between ${fromStr} and ${toStr}?\n\nÃƒÆ’Ã‚Â¢Ãƒâ€¦Ã‚Â¡ ÃƒÆ’Ã‚Â¯Ãƒâ€šÃ‚Â¸Ãƒâ€šÃ‚Â This will hide them from display only.\nGoogle Sheets data remains unchanged.\n\nYou can restore them later by clearing browser data.`;
    
    if (!confirm(confirmMsg)) return;
    
    // ÃƒÆ’Ã‚Â¢Ãƒâ€¦Ã¢â‚¬Å“ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¦ FIX: Store deleted IDs persistently
    salesInRange.forEach(sale => {
        if (sale.id && !deletedSaleIds.includes(sale.id)) {
            deletedSaleIds.push(sale.id);
        }
    });
    
    // Save to localStorage for persistence across sessions and page reloads
    try {
        localStorage.setItem('deletedSaleIds', JSON.stringify(deletedSaleIds));
        console.log('ÃƒÆ’Ã‚Â°Ãƒâ€¦Ã‚Â¸ÃƒÂ¢Ã¢â€šÂ¬Ã¢â€žÂ¢Ãƒâ€šÃ‚Â¾ Saved', deletedSaleIds.length, 'deleted sale IDs to localStorage');
    } catch (e) {
        console.warn('Could not save deletedSaleIds to localStorage', e);
    }
    
    // Filter out sales in the date range
    cachedSales = cachedSales.filter(sale => {
        const saleDate = new Date(sale.date);
        return saleDate < fromDate || saleDate > toDate;
    });
    
    // Update display
    displaySalesFromCache();
    updateSummaryFromCache();
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('clearSalesModal'));
    modal.hide();
    
    // Show success message
    alert(`ÃƒÆ’Ã‚Â¢Ãƒâ€¦Ã¢â‚¬Å“ÃƒÂ¢Ã¢â€šÂ¬Ã‚Â¦ Successfully cleared ${salesInRange.length} sales records!\n\nNote: They're hidden from display only. Google Sheets data is unchanged.\n\nTo restore: Clear browser data or use developer console to run:\nlocalStorage.removeItem('deletedSaleIds')`);
}

function displaySalesFromCache() {
  const salesList = document.getElementById('salesList');
  
  if (cachedSales.length === 0) {
    salesList.innerHTML = `
      <tr>
        <td colspan="5" class="text-center text-muted py-4">
          No sales recorded yet
        </td>
      </tr>
    `;
    return;
  }
  
  salesList.innerHTML = '';
  
  const recentSales = cachedSales.slice(0, 100);
  
  recentSales.forEach(sale => {
    const date = new Date(sale.date);
    
    // ✅ COMPACT FORMAT: "8-Dec 1:07PM" on two lines
    const day = date.getDate();
    const month = date.toLocaleString('en-IN', { month: 'short' });
    const hours = date.getHours();
    const minutes = date.getMinutes().toString().padStart(2, '0');
    const ampm = hours >= 12 ? 'PM' : 'AM';
    const hour12 = hours % 12 || 12;
    
    const formattedDate = `${day}-${month}<br><small>${hour12}:${minutes}${ampm}</small>`;
    
    const row = `
      <tr>
        <td style="line-height: 1.3; font-size: 0.85rem;">${formattedDate}</td>
        <td style="font-size: 0.85rem;">${sale.productName}</td>
        <td style="font-size: 0.85rem;">${sale.quantity}</td>
        <td style="font-size: 0.85rem;">${sale.unitType}</td>
        <td class="text-success fw-bold" style="font-size: 0.85rem;">₹${parseFloat(sale.totalAmount).toFixed(2)}</td>
      </tr>
    `;
    
    salesList.innerHTML += row;
  });
  
  if (cachedSales.length > 100) {
    salesList.innerHTML += `
      <tr>
        <td colspan="5" class="text-center text-muted">
          <small>Showing 100 most recent sales. Total: ${cachedSales.length} sales</small>
        </td>
      </tr>
    `;
  }
}


/**
 * ==========================================
 * âœ… PHOTO PRODUCT FUNCTIONALITY
 * ==========================================
 */

// Photo selection variables
let selectedPhotoFile = null;
let selectedPhotoBase64 = null;

// Open photo product modal
function openPhotoProductModal() {
  // Reset form
  document.getElementById('photoProductName').value = '';
  document.getElementById('photoProductBrand').value = '';
  document.getElementById('photoProductSize').value = '';
  document.getElementById('photoProductStock').value = '';
  document.getElementById('photoProductPrice').value = '';
  document.getElementById('photoPreviewContainer').style.display = 'none';
  document.getElementById('photoLoadingSpinner').style.display = 'none';
  selectedPhotoFile = null;
  selectedPhotoBase64 = null;
  
  // Show modal
  const modal = new bootstrap.Modal(document.getElementById('photoProductModal'));
  modal.show();
}

// Handle photo selection
function handlePhotoSelect(event) {
  const file = event.target.files[0];
  if (!file || !file.type.startsWith('image/')) {
    alert('Please select a valid image file');
    return;
  }
  
  selectedPhotoFile = file;
  
  const reader = new FileReader();
  reader.onload = (e) => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      
      const maxWidth = 1920;
      const maxHeight = 1080;
      let width = img.width;
      let height = img.height;
      
      if (width > height) {
        if (width > maxWidth) {
          height = (maxWidth / width) * height;
          width = maxWidth;
        }
      } else {
        if (height > maxHeight) {
          width = (maxHeight / height) * width;
          height = maxHeight;
        }
      }
      
      canvas.width = width;
      canvas.height = height;
      ctx.drawImage(img, 0, 0, width, height);
      
      selectedPhotoBase64 = canvas.toDataURL('image/jpeg', 0.7);
      
      document.getElementById('photoPreviewImage').src = selectedPhotoBase64;
      document.getElementById('photoPreviewContainer').style.display = 'block';
      
      console.log('Photo selected and compressed:', file.name);
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

// Clear photo selection
function clearPhotoSelection() {
  selectedPhotoFile = null;
  selectedPhotoBase64 = null;
  document.getElementById('photoFileInput').value = '';
  document.getElementById('photoCameraInput').value = '';
  document.getElementById('photoPreviewContainer').style.display = 'none';
}

// Save photo product
async function savePhotoProduct() {
  const productName = document.getElementById('photoProductName').value.trim();
  if (!productName) {
    alert('Product name is required!');
    return;
  }
  
  if (!selectedPhotoBase64) {
    alert('Please take or select a photo!');
    return;
  }
  
  const productData = {
    id: generateId(),
    name: productName,
    category: 'Photo Products',
    brand: document.getElementById('photoProductBrand').value.trim() || '',
    size: document.getElementById('photoProductSize').value.trim() || '',
    unitType: 'Piece',
    piecesPerBox: '',
    sftPerBox: '',
    price: parseFloat(document.getElementById('photoProductPrice').value) || 0,
    stock: parseFloat(document.getElementById('photoProductStock').value) || 0,
    minStock: 0,
    imageUrl: 'uploading...'
  };
  
  cachedProducts.push(productData);
  renderProducts();
  
  const modalEl = document.getElementById('photoProductModal');
  const modal = bootstrap.Modal.getInstance(modalEl);
  modal.hide();
  
  showSuccessToast('Photo product added! Uploading image...');
  
  uploadPhotoToBackend(productData, selectedPhotoBase64);
}

/**
 * Upload photo to Firebase (temp solution - stores base64)
 * TODO: Upgrade to Firebase Storage for production
 */
async function uploadPhotoToBackend(productData, photoBase64) {
  try {
    console.log('Saving photo product to Firebase...');
    
    const user = window.auth.currentUser;
    if (!user) {
      throw new Error('User not authenticated');
    }
    
    // For now, store base64 directly in product
    productData.imageUrl = photoBase64;
    
    const productIndex = cachedProducts.findIndex(p => p.id === productData.id);
    if (productIndex !== -1) {
      cachedProducts[productIndex].imageUrl = photoBase64;
    }
    
    // Save to Firestore
    await saveProductToSheet(productData);
    
    renderProducts();
    showSuccessToast('✅ Photo product saved!');
    
    console.log('✅ Photo product saved to Firestore');
    
    // TODO: For production, use Firebase Storage:
    // const storage = getStorage();
    // const storageRef = ref(storage, `products/${user.uid}/${productData.id}.jpg`);
    // const uploadTask = await uploadString(storageRef, photoBase64, 'data_url');
    // const photoUrl = await getDownloadURL(uploadTask.ref);
    // return photoUrl;
    
  } catch (error) {
    console.error('Photo upload error:', error);
    alert('Failed to save photo product. Please try again.');
    
    productData.imageUrl = '';
    const productIndex = cachedProducts.findIndex(p => p.id === productData.id);
    if (productIndex !== -1) {
      cachedProducts[productIndex].imageUrl = '';
    }
    
    renderProducts();
  }
}


/**
 * Show all products (table view) - FIXED
 */
/**
 * Show all products (table view) - COMPLETE FIX
 */
function showAllProducts() {
  console.log('📋 Switching to All Products view');
  
  // ✅ Update button states
  const btnAll = document.getElementById('btnAllView');
  const btnPhoto = document.getElementById('btnPhotoView');
  
  if (btnAll) btnAll.classList.add('active');
  if (btnPhoto) btnPhoto.classList.remove('active');
  
  // ✅ Hide photo grid - Make sure it's fully hidden
  const photoGrid = document.getElementById('photoProductGrid');
  if (photoGrid) {
    photoGrid.style.display = 'none';
    photoGrid.style.visibility = 'hidden';
    photoGrid.innerHTML = ''; // Clear it
    console.log('✅ Photo grid hidden and cleared');
  }
  
  // ✅ Show table - Try multiple selectors to find it
  let tableExplorer = document.querySelector('.table-explorer');
  
  if (!tableExplorer) {
    tableExplorer = document.querySelector('[class*="table"]');
  }
  
  if (tableExplorer) {
    tableExplorer.style.display = 'block';
    tableExplorer.style.visibility = 'visible';
    console.log('✅ Table explorer shown');
  } else {
    console.warn('⚠️ Table explorer element not found!');
  }
  
  // ✅ Show mobile list
  const mobileList = document.getElementById('mobileProductsList');
  if (mobileList) {
    mobileList.style.display = 'block';
    console.log('✅ Mobile list shown');
  }
  
  // ✅ Render products
  renderProducts();
  console.log('✅ All Products view activated');
}


/**
 * Show photo products (grid view) - VERTICAL SCROLL FIXED
 */
function showPhotoProducts() {
  console.log('📷 Switching to Photo Products view');
  
  // ✅ Update button states
  const btnAll = document.getElementById('btnAllView');
  const btnPhoto = document.getElementById('btnPhotoView');
  
  if (btnAll) btnAll.classList.remove('active');
  if (btnPhoto) btnPhoto.classList.add('active');
  
  // ✅ Hide table - Try multiple selectors
  let tableExplorer = document.querySelector('.table-explorer');
  
  if (!tableExplorer) {
    tableExplorer = document.querySelector('[class*="table"]');
  }
  
  if (tableExplorer) {
    tableExplorer.style.display = 'none';
    tableExplorer.style.visibility = 'hidden';
    console.log('✅ Table explorer hidden');
  }
  
  // ✅ Hide mobile list
  const mobileList = document.getElementById('mobileProductsList');
  if (mobileList) {
    mobileList.style.display = 'none';
    console.log('✅ Mobile list hidden');
  }
  
  // ✅ Show photo grid
  const photoGrid = document.getElementById('photoProductGrid');
  if (photoGrid) {
    photoGrid.style.display = 'grid';
    photoGrid.style.visibility = 'visible';
    console.log('✅ Photo grid shown');
  } else {
    console.error('❌ Photo grid element not found!');
  }
  
  // ✅ Render photo products
  renderPhotoProductsGrid();
  console.log('✅ Photo Products view activated');
}
function renderPhotoProductsGrid() {
  const photoGrid = document.getElementById('photoProductGrid');
  if (!photoGrid) {
    console.error('❌ Photo grid not found');
    return;
  }
  
  photoGrid.innerHTML = ''; // Clear first
  
  const photoProducts = cachedProducts.filter(p => {
    const hasImage = p.imageUrl && p.imageUrl !== '' && p.imageUrl !== 'uploading...';
    return hasImage;
  });
  
  console.log(`📸 Found ${photoProducts.length} photo products`);
  
  if (photoProducts.length === 0) {
    photoGrid.innerHTML = `
      <div style="grid-column: 1 / -1;">
        <div class="alert alert-info text-center">
          <i class="bi bi-images" style="font-size: 3rem;"></i><br>
          <strong>No photo products yet.</strong><br>
          Click <strong>"Product by Photo"</strong> to add one!
        </div>
      </div>
    `;
    return;
  }
  
  photoProducts.forEach(product => {
    const stockBadge = product.stock > 0 ? 
      `<span class="badge bg-success">Stock: ${product.stock}</span>` : 
      `<span class="badge bg-danger">Out of Stock</span>`;
    
    const priceDisplay = product.price > 0 ? `₹${product.price.toFixed(2)}` : 'Price not set';
    
    const cardDiv = document.createElement('div');
    cardDiv.className = 'card h-100 shadow-sm';
    cardDiv.style.display = 'flex';
    cardDiv.style.flexDirection = 'column';
    
    cardDiv.innerHTML = `
      <img src="${product.imageUrl}" 
           class="card-img-top" 
           alt="${escapeHtml(product.name)}" 
           style="height:150px; object-fit:cover; cursor:pointer; flex-shrink: 0;" 
           onclick="viewPhotoProduct('${product.id}')"
           onerror="this.onerror=null; this.src='https://via.placeholder.com/200?text=Image';">
      <div class="card-body p-2" style="flex: 1;">
        <h6 class="card-title" style="font-size:0.9rem; margin-bottom: 5px;">${escapeHtml(product.name)}</h6>
        <p class="card-text small mb-2" style="font-size:0.75rem;">
          ${product.brand ? `<strong>Brand:</strong> ${escapeHtml(product.brand)}<br>` : ''}
          ${product.size ? `<strong>Size:</strong> ${escapeHtml(product.size)}<br>` : ''}
          ${stockBadge}<br>
          <strong>Price:</strong> ${priceDisplay}
        </p>
      </div>
      <div class="card-footer bg-white border-0 d-flex gap-2 p-2">
        <button class="btn btn-sm btn-primary flex-fill" onclick="editProduct('${product.id}')">
          <i class="bi bi-pencil"></i> Edit
        </button>
        <button class="btn btn-sm btn-danger flex-fill" onclick="deleteProduct('${product.id}')">
          <i class="bi bi-trash"></i> Delete
        </button>
      </div>
    `;
    
    photoGrid.appendChild(cardDiv);
  });
  
  console.log('✅ Photo grid rendered');
}


    

// View photo product enlarged
function viewPhotoProduct(productId) {
  const product = cachedProducts.find(p => p.id === productId);
  if (!product) {
    alert('Product not found');
    return;
  }
  
  document.getElementById('viewPhotoModalTitle').textContent = product.name;
  document.getElementById('viewPhotoModalBody').innerHTML = `
    <div class="text-center">
      <img src="${product.imageUrl}" 
           class="img-fluid mb-3" 
           alt="${product.name}"
           style="max-height: 500px; border-radius: 10px;"
           onerror="this.src='https://via.placeholder.com/500?text=Image+Not+Found'">
      <table class="table table-bordered mt-3">
        <tr><th>Product Name</th><td>${product.name}</td></tr>
        <tr><th>Category</th><td>${product.category || ''}</td></tr>
        <tr><th>Brand</th><td>${product.brand || ''}</td></tr>
        <tr><th>Size</th><td>${product.size || ''}</td></tr>
        <tr><th>Stock</th><td>${product.stock || 0} ${product.unitType || 'Pieces'}</td></tr>
        <tr><th>Price</th><td>₹${formatCurrency(product.price || 0)}</td></tr>
        <tr><th>Minimum Stock Alert</th><td>${product.minStock || 0}</td></tr>
      </table>
    </div>
  `;
  
  const modal = new bootstrap.Modal(document.getElementById('viewPhotoModal'));
  modal.show();
}
/**
 * ==========================================
 * INITIALIZATION ON PAGE LOAD - FIREBASE VERSION
 * ==========================================
 */
 document.addEventListener('DOMContentLoaded', async function() {
  console.log('🚀 Initializing Inventory App with Firebase...');
  
  // ✅ STEP 1: Apply feature flags IMMEDIATELY (before anything else)
  // This uses the synchronously-loaded localStorage data to prevent flash
  if (window.featureFlags) {
    console.log('⚡ Applying feature flags from cache (sync)...');
    applyFeatureFlagVisibilityQuick();
  } else {
    console.warn('⚠️ Feature flags not loaded yet, using defaults');
    window.featureFlags = {
      enableInvoiceGeneration: true,
      enableInvoiceViewing: true,
      updatedAt: new Date().toISOString()
    };
    applyFeatureFlagVisibilityQuick();
  }
  
  // Set initial page
  currentPage = 'home';
  
  // Hide all pages initially
  const allProductsPage = document.getElementById('allProductsPage');
  const productGroupsPage = document.getElementById('productGroupsPage');
  const groupDetailPage = document.getElementById('groupDetailPage');
  const brandsPage = document.getElementById('brandsPage');
  const sizesPage = document.getElementById('sizesPage');
  const categoriesPage = document.getElementById('categoriesPage');
  const unitTypesPage = document.getElementById('unitTypesPage'); // ✅ NEW
  
  if (allProductsPage) allProductsPage.classList.remove('active');
  if (productGroupsPage) productGroupsPage.classList.remove('active');
  if (groupDetailPage) groupDetailPage.classList.remove('active');
  if (brandsPage) brandsPage.classList.remove('active');
  if (sizesPage) sizesPage.classList.remove('active');
  if (categoriesPage) categoriesPage.classList.remove('active');
  if (unitTypesPage) unitTypesPage.classList.remove('active'); // ✅ NEW
  
  // Show main dashboard
  const mainApp = document.getElementById('mainApp');
  if (mainApp) {
    mainApp.style.display = 'block';
    console.log('✅ Main dashboard visible');
  }
  
  // Reset product modal on close
  const productModal = document.getElementById('productModal');
  if (productModal) {
    productModal.addEventListener('hidden.bs.modal', function() {
      // Reset Brand Button
      const saveBrandBtn = document.getElementById('saveBrandInsideBtn');
      if (saveBrandBtn) {
        saveBrandBtn.style.display = 'none';
        saveBrandBtn.innerHTML = '💾';
        saveBrandBtn.style.background = '#28a745';
        saveBrandBtn.disabled = false;
      }
      
      // Reset Brand Field
      const brandField = document.getElementById('brand');
      if (brandField) brandField.value = '';
      
      // Reset Size Button
      const saveSizeBtn = document.getElementById('saveSizeInsideBtn');
      if (saveSizeBtn) {
        saveSizeBtn.style.display = 'none';
        saveSizeBtn.innerHTML = '💾';
        saveSizeBtn.style.background = '#007bff';
        saveSizeBtn.disabled = false;
      }
      
      // Reset Size Field
      const sizeField = document.getElementById('size');
      if (sizeField) sizeField.value = '';
      
      // Reset Category Dropdown
      const categoryField = document.getElementById('category');
      if (categoryField) categoryField.value = '';
      
      // ✅ Reset Unit Type Dropdown
      const unitTypeField = document.getElementById('unitType');
      if (unitTypeField) unitTypeField.value = '';
      
      // Clear photo selection
      if (typeof clearProductPhotoSelection === 'function') {
        clearProductPhotoSelection();
      }
      
      // Hide Brand Dropdown
      const brandDropdown = document.getElementById('addProductBrandSuggestionsDropdown');
      if (brandDropdown) brandDropdown.style.display = 'none';
      
      // Hide Size Dropdown
      const sizeDropdown = document.getElementById('addProductSizeSuggestionsDropdown');
      if (sizeDropdown) sizeDropdown.style.display = 'none';
      
      console.log('🔄 Product modal reset');
    });
  }
  
  // Load Brand Cache
  if (typeof loadBrandAutocompleteCache === 'function') {
    console.log('🏷️ Loading brand cache...');
    loadBrandAutocompleteCache();
  } else {
    console.warn('⚠️ loadBrandAutocompleteCache function not found');
  }
  
  // Load Size Cache
  if (typeof loadSizeAutocompleteCache === 'function') {
    console.log('📏 Loading size cache...');
    loadSizeAutocompleteCache();
  } else {
    console.warn('⚠️ loadSizeAutocompleteCache function not found');
  }
  
  // Load Category Cache
  if (typeof loadCategoryAutocompleteCache === 'function') {
    console.log('📦 Loading category cache...');
    await loadCategoryAutocompleteCache();
  } else {
    console.warn('⚠️ loadCategoryAutocompleteCache function not found');
  }
  
  // ✅ NEW: Load Unit Type Cache
  if (typeof loadUnitTypeAutocompleteCache === 'function') {
    console.log('📋 Loading unit type cache...');
    await loadUnitTypeAutocompleteCache();
  } else {
    console.warn('⚠️ loadUnitTypeAutocompleteCache function not found');
  }
  
  // FIREBASE INITIALIZATION
  console.log('📱 Waiting for Firebase authentication...');
  
  // Load from localStorage cache first
  try {
    cachedProducts = JSON.parse(localStorage.getItem('inventory_products_cache') || '[]');
    cachedSales = JSON.parse(localStorage.getItem('inventory_sales_cache') || '[]');
    renderProducts();
    renderSales();
    console.log('✅ Displayed cached data');
  } catch (e) {
    console.warn('⚠️ Cache load failed:', e);
  }
  
  // Load purchases
  if (typeof loadRecentPurchases === 'function') {
    console.log('📦 Loading purchases...');
    await loadRecentPurchases();
  }
  
  // Load customer invoices
  if (typeof loadCustomerInvoices === 'function') {
    console.log('📄 Loading customer invoices...');
    await loadCustomerInvoices();
  }
  
  console.log('✅ App initialization complete');
});


/**
 * ==========================================
 * QUICK APPLY FEATURE FLAGS (No Firestore Wait)
 * ==========================================
 * This function applies feature flags from localStorage immediately
 * Prevents the "flash" of enabled buttons on page load
 */
 function applyFeatureFlagVisibilityQuick() {
    console.log("⚡ Quick-applying feature flag visibility (sync)...");
    
    // Hide/Show Invoice Generation buttons
    const invoiceGenButtons = document.querySelectorAll('[data-feature-flag="enableInvoiceGeneration"]');
    invoiceGenButtons.forEach(button => {
        if (window.featureFlags.enableInvoiceGeneration === true) {
            button.style.display = '';
            button.style.opacity = '1';
            button.style.visibility = 'visible';
            button.style.pointerEvents = 'auto';
            button.classList.remove('d-none');
            
            const textElements = button.querySelectorAll('span, i');
            textElements.forEach(el => {
                el.style.opacity = '1';
                el.style.visibility = 'visible';
            });
        } else {
            button.style.display = 'none';
            button.style.opacity = '0';
            button.style.visibility = 'hidden';
            button.style.pointerEvents = 'none';
            button.classList.add('d-none');
        }
    });
    
    // Hide/Show Invoice Viewing buttons
    const invoiceViewButtons = document.querySelectorAll('[data-feature-flag="enableInvoiceViewing"]');
    invoiceViewButtons.forEach(button => {
        if (window.featureFlags.enableInvoiceViewing === true) {
            button.style.display = '';
            button.style.opacity = '1';
            button.style.visibility = 'visible';
            button.style.pointerEvents = 'auto';
            button.classList.remove('d-none');
            
            const textElements = button.querySelectorAll('span, i');
            textElements.forEach(el => {
                el.style.opacity = '1';
                el.style.visibility = 'visible';
            });
        } else {
            button.style.display = 'none';
            button.style.opacity = '0';
            button.style.visibility = 'hidden';
            button.style.pointerEvents = 'none';
            button.classList.add('d-none');
        }
    });
    
    // Hide/Show Record Sale buttons
    const recordSaleButtons = document.querySelectorAll('[data-feature-flag="enableSalesRecording"]');
    recordSaleButtons.forEach(button => {
        if (window.featureFlags.enableSalesRecording === true) {
            button.style.display = '';
            button.style.opacity = '1';
            button.style.visibility = 'visible';
            button.style.pointerEvents = 'auto';
            button.classList.remove('d-none');
            
            const textElements = button.querySelectorAll('span, i');
            textElements.forEach(el => {
                el.style.opacity = '1';
                el.style.visibility = 'visible';
            });
        } else {
            button.style.display = 'none';
            button.style.opacity = '0';
            button.style.visibility = 'hidden';
            button.style.pointerEvents = 'none';
            button.classList.add('d-none');
        }
    });
    
    // ✅ NEW: Hide/Show Recent Sales View button
    const recentSalesButtons = document.querySelectorAll('[data-feature-flag="enableRecentSalesView"]');
    recentSalesButtons.forEach(button => {
        if (window.featureFlags.enableRecentSalesView === true) {
            button.style.display = '';
            button.style.opacity = '1';
            button.style.visibility = 'visible';
            button.style.pointerEvents = 'auto';
            button.classList.remove('d-none');
            
            const textElements = button.querySelectorAll('span, i');
            textElements.forEach(el => {
                el.style.opacity = '1';
                el.style.visibility = 'visible';
            });
        } else {
            button.style.display = 'none';
            button.style.opacity = '0';
            button.style.visibility = 'hidden';
            button.style.pointerEvents = 'none';
            button.classList.add('d-none');
            
            // Switch to inventory if sales view is active
            if (button.classList.contains('active')) {
                switchToInventoryView();
            }
        }
    });
    
    console.log(`✅ Feature flags applied instantly:
      - Invoice Generation: ${window.featureFlags.enableInvoiceGeneration ? '✅ VISIBLE' : '❌ HIDDEN'}
      - Invoice Viewing: ${window.featureFlags.enableInvoiceViewing ? '✅ VISIBLE' : '❌ HIDDEN'}
      - Sales Recording: ${window.featureFlags.enableSalesRecording ? '✅ VISIBLE' : '❌ HIDDEN'}
      - Recent Sales View: ${window.featureFlags.enableRecentSalesView ? '✅ VISIBLE' : '❌ HIDDEN'}`);
    
    // Adjust flip card layout based on visibility
    adjustFlipCardLayout();
}





/**
 * ==========================================
 * BULK ADD PRODUCTS FOR RECORD SALE
 * ==========================================
 */

// Global variable to store selected products for sale
let selectedBulkProductsSale = {};

/**
 * Open Bulk Add Modal for Sale
 */
/**
 * Open Bulk Add Modal for Sale (WITH SAFETY CHECKS)
 */
function openBulkAddModalForSale() {
  console.log('📦 Opening Bulk Add Modal for Sale');
  
  // ✅ SAFE: Reset search input (check if exists first)
  const searchInput = document.getElementById('bulkSearchInputSale');
  if (searchInput) {
    searchInput.value = '';
  } else {
    console.warn('⚠️ bulkSearchInputSale element not found');
  }
  
  // ✅ ALWAYS RESET COMPLETELY
  selectedBulkProductsSale = {};
  
  // ✅ Clear selected items panel
  const selectedContainer = document.getElementById('bulkSelectedItemsSale');
  if (selectedContainer) {
    selectedContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">No items selected</div>';
  }
  
  // ✅ Reset counters
  updateBulkCountersSale();
  
  // Render all products
  renderBulkProductsListSale('');
  
  // Show modal
  const modalElement = document.getElementById('bulkAddModalForSale');
  if (modalElement) {
    const modal = new bootstrap.Modal(modalElement);
    modal.show();
    console.log('✅ Modal opened with clean state');
  } else {
    console.error('❌ bulkAddModalForSale element not found!');
    alert('Error: Bulk Add Modal not found. Please check your HTML.');
  }
}


/**
 * Filter products by search query (SAFE)
 */
function filterBulkProductsSale(query) {
  console.log('🔍 Filtering bulk products for sale:', query);
  renderBulkProductsListSale(query);
}

/**
 * Render products list on left side (WITH SAFETY CHECKS)
 */
function renderBulkProductsListSale(searchQuery) {
  const container = document.getElementById('bulkProductsListSale');
  if (!container) {
    console.error('❌ bulkProductsListSale container not found');
    return;
  }
  
  const products = cachedProducts || [];
  let filtered = products;
  
  // Filter by search query
  if (searchQuery && searchQuery.trim().length > 0) {
    const query = searchQuery.toLowerCase();
    filtered = products.filter(product => {
      const name = (product.name || '').toLowerCase();
      const brand = (product.brand || '').toLowerCase();
      const category = (product.category || '').toLowerCase();
      
      return name.includes(query) || brand.includes(query) || category.includes(query);
    });
  }
  
  if (filtered.length === 0) {
    container.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">No products found</div>';
    return;
  }
  
  let html = '';
  filtered.forEach(product => {
    const isSelected = selectedBulkProductsSale[product.id];
    const displayName = product.size ? `${product.name} (${product.size})` : product.name;
    const rateText = product.price ? `₹${product.price.toFixed(2)}` : 'N/A';
    const stockText = product.stock ? `Stock: ${product.stock}` : '';
    
    html += `
      <div onclick="toggleBulkProductSelectionSale('${product.id}', '${escapeHtml(product.name)}', '${escapeHtml(product.size || '')}', ${product.price || 0})"
           style="
             padding: 12px;
             border-bottom: 1px solid #f0f0f0;
             cursor: pointer;
             transition: background-color 0.2s;
             display: flex;
             justify-content: space-between;
             align-items: center;
             ${isSelected ? 'background-color: #e3f2fd;' : 'background-color: white;'}
           "
           onmouseover="this.style.backgroundColor='#f5f5f5'"
           onmouseout="this.style.backgroundColor='${isSelected ? '#e3f2fd' : 'white'}'"
      >
        <div style="flex: 1;">
          <strong>${escapeHtml(displayName)}</strong>
          <div style="font-size: 0.85rem; color: #666;">
            ${rateText} ${stockText ? '• ' + stockText : ''}
          </div>
        </div>
        <div style="
          width: 24px;
          height: 24px;
          display: flex;
          align-items: center;
          justify-content: center;
          margin-left: 10px;
        ">
          ${isSelected ? '✓' : ''}
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
  console.log('✅ Rendered', filtered.length, 'products for sale');
}

/**
 * Update counters (WITH SAFETY CHECKS)
 */
function updateBulkCountersSale() {
  const selectedArray = Object.values(selectedBulkProductsSale);
  const selectedCount = selectedArray.length;
  const totalQty = selectedArray.reduce((sum, p) => sum + p.qty, 0);
  
  const countElement = document.getElementById('bulkSelectedCountSale');
  const qtyElement = document.getElementById('bulkTotalQtySale');
  
  if (countElement) {
    countElement.textContent = selectedCount;
  }
  if (qtyElement) {
    qtyElement.textContent = totalQty;
  }
  
  console.log('📊 Counters: Selected=' + selectedCount + ', TotalQty=' + totalQty);
}

/**
 * Toggle product selection for sale
 */
function toggleBulkProductSelectionSale(productId, productName, productSize, productPrice) {
  console.log('✓ Toggle product for sale:', productName);
  
  if (selectedBulkProductsSale[productId]) {
    // Remove if already selected
    delete selectedBulkProductsSale[productId];
    console.log('❌ Removed:', productName);
  } else {
    // Add if not selected
    selectedBulkProductsSale[productId] = {
      id: productId,
      name: productName,
      size: productSize,
      price: productPrice,
      qty: 1
    };
    console.log('✅ Added:', productName);
  }
  
  // Refresh both panels
  renderBulkProductsListSale(document.getElementById('bulkSearchInputSale').value);
  renderBulkSelectedItemsSale();
}

/**
 * Render selected items with horizontal buttons
 */
function renderBulkSelectedItemsSale() {
  const container = document.getElementById('bulkSelectedItemsSale');
  if (!container) return;
  
  const selectedArray = Object.values(selectedBulkProductsSale);
  
  if (selectedArray.length === 0) {
    container.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">No items selected</div>';
    updateBulkCountersSale();
    return;
  }
  
  let html = '';
  selectedArray.forEach((product, idx) => {
    const displayName = product.size ? `${product.name} (${product.size})` : product.name;
    
    html += `
      <div style="
        padding: 12px;
        border-bottom: 1px solid #ddd;
      ">
        <!-- Product Info (always on top) -->
        <div style="margin-bottom: 8px;">
          <strong style="display: block; font-size: 14px; margin-bottom: 4px;">
            ${escapeHtml(displayName)}
          </strong>
          <div style="font-size: 0.85rem; color: #666;">
            ₹${product.price.toFixed(2)}
          </div>
        </div>
        
        <!-- Quantity Controls (ALWAYS HORIZONTAL) -->
        <div style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          gap: 8px;
          flex-wrap: nowrap;
        ">
          <!-- LEFT: Minus, Qty, Plus (HORIZONTAL) -->
          <div style="
            display: flex;
            align-items: center;
            gap: 4px;
            flex-wrap: nowrap;
            min-width: 0;
          ">
            <!-- Minus Button -->
            <button type="button" class="bulk-qty-btn" 
                    onclick="updateBulkQtySale('${product.id}', -1)"
                    style="
                      padding: 6px 10px;
                      font-size: 16px;
                      background: #dc3545;
                      color: white;
                      border: none;
                      border-radius: 4px;
                      cursor: pointer;
                      min-width: 40px;
                      min-height: 40px;
                      font-weight: bold;
                      transition: background 0.2s;
                      flex-shrink: 0;
                    "
                    onmouseover="this.style.background='#c82333'"
                    onmouseout="this.style.background='#dc3545'">
              −
            </button>
            
            <!-- Quantity Input -->
            <input type="number" value="${product.qty}" 
                   class="bulk-qty-input"
                   style="
                     width: 50px;
                     padding: 6px;
                     text-align: center;
                     font-size: 14px;
                     font-weight: bold;
                     border: 1px solid #ddd;
                     border-radius: 4px;
                     flex-shrink: 0;
                   "
                   onchange="updateBulkQtyDirectSale('${product.id}', this.value)">
            
            <!-- Plus Button -->
            <button type="button" class="bulk-qty-btn" 
                    onclick="updateBulkQtySale('${product.id}', 1)"
                    style="
                      padding: 6px 10px;
                      font-size: 16px;
                      background: #28a745;
                      color: white;
                      border: none;
                      border-radius: 4px;
                      cursor: pointer;
                      min-width: 40px;
                      min-height: 40px;
                      font-weight: bold;
                      transition: background 0.2s;
                      flex-shrink: 0;
                    "
                    onmouseover="this.style.background='#218838'"
                    onmouseout="this.style.background='#28a745'">
              +
            </button>
          </div>
          
          <!-- RIGHT: Remove Button -->
          <button type="button" class="btn btn-sm btn-link text-danger bulk-remove-btn" 
                  onclick="toggleBulkProductSelectionSale('${product.id}', '${escapeHtml(product.name)}', '${product.size}', ${product.price})"
                  style="
                    padding: 6px 10px;
                    font-size: 16px;
                    min-width: 40px;
                    min-height: 40px;
                    cursor: pointer;
                    flex-shrink: 0;
                  ">
            ✕
          </button>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
  updateBulkCountersSale();
  console.log('✅ Rendered', selectedArray.length, 'selected items for sale');
}

/**
 * Update quantity (increment/decrement)
 */
function updateBulkQtySale(productId, change) {
  if (selectedBulkProductsSale[productId]) {
    const newQty = Math.max(1, selectedBulkProductsSale[productId].qty + change);
    selectedBulkProductsSale[productId].qty = newQty;
    renderBulkSelectedItemsSale();
    console.log('📊 Updated qty:', newQty);
  }
}

/**
 * Update quantity (direct input)
 */
function updateBulkQtyDirectSale(productId, value) {
  if (selectedBulkProductsSale[productId]) {
    const newQty = Math.max(1, parseInt(value) || 1);
    selectedBulkProductsSale[productId].qty = newQty;
    renderBulkSelectedItemsSale();
    console.log('📊 Updated qty directly:', newQty);
  }
}

/**
 * Add all selected products to Record Sale Grid
 */
/**
 * Add all selected products to Record Sale
 */
function addBulkProductsToSale() {
  const selectedArray = Object.values(selectedBulkProductsSale);
  
  if (selectedArray.length === 0) {
    alert('❌ Please select at least one product');
    return;
  }
  
  console.log('📦 Adding', selectedArray.length, 'products to Record Sale');
  
  const tbody = document.getElementById('product-grid-body');
  if (!tbody) {
    console.error('❌ Record Sale table body not found');
    return;
  }
  
  // Add each product as a new row
  selectedArray.forEach((product, index) => {
    // Get current number of rows
    const rowIndex = tbody.querySelectorAll('tr').length + 1;
    
    // Create new row element
    const tr = document.createElement('tr');
    tr.className = 'product-row';
    tr.setAttribute('data-index', rowIndex);
    
    const displayName = product.size ? `${product.name} (${product.size})` : product.name;
    
    // ✅ Build row HTML (MATCHING YOUR EXISTING TABLE STRUCTURE)
    tr.innerHTML = `
      <td class="grid-row-number">${rowIndex}</td>
      <td>
        <select class="form-select product-select" id="product-${rowIndex}" onchange="onProductSelect(${rowIndex})">
          <option value="">-- Select Product --</option>
        </select>
      </td>
      <td><input type="text" class="form-control size-input readonly-input" id="size-${rowIndex}" readonly /></td>
      <td><input type="number" class="form-control qty-input" id="qty-${rowIndex}" min="1" placeholder="Enter quantity" oninput="onQtyChange(${rowIndex})"></td>
      <td><input type="text" class="form-control unit-input readonly-input" id="unit-${rowIndex}" readonly /></td>
      <td><input type="number" class="form-control price-input readonly-input" id="price-${rowIndex}" readonly /></td>
      <td><div id="total-${rowIndex}" class="fw-bold">₹0.00</div></td>
      <td><button class="btn btn-sm btn-outline-danger" onclick="removeRow(this)"><i class="bi bi-x"></i></button></td>
    `;
    
    tbody.appendChild(tr);
    
    // ✅ CRITICAL: Populate the product select dropdown FIRST
    populateProductSelectForRow(rowIndex);
    
    // ✅ CRITICAL: Set the select value to the product ID
    const select = document.getElementById(`product-${rowIndex}`);
    if (select) {
      select.value = product.id;
      console.log('✅ Set product select value:', product.id);
    }
    
    // ✅ NOW trigger onProductSelect to auto-fill all fields
    onProductSelect(rowIndex);
    
    // ✅ Set quantity
    const qtyInput = document.getElementById(`qty-${rowIndex}`);
    if (qtyInput) {
      qtyInput.value = product.qty;
      console.log('✅ Set quantity:', product.qty);
    }
    
    // ✅ Trigger calculation
    onQtyChange(rowIndex);
    
    console.log('✅ Added row', rowIndex, ':', displayName, 'x' + product.qty);
  });
  
  // ✅ Calculate grand total AFTER all rows added
  setTimeout(() => {
    updateGrandTotal();
    updateRowNumbers();
    console.log('✅ Record Sale totals calculated');
  }, 100);
  
  // Clear selections
  selectedBulkProductsSale = {};
  
  // Close modal
  const modal = bootstrap.Modal.getInstance(document.getElementById('bulkAddModalForSale'));
  if (modal) {
    modal.hide();
  }
  
  console.log('✅ All', selectedArray.length, 'products added successfully!');
}

/**
 * Calculate Record Sale totals
 */
function calculateRecordSaleTotal() {
  const tbody = document.getElementById('product-grid-body');
  if (!tbody) return;
  
  let subtotal = 0;
  const rows = tbody.querySelectorAll('tr');
  
  rows.forEach((row, index) => {
    const qtyInput = row.querySelector(`input[id^="saleQty-"]`);
    const priceInput = row.querySelector(`input[id^="salePrice-"]`);
    const totalSpan = row.querySelector(`span[id^="saleRowTotal-"]`);
    
    if (qtyInput && priceInput) {
      const qty = parseInt(qtyInput.value) || 0;
      const price = parseFloat(priceInput.value) || 0;
      const rowTotal = qty * price;
      
      if (totalSpan) {
        totalSpan.textContent = `₹${rowTotal.toFixed(2)}`;
      }
      
      subtotal += rowTotal;
    }
  });
  
  // Update totals
  const subtotalSpan = document.getElementById('subtotal');
  const grandTotalSpan = document.getElementById('grandTotal');
  
  if (subtotalSpan) {
    subtotalSpan.textContent = `₹${subtotal.toFixed(2)}`;
  }
  if (grandTotalSpan) {
    grandTotalSpan.textContent = `₹${subtotal.toFixed(2)}`;
  }
}

/**
 * Delete sale row
 */
function deleteSaleRow(rowIndex) {
  const tbody = document.getElementById('product-grid-body');
  if (!tbody) return;
  
  const row = tbody.querySelector(`tr[data-index="${rowIndex}"]`);
  if (row) {
    row.remove();
    calculateRecordSaleTotal();
  }
}










    

  /**
 * ==========================================
 * INVOICE GENERATOR 
 * ==========================================
 */

// Global variable to store invoice number counter
let invoiceCounter = parseInt(localStorage.getItem('lastInvoiceNumber') || '0');

function generateInvoice() {
  // ✅ REMOVED: No longer require products from sale grid
  // Users can now open invoice modal directly and add items manually
  
  console.log('📄 Opening invoice generator...');
  
  // Store empty items temporarily (user can add manually in modal)
  window.tempInvoiceItems = [];
  
  // Close Sales Modal if open
  const salesModal = bootstrap.Modal.getInstance(document.getElementById('salesModal'));
  if (salesModal) {
    salesModal.hide();
    console.log('✅ Sales modal closed');
  }
  
  // Wait for modal to close, then open invoice modal
  setTimeout(() => {
    openInvoiceModal();
  }, 300);
}

function openInvoiceModal() {
  console.log('🚀 Opening invoice modal...');
  
  // Check if modal exists
  const modalEl = document.getElementById('invoiceModal');
  
  if (!modalEl) {
    console.error('❌ Invoice modal not found');
    alert('❌ Invoice modal not found. Please refresh the page.');
    return;
  }
  
  // Generate invoice number
  invoiceCounter++;
  const invoiceNo = 'INV-' + String(invoiceCounter).padStart(6, '0');
  
  const invoiceNumEl = document.getElementById('invoiceNumber');
  if (invoiceNumEl) {
    invoiceNumEl.value = invoiceNo;
  }
  
  localStorage.setItem('lastInvoiceNumber', invoiceCounter);
  console.log('✅ Invoice number generated:', invoiceNo);
  
  // Set today's date
  const today = new Date().toISOString().split('T')[0];
  const dateEl = document.getElementById('invoiceDate');
  if (dateEl) {
    dateEl.value = today;
  }
  
  calculateDueDate();
  populateInvoiceItems();
  loadDefaultTerms();
  
  // Show modal
  try {
    const bsModal = new bootstrap.Modal(modalEl);
    bsModal.show();
    console.log('✅ Invoice modal opened');
  } catch (error) {
    console.error('❌ Error opening modal:', error);
  }
}

// Regenerate Invoice Number
function regenerateInvoiceNumber() {
  invoiceCounter++;
  const invoiceNo = 'INV-' + String(invoiceCounter).padStart(6, '0');
  document.getElementById('invoiceNumber').value = invoiceNo;
  localStorage.setItem('lastInvoiceNumber', invoiceCounter);
  console.log('✅ Invoice number regenerated:', invoiceNo);
}

// Calculate Due Date based on Payment Terms
function calculateDueDate() {
  const invoiceDate = new Date(document.getElementById('invoiceDate').value);
  const terms = parseInt(document.getElementById('paymentTerms').value);
  
  const dueDate = new Date(invoiceDate);
  dueDate.setDate(dueDate.getDate() + terms);
  
  document.getElementById('invoiceDueDate').value = dueDate.toISOString().split('T')[0];
}

// Populate Invoice Items from Sale
function populateInvoiceItems() {
  const tbody = document.getElementById('invoiceItemsBody');
  tbody.innerHTML = '';
  
  // ✅ CHANGED: If no items, create empty row for user to add
  if (!window.tempInvoiceItems || window.tempInvoiceItems.length === 0) {
    console.log('📝 No items from sale, adding empty row for manual entry');
    const emptyItem = {
      name: '',
      size: '',
      quantity: 1,
      rate: 0,
      amount: 0
    };
    tbody.innerHTML += createInvoiceRow(emptyItem, 0);
    calculateInvoiceTotal();
    return;
  }
  
  window.tempInvoiceItems.forEach((item, index) => {
    const row = createInvoiceRow(item, index);
    tbody.innerHTML += row;
  });
  
  calculateInvoiceTotal();
}

/**
 * Create Invoice Row HTML (UPDATED - matches Purchase style)
 */
/**
 * Create Invoice Row HTML (GRID LAYOUT - MATCHES PURCHASE)
 */
/**
 * Create Invoice Row HTML (3-LINE MOBILE LAYOUT - MATCHES PURCHASE)
 */
function createInvoiceRow(item, index) {
  const itemName = item.size ? `${item.name} (${item.size})` : item.name;
  const amount = (item.quantity * item.rate).toFixed(2);
  
  return `
    <div class="invoice-product-row" id="invoiceRow${index}" data-index="${index}">
      <!-- Line 1: Product Name -->
      <div class="invoice-name-line">
        <div class="invoice-field-label">Product Name</div>
        <input type="text" class="form-control" placeholder="Product name"
               id="invoiceProduct-${index}"
               value="${escapeHtml(itemName)}">
      </div>
      
      <!-- Line 2: Qty & Rate -->
      <div class="invoice-details-line">
        <div>
          <div class="invoice-field-label">Quantity</div>
          <input type="number" class="form-control" placeholder="Qty" min="1"
                 id="invoiceQty-${index}"
                 value="${item.quantity}"
                 oninput="updateInvoiceRowTotal(${index}); calculateInvoiceTotal();">
        </div>
        <div>
          <div class="invoice-field-label">Rate</div>
          <input type="number" class="form-control" placeholder="Rate" min="0" step="0.01"
                 id="invoiceRate-${index}"
                 value="${item.rate}"
                 oninput="updateInvoiceRowTotal(${index}); calculateInvoiceTotal();">
        </div>
      </div>
      
      <!-- Line 3: Amount -->
      <div class="invoice-amount-line">
        <div class="invoice-field-label">Amount</div>
        <input type="text" class="form-control" placeholder="Amount" readonly
               id="invoiceRowTotal-${index}"
               value="₹${amount}"
               style="background: #e8f5e9; font-weight: 600; color: #2e7d32;">
      </div>
      
      <!-- Remove Button (Top-Right on Mobile, Inline on Desktop) -->
      <button type="button" class="btn btn-danger invoice-remove-btn"
              onclick="deleteInvoiceRow(${index})">
        ×
      </button>
    </div>
  `;
}

/**
 * Update individual row total (FIXED - direct TD update like Purchase)
 */
/**
 * Add a new empty invoice row (GRID LAYOUT - MATCHES PURCHASE)
 */
/**
 * Add a new empty invoice row (3-LINE MOBILE LAYOUT)
 */
/**
 * Add a new empty invoice row (USES createInvoiceRow FOR CONSISTENCY)
 */
function addInvoiceRow() {
  const container = document.getElementById('invoiceItemsBody');
  if (!container) {
    console.error('❌ Invoice container not found');
    return;
  }
  
  // Get current number of rows
  const rowIndex = container.querySelectorAll('.invoice-product-row').length;
  
  // ✅ Create empty item object
  const emptyItem = {
    name: '',
    size: '',
    quantity: 1,
    rate: 0
  };
  
  // ✅ Use createInvoiceRow function to ensure consistency
  const rowHTML = createInvoiceRow(emptyItem, rowIndex);
  
  // Add row to container
  container.insertAdjacentHTML('beforeend', rowHTML);
  
  console.log('✅ Added new invoice row', rowIndex);
}



/**
 * Update individual row total (GRID LAYOUT VERSION)
 */
function updateInvoiceRowTotal(rowIndex) {
  console.log('🔄 Updating row', rowIndex, 'total...');
  
  const qtyInput = document.getElementById(`invoiceQty-${rowIndex}`);
  const rateInput = document.getElementById(`invoiceRate-${rowIndex}`);
  const totalInput = document.getElementById(`invoiceRowTotal-${rowIndex}`);
  
  if (!qtyInput || !rateInput || !totalInput) {
    console.warn('⚠️ Row', rowIndex, 'missing required elements');
    return;
  }
  
  const qty = parseFloat(qtyInput.value) || 0;
  const rate = parseFloat(rateInput.value) || 0;
  const total = qty * rate;
  
  totalInput.value = '₹' + total.toFixed(2);
  
  console.log('✅ Row', rowIndex, 'updated:', qty, 'x', rate, '=', total);
}



    
/**
 * Delete invoice row and recalculate totals
 */
/**
 * Delete invoice row and recalculate totals (GRID VERSION)
 */
/**
 * Delete invoice row and recalculate totals (WITH RENUMBERING)
 */
function deleteInvoiceRow(rowIndex) {
  console.log('🗑️ Deleting row', rowIndex);
  
  const row = document.getElementById(`invoiceRow${rowIndex}`);
  if (row) {
    row.remove();
    console.log('✅ Row', rowIndex, 'deleted');
    
    // ✅ Renumber remaining rows
    renumberInvoiceRows();
  }
  
  // Recalculate totals
  calculateInvoiceTotal();
}




/**
 * Calculate and update invoice totals (UPDATED FOR GRID LAYOUT)
 */
function calculateInvoiceTotal() {
  console.log('📊 Calculating invoice totals...');
  
  const container = document.getElementById('invoiceItemsBody');
  if (!container) {
    console.warn('⚠️ Invoice container not found');
    return;
  }
  
  let subtotal = 0;
  const rows = container.querySelectorAll('.invoice-product-row');
  
  console.log('🔍 Processing', rows.length, 'rows');
  
  // Process each row
  rows.forEach((row, rowIdx) => {
    const rowIndex = row.getAttribute('data-index');
    
    const qtyInput = document.getElementById(`invoiceQty-${rowIndex}`);
    const rateInput = document.getElementById(`invoiceRate-${rowIndex}`);
    const totalInput = document.getElementById(`invoiceRowTotal-${rowIndex}`);
    
    if (qtyInput && rateInput && totalInput) {
      const qty = parseFloat(qtyInput.value) || 0;
      const rate = parseFloat(rateInput.value) || 0;
      const rowTotal = qty * rate;
      
      // Update row total display
      totalInput.value = '₹' + rowTotal.toFixed(2);
      
      subtotal += rowTotal;
      
      console.log('  Row', rowIdx, ':', qty, 'x', rate, '=', rowTotal);
    }
  });
  
  console.log('✅ Subtotal calculated:', subtotal);
  
  // Get discount
  const discountInput = document.getElementById('invoiceDiscount');
  const discountTypeSelect = document.getElementById('invoiceDiscountType');
  let discountAmount = 0;
  
  if (discountInput && discountTypeSelect) {
    const discountValue = parseFloat(discountInput.value) || 0;
    const discountType = discountTypeSelect.value;
    
    if (discountType === 'percent') {
      discountAmount = (subtotal * discountValue) / 100;
    } else {
      discountAmount = discountValue;
    }
  }
  
  // Get tax rate
  const taxSelect = document.getElementById('invoiceTaxRate');
  let taxRate = 0;
  
  if (taxSelect) {
    taxRate = parseFloat(taxSelect.value) || 0;
  }
  
  // Calculate amounts
  const afterDiscount = subtotal - discountAmount;
  const taxAmount = (afterDiscount * taxRate) / 100;
  const grandTotal = afterDiscount + taxAmount;
  
  // Update display elements
  const subtotalSpan = document.getElementById('invoiceSubtotal');
  const discountAmountSpan = document.getElementById('invoiceDiscountAmount');
  const taxAmountSpan = document.getElementById('invoiceTaxAmount');
  const grandTotalSpan = document.getElementById('invoiceGrandTotal');
  
  if (subtotalSpan) {
    subtotalSpan.textContent = '₹' + subtotal.toFixed(2);
  }
  
  if (discountAmountSpan) {
    discountAmountSpan.textContent = '-₹' + discountAmount.toFixed(2);
  }
  
  if (taxAmountSpan) {
    taxAmountSpan.textContent = '₹' + taxAmount.toFixed(2);
  }
  
  if (grandTotalSpan) {
    grandTotalSpan.textContent = '₹' + grandTotal.toFixed(2);
  }
  
  console.log('✅ Totals updated:', {
    subtotal: subtotal.toFixed(2),
    discount: discountAmount.toFixed(2),
    tax: taxAmount.toFixed(2),
    grandTotal: grandTotal.toFixed(2)
  });
}

// Load Default Terms & Conditions
function loadDefaultTerms() {
  const defaultTerms = `1. Payment due within 14 days of invoice date
2. Late payments subject to 2% monthly interest charge
3. Goods once sold cannot be returned or exchanged
4. Delivery charges may apply for orders under ₹10,000
5. Company not responsible for damages during transit`;
  
  document.getElementById('invoiceTerms').value = defaultTerms;
}

/**
 * ==========================================
 * OPTIONAL: SAVE INVOICE TO FIREBASE
 * ==========================================
 */

/**
 * Save generated invoice to Firestore
 */
async function saveInvoiceToFirebase() {
  const user = window.auth.currentUser;
  if (!user) {
    alert('Please sign in to save invoice');
    return;
  }
  
  try {
    // Get invoice data from form
    const invoiceNo = document.getElementById('invoiceNumber')?.value;
    const invoiceDate = document.getElementById('invoiceDate')?.value;
    const dueDate = document.getElementById('invoiceDueDate')?.value;
    const customerName = document.getElementById('customerName')?.value;
    const customerEmail = document.getElementById('customerEmail')?.value;
    const customerPhone = document.getElementById('customerPhone')?.value;
    const customerAddress = document.getElementById('customerAddress')?.value;
    
    // Get items
    const items = [];
    const container = document.getElementById('invoiceItemsBody');
    const rows = container.querySelectorAll('.invoice-product-row');
    
    rows.forEach((row) => {
      const rowIndex = row.getAttribute('data-index');
      const product = document.getElementById(`invoiceProduct-${rowIndex}`)?.value;
      const qty = parseFloat(document.getElementById(`invoiceQty-${rowIndex}`)?.value) || 0;
      const rate = parseFloat(document.getElementById(`invoiceRate-${rowIndex}`)?.value) || 0;
      
      if (product && qty > 0 && rate > 0) {
        items.push({
          product: product,
          quantity: qty,
          rate: rate,
          amount: qty * rate
        });
      }
    });
    
    // Get totals
    const subtotal = parseFloat(document.getElementById('invoiceSubtotal')?.textContent.replace('₹', '') || 0);
    const discount = parseFloat(document.getElementById('invoiceDiscountAmount')?.textContent.replace('-₹', '') || 0);
    const tax = parseFloat(document.getElementById('invoiceTaxAmount')?.textContent.replace('₹', '') || 0);
    const grandTotal = parseFloat(document.getElementById('invoiceGrandTotal')?.textContent.replace('₹', '') || 0);
    
    // Get terms
    const terms = document.getElementById('invoiceTerms')?.value;
    
    // Build invoice object
    const invoiceData = {
      invoiceNumber: invoiceNo,
      invoiceDate: invoiceDate,
      dueDate: dueDate,
      customer: {
        name: customerName,
        email: customerEmail,
        phone: customerPhone,
        address: customerAddress
      },
      items: items,
      subtotal: subtotal,
      discount: discount,
      tax: tax,
      grandTotal: grandTotal,
      terms: terms,
      status: 'pending',
      createdAt: new Date().toISOString(),
      userId: user.uid
    };
    
    console.log('💾 Saving invoice to Firebase:', invoiceData);
    
    // Save to Firestore
    const { collection, addDoc } = window.firebaseImports;
    const invoicesRef = collection(window.db, 'tenants', user.uid, 'invoices');
    
    const docRef = await addDoc(invoicesRef, invoiceData);
    
    console.log('✅ Invoice saved to Firebase:', docRef.id);
    
    showSuccessToast(`✅ Invoice ${invoiceNo} saved successfully!`);
    
    return docRef.id;
    
  } catch (error) {
    console.error('❌ Error saving invoice:', error);
    alert('Failed to save invoice: ' + error.message);
    return null;
  }
}

/**
 * Load customer invoices from Firestore
 */
async function loadCustomerInvoices() {
  const user = window.auth.currentUser;
  if (!user) {
    console.log('No user authenticated, skipping invoice load');
    return;
  }
  
  try {
    const { collection, getDocs, query, orderBy } = window.firebaseImports;
    
    const invoicesRef = collection(window.db, 'tenants', user.uid, 'invoices');
    const q = query(invoicesRef, orderBy('createdAt', 'desc'));
    const snapshot = await getDocs(q);
    
    const invoices = [];
    snapshot.forEach((doc) => {
      invoices.push({
        id: doc.id,
        ...doc.data()
      });
    });
    
    console.log(`✅ Loaded ${invoices.length} invoices from Firebase`);
    
    // Store in global variable for display
    window.cachedInvoices = invoices;
    
    // If you have a display function, call it here
    if (typeof displayInvoices === 'function') {
      displayInvoices(invoices);
    }
    
    return invoices;
    
  } catch (error) {
    console.error('❌ Error loading invoices:', error);
    return [];
  }
}




/**
 * ==========================================
 * INVOICE BULK ADD MODAL
 * ==========================================
 */

// Global variable to store selected products
let selectedBulkProducts = {};

/**
 * Open Bulk Add Modal
 */
/**
 * Open Bulk Add Modal (WITH SAFETY CHECKS)
 */
function openBulkAddModal() {
  console.log('📦 Opening Bulk Add Modal for Invoice');
  
  // ✅ SAFE: Reset search input (check if exists first)
  const searchInput = document.getElementById('bulkSearchInput');
  if (searchInput) {
    searchInput.value = '';
  } else {
    console.warn('⚠️ bulkSearchInput element not found');
  }
  
  // ✅ ALWAYS RESET COMPLETELY
  selectedBulkProducts = {};
  
  // ✅ Clear selected items panel
  const selectedContainer = document.getElementById('bulkSelectedItems');
  if (selectedContainer) {
    selectedContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">No items selected</div>';
  }
  
  // ✅ Reset counters
  updateBulkCounters();
  
  // Render all products
  renderBulkProductsList('');
  
  // Show modal
  const modalElement = document.getElementById('bulkAddModal');
  if (modalElement) {
    const modal = new bootstrap.Modal(modalElement);
    modal.show();
    console.log('✅ Modal opened with clean state');
  } else {
    console.error('❌ bulkAddModal element not found!');
    alert('Error: Bulk Add Modal not found. Please check your HTML.');
  }
}


/**
 * Filter products by search query
 */
function filterBulkProducts(query) {
  console.log('🔍 Filtering bulk products:', query);
  renderBulkProductsList(query);
}

/**
 * Render products list on left side
 */
function renderBulkProductsList(searchQuery) {
  const container = document.getElementById('bulkProductsList');
  if (!container) return;
  
  const products = cachedProducts || [];
  let filtered = products;
  
  // Filter by search query
  if (searchQuery && searchQuery.trim().length > 0) {
    const query = searchQuery.toLowerCase();
    filtered = products.filter(product => {
      const name = product.name.toLowerCase();
      const brand = (product.brand || '').toLowerCase();
      const category = (product.category || '').toLowerCase();
      
      return name.includes(query) || brand.includes(query) || category.includes(query);
    });
  }
  
  if (filtered.length === 0) {
    container.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">No products found</div>';
    return;
  }
  
  let html = '';
  filtered.forEach(product => {
    const isSelected = selectedBulkProducts[product.id];
    const displayName = product.size ? `${product.name} (${product.size})` : product.name;
    const rateText = product.price ? `₹${product.price.toFixed(2)}` : 'N/A';
    const stockText = product.stock ? `Stock: ${product.stock}` : '';
    
    html += `
      <div onclick="toggleBulkProductSelection('${product.id}', '${escapeHtml(product.name)}', '${escapeHtml(product.size || '')}', ${product.price || 0})"
           style="
             padding: 12px;
             border-bottom: 1px solid #f0f0f0;
             cursor: pointer;
             transition: background-color 0.2s;
             display: flex;
             justify-content: space-between;
             align-items: center;
             ${isSelected ? 'background-color: #e3f2fd;' : 'background-color: white;'}
           "
           onmouseover="this.style.backgroundColor='#f5f5f5'"
           onmouseout="this.style.backgroundColor='${isSelected ? '#e3f2fd' : 'white'}'"
      >
        <div style="flex: 1;">
          <strong>${escapeHtml(displayName)}</strong>
          <div style="font-size: 0.85rem; color: #666;">
            ${rateText} ${stockText ? '• ' + stockText : ''}
          </div>
        </div>
        <div style="
          width: 24px;
          height: 24px;
          display: flex;
          align-items: center;
          justify-content: center;
          margin-left: 10px;
        ">
          ${isSelected ? '✓' : ''}
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
  console.log('✅ Rendered', filtered.length, 'products');
}

/**
 * Toggle product selection
 */
function toggleBulkProductSelection(productId, productName, productSize, productPrice) {
  console.log('✓ Toggle product:', productName);
  
  if (selectedBulkProducts[productId]) {
    // Remove if already selected
    delete selectedBulkProducts[productId];
    console.log('❌ Removed:', productName);
  } else {
    // Add if not selected
    selectedBulkProducts[productId] = {
      id: productId,
      name: productName,
      size: productSize,
      price: productPrice,
      qty: 1
    };
    console.log('✅ Added:', productName);
  }
  
  // Refresh both panels
  renderBulkProductsList(document.getElementById('bulkSearchInput').value);
  renderBulkSelectedItems();
}


/**
 * Render selected items with FIXED HORIZONTAL BUTTONS
 */
function renderBulkSelectedItems() {
  const container = document.getElementById('bulkSelectedItems');
  if (!container) return;
  
  const selectedArray = Object.values(selectedBulkProducts);
  
  if (selectedArray.length === 0) {
    container.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">No items selected</div>';
    updateBulkCounters();
    return;
  }
  
  let html = '';
  selectedArray.forEach((product, idx) => {
    const displayName = product.size ? `${product.name} (${product.size})` : product.name;
    
    html += `
      <div style="
        padding: 12px;
        border-bottom: 1px solid #ddd;
      ">
        <!-- Product Info (always on top) -->
        <div style="margin-bottom: 8px;">
          <strong style="display: block; font-size: 14px; margin-bottom: 4px;">
            ${escapeHtml(displayName)}
          </strong>
          <div style="font-size: 0.85rem; color: #666;">
            ₹${product.price.toFixed(2)}
          </div>
        </div>
        
        <!-- Quantity Controls (ALWAYS HORIZONTAL) -->
        <div style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          gap: 8px;
          flex-wrap: nowrap;
        ">
          <!-- LEFT: Minus, Qty, Plus (HORIZONTAL) -->
          <div style="
            display: flex;
            align-items: center;
            gap: 4px;
            flex-wrap: nowrap;
            min-width: 0;
          ">
            <!-- Minus Button -->
            <button type="button" class="bulk-qty-btn" 
                    onclick="updateBulkQty('${product.id}', -1)"
                    style="
                      padding: 6px 10px;
                      font-size: 16px;
                      background: #dc3545;
                      color: white;
                      border: none;
                      border-radius: 4px;
                      cursor: pointer;
                      min-width: 40px;
                      min-height: 40px;
                      font-weight: bold;
                      transition: background 0.2s;
                      flex-shrink: 0;
                    "
                    onmouseover="this.style.background='#c82333'"
                    onmouseout="this.style.background='#dc3545'">
              −
            </button>
            
            <!-- Quantity Input -->
            <input type="number" value="${product.qty}" 
                   class="bulk-qty-input"
                   style="
                     width: 50px;
                     padding: 6px;
                     text-align: center;
                     font-size: 14px;
                     font-weight: bold;
                     border: 1px solid #ddd;
                     border-radius: 4px;
                     flex-shrink: 0;
                   "
                   onchange="updateBulkQtyDirect('${product.id}', this.value)">
            
            <!-- Plus Button -->
            <button type="button" class="bulk-qty-btn" 
                    onclick="updateBulkQty('${product.id}', 1)"
                    style="
                      padding: 6px 10px;
                      font-size: 16px;
                      background: #28a745;
                      color: white;
                      border: none;
                      border-radius: 4px;
                      cursor: pointer;
                      min-width: 40px;
                      min-height: 40px;
                      font-weight: bold;
                      transition: background 0.2s;
                      flex-shrink: 0;
                    "
                    onmouseover="this.style.background='#218838'"
                    onmouseout="this.style.background='#28a745'">
              +
            </button>
          </div>
          
          <!-- RIGHT: Remove Button -->
          <button type="button" class="btn btn-sm btn-link text-danger bulk-remove-btn" 
                  onclick="toggleBulkProductSelection('${product.id}', '${escapeHtml(product.name)}', '${product.size}', ${product.price})"
                  style="
                    padding: 6px 10px;
                    font-size: 16px;
                    min-width: 40px;
                    min-height: 40px;
                    cursor: pointer;
                    flex-shrink: 0;
                  ">
            ✕
          </button>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
  updateBulkCounters();
  console.log('✅ Rendered', selectedArray.length, 'selected items (horizontal buttons)');
}

/**
 * Update quantity (increment/decrement)
 */
function updateBulkQty(productId, change) {
  if (selectedBulkProducts[productId]) {
    const newQty = Math.max(1, selectedBulkProducts[productId].qty + change);
    selectedBulkProducts[productId].qty = newQty;
    renderBulkSelectedItems();
    console.log('📊 Updated qty:', newQty);
  }
}

/**
 * Update quantity (direct input)
 */
function updateBulkQtyDirect(productId, value) {
  if (selectedBulkProducts[productId]) {
    const newQty = Math.max(1, parseInt(value) || 1);
    selectedBulkProducts[productId].qty = newQty;
    renderBulkSelectedItems();
    console.log('📊 Updated qty directly:', newQty);
  }
}

/**
 * Update counters (selected count, total qty)
 */
function updateBulkCounters() {
  const selectedArray = Object.values(selectedBulkProducts);
  const selectedCount = selectedArray.length;
  const totalQty = selectedArray.reduce((sum, p) => sum + p.qty, 0);
  
  document.getElementById('bulkSelectedCount').textContent = selectedCount;
  document.getElementById('bulkTotalQty').textContent = totalQty;
  
  console.log('📊 Counters: Selected=' + selectedCount + ', TotalQty=' + totalQty);
}

/**
 * ✅ Renumber all invoice rows after adding/removing (PREVENTS INDEX CONFLICTS)
 */
function renumberInvoiceRows() {
  const container = document.getElementById('invoiceItemsBody');
  if (!container) return;
  
  const rows = container.querySelectorAll('.invoice-product-row');
  
  rows.forEach((row, newIndex) => {
    const oldIndex = row.getAttribute('data-index');
    
    // Update row data-index
    row.setAttribute('data-index', newIndex);
    row.id = `invoiceRow${newIndex}`;
    
    // Update all input IDs
    const productInput = row.querySelector('input[id^="invoiceProduct-"]');
    const qtyInput = row.querySelector('input[id^="invoiceQty-"]');
    const rateInput = row.querySelector('input[id^="invoiceRate-"]');
    const totalInput = row.querySelector('input[id^="invoiceRowTotal-"]');
    const deleteBtn = row.querySelector('button[onclick*="deleteInvoiceRow"]');
    
    if (productInput) productInput.id = `invoiceProduct-${newIndex}`;
    if (qtyInput) {
      qtyInput.id = `invoiceQty-${newIndex}`;
      qtyInput.setAttribute('oninput', `updateInvoiceRowTotal(${newIndex}); calculateInvoiceTotal();`);
    }
    if (rateInput) {
      rateInput.id = `invoiceRate-${newIndex}`;
      rateInput.setAttribute('oninput', `updateInvoiceRowTotal(${newIndex}); calculateInvoiceTotal();`);
    }
    if (totalInput) totalInput.id = `invoiceRowTotal-${newIndex}`;
    if (deleteBtn) {
      deleteBtn.setAttribute('onclick', `deleteInvoiceRow(${newIndex})`);
    }
    
    console.log(`  Row ${oldIndex} → ${newIndex}`);
  });
  
  console.log('✅ Renumbered', rows.length, 'invoice rows');
}

/**
 * ✅ Add all selected products to invoice (FIXED DUPLICATE MATCHING)
 */
function addBulkProductsToInvoice() {
  const selectedArray = Object.values(selectedBulkProducts);
  
  if (selectedArray.length === 0) {
    alert('❌ Please select at least one product');
    return;
  }
  
  console.log('📦 Adding', selectedArray.length, 'products to invoice');
  
  const container = document.getElementById('invoiceItemsBody');
  if (!container) {
    console.error('❌ Invoice container not found');
    return;
  }
  
  selectedArray.forEach(product => {
    const productName = product.size ? `${product.name} (${product.size})` : product.name;
    
    // ✅ FIX: Get fresh list of rows and check each one's product name input
    const allRows = container.querySelectorAll('.invoice-product-row');
    let existingRow = null;
    
    allRows.forEach(row => {
      const rowIndex = row.getAttribute('data-index');
      const nameInput = document.getElementById(`invoiceProduct-${rowIndex}`);
      
      // Check if product name matches (exact match, trimmed)
      if (nameInput && nameInput.value.trim() === productName) {
        existingRow = row;
      }
    });
    
    if (existingRow) {
      // ✅ PRODUCT EXISTS - MERGE QUANTITY
      const rowIndex = existingRow.getAttribute('data-index');
      const qtyInput = document.getElementById(`invoiceQty-${rowIndex}`);
      
      if (qtyInput) {
        const currentQty = parseFloat(qtyInput.value) || 0;
        const newQty = currentQty + product.qty;
        qtyInput.value = newQty;
        
        // Update total
        updateInvoiceRowTotal(parseInt(rowIndex));
        
        console.log(`✅ Merged: ${productName} - Updated qty from ${currentQty} to ${newQty}`);
      }
    } else {
      // ✅ NEW PRODUCT - ADD TO TOP
      // Get fresh count for new index
      const currentRowCount = container.querySelectorAll('.invoice-product-row').length;
      const newRowIndex = currentRowCount;
      
      const item = {
        name: product.name,
        size: product.size || '',
        quantity: product.qty,
        rate: product.price
      };
      
      // ✅ Use createInvoiceRow function
      const rowHTML = createInvoiceRow(item, newRowIndex);
      
      // Add to top of container
      container.insertAdjacentHTML('afterbegin', rowHTML);
      
      console.log(`✅ Added new: ${productName} - Qty ${product.qty} at index ${newRowIndex}`);
    }
  });
  
  // ✅ After all products added, renumber all rows to fix indices
  renumberInvoiceRows();
  
  // Calculate totals
  setTimeout(() => {
    calculateInvoiceTotal();
  }, 50);
  
  // Clear selections and close modal
  selectedBulkProducts = {};
  const modal = bootstrap.Modal.getInstance(document.getElementById('bulkAddModal'));
  if (modal) {
    modal.hide();
  }
  
  console.log('✅ All products added/merged successfully!');
}


/**
 * Helper: Escape HTML characters
 */
function escapeHtml(text) {
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return String(text).replace(/[&<>"']/g, m => map[m]);
}









    



/**
 * ==========================================
 * SAVE INVOICE - FIREBASE VERSION
 * ==========================================
 */

async function saveInvoice() {
  console.log('💾 Save Invoice clicked');
  
  const user = window.auth.currentUser;
  if (!user) {
    alert('Please sign in to save invoice');
    return;
  }
  
  try {
    const customerName = document.getElementById('invoiceCustomerName')?.value.trim();
    
    if (!customerName) {
      alert('⚠️ Please enter customer name');
      return;
    }
    
    // Collect items from GRID LAYOUT (SKIP EMPTY ROWS)
    const items = [];
    const container = document.getElementById('invoiceItemsBody');
    
    if (container) {
      const rows = container.querySelectorAll('.invoice-product-row');
      
      rows.forEach(row => {
        const rowIndex = row.getAttribute('data-index');
        
        const nameInput = document.getElementById(`invoiceProduct-${rowIndex}`);
        const qtyInput = document.getElementById(`invoiceQty-${rowIndex}`);
        const rateInput = document.getElementById(`invoiceRate-${rowIndex}`);
        
        if (nameInput && qtyInput && rateInput) {
          const name = nameInput.value.trim();
          const qty = parseFloat(qtyInput.value) || 0;
          const rate = parseFloat(rateInput.value) || 0;
          
          if (name && (qty > 0 || rate > 0)) {
            items.push({
              name: name,
              quantity: qty,
              rate: rate,
              amount: qty * rate
            });
          }
        }
      });
    }
    
    if (items.length === 0) {
      alert('⚠️ Please add at least one product to the invoice');
      return;
    }
    
    // Calculate totals
    let subtotal = 0;
    items.forEach(item => {
      subtotal += item.amount;
    });
    
    const discount = parseFloat(document.getElementById('invoiceDiscount')?.value) || 0;
    const taxRate = parseFloat(document.getElementById('invoiceTaxRate')?.value) || 0;
    const taxableAmount = subtotal - discount;
    const tax = (taxableAmount * taxRate) / 100;
    const total = taxableAmount + tax;
    
    // Create invoice object
    const invoiceData = {
      invoiceNumber: document.getElementById('invoiceNumber').value,
      customerName: customerName,
      invoiceDate: document.getElementById('invoiceDate').value,
      dueDate: document.getElementById('invoiceDueDate').value,
      items: items,
      subtotal: subtotal,
      discount: discount,
      tax: tax,
      total: total,
      notes: document.getElementById('invoiceNotes')?.value || '',
      terms: document.getElementById('invoiceTerms')?.value || '',
      createdAt: new Date().toISOString(),
      userId: user.uid,
      userEmail: user.email
    };
    
    console.log('✅ Invoice data ready:', invoiceData);
    
    // ✅ Save to localStorage (immediate backup)
    let invoices = JSON.parse(localStorage.getItem('customerInvoices') || '[]');
    invoices.push(invoiceData);
    localStorage.setItem('customerInvoices', JSON.stringify(invoices));
    console.log('✅ Saved to localStorage');
    
    // ✅ Save to Firestore (cloud backup)
    let cloudSyncSuccess = false;
    let cloudSyncError = null;
    
    try {
      console.log('☁️ Saving invoice to Firestore...');
      
      const { collection, addDoc } = window.firebaseImports;
      const invoicesRef = collection(window.db, 'tenants', user.uid, 'invoices');
      
      const docRef = await addDoc(invoicesRef, invoiceData);
      
      cloudSyncSuccess = true;
      console.log('✅ Invoice saved to Firestore:', docRef.id);
      
    } catch (firebaseError) {
      cloudSyncError = firebaseError;
      console.error('❌ Firestore save error:', firebaseError);
    }
    
    // Show appropriate message
    if (cloudSyncSuccess) {
      alert(`✅ Invoice saved successfully!\n\n📄 Invoice: ${invoiceData.invoiceNumber}\n👤 Customer: ${customerName}\n📦 Items: ${items.length}\n💰 Total: ₹${total.toFixed(2)}\n\n☁️ Saved to cloud (Firestore)`);
    } else {
      alert(`✅ Invoice saved locally!\n\n📄 Invoice: ${invoiceData.invoiceNumber}\n💰 Total: ₹${total.toFixed(2)}\n\n⚠️ Cloud sync failed: ${cloudSyncError?.message || 'Unknown error'}\n\nThe invoice is saved on this device.`);
    }
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('invoiceModal'));
    if (modal) {
      modal.hide();
    }
    
    // Reload invoices list (if function exists)
    if (typeof loadCustomerInvoices === 'function') {
      setTimeout(() => {
        loadCustomerInvoices();
      }, 500);
    }
    
  } catch (error) {
    console.error('❌ Error saving invoice:', error);
    alert('❌ Error: ' + error.message);
  }
}


  
function previewInvoice() {
  console.log('👁️ Opening invoice preview...');
  
  // Collect invoice data
  const customerName = document.getElementById('invoiceCustomerName')?.value || 'Customer';
  const invoiceNumber = document.getElementById('invoiceNumber')?.value || 'INV-0000';
  const invoiceDate = document.getElementById('invoiceDate')?.value || new Date().toISOString().split('T')[0];
  const dueDate = document.getElementById('invoiceDueDate')?.value || invoiceDate;
  const paymentTerms = document.getElementById('paymentTerms')?.selectedOptions[0]?.text || 'Net 15';
  
  // ✅ FIX: Get invoice items from GRID LAYOUT (not table rows)
  const container = document.getElementById('invoiceItemsBody');
  let items = [];
  let subtotal = 0;
  
  console.log('📋 Parsing invoice items from grid layout...');
  
  if (container) {
    // ✅ Get all invoice-product-row divs (not tr elements)
    const rows = container.querySelectorAll('.invoice-product-row');
    console.log('✅ Found', rows.length, 'product rows');
    
    rows.forEach((row, idx) => {
      const rowIndex = row.getAttribute('data-index');
      
      // Get inputs by ID (more reliable)
      const nameInput = document.getElementById(`invoiceProduct-${rowIndex}`);
      const qtyInput = document.getElementById(`invoiceQty-${rowIndex}`);
      const rateInput = document.getElementById(`invoiceRate-${rowIndex}`);
      
      if (nameInput && qtyInput && rateInput) {
        const name = nameInput.value.trim();
        const qty = parseFloat(qtyInput.value) || 0;
        const rate = parseFloat(rateInput.value) || 0;
        const amount = qty * rate;
        
        console.log('  Row', idx, ':', name, 'x', qty, '@', rate, '=', amount);
        
       if (name && (qty > 0 || rate > 0)) { 
          items.push({
            name: name || 'Unnamed Item',
            quantity: qty,
            rate: rate,
            amount: amount
          });
          subtotal += amount;
        }
      } else {
        console.log('  ⏭️ Skipped empty row');
      }
    });
  }
  
  console.log('✅ Total items parsed:', items.length, 'Subtotal:', subtotal);
  
  // Get discount
  const discountInput = document.getElementById('invoiceDiscount');
  const discountTypeSelect = document.getElementById('invoiceDiscountType');
  let discountAmount = 0;
  
  if (discountInput && discountTypeSelect) {
    const discountValue = parseFloat(discountInput.value) || 0;
    const discountType = discountTypeSelect.value;
    
    if (discountType === 'percent') {
      discountAmount = (subtotal * discountValue) / 100;
    } else {
      discountAmount = discountValue;
    }
  }
  
  // Get tax
  const taxSelect = document.getElementById('invoiceTaxRate');
  let taxRate = 0;
  if (taxSelect) {
    taxRate = parseFloat(taxSelect.value) || 0;
  }
  
  const afterDiscount = subtotal - discountAmount;
  const tax = (afterDiscount * taxRate) / 100;
  const grandTotal = afterDiscount + tax;
  
  // Get notes and terms
  const notes = document.getElementById('invoiceNotes')?.value || '';
  const terms = document.getElementById('invoiceTerms')?.value || '';
  
  // Build items HTML
  let itemsHTML = '';
  if (items.length > 0) {
    items.forEach((item, index) => {
      itemsHTML += `
        <tr>
          <td style="text-align: center">${index + 1}</td>
          <td>${escapeHtml(item.name)}</td>
          <td style="text-align: center">${item.quantity}</td>
          <td style="text-align: right">₹${item.rate.toFixed(2)}</td>
          <td style="text-align: right">₹${item.amount.toFixed(2)}</td>
        </tr>
      `;
    });
  } else {
    itemsHTML = `<tr><td colspan="5" style="text-align: center; color: #999; padding: 20px;">No items added to invoice</td></tr>`;
  }
  
  // Generate HTML
  const invoiceHTML = `
    <!DOCTYPE html>
    <html>
    <head>
      <title>Invoice ${invoiceNumber}</title>
      <style>
        body { 
          font-family: Arial, sans-serif; 
          padding: 40px; 
          background: #f5f5f5;
          margin: 0;
        }
        .invoice-container {
          background: white;
          max-width: 900px;
          margin: 0 auto;
          padding: 30px;
          border-radius: 8px;
          box-shadow: 0 2 8px rgba(0,0,0,0.1);
        }
        .invoice-header { 
          text-align: center; 
          margin-bottom: 30px;
          border-bottom: 2px solid #007bff;
          padding-bottom: 20px;
        }
        .invoice-header h1 { margin: 0; color: #333; font-size: 32px; }
        .invoice-header h3 { margin: 5px 0 0 0; color: #666; font-size: 16px; }
        .invoice-details { 
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 30px;
          margin-bottom: 30px;
          padding-bottom: 20px;
          border-bottom: 1px solid #ddd;
        }
        .detail-group p {
          margin: 8px 0;
          font-size: 14px;
          line-height: 1.6;
        }
        .detail-group strong {
          color: #333;
          font-weight: 600;
        }
        table { 
          width: 100%; 
          border-collapse: collapse; 
          margin-bottom: 20px; 
        }
        th, td { 
          border: 1px solid #ddd; 
          padding: 12px; 
          font-size: 14px;
          text-align: left;
        }
        th { 
          background-color: #007bff;
          color: white;
          font-weight: bold;
        }
        tbody tr:nth-child(even) { background-color: #f9f9f9; }
        .totals-table {
          width: 450px;
          margin-left: auto;
          margin-bottom: 30px;
          border-collapse: collapse;
        }
        .totals-table td {
          border: 1px solid #ddd;
          padding: 12px;
          font-size: 14px;
        }
        .totals-table .label {
          font-weight: 600;
          color: #333;
          width: 70%;
        }
        .totals-table .amount {
          text-align: right;
          width: 30%;
          font-weight: 600;
          color: #333;
        }
        .totals-table .total-row {
          background-color: #d4edda;
          font-weight: bold;
          font-size: 16px;
        }
        .notes-section {
          margin-top: 30px;
          padding: 15px;
          border-top: 1px solid #ddd;
          font-size: 13px;
          color: #555;
        }
        .notes-section h4 {
          margin: 0 0 10px 0;
          color: #333;
          font-size: 14px;
          font-weight: 600;
        }
        .notes-section p {
          margin: 0;
          line-height: 1.5;
        }
        .terms-section {
          margin-top: 20px;
          font-size: 12px;
          color: #666;
          white-space: pre-wrap;
          background: #f9f9f9;
          padding: 15px;
          border-radius: 4px;
          border-left: 3px solid #007bff;
        }
        .terms-section strong {
          color: #333;
          display: block;
          margin-bottom: 10px;
          font-size: 13px;
        }
        .print-button {
          margin-top: 30px;
          text-align: center;
          padding-top: 20px;
          border-top: 1px solid #ddd;
        }
        .print-button button {
          padding: 12px 30px;
          font-size: 14px;
          background: #28a745;
          color: white;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          margin-right: 10px;
          font-weight: 600;
          transition: background 0.2s;
        }
        .print-button button:hover {
          background: #218838;
        }
        .print-button button.close-btn {
          background: #6c757d;
        }
        .print-button button.close-btn:hover {
          background: #5a6268;
        }
        @media print {
          body { background: white; padding: 0; }
          .invoice-container { box-shadow: none; }
          .print-button { display: none; }
          .invoice-details { border-bottom: 1px solid #000; }
        }
      </style>
    </head>
    <body>
      <div class="invoice-container">
        <div class="invoice-header">
          <h1>INVOICE</h1>
          <h3>Tile & Sanitaryware Inventory</h3>
        </div>
        
        <div class="invoice-details">
          <div class="detail-group">
            <p><strong>Invoice Number:</strong> ${invoiceNumber}</p>
            <p><strong>Invoice Date:</strong> ${new Date(invoiceDate).toLocaleDateString('en-IN')}</p>
            <p><strong>Payment Terms:</strong> ${paymentTerms}</p>
          </div>
          <div class="detail-group">
            <p><strong>Customer Name:</strong> ${escapeHtml(customerName)}</p>
            <p><strong>Due Date:</strong> ${new Date(dueDate).toLocaleDateString('en-IN')}</p>
          </div>
        </div>
        
        <table>
          <thead>
            <tr>
              <th style="width: 50px; text-align: center">#</th>
              <th>Item Description</th>
              <th style="width: 100px; text-align: center">Quantity</th>
              <th style="width: 120px; text-align: right">Rate</th>
              <th style="width: 120px; text-align: right">Amount</th>
            </tr>
          </thead>
          <tbody>
            ${itemsHTML}
          </tbody>
        </table>
        
        <table class="totals-table">
          <tr>
            <td class="label">Sub Total:</td>
            <td class="amount">₹${subtotal.toFixed(2)}</td>
          </tr>
          <tr>
            <td class="label">Discount:</td>
            <td class="amount">-₹${discountAmount.toFixed(2)}</td>
          </tr>
          <tr>
            <td class="label">Tax (${taxRate}%):</td>
            <td class="amount">₹${tax.toFixed(2)}</td>
          </tr>
          <tr class="total-row">
            <td class="label">Grand Total:</td>
            <td class="amount">₹${grandTotal.toFixed(2)}</td>
          </tr>
        </table>
        
        ${notes ? `
        <div class="notes-section">
          <h4>Customer Notes</h4>
          <p>${escapeHtml(notes)}</p>
        </div>
        ` : ''}
        
        ${terms ? `
        <div class="terms-section">
          <strong>Terms & Conditions:</strong>
          ${escapeHtml(terms)}
        </div>
        ` : ''}
        
        <div class="print-button">
          <button onclick="window.print()">🖨️ Print Invoice</button>
          <button class="close-btn" onclick="window.close()">✕ Close</button>
        </div>
      </div>
    </body>
    </html>
  `;
  
  // Open preview
  const previewWindow = window.open('', 'invoicePreview', 'width=950,height=1100');
  if (previewWindow) {
    previewWindow.document.write(invoiceHTML);
    previewWindow.document.close();
    console.log('✅ Preview opened with', items.length, 'items');
  } else {
    alert('❌ Preview window blocked. Please allow pop-ups.');
  }
}


 


/**
 * ==========================================
 * VIEW SAVED INVOICES 
 * ==========================================
 */

/**
 * ✅ UPDATED: View Invoices (with cloud sync)
 */
async function viewSavedInvoices() {
  console.log('📄 Opening saved invoices...');
  
  // Show loading modal
  const loadingModal = `
    <div class="modal fade" id="invoiceListModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
      <div class="modal-dialog modal-fullscreen-md-down modal-xl">
        <div class="modal-content">
          <div class="modal-header" style="background: #007bff; color: white;">
            <h5 class="modal-title">📄 Saved Invoices</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="invoiceListContent" style="min-height: 400px;">
            <div style="text-align: center; padding: 60px 20px;">
              <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
              <p style="margin-top: 20px; color: #666; font-size: 16px;">Loading invoices from cloud...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
  
  // Remove existing modal
  const existing = document.getElementById('invoiceListModal');
  if (existing) existing.remove();
  
  // Add modal
  document.body.insertAdjacentHTML('beforeend', loadingModal);
  
  // Show modal
  const modal = new bootstrap.Modal(document.getElementById('invoiceListModal'));
  modal.show();
  
  // Load invoices from cloud + localStorage
  try {
    const invoices = await loadCustomerInvoices();
    displayInvoiceList(invoices);
  } catch (error) {
    console.error('❌ Error loading invoices:', error);
    document.getElementById('invoiceListContent').innerHTML = `
      <div style="text-align: center; padding: 40px; color: #dc3545;">
        <i class="bi bi-exclamation-triangle" style="font-size: 48px;"></i>
        <p style="margin-top: 15px;">Failed to load invoices</p>
        <p style="font-size: 14px; color: #666;">${error.message}</p>
      </div>
    `;
  }
  
  // Cleanup on close
  document.getElementById('invoiceListModal').addEventListener('hidden.bs.modal', function() {
    this.remove();
  });
}

/**
 * ✅ Display invoice list in modal
 */
/**
 * ✅ FIXED: Display invoice list in modal
 * Uses invoiceNumber instead of index to avoid sort conflicts
 */
function displayInvoiceList(invoices) {
  const container = document.getElementById('invoiceListContent');
  
  if (!invoices || invoices.length === 0) {
    container.innerHTML = `
      <div style="text-align: center; padding: 60px 20px; color: #999;">
        <i class="bi bi-inbox" style="font-size: 64px;"></i>
        <p style="margin-top: 20px; font-size: 18px;">No invoices found</p>
        <p style="font-size: 14px;">Create your first invoice to get started</p>
      </div>
    `;
    return;
  }
  
  // Sort by date (newest first)
  invoices.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  
  let html = '<div class="table-responsive"><table class="table table-hover table-bordered">';
  html += '<thead style="background: #f8f9fa;"><tr>';
  html += '<th>Invoice #</th>';
  html += '<th>Customer</th>';
  html += '<th>Date</th>';
  html += '<th>Total</th>';
  html += '<th style="width: 150px; text-align: center;">Actions</th>';
  html += '</tr></thead><tbody>';
  
  invoices.forEach((invoice) => {
    const invoiceDate = new Date(invoice.invoiceDate).toLocaleDateString('en-IN');
    const total = parseFloat(invoice.total || 0).toFixed(2);
    
    html += '<tr>';
    html += `<td><strong>${escapeHtml(invoice.invoiceNumber)}</strong></td>`;
    html += `<td>${escapeHtml(invoice.customerName)}</td>`;
    html += `<td>${invoiceDate}</td>`;
    html += `<td><strong>₹${total}</strong></td>`;
    html += `<td style="text-align: center;">
      <button class="btn btn-sm btn-primary" onclick="previewSavedInvoice('${invoice.invoiceNumber}')" title="View Invoice">
        <i class="bi bi-eye"></i>
      </button>
      <button class="btn btn-sm btn-danger" onclick="deleteSavedInvoice('${invoice.invoiceNumber}')" title="Delete Invoice">
        <i class="bi bi-trash"></i>
      </button>
    </td>`;
    html += '</tr>';
  });
  
  html += '</tbody></table></div>';
  html += `<div style="padding: 15px; background: #f8f9fa; border-top: 1px solid #dee2e6; margin-top: 20px;">
    <p style="margin: 0; font-size: 14px; color: #666;">
      <i class="bi bi-info-circle"></i> Total Invoices: <strong>${invoices.length}</strong>
    </p>
  </div>`;
  
  container.innerHTML = html;
  console.log(`✅ Displayed ${invoices.length} invoices`);
}


/**
 * Initialize invoice list when View Invoices page loads
 */
async function initInvoiceListPage() {
  console.log('📄 Initializing invoice list page...');
  
  // Show loading
  const invoiceListContainer = document.getElementById('invoiceListContainer');
  if (invoiceListContainer) {
    invoiceListContainer.innerHTML = `
      <div style="text-align: center; padding: 40px;">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p style="margin-top: 15px; color: #666;">Loading invoices...</p>
      </div>
    `;
  }
  
  // Load invoices from cloud + localStorage
  const invoices = await loadCustomerInvoices();
  
  // Display invoices
  displayCustomerInvoiceList(invoices);
}

/**
 * Display customer invoice list
 */
function displayCustomerInvoiceList(invoices) {
  const container = document.getElementById('invoiceListContainer');
  
  if (!container) {
    console.error('❌ Invoice list container not found');
    return;
  }
  
  if (!invoices || invoices.length === 0) {
    container.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #999;">
        <i class="bi bi-inbox" style="font-size: 48px;"></i>
        <p style="margin-top: 15px;">No invoices found</p>
      </div>
    `;
    return;
  }
  
  // Sort by date (newest first)
  invoices.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  
  let html = '<div class="table-responsive"><table class="table table-hover">';
  html += '<thead><tr>';
  html += '<th>Invoice #</th>';
  html += '<th>Customer</th>';
  html += '<th>Date</th>';
  html += '<th>Total</th>';
  html += '<th>Actions</th>';
  html += '</tr></thead><tbody>';
  
  invoices.forEach(invoice => {
    const invoiceDate = new Date(invoice.invoiceDate).toLocaleDateString('en-IN');
    const total = parseFloat(invoice.total || 0).toFixed(2);
    
    html += '<tr>';
    html += `<td><strong>${invoice.invoiceNumber}</strong></td>`;
    html += `<td>${invoice.customerName}</td>`;
    html += `<td>${invoiceDate}</td>`;
    html += `<td>₹${total}</td>`;
    html += `<td>
      <button class="btn btn-sm btn-primary" onclick="viewInvoicePreview('${invoice.invoiceNumber}')">
        <i class="bi bi-eye"></i> View
      </button>
      <button class="btn btn-sm btn-danger" onclick="deleteCustomerInvoice('${invoice.invoiceNumber}')">
        <i class="bi bi-trash"></i>
      </button>
    </td>`;
    html += '</tr>';
  });
  
  html += '</tbody></table></div>';
  container.innerHTML = html;
  
  console.log(`✅ Displayed ${invoices.length} invoices`);
}


/**
 * ✅ FIXED: Preview saved invoice by invoiceNumber (not index)
 * Works correctly with sorted lists
 */
function previewSavedInvoice(invoiceNumber) {
  console.log('👁️ Previewing invoice:', invoiceNumber);
  
  try {
    // Get invoice from localStorage
    const invoices = JSON.parse(localStorage.getItem('customerInvoices') || '[]');
    
    // ✅ FIX: Find invoice by invoiceNumber (not by index)
    const inv = invoices.find(invoice => invoice.invoiceNumber === invoiceNumber);
    
    if (!inv) {
      alert('❌ Invoice not found: ' + invoiceNumber);
      console.error('❌ Invoice not found:', invoiceNumber);
      return;
    }
    
    console.log('📄 Invoice data:', inv);
    
    // Detect mobile
    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent) || window.innerWidth < 768;
    
    // Close parent modal first
    const parentModal = document.getElementById('invoiceListModal');
    if (parentModal) {
      const bsModal = bootstrap.Modal.getInstance(parentModal);
      if (bsModal) {
        bsModal.hide();
      }
    }
    
    // Wait for modal to close, then show preview
    setTimeout(() => {
      if (isMobile) {
        showInvoiceModal(inv);
      } else {
        showInvoiceWindow(inv);
      }
    }, 300);
    
  } catch (error) {
    console.error('❌ Error:', error);
    alert('❌ Error: ' + error.message);
  }
}

/**
 * ✅ Show invoice in modal (mobile-optimized)
 */
function showInvoiceModal(inv) {
  const invoiceHTML = generateInvoiceHTML(inv);
  
  const modalHTML = `
    <div class="modal fade" id="invoicePreviewModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
      <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
          <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; position: sticky; top: 0; z-index: 1000;">
            <h5 class="modal-title">
              <i class="bi bi-file-earmark-text"></i> 
              Invoice ${escapeHtml(inv.invoiceNumber)}
            </h5>
            <button type="button" class="btn-close btn-close-white" onclick="closeInvoicePreview()"></button>
          </div>
          <div class="modal-body" style="padding: 0; background: #f5f5f5; overflow-y: auto;">
            ${invoiceHTML}
          </div>
          <div class="modal-footer" style="position: sticky; bottom: 0; background: white; border-top: 2px solid #dee2e6; z-index: 999;">
            <button type="button" class="btn btn-secondary" onclick="closeInvoicePreview()">
              <i class="bi bi-arrow-left"></i> Back
            </button>
            <button type="button" class="btn btn-success" onclick="printInvoiceFromModal('${inv.invoiceNumber}')">
              <i class="bi bi-printer"></i> Print
            </button>
          </div>
        </div>
      </div>
    </div>
  `;
  
  // Remove existing modals
  document.querySelectorAll('#invoicePreviewModal').forEach(el => el.remove());
  
  // Add new modal
  document.body.insertAdjacentHTML('beforeend', modalHTML);
  
  // Show modal with a slight delay
  setTimeout(() => {
    const modal = new bootstrap.Modal(document.getElementById('invoicePreviewModal'), {
      backdrop: 'static',
      keyboard: false
    });
    modal.show();
    console.log('✅ Invoice modal opened');
  }, 100);
}

/**
 * ✅ Close invoice preview and reopen invoice list
 */
function closeInvoicePreview() {
  const previewModal = document.getElementById('invoicePreviewModal');
  if (previewModal) {
    const bsModal = bootstrap.Modal.getInstance(previewModal);
    if (bsModal) {
      bsModal.hide();
    }
    
    // Remove modal after animation
    setTimeout(() => {
      previewModal.remove();
      
      // Reopen invoice list
      viewSavedInvoices();
    }, 300);
  }
}

/**
 * ✅ Show invoice in window (for laptop)
 */
function showInvoiceWindow(inv) {
  const invoiceHTML = generateInvoiceHTML(inv);
  
  const fullHTML = `
    <!DOCTYPE html>
    <html>
    <head>
      <title>Invoice ${escapeHtml(inv.invoiceNumber)}</title>
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <style>
        body { 
          font-family: Arial, sans-serif; 
          margin: 0; 
          padding: 0;
          background: #f5f5f5;
        }
        .print-buttons {
          text-align: center;
          padding: 20px;
          background: white;
          border-top: 2px solid #dee2e6;
          position: sticky;
          bottom: 0;
          box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
        }
        .print-buttons button {
          padding: 12px 30px;
          font-size: 14px;
          font-weight: 600;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          margin: 0 5px;
          transition: all 0.2s;
        }
        .print-btn {
          background: #28a745;
          color: white;
        }
        .print-btn:hover {
          background: #218838;
          transform: translateY(-2px);
          box-shadow: 0 4px 8px rgba(40,167,69,0.3);
        }
        .close-btn {
          background: #6c757d;
          color: white;
        }
        .close-btn:hover {
          background: #5a6268;
          transform: translateY(-2px);
          box-shadow: 0 4px 8px rgba(108,117,125,0.3);
        }
        @media print {
          body { background: white; }
          .print-buttons { display: none; }
        }
      </style>
    </head>
    <body>
      ${invoiceHTML}
      <div class="print-buttons">
        <button class="print-btn" onclick="window.print()">
          <i class="bi bi-printer"></i> 🖨️ Print Invoice
        </button>
        <button class="close-btn" onclick="window.close()">
          ✕ Close Window
        </button>
      </div>
    </body>
    </html>
  `;
  
  const win = window.open('', 'InvoicePreview', 'width=950,height=1100,scrollbars=yes');
  if (win) {
    win.document.write(fullHTML);
    win.document.close();
    console.log('✅ Invoice window opened');
  } else {
    alert('❌ Pop-up blocked. Please allow pop-ups and try again.');
  }
}


/**
 * ✅ Generate invoice HTML (mobile responsive)
 */
function generateInvoiceHTML(inv) {
  // Build items table
  let itemsHTML = '';
  if (inv.items && inv.items.length > 0) {
    inv.items.forEach((item, idx) => {
      itemsHTML += `
        <tr>
          <td style="text-align: center; font-weight: 600; color: #666;">${idx + 1}</td>
          <td style="font-weight: 500;">${escapeHtml(item.name)}</td>
          <td style="text-align: center; font-weight: 600;">${item.quantity}</td>
          <td style="text-align: right; color: #28a745; font-weight: 600;">₹${parseFloat(item.rate || 0).toFixed(2)}</td>
          <td style="text-align: right; color: #007bff; font-weight: 700;">₹${parseFloat(item.amount || 0).toFixed(2)}</td>
        </tr>
      `;
    });
  } else {
    itemsHTML = `<tr><td colspan="5" style="text-align: center; color: #999; padding: 30px;">No items</td></tr>`;
  }
  
  const subtotal = parseFloat(inv.subtotal || 0);
  const discount = parseFloat(inv.discount || 0);
  const tax = parseFloat(inv.tax || 0);
  const total = parseFloat(inv.total || 0);
  
  return `
    <style>
      .invoice-container {
        background: white;
        max-width: 900px;
        margin: 0 auto;
        padding: 30px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }
      .invoice-header {
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 3px solid #667eea;
        background: linear-gradient(135deg, #667eea22 0%, #764ba222 100%);
        padding: 20px;
        border-radius: 8px;
      }
      .invoice-header h1 {
        margin: 0;
        color: #667eea;
        font-size: 36px;
        font-weight: 800;
        letter-spacing: 2px;
      }
      .invoice-header h3 {
        margin: 8px 0 0 0;
        color: #666;
        font-size: 16px;
        font-weight: 400;
      }
      .invoice-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
      }
      .detail-group p {
        margin: 10px 0;
        font-size: 14px;
        line-height: 1.8;
      }
      .detail-group strong {
        color: #333;
        font-weight: 700;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      }
      th, td {
        border: 1px solid #dee2e6;
        padding: 14px;
        font-size: 14px;
      }
      th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      tbody tr:nth-child(even) {
        background-color: #f8f9fa;
      }
      tbody tr:hover {
        background-color: #e9ecef;
      }
      .totals-table {
        width: 100%;
        max-width: 450px;
        margin-left: auto;
        margin-bottom: 30px;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        overflow: hidden;
      }
      .totals-table td {
        padding: 14px;
        font-size: 15px;
        border: none;
        border-bottom: 1px solid #dee2e6;
      }
      .totals-table tr:last-child td {
        border-bottom: none;
      }
      .totals-table .label {
        font-weight: 600;
        color: #495057;
      }
      .totals-table .amount {
        text-align: right;
        font-weight: 700;
        color: #212529;
      }
      .totals-table .total-row {
        background: linear-gradient(135deg, #667eea22 0%, #764ba222 100%);
        font-size: 18px;
      }
      .totals-table .total-row .amount {
        color: #667eea;
        font-size: 20px;
      }
      .notes-section {
        margin-top: 30px;
        padding: 20px;
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        border-radius: 4px;
      }
      .notes-section h4 {
        margin: 0 0 10px 0;
        color: #856404;
        font-size: 16px;
      }
      .terms-section {
        margin-top: 20px;
        padding: 20px;
        background: #d4edda;
        border-left: 4px solid #28a745;
        border-radius: 4px;
        font-size: 13px;
        color: #155724;
      }
      .terms-section strong {
        display: block;
        margin-bottom: 10px;
        font-size: 15px;
        color: #155724;
      }
      
      /* Mobile Responsive */
      @media (max-width: 768px) {
        .invoice-container {
          padding: 15px;
        }
        .invoice-header h1 {
          font-size: 28px;
        }
        .invoice-details {
          grid-template-columns: 1fr;
          gap: 10px;
          padding: 15px;
        }
        .detail-group p {
          font-size: 13px;
          margin: 8px 0;
        }
        table {
          font-size: 12px;
        }
        th, td {
          padding: 10px 8px;
        }
        .totals-table {
          width: 100%;
        }
        .totals-table td {
          padding: 12px;
          font-size: 14px;
        }
        .notes-section, .terms-section {
          padding: 15px;
          font-size: 12px;
        }
      }
      
      @media print {
        body {
          background: white;
        }
        .invoice-container {
          box-shadow: none;
          padding: 20px;
        }
      }
    </style>
    
    <div class="invoice-container">
      <div class="invoice-header">
        <h1>INVOICE</h1>
        <h3>Tile & Sanitaryware Inventory</h3>
      </div>
      
      <div class="invoice-details">
        <div class="detail-group">
          <p><strong>Invoice #:</strong> ${escapeHtml(inv.invoiceNumber)}</p>
          <p><strong>Invoice Date:</strong> ${new Date(inv.invoiceDate).toLocaleDateString('en-IN')}</p>
          <p><strong>Created:</strong> ${new Date(inv.createdAt).toLocaleDateString('en-IN')}</p>
        </div>
        <div class="detail-group">
          <p><strong>Customer:</strong> ${escapeHtml(inv.customerName)}</p>
          <p><strong>Due Date:</strong> ${new Date(inv.dueDate).toLocaleDateString('en-IN')}</p>
        </div>
      </div>
      
      <table>
        <thead>
          <tr>
            <th style="width: 40px; text-align: center">#</th>
            <th>Description</th>
            <th style="width: 80px; text-align: center">Qty</th>
            <th style="width: 100px; text-align: right">Rate</th>
            <th style="width: 120px; text-align: right">Amount</th>
          </tr>
        </thead>
        <tbody>
          ${itemsHTML}
        </tbody>
      </table>
      
      <table class="totals-table">
        <tr>
          <td class="label">Sub Total:</td>
          <td class="amount">₹${subtotal.toFixed(2)}</td>
        </tr>
        <tr>
          <td class="label">Discount:</td>
          <td class="amount">-₹${discount.toFixed(2)}</td>
        </tr>
        <tr>
          <td class="label">Tax (GST):</td>
          <td class="amount">₹${tax.toFixed(2)}</td>
        </tr>
        <tr class="total-row">
          <td class="label">GRAND TOTAL:</td>
          <td class="amount">₹${total.toFixed(2)}</td>
        </tr>
      </table>
      
      ${inv.notes ? `
      <div class="notes-section">
        <h4>📝 Notes</h4>
        <p style="margin: 0; line-height: 1.6;">${escapeHtml(inv.notes)}</p>
      </div>
      ` : ''}
      
      ${inv.terms ? `
      <div class="terms-section">
        <strong>📜 Terms & Conditions</strong>
        <div style="white-space: pre-wrap; line-height: 1.6;">${escapeHtml(inv.terms)}</div>
      </div>
      ` : ''}
    </div>
  `;
}

    


/**
 * Load customer invoices from Firestore
 * ✅ FIREBASE VERSION
 */
async function loadCustomerInvoices() {
  console.log('☁️ Loading customer invoices from Firestore...');
  
  const user = window.auth.currentUser;
  
  if (!user) {
    console.log('No user authenticated, loading from localStorage only');
    const localInvoices = JSON.parse(localStorage.getItem('customerInvoices') || '[]');
    return localInvoices;
  }
  
  try {
    const { collection, getDocs, query, orderBy } = window.firebaseImports;
    
    const invoicesRef = collection(window.db, 'tenants', user.uid, 'invoices');
    const q = query(invoicesRef, orderBy('createdAt', 'desc'));
    const snapshot = await getDocs(q);
    
    const cloudInvoices = [];
    snapshot.forEach((doc) => {
      cloudInvoices.push({
        id: doc.id,
        ...doc.data()
      });
    });
    
    console.log(`✅ Loaded ${cloudInvoices.length} invoices from Firestore`);
    
    // Merge with localStorage invoices
    const localInvoices = JSON.parse(localStorage.getItem('customerInvoices') || '[]');
    const invoiceMap = new Map();
    
    // Cloud invoices first (source of truth)
    cloudInvoices.forEach(inv => {
      invoiceMap.set(inv.invoiceNumber, inv);
    });
    
    // Add local invoices not in cloud
    localInvoices.forEach(inv => {
      if (!invoiceMap.has(inv.invoiceNumber)) {
        invoiceMap.set(inv.invoiceNumber, inv);
      }
    });
    
    const mergedInvoices = Array.from(invoiceMap.values());
    
    // Save merged data to localStorage
    localStorage.setItem('customerInvoices', JSON.stringify(mergedInvoices));
    
    console.log(`✅ Total invoices: ${mergedInvoices.length} (${cloudInvoices.length} from cloud + ${localInvoices.length} local)`);
    
    // Store in global variable
    window.cachedInvoices = mergedInvoices;
    
    return mergedInvoices;
    
  } catch (error) {
    console.error('❌ Error loading invoices from Firestore:', error.message);
    
    // Fallback to localStorage
    const localInvoices = JSON.parse(localStorage.getItem('customerInvoices') || '[]');
    console.log(`⚠️ Cloud load failed, using ${localInvoices.length} local invoices`);
    
    return localInvoices;
  }
}


  

/**
 * Delete invoice from localStorage and Firestore
 * ✅ FIREBASE VERSION
 */
async function deleteSavedInvoice(invoiceNumber) {
  console.log('🗑️ Deleting invoice:', invoiceNumber);
  
  if (!confirm(`Are you sure you want to delete invoice ${invoiceNumber}?\n\nThis action cannot be undone.`)) {
    return;
  }
  
  const user = window.auth.currentUser;
  
  try {
    // Get invoices from localStorage
    let invoices = JSON.parse(localStorage.getItem('customerInvoices') || '[]');
    
    // Find invoice by invoiceNumber
    const invoiceIndex = invoices.findIndex(inv => inv.invoiceNumber === invoiceNumber);
    
    if (invoiceIndex === -1) {
      alert('❌ Invoice not found: ' + invoiceNumber);
      return;
    }
    
    // Remove from array
    invoices.splice(invoiceIndex, 1);
    
    // Save back to localStorage
    localStorage.setItem('customerInvoices', JSON.stringify(invoices));
    console.log('✅ Deleted from localStorage');
    
    // Delete from Firestore
    if (user) {
      try {
        const { collection, query, where, getDocs, deleteDoc, doc } = window.firebaseImports;
        
        const invoicesRef = collection(window.db, 'tenants', user.uid, 'invoices');
        const q = query(invoicesRef, where('invoiceNumber', '==', invoiceNumber));
        const snapshot = await getDocs(q);
        
        if (!snapshot.empty) {
          // Delete all matching invoices (should be only one)
          const deletePromises = [];
          snapshot.forEach((docSnapshot) => {
            const docRef = doc(window.db, 'tenants', user.uid, 'invoices', docSnapshot.id);
            deletePromises.push(deleteDoc(docRef));
          });
          
          await Promise.all(deletePromises);
          console.log('✅ Deleted from Firestore');
        } else {
          console.warn('⚠️ Invoice not found in Firestore');
        }
        
      } catch (firebaseError) {
        console.error('❌ Failed to delete from Firestore:', firebaseError);
        alert(`⚠️ Invoice deleted locally but cloud deletion failed.\n\n${firebaseError.message}`);
      }
    } else {
      console.log('No user authenticated, skipped cloud deletion');
    }
    
    alert(`✅ Invoice ${invoiceNumber} deleted successfully`);
    
    // Refresh the list
    viewSavedInvoices();
    
  } catch (error) {
    console.error('❌ Delete error:', error);
    alert('❌ Error deleting invoice: ' + error.message);
  }
}


// ==========================================
// SHARE INVOICE FEATURE
// ==========================================

// Share Invoice as Image (Primary Method)
async function shareInvoiceAsImage() {
  // Validate customer name
  const customerName = document.getElementById('invoiceCustomerName').value.trim();
  if (!customerName) {
    alert('âŒ Please enter customer name before sharing');
    return;
  }
  
  showLoading('Generating image...');
  
  try {
    // Get invoice data
    const invoiceData = collectInvoiceData();
    
    // Generate invoice HTML in hidden container
    const tempContainer = document.createElement('div');
    tempContainer.style.cssText = 'position:absolute;left:-9999px;top:0;background:white;width:800px;padding:40px;';
    tempContainer.innerHTML = generateInvoiceHTMLForImage(invoiceData);
    document.body.appendChild(tempContainer);
    
    // Wait for fonts to load
    await document.fonts.ready;
    
    // Convert to canvas
    const canvas = await html2canvas(tempContainer, {
      backgroundColor: '#ffffff',
      scale: 2,
      logging: false,
      windowWidth: 800,
      windowHeight: tempContainer.scrollHeight
    });
    
    // Remove temp container
    document.body.removeChild(tempContainer);
    
    hideLoading();
    
    // Convert canvas to blob
    canvas.toBlob(async (blob) => {
      const fileName = `Invoice_${invoiceData.invoiceNumber}_${invoiceData.customerName.replace(/\s+/g, '_')}.png`;
      const file = new File([blob], fileName, { type: 'image/png' });
      
      // Try Web Share API (mobile & modern browsers)
      if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
        try {
          await navigator.share({
            title: `Invoice ${invoiceData.invoiceNumber}`,
            text: `Invoice for ${invoiceData.customerName} - ₹${invoiceData.total.toFixed(2)}`,
            files: [file]
          });
          console.log('âœ… Invoice shared successfully');
        } catch (err) {
          if (err.name !== 'AbortError') {
            console.error('Share failed:', err);
            fallbackDownloadImage(canvas, fileName);
          }
        }
      } else {
        // Fallback: Download image
        fallbackDownloadImage(canvas, fileName);
      }
    }, 'image/png', 0.95);
    
  } catch (error) {
    hideLoading();
    console.error('Error generating image:', error);
    alert('âŒ Error generating invoice image. Please try again.');
  }
}

/**
 * ==========================================
 * âœ… NEW: Share Invoice Image on WhatsApp Number
 * ==========================================
 */

// Open WhatsApp number input modal
function shareImageToWhatsAppNumber() {
  // Validate customer name first
  const customerName = document.getElementById('invoiceCustomerName').value.trim();
  if (!customerName) {
    alert('âŒ Please enter customer name before sharing');
    return;
  }
  
  // Load saved number if exists
  const savedNumber = localStorage.getItem('whatsappNumber');
  if (savedNumber) {
    document.getElementById('whatsappNumberInput').value = savedNumber;
    document.getElementById('saveWhatsAppNumber').checked = true;
  }
  
  // Show modal
  const modal = new bootstrap.Modal(document.getElementById('whatsappNumberModal'));
  modal.show();
  
  // Focus input after modal opens
  setTimeout(() => {
    document.getElementById('whatsappNumberInput').focus();
  }, 500);
}

// Send invoice image to specific WhatsApp number (FINAL FIX - NO STRING ESCAPING ISSUES)
async function sendInvoiceToWhatsApp() {
  const numberInput = document.getElementById('whatsappNumberInput');
  const phoneNumber = numberInput.value.trim();
  
  // Validation
  if (!phoneNumber) {
    alert('❌ Please enter WhatsApp number');
    numberInput.focus();
    return;
  }
  
  if (!/^[0-9]{10}$/.test(phoneNumber)) {
    alert('❌ Please enter a valid 10-digit mobile number');
    numberInput.focus();
    return;
  }
  
  // Save number if checkbox checked
  if (document.getElementById('saveWhatsAppNumber').checked) {
    localStorage.setItem('whatsappNumber', phoneNumber);
  }
  
  // Close number input modal
  const numberModal = bootstrap.Modal.getInstance(document.getElementById('whatsappNumberModal'));
  if (numberModal) {
    numberModal.hide();
  }
  
  // Detect iOS
  const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
  
  // Show loading
  showLoading('Preparing invoice for WhatsApp...');
  
  try {
    // Get invoice data
    const invoiceData = collectInvoiceData();
    
    // Generate invoice HTML
    const tempContainer = document.createElement('div');
    tempContainer.style.cssText = 'position:absolute;left:-9999px;top:0;background:white;width:800px;padding:40px;';
    tempContainer.innerHTML = generateInvoiceHTMLForImage(invoiceData);
    document.body.appendChild(tempContainer);
    
    await document.fonts.ready;
    
    // Convert to canvas
    const canvas = await html2canvas(tempContainer, {
      backgroundColor: '#ffffff',
      scale: 2,
      logging: false,
      windowWidth: 800,
      windowHeight: tempContainer.scrollHeight
    });
    
    document.body.removeChild(tempContainer);
    
    hideLoading();
    
    // Full phone number with country code
    const fullNumber = '91' + phoneNumber;
    
    // Convert canvas to blob
    canvas.toBlob(async (blob) => {
      const fileName = 'Invoice_' + invoiceData.invoiceNumber + '_' + invoiceData.customerName.replace(/\s+/g, '_') + '.png';
      
      // iOS FIX: Different handling for iPhone
      if (isIOS) {
        // Step 1: Show the image in a new window for user to save manually
        const imageUrl = canvas.toDataURL('image/png');
        const newWindow = window.open('', '_blank');
        
        if (newWindow) {
          // ✅ FINAL FIX: Build HTML using DOM methods (no string escaping needed!)
          const doc = newWindow.document;
          doc.open();
          doc.write('<!DOCTYPE html><html><head>');
          doc.write('<meta name="viewport" content="width=device-width, initial-scale=1">');
          doc.write('<title>Invoice Image</title>');
          
          // Add styles
          const style = doc.createElement('style');
          style.textContent = 
            'body { margin: 0; padding: 20px; text-align: center; background: #f0f0f0; font-family: Arial, sans-serif; }' +
            'img { max-width: 100%; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); margin-top: 20px; }' +
            '.instructions { background: white; padding: 20px; border-radius: 10px; margin: 20px auto; max-width: 90%; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }' +
            'button { background: #25D366; color: white; border: none; padding: 15px 30px; border-radius: 25px; font-size: 16px; font-weight: bold; margin: 10px; cursor: pointer; }' +
            'ol { text-align: left; line-height: 1.8; }';
          doc.head.appendChild(style);
          doc.write('</head><body>');
          
          // Add instructions
          doc.write('<div class="instructions">');
          doc.write('<h2 style="color: #25D366;">📱 Save & Share Invoice</h2>');
          doc.write('<ol>');
          doc.write('<li><strong>Tap and hold</strong> on the invoice image below</li>');
          doc.write('<li>Select <strong>"Add to Photos"</strong> or <strong>"Save Image"</strong></li>');
          doc.write('<li>Click the <strong>"Open WhatsApp"</strong> button below</li>');
          doc.write('<li>In WhatsApp, tap <strong>📎</strong> → <strong>Gallery</strong> → Select invoice → Send</li>');
          doc.write('</ol>');
          doc.write('<button id="waBtn">📱 Open WhatsApp Chat</button>');
          doc.write('</div>');
          
          // Add image
          doc.write('<img src="' + imageUrl + '" alt="Invoice">');
          
          doc.write('</body></html>');
          doc.close();
          
          // Add WhatsApp button click handler
          const waBtn = doc.getElementById('waBtn');
          if (waBtn) {
            waBtn.onclick = function() {
              const waUrl = 'whatsapp://send?phone=' + fullNumber + '&text=' + 
                encodeURIComponent('Invoice ' + invoiceData.invoiceNumber + ' - ₹' + invoiceData.total.toFixed(2));
              newWindow.location.href = waUrl;
            };
          }
          
        } else {
          // Popup blocked - fallback to download
          const link = document.createElement('a');
          link.download = fileName;
          link.href = imageUrl;
          link.click();
          
          // Open WhatsApp after short delay
          setTimeout(function() {
            window.location.href = 'whatsapp://send?phone=' + fullNumber + '&text=' + 
              encodeURIComponent('Invoice ' + invoiceData.invoiceNumber);
          }, 500);
        }
        
      } else {
        // Android/Desktop: Standard download method
        const link = document.createElement('a');
        link.download = fileName;
        link.href = canvas.toDataURL('image/png');
        link.click();
        
        // Show notification
        alert('✅ Invoice downloaded: ' + fileName + '\n\n📱 WhatsApp will open now. Attach the downloaded invoice from Gallery.');
        
        // Open WhatsApp
        setTimeout(function() {
          const message = encodeURIComponent(
            '📄 Invoice ' + invoiceData.invoiceNumber + '\n' +
            'Customer: ' + invoiceData.customerName + '\n' +
            'Amount: ₹' + invoiceData.total.toFixed(2)
          );
          window.location.href = 'whatsapp://send?phone=' + fullNumber + '&text=' + message;
        }, 1000);
      }
      
    }, 'image/png', 0.95);
    
  } catch (error) {
    hideLoading();
    console.error('Error generating invoice image:', error);
    alert('❌ Error generating invoice image. Please try again.');
  }
}


// Helper: Detect mobile device
function isMobileDevice() {
  return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}

// Helper: Download invoice image
function downloadInvoiceImage(canvas, fileName) {
  const link = document.createElement('a');
  link.download = fileName;
  link.href = canvas.toDataURL('image/png');
  link.click();
}

// Fallback: Download image and open WhatsApp
function fallbackWhatsAppShare(phoneNumber, invoiceData, canvas, fileName) {
  // Download image
  downloadInvoiceImage(canvas, fileName);
  
  // Prepare WhatsApp message
  const message = encodeURIComponent(
    `ðŸ“„ Invoice ${invoiceData.invoiceNumber}\n` +
    `Customer: ${invoiceData.customerName}\n` +
    `Amount: ₹${invoiceData.total.toFixed(2)}`
  );
  
  // Open WhatsApp with the specific number
  const whatsappUrl = isMobileDevice() 
    ? `whatsapp://send?phone=${phoneNumber}&text=${message}`
    : `https://wa.me/${phoneNumber}?text=${message}`;
  
  if (isMobileDevice()) {
    // Mobile: Open WhatsApp app directly
    window.location.href = whatsappUrl;
    
    setTimeout(() => {
      alert('ðŸ“± Steps to send invoice:\n\n1. Tap attach button (ðŸ“Ž)\n2. Select "Gallery" or "Photos"\n3. Choose the downloaded invoice\n4. Tap Send âœ“\n\nThe invoice image is saved in your downloads/gallery.');
    }, 1000);
  } else {
    // Desktop: Open WhatsApp Web
    window.open(whatsappUrl, '_blank');
    alert('âœ… Invoice image downloaded!\nðŸ“± WhatsApp Web opened - please attach the downloaded image and send.');
  }
}


// Fallback: Open WhatsApp Web with message and download image
function fallbackWhatsAppShare(phoneNumber, invoiceData, canvas, fileName) {
  // Download image
  const link = document.createElement('a');
  link.download = fileName;
  link.href = canvas.toDataURL('image/png');
  link.click();
  
  // Open WhatsApp Web with pre-filled message
  const message = encodeURIComponent(
    `ðŸ“„ Invoice ${invoiceData.invoiceNumber}\n` +
    `Customer: ${invoiceData.customerName}\n` +
    `Amount: ₹${invoiceData.total.toFixed(2)}\n\n` +
    `Invoice image downloaded. Please attach and send.`
  );
  
  const whatsappUrl = `https://wa.me/${phoneNumber}?text=${message}`;
  window.open(whatsappUrl, '_blank');
  
  alert('âœ… Invoice image downloaded!\nðŸ“± WhatsApp opened - please attach the downloaded image and send.');
}




    
// Fallback: Download image if share not supported
function fallbackDownloadImage(canvas, fileName) {
  const link = document.createElement('a');
  link.download = fileName;
  link.href = canvas.toDataURL('image/png');
  link.click();
  alert('âœ… Invoice image downloaded! You can now share it from your downloads.');
}

// Generate clean invoice HTML for image conversion
function generateInvoiceHTMLForImage(data) {
  let itemsHTML = '';
  data.items.forEach((item, index) => {
    itemsHTML += `
      <tr>
        <td style="text-align:center;padding:8px;border:1px solid #ddd;">${index + 1}</td>
        <td style="padding:8px;border:1px solid #ddd;">${escapeHtml(item.name)}</td>
        <td style="text-align:center;padding:8px;border:1px solid #ddd;">${item.quantity}</td>
        <td style="text-align:right;padding:8px;border:1px solid #ddd;">₹${item.rate.toFixed(2)}</td>
        <td style="text-align:right;padding:8px;border:1px solid #ddd;">₹${item.amount.toFixed(2)}</td>
      </tr>
    `;
  });
  
  return `
    <div style="font-family:Arial,sans-serif;padding:20px;max-width:800px;margin:0 auto;">
      <div style="text-align:center;margin-bottom:30px;border-bottom:3px solid #0d6efd;padding-bottom:20px;">
        <h1 style="margin:0;font-size:36px;color:#0d6efd;">INVOICE</h1>
        <h2 style="margin:10px 0;font-size:20px;color:#333;">Tile & Sanitaryware Inventory</h2>
      </div>
      
      <div style="display:flex;justify-content:space-between;margin-bottom:30px;">
        <div style="flex:1;">
          <p style="margin:5px 0;"><strong>Invoice Number:</strong> ${data.invoiceNumber}</p>
          <p style="margin:5px 0;"><strong>Customer Name:</strong> ${escapeHtml(data.customerName)}</p>
        </div>
        <div style="flex:1;text-align:right;">
          <p style="margin:5px 0;"><strong>Invoice Date:</strong> ${new Date(data.invoiceDate).toLocaleDateString('en-IN')}</p>
          <p style="margin:5px 0;"><strong>Due Date:</strong> ${new Date(data.dueDate).toLocaleDateString('en-IN')}</p>
        </div>
      </div>
      
      <table style="width:100%;border-collapse:collapse;margin-bottom:20px;">
        <thead>
          <tr style="background:#f8f9fa;">
            <th style="padding:10px;border:1px solid #ddd;text-align:center;width:50px;">#</th>
            <th style="padding:10px;border:1px solid #ddd;text-align:left;">Item Description</th>
            <th style="padding:10px;border:1px solid #ddd;text-align:center;width:80px;">Quantity</th>
            <th style="padding:10px;border:1px solid #ddd;text-align:right;width:100px;">Rate</th>
            <th style="padding:10px;border:1px solid #ddd;text-align:right;width:120px;">Amount</th>
          </tr>
        </thead>
        <tbody>
          ${itemsHTML}
        </tbody>
      </table>
      
      <div style="text-align:right;margin-bottom:20px;">
        <table style="margin-left:auto;width:300px;">
          <tr>
            <td style="padding:5px;"><strong>Sub Total:</strong></td>
            <td style="padding:5px;text-align:right;">₹${data.subtotal.toFixed(2)}</td>
          </tr>
          <tr>
            <td style="padding:5px;color:#dc3545;"><strong>Discount:</strong></td>
            <td style="padding:5px;text-align:right;color:#dc3545;">-₹${data.discount.toFixed(2)}</td>
          </tr>
          <tr>
            <td style="padding:5px;"><strong>Tax:</strong></td>
            <td style="padding:5px;text-align:right;">₹${data.tax.toFixed(2)}</td>
          </tr>
          <tr style="border-top:2px solid #000;">
            <td style="padding:10px;font-size:18px;"><strong>Grand Total:</strong></td>
            <td style="padding:10px;text-align:right;font-size:18px;"><strong>₹${data.total.toFixed(2)}</strong></td>
          </tr>
        </table>
      </div>
      
      ${data.notes ? `
        <div style="margin-bottom:20px;">
          <p style="margin:5px 0;"><strong>Customer Notes:</strong></p>
          <p style="margin:5px 0;padding:10px;background:#f8f9fa;border-left:3px solid #0d6efd;">${escapeHtml(data.notes)}</p>
        </div>
      ` : ''}
      
      ${data.terms ? `
        <div style="margin-bottom:20px;">
          <p style="margin:5px 0;"><strong>Terms & Conditions:</strong></p>
          <p style="margin:5px 0;white-space:pre-line;font-size:12px;color:#666;">${escapeHtml(data.terms)}</p>
        </div>
      ` : ''}
      
      <div style="text-align:center;margin-top:30px;padding-top:20px;border-top:1px solid #ddd;color:#666;font-size:12px;">
        <p>Thank you for your business!</p>
      </div>
    </div>
  `;
}

// Share Invoice as PDF
async function shareInvoiceAsPDF() {
  alert('ðŸ“„ PDF sharing coming soon! For now, use Preview â†’ Print to save as PDF.');
  // You can implement PDF generation using jsPDF or html2pdf.js later
}

// Share via WhatsApp (Text message)
function shareViaWhatsApp() {
  const invoiceData = collectInvoiceData();
  
  if (!invoiceData.customerName) {
    alert('âŒ Please enter customer name');
    return;
  }
  
  const message = generateShareText(invoiceData);
  const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
  window.open(whatsappUrl, '_blank');
}

// Share via Email (Text)
function shareViaEmail() {
  const invoiceData = collectInvoiceData();
  
  if (!invoiceData.customerName) {
    alert('âŒ Please enter customer name');
    return;
  }
  
  const subject = `Invoice ${invoiceData.invoiceNumber} from Tile & Sanitaryware Inventory`;
  const body = generateShareText(invoiceData);
  const mailtoUrl = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  window.location.href = mailtoUrl;
}

// Share via SMS (Text)
function shareViaSMS() {
  const invoiceData = collectInvoiceData();
  
  if (!invoiceData.customerName) {
    alert('âŒ Please enter customer name');
    return;
  }
  
  const message = generateShareText(invoiceData);
  const smsUrl = `sms:?body=${encodeURIComponent(message)}`;
  window.location.href = smsUrl;
}

// Generate text message for sharing
function generateShareText(data) {
  let text = `ðŸ§¾ INVOICE\n\n`;
  text += `Invoice No: ${data.invoiceNumber}\n`;
  text += `Customer: ${data.customerName}\n`;
  text += `Date: ${new Date(data.invoiceDate).toLocaleDateString('en-IN')}\n`;
  text += `Due Date: ${new Date(data.dueDate).toLocaleDateString('en-IN')}\n\n`;
  
  text += `ITEMS:\n`;
  data.items.forEach((item, i) => {
    text += `${i + 1}. ${item.name} x ${item.quantity} = ₹${item.amount.toFixed(2)}\n`;
  });
  
  text += `\n`;
  text += `Sub Total: ₹${data.subtotal.toFixed(2)}\n`;
  if (data.discount > 0) {
    text += `Discount: -₹${data.discount.toFixed(2)}\n`;
  }
  if (data.tax > 0) {
    text += `Tax: ₹${data.tax.toFixed(2)}\n`;
  }
  text += `â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n`;
  text += `TOTAL: ₹${data.total.toFixed(2)}\n\n`;
  
  text += `Thank you for your business!\n`;
  text += `- Tile & Sanitaryware Inventory`;
  
  return text;
}

// Show loading indicator
function showLoading(message = 'Loading...') {
  // Check if loading div already exists
  let loadingDiv = document.getElementById('globalLoading');
  
  if (!loadingDiv) {
    // Create loading indicator
    loadingDiv = document.createElement('div');
    loadingDiv.id = 'globalLoading';
    loadingDiv.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    `;
    
    loadingDiv.innerHTML = `
      <div style="background: white; padding: 30px; border-radius: 12px; text-align: center;">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <div style="margin-top: 15px; color: #333;" id="loadingMessage">${message}</div>
      </div>
    `;
    
    document.body.appendChild(loadingDiv);
  } else {
    // Update message
    const messageEl = document.getElementById('loadingMessage');
    if (messageEl) {
      messageEl.textContent = message;
    }
    loadingDiv.style.display = 'flex';
  }
}

// Hide loading indicator
function hideLoading() {
  const loadingDiv = document.getElementById('globalLoading');
  if (loadingDiv) {
    loadingDiv.style.display = 'none';
  }
}


/**
 * ==========================================
 * SIDEBAR MENU FUNCTIONALITY
 * ==========================================
 */

// Toggle Sidebar
function toggleSidebar() {
  const sidebar = document.getElementById('sidebarMenu');
  const overlay = document.getElementById('sidebarOverlay');
  
  if (sidebar.classList.contains('open')) {
    closeSidebar();
  } else {
    sidebar.classList.add('open');
    overlay.classList.add('show');
  }
}

// Close Sidebar
function closeSidebar() {
  const sidebar = document.getElementById('sidebarMenu');
  const overlay = document.getElementById('sidebarOverlay');
  
  sidebar.classList.remove('open');
  overlay.classList.remove('show');
}

// ✅ UPDATE: Go to Home function
function goToHome() {
  closeSidebar();
  navigateToHome();
}

// ✅ UPDATE: Sidebar Action function
function sidebarAction(action) {
  console.log('Sidebar action:', action);
  
  // Show coming soon for disabled items
  alert('⏳ "' + action.replace(/([A-Z])/g, ' $1').trim() + '" feature coming soon!\n\nThis will be implemented in the next phase.');
  
  closeSidebar();
}


/**
 * Navigate to All Products
 */
 function navigateToAllProducts() {
  console.log('📦 Navigating to All Products');
  
  currentPage = 'allProducts';
  
  // Get page elements
  const mainApp = document.getElementById('mainApp');
  const allProductsPage = document.getElementById('allProductsPage');
  const productGroupsPage = document.getElementById('productGroupsPage');
  const customersPage = document.getElementById('customersPage');
  const groupDetailPage = document.getElementById('groupDetailPage');
  const brandsPage = document.getElementById('brandsPage');
  const sizesPage = document.getElementById('sizesPage');
  const categoriesPage = document.getElementById('categoriesPage');
  const unitTypesPage = document.getElementById('unitTypesPage');
  const vendorsPage = document.getElementById('vendorsPage');
  const invoiceCustomersPage = document.getElementById('invoiceCustomersPage');
  
  // Hide all other pages
  if (mainApp) {
    mainApp.style.display = 'none';
    mainApp.classList.remove('active');
  }
  
  if (productGroupsPage) {
    productGroupsPage.classList.remove('active');
    productGroupsPage.style.display = 'none';
  }
  
  if (customersPage) {
    customersPage.classList.remove('active');
    customersPage.style.display = 'none';
  }
  
  if (groupDetailPage) {
    groupDetailPage.classList.remove('active');
    groupDetailPage.style.display = 'none';
  }
  
  if (brandsPage) {
    brandsPage.classList.remove('active');
    brandsPage.style.display = 'none';
  }
  
  if (sizesPage) {
    sizesPage.classList.remove('active');
    sizesPage.style.display = 'none';
  }
  
  if (categoriesPage) {
    categoriesPage.classList.remove('active');
    categoriesPage.style.display = 'none';
  }
  
  if (unitTypesPage) {
    unitTypesPage.classList.remove('active');
    unitTypesPage.style.display = 'none';
  }
  
  if (vendorsPage) {
    vendorsPage.classList.remove('active');
    vendorsPage.style.display = 'none';
  }
  
  if (invoiceCustomersPage) {
    invoiceCustomersPage.classList.remove('active');
    invoiceCustomersPage.style.display = 'none';
  }
  
  // ✅ Hide main app navbar
  const mainNavbar = document.getElementById('mainAppNavbar');
  if (mainNavbar) {
    mainNavbar.style.display = 'none';
    console.log('✅ Hidden main app navbar');
  }
  
  const stickyNavbar = document.querySelector('.navbar.sticky-top');
  if (stickyNavbar) {
    stickyNavbar.style.display = 'none';
    console.log('✅ Hidden sticky navbar');
  }
  
  // Show all products page
  if (allProductsPage) {
    allProductsPage.classList.add('active');
    allProductsPage.style.display = 'block';
    allProductsPage.style.marginTop = '0';
    allProductsPage.style.paddingTop = '0';
    console.log('✅ All Products page displayed');
  } else {
    console.error('❌ allProductsPage element not found!');
    return;
  }
  
  // Load products
  if (typeof renderAllProductsList === 'function') {
    renderAllProductsList();
    console.log('✅ Products list rendered');
  }
  
  // Auto-trigger "ALL" filter after a short delay
  setTimeout(() => {
    if (typeof filterByCategory === 'function') {
      filterByCategory('all');
      console.log('✅ "ALL" filter applied');
    }
  }, 100);
  
  // Close sidebar and scroll
  if (typeof closeSidebar === 'function') {
    closeSidebar();
  }
  
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Make it global
window.navigateToAllProducts = navigateToAllProducts;











let currentGroupName = null;
let attributeRowCounter = 0;


/**
 * ==========================================
 * NAVIGATION - PRODUCT GROUPS
 * ==========================================
 */

// Navigate to Product Groups List Page - UPDATED FOR INVOICE NAVIGATION
function navigateToProductGroups() {
  console.log('📁 Navigating to Product Groups');
  
  currentPage = 'productGroups';
  
  // === STEP 1: Hide navbar ===
  const navbar = document.querySelector('.navbar.navbar-dark.bg-primary');
  if (navbar) navbar.style.display = 'none';
  
  // === STEP 2: Hide main app ===
  const mainApp = document.getElementById('mainApp');
  if (mainApp) mainApp.style.display = 'none';
  
  // === STEP 3: Hide other pages ===
  const allProductsPage = document.getElementById('allProductsPage');
  const customersPage = document.getElementById('customersPage');
  const groupDetailPage = document.getElementById('groupDetailPage');
  
  if (allProductsPage) {
    allProductsPage.style.display = 'none';
    allProductsPage.classList.remove('active');
  }
  if (customersPage) {
    customersPage.style.display = 'none';
    customersPage.classList.remove('active');
  }
  if (groupDetailPage) {
    groupDetailPage.style.display = 'none';
    groupDetailPage.classList.remove('active');
  }
  
  // === STEP 4: Remove old container if exists ===
  const oldContainer = document.getElementById('productGroupsPageContainer');
  if (oldContainer) oldContainer.remove();
  
  // === STEP 5: Build full-screen page ===
  document.body.innerHTML += `
    <div id="productGroupsPageContainer" style="position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: #f8f9fa; z-index: 99999; overflow-y: auto;">
      
      <!-- Header -->
      <div class="modal-header-mobile">
               <button onclick="location.reload()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
          ← Back to Home
        </button>

        <h3>Products in Group</h3>
        <button class="btn-primary-bottom" onclick="openCreateGroupModal()" style="padding: 8px 16px; min-height: auto; flex: none; font-size: 14px;">
          + Create
        </button>
      </div>
      
      <!-- Search -->
      <div style="padding: 16px;">
        <input 
          type="text" 
          id="searchGroupsInput" 
          placeholder="🔍 Search groups..."
          style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px;"
          onkeyup="filterProductGroups(this.value)">
      </div>
      
      <!-- Loading State -->
      <div id="groupsLoadingState" class="loading-spinner">
        <div class="spinner"></div>
        <p>Loading product groups...</p>
      </div>
      
      <!-- Groups List -->
      <div id="groupsListContainer" style="display: none;">
        <!-- Groups will be rendered here -->
      </div>
      
      <!-- Empty State -->
      <div id="groupsEmptyState" class="empty-state" style="display: none;">
        <div class="empty-state-icon">📁</div>
        <h3>No Product Groups Yet</h3>
        <p>Create your first product group to manage variants</p>
        <button class="btn-primary-bottom" onclick="openCreateGroupModal()" style="max-width: 200px; margin: 0 auto;">
          + Create First Group
        </button>
      </div>
      
    </div>
  `;
  
  // === STEP 6: Close sidebar ===
  if (typeof closeSidebar === 'function') {
    closeSidebar();
  }
  
  // === STEP 7: Load data ===
  loadProductGroups();
  
  // === STEP 8: Scroll to top ===
  window.scrollTo({ top: 0, behavior: 'smooth' });
}



// Navigate to Group Variants (Detail Page)
function navigateToGroupVariants(groupId, groupName) {
  console.log('📦 Opening variants for:', groupName);
  
  currentGroupId = groupId;
  currentGroupName = groupName;
  
  // Remove existing page if any
  const existingPage = document.getElementById('groupVariantsPageContainer');
  if (existingPage) existingPage.remove();
  
  // Build variants page
  document.body.innerHTML += `
    <div id="groupVariantsPageContainer" style="position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: #f8f9fa; z-index: 99999; overflow-y: auto;">
      
      <!-- Header -->
      <div class="modal-header-mobile">
        <button class="btn-cancel-modal" onclick="closeGroupVariantsPage()">
          ← Back
        </button>
        <h3>${groupName}</h3>
        <div style="width: 80px;"></div>
      </div>
      
      <!-- Search -->
      <div style="padding: 16px;">
        <input 
          type="text" 
          id="searchVariantsInput" 
          placeholder="🔍 Search variants..."
          style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px;"
          onkeyup="filterGroupVariants(this.value)">
      </div>
      
      <!-- Loading State -->
      <div id="variantsLoadingState" class="loading-spinner">
        <div class="spinner"></div>
        <p>Loading variants...</p>
      </div>
      
      <!-- Variants List -->
      <div id="variantsListContainer" style="display: none;">
        <!-- Variants will be rendered here -->
      </div>
      
      <!-- Empty State -->
      <div id="variantsEmptyState" class="empty-state" style="display: none;">
        <div class="empty-state-icon">📦</div>
        <h3>No Variants Yet</h3>
        <p>This group doesn't have any variants</p>
      </div>
      
    </div>
  `;
  
  // Load variants
  loadGroupVariants(groupId);
}


// Close Group Variants Page
function closeGroupVariantsPage() {
  const page = document.getElementById('groupVariantsPageContainer');
  if (page) page.remove();
  
  // Refresh groups list
  loadProductGroups();
}


/**
 * ==========================================
 * DATA LOADING FUNCTIONS
 * ==========================================
 */

/**
 * ==========================================
 * DATA LOADING FUNCTIONS - FIREBASE VERSION
 * ==========================================
 */

// Load Product Groups from Firestore
async function loadProductGroups() {
  const user = window.auth.currentUser;
  
  if (!user) {
    console.log('No user authenticated');
    const loadingState = document.getElementById('groupsLoadingState');
    if (loadingState) {
      loadingState.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">🔒</div>
          <h3>Please Sign In</h3>
          <p>Sign in to view your product groups</p>
        </div>
      `;
    }
    return;
  }
  
  try {
    console.log('📡 Fetching product groups from Firestore...');
    
    const { collection, getDocs, query, orderBy } = window.firebaseImports;
    
    const groupsRef = collection(window.db, 'tenants', user.uid, 'productGroups');
    const q = query(groupsRef, orderBy('createdAt', 'desc'));
    const snapshot = await getDocs(q);
    
    const groups = [];
    snapshot.forEach((doc) => {
      groups.push({
        groupId: doc.id,
        ...doc.data()
      });
    });
    
    cachedProductGroups = groups;
    console.log('✅ Loaded', groups.length, 'groups from Firestore');
    
    // Hide loading
    const loadingState = document.getElementById('groupsLoadingState');
    if (loadingState) loadingState.style.display = 'none';
    
    // Show appropriate view
    if (groups.length === 0) {
      const emptyState = document.getElementById('groupsEmptyState');
      if (emptyState) emptyState.style.display = 'flex';
    } else {
      renderProductGroups(groups);
    }
    
  } catch (error) {
    console.error('❌ Error loading groups from Firestore:', error);
    
    const loadingState = document.getElementById('groupsLoadingState');
    if (loadingState) {
      loadingState.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">⚠️</div>
          <h3>Error Loading Groups</h3>
          <p>${error.message}</p>
          <button class="btn-primary-bottom" onclick="loadProductGroups()" style="max-width: 200px; margin: 16px auto 0;">
            🔄 Retry
          </button>
        </div>
      `;
    }
  }
}

// Load Group Variants from Firestore
async function loadGroupVariants(groupId) {
  const user = window.auth.currentUser;
  
  if (!user) {
    console.log('No user authenticated');
    return;
  }
  
  try {
    console.log('📡 Fetching variants for group:', groupId);
    
    const { collection, getDocs, query, where } = window.firebaseImports;
    
    // Get variants that belong to this group
    const variantsRef = collection(window.db, 'tenants', user.uid, 'products');
    const q = query(variantsRef, where('groupId', '==', groupId));
    const snapshot = await getDocs(q);
    
    const variants = [];
    snapshot.forEach((doc) => {
      variants.push({
        variantId: doc.id,
        ...doc.data()
      });
    });
    
    cachedGroupVariants = variants;
    console.log('✅ Loaded', variants.length, 'variants from Firestore');
    
    // Hide loading
    const loadingState = document.getElementById('variantsLoadingState');
    if (loadingState) loadingState.style.display = 'none';
    
    // Show appropriate view
    if (variants.length === 0) {
      const emptyState = document.getElementById('variantsEmptyState');
      if (emptyState) emptyState.style.display = 'flex';
    } else {
      renderGroupVariants(variants);
    }
    
  } catch (error) {
    console.error('❌ Error loading variants from Firestore:', error);
    
    const loadingState = document.getElementById('variantsLoadingState');
    if (loadingState) {
      loadingState.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">⚠️</div>
          <h3>Error Loading Variants</h3>
          <p>${error.message}</p>
          <button class="btn-primary-bottom" onclick="loadGroupVariants('${groupId}')" style="max-width: 200px; margin: 16px auto 0;">
            🔄 Retry
          </button>
        </div>
      `;
    }
  }
}


/**
 * ==========================================
 * RENDERING FUNCTIONS
 * ==========================================
 */

// Render Product Groups List
function renderProductGroups(groups) {
  const container = document.getElementById('groupsListContainer');
  if (!container) return;
  
  let html = '';
  
  groups.forEach(group => {
    const variantText = group.totalVariants === 1 ? '1 variant' : `${group.totalVariants} variants`;
    const categoryText = group.category || 'Uncategorized';
    
    html += `
      <div class="group-card" onclick="navigateToGroupVariants('${group.groupId}', '${escapeHtml(group.groupName)}')">
        <div class="group-icon">📁</div>
        
        <div class="group-info">
          <div class="group-name">${escapeHtml(group.groupName)}</div>
          <div class="group-description">${escapeHtml(group.description || 'No description')}</div>
          <div class="group-meta">
            <span class="group-meta-item">📦 ${variantText}</span>
            <span class="group-meta-item">🏷️ ${categoryText}</span>
          </div>
        </div>
        
        <div class="group-actions" onclick="event.stopPropagation()">
          <button class="btn-icon-small btn-delete-small" onclick="confirmDeleteGroup('${group.groupId}', '${escapeHtml(group.groupName)}')">
            🗑️
          </button>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
  container.style.display = 'block';
}


// Render Group Variants List - FIXED
function renderGroupVariants(variants) {
  const container = document.getElementById('variantsListContainer');
  if (!container) return;

  if (!variants || variants.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">📦</div>
        <h3>No Variants Yet</h3>
        <p>This group doesn't have any variants</p>
      </div>
    `;
    return;
  }

  let html = '';
  
  variants.forEach(variant => {
    // Parse attributes
    let attributesText = '';
    try {
      const attrs = typeof variant.attributes === 'string' 
        ? JSON.parse(variant.attributes) 
        : variant.attributes;
      const attrArray = Object.entries(attrs).map(([key, value]) => `${key}: ${value}`);
      attributesText = attrArray.join(' • ');
    } catch (e) {
      attributesText = '';
    }

    // Stock status
    const stockClass = variant.stock <= variant.minStock ? 'low' : 'good';
    const stockIcon = variant.stock <= variant.minStock ? '⚠️' : '✅';
    const stockText = `${stockIcon} ${variant.stock}`;

    // Price
    const priceText = variant.sellingPrice > 0 ? `₹${variant.sellingPrice.toFixed(2)}` : '₹0.00';

    html += `
      <div class="variant-card">
        <div class="variant-icon">📦</div>
        <div class="variant-info">
          <div class="variant-name">${escapeHtml(variant.variantName)}</div>
          ${attributesText ? `<div class="variant-attributes">${attributesText}</div>` : ''}
          <div class="variant-details">
            <span class="variant-stock ${stockClass}">${stockText}</span>
            <span class="variant-price">${priceText}</span>
          </div>
        </div>
        <div class="variant-actions">
          <button class="btn-icon-small btn-edit-small" onclick="openEditVariantModal('${variant.variantId}')">
            <i class="bi bi-pencil"></i>
          </button>
          <button class="btn-icon-small btn-delete-small" onclick="confirmDeleteVariant('${variant.variantId}', '${escapeHtml(variant.variantName)}')">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </div>
    `;
  });

  container.innerHTML = html;
  container.style.display = 'block';
}


/**
 * ==========================================
 * FILTER FUNCTIONS
 * ==========================================
 */

// Filter Product Groups
function filterProductGroups(searchText) {
  if (!searchText || searchText.trim() === '') {
    renderProductGroups(cachedProductGroups);
    return;
  }
  
  const filtered = cachedProductGroups.filter(group => 
    group.groupName.toLowerCase().includes(searchText.toLowerCase()) ||
    (group.description && group.description.toLowerCase().includes(searchText.toLowerCase())) ||
    (group.category && group.category.toLowerCase().includes(searchText.toLowerCase()))
  );
  
  renderProductGroups(filtered);
}


// Filter Group Variants
function filterGroupVariants(searchText) {
  if (!searchText || searchText.trim() === '') {
    renderGroupVariants(cachedGroupVariants);
    return;
  }
  
  const filtered = cachedGroupVariants.filter(variant => 
    variant.variantName.toLowerCase().includes(searchText.toLowerCase())
  );
  
  renderGroupVariants(filtered);
}


/**
 * ==========================================
 * CREATE GROUP MODAL FUNCTIONS
 * ==========================================
 */

function openCreateGroupModal() {
  console.log('📝 Opening Create Group Modal');

  // Remove any existing injected modal to avoid duplicates
  const existing = document.getElementById('createGroupModal');
  if (existing) existing.remove();

  const html = `
    <div id="createGroupModal" class="fullscreen-modal active keep-in-dom-remove"
         style="display:block!important;position:fixed;top:0;left:0;width:100%;height:100vh;background:#fff;z-index:9999999;overflow-y:auto">
      <div class="modal-header-mobile" style="position:sticky;top:0;background:#fff;padding:12px 16px;border-bottom:1px solid #e0e0e0;z-index:100;display:flex;justify-content:space-between;align-items:center">
        <button class="btn-cancel-modal" onclick="closeCreateGroupModal()" style="background:#dc3545;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer">✕ Cancel</button>
        <h3 style="margin:0;font-size:18px;font-weight:600">New Item Group</h3>
        <div style="width:80px"></div>
      </div>

      <form id="createGroupForm" class="mobile-form" onsubmit="handleCreateGroup(event)" style="padding:16px;padding-bottom:100px">
        <div class="form-section" style="margin-bottom:24px;background:#f8f9fa;padding:16px;border-radius:12px">
          <div class="section-title" style="font-size:16px;font-weight:600;margin-bottom:12px">Basic Information</div>
          <label style="display:block;font-weight:600;margin-bottom:6px">Item Group Name <span style="color:#dc3545">*</span></label>
          <input id="groupName" required placeholder="e.g., T-Shirts, Tiles" style="width:100%;padding:12px;font-size:16px;border:1px solid #ddd;border-radius:8px">

          <label style="display:block;font-weight:600;margin:16px 0 6px">Description</label>
          <textarea id="groupDescription" rows="3" placeholder="Optional" style="width:100%;padding:12px;font-size:16px;border:1px solid #ddd;border-radius:8px"></textarea>

          <label style="display:block;font-weight:600;margin:16px 0 6px">Manufacturer/Brand</label>
          <input id="groupManufacturer" placeholder="e.g., Somany" style="width:100%;padding:12px;font-size:16px;border:1px solid #ddd;border-radius:8px">

          <label style="display:block;font-weight:600;margin:16px 0 6px">Category</label>
          <select id="groupCategory" style="width:100%;padding:12px;font-size:16px;border:1px solid #ddd;border-radius:8px">
            <option value="">Select Category</option>
            <option value="Tiles">Tiles</option>
            <option value="Sanitaryware">Sanitaryware</option>
            <option value="Accessories">Accessories</option>
            <option value="Apparel">Apparel</option>
            <option value="Custom">Custom</option>
          </select>
        </div>

        <div class="form-section" style="margin-bottom:24px;background:#f8f9fa;padding:16px;border-radius:12px">
          <div class="section-title" style="font-size:16px;font-weight:600;margin-bottom:8px">Create Attributes</div>
          <div class="section-description" style="font-size:13px;color:#666;margin-bottom:12px">Add attributes like Size, Color, Material</div>
          <div id="attributesContainer"></div>
          <button type="button" onclick="addAttributeRow()" style="width:100%;padding:12px;background:#007bff;color:#fff;border:none;border-radius:8px;font-weight:600;margin-top:8px">➕ Add Attribute</button>
        </div>

        <div class="form-section" style="background:#fff;padding:16px;border-radius:12px;border:2px solid #e3f2fd">
          <div style="display:inline-block;background:#667eea;color:#fff;padding:6px 12px;border-radius:16px;font-weight:600">
            <span id="variantCount">0</span> Variants Will Be Created
          </div>
          <div id="variantPreviewContainer" style="max-height:240px;overflow-y:auto;margin-top:10px">
            <div style="padding:10px 12px;background:#e3f2fd;border-radius:8px;color:#1976d2">Add attributes to see preview...</div>
          </div>
        </div>

        <div style="position:fixed;bottom:0;left:0;right:0;background:#fff;padding:12px 16px;box-shadow:0 -2px 8px rgba(0,0,0,.1);display:flex;gap:12px;z-index:1000">
          <button type="button" onclick="closeCreateGroupModal()" style="flex:1;padding:12px;background:#6c757d;color:#fff;border:none;border-radius:8px;font-weight:600">Cancel</button>
          <button type="submit" id="btnSaveGroup" style="flex:2;padding:12px;background:#28a745;color:#fff;border:none;border-radius:8px;font-weight:600">💾 Save & Generate</button>
        </div>
      </form>
    </div>
  `;

  document.body.insertAdjacentHTML('beforeend', html);

  // mark as removable
  const modal = document.getElementById('createGroupModal');
  if (modal) modal.classList.add('keep-in-dom');

  // Prevent body scroll
  document.body.style.overflow = 'hidden';

  // Reset attributes and add first row (guarded)
  if (typeof attributeRowCounter === 'undefined') window.attributeRowCounter = 0;
  const container = document.getElementById('attributesContainer');
  if (container) {
    container.innerHTML = '';
    if (typeof addAttributeRow === 'function') {
      addAttributeRow();
    } else {
      console.warn('addAttributeRow is not defined yet');
    }
  }

  console.log('✅ Create Group Modal injected and opened');
}






// Close Create Group Modal - FIXED
function closeCreateGroupModal() {
  console.log('🔒 Closing Create Group Modal');
  
  const modal = document.getElementById('createGroupModal');
  if (modal) {
    // Remove active class
    modal.classList.remove('active');
    
    // Hide with inline styles
    modal.style.display = 'none';
  }
  
  // Restore body scroll
  document.body.style.overflow = '';
  
  // Reset form
  const form = document.getElementById('createGroupForm');
  if (form) {
    form.reset();
  }
  
  // Clear attributes container
  const container = document.getElementById('attributesContainer');
  if (container) {
    container.innerHTML = '';
  }
  
  // Reset attribute counter
  attributeRowCounter = 0;
  
  // Reset button
  const submitBtn = document.getElementById('btnSaveGroup');
  if (submitBtn) {
    submitBtn.disabled = false;
    submitBtn.innerHTML = '💾 Save & Generate';
  }
  
  console.log('✅ Modal closed and reset');
}


    
// Add Attribute Row - MOBILE OPTIMIZED
function addAttributeRow() {
  const container = document.getElementById('attributesContainer');
  if (!container) return;
  
  const rowId = `attributeRow${Date.now()}`;
  
  const row = document.createElement('div');
  row.className = 'attribute-row';
  row.id = rowId;
  row.style.cssText = 'display: flex; gap: 8px; margin-bottom: 12px; align-items: center;';
  
  row.innerHTML = `
    <input 
      type="text" 
      class="attr-name" 
      placeholder="Attribute (e.g., Size)" 
      style="flex: 1; padding: 12px; font-size: 16px; border: 1px solid #ddd; border-radius: 8px;"
      autocomplete="off"
      autocorrect="off"
      autocapitalize="words"
      oninput="updateVariantPreview()"
    >
    <input 
      type="text" 
      class="attr-options" 
      placeholder="Options (e.g., Small, Large)" 
      style="flex: 2; padding: 12px; font-size: 16px; border: 1px solid #ddd; border-radius: 8px;"
      autocomplete="off"
      autocorrect="off"
      autocapitalize="words"
      oninput="updateVariantPreview()"
    >
    <button 
      type="button" 
      onclick="removeAttributeRow('${rowId}')" 
      style="padding: 10px 12px; background: #dc3545; color: #fff; border: none; border-radius: 8px; font-size: 18px;"
      aria-label="Remove attribute"
    >
      ×
    </button>
  `;
  
  container.appendChild(row);
  
  // Focus on the attribute name input (mobile-friendly)
  setTimeout(() => {
    const nameInput = row.querySelector('.attr-name');
    if (nameInput) {
      nameInput.focus();
    }
  }, 100);
  
  updateVariantPreview();
  
  console.log(`✅ Added attribute row: ${rowId}`);
}

// Remove Attribute Row
function removeAttributeRow(rowId) {
  const row = document.getElementById(`attributeRow${rowId}`);
  if (row) {
    row.remove();
    updateVariantPreview();
  }
}

// Remove Attribute Row
function removeAttributeRow(rowId) {
  const row = document.getElementById(`attributeRow${rowId}`);
  if (row) {
    row.remove();
    updateVariantPreview();
  }
}


/**
 * ==========================================
 * VARIANT GENERATION & PREVIEW
 * ==========================================
 */
// Parse Attributes from Form - MOBILE OPTIMIZED
function parseAttributesFromForm() {
  console.log('🔍 Parsing attributes from form...');
  
  const attributes = {};
  const rows = document.querySelectorAll('.attribute-row');
  
  console.log(`Found ${rows.length} attribute rows`);
  
  rows.forEach((row, index) => {
    // Try multiple selector strategies for mobile compatibility
    const nameInput = row.querySelector('.attr-name') || 
                     row.querySelector('input[placeholder*="Size"]') ||
                     row.querySelector('input[type="text"]:first-child');
    
    const optionsInput = row.querySelector('.attr-options') || 
                        row.querySelector('input[placeholder*="Small"]') ||
                        row.querySelector('input[type="text"]:last-child');
    
    if (nameInput && optionsInput) {
      // Get values with fallback for mobile
      const attrName = (nameInput.value || '').trim();
      const optionsText = (optionsInput.value || '').trim();
      
      console.log(`Row ${index + 1}:`, {
        name: attrName,
        options: optionsText
      });
      
      if (attrName && optionsText) {
        // Parse options - handle multiple separators
        const attrOptions = optionsText
          .split(/[,;|]/) // Split by comma, semicolon, or pipe
          .map(opt => opt.trim())
          .filter(opt => opt.length > 0);
        
        if (attrOptions.length > 0) {
          attributes[attrName] = attrOptions;
          console.log(`✅ Added attribute: ${attrName} = [${attrOptions.join(', ')}]`);
        } else {
          console.warn(`⚠️ No valid options for attribute: ${attrName}`);
        }
      } else {
        console.warn(`⚠️ Row ${index + 1} - Empty name or options`);
      }
    } else {
      console.error(`❌ Row ${index + 1} - Could not find inputs`);
    }
  });
  
  console.log('📦 Final parsed attributes:', attributes);
  console.log('📊 Total attributes:', Object.keys(attributes).length);
  
  return attributes;
}



// Generate Variant Combinations
function generateVariantCombinations(attributes) {
  const keys = Object.keys(attributes);
  
  if (keys.length === 0) {
    return [];
  }
  
  // Get all arrays of options
  const optionArrays = keys.map(key => attributes[key]);
  
  // Generate cartesian product
  function cartesianProduct(arrays) {
    if (arrays.length === 0) return [[]];
    if (arrays.length === 1) return arrays[0].map(item => [item]);
    
    const [first, ...rest] = arrays;
    const restProduct = cartesianProduct(rest);
    
    const result = [];
    for (let i = 0; i < first.length; i++) {
      for (let j = 0; j < restProduct.length; j++) {
        result.push([first[i], ...restProduct[j]]);
      }
    }
    return result;
  }
  
  const combinations = cartesianProduct(optionArrays);
  
  // Convert arrays to objects
  return combinations.map(combo => {
    const variant = {};
    keys.forEach((key, index) => {
      variant[key] = combo[index];
    });
    return variant;
  });
}


// Generate Variant Name
function generateVariantName(groupName, attributes) {
  const values = Object.values(attributes);
  if (values.length === 0) return groupName;
  return `${groupName}-${values.join('-')}`;
}


// Update Variant Preview (Real-time)
function updateVariantPreview() {
  const groupName = document.getElementById('groupName').value.trim() || 'Product';
  const attributes = parseAttributesFromForm();
  const variants = generateVariantCombinations(attributes);
  
  // Update count
  document.getElementById('variantCount').textContent = variants.length;
  
  // Update preview list
  const container = document.getElementById('variantPreviewContainer');
  if (!container) return;
  
  if (variants.length === 0) {
    container.innerHTML = `
      <div class="variant-preview-item">
        Add attributes to see preview...
      </div>
    `;
    return;
  }
  
  // Show first 10 variants
  const previewLimit = 10;
  let html = '';
  
  variants.slice(0, previewLimit).forEach(attr => {
    const variantName = generateVariantName(groupName, attr);
    html += `
      <div class="variant-preview-item">
        <span class="icon">✓</span>
        ${escapeHtml(variantName)}
      </div>
    `;
  });
  
  // Show "and X more" if needed
  if (variants.length > previewLimit) {
    html += `
      <div class="variant-preview-more">
        ... and ${variants.length - previewLimit} more
      </div>
    `;
  }
  
  container.innerHTML = html;
}

    

// Navigate to Group Detail - FIXED
function navigateToGroupDetail(groupId, groupName) {
  console.log('📦 Navigating to Group Detail:', groupName);
  
  currentPage = 'groupDetail';
  currentGroupId = groupId;
  
  const mainApp = document.getElementById('mainApp');
  const allProductsPage = document.getElementById('allProductsPage');
  const productGroupsPage = document.getElementById('productGroupsPage');
  const groupDetailPage = document.getElementById('groupDetailPage');
  
  // HIDE the main dashboard
  if (mainApp) {
    mainApp.style.display = 'none';
  }
  
  // ✅ HIDE THE BLUE NAVBAR
  const navbar = document.querySelector('.navbar');
  if (navbar) {
    navbar.style.display = 'none';
  }
  
  // SHOW Group Detail page
  if (groupDetailPage) {
    groupDetailPage.classList.add('active');
  }
  
  if (allProductsPage) allProductsPage.classList.remove('active');
  if (productGroupsPage) productGroupsPage.classList.remove('active');
  
  // Set group title
  const groupTitleEl = document.getElementById('groupDetailTitle');
  if (groupTitleEl) {
    groupTitleEl.textContent = groupName;
  }
  
  // Load variants
  if (typeof syncGroupVariants === 'function') {
    syncGroupVariants(groupId);
  }
  
  window.scrollTo({ top: 0, behavior: 'smooth' });
}




    
/**
 * ==========================================
 * FORM SUBMISSION HANDLERS - FIREBASE VERSION
 * ==========================================
 */

// Handle Create Group Form Submission
async function handleCreateGroup(event) {
  event.preventDefault();
  console.log('📝 Creating product group...');
  
  const user = window.auth.currentUser;
  if (!user) {
    alert('Please sign in first');
    return;
  }
  
  const submitBtn = document.getElementById('btnSaveGroup');
  const originalText = submitBtn.innerHTML;
  
  if (submitBtn.disabled) {
    console.log('⚠️ Already submitting...');
    return;
  }
  
  submitBtn.disabled = true;
  submitBtn.innerHTML = '⏳ Creating...';
  
  try {
    // Collect form data
    const groupName = document.getElementById('groupName').value.trim();
    const description = document.getElementById('groupDescription').value.trim();
    const manufacturer = document.getElementById('groupManufacturer').value.trim();
    const category = document.getElementById('groupCategory').value;
    
    console.log('📋 Form data:', { groupName, description, manufacturer, category });
    
    // Parse attributes
    const attributes = parseAttributesFromForm();
    
    // Validation
    if (!groupName) {
      throw new Error('❌ Group name is required');
    }
    
    if (groupName.length < 2) {
      throw new Error('❌ Group name must be at least 2 characters');
    }
    
    if (Object.keys(attributes).length === 0) {
      throw new Error('❌ Please add at least one attribute with options.\n\nExample:\nAttribute: Size\nOptions: Small, Large');
    }
    
    // Validate each attribute has options
    for (const [attrName, attrOptions] of Object.entries(attributes)) {
      if (attrOptions.length === 0) {
        throw new Error(`❌ Attribute "${attrName}" has no options.\n\nPlease enter options separated by commas.\n\nExample: Small, Medium, Large`);
      }
    }
    
    console.log('✅ Validation passed!');
    
    // Generate variants
    const variants = generateVariantCombinations(attributes);
    console.log(`📊 Will create ${variants.length} variants`);
    
    const { collection, addDoc } = window.firebaseImports;
    
    // Save product group
    const groupsRef = collection(window.db, 'tenants', user.uid, 'productGroups');
    const groupDocRef = await addDoc(groupsRef, {
      groupName: groupName,
      description: description,
      manufacturer: manufacturer,
      brand: manufacturer,
      category: category,
      attributes: attributes,
      totalVariants: variants.length,
      createdBy: user.email,
      createdAt: new Date().toISOString(),
      userId: user.uid
    });
    
    console.log('✅ Group created:', groupDocRef.id);
    
    // Save all variants
    const productsRef = collection(window.db, 'tenants', user.uid, 'products');
    const variantPromises = variants.map(attrs => {
      const variantName = generateVariantName(groupName, attrs);
      
      return addDoc(productsRef, {
        name: variantName,
        variantName: variantName,
        groupId: groupDocRef.id,
        groupName: groupName,
        category: category,
        brand: manufacturer,
        manufacturer: manufacturer,
        attributes: attrs,
        unitType: 'Piece',
        price: 0,
        sellingPrice: 0,
        costPrice: 0,
        stock: 0,
        minStock: 0,
        size: attrs.Size || '',
        createdAt: new Date().toISOString(),
        userId: user.uid
      });
    });
    
    await Promise.all(variantPromises);
    
    console.log(`✅ Created ${variants.length} variants`);
    
    // Show success message
    showSuccessToast(`✅ Created "${groupName}" with ${variants.length} variants!`);
    
    // Close modal
    closeCreateGroupModal();
    
    // Reload groups list
    setTimeout(() => {
      loadProductGroups();
    }, 500);
    
  } catch (error) {
    console.error('❌ Error creating product group:', error);
    alert(`Error: ${error.message}`);
    
    submitBtn.disabled = false;
    submitBtn.innerHTML = originalText;
  }
}


/**
 * ==========================================
 * EDIT VARIANT MODAL FUNCTIONS
 * ==========================================
 */

// Open Edit Variant Modal - AGGRESSIVE FORCE SHOW VERSION
function openEditVariantModal(variantId) {
  console.log('🔍 Opening edit modal for variant:', variantId);
  
  // Find variant in cache
  const variant = cachedGroupVariants.find(v => v.variantId === variantId);
  
  if (!variant) {
    alert('Variant not found');
    return;
  }

  // Use the existing Bootstrap product modal
  const modal = document.getElementById('productModal');
  
  if (!modal) {
    console.error('❌ productModal not found in DOM!');
    alert('Error: Edit modal not found. Please refresh the page.');
    return;
  }

  // Set modal title
  const modalTitle = document.getElementById('productModalLabel');
  if (modalTitle) {
    modalTitle.textContent = 'Edit Variant';
  }

  // ✅ SAFE FIELD POPULATION
  const setFieldValue = (id, value) => {
    const field = document.getElementById(id);
    if (field) {
      field.value = value;
      return true;
    } else {
      console.warn(`⚠️ Field not found: ${id}`);
      return false;
    }
  };

  // Populate form fields
  setFieldValue('productId', variant.variantId);
  setFieldValue('productName', variant.variantName);
  setFieldValue('brand', variant.manufacturer || variant.brand || '');
  setFieldValue('size', extractAttributeValue(variant.attributes, 'Size') || '');
  setFieldValue('category', variant.category || 'Tiles');
  setFieldValue('unitType', variant.unitType || 'Piece');
  setFieldValue('piecesPerBox', 0);
  setFieldValue('sftPerBox', 0);
  setFieldValue('price', variant.sellingPrice || 0);
  setFieldValue('stock', variant.stock || 0);
  setFieldValue('minStock', variant.minStock || 0);

  // Store that this is a variant edit
  const form = document.getElementById('productForm');
  if (form) {
    form.dataset.isVariant = 'true';
    form.dataset.groupId = variant.groupId;
  }

  // Make fields readonly
  const makeReadonly = (id) => {
    const field = document.getElementById(id);
    if (field) {
      field.readOnly = true;
      field.style.background = '#f8f9fa';
      field.style.color = '#6c757d';
    }
  };

  makeReadonly('productName');
  makeReadonly('brand');
  makeReadonly('size');

  // ✅ FORCE SHOW MODAL - Multiple methods
  console.log('Attempting to show modal...');
  
  // Method 1: Try Bootstrap 5 Modal API
  try {
    let bootstrapModal = bootstrap.Modal.getInstance(modal);
    if (!bootstrapModal) {
      bootstrapModal = new bootstrap.Modal(modal);
    }
    bootstrapModal.show();
    console.log('✅ Bootstrap modal.show() called');
  } catch (e) {
    console.error('❌ Bootstrap Modal failed:', e);
    
    // Method 2: Manual show with jQuery (fallback)
    if (typeof $ !== 'undefined' && $.fn.modal) {
      $(modal).modal('show');
      console.log('✅ jQuery modal.show() called');
    } else {
      // Method 3: Direct CSS manipulation (last resort)
      modal.classList.add('show');
      modal.style.display = 'block';
      modal.setAttribute('aria-modal', 'true');
      modal.removeAttribute('aria-hidden');
      document.body.classList.add('modal-open');
      
      // Add backdrop manually
      const backdrop = document.createElement('div');
      backdrop.className = 'modal-backdrop fade show';
      backdrop.id = 'variantModalBackdrop';
      document.body.appendChild(backdrop);
      
      console.log('✅ Manual modal display applied');
    }
  }

  // ✅ AGGRESSIVE FORCE TO FOREGROUND (Works regardless of Bootstrap method)
  setTimeout(() => {
    // Force modal container
    modal.style.cssText = `
      display: block !important;
      z-index: 999999 !important;
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100% !important;
      height: 100% !important;
      overflow-y: auto !important;
      background: rgba(0, 0, 0, 0.5) !important;
    `;
    
    // Force modal dialog
    const modalDialog = modal.querySelector('.modal-dialog');
    if (modalDialog) {
      modalDialog.style.cssText = `
        z-index: 1000000 !important;
        position: relative !important;
        margin: 1.75rem auto !important;
        max-width: 500px !important;
        pointer-events: auto !important;
      `;
    }
    
    // Force modal content
    const modalContent = modal.querySelector('.modal-content');
    if (modalContent) {
      modalContent.style.cssText = `
        background: white !important;
        border-radius: 8px !important;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5) !important;
        position: relative !important;
        display: flex !important;
        flex-direction: column !important;
      `;
    }
    
    // Force backdrop if exists
    const backdrop = document.querySelector('.modal-backdrop');
    if (backdrop) {
      backdrop.style.cssText = `
        z-index: 999998 !important;
        opacity: 0.5 !important;
      `;
    }
    
    // Lower z-index of page views
    const pageViews = document.querySelectorAll('.page-view');
    pageViews.forEach(view => {
      view.style.zIndex = '1';
    });
    
    console.log('✅ Modal FORCED to foreground with inline styles');
  }, 100);

  console.log('✅ Edit variant modal opened for:', variant.variantName);
}

// Helper function to extract attribute value from JSON
function extractAttributeValue(attributes, key) {
  try {
    const attrs = typeof attributes === 'string' 
      ? JSON.parse(attributes) 
      : attributes;
    return attrs[key] || '';
  } catch (e) {
    return '';
  }
}

// Close Edit Variant Modal - COMPLETE FIX
function closeEditVariantModal() {
  console.log('Closing edit variant modal');
  
  const modal = document.getElementById('editVariantModal');
  if (modal) {
    modal.classList.remove('active');
    modal.style.display = 'none'; // Hide it
    
    // Restore body scroll
    document.body.style.overflow = '';
  }

  // Reset form
  const form = document.getElementById('editVariantForm');
  if (form) {
    form.reset();
  }
  
  console.log('Modal closed');
}
// Handle Update Variant - FIREBASE VERSION
async function handleUpdateVariant(event) {
  event.preventDefault();
  
  console.log('💾 Updating variant...');
  
  const user = window.auth.currentUser;
  if (!user) {
    alert('Please sign in first');
    return;
  }
  
  const submitBtn = event.target.querySelector('button[type="submit"]');
  const originalText = submitBtn.innerHTML;
  submitBtn.disabled = true;
  submitBtn.innerHTML = '⏳ Saving...';
  
  try {
    // Collect form data (using product form fields)
    const variantId = document.getElementById('productId').value;
    const price = parseFloat(document.getElementById('price').value) || 0;
    const stock = parseInt(document.getElementById('stock').value) || 0;
    const minStock = parseInt(document.getElementById('minStock').value) || 0;
    
    // Validate
    if (price < 0 || stock < 0 || minStock < 0) {
      throw new Error('Values cannot be negative');
    }
    
    console.log('📤 Updating variant:', variantId);
    
    // Update in Firestore
    const { doc, updateDoc } = window.firebaseImports;
    const variantRef = doc(window.db, 'tenants', user.uid, 'products', variantId);
    
    await updateDoc(variantRef, {
      price: price,
      sellingPrice: price,
      stock: stock,
      minStock: minStock,
      updatedAt: new Date().toISOString()
    });
    
    console.log('✅ Variant updated in Firestore');
    
    // Update local cache
    const cachedVariant = cachedProducts.find(p => p.id === variantId);
    if (cachedVariant) {
      cachedVariant.price = price;
      cachedVariant.stock = stock;
      cachedVariant.minStock = minStock;
    }
    
    // Show success message
    showSuccessToast('Variant updated successfully!');
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
    if (modal) modal.hide();
    
    // Refresh variants list
    setTimeout(() => {
      if (currentGroupId) {
        loadGroupVariants(currentGroupId);
      }
    }, 500);
    
  } catch (error) {
    console.error('❌ Error updating variant:', error);
    alert('Error: ' + error.message);
    
    submitBtn.disabled = false;
    submitBtn.innerHTML = originalText;
  }
}


/**
 * ==========================================
 * DELETE FUNCTIONS - FIREBASE VERSION
 * ==========================================
 */

// ✅ NO CHANGES NEEDED
function confirmDeleteGroup(groupId, groupName) { /* Keep as is */ }

// Delete Product Group - FIREBASE VERSION
async function deleteProductGroup(groupId, groupName) {
  console.log('🗑️ Deleting group:', groupId);
  
  const user = window.auth.currentUser;
  if (!user) {
    alert('Please sign in first');
    return;
  }
  
  try {
    showLoadingOverlay('Deleting group...');
    
    const { doc, deleteDoc, collection, query, where, getDocs } = window.firebaseImports;
    
    // Delete the group document
    const groupRef = doc(window.db, 'tenants', user.uid, 'productGroups', groupId);
    await deleteDoc(groupRef);
    
    // Delete all variants in this group
    const productsRef = collection(window.db, 'tenants', user.uid, 'products');
    const q = query(productsRef, where('groupId', '==', groupId));
    const snapshot = await getDocs(q);
    
    const deletePromises = [];
    snapshot.forEach((docSnapshot) => {
      const variantRef = doc(window.db, 'tenants', user.uid, 'products', docSnapshot.id);
      deletePromises.push(deleteDoc(variantRef));
    });
    
    await Promise.all(deletePromises);
    
    hideLoadingOverlay();
    
    console.log(`✅ Group deleted along with ${deletePromises.length} variants`);
    
    showSuccessToast(`Deleted "${groupName}" and all its variants`);
    
    setTimeout(() => {
      loadProductGroups();
    }, 500);
    
  } catch (error) {
    hideLoadingOverlay();
    console.error('❌ Error deleting group:', error);
    alert('Error: ' + error.message);
  }
}

// ✅ NO CHANGES NEEDED
function confirmDeleteVariant(variantId, variantName) { /* Keep as is */ }

// Delete Variant - FIREBASE VERSION
async function deleteVariant(variantId, variantName) {
  console.log('🗑️ Deleting variant:', variantId);
  
  const user = window.auth.currentUser;
  if (!user) {
    alert('Please sign in first');
    return;
  }
  
  try {
    showLoadingOverlay('Deleting variant...');
    
    const { doc, deleteDoc } = window.firebaseImports;
    
    const variantRef = doc(window.db, 'tenants', user.uid, 'products', variantId);
    await deleteDoc(variantRef);
    
    hideLoadingOverlay();
    
    console.log('✅ Variant deleted from Firestore');
    
    showSuccessToast(`Deleted "${variantName}"`);
    
    setTimeout(() => {
      loadGroupVariants(currentGroupId);
    }, 500);
    
  } catch (error) {
    hideLoadingOverlay();
    console.error('❌ Error deleting variant:', error);
    alert('Error: ' + error.message);
  }
}





  // Open Add Product modal (from All Products page) - FIXED
function openAddProduct() {
  console.log('📝 Opening Add Product modal');
  loadBrandAutocompleteCache();
  // Reset product modal
  const modalTitle = document.getElementById('modalTitle');
  const productForm = document.getElementById('productForm');
  const productId = document.getElementById('productId');
  const currentPhotoUrl = document.getElementById('currentPhotoUrl');
  const photoPreview = document.getElementById('photoPreview');
  
  if (modalTitle) modalTitle.textContent = 'Add New Product';
  if (productForm) productForm.reset();
  if (productId) productId.value = '';
  if (currentPhotoUrl) currentPhotoUrl.value = '';
  if (photoPreview) photoPreview.style.display = 'none';
  
  // Show modal - FIXED Bootstrap 5 syntax
  const productModal = document.getElementById('productModal');
  if (productModal) {
    const modal = new bootstrap.Modal(productModal);
    modal.show();
    console.log('✅ Product modal opened');
  } else {
    console.error('❌ Product modal not found');
    alert('Error: Product modal not found. Please refresh the page.');
  }
}  
// Render All Products List - UPDATED
function renderAllProductsList() {
  const container = document.getElementById('allProductsList');
  
  if (!container) {
    console.error('❌ allProductsList container not found');
    return;
  }
  
  if (!cachedProducts || cachedProducts.length === 0) {
    container.innerHTML = `
      <div style="text-align:center; padding:60px 20px; color:#999;">
        <i class="bi bi-box-seam" style="font-size:64px;"></i>
        <h4 style="margin-top:20px;">No Products Yet</h4>
        <p>Add your first product to get started</p>
      </div>
    `;
    return;
  }
  
  let html = '';
  
  cachedProducts.forEach(product => {
    const stockBadge = product.stock <= product.minStock 
      ? `<span style="color:#dc3545;">⚠️ Low (${product.stock})</span>`
      : `<span style="color:#28a745;">✓ ${product.stock}</span>`;
    
    const productIcon = getProductIcon(product.category);
    
    // ✅ REMOVED EYE BUTTON, MADE CARD CLICKABLE
    html += `
      <div class="product-item-compact" onclick="showProductDetails('${product.id}')" style="cursor: pointer;">
        <div class="product-item-icon">${productIcon}</div>
        <div class="product-item-info">
          <div class="product-item-name">${product.name}</div>
          <div class="product-item-details">
            <span><i class="bi bi-tag"></i> ${product.category}</span>
            ${product.brand ? `<span><i class="bi bi-award"></i> ${product.brand}</span>` : ''}
            ${product.size ? `<span><i class="bi bi-rulers"></i> ${product.size}</span>` : ''}
            <span>${stockBadge}</span>
            <span><i class="bi bi-currency-rupee"></i>${product.price.toFixed(2)}</span>
          </div>
        </div>
        <div class="product-item-actions" onclick="event.stopPropagation()">
          <button class="btn-edit-compact" onclick="editProduct('${product.id}')">
            <i class="bi bi-pencil"></i>
          </button>
          <button class="btn-delete-compact" onclick="confirmDeleteProduct('${product.id}')">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}


/**
 * Show Product Details Modal (GLOBAL - works on any page)
 * ✅ DISABLED during bulk edit mode
 */
 function showProductDetails(productId) {
  console.log('👁️ Showing details for product:', productId);
  
  // ✅ CHECK IF BULK EDIT MODE IS ACTIVE
  if (bulkEditMode && bulkEditMode.active) {
    console.log('⚠️ Bulk edit mode active - product details disabled');
    return; // Don't show modal during bulk edit
  }
  
  // Find the product from cachedProducts
  const product = cachedProducts.find(p => p.id === productId);
  
  if (!product) {
    console.error('Product not found:', productId);
    alert('❌ Product not found');
    return;
  }
  
  // Create modal content with all specifications
  const modalContent = `
    <div style="padding: 20px;">
      ${product.imageUrl ? `
        <img src="${product.imageUrl}" 
             style="width:100%; max-height:300px; object-fit:cover; border-radius:8px; margin-bottom:20px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);" 
             alt="${escapeHtml(product.name)}" />
      ` : ''}
      
      <h3 style="margin-bottom: 20px; color: #333;">${escapeHtml(product.name)}</h3>
      
      <table style="width:100%; border-collapse: collapse;">
        <tr style="border-bottom: 1px solid #eee;">
          <td style="padding: 12px 10px; font-weight: 600; width: 40%;">Category:</td>
          <td style="padding: 12px 10px;">${escapeHtml(product.category || '-')}</td>
        </tr>
        
        ${product.brand ? `
        <tr style="border-bottom: 1px solid #eee;">
          <td style="padding: 12px 10px; font-weight: 600;">Brand:</td>
          <td style="padding: 12px 10px;">${escapeHtml(product.brand)}</td>
        </tr>` : ''}
        
        ${product.size ? `
        <tr style="border-bottom: 1px solid #eee;">
          <td style="padding: 12px 10px; font-weight: 600;">Size:</td>
          <td style="padding: 12px 10px;"><strong>${escapeHtml(product.size)}</strong></td>
        </tr>` : ''}
        
        <tr style="border-bottom: 1px solid #eee;">
          <td style="padding: 12px 10px; font-weight: 600;">Unit Type:</td>
          <td style="padding: 12px 10px;">${escapeHtml(product.unitType || 'Piece')}</td>
        </tr>
        
        ${product.piecesPerBox ? `
        <tr style="border-bottom: 1px solid #eee;">
          <td style="padding: 12px 10px; font-weight: 600;">Pieces/Box:</td>
          <td style="padding: 12px 10px;">${product.piecesPerBox}</td>
        </tr>` : ''}
        
        ${product.sftPerBox ? `
        <tr style="border-bottom: 1px solid #eee;">
          <td style="padding: 12px 10px; font-weight: 600;">SFT/Box:</td>
          <td style="padding: 12px 10px;">${product.sftPerBox}</td>
        </tr>` : ''}
        
        <tr style="border-bottom: 1px solid #eee; background: #f8f9fa;">
          <td style="padding: 12px 10px; font-weight: 600;">Selling Price:</td>
          <td style="padding: 12px 10px; font-size: 20px; color: #007bff; font-weight: 700;">
            ₹${parseFloat(product.price || 0).toFixed(2)}
          </td>
        </tr>
        
        <tr style="border-bottom: 1px solid #eee;">
          <td style="padding: 12px 10px; font-weight: 600;">Current Stock:</td>
          <td style="padding: 12px 10px;">
            ${stockBadgeHtml(product.stock, product.minStock)}
          </td>
        </tr>
        
        <tr style="border-bottom: 1px solid #eee;">
          <td style="padding: 12px 10px; font-weight: 600;">Min Stock Alert:</td>
          <td style="padding: 12px 10px;">${product.minStock || 5}</td>
        </tr>
        
        ${product.isGroupVariant ? `
        <tr style="background: #e3f2fd;">
          <td colspan="2" style="padding: 12px 10px; text-align: center;">
            <span style="background: #667eea; color: white; padding: 6px 16px; border-radius: 20px; font-weight: 600;">
              📦 Product Group Variant
            </span>
          </td>
        </tr>` : ''}
      </table>
      
      <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
        <button class="btn btn-primary" onclick="editProductFromDetail('${product.id}', ${product.isGroupVariant})">
          <i class="bi bi-pencil"></i> Edit Product
        </button>
        <button class="btn btn-secondary" onclick="closeProductDetailModal()">
          <i class="bi bi-x-circle"></i> Close
        </button>
      </div>
    </div>
  `;
  
  // Show in Bootstrap modal
  const modalEl = document.getElementById('productDetailModal');
  if (modalEl) {
    document.getElementById('productDetailModalBody').innerHTML = modalContent;
    const modal = new bootstrap.Modal(modalEl);
    modal.show();
  } else {
    console.error('❌ productDetailModal not found in DOM');
    // Fallback: create temporary modal
    createTempProductDetailModal(modalContent, product.id, product.isGroupVariant);
  }
}


/**
 * ✅ NEW: Edit product from detail modal - closes detail modal first
 */
function editProductFromDetail(productId, isVariant = false) {
  console.log('✏️ Edit from detail modal:', productId);
  
  // Close the product detail modal first
  closeProductDetailModal();
  
  // Wait for modal to close, then open edit modal
  setTimeout(() => {
    editProduct(productId, isVariant);
  }, 300); // 300ms delay for smooth transition
}

/**
 * Close Product Detail Modal
 */
function closeProductDetailModal() {
  const modalEl = document.getElementById('productDetailModal');
  if (modalEl) {
    const modal = bootstrap.Modal.getInstance(modalEl);
    if (modal) {
      modal.hide();
    }
  }
  
  // Also close temp modal if exists
  const tempModal = document.getElementById('tempProductDetailModal');
  if (tempModal) {
    const modal = bootstrap.Modal.getInstance(tempModal);
    if (modal) modal.hide();
  }
}

/**
 * Create temporary modal if main modal doesn't exist
 */
function createTempProductDetailModal(content, productId, isVariant) {
  // Remove existing temp modal if any
  let tempModal = document.getElementById('tempProductDetailModal');
  if (tempModal) tempModal.remove();
  
  // Replace the edit button onclick in content
  content = content.replace(
    `onclick="editProductFromDetail('${productId}', ${isVariant})"`,
    `onclick="editProductFromDetail('${productId}', ${isVariant})"`
  );
  
  // Create new modal
  const modalHTML = `
    <div class="modal fade" id="tempProductDetailModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">
              <i class="bi bi-info-circle"></i> Product Details
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">${content}</div>
        </div>
      </div>
    </div>
  `;
  
  document.body.insertAdjacentHTML('beforeend', modalHTML);
  
  const modal = new bootstrap.Modal(document.getElementById('tempProductDetailModal'));
  modal.show();
  
  // Remove on hide
  document.getElementById('tempProductDetailModal').addEventListener('hidden.bs.modal', function() {
    this.remove();
  });
}

// ✅ Make functions global
window.showProductDetails = showProductDetails;
window.editProductFromDetail = editProductFromDetail;
window.closeProductDetailModal = closeProductDetailModal;

console.log('✅ Product detail view functions loaded (global)');



// Confirm delete with better UX
function confirmDeleteProduct(productId) {
  const product = cachedProducts.find(p => p.id === productId);
  const productName = product ? product.name : 'this product';
  
  if (confirm(`⚠️ Delete "${productName}"?\n\nThis action cannot be undone.`)) {
    deleteProduct(productId);
  }
}

/**
 * Filter products by category
 */
 function filterByCategory(category) {
  currentCategoryFilter = category;
  
  // Update button states
  const buttons = document.querySelectorAll('#allProductsPage .btn-outline-primary');
  buttons.forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  
  if (category === 'all') {
    renderAllProductsList();
    return;
  }
  
  const filteredProducts = cachedProducts.filter(p => p.category === category);
  
  // Temporarily update for rendering
  const originalProducts = cachedProducts;
  cachedProducts = filteredProducts;
  renderAllProductsList();
  cachedProducts = originalProducts;
}


/**
 * Filter all products by search term
 */
function filterAllProducts() {
  const searchInput = document.getElementById('allProductsSearch');
  if (!searchInput) return;
  
  const searchTerm = searchInput.value.toLowerCase().trim();
  console.log('🔍 Searching products:', searchTerm);
  
  const allProducts = window.allProductsCache || [];
  
  if (!searchTerm) {
    // No search term - show all products
    renderFilteredProducts(allProducts);
    return;
  }
  
  // Filter products
  const filtered = allProducts.filter(product => {
    const name = (product.name || '').toLowerCase();
    const brand = (product.brand || '').toLowerCase();
    const category = (product.category || '').toLowerCase();
    const code = (product.code || '').toLowerCase();
    
    return name.includes(searchTerm) || 
           brand.includes(searchTerm) || 
           category.includes(searchTerm) ||
           code.includes(searchTerm);
  });
  
  console.log(`✅ Found ${filtered.length} matching products`);
  renderFilteredProducts(filtered);
}


/**
 * Render filtered products
 */
function renderFilteredProducts(products) {
  const container = document.getElementById('allProductsList');
  const emptyState = document.getElementById('allProductsEmptyState');
  
  if (!container) {
    console.error('❌ allProductsList container not found');
    return;
  }
  
  if (!products || products.length === 0) {
    container.innerHTML = '';
    if (emptyState) {
      emptyState.style.display = 'block';
    }
    return;
  }
  
  if (emptyState) {
    emptyState.style.display = 'none';
  }
  
  // Sort products alphabetically
  const sortedProducts = [...products].sort((a, b) => 
    (a.name || '').localeCompare(b.name || '')
  );
  
  let html = '<div style="padding:20px; max-width:1200px; margin:0 auto;">';
  
  sortedProducts.forEach(product => {
    const stockStatus = (product.currentStock || 0) > 0 ? 
      `<span class="badge bg-success">In Stock: ${product.currentStock}</span>` :
      `<span class="badge bg-danger">Out of Stock</span>`;
    
    html += `
      <div class="card mb-3 shadow-sm" style="cursor:pointer; transition:transform 0.2s;" 
           onmouseover="this.style.transform='scale(1.02)'" 
           onmouseout="this.style.transform='scale(1)'"
           onclick="viewProductDetails('${product.id}')">
        <div class="card-body">
          <div style="display:flex; justify-content:space-between; align-items:start;">
            <div style="flex:1;">
              <h5 class="mb-2">
                <i class="bi bi-box"></i> ${escapeHtml(product.name || 'Unnamed Product')}
              </h5>
              <p class="mb-1 text-muted">
                <strong>Brand:</strong> ${escapeHtml(product.brand || 'N/A')} | 
                <strong>Category:</strong> ${escapeHtml(product.category || 'N/A')}
              </p>
              <p class="mb-1">
                <strong>Code:</strong> ${escapeHtml(product.code || 'N/A')} | 
                <strong>Price:</strong> ₹${(product.sellingPrice || 0).toFixed(2)}
              </p>
              <div class="mt-2">
                ${stockStatus}
              </div>
            </div>
            <div style="display:flex; gap:8px;">
              <button class="btn btn-sm btn-primary" 
                      onclick="event.stopPropagation(); editProduct('${product.id}')"
                      title="Edit Product">
                <i class="bi bi-pencil"></i>
              </button>
              <button class="btn btn-sm btn-danger" 
                      onclick="event.stopPropagation(); deleteProduct('${product.id}')"
                      title="Delete Product">
                <i class="bi bi-trash"></i>
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  
  container.innerHTML = html;
  console.log(`✅ Rendered ${sortedProducts.length} products`);
}

// Make functions global
window.filterByCategory = filterByCategory;
window.filterAllProducts = filterAllProducts;
window.renderFilteredProducts = renderFilteredProducts;

    /**
 * ==========================================
 * PLACEHOLDER FUNCTIONS (TO BE IMPLEMENTED)
 * ==========================================
 */

// View product details (placeholder)
function viewProductDetails(productId) {
  const product = cachedProducts.find(p => p.id === productId);
  
  if (!product) {
    showError('Product not found');
    return;
  }
  
  // Simple alert for now - can be replaced with modal later
  let details = `📦 ${product.name}\n\n`;
  details += `Category: ${product.category}\n`;
  if (product.brand) details += `Brand: ${product.brand}\n`;
  if (product.size) details += `Size: ${product.size}\n`;
  details += `Price: ₹${product.price.toFixed(2)} / ${product.unitType}\n`;
  details += `Stock: ${product.stock}\n`;
  details += `Min Stock: ${product.minStock}\n`;
  
  alert(details);
}



    
/**
 * ==========================================
 * UI HELPER FUNCTIONS
 * ==========================================
 */

// Show success message
function showSuccessMessage(message) {
  const toast = document.createElement('div');
  toast.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: #4caf50;
    color: white;
    padding: 16px 24px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 10000;
    animation: slideIn 0.3s ease-out;
  `;
  toast.textContent = message;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease-out';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}


// Show Loading Overlay
function showLoadingOverlay(message = 'Loading...') {
  // Remove existing overlay if any
  let overlay = document.getElementById('loadingOverlayCustom');
  if (overlay) overlay.remove();
  
  // Create new overlay
  overlay = document.createElement('div');
  overlay.id = 'loadingOverlayCustom';
  overlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    background: rgba(0, 0, 0, 0.7);
    z-index: 100000;
    display: flex;
    align-items: center;
    justify-content: center;
  `;
  
  overlay.innerHTML = `
    <div style="background: white; padding: 32px; border-radius: 12px; text-align: center;">
      <div class="spinner"></div>
      <p style="margin-top: 16px; font-size: 16px; color: #333;">${message}</p>
    </div>
  `;
  
  document.body.appendChild(overlay);
}


// Hide Loading Overlay
function hideLoadingOverlay() {
  const overlay = document.getElementById('loadingOverlayCustom');
  if (overlay) {
    overlay.remove();
  }
}


// Escape HTML to prevent XSS
function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

/**
 * Navigate to Settings Page
 */
 function navigateToSettings() {
  console.log('⚙️ Navigating to Settings');
  
  currentPage = 'settings';
  
  // Get page elements
  const mainApp = document.getElementById('mainApp');
  const allProductsPage = document.getElementById('allProductsPage');
  const productGroupsPage = document.getElementById('productGroupsPage');
  const customersPage = document.getElementById('customersPage');
  const groupDetailPage = document.getElementById('groupDetailPage');
  const brandsPage = document.getElementById('brandsPage');
  const sizesPage = document.getElementById('sizesPage');
  const categoriesPage = document.getElementById('categoriesPage');
  const unitTypesPage = document.getElementById('unitTypesPage');
  const vendorsPage = document.getElementById('vendorsPage');
  const invoiceCustomersPage = document.getElementById('invoiceCustomersPage');
  const settingsPage = document.getElementById('settingsPage');
  
  // Hide all other pages
  if (mainApp) {
    mainApp.style.display = 'none';
    mainApp.classList.remove('active');
  }
  
  if (allProductsPage) {
    allProductsPage.classList.remove('active');
    allProductsPage.style.display = 'none';
  }
  
  if (productGroupsPage) {
    productGroupsPage.classList.remove('active');
    productGroupsPage.style.display = 'none';
  }
  
  if (customersPage) {
    customersPage.classList.remove('active');
    customersPage.style.display = 'none';
  }
  
  if (groupDetailPage) {
    groupDetailPage.classList.remove('active');
    groupDetailPage.style.display = 'none';
  }
  
  if (brandsPage) {
    brandsPage.classList.remove('active');
    brandsPage.style.display = 'none';
  }
  
  if (sizesPage) {
    sizesPage.classList.remove('active');
    sizesPage.style.display = 'none';
  }
  
  if (categoriesPage) {
    categoriesPage.classList.remove('active');
    categoriesPage.style.display = 'none';
  }
  
  if (unitTypesPage) {
    unitTypesPage.classList.remove('active');
    unitTypesPage.style.display = 'none';
  }
  
  if (vendorsPage) {
    vendorsPage.classList.remove('active');
    vendorsPage.style.display = 'none';
  }
  
  if (invoiceCustomersPage) {
    invoiceCustomersPage.classList.remove('active');
    invoiceCustomersPage.style.display = 'none';
  }
  
  // ✅ Hide main app navbar (like Brands page does)
  const mainNavbar = document.getElementById('mainAppNavbar');
  if (mainNavbar) {
    mainNavbar.style.display = 'none';
    console.log('✅ Hidden main app navbar');
  }
  
  // Also hide by class selector as backup
  const stickyNavbar = document.querySelector('.navbar.sticky-top');
  if (stickyNavbar) {
    stickyNavbar.style.display = 'none';
    console.log('✅ Hidden sticky navbar');
  }
  
  // Show settings page
  if (settingsPage) {
    settingsPage.classList.add('active');
    settingsPage.style.display = 'block';
    settingsPage.style.marginTop = '0';
    settingsPage.style.paddingTop = '0';
    console.log('✅ Settings page displayed');
  } else {
    console.error('❌ settingsPage element not found!');
    return;
  }
  
  // Close sidebar and scroll
  if (typeof closeSidebar === 'function') {
    closeSidebar();
  }
  
  window.scrollTo({ top: 0, behavior: 'smooth' });
  
  console.log('✅ Settings displayed');
}

// Make it global
window.navigateToSettings = navigateToSettings;


/**
 * ==========================================
 * BRAND AUTOCOMPLETE SYSTEM - FIREBASE VERSION
 * ==========================================
 */

// Global brand cache
let brandAutocompleteCache = [];
let brandCacheLoaded = false;




// ✅ THESE WERE MISSING!
let brandsCache = [];
let pendingBrands = [];



console.log('✅ Brand Manager Module Loaded');
function navigateToBrands() {
  console.log('🏷️ Navigating to Brands');
  
  currentPage = 'brands';
  
  // Get page elements
  const mainApp = document.getElementById('mainApp');
  const allProductsPage = document.getElementById('allProductsPage');
  const productGroupsPage = document.getElementById('productGroupsPage');
  const customersPage = document.getElementById('customersPage');
  const groupDetailPage = document.getElementById('groupDetailPage');
  const brandsPage = document.getElementById('brandsPage');
  const sizesPage = document.getElementById('sizesPage');
  const categoriesPage = document.getElementById('categoriesPage');
  const unitTypesPage = document.getElementById('unitTypesPage');
  const vendorsPage = document.getElementById('vendorsPage');
  const invoiceCustomersPage = document.getElementById('invoiceCustomersPage'); // ✅ ADD THIS
  
  // Hide all other pages
  if (mainApp) {
    mainApp.style.display = 'none';
    mainApp.classList.remove('active');
  }
  
  if (allProductsPage) {
    allProductsPage.classList.remove('active');
    allProductsPage.style.display = 'none';
  }
  
  if (productGroupsPage) {
    productGroupsPage.classList.remove('active');
    productGroupsPage.style.display = 'none';
  }
  
  if (customersPage) {
    customersPage.classList.remove('active');
    customersPage.style.display = 'none';
  }
  
  if (groupDetailPage) {
    groupDetailPage.classList.remove('active');
    groupDetailPage.style.display = 'none';
  }
  
  if (sizesPage) {
    sizesPage.classList.remove('active');
    sizesPage.style.display = 'none';
  }
  
  if (categoriesPage) {
    categoriesPage.classList.remove('active');
    categoriesPage.style.display = 'none';
  }
  
  if (unitTypesPage) {
    unitTypesPage.classList.remove('active');
    unitTypesPage.style.display = 'none';
  }
  
  if (vendorsPage) {
    vendorsPage.classList.remove('active');
    vendorsPage.style.display = 'none';
  }
  
  // ✅ ADD THIS - Hide invoice customers page
  if (invoiceCustomersPage) {
    invoiceCustomersPage.classList.remove('active');
    invoiceCustomersPage.style.display = 'none';
  }
  
  // ✅ Hide main app navbar
  const mainNavbar = document.getElementById('mainAppNavbar');
  if (mainNavbar) {
    mainNavbar.style.display = 'none';
    console.log('✅ Hidden main app navbar');
  }
  
  // Also hide by class selector as backup
  const stickyNavbar = document.querySelector('.navbar.sticky-top');
  if (stickyNavbar) {
    stickyNavbar.style.display = 'none';
    console.log('✅ Hidden sticky navbar');
  }
  
  // Show brands page
  if (brandsPage) {
    brandsPage.classList.add('active');
    brandsPage.style.display = 'block';
    brandsPage.style.marginTop = '0';
    brandsPage.style.paddingTop = '0';
    console.log('✅ Brands page displayed');
  } else {
    console.error('❌ brandsPage element not found!');
    return;
  }
  
  // Refresh brand caches
  if (typeof refreshBrandAutocompleteCache === 'function') {
    refreshBrandAutocompleteCache();
  }
  
  // Load brands
  if (typeof loadBrands === 'function') {
    loadBrands();
  }
  
  // Close sidebar and scroll
  if (typeof closeSidebar === 'function') {
    closeSidebar();
  }
  
  window.scrollTo({ top: 0, behavior: 'smooth' });
}


/**
 * ==========================================
 * SECTION 2: DATA LOADING FUNCTIONS
 * ==========================================
 */

async function loadBrands() {
  try {
    console.log('📡 Fetching brands from Firebase...');
    
    const user = window.auth.currentUser;
    
    if (!user) {
      console.error('❌ No user authenticated');
      throw new Error('Please sign in first');
    }
    
    const { collection, getDocs } = window.firebaseImports;
    const userId = user.uid;
    
    const brandsRef = collection(window.db, 'tenants', userId, 'brands');
    const brandsSnap = await getDocs(brandsRef);
    
    brandsCache = [];
    brandsSnap.forEach((doc) => {
      const data = doc.data();
      if (data.name) {
        brandsCache.push(data.name);
      }
    });
    
    console.log('✅ Loaded', brandsCache.length, 'brands from Firebase');
    console.log('  Brands:', brandsCache);
    
    renderBrandsList();
    
  } catch (error) {
    console.error('❌ Error loading brands:', error);
    
    const container = document.getElementById('brandsListContainer');
    if (container) {
      container.innerHTML = `
        <div style="text-align:center; padding:40px; color:#dc3545;">
          <i class="bi bi-exclamation-circle" style="font-size:48px;"></i>
          <h4 style="margin-top:20px;">Error Loading Brands</h4>
          <p>${error.message}</p>
          <button class="btn btn-primary mt-3" onclick="loadBrands()">
            <i class="bi bi-arrow-clockwise"></i> Retry
          </button>
        </div>
      `;
    }
  }
}

/**
 * ==========================================
 * SECTION 3: RENDERING FUNCTIONS
 * ==========================================
 */

function renderBrandsList() {
  console.log('🎨 Rendering brands list...');
  
  const container = document.getElementById('brandsListContainer');
  const emptyState = document.getElementById('brandsEmptyState');
  
  if (!container) {
    console.error('❌ brandsListContainer not found!');
    return;
  }
  
  if (!brandsCache || brandsCache.length === 0) {
    container.innerHTML = '';
    if (emptyState) {
      emptyState.style.display = 'block';
    }
    console.log('📋 No brands to display');
    return;
  }
  
  if (emptyState) {
    emptyState.style.display = 'none';
  }
  
  const sortedBrands = [...brandsCache].sort((a, b) => a.localeCompare(b));
  
  let html = '<div style="padding:20px; max-width:1200px; margin:0 auto;">';
  
  sortedBrands.forEach(brand => {
    html += `
      <div class="card mb-3 shadow-sm" style="cursor:pointer; transition:transform 0.2s;" 
           onmouseover="this.style.transform='scale(1.02)'" 
           onmouseout="this.style.transform='scale(1)'">
        <div class="card-body">
          <div style="display:flex; justify-content:space-between; align-items:start;">
            <div style="flex:1;">
              <h5 class="mb-2">
                <i class="bi bi-tag"></i> ${escapeHtml(brand)}
              </h5>
            </div>
            <div style="display:flex; gap:8px;">
              <button class="btn btn-sm btn-danger" 
                      onclick="confirmDeleteBrand('${escapeHtml(brand)}')"
                      title="Delete Brand">
                <i class="bi bi-trash"></i> Delete
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  
  container.innerHTML = html;
  console.log(`✅ Rendered ${brandsCache.length} brands`);
}

function filterBrands(searchTerm) {
  if (!brandsCache) {
    console.warn('⚠️ brandsCache is empty');
    return;
  }
  
  const term = searchTerm.toLowerCase().trim();
  const container = document.getElementById('brandsListContainer');
  const emptyState = document.getElementById('brandsEmptyState');
  
  if (!container) return;
  
  if (!term || term.length === 0) {
    renderBrandsList();
    return;
  }
  
  const filtered = brandsCache.filter(brand => 
    brand.toLowerCase().includes(term)
  );
  
  console.log(`🔍 Search: "${searchTerm}" - Found ${filtered.length} matches`);
  
  if (emptyState) {
    emptyState.style.display = 'none';
  }
  
  if (filtered.length === 0) {
    container.innerHTML = `
      <div style="text-align:center; padding:40px; color:#999;">
        <i class="bi bi-search" style="font-size:48px;"></i>
        <h4 style="margin-top:20px;">No brands found</h4>
        <p>No brands match "${escapeHtml(searchTerm)}"</p>
        <button class="btn btn-outline-primary mt-3" onclick="document.getElementById('searchBrandsInput').value=''; filterBrands('');">
          <i class="bi bi-x-circle"></i> Clear Search
        </button>
      </div>
    `;
    return;
  }
  
  const sortedFiltered = filtered.sort((a, b) => a.localeCompare(b));
  
  let html = '<div style="padding:20px; max-width:1200px; margin:0 auto;">';
  
  sortedFiltered.forEach(brand => {
    html += `
      <div class="card mb-3 shadow-sm" style="cursor:pointer; transition:transform 0.2s;" 
           onmouseover="this.style.transform='scale(1.02)'" 
           onmouseout="this.style.transform='scale(1)'">
        <div class="card-body">
          <div style="display:flex; justify-content:space-between; align-items:start;">
            <div style="flex:1;">
              <h5 class="mb-2">
                <i class="bi bi-tag"></i> ${escapeHtml(brand)}
              </h5>
            </div>
            <div style="display:flex; gap:8px;">
              <button class="btn btn-sm btn-danger" 
                      onclick="confirmDeleteBrand('${escapeHtml(brand)}')"
                      title="Delete Brand">
                <i class="bi bi-trash"></i> Delete
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  container.innerHTML = html;
}

/**
 * ==========================================
 * SECTION 4: MODAL FUNCTIONS
 * ==========================================
 */
function openAddBrandModal() {
  console.log('➕ Opening Add Brands modal');
  
  // Reset pending brands
  pendingBrands = [];
  
  // ✅ Use WORKING clear method
  document.querySelectorAll('#brandInput').forEach(inp => {
    inp.value = '';
    inp.setAttribute('value', '');
    window.lastBrandInput = '';
    inp.dispatchEvent(new Event('input', { bubbles: true }));
  });
  
  // Update preview (should show empty state)
  updateBrandPreviewList();
  
  // Open modal
  const modal = new bootstrap.Modal(document.getElementById('addBrandsModal'));
  modal.show();
  
  // Focus on input after modal opens
  setTimeout(() => {
    const input = document.getElementById('brandInput');
    if (input) {
      input.focus();
    }
  }, 200);
}


/**
 * ==========================================
 * SECTION 5: HANDLE BRAND INPUT
 * ==========================================
 */

/**
 * Force clear brand input (WORKING METHOD)
 */
function forceClearBrandInput() {
  // Clear ALL inputs with this ID
  document.querySelectorAll('#brandInput').forEach(inp => {
    inp.value = '';
    inp.setAttribute('value', '');
    window.lastBrandInput = '';
    inp.dispatchEvent(new Event('input', { bubbles: true }));
  });
  console.log('🧹 Input cleared');
}

/**
 * Handle brand input (Enter or Comma keys)
 */
function handleBrandInputKeydown(event) {
  const input = document.getElementById('brandInput');
  if (!input) {
    console.error('❌ brandInput not found');
    return;
  }
  
  // Check if Enter or Comma key
  if (event.key === 'Enter' || event.key === ',') {
    event.preventDefault();
    
    // Get value from storage or directly from input
    let value = window.lastBrandInput || input.value;
    value = value.trim();
    
    // Remove trailing comma if present
    if (value.endsWith(',')) {
      value = value.slice(0, -1).trim();
    }
    
    console.log('⌨️ Key pressed:', event.key);
    console.log('📝 Value:', value);
    
    if (value && value.length > 0) {
      // Check if already in pending list
      if (pendingBrands.includes(value)) {
        alert('⚠️ This brand is already in the list!');
      } else {
        // Add to pending brands
        pendingBrands.push(value);
        console.log('✅ Brand added to preview:', value);
        
        // Update preview
        updateBrandPreviewList();
      }
    }
    
    // ✅ Use the WORKING clear method
    forceClearBrandInput();
  }
}



/**
 * ✅ NEW FUNCTION - Add brand from button click
 * This function is triggered by the Enter icon button
 */
function addBrandFromButtonClick(event) {
  // Prevent any default behavior
  event.preventDefault();
  event.stopPropagation();
  
  const input = document.getElementById('brandInput');
  if (!input) {
    console.error('❌ brandInput not found');
    return;
  }
  
  const brandName = input.value.trim();
  
  console.log('🔘 Enter button clicked');
  console.log('📝 Input value:', brandName);
  console.log('📋 Current pending brands:', pendingBrands);
  
  // Check if empty
  if (!brandName || brandName.length === 0) {
    alert('⚠️ Please enter a brand name');
    input.focus();
    return;
  }
  
  // Check for duplicates in pending list
  if (pendingBrands.includes(brandName)) {
    alert('⚠️ This brand is already in the list!');
    input.value = '';
    input.focus();
    return;
  }
  
  // Check if brand already exists in database
  if (brandsCache && brandsCache.includes(brandName)) {
    const confirm = window.confirm(`⚠️ Brand "${brandName}" already exists in your database!\n\nDo you want to add it to the list anyway?`);
    if (!confirm) {
      input.value = '';
      input.focus();
      return;
    }
  }
  
  // Add to pending list
  pendingBrands.push(brandName);
  console.log('✅ Brand added to preview:', brandName);
  console.log('📋 Updated pending brands:', pendingBrands);
  
  // Clear input
  input.value = '';
  
  // Update preview
  updateBrandPreviewList();
  
  // Focus back to input
  setTimeout(() => {
    input.focus();
  }, 50);
}

/**
 * ==========================================
 * SECTION 6: BUTTON HANDLER
 * ==========================================
 */

function setupBrandInputButton() {
  const btn = document.getElementById('addBrandBtn');
  const input = document.getElementById('brandInput');
  
  if (!btn || !input) {
    console.error('❌ Button or input not found');
    return;
  }
  
  // Remove old listener if exists
  const newBtn = btn.cloneNode(true);
  btn.parentNode.replaceChild(newBtn, btn);
  
  // Add fresh listener
  newBtn.addEventListener('click', function(e) {
    e.preventDefault();
    e.stopPropagation();
    
    const brandName = input.value.trim();
    
    console.log('🔘 Button clicked');
    console.log('📝 Value:', brandName);
    console.log('📋 Current pending:', pendingBrands);
    
    if (!brandName) {
      alert('⚠️ Please enter a brand name');
      return;
    }
    
    if (pendingBrands.includes(brandName)) {
      alert('⚠️ This brand is already in the list!');
      return;
    }
    
    pendingBrands.push(brandName);
    console.log('✅ Added:', brandName);
    
    input.value = '';
    updateBrandPreviewList();
    input.focus();
  });
  
  newBtn.addEventListener('mouseenter', function() {
    this.style.background = '#218838';
  });
  
  newBtn.addEventListener('mouseleave', function() {
    this.style.background = '#28a745';
  });
  
  console.log('✅ Brand input button setup complete');
}

/**
 * ==========================================
 * SECTION 7: UPDATE BRAND PREVIEW
 * ==========================================
 */

function updateBrandPreviewList() {
  const previewList = document.getElementById('brandPreviewList');
  const previewCount = document.getElementById('previewCount');
  
  if (!previewList) {
    console.error('❌ brandPreviewList not found');
    return;
  }
  
  if (previewCount) {
    previewCount.textContent = `📝 Brands to Save (${pendingBrands.length}):`;
  }
  
  if (pendingBrands.length === 0) {
    previewList.innerHTML = `
      <div style="padding: 15px; color: #999; text-align: center; font-size: 14px;">
        No brands added yet
      </div>
    `;
    return;
  }
  
  let html = '';
  pendingBrands.forEach((brand, index) => {
    html += `
      <div style="
        display: flex; justify-content: space-between; align-items: center;
        padding: 10px 12px; border-bottom: 1px solid #e0e0e0;
        background: white; transition: background 0.2s;
      " onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='white'">
        
        <span style="font-size: 14px; color: #333; flex: 1;">
          <strong style="color: #007bff;">${index + 1}.</strong> 
          <span style="margin-left: 8px;">${escapeHtml(brand)}</span>
        </span>
        
        <button onclick="removePendingBrand('${escapeHtml(brand)}')" style="
          background: #dc3545; color: white; border: none; 
          padding: 5px 10px; border-radius: 5px; cursor: pointer;
          font-size: 12px; font-weight: 600; transition: background 0.2s;
        " onmouseover="this.style.background='#c82333'" onmouseout="this.style.background='#dc3545'">
          <i class="bi bi-x"></i>
        </button>
      </div>
    `;
  });
  
  previewList.innerHTML = html;
  console.log(`📋 Updated preview: ${pendingBrands.length} brands`);
}

function removePendingBrand(brand) {
  pendingBrands = pendingBrands.filter(b => b !== brand);
  updateBrandPreviewList();
  console.log('🗑️ Removed from preview:', brand);
}

/**
 * ==========================================
 * SECTION 8: SAVE ALL BRANDS TO FIREBASE
 * ==========================================
 */
async function saveAllBrands() {
  if (pendingBrands.length === 0) {
    alert('⚠️ Please add at least one brand');
    return;
  }
  
  console.log('💾 Saving', pendingBrands.length, 'brands to Firebase...');
  
  const user = window.auth.currentUser;
  
  if (!user) {
    alert('❌ Please sign in first');
    return;
  }
  
  try {
    // Clear input field
    document.querySelectorAll('#brandInput').forEach(inp => {
      inp.value = '';
      inp.setAttribute('value', '');
      window.lastBrandInput = '';
      inp.dispatchEvent(new Event('input', { bubbles: true }));
    });
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('addBrandsModal'));
    if (modal) {
      modal.hide();
    }
    
    // Add brands to cache immediately
    const brandsToSave = [...pendingBrands];
    brandsCache.push(...brandsToSave);
    
    // ✅ FIXED: Also update autocomplete cache
    brandsToSave.forEach(brand => {
      if (!brandAutocompleteCache.includes(brand)) {
        brandAutocompleteCache.push(brand);
      }
    });
    console.log('✅ Updated both caches');
    
    // Refresh display
    renderBrandsList();
    
    // Show success
    alert(`✅ Success!\n\n${brandsToSave.length} brand(s) added!`);
    
    // Clear pending
    pendingBrands = [];
    
    // Save to Firebase
    const { collection, addDoc } = window.firebaseImports;
    const userId = user.uid;
    const brandsRef = collection(window.db, 'tenants', userId, 'brands');
    
    const savePromises = brandsToSave.map(async (brandName) => {
      try {
        await addDoc(brandsRef, {
          name: brandName,
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString(),
          userId: userId
        });
        console.log('✅ Firebase: Brand saved:', brandName);
        return { success: true, brand: brandName };
      } catch (error) {
        console.error('❌ Firebase: Failed to save brand:', brandName, error);
        return { success: false, brand: brandName, error };
      }
    });
    
    const results = await Promise.all(savePromises);
    const failed = results.filter(r => !r.success);
    
    if (failed.length > 0) {
      console.warn(`⚠️ ${failed.length} brand(s) failed to save`);
      setTimeout(() => {
        loadBrands();
      }, 1000);
    } else {
      console.log(`✅ All ${brandsToSave.length} brands saved`);
    }
    
  } catch (error) {
    console.error('❌ Error saving brands:', error);
    alert('❌ Error saving brands. Please try again.');
    loadBrands();
  }
}


/**
 * ==========================================
 * SECTION 9: DELETE BRAND FROM FIREBASE
 * ==========================================
 */

function confirmDeleteBrand(brand) {
  const confirmed = confirm(`🗑️ Delete "${brand}"?\n\nThis cannot be undone.`);
  
  if (confirmed) {
    deleteBrand(brand);
  }
}
/**
 * Delete a brand
 * ✅ FIXED - Actually deletes from Firebase
 */
async function deleteBrand(brandName) {
  const confirmed = confirm(`Are you sure you want to delete "${brandName}"?\n\nThis action cannot be undone.`);
  
  if (!confirmed) {
    return;
  }
  
  console.log('🗑️ Deleting brand:', brandName);
  
  const user = window.auth.currentUser;
  
  if (!user) {
    alert('❌ Please sign in first');
    return;
  }
  
  try {
    // Remove from local caches immediately (Optimistic UI)
    brandsCache = brandsCache.filter(b => b !== brandName);
    brandAutocompleteCache = brandAutocompleteCache.filter(b => b !== brandName);
    
    console.log('🧹 Removed from local caches');
    console.log('  brandsCache:', brandsCache.length, 'items');
    console.log('  brandAutocompleteCache:', brandAutocompleteCache.length, 'items');
    
    // Refresh display immediately
    renderBrandsList();
    
    // ✅ FIXED: Delete from Firebase properly
    const { collection, query, where, getDocs, deleteDoc, doc } = window.firebaseImports;
    const userId = user.uid;
    
    const brandsRef = collection(window.db, 'tenants', userId, 'brands');
    
    // Query for brands with this name
    const q = query(brandsRef, where('name', '==', brandName));
    const snapshot = await getDocs(q);
    
    console.log('📊 Firebase query found', snapshot.size, 'documents to delete');
    
    if (snapshot.empty) {
      console.warn('⚠️ Brand not found in Firebase:', brandName);
      
      // Try alternate field name
      const q2 = query(brandsRef, where('brandName', '==', brandName));
      const snapshot2 = await getDocs(q2);
      
      console.log('📊 Trying "brandName" field, found', snapshot2.size, 'documents');
      
      if (snapshot2.empty) {
        console.error('❌ Brand not found with either field name');
        alert(`⚠️ Brand "${brandName}" not found in database`);
        return;
      }
      
      // Delete from alternate query
      const deletePromises2 = [];
      snapshot2.forEach((docSnap) => {
        console.log('  Deleting doc:', docSnap.id);
        deletePromises2.push(deleteDoc(docSnap.ref));
      });
      
      await Promise.all(deletePromises2);
      console.log('✅ Brand deleted from Firebase (brandName field)');
      alert(`✅ Brand "${brandName}" deleted successfully!`);
      return;
    }
    
    // Delete all matching documents
    const deletePromises = [];
    snapshot.forEach((docSnap) => {
      console.log('  Deleting doc:', docSnap.id, '→', docSnap.data());
      deletePromises.push(deleteDoc(docSnap.ref));
    });
    
    await Promise.all(deletePromises);
    
    console.log('✅ Brand deleted from Firebase:', brandName);
    alert(`✅ Brand "${brandName}" deleted successfully!`);
    
  } catch (error) {
    console.error('❌ Error deleting brand:', error);
    console.error('Error details:', error.message);
    alert('❌ Error deleting brand: ' + error.message);
    
    // Reload brands to sync
    loadBrands();
  }
}


/**
 * ==========================================
 * SECTION 10: HELPER FUNCTIONS
 * ==========================================
 */

function goBackHome() {
  console.log('🏠 Going back to home');
  
  const navbar = document.querySelector('.navbar');
  if (navbar) {
    navbar.style.display = 'flex';
  }
  
  const brandsPage = document.getElementById('brandsPage');
  if (brandsPage) {
    brandsPage.style.display = 'none';
  }
  
  if (typeof navigateToHome === 'function') {
    navigateToHome();
  } else if (typeof navigateTo === 'function') {
    navigateTo('dashboard');
  } else {
    location.reload();
  }
}

function escapeHtml(text) {
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#39;'
  };
  return String(text).replace(/[&<>"']/g, m => map[m]);
}

console.log('✅ Brand Manager Module Loaded (Firebase)');
/**
 * Remove pending brand from list
 */
function removePendingBrand(index) {
  if (!pendingBrands || index < 0 || index >= pendingBrands.length) {
    console.error('❌ Invalid index:', index);
    return;
  }
  
  const removed = pendingBrands.splice(index, 1);
  console.log('🗑️ Removed brand:', removed[0]);
  updateBrandPreviewList();
}

// ✅ Make them global
window.updateBrandPreviewList = updateBrandPreviewList;
window.removePendingBrand = removePendingBrand;




async function loadBrandAutocompleteCache() {
  if (brandCacheLoaded) {
    console.log('✅ Brand cache already loaded');
    return;
  }
  
  const user = window.auth.currentUser;
  
  if (!user) {
    console.log('No user authenticated, skipping brand cache load');
    return;
  }
  
  console.log('📥 Loading brand autocomplete cache from Firestore...');
  
  try {
    const { collection, getDocs } = window.firebaseImports;
    
    // Load from Firestore
    const brandsRef = collection(window.db, 'tenants', user.uid, 'brands');
    const snapshot = await getDocs(brandsRef);
    
    const brands = [];
    snapshot.forEach((doc) => {
      const data = doc.data();
      // ✅ FIXED: Use 'name' field (with fallback to 'brandName' for old data)
      const brandName = data.name || data.brandName;
      if (brandName) {
        brands.push(brandName);
      }
    });
    
    brandAutocompleteCache = brands;
    brandCacheLoaded = true;
    
    console.log('✅ Loaded', brands.length, 'brands into cache from Firestore');
    
  } catch (error) {
    console.error('❌ Error loading brand cache from Firestore:', error);
    
    // Fallback: Try to extract unique brands from products
    try {
      const uniqueBrands = [...new Set(
        cachedProducts
          .map(p => p.brand)
          .filter(b => b && b.trim() !== '')
      )];
      
      brandAutocompleteCache = uniqueBrands;
      brandCacheLoaded = true;
      
      console.log('✅ Extracted', uniqueBrands.length, 'brands from products as fallback');
    } catch (fallbackError) {
      console.error('❌ Fallback brand extraction failed:', fallbackError);
    }
  }
}


async function loadBrands() {
  try {
    console.log('📡 Fetching brands from Firebase...');
    
    const user = window.auth.currentUser;
    
    if (!user) {
      console.error('❌ No user authenticated');
      throw new Error('Please sign in first');
    }
    
    const { collection, getDocs } = window.firebaseImports;
    const userId = user.uid;
    
    const brandsRef = collection(window.db, 'tenants', userId, 'brands');
    const brandsSnap = await getDocs(brandsRef);
    
    brandsCache = [];
    brandsSnap.forEach((doc) => {
      const data = doc.data();
      const brandName = data.name || data.brandName;
      if (brandName) {
        brandsCache.push(brandName);
      }
    });
    
    console.log('✅ Loaded', brandsCache.length, 'brands from Firebase');
    
    // Sync caches
    syncBrandCaches();
    
    renderBrandsList();
    
  } catch (error) {
    console.error('❌ Error loading brands:', error);
    
    const container = document.getElementById('brandsListContainer');
    if (container) {
      container.innerHTML = `
        <div style="text-align:center; padding:40px; color:#dc3545;">
          <i class="bi bi-exclamation-circle" style="font-size:48px;"></i>
          <h4 style="margin-top:20px;">Error Loading Brands</h4>
          <p>${error.message}</p>
          <button class="btn btn-primary mt-3" onclick="loadBrands()">
            <i class="bi bi-arrow-clockwise"></i> Retry
          </button>
        </div>
      `;
    }
  }
}

/**
 * Render brands list
 */
 function renderBrandsList() {
  const container = document.getElementById('brandsListContainer');
  const emptyState = document.getElementById('brandsEmptyState');
  
  if (!container) return;
  
  if (brandsCache.length === 0) {
    container.style.display = 'none';
    if (emptyState) emptyState.style.display = 'block';
    return;
  }
  
  container.style.display = 'grid';
  if (emptyState) emptyState.style.display = 'none';
  
  // Sort alphabetically
  const sortedBrands = [...brandsCache].sort((a, b) => a.localeCompare(b));
  
  let html = '<div class="row g-3">';
  
  sortedBrands.forEach(brand => {
    html += `
      <div class="col-12 col-sm-6 col-md-4 col-lg-3">
        <div class="card h-100" style="border-radius: 8px; transition: all 0.2s;">
          <div class="card-body d-flex align-items-center justify-content-between">
            <div>
              <h6 class="mb-0" style="font-weight: 600;">
                <i class="bi bi-tag text-success"></i> ${brand}
              </h6>
            </div>
            <button 
              class="btn btn-sm btn-outline-danger" 
              onclick="deleteBrand('${escapeHtml(brand)}')"
              title="Delete">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  
  container.innerHTML = html;
}
/**
 * Filter brand suggestions based on input
 * ✅ Enhanced version with smooth UX
 */
 function filterBrandSuggestions(inputText) {
  const dropdown = document.getElementById('addProductBrandSuggestionsDropdown');
  const input = document.getElementById('brand');
  
  if (!input) {
    console.warn('⚠️ Brand input field not found');
    return;
  }
  
  // Check if input field is focused
  const isFocused = document.activeElement === input;
  
  // Normalize input
  const trimmedInput = inputText ? inputText.trim() : '';
  
  // ✅ CASE 1: Input is empty
  if (!trimmedInput || trimmedInput.length === 0) {
    // Show all brands ONLY if field is focused
    if (isFocused) {
      if (brandAutocompleteCache && brandAutocompleteCache.length > 0) {
        renderBrandSuggestions(brandAutocompleteCache);
        console.log('✅ Showing all', brandAutocompleteCache.length, 'brands (field focused, input empty)');
      } else {
        // No brands in cache
        if (dropdown) {
          dropdown.innerHTML = `
            <div style="padding: 15px; text-align: center; color: #999;">
              <i class="bi bi-inbox"></i> No brands available
            </div>
          `;
          dropdown.style.display = 'block';
        }
        console.log('ℹ️ No brands in cache');
      }
    } else {
      // Field not focused, hide dropdown
      if (dropdown) dropdown.style.display = 'none';
    }
    
    // Hide save button when input is empty
    const saveBtn = document.getElementById('saveBrandInsideBtn');
    if (saveBtn) saveBtn.style.display = 'none';
    
    return;
  }
  
  // ✅ CASE 2: User is typing - filter brands
  const query = trimmedInput.toLowerCase();
  const matches = brandAutocompleteCache.filter(brand => 
    brand.toLowerCase().startsWith(query)
  );
  
  if (matches.length > 0) {
    // Show filtered results
    renderBrandSuggestions(matches);
    console.log('✅ Showing', matches.length, 'brands matching "' + trimmedInput + '"');
  } else {
    // No matches found
    if (dropdown) {
      dropdown.innerHTML = `
        <div style="padding: 15px; text-align: center; color: #999;">
          <i class="bi bi-search"></i> No brands match "<strong>${escapeHtml(trimmedInput)}</strong>"
        </div>
      `;
      dropdown.style.display = 'block';
    }
    console.log('ℹ️ No brands match:', trimmedInput);
  }
  
  // Check if we should show save button for new brand
  checkAndShowSaveBrandButton(trimmedInput);
}




/**
 * Render brand suggestions in dropdown
 */
function renderBrandSuggestions(matches) {
  const dropdown = document.getElementById('brandSuggestionsDropdown');
  
  // Limit to max 15 suggestions
  const limitedMatches = matches.slice(0, 15);
  
  let html = '';
  limitedMatches.forEach(brand => {
    html += `
      <div onclick="selectBrandSuggestion('${escapeHtml(brand)}')" style="
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background 0.2s;
      " onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='transparent'">
        <strong>${brand}</strong>
      </div>
    `;
  });
  
  dropdown.innerHTML = html;
  dropdown.style.display = 'block';
  
  console.log('🎯 Rendered', limitedMatches.length, 'brand suggestions');
}

/**
 * Select brand from dropdown
 */
function selectBrandSuggestion(brandName) {
  document.getElementById('brand').value = brandName;
  
  // ✅ Hide save button when brand is selected
  const saveBtn = document.getElementById('saveBrandInsideBtn');
  if (saveBtn) {
    saveBtn.style.display = 'none';
  }
  
  hideBrandSuggestions();
  console.log('✅ Selected brand:', brandName);
}

/**
 * Show all brands when field is focused (clicked)
 * If user has typed text, show filtered suggestions
 */
function showBrandSuggestions() {
  const input = document.getElementById('brand');
  if (!input) return;
  
  const inputValue = input.value.trim();
  
  // ✅ If field is empty, show ALL brands
  if (!inputValue || inputValue.length === 0) {
    if (brandAutocompleteCache && brandAutocompleteCache.length > 0) {
      renderBrandSuggestions(brandAutocompleteCache);
      console.log('📋 Showing all', brandAutocompleteCache.length, 'brands');
    } else {
      console.warn('⚠️ No brands in cache');
    }
  } else {
    // If user has typed something, filter based on input
    filterBrandSuggestions(inputValue);
  }
}

/**
 * Hide suggestions dropdown
 */
function hideBrandSuggestions() {
  const dropdown = document.getElementById('brandSuggestionsDropdown');
  if (dropdown) {
    dropdown.style.display = 'none';
  }
}

/**
 * Check if brand exists and show/hide save button
 * Hides "Saved" state when user modifies the field
 */
function checkAndShowSaveBrandButton(inputText) {
  const btn = document.getElementById('saveBrandInsideBtn');
  if (!btn) return;
  
  const input = inputText.trim();
  
  // Hide button if input is empty
  if (!input || input.length === 0) {
    btn.style.display = 'none';
    return;
  }
  
  // Check if brand already exists in cache
  const brandExists = brandAutocompleteCache.some(brand => 
    brand.toLowerCase() === input.toLowerCase()
  );
  
  // Show button ONLY if brand doesn't exist
  if (!brandExists) {
    // ✅ Reset to save icon when user modifies field
    btn.innerHTML = '💾';
    btn.style.background = '#28a745';
    btn.style.cursor = 'pointer';
    btn.disabled = false;
    btn.style.display = 'block';
    
    console.log('✅ Show save button - new brand:', input);
  } else {
    btn.style.display = 'none';
    console.log('ℹ️ Hide save button - brand already exists:', input);
  }
}

/**
 * Save new brand to Firestore
 * ✅ FIXED - Uses 'name' field consistently
 */
async function saveNewBrandFromProductField() {
  const input = document.getElementById('brand');
  const brandName = input.value.trim();
  const btn = document.getElementById('saveBrandInsideBtn');
  
  if (!brandName || brandName.length === 0) {
    return;
  }
  
  const user = window.auth.currentUser;
  
  if (!user) {
    console.log('No user authenticated');
    return;
  }
  
  // Check if brand already exists
  const brandExists = brandAutocompleteCache.some(brand => 
    brand.toLowerCase() === brandName.toLowerCase()
  );
  
  if (brandExists) {
    if (btn) {
      btn.style.display = 'none';
    }
    return;
  }
  
  console.log('💾 Saving new brand to Firestore:', brandName);
  
  // Instant feedback
  if (btn) {
    btn.innerHTML = '✅ Saved';
    btn.style.background = '#218838';
    btn.disabled = true;
    btn.style.cursor = 'default';
  }
  
  try {
    const { collection, addDoc } = window.firebaseImports;
    
    // Save to Firestore
    const brandsRef = collection(window.db, 'tenants', user.uid, 'brands');
    await addDoc(brandsRef, {
      name: brandName,  // ✅ FIXED: Use 'name' instead of 'brandName'
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),  // ✅ Added updatedAt
      userId: user.uid
    });
    
    console.log('✅ Brand saved successfully in Firestore:', brandName);
    
    // Add to cache
    brandAutocompleteCache.push(brandName);
    
    // Button stays as "✅ Saved"
    
  } catch (error) {
    console.error('❌ Error saving brand to Firestore:', error);
    
    // Show error on button
    if (btn) {
      btn.innerHTML = '❌ Error';
      btn.style.background = '#dc3545';
      
      // Reset after 2 seconds
      setTimeout(() => {
        btn.innerHTML = '💾';
        btn.style.background = '#28a745';
        btn.disabled = false;
        btn.style.cursor = 'pointer';
      }, 2000);
    }
  }
}


/**
 * Sync autocomplete cache with brands cache
 */
 function syncBrandCaches() {
  console.log('🔄 Syncing brand caches...');
  brandAutocompleteCache = [...brandsCache];
  brandAutocompleteCache = [...new Set(brandAutocompleteCache)];
  console.log('✅ Sync complete -', brandAutocompleteCache.length, 'brands');
}


/**
 * Refresh brand cache
 * ✅ Updated for Firebase
 */
function refreshBrandAutocompleteCache() {
  brandCacheLoaded = false;
  loadBrandAutocompleteCache();
}


/**
 * ==========================================
 * ADD PRODUCT MODAL - BRAND FUNCTIONS
 * ==========================================
 */

/**
 * Show brand suggestions for ADD PRODUCT modal
 */
 async function showBrandSuggestions() {
  const input = document.getElementById('brand');
  if (!input) return;
  
  console.log('👆 Add Product brand field clicked');
  
  // Load cache if empty
  if (!brandAutocompleteCache || brandAutocompleteCache.length === 0) {
    const user = window.auth.currentUser;
    if (user) {
      try {
        const { collection, getDocs } = window.firebaseImports;
        const brandsRef = collection(window.db, 'tenants', user.uid, 'brands');
        const snapshot = await getDocs(brandsRef);
        
        const brands = [];
        snapshot.forEach((doc) => {
          const data = doc.data();
          const brandName = data.name || data.brandName;
          if (brandName) brands.push(brandName);
        });
        
        brandAutocompleteCache = brands;
        brandCacheLoaded = true;
        console.log('✅ Force loaded', brands.length, 'brands for Add Product');
      } catch (error) {
        console.error('❌ Error:', error);
        return;
      }
    }
  }
  
  const inputValue = input.value.trim();
  
  if (!inputValue || inputValue.length === 0) {
    if (brandAutocompleteCache && brandAutocompleteCache.length > 0) {
      renderBrandSuggestions(brandAutocompleteCache);
    }
  } else {
    filterBrandSuggestions(inputValue);
  }
}



/**
 * Render brand suggestions for ADD PRODUCT modal
 */
function renderBrandSuggestions(matches) {
  const dropdown = document.getElementById('addProductBrandSuggestionsDropdown');
  if (!dropdown) return;
  
  const limitedMatches = matches.slice(0, 15);
  
  let html = '';
  limitedMatches.forEach(brand => {
    const escaped = escapeHtml(brand);
    html += `
      <div onclick="selectBrandSuggestion('${escaped}')" style="
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background 0.2s;
      " onmouseover="this.style.background='#f5f5f5'" 
         onmouseout="this.style.background='transparent'">
        <strong>${brand}</strong>
      </div>
    `;
  });
  
  dropdown.innerHTML = html;
  dropdown.style.display = 'block';
  
  console.log('✅ Rendered', limitedMatches.length, 'brands for Add Product');
}

/**
 * Select brand for ADD PRODUCT modal
 */
function selectBrandSuggestion(brandName) {
  const input = document.getElementById('brand');
  const dropdown = document.getElementById('addProductBrandSuggestionsDropdown');
  
  if (input) {
    input.value = brandName;
  }
  
  // Hide dropdown
  if (dropdown) dropdown.style.display = 'none';
  
  // Hide save button
  const saveBtn = document.getElementById('saveBrandInsideBtn');
  if (saveBtn) saveBtn.style.display = 'none';
  
  console.log('✅ Selected brand:', brandName);
}

/**
 * Hide brand suggestions for ADD PRODUCT modal
 */
function hideBrandSuggestions() {
  const dropdown = document.getElementById('addProductBrandSuggestionsDropdown');
  if (dropdown) {
    dropdown.style.display = 'none';
  }
}

/**
 * Check if brand exists and show/hide save button
 */
function checkAndShowSaveBrandButton(inputText) {
  const btn = document.getElementById('saveBrandInsideBtn');
  if (!btn) return;
  
  const input = inputText.trim();
  
  if (!input || input.length === 0) {
    btn.style.display = 'none';
    return;
  }
  
  const brandExists = brandAutocompleteCache.some(brand => 
    brand.toLowerCase() === input.toLowerCase()
  );
  
  if (!brandExists) {
    btn.innerHTML = '💾';
    btn.style.background = '#28a745';
    btn.style.cursor = 'pointer';
    btn.disabled = false;
    btn.style.display = 'block';
  } else {
    btn.style.display = 'none';
  }
}

/**
 * Save new brand from ADD PRODUCT field
 */
async function saveNewBrandFromProductField() {
  const input = document.getElementById('brand');
  const brandName = input.value.trim();
  const btn = document.getElementById('saveBrandInsideBtn');
  
  if (!brandName || brandName.length === 0) {
    return;
  }
  
  const user = window.auth.currentUser;
  
  if (!user) {
    console.log('No user authenticated');
    return;
  }
  
  const brandExists = brandAutocompleteCache.some(brand => 
    brand.toLowerCase() === brandName.toLowerCase()
  );
  
  if (brandExists) {
    if (btn) btn.style.display = 'none';
    return;
  }
  
  console.log('💾 Saving new brand:', brandName);
  
  if (btn) {
    btn.innerHTML = '✅ Saved';
    btn.style.background = '#218838';
    btn.disabled = true;
  }
  
  try {
    const { collection, addDoc } = window.firebaseImports;
    
    const brandsRef = collection(window.db, 'tenants', user.uid, 'brands');
    await addDoc(brandsRef, {
      name: brandName,
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
      userId: user.uid
    });
    
    console.log('✅ Brand saved successfully:', brandName);
    
    // Add to cache
    brandAutocompleteCache.push(brandName);
    
  } catch (error) {
    console.error('❌ Error saving brand:', error);
    
    if (btn) {
      btn.innerHTML = '❌ Error';
      btn.style.background = '#dc3545';
      
      setTimeout(() => {
        btn.innerHTML = '💾';
        btn.style.background = '#28a745';
        btn.disabled = false;
      }, 2000);
    }
  }
}





    
/**
 * ==========================================
 * INITIALIZE ON PAGE LOAD
 * ==========================================
 */

// Add event listeners when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
  console.log('🎨 Product Groups UI initialized');
 // ✅ ADD THIS LINE - Load brand cache on page load
  loadBrandAutocompleteCache();
  loadVendorAutocompleteCache();
  loadInvoiceCustomerAutocompleteCache(); 

  
  // Add event listener for group name input (real-time preview)
  const groupNameInput = document.getElementById('groupName');
  if (groupNameInput) {
    groupNameInput.addEventListener('input', updateVariantPreview);
  }
  
  // Close modals on ESC key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      const createModal = document.getElementById('createGroupModal');
      const editModal = document.getElementById('editVariantModal');
      
      if (createModal && createModal.classList.contains('active')) {
        closeCreateGroupModal();
      }
      
      if (editModal && editModal.classList.contains('active')) {
        closeEditVariantModal();
      }
    }
  });
});


/**
 * ==========================================
 * UTILITY: Navigate to Home (Override if needed)
 * ==========================================
 */


/**
 * Create Product Group - FIREBASE VERSION
 * ✅ This is the older/duplicate function - update to match the newer one
 */
async function createProductGroup(groupData) {
  const user = window.auth.currentUser;
  
  if (!user) {
    alert('Please sign in first');
    return;
  }
  
  try {
    const btn = document.getElementById('btnSaveGroup');
    if (btn) { 
      btn.disabled = true; 
      btn.innerHTML = '⏳ Creating...'; 
    }
    
    console.log('📦 Creating product group in Firestore:', groupData);
    
    const { collection, addDoc } = window.firebaseImports;
    
    // Save product group
    const groupsRef = collection(window.db, 'tenants', user.uid, 'productGroups');
    const groupDocRef = await addDoc(groupsRef, {
      groupName: groupData.groupName,
      description: groupData.description || '',
      manufacturer: groupData.manufacturer || '',
      brand: groupData.brand || groupData.manufacturer || '',
      category: groupData.category || '',
      attributes: groupData.attributes || {},
      totalVariants: 0, // Will be updated after variants are created
      createdBy: user.email,
      createdAt: new Date().toISOString(),
      userId: user.uid
    });
    
    console.log('✅ Group created in Firestore:', groupDocRef.id);
    
    alert(`Success! Group "${groupData.groupName}" created.`);
    
    closeCreateGroupModal();
    
    setTimeout(() => {
      loadProductGroups();
    }, 500);
    
  } catch (error) {
    console.error('❌ Error creating product group:', error);
    alert('Error: ' + error.message);
  } finally {
    const btn = document.getElementById('btnSaveGroup');
    if (btn) { 
      btn.disabled = false; 
      btn.innerHTML = '💾 Save & Generate'; 
    }
  }
}







function navigateToHome() {
  console.log('🏠 Navigating to Home');
  
  currentPage = 'home';
  
  const mainApp = document.getElementById('mainApp');
  const allProductsPage = document.getElementById('allProductsPage');
  const productGroupsPage = document.getElementById('productGroupsPage');
  const customersPage = document.getElementById('customersPage');
  const groupDetailPage = document.getElementById('groupDetailPage');
  const brandsPage = document.getElementById('brandsPage');
  const sizesPage = document.getElementById('sizesPage');
  const categoriesPage = document.getElementById('categoriesPage');
  const unitTypesPage = document.getElementById('unitTypesPage');
  const vendorsPage = document.getElementById('vendorsPage'); 
  const invoiceCustomersPage = document.getElementById('invoiceCustomersPage');
  const settingsPage = document.getElementById('settingsPage'); // ✅ ADD THIS
  
  // Show main app
  if (mainApp) mainApp.style.display = 'block';
  
  // Hide all other pages
  if (allProductsPage) {
    allProductsPage.classList.remove('active');
    allProductsPage.style.display = 'none';
  }
  if (productGroupsPage) {
    productGroupsPage.classList.remove('active');
    productGroupsPage.style.display = 'none';
  }
  if (customersPage) {
    customersPage.classList.remove('active');
    customersPage.style.display = 'none';
  }
  if (brandsPage) {
    brandsPage.classList.remove('active');
    brandsPage.style.display = 'none';
  }
  if (sizesPage) {
    sizesPage.classList.remove('active');
    sizesPage.style.display = 'none';
  }
  if (categoriesPage) {
    categoriesPage.classList.remove('active');
    categoriesPage.style.display = 'none';
  }
  if (unitTypesPage) {
    unitTypesPage.classList.remove('active');
    unitTypesPage.style.display = 'none';
  }
  if (vendorsPage) {
    vendorsPage.classList.remove('active');
    vendorsPage.style.display = 'none';
  }
  if (invoiceCustomersPage) {
    invoiceCustomersPage.classList.remove('active');
    invoiceCustomersPage.style.display = 'none';
  }
  // ✅ ADD THIS
  if (settingsPage) {
    settingsPage.classList.remove('active');
    settingsPage.style.display = 'none';
  }
  if (groupDetailPage) {
    groupDetailPage.classList.remove('active');
    groupDetailPage.style.display = 'none';
  }
  
  // Show navbar
  const mainNavbar = document.getElementById('mainAppNavbar');
  if (mainNavbar) {
    mainNavbar.style.display = 'flex';
  }
  
  const stickyNavbar = document.querySelector('.navbar.sticky-top');
  if (stickyNavbar) {
    stickyNavbar.style.display = 'flex';
  }
  
  window.scrollTo({ top: 0, behavior: 'smooth' });
  
  // Auto-load sales and purchases
  console.log('🔄 Loading sales and purchases...');
  
  if (typeof loadRecentSales === 'function') {
    loadRecentSales().catch(err => {
      console.error('❌ Failed to load sales:', err.message);
    });
  }
  
  if (typeof loadRecentPurchases === 'function') {
    loadRecentPurchases().catch(err => {
      console.error('❌ Failed to load purchases:', err.message);
    });
  }
  
  console.log('✅ Home displayed');
}


// Make it global
window.navigateToHome = navigateToHome;

/**
 * ==========================================
 * CENTRALIZED NAVIGATION FUNCTION - UPDATED
 * ==========================================
 */
 function navigateTo(page) {
  console.log('🔷 navigateTo called with:', page);
  
  if (page === 'dashboard') {
    navigateToHome();
  } 
  else if (page === 'allProducts') {
    navigateToAllProducts();
  } 
  else if (page === 'customers') {
    navigateToCustomers();
  } 
  else if (page === 'productGroups') {
    navigateToProductGroups();
  } 
  else if (page === 'brands') {
    navigateToBrands();
  } 
  else if (page === 'sizes') {
    navigateToSizes();
  } 
  else if (page === 'categories') {
    navigateToCategories();
  } 
  else if (page === 'unitTypes') {
    navigateToUnitTypes();
  } 
  else if (page === 'vendor') {
    navigateToVendors();
  } 
  else if (page === 'invoiceCustomer' || page === 'invoiceCustomers') {
    navigateToInvoiceCustomers();
  } 
  else if (page === 'sales') {
    navigateToSales();
  } 
  else if (page === 'purchases') {
    navigateToPurchases();
  } 
  else if (page === 'invoices') {
    window.location.href = 'invoices.html';
  }
  else if (page === 'settings') {
    // ✅ Navigate to settings page (not modal)
    navigateToSettings();
  }
  else {
    console.error('❌ Unknown page:', page);
  }
}

// Make global
window.navigateTo = navigateTo;



/**
 * ==========================================
 * NAVIGATE TO SALES - NEW FUNCTION
 * ==========================================
 */
function navigateToSales() {
  console.log('🛒 Navigating to Sales');
  
  // Your existing code to show sales page
  // (If you don't have a separate sales page, this might go to homepage)
  
  // ✅ AUTO-LOAD SALES
  if (typeof loadRecentSales === 'function') {
    loadRecentSales().catch(err => {
      console.error('❌ Failed to load sales:', err.message);
    });
  }
  
  console.log('✅ Sales page displayed');
}

/**
 * ==========================================
 * NAVIGATE TO PURCHASES - NEW FUNCTION
 * ==========================================
 */
function navigateToPurchases() {
  console.log('📦 Navigating to Purchases');
  
  // Your existing code to show purchases page
  // (If you don't have a separate purchases page, this might go to homepage)
  
  // ✅ AUTO-LOAD PURCHASES
  if (typeof loadRecentPurchases === 'function') {
    loadRecentPurchases().catch(err => {
      console.error('❌ Failed to load purchases:', err.message);
    });
  }
  
  console.log('✅ Purchases page displayed');
}



// Navigate to Group Detail - FIXED
function navigateToGroupDetail(groupId, groupName) {
  console.log('📦 Navigating to Group Detail:', groupName);
  
  currentPage = 'groupDetail';
  currentGroupId = groupId;
  
  const mainApp = document.getElementById('mainApp');
  const allProductsPage = document.getElementById('allProductsPage');
  const productGroupsPage = document.getElementById('productGroupsPage');
  const groupDetailPage = document.getElementById('groupDetailPage');
  
  // HIDE the main dashboard
  if (mainApp) {
    mainApp.style.display = 'none';
  }
  
  // ✅ HIDE THE BLUE NAVBAR
  const navbar = document.querySelector('.navbar');
  if (navbar) {
    navbar.style.display = 'none';
  }
  
  // SHOW Group Detail page
  if (groupDetailPage) {
    groupDetailPage.classList.add('active');
  }
  
  if (allProductsPage) allProductsPage.classList.remove('active');
  if (productGroupsPage) productGroupsPage.classList.remove('active');
  
  // Set group title
  const groupTitleEl = document.getElementById('groupDetailTitle');
  if (groupTitleEl) {
    groupTitleEl.textContent = groupName;
  }
  
  // Load variants
  if (typeof syncGroupVariants === 'function') {
    syncGroupVariants(groupId);
  }
  
  window.scrollTo({ top: 0, behavior: 'smooth' });
}





// Get product icon based on category
function getProductIcon(category) {
  const icons = {
    'Tiles': '🔲',
    'Sanitaryware': '🚿',
    'Accessories': '🔧',
    'Custom': '📦',
    'Photo Products': '📸'
  };
  return icons[category] || '📦';
}





window.addEventListener('DOMContentLoaded', () => {
  // Wait longer for data to fully load
  setTimeout(() => {
    const urlParams = new URLSearchParams(window.location.search);
    const page = urlParams.get('page');
    
    if (!page) {
      console.log('✅ No page parameter - Normal page load');
      return;
    }
    
    console.log('🔍 URL page parameter detected:', page);
    
    // Route to appropriate page based on parameter
    switch(page) {
      case 'allProducts':
        console.log('📍 Routing: Invoices → All Products');
        if (typeof navigateToAllProducts === 'function') {
          navigateToAllProducts();
        } else {
          console.error('❌ navigateToAllProducts function not found');
        }
        break;
        
      case 'productGroups':
        console.log('📍 Routing: Invoices → Product Groups');
        if (typeof navigateToProductGroups === 'function') {
          navigateToProductGroups();
        } else {
          console.error('❌ navigateToProductGroups function not found');
        }
        break;
        
      case 'customers':
        console.log('📍 Routing: Invoices → Customers');
        if (typeof navigateToCustomers === 'function') {
          navigateToCustomers();
        } else {
          console.error('❌ navigateToCustomers function not found');
        }
        break;
      
      case 'brands':
        console.log('📍 Routing: Invoices → Brands');
        if (typeof navigateToBrands === 'function') {
          navigateToBrands();
        } else {
          console.error('❌ navigateToBrands function not found');
        }
        break;
        
      default:
        console.warn('⚠️ Unknown page parameter:', page);
    }
    
    // === ✅ CLEAN URL AFTER NAVIGATION ===
    // Remove the query parameter so it doesn't persist on reload
    window.history.replaceState({}, document.title, window.location.pathname);
    console.log('🧹 URL cleaned - page parameter removed');
    
  }, 800);  // Wait 800ms for data to fully load
});

// Navigate to Purchase Orders page
function navigateToPurchaseOrders() {
  // Close sidebar
  closeSidebar();
  
  // Redirect to purchase page
  window.location.href = 'purchase.html';
}



/**
 * ==========================================
 * SHARE INVOICE DROPDOWN FIX
 * ==========================================
 */

document.addEventListener('DOMContentLoaded', function() {
  console.log('🚀 Initializing Share Invoice dropdown...');
  
  // Find all share invoice buttons
  const shareButtons = document.querySelectorAll('[data-bs-toggle="dropdown"]');
  console.log('📊 Found', shareButtons.length, 'dropdown buttons');
  
  shareButtons.forEach((btn, index) => {
    // Add click handler to each button
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      console.log('🔘 Share button clicked');
      
      // Find the next dropdown menu
      let menu = this.nextElementSibling;
      
      // If next sibling isn't a dropdown, search for it
      if (!menu || !menu.classList.contains('dropdown-menu')) {
        menu = this.parentElement.querySelector('.dropdown-menu');
      }
      
      if (menu) {
        // Toggle the dropdown
        menu.classList.toggle('show');
        console.log('✅ Dropdown toggled:', menu.classList.contains('show'));
        
        // Force styles
        if (menu.classList.contains('show')) {
          menu.style.display = 'block';
          menu.style.visibility = 'visible';
          menu.style.opacity = '1';
        } else {
          menu.style.display = 'none';
        }
      } else {
        console.warn('⚠️ Dropdown menu not found');
      }
    });
  });
  
  // Close dropdowns when clicking outside
  document.addEventListener('click', function(e) {
    const menus = document.querySelectorAll('.dropdown-menu.show');
    menus.forEach(menu => {
      const btn = menu.previousElementSibling;
      if (btn && !btn.contains(e.target) && !menu.contains(e.target)) {
        menu.classList.remove('show');
        menu.style.display = 'none';
        console.log('✅ Dropdown closed');
      }
    });
  });
  
  console.log('✅ Share Invoice dropdown initialized');
});

    


/**
 * ==========================================
 * AUTO-LOAD SALES & PURCHASES ON PAGE LOAD
 * ==========================================
 */

// Simple auto-load that works with your existing auth system
window.addEventListener('load', function() {
  console.log('🔄 Page loaded, initializing sales & purchases...');
  
  // Wait for user to be authenticated (check every 500ms)
  const checkAndLoadInterval = setInterval(() => {
    const user = window.auth?.currentUser;
    
    if (user) {
      console.log('✅ User authenticated:', user.email);
      clearInterval(checkAndLoadInterval);
      
      // Load sales and purchases after a short delay
      setTimeout(() => {
        console.log('📦 Auto-loading sales and purchases...');
        
        // Load purchases
        if (typeof loadRecentPurchases === 'function') {
          loadRecentPurchases().catch(err => {
            console.error('❌ Failed to load purchases:', err.message);
          });
        }
        
        // Load sales
        if (typeof loadRecentSales === 'function') {
          loadRecentSales().catch(err => {
            console.error('❌ Failed to load sales:', err.message);
          });
        }
        
        console.log('✅ Auto-load initiated');
      }, 1000);
    }
  }, 500);
  
  // Stop checking after 15 seconds
  setTimeout(() => {
    clearInterval(checkAndLoadInterval);
    console.log('⏱️ Stopped checking for authentication');
  }, 15000);
});

/**
 * ==========================================
 * LOAD RECENT SALES FROM FIRESTORE
 * ==========================================
 */
async function loadRecentSales() {
  console.log('🛒 Loading recent sales from Firestore...');
  
  const user = window.auth?.currentUser;
  if (!user) {
    console.error('❌ User not authenticated');
    return;
  }
  
  const tbody = document.getElementById('salesList');
  
  if (!tbody) {
    console.error('❌ Sales table not found');
    return;
  }
  
  tbody.innerHTML = `
    <tr>
      <td colspan="5" style="text-align: center; padding: 20px;">
        <span class="spinner-border spinner-border-sm"></span> Loading sales...
      </td>
    </tr>
  `;
  
  try {
    const { collection, getDocs } = window.firebaseImports;
    
    // ✅ REMOVE orderBy - just get all sales
    const salesRef = collection(window.db, 'tenants', user.uid, 'sales');
    const snapshot = await getDocs(salesRef);
    
    console.log(`✅ Got ${snapshot.size} sales from Firestore`);
    
    const sales = [];
    snapshot.forEach((doc) => {
      sales.push({
        id: doc.id,
        ...doc.data()
      });
    });
    
    // Sort by date in JavaScript (more flexible)
    sales.sort((a, b) => {
      const dateA = a.date ? new Date(a.date).getTime() : 0;
      const dateB = b.date ? new Date(b.date).getTime() : 0;
      return dateB - dateA; // Newest first
    });
    
    console.log('✅ Sales loaded and sorted:', sales.length);
    
    displayRecentSales(sales);
    window.cachedSales = sales;
    
  } catch (error) {
    console.error('❌ Error loading sales:', error);
    tbody.innerHTML = `
      <tr>
        <td colspan="5" style="text-align: center; padding: 20px; color: #dc3545;">
          <i class="bi bi-exclamation-triangle"></i> Failed to load sales<br>
          <small>${error.message}</small>
        </td>
      </tr>
    `;
  }
}
/**
 * Display sales in Recent Sales table - COMPACT DATE FORMAT
 */
 function displayRecentSales(sales) {
  const tbody = document.getElementById('salesList');
  
  if (!tbody) {
    console.error('❌ Sales table not found');
    return;
  }
  
  if (!sales || sales.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="5" style="text-align: center; padding: 20px; color: #999;">
          <i class="bi bi-inbox"></i> No sales recorded yet
        </td>
      </tr>
    `;
    return;
  }
  
  let html = '';
  
  sales.forEach((sale) => {
    // ✅ COMPACT DATE FORMAT
    let dateStr = '-';
    if (sale.date) {
      try {
        const date = new Date(sale.date);
        if (!isNaN(date.getTime())) {
          // Format: "8-Dec 1:07PM" - Compact, no year, no padding
          const day = date.getDate();
          const month = date.toLocaleString('en-IN', { month: 'short' });
          const hours = date.getHours();
          const minutes = date.getMinutes().toString().padStart(2, '0');
          const ampm = hours >= 12 ? 'PM' : 'AM';
          const hour12 = hours % 12 || 12;
          
          dateStr = `${day}-${month}<br><small>${hour12}:${minutes}${ampm}</small>`;
        }
      } catch (e) {
        console.error('Invalid date:', sale.date);
      }
    } else if (sale.createdAt) {
      try {
        const date = new Date(sale.createdAt);
        if (!isNaN(date.getTime())) {
          const day = date.getDate();
          const month = date.toLocaleString('en-IN', { month: 'short' });
          const hours = date.getHours();
          const minutes = date.getMinutes().toString().padStart(2, '0');
          const ampm = hours >= 12 ? 'PM' : 'AM';
          const hour12 = hours % 12 || 12;
          
          dateStr = `${day}-${month}<br><small>${hour12}:${minutes}${ampm}</small>`;
        }
      } catch (e) {
        console.error('Invalid createdAt:', sale.createdAt);
      }
    }
    
    // ✅ Extract product info from multiple possible structures
    let productsStr = '-';
    let totalQty = 0;
    let unit = 'pcs';
    
    if (sale.products && Array.isArray(sale.products) && sale.products.length > 0) {
      const productNames = sale.products
        .map(p => {
          const name = p.name || p.product || p.productName || 'Unknown';
          const qty = p.quantity || p.qty || 0;
          totalQty += Number(qty);
          
          if (p.unitType || p.unit) {
            unit = p.unitType || p.unit;
          }
          
          return name;
        })
        .filter(n => n && n !== 'Unknown');
      
      if (productNames.length > 2) {
        productsStr = productNames.slice(0, 2).join(', ') + `... (+${productNames.length - 2} more)`;
      } else if (productNames.length > 0) {
        productsStr = productNames.join(', ');
      }
    } else if (sale.productName) {
      productsStr = sale.productName;
      totalQty = sale.quantity || 0;
      unit = sale.unitType || 'pcs';
    } else if (typeof sale.products === 'string') {
      productsStr = sale.products;
      totalQty = sale.quantity || 0;
    }
    
    const amount = sale.totalAmount || sale.grandTotal || sale.amount || 0;
    
    html += `
      <tr onclick="viewSaleDetail('${sale.id}')" style="cursor: pointer; transition: background 0.2s;">
        <td style="white-space: nowrap; font-size: 0.85rem; line-height: 1.3;">${dateStr}</td>
        <td style="max-width: 150px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 0.85rem;" 
            title="${escapeHtml(productsStr)}">
          ${escapeHtml(productsStr)}
        </td>
        <td style="text-align: center; font-size: 0.85rem;">${totalQty}</td>
        <td style="font-size: 0.85rem;">${unit}</td>
        <td style="font-weight: 600; color: #28a745; font-size: 0.85rem;">₹${Number(amount).toFixed(2)}</td>
      </tr>
    `;
  });
  
  tbody.innerHTML = html;
  
  console.log('✅ Displayed', sales.length, 'sales in Recent Sales table');
}

/**
 * ==========================================
 * VIEW SALE DETAIL - FIXED FOR BOTH STRUCTURES
 * ==========================================
 */
function viewSaleDetail(saleId) {
  console.log('📄 Viewing sale detail:', saleId);
  
  const sale = window.cachedSales?.find(s => s.id === saleId);
  
  if (!sale) {
    alert('❌ Sale not found');
    return;
  }
  
  console.log('📊 Sale data:', sale); // Debug log
  
  // ✅ Extract products from different possible structures
  let products = [];
  
  if (Array.isArray(sale.products) && sale.products.length > 0) {
    // Structure 1: Array of products
    products = sale.products;
  } else if (sale.productName) {
    // Structure 2: Single product fields (productName, quantity, etc.)
    products = [{
      name: sale.productName,
      product: sale.productName,
      quantity: sale.quantity,
      qty: sale.quantity,
      unitType: sale.unitType,
      unit: sale.unitType,
      price: sale.unitPrice || (sale.totalAmount / (sale.quantity || 1)),
      unitPrice: sale.unitPrice
    }];
  } else if (typeof sale.products === 'string') {
    // Structure 3: Products as string
    products = [{
      name: sale.products,
      product: sale.products,
      quantity: sale.quantity || 1,
      qty: sale.quantity || 1,
      unitType: sale.unitType || 'pcs',
      unit: sale.unitType || 'pcs',
      price: sale.totalAmount || 0,
      unitPrice: sale.unitPrice || 0
    }];
  }
  
  console.log('📦 Extracted products:', products);
  
  // ✅ Get total amount
  const totalAmount = sale.totalAmount || sale.grandTotal || sale.amount || 0;
  
  // Build detail HTML
  let html = `
    <div style="padding: 15px;">
      <div class="card mb-3">
        <div class="card-header bg-primary text-white">
          <strong>Sale Information</strong>
        </div>
        <div class="card-body">
          <div class="row mb-2">
            <div class="col-6"><strong>Date:</strong></div>
            <div class="col-6">${new Date(sale.date || sale.createdAt).toLocaleString('en-IN')}</div>
          </div>
          <div class="row mb-2">
            <div class="col-6"><strong>Total Amount:</strong></div>
            <div class="col-6" style="font-size: 1.3rem; color: #28a745; font-weight: 700;">
              ₹${Number(totalAmount).toFixed(2)}
            </div>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header bg-primary text-white">
          <strong>Products</strong>
        </div>
        <div class="card-body">
  `;
  
  if (products.length > 0) {
    html += `
          <table class="table table-sm table-bordered">
            <thead class="table-light">
              <tr>
                <th>Product</th>
                <th>Qty</th>
                <th>Unit</th>
                <th>Price</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody>
    `;
    
    products.forEach(p => {
      const qty = Number(p.quantity || p.qty || 1);
      const price = Number(p.unitPrice || p.price || 0);
      const total = qty * price;
      const productName = p.name || p.product || p.productName || 'Unknown Product';
      const unit = p.unitType || p.unit || 'pcs';
      
      html += `
        <tr>
          <td>${escapeHtml(productName)}</td>
          <td>${qty}</td>
          <td>${unit}</td>
          <td>₹${price.toFixed(2)}</td>
          <td style="font-weight: 600;">₹${total.toFixed(2)}</td>
        </tr>
      `;
    });
    
    html += `
            </tbody>
          </table>
    `;
  } else {
    html += `
          <p class="text-muted text-center mb-0">No product details available</p>
    `;
  }
  
  html += `
        </div>
      </div>
      
      <div class="text-center mt-3">
        <button class="btn btn-danger" onclick="confirmDeleteSale('${sale.id}')">
          <i class="bi bi-trash"></i> Delete Sale
        </button>
      </div>
    </div>
  `;
  
  // Create or update modal
  let modal = document.getElementById('saleDetailModal');
  if (!modal) {
    modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'saleDetailModal';
    modal.innerHTML = `
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">
              <i class="bi bi-receipt"></i> Sale Details
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="saleDetailContent"></div>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }
  
  document.getElementById('saleDetailContent').innerHTML = html;
  
  const bsModal = new bootstrap.Modal(modal);
  bsModal.show();
}

/**
 * Confirm delete sale
 */
async function confirmDeleteSale(saleId) {
  if (!confirm('Are you sure you want to delete this sale? This cannot be undone.')) {
    return;
  }
  
  const user = window.auth?.currentUser;
  if (!user) {
    alert('Please sign in first');
    return;
  }
  
  try {
    const { doc, deleteDoc } = window.firebaseImports;
    
    const saleDoc = doc(window.db, 'tenants', user.uid, 'sales', saleId);
    await deleteDoc(saleDoc);
    
    alert('✅ Sale deleted successfully!');
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('saleDetailModal'));
    if (modal) modal.hide();
    
    // Reload sales list
    await loadRecentSales();
    
  } catch (error) {
    console.error('❌ Error deleting sale:', error);
    alert('❌ Failed to delete sale: ' + error.message);
  }
}

 /**
 * ==========================================
 * OPTIONS DROPDOWN - DESKTOP & MOBILE
 * ==========================================
 */

/**
 * Toggle Options Dropdown (Desktop and Mobile)
 */
function toggleOptionsDropdown(event) {
  // Prevent event bubbling
  if (event) {
    event.stopPropagation();
  }
  
  // Detect if mobile or desktop based on which button was clicked
  const isMobile = event && event.target.closest('#optionsButtonContainerMobile');
  
  // Get the correct elements based on device
  const dropdown = document.getElementById(isMobile ? 'optionsDropdownMobile' : 'optionsDropdown');
  const arrow = document.getElementById(isMobile ? 'optionsArrowMobile' : 'optionsArrow');
  
  if (dropdown && arrow) {
    if (dropdown.style.display === 'none' || dropdown.style.display === '') {
      // Open dropdown
      dropdown.style.display = 'block';
      arrow.classList.remove('bi-chevron-down');
      arrow.classList.add('bi-chevron-up');
    } else {
      // Close dropdown
      dropdown.style.display = 'none';
      arrow.classList.remove('bi-chevron-up');
      arrow.classList.add('bi-chevron-down');
    }
  }
}

/**
 * Close Options Dropdown (Desktop and Mobile)
 */
function closeOptionsDropdown() {
  // Close desktop dropdown
  const dropdownDesktop = document.getElementById('optionsDropdown');
  const arrowDesktop = document.getElementById('optionsArrow');
  
  if (dropdownDesktop && arrowDesktop) {
    dropdownDesktop.style.display = 'none';
    arrowDesktop.classList.remove('bi-chevron-up');
    arrowDesktop.classList.add('bi-chevron-down');
  }
  
  // Close mobile dropdown
  const dropdownMobile = document.getElementById('optionsDropdownMobile');
  const arrowMobile = document.getElementById('optionsArrowMobile');
  
  if (dropdownMobile && arrowMobile) {
    dropdownMobile.style.display = 'none';
    arrowMobile.classList.remove('bi-chevron-up');
    arrowMobile.classList.add('bi-chevron-down');
  }
}

/**
 * Close dropdown when clicking outside
 */
document.addEventListener('click', function(event) {
  const dropdownDesktop = document.getElementById('optionsDropdown');
  const containerDesktop = document.getElementById('optionsButtonContainer');
  
  const dropdownMobile = document.getElementById('optionsDropdownMobile');
  const containerMobile = document.getElementById('optionsButtonContainerMobile');
  
  // Check desktop dropdown
  if (dropdownDesktop && containerDesktop) {
    if (!containerDesktop.contains(event.target)) {
      dropdownDesktop.style.display = 'none';
      const arrowDesktop = document.getElementById('optionsArrow');
      if (arrowDesktop) {
        arrowDesktop.classList.remove('bi-chevron-up');
        arrowDesktop.classList.add('bi-chevron-down');
      }
    }
  }
  
  // Check mobile dropdown
  if (dropdownMobile && containerMobile) {
    if (!containerMobile.contains(event.target)) {
      dropdownMobile.style.display = 'none';
      const arrowMobile = document.getElementById('optionsArrowMobile');
      if (arrowMobile) {
        arrowMobile.classList.remove('bi-chevron-up');
        arrowMobile.classList.add('bi-chevron-down');
      }
    }
  }
});

// Make functions global (for inline onclick handlers)
window.toggleOptionsDropdown = toggleOptionsDropdown;
window.closeOptionsDropdown = closeOptionsDropdown;

console.log('✅ Options Dropdown Module Loaded (Desktop + Mobile)');


/**
 * ==========================================
 * INSTANT PRODUCTS MODULE - WITH STOCK ENTRY MODE
 * ==========================================
 */

// Temporary array to hold products before saving
let pendingInstantProducts = [];

// Stock entry mode tracking
let instantProductMode = 'product'; // 'product' or 'stock'
let selectedProductIndex = -1; // Currently selected product for stock entry


/**
 * Add focus/blur handlers to input for keyboard detection
 */
function setupInputKeyboardHandlers() {
  const input = document.getElementById('instantProductInput');
  
  if (input) {
    input.addEventListener('focus', () => {
      console.log('📱 Input focused');
      
      // ✅ Scroll preview for BOTH product and stock modes
      setTimeout(() => {
        scrollPreviewIntoView();
        if (instantProductMode === 'stock') {
          scrollToSelectedProduct();
        }
      }, 400); // Wait for keyboard animation
    });
    
    input.addEventListener('blur', () => {
      console.log('📱 Input blurred');
    });
  }
}


/**
 * Call this when modal opens
 */
function openInstantProductsModal() {
  console.log('⚡ Opening Instant Products modal');
  
  resetInstantProductsModal();
  
  const modal = new bootstrap.Modal(document.getElementById('instantProductsModal'));
  modal.show();
  
  // ✅ Setup keyboard handlers
  setTimeout(() => {
    setupInputKeyboardHandlers();
    document.getElementById('instantProductInput').focus();
  }, 200);
}


/**
 * ✅ CANCEL BUTTON - RESET TRANSFORM TOO
 */
 function cancelInstantProducts() {
  console.log('❌ Cancel clicked - closing and resetting modal');
  
  // Reset modal transform
  const modalDialog = document.querySelector('#instantProductsModal .modal-dialog');
  if (modalDialog) {
    modalDialog.style.transform = '';
  }
  
  // Close modal
  const modal = bootstrap.Modal.getInstance(document.getElementById('instantProductsModal'));
  if (modal) {
    modal.hide();
  }
  
  // Reset modal data
  resetInstantProductsModal();
}

/**
 * ✅ UNIVERSAL KEYBOARD SCROLL FIX - ENHANCED UPWARD SCROLL
 */
 function setupSimpleKeyboardScroll() {
  const input = document.getElementById('instantProductInput');
  
  if (!input) return;
  
  // When input gets focus in ANY mode
  input.addEventListener('focus', () => {
    console.log('🔍 Input focused, will scroll preview upward');
    
    // Wait for mobile keyboard to fully open (300-500ms)
    setTimeout(() => {
      const previewList = document.getElementById('instantProductPreviewList');
      const modalBody = document.querySelector('#instantProductsModal .modal-body');
      const modalDialog = document.querySelector('#instantProductsModal .modal-dialog');
      
      if (previewList && modalBody) {
        // ✅ Scroll preview to top of visible area
        previewList.scrollIntoView({ 
          behavior: 'smooth',
          block: 'start' // Start = top of viewport
        });
        
        // ✅ Additional adjustment after scroll
        setTimeout(() => {
          const previewRect = previewList.getBoundingClientRect();
          const keyboardHeight = window.innerHeight - window.visualViewport?.height || 300;
          
          // If preview is hidden by keyboard or too low
          if (previewRect.bottom > window.innerHeight - keyboardHeight - 50) {
            // Scroll modal dialog up
            if (modalDialog) {
              modalDialog.style.transform = 'translateY(-60px)';
              modalDialog.style.transition = 'transform 0.3s ease';
            }
            
            // Also scroll modal body
            modalBody.scrollBy({
              top: -100, // Scroll up 100px
              behavior: 'smooth'
            });
            
            console.log('✅ Applied additional upward scroll for keyboard');
          }
        }, 150);
        
        console.log('✅ Scrolled preview into view for keyboard');
      }
    }, 400);
  });
  
  // Reset transform when input loses focus
  input.addEventListener('blur', () => {
    setTimeout(() => {
      const modalDialog = document.querySelector('#instantProductsModal .modal-dialog');
      if (modalDialog) {
        modalDialog.style.transform = '';
      }
    }, 300);
  });
}


/**
 * Scroll preview area into view - ENHANCED FOR BETTER VISIBILITY
 */
 function scrollPreviewIntoView() {
  const previewContainer = document.getElementById('instantProductPreviewList');
  const modalBody = document.querySelector('#instantProductsModal .modal-body');
  
  if (previewContainer && modalBody) {
    // ✅ Scroll more aggressively to show preview prominently
    previewContainer.scrollIntoView({ 
      behavior: 'smooth', 
      block: 'start', // Changed from 'nearest' to 'start' for more upward scroll
      inline: 'nearest'
    });
    
    // ✅ Additional scroll adjustment for better visibility
    setTimeout(() => {
      const previewRect = previewContainer.getBoundingClientRect();
      const viewportHeight = window.innerHeight;
      
      // If preview is too low, scroll modal body up more
      if (previewRect.top > viewportHeight * 0.3) {
        modalBody.scrollBy({
          top: -80, // Scroll up an additional 80px
          behavior: 'smooth'
        });
      }
    }, 100);
    
    console.log('📜 Scrolled preview into view (enhanced)');
  }
}



/**
 * ✅ FORCE NUMERIC KEYBOARD OPEN (iOS/Android)
 */
function forceNumericKeyboardOpen() {
  const input = document.getElementById('instantProductInput');
  
  if (instantProductMode === 'stock' && input) {
    // Create a touch event to simulate user interaction
    const touchEvent = new TouchEvent('touchstart', {
      bubbles: true,
      cancelable: true,
      view: window
    });
    
    input.dispatchEvent(touchEvent);
    input.focus();
    input.click();
    
    console.log('📱 Forced numeric keyboard open via touch event');
  }
}


/**
 * Select next product without stock - WITH SKIP PRIORITY
 */
function selectNextProductWithoutStock() {
  // ✅ PHASE 1: Find non-skipped products without stock
  for (let i = 0; i < pendingInstantProducts.length; i++) {
    const product = pendingInstantProducts[i];
    const hasStock = product.stock !== undefined && product.stock !== null;
    const isSkipped = product.skipped === true;
    
    if (!hasStock && !isSkipped) {
      selectedProductIndex = i;
      console.log('✅ Selected non-skipped product:', i);
      updateInstantProductPreview();
      
      setTimeout(() => {
        scrollToSelectedProduct();
        focusInput();
      }, 100);
      
      return;
    }
  }
  
  // ✅ PHASE 2: All non-skipped products have stock, now go to skipped ones
  console.log('📋 All non-skipped products done, checking skipped products...');
  
  for (let i = 0; i < pendingInstantProducts.length; i++) {
    const product = pendingInstantProducts[i];
    const hasStock = product.stock !== undefined && product.stock !== null;
    const isSkipped = product.skipped === true;
    
    if (!hasStock && isSkipped) {
      selectedProductIndex = i;
      console.log('✅ Selected skipped product:', i);
      updateInstantProductPreview();
      
      setTimeout(() => {
        scrollToSelectedProduct();
        focusInput();
      }, 100);
      
      return;
    }
  }
  
  // ✅ All products have stock
  selectedProductIndex = -1;
  console.log('✅ All products have stock assigned');
}


/**
 * Select specific product - WITH VALIDATION
 */
function selectProduct(index) {
  if (instantProductMode !== 'stock') return;
  
  selectedProductIndex = index;
  console.log('🎯 Manually selected product:', index);
  
  // ✅ If user clicks on a skipped product, they can enter stock
  // The skipped flag will be cleared when stock is entered
  
  updateInstantProductPreview();
  
  setTimeout(() => {
    scrollToSelectedProduct();
    focusInput();
  }, 100);
}


/**
 * Skip current product - KEEP KEYBOARD OPEN
 */
function skipCurrentProduct() {
  if (selectedProductIndex === -1) return;
  
  console.log('⏭️ Skipping product:', selectedProductIndex);
  
  // ✅ Mark product as skipped
  pendingInstantProducts[selectedProductIndex].skipped = true;
  
  // ✅ Find next product to select
  selectNextProductWithoutStock();
  
  updateInstantProductPreview();
  
  // ✅ Keep keyboard open
  const input = document.getElementById('instantProductInput');
  setTimeout(() => {
    scrollToSelectedProduct();
    input.focus();
  }, 100);
}

/**
 * Handle "Add to List" button click - AUTO-SKIP ON EMPTY
 */
 function handleAddToListClick() {
  const input = document.getElementById('instantProductInput');
  const value = input.value.trim();
  
  if (instantProductMode === 'product') {
    // Add product name
    if (!value || value.length === 0) {
      alert('⚠️ Please enter a product name');
      input.focus();
      return;
    }
    
    const productName = value.replace(/,\s*$/, '').trim();
    
    if (pendingInstantProducts.find(p => p.name === productName)) {
      alert('⚠️ Product already in list!');
      input.focus();
      return;
    }
    
    pendingInstantProducts.push({ name: productName, stock: null, skipped: false });
    console.log('✅ Added product:', productName);
    
    input.value = '';
    window.lastInstantProductInput = '';
    updateInstantProductPreview();
    
    // Keep keyboard open and scroll preview
    setTimeout(() => {
      const previewList = document.getElementById('instantProductPreviewList');
      if (previewList) {
        previewList.scrollTop = previewList.scrollHeight;
      }
      input.focus();
    }, 50);
    
  } else if (instantProductMode === 'stock') {
    // ✅ STOCK ENTRY MODE - SKIP ON EMPTY
    if (selectedProductIndex === -1) {
      alert('⚠️ No product selected');
      input.focus();
      return;
    }
    
    // ✅ NEW: If empty, skip the product automatically
    if (!value || value.length === 0) {
      console.log('⏭️ Auto-skipping product (empty button click):', selectedProductIndex);
      
      // Mark product as skipped
      pendingInstantProducts[selectedProductIndex].skipped = true;
      
      // Clear input
      input.value = '';
      window.lastInstantProductInput = '';
      
      // Select next product
      selectNextProductWithoutStock();
      updateInstantProductPreview();
      
      // Keep keyboard open
      setTimeout(() => {
        scrollToSelectedProduct();
        input.focus();
      }, 100);
      
      return; // Exit early
    }
    
    // ✅ Value provided - set stock normally
    const stockValue = parseInt(value);
    if (isNaN(stockValue) || stockValue < 0) {
      alert('⚠️ Please enter a valid stock number');
      input.focus();
      return;
    }
    
    // Set stock and clear skipped flag
    pendingInstantProducts[selectedProductIndex].stock = stockValue;
    pendingInstantProducts[selectedProductIndex].skipped = false;
    
    console.log('✅ Set stock:', stockValue, 'for product:', pendingInstantProducts[selectedProductIndex].name);
    
    input.value = '';
    window.lastInstantProductInput = '';
    
    // Select next product without stock
    selectNextProductWithoutStock();
    updateInstantProductPreview();
    
    // Keep keyboard open and focused
    setTimeout(() => {
      scrollToSelectedProduct();
      input.focus();
    }, 100);
  }
}


/**
 * Handle product input (Enter or Comma) - AUTO-SKIP ON EMPTY
 */
 function handleInstantProductInputKeydown(event) {
  const input = document.getElementById('instantProductInput');
  const value = input.value.trim();
  
  if (event.key === 'Enter' || event.key === ',') {
    event.preventDefault();
    
    if (instantProductMode === 'product') {
      // Product name mode
      if (value && value.length > 0) {
        const productName = value.replace(/,\s*$/, '').trim();
        
        if (productName && !pendingInstantProducts.find(p => p.name === productName)) {
          pendingInstantProducts.push({ name: productName, stock: null, skipped: false });
          console.log('✅ Product added:', productName);
          
          input.value = '';
          window.lastInstantProductInput = '';
          updateInstantProductPreview();
          
          setTimeout(() => {
            const previewList = document.getElementById('instantProductPreviewList');
            if (previewList) {
              previewList.scrollTop = previewList.scrollHeight;
            }
            focusInput();
          }, 50);
          
        } else if (pendingInstantProducts.find(p => p.name === productName)) {
          alert('⚠️ This product is already in the list!');
        }
      }
      
    } else if (instantProductMode === 'stock') {
      // ✅ STOCK ENTRY MODE - SKIP ON EMPTY
      if (selectedProductIndex === -1) {
        alert('⚠️ No product selected');
        return;
      }
      
      // ✅ NEW: If empty, skip the product automatically
      if (!value || value.length === 0) {
        console.log('⏭️ Auto-skipping product (empty Enter):', selectedProductIndex);
        
        // Mark product as skipped
        pendingInstantProducts[selectedProductIndex].skipped = true;
        
        // Clear input
        input.value = '';
        window.lastInstantProductInput = '';
        
        // Select next product
        selectNextProductWithoutStock();
        updateInstantProductPreview();
        
        setTimeout(() => {
          scrollToSelectedProduct();
          focusInput();
        }, 100);
        
        return; // Exit early
      }
      
      // ✅ Value provided - set stock normally
      const stockValue = parseInt(value);
      
      if (isNaN(stockValue) || stockValue < 0) {
        alert('⚠️ Please enter a valid stock number');
        return;
      }
      
      // Set stock and clear skipped flag
      pendingInstantProducts[selectedProductIndex].stock = stockValue;
      pendingInstantProducts[selectedProductIndex].skipped = false;
      
      console.log('✅ Set stock:', stockValue, 'for:', pendingInstantProducts[selectedProductIndex].name);
      
      input.value = '';
      window.lastInstantProductInput = '';
      
      // Select next product
      selectNextProductWithoutStock();
      updateInstantProductPreview();
      
      setTimeout(() => {
        scrollToSelectedProduct();
        focusInput();
      }, 100);
    }
  }
}


/**
 * Handle input validation in stock mode
 */
function handleInstantProductInput(event) {
  const input = document.getElementById('instantProductInput');
  
  // ✅ In stock mode, only allow numbers
  if (instantProductMode === 'stock') {
    // Remove any non-numeric characters
    input.value = input.value.replace(/[^0-9]/g, '');
  }
  
  window.lastInstantProductInput = input.value;
}


/**
 * ✅ SCROLL TO SELECTED PRODUCT (SMOOTH ANIMATION)
 */
function scrollToSelectedProduct() {
  if (selectedProductIndex === -1) return;
  
  const selectedElement = document.getElementById(`instant-product-${selectedProductIndex}`);
  const previewList = document.getElementById('instantProductPreviewList');
  
  if (selectedElement && previewList) {
    console.log('📜 Scrolling to product:', selectedProductIndex);
    
    // ✅ Calculate position to center the selected product
    const containerRect = previewList.getBoundingClientRect();
    const elementRect = selectedElement.getBoundingClientRect();
    const relativeTop = elementRect.top - containerRect.top;
    const scrollOffset = relativeTop - (containerRect.height / 2) + (elementRect.height / 2);
    
    // ✅ Smooth scroll
    previewList.scrollTo({
      top: previewList.scrollTop + scrollOffset,
      behavior: 'smooth'
    });
    
    console.log('✅ Scrolled to product');
  }
}


/**
 * ✅ FOCUS INPUT FIELD
 */
function focusInput() {
  const input = document.getElementById('instantProductInput');
  if (input) {
    input.focus();
    console.log('✅ Input focused');
  }
}

/**
 * Update product preview list - WITH TRANSLATION & SKIPPED STATUS
 */
 function updateInstantProductPreview() {
  const lang = window.currentLanguage || 'en';
  const translations = window.translations[lang];
  
  const previewList = document.getElementById('instantProductPreviewList');
  const previewCount = document.getElementById('instantProductPreviewCount');
  
  if (!previewList) return;
  
  // Update count header
  if (previewCount) {
    const productsToSaveText = translations.productsToSave || '📝 Products to Save';
    previewCount.innerHTML = `${productsToSaveText} (<span id="productCount">${pendingInstantProducts.length}</span>):`;
  }
  
  // Empty state
  if (pendingInstantProducts.length === 0) {
    const noProductsText = translations.noProductsAddedYet || 'No products added yet';
    previewList.innerHTML = `
      <div style="padding: 15px; color: #999; text-align: center; font-size: 14px;">
        ${noProductsText}
      </div>
    `;
    return;
  }
  
  // Get translated status texts
  const skippedText = translations.skipped || 'Skipped';
  const enteringText = translations.entering || 'ENTERING';
  
  // Build product list
  let html = '';
  pendingInstantProducts.forEach((product, index) => {
    const isSelected = index === selectedProductIndex && instantProductMode === 'stock';
    const hasStock = product.stock !== null && product.stock !== undefined;
    const isSkipped = product.skipped === true && !hasStock;
    
    const bgColor = isSelected ? '#e7f5e7' : (isSkipped ? '#fff3cd' : 'white');
    const borderColor = isSelected ? '#28a745' : (isSkipped ? '#ffc107' : '#e0e0e0');
    const borderWidth = isSelected ? '3px' : '1px';
    
    html += `
      <div 
        id="instant-product-${index}"
        onclick="${instantProductMode === 'stock' ? `selectProduct(${index})` : ''}"
        style="
          display: flex; justify-content: space-between; align-items: center;
          padding: 12px 12px; border-bottom: 1px solid #e0e0e0;
          background: ${bgColor}; 
          border-left: ${borderWidth} solid ${borderColor};
          transition: all 0.3s ease;
          cursor: ${instantProductMode === 'stock' ? 'pointer' : 'default'};
          ${isSelected ? 'box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);' : ''}
        " 
        ${instantProductMode === 'stock' ? `onmouseover="if(${index} !== ${selectedProductIndex}) this.style.background='${isSkipped ? '#fff9e6' : '#f0f0f0'}'" onmouseout="if(${index} !== ${selectedProductIndex}) this.style.background='${bgColor}'"` : ''}>
        
        <span style="font-size: 14px; color: #333; flex: 1;">
          <strong style="color: ${isSelected ? '#28a745' : (isSkipped ? '#ffc107' : '#666')}; font-size: ${isSelected ? '16px' : '14px'};">${index + 1}.</strong> 
          <span style="margin-left: 8px; font-weight: ${isSelected ? '600' : 'normal'}; font-size: ${isSelected ? '15px' : '14px'};">${escapeHtml(product.name)}</span>
          
          ${hasStock ? `<span style="margin-left: 10px; color: #28a745; font-weight: 600; font-size: 13px; background: #e7f5e7; padding: 2px 8px; border-radius: 4px;">📦 ${product.stock}</span>` : ''}
          
          ${isSkipped ? `<span style="margin-left: 10px; color: #ffc107; font-weight: 600; font-size: 12px; background: #fff3cd; padding: 2px 8px; border-radius: 4px;">⏭️ ${skippedText}</span>` : ''}
          
          ${isSelected ? `<span style="margin-left: 10px; color: #28a745; font-size: 12px; font-weight: 700;">← ${enteringText}</span>` : ''}
        </span>
        
        <button onclick="removePendingInstantProduct(${index}); event.stopPropagation();" style="
          background: #dc3545; color: white; border: none; 
          padding: 5px 10px; border-radius: 5px; cursor: pointer;
          font-size: 12px; font-weight: 600; transition: background 0.2s;
        " onmouseover="this.style.background='#c82333'" onmouseout="this.style.background='#dc3545'">
          <i class="bi bi-x"></i>
        </button>
      </div>
    `;
  });
  
  previewList.innerHTML = html;
}



/**
 * Remove product from pending list
 */
function removePendingInstantProduct(index) {
  pendingInstantProducts.splice(index, 1);
  
  // Adjust selected index
  if (selectedProductIndex === index) {
    selectedProductIndex = -1;
    selectNextProductWithoutStock();
  } else if (selectedProductIndex > index) {
    selectedProductIndex--;
  }
  
  updateInstantProductPreview();
  console.log('🗑️ Removed product at index:', index);
}
/**
 * Save all instant products to Firebase - CLEAN VERSION (NO DEFAULT VALUES)
 */
 async function saveAllInstantProducts() {
  const lang = window.currentLanguage || 'en';
  const translations = window.translations[lang];
  
  if (pendingInstantProducts.length === 0) {
    alert(translations.pleaseAddAtLeastOneProduct || '⚠️ Please add at least one product');
    return;
  }
  
  console.log('💾 Saving', pendingInstantProducts.length, 'instant products...');
  
  // Close modal immediately
  const modal = bootstrap.Modal.getInstance(document.getElementById('instantProductsModal'));
  if (modal) {
    modal.hide();
  }
  
  // Show loading indicator
  showLoading(translations.savingProducts || 'Saving products...');
  
  // ✅ Check authentication
  const user = window.auth?.currentUser;
  if (!user) {
    hideLoading();
    alert(translations.errorNotAuthenticated || '❌ Error: Not authenticated. Please sign in again.');
    console.error('❌ No user signed in');
    return;
  }
  
  // ✅ Get Firebase imports
  const { doc, setDoc, collection } = window.firebaseImports;
  const userId = user.uid;
  
  const productsToSave = [...pendingInstantProducts];
  const savedProducts = [];
  const failedProducts = [];
  
  // Save each product to Firebase
  for (let i = 0; i < productsToSave.length; i++) {
    const productItem = productsToSave[i];
    const productName = productItem.name;
    const stockValue = productItem.stock !== null && productItem.stock !== undefined ? productItem.stock : 0;
    
    try {
      // Generate unique ID
      const productsCollectionRef = collection(window.db, 'tenants', userId, 'products');
      const newProductRef = doc(productsCollectionRef);
      const productId = newProductRef.id;
      
      // ✅ NEW: Create product data WITHOUT default values
      // Only include fields that have actual values
      const productData = {
        id: productId,
        name: productName,
        
        // ✅ EMPTY VALUES - will be hidden in display
        category: '',           // Empty instead of "Uncategorized"
        brand: '',              // Empty instead of "N/A"
        size: '',               // Empty instead of "N/A"
        unitType: '',           // Empty instead of "Piece"
        piecesPerBox: null,     // Null instead of 1
        sftPerBox: null,        // Null instead of 0
        price: null,            // Null instead of 0
        
        // ✅ ACTUAL VALUES
        stock: stockValue,
        minStock: 5,
        imageUrl: '',
        stockStatus: 'exact',
        stockValue: stockValue,
        updatedAt: new Date().toISOString(),
        isGroupVariant: false,
        groupId: '',
        variantId: ''
      };
      
      // Save to Firestore
      const productRef = doc(window.db, 'tenants', userId, 'products', productId);
      await setDoc(productRef, productData);
      
      savedProducts.push(productName);
      console.log(`✅ Saved (${i + 1}/${productsToSave.length}):`, productName, 'with stock:', stockValue);
      
    } catch (error) {
      console.error(`❌ Failed to save (${i + 1}/${productsToSave.length}):`, productName, error);
      failedProducts.push(productName);
    }
  }
  
  // Hide loading
  hideLoading();
  
  // ✅ COMPLETE MODAL RESET
  resetInstantProductsModal();
  
  // Show results
  if (failedProducts.length === 0) {
    const successMsg = translations.productsAddedSuccess || '✅ Success!\n\n{count} product(s) added with stock!';
    alert(successMsg.replace('{count}', savedProducts.length));
  } else {
    const partialMsg = translations.partialSuccess || '⚠️ Partial Success\n\n✅ Saved: {saved}\n❌ Failed: {failed}\n\nFailed products:\n{list}';
    const message = partialMsg
      .replace('{saved}', savedProducts.length)
      .replace('{failed}', failedProducts.length)
      .replace('{list}', failedProducts.join(', '));
    alert(message);
  }
  
  // Refresh product list
  if (typeof loadProducts === 'function') {
    loadProducts();
  }
}


/**
 * ==========================================
 * 🎨 DISPLAY HELPERS - HIDE EMPTY FIELDS
 * ==========================================
 */

/**
 * Check if a field value should be displayed
 */
function shouldDisplayField(value, fieldType = 'text') {
  if (value === null || value === undefined) return false;
  
  const strValue = String(value).trim().toLowerCase();
  if (strValue === '') return false;
  
  const emptyValues = ['n/a', 'na', 'not applicable', 'uncategorized', 'piece', 'pieces', 'none', 'null', 'undefined', '-'];
  if (emptyValues.includes(strValue)) return false;
  
  if (fieldType === 'number') {
    const numValue = parseFloat(value);
    if (isNaN(numValue) || numValue === 0) return false;
  }
  
  if (fieldType === 'price') {
    const numValue = parseFloat(value);
    if (isNaN(numValue) || numValue === 0 || numValue === 0.00) return false;
  }
  
  return true;
}

console.log('✅ Display helper functions loaded');

/**
 * Switch between Product and Stock modes - WITH TRANSLATION
 */
 function switchInstantProductMode(mode) {
  console.log('🔄 Switching to mode:', mode);
  
  const lang = window.currentLanguage || 'en';
  const translations = window.translations[lang];
  
  if (mode === 'stock' && pendingInstantProducts.length === 0) {
    alert(translations.pleaseAddProductsFirst || '⚠️ Please add products first before entering stock');
    return;
  }
  
  instantProductMode = mode;
  
  const input = document.getElementById('instantProductInput');
  const productBtn = document.getElementById('productNameModeBtn');
  const stockBtn = document.getElementById('stockModeBtn');
  const skipBtn = document.getElementById('skipStockBtn');
  const addBtn = document.getElementById('addToListBtn');
  
  if (mode === 'product') {
    // Product name mode
    productBtn.classList.add('active');
    stockBtn.classList.remove('active');
    skipBtn.style.display = 'none';
    addBtn.innerHTML = '<i class="bi bi-plus-lg"></i> ' + (translations.addToList || 'Add to List');
    
    input.blur();
    
    setTimeout(() => {
      input.type = 'text';
      input.removeAttribute('inputmode');
      input.removeAttribute('pattern');
      input.removeAttribute('min');
      input.removeAttribute('step');
      input.placeholder = translations.instantProductPlaceholder || 'e.g., Tilecleaner, Grout, Adhesive...';
      input.value = '';
      
      selectedProductIndex = -1;
      updateInstantProductPreview();
      
      requestAnimationFrame(() => {
        input.focus();
        
        setTimeout(() => {
          performSmartScroll();
          
          setTimeout(() => {
            const modalBody = document.querySelector('#instantProductsModal .modal-body');
            const modalDialog = document.querySelector('#instantProductsModal .modal-dialog');
            
            if (modalBody && modalDialog) {
              modalDialog.style.transform = 'translateY(-60px)';
              modalDialog.style.transition = 'transform 0.3s ease';
              
              modalBody.scrollBy({
                top: -80,
                behavior: 'smooth'
              });
              
              console.log('✅ Applied extra upward scroll for QWERTY');
            }
          }, 200);
        }, 400);
      });
    }, 150);
    
  } else if (mode === 'stock') {
    // ✅ STOCK ENTRY MODE - STANDARD NUMERIC KEYBOARD WITH ENTER KEY
    productBtn.classList.remove('active');
    stockBtn.classList.add('active');
    skipBtn.style.display = 'block';
    addBtn.innerHTML = '<i class="bi bi-check-lg"></i> ' + (translations.setStock || 'Set Stock');
    
    input.blur();
    input.value = '';
    input.readOnly = true;
    
    setTimeout(() => {
      // ✅ CHANGED: Use type="number" only (no inputmode)
      // This shows standard numeric keyboard with Enter key on iPhone
      input.type = 'number';
      input.removeAttribute('inputmode'); // ✅ REMOVED: Don't set inputmode
      input.removeAttribute('pattern');   // ✅ REMOVED: Don't need pattern
      input.setAttribute('min', '0');
      input.setAttribute('step', '1');
      input.placeholder = translations.enterStockQuantity || 'Enter stock quantity...';
      input.readOnly = false;
      
      selectNextProductWithoutStock();
      updateInstantProductPreview();
      
      requestAnimationFrame(() => {
        input.focus();
        
        setTimeout(() => {
          input.click();
          
          setTimeout(() => {
            if (document.activeElement !== input) {
              input.focus();
              input.setSelectionRange(0, 0);
            }
            
            setTimeout(() => {
              performSmartScroll();
              
              setTimeout(() => {
                const modalBody = document.querySelector('#instantProductsModal .modal-body');
                const modalDialog = document.querySelector('#instantProductsModal .modal-dialog');
                
                if (modalBody && modalDialog) {
                  modalDialog.style.transform = 'translateY(-60px)';
                  modalDialog.style.transition = 'transform 0.3s ease';
                  
                  modalBody.scrollBy({
                    top: -80,
                    behavior: 'smooth'
                  });
                }
              }, 200);
            }, 300);
            
            console.log('✅ Numeric keyboard with Enter key should be open');
          }, 100);
        }, 50);
      });
    }, 250);
  }
}

/**
 * ✅ RESET MODAL - WITH TRANSLATION
 */
 function resetInstantProductsModal() {
  console.log('🔄 Resetting Instant Products modal...');
  
  const lang = window.currentLanguage || 'en';
  const translations = window.translations[lang];
  
  // Clear data
  pendingInstantProducts = [];
  instantProductMode = 'product';
  selectedProductIndex = -1;
  window.lastInstantProductInput = '';
  
  // Reset modal transform
  const modalDialog = document.querySelector('#instantProductsModal .modal-dialog');
  if (modalDialog) {
    modalDialog.style.transform = '';
  }
  
  // ✅ Reset input field - REMOVE ALL NUMERIC ATTRIBUTES
  const input = document.getElementById('instantProductInput');
  if (input) {
    input.value = '';
    input.placeholder = translations.instantProductPlaceholder || 'e.g., Tilecleaner, Grout, Adhesive...';
    input.type = 'text';
    input.removeAttribute('inputmode');  // ✅ Clean removal
    input.removeAttribute('pattern');
    input.removeAttribute('min');
    input.removeAttribute('step');
  }
  
  // Reset tabs
  const productBtn = document.getElementById('productNameModeBtn');
  const stockBtn = document.getElementById('stockModeBtn');
  if (productBtn) productBtn.classList.add('active');
  if (stockBtn) stockBtn.classList.remove('active');
  
  // Hide skip button
  const skipBtn = document.getElementById('skipStockBtn');
  if (skipBtn) {
    skipBtn.style.display = 'none';
  }
  
  // Reset button text
  const addBtn = document.getElementById('addToListBtn');
  if (addBtn) {
    addBtn.innerHTML = '<i class="bi bi-plus-lg"></i> ' + (translations.addToList || 'Add to List');
  }
  
  // Update preview to show empty state
  updateInstantProductPreview();
  
  console.log('✅ Instant Products modal reset complete');
}



/**
 * Escape HTML
 */
function escapeHtml(text) {
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return String(text).replace(/[&<>"']/g, m => map[m]);
}


console.log('✅ Instant Products Module Loaded (with Stock Mode)');

    /**
 * Show loading indicator
 */
function showLoading(message = 'Loading...') {
  const loadingDiv = document.createElement('div');
  loadingDiv.id = 'loadingOverlay';
  loadingDiv.style.cssText = `
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); z-index: 9999;
    display: flex; align-items: center; justify-content: center;
  `;
  loadingDiv.innerHTML = `
    <div style="background: white; padding: 30px; border-radius: 10px; text-align: center;">
      <div class="spinner-border text-success" role="status" style="width: 3rem; height: 3rem;">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p style="margin-top: 15px; font-weight: 600; color: #333;">${message}</p>
    </div>
  `;
  document.body.appendChild(loadingDiv);
}

/**
 * Hide loading indicator
 */
function hideLoading() {
  const loadingDiv = document.getElementById('loadingOverlay');
  if (loadingDiv) {
    loadingDiv.remove();
  }
}


/**
 * ==========================================
 * CHANGE PASSWORD MODULE (Firebase Auth)
 * ==========================================
 */

/**
 * Open Change Password Modal
 */
function openChangePasswordModal() {
  console.log('🔑 Opening Change Password modal');
  
  // Reset form
  document.getElementById('currentPasswordInput').value = '';
  document.getElementById('newPasswordInput').value = '';
  document.getElementById('confirmPasswordInput').value = '';
  
  // Show step 1, hide step 2
  document.getElementById('verifyPasswordStep').style.display = 'block';
  document.getElementById('newPasswordStep').style.display = 'none';
  
  // Show modal
  const modal = new bootstrap.Modal(document.getElementById('changePasswordModal'));
  modal.show();
  
  // Focus on current password input
  setTimeout(() => {
    document.getElementById('currentPasswordInput').focus();
  }, 300);
}

/**
 * Step 1: Verify Current Password
 */
async function verifyCurrentPassword() {
  const currentPassword = document.getElementById('currentPasswordInput').value;
  
  if (!currentPassword) {
    alert('⚠️ Please enter your current password');
    return;
  }
  
  // Show loading
  showLoading('Verifying password...');
  
  try {
    const user = window.auth.currentUser;
    
    if (!user || !user.email) {
      hideLoading();
      alert('❌ Error: No user signed in');
      return;
    }
    
    // Get Firebase Auth functions
    const { EmailAuthProvider, reauthenticateWithCredential } = window.firebaseImports;
    
    // Create credential with current email and password
    const credential = EmailAuthProvider.credential(user.email, currentPassword);
    
    // Reauthenticate (this verifies the password)
    await reauthenticateWithCredential(user, credential);
    
    console.log('✅ Current password verified');
    hideLoading();
    
    // Show step 2
    document.getElementById('verifyPasswordStep').style.display = 'none';
    document.getElementById('newPasswordStep').style.display = 'block';
    
    // Focus on new password input
    setTimeout(() => {
      document.getElementById('newPasswordInput').focus();
    }, 100);
    
  } catch (error) {
    console.error('❌ Password verification failed:', error);
    hideLoading();
    
    let errorMessage = 'Incorrect password. Please try again.';
    
    if (error.code === 'auth/wrong-password') {
      errorMessage = '❌ Incorrect password. Please try again.';
    } else if (error.code === 'auth/too-many-requests') {
      errorMessage = '❌ Too many failed attempts. Please try again later.';
    } else if (error.code === 'auth/invalid-credential') {
      errorMessage = '❌ Incorrect password. Please try again.';
    }
    
    alert(errorMessage);
  }
}

/**
 * Step 2: Submit New Password
 */
async function submitNewPassword() {
  const newPassword = document.getElementById('newPasswordInput').value;
  const confirmPassword = document.getElementById('confirmPasswordInput').value;
  
  // Validation
  if (!newPassword || !confirmPassword) {
    alert('⚠️ Please fill in both password fields');
    return;
  }
  
  if (newPassword.length < 6) {
    alert('⚠️ Password must be at least 6 characters long');
    return;
  }
  
  if (newPassword !== confirmPassword) {
    alert('⚠️ Passwords do not match. Please try again.');
    return;
  }
  
  // Show loading
  showLoading('Updating password...');
  
  try {
    const user = window.auth.currentUser;
    
    if (!user) {
      hideLoading();
      alert('❌ Error: No user signed in');
      return;
    }
    
    // Get Firebase Auth function
    const { updatePassword } = window.firebaseImports;
    
    // Update password
    await updatePassword(user, newPassword);
    
    console.log('✅ Password updated successfully');
    hideLoading();
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('changePasswordModal'));
    if (modal) {
      modal.hide();
    }
    
    // Show success message
    alert('✅ Password changed successfully!\n\nYour password has been updated.');
    
  } catch (error) {
    console.error('❌ Password update failed:', error);
    hideLoading();
    
    let errorMessage = 'Failed to update password. Please try again.';
    
    if (error.code === 'auth/weak-password') {
      errorMessage = '❌ Password is too weak. Please use a stronger password.';
    } else if (error.code === 'auth/requires-recent-login') {
      errorMessage = '❌ For security, please sign out and sign in again before changing your password.';
    }
    
    alert(errorMessage);
  }
}

console.log('✅ Change Password Module Loaded');


/**
 * ==========================================
 * SIGN OUT FUNCTION (Firebase Auth - UPDATED)
 * ==========================================
 */

/**
 * Sign out current user with confirmation
 */
async function signOut() {
  console.log('🚪 Sign out requested');
  
  // Show confirmation dialog
  const confirmed = confirm('Are you sure you want to sign out?');
  
  if (!confirmed) {
    console.log('❌ Sign out cancelled by user');
    return;
  }
  
  try {
    console.log('🔓 Signing out...');
    
    // Get Firebase signOut function
    const { signOut: firebaseSignOut } = window.firebaseImports;
    
    // Sign out from Firebase
    await firebaseSignOut(window.auth);
    
    console.log('✅ Sign out successful');
    
    // Clear current user
    window.currentUser = null;
    
    // ✅ NEW: Clear password field (keep email)
    const passwordInput = document.getElementById('userPasswordInput');
    if (passwordInput) {
      passwordInput.value = '';
      console.log('✅ Password field cleared');
    }
    
    // The onAuthStateChanged listener will automatically show the login page
    
  } catch (error) {
    console.error('❌ Sign out error:', error);
    alert('Failed to sign out. Please try again.');
  }
}

console.log('✅ Sign Out Module Loaded');


/**
 * ==========================================
 * PASSWORD VISIBILITY TOGGLE
 * ==========================================
 */

/**
 * Toggle password visibility (show/hide password)
 */
function togglePasswordVisibility() {
  console.log('👁️ Toggling password visibility');
  
  const passwordInput = document.getElementById('userPasswordInput');
  const toggleIcon = document.getElementById('passwordToggleIcon');
  
  if (!passwordInput || !toggleIcon) {
    console.error('❌ Password input or toggle icon not found');
    return;
  }
  
  // Toggle input type
  if (passwordInput.type === 'password') {
    // Show password
    passwordInput.type = 'text';
    toggleIcon.classList.remove('bi-eye');
    toggleIcon.classList.add('bi-eye-slash');
    console.log('✅ Password visible');
  } else {
    // Hide password
    passwordInput.type = 'password';
    toggleIcon.classList.remove('bi-eye-slash');
    toggleIcon.classList.add('bi-eye');
    console.log('✅ Password hidden');
  }
}

console.log('✅ Password Toggle Module Loaded');

/**
 * ==========================================
 * MONTHLY BACKUP REMINDER SYSTEM (UPDATED)
 * With Popup Instead of Badges
 * ==========================================
 */

/**
 * Check if backup was done this month
 */
 function wasBackupDoneThisMonth() {
  const lastBackupDate = localStorage.getItem('lastBackupDate');
  if (!lastBackupDate) return false;
  
  const lastBackup = new Date(lastBackupDate);
  const now = new Date();
  
  return lastBackup.getMonth() === now.getMonth() && 
         lastBackup.getFullYear() === now.getFullYear();
}

/**
 * Check if backup reminder should be shown
 */
function shouldShowBackupReminder() {
  const today = new Date();
  const dayOfMonth = today.getDate();
  
  // Only show during first 5 days of month
  if (dayOfMonth > 5) {
    console.log(`ℹ️ Day ${dayOfMonth} - Outside reminder window (1-5)`);
    return false;
  }
  
  // Check if user dismissed for this month
  const dismissedMonth = localStorage.getItem('backupReminderDismissedMonth');
  const currentMonth = `${today.getFullYear()}-${today.getMonth()}`;
  
  if (dismissedMonth === currentMonth) {
    console.log('ℹ️ User dismissed reminder for this month');
    return false;
  }
  
  // Check if backup was already done this month
  if (wasBackupDoneThisMonth()) {
    console.log('✅ Backup already completed this month');
    return false;
  }
  
  console.log('⚠️ Backup reminder should be shown');
  return true;
}

/**
 * Show backup reminder popup
 */
function showBackupReminder() {
  const modal = document.getElementById('backupReminderModal');
  if (!modal) {
    console.error('❌ Backup reminder modal not found');
    return;
  }
  
  // Update last backup info
  updateLastBackupInfo();
  
  // Show modal with animation
  modal.style.display = 'flex';
  console.log('📅 Backup reminder popup shown');
}

/**
 * Hide backup reminder popup
 */
function hideBackupReminder() {
  const modal = document.getElementById('backupReminderModal');
  if (modal) {
    modal.style.display = 'none';
    console.log('✅ Backup reminder hidden');
  }
}

/**
 * Update last backup info text
 */
function updateLastBackupInfo() {
  const lastBackupText = document.getElementById('lastBackupText');
  const lastBackupInfo = document.getElementById('lastBackupInfo');
  
  if (!lastBackupText || !lastBackupInfo) return;
  
  const lastBackupDate = localStorage.getItem('lastBackupDate');
  
  if (lastBackupDate) {
    const lastBackup = new Date(lastBackupDate);
    const today = new Date();
    
    // Calculate days ago
    const diffTime = Math.abs(today - lastBackup);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    const formattedDate = lastBackup.toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      year: 'numeric'
    });
    
    if (diffDays === 0) {
      lastBackupText.textContent = `Last backup: Today`;
      lastBackupInfo.style.background = '#d1ecf1';
      lastBackupInfo.style.borderLeftColor = '#0dcaf0';
    } else if (diffDays === 1) {
      lastBackupText.textContent = `Last backup: Yesterday`;
      lastBackupInfo.style.background = '#d1ecf1';
      lastBackupInfo.style.borderLeftColor = '#0dcaf0';
    } else if (diffDays <= 7) {
      lastBackupText.textContent = `Last backup: ${diffDays} days ago (${formattedDate})`;
      lastBackupInfo.style.background = '#fff3cd';
      lastBackupInfo.style.borderLeftColor = '#ffc107';
    } else {
      lastBackupText.textContent = `Last backup: ${formattedDate} (${diffDays} days ago)`;
      lastBackupInfo.style.background = '#f8d7da';
      lastBackupInfo.style.borderLeftColor = '#dc3545';
    }
  } else {
    lastBackupText.textContent = 'No backup found this month';
    lastBackupInfo.style.background = '#fff3cd';
    lastBackupInfo.style.borderLeftColor = '#ffc107';
  }
}

/**
 * Cancel backup reminder
 */
function cancelBackupReminder() {
  const checkbox = document.getElementById('dontShowAgainCheckbox');
  
  // Check if user selected "don't show again"
  if (checkbox && checkbox.checked) {
    const today = new Date();
    const currentMonth = `${today.getFullYear()}-${today.getMonth()}`;
    localStorage.setItem('backupReminderDismissedMonth', currentMonth);
    console.log('✅ Reminder dismissed for this month');
  }
  
  hideBackupReminder();
  console.log('❌ User cancelled backup reminder');
}

/**
 * Start backup from reminder popup
 */
async function startBackupFromReminder() {
  console.log('📥 Starting backup from reminder...');
  
  const downloadButton = document.querySelector('.btn-backup-download');
  
  try {
    // Add loading state
    if (downloadButton) {
      downloadButton.classList.add('loading');
      downloadButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creating backup...';
    }
    
    // Call the actual backup function
    await sendBackupEmail();
    
    // Mark backup as completed (in case wrapper doesn't work)
    markBackupCompleted();
    
    // Hide modal
    hideBackupReminder();
    
    console.log('✅ Backup completed from reminder');
    
  } catch (error) {
    console.error('❌ Backup failed:', error);
    
    // Reset button
    if (downloadButton) {
      downloadButton.classList.remove('loading');
      downloadButton.innerHTML = '<i class="bi bi-cloud-download me-2"></i>Backup Now';
    }
    
    alert('❌ Backup failed: ' + error.message);
  }
}

/**
 * Mark backup as completed
 */
function markBackupCompleted() {
  const now = new Date().toISOString();
  localStorage.setItem('lastBackupDate', now);
  
  // Also clear any "dismissed" flag since backup is done
  localStorage.removeItem('backupReminderDismissedMonth');
  
  console.log('✅ Backup marked as completed:', now);
  console.log('✅ Reminder preferences cleared');
}

/**
 * ==========================================
 * BACKUP FUNCTION WRAPPER
 * ==========================================
 */

/**
 * Wrap the backup function to add completion tracking
 */
function wrapBackupFunction() {
  // Check if function exists
  if (typeof window.sendBackupEmail !== 'function') {
    console.warn('⚠️ sendBackupEmail function not found - skipping wrap');
    return false;
  }
  
  // Check if already wrapped
  if (window.sendBackupEmail._isWrapped) {
    console.log('ℹ️ sendBackupEmail already wrapped');
    return true;
  }
  
  // Store reference to original function
  const originalSendBackupEmail = window.sendBackupEmail;
  
  // Replace with wrapped version
  window.sendBackupEmail = async function(event) {
    console.log('📧 Starting backup (wrapped)...');
    
    try {
      // Call original backup function
      await originalSendBackupEmail(event);
      
      // Mark backup as completed (only if successful)
      markBackupCompleted();
      
      console.log('✅ Backup completed and tracked');
      
      return true;
      
    } catch (error) {
      console.error('❌ Backup error:', error);
      throw error;
    }
  };
  
  // Mark as wrapped
  window.sendBackupEmail._isWrapped = true;
  
  console.log('✅ sendBackupEmail function wrapped with completion tracking');
  return true;
}

/**
 * Try to wrap backup function with retries
 */
function tryWrapBackupFunction() {
  let attempts = 0;
  const maxAttempts = 50;
  
  const checkInterval = setInterval(() => {
    attempts++;
    
    if (wrapBackupFunction()) {
      clearInterval(checkInterval);
      console.log(`✅ Backup function wrapped after ${attempts} attempts`);
    } else if (attempts >= maxAttempts) {
      clearInterval(checkInterval);
      console.warn('⚠️ Could not wrap sendBackupEmail after', maxAttempts, 'attempts');
      console.warn('⚠️ Manual tracking will be used instead');
    }
  }, 100);
}

/**
 * ==========================================
 * EVENT LISTENERS
 * ==========================================
 */

/**
 * Close modal when clicking outside
 */
function setupModalClickOutside() {
  document.addEventListener('click', function(event) {
    const modal = document.getElementById('backupReminderModal');
    if (modal && event.target === modal) {
      cancelBackupReminder();
    }
  });
}

/**
 * Close modal with Escape key
 */
function setupModalEscapeKey() {
  document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
      const modal = document.getElementById('backupReminderModal');
      if (modal && modal.style.display === 'flex') {
        cancelBackupReminder();
      }
    }
  });
}

/**
 * Add keyboard shortcut (Ctrl+B to backup)
 */
function setupBackupKeyboardShortcut() {
  document.addEventListener('keydown', function(event) {
    if ((event.ctrlKey || event.metaKey) && event.key === 'b') {
      event.preventDefault();
      console.log('⌨️ Keyboard shortcut triggered (Ctrl+B)');
      
      if (typeof window.sendBackupEmail === 'function') {
        window.sendBackupEmail();
      } else {
        console.error('❌ Backup function not available');
        alert('Backup function is not ready yet. Please wait a moment and try again.');
      }
    }
  });
}

/**
 * ==========================================
 * INITIALIZATION
 * ==========================================
 */

/**
 * Log backup status for debugging
 */
function logBackupStatus() {
  const today = new Date();
  const lastBackupDate = localStorage.getItem('lastBackupDate');
  const dismissedMonth = localStorage.getItem('backupReminderDismissedMonth');
  
  console.log('📊 Backup Status:');
  console.log('  - Current Date:', today.toLocaleDateString());
  console.log('  - Day of Month:', today.getDate());
  console.log('  - Last Backup:', lastBackupDate || 'Never');
  console.log('  - Dismissed Month:', dismissedMonth || 'None');
  console.log('  - Should Show Reminder:', shouldShowBackupReminder());
}

/**
 * Initialize the backup reminder system
 */
function initializeBackupReminderSystem() {
  console.log('🔄 Initializing backup reminder system...');
  
  // Check if modal exists
  const modal = document.getElementById('backupReminderModal');
  if (!modal) {
    console.warn('⚠️ Backup reminder modal not found in DOM');
    return;
  }
  
  // Setup event listeners
  setupModalClickOutside();
  setupModalEscapeKey();
  setupBackupKeyboardShortcut();
  
  // Try to wrap backup function
  tryWrapBackupFunction();
  
  // Log current status
  logBackupStatus();
  
  // Wait a bit for page to settle, then check if reminder should show
  setTimeout(() => {
    if (shouldShowBackupReminder()) {
      console.log('📅 Showing backup reminder popup...');
      showBackupReminder();
    } else {
      console.log('ℹ️ Backup reminder not needed at this time');
    }
  }, 1500); // 1.5 second delay after page load
}

/**
 * Main initialization - runs on page load
 */
function initBackupReminder() {
  console.log('🚀 Backup Reminder Module Loading...');
  initializeBackupReminderSystem();
  console.log('✅ Backup Reminder System Loaded');
  console.log('💡 Press Ctrl+B to quickly start a backup');
}

/**
 * Initialize based on document ready state
 */
if (document.readyState === 'loading') {
  // DOM not ready yet
  document.addEventListener('DOMContentLoaded', initBackupReminder);
  console.log('⏳ Waiting for DOM to load...');
} else {
  // DOM already loaded
  initBackupReminder();
}

/**
 * ==========================================
 * UTILITY FUNCTIONS (for testing/debugging)
 * ==========================================
 */

/**
 * Manually trigger backup reminder (for testing)
 */
window.showBackupReminderTest = function() {
  console.log('🧪 Showing backup reminder (test mode)');
  const modal = document.getElementById('backupReminderModal');
  if (modal) {
    updateLastBackupInfo();
    modal.style.display = 'flex';
  } else {
    console.error('❌ Modal not found');
  }
};

/**
 * Reset all backup preferences (for testing)
 */
window.resetBackupPreferences = function() {
  localStorage.removeItem('lastBackupDate');
  localStorage.removeItem('backupReminderDismissedMonth');
  console.log('✅ Backup preferences reset');
  console.log('🔄 Reload page to see reminder popup');
};

/**
 * Get backup statistics
 */
window.getBackupStats = function() {
  const lastBackupDate = localStorage.getItem('lastBackupDate');
  const dismissedMonth = localStorage.getItem('backupReminderDismissedMonth');
  const today = new Date();
  
  const stats = {
    currentDay: today.getDate(),
    currentMonth: today.getMonth() + 1,
    currentYear: today.getFullYear(),
    lastBackup: lastBackupDate || 'Never',
    dismissedMonth: dismissedMonth || 'None',
    shouldShowReminder: shouldShowBackupReminder(),
    isBackupWindow: today.getDate() <= 5,
    backupDoneThisMonth: wasBackupDoneThisMonth()
  };
  
  console.table(stats);
  return stats;
};

/**
 * Force backup (bypass reminder)
 */
window.forceBackup = function() {
  if (typeof window.sendBackupEmail === 'function') {
    console.log('🚀 Forcing backup...');
    window.sendBackupEmail();
  } else {
    console.error('❌ Backup function not available');
  }
};

/**
 * Simulate first 3 days scenario (for testing)
 */
window.testBackupScenario = function() {
  console.log('🧪 Testing backup reminder scenario...');
  
  // Clear all preferences
  localStorage.removeItem('lastBackupDate');
  localStorage.removeItem('backupReminderDismissedMonth');
  
  // Show the popup
  const modal = document.getElementById('backupReminderModal');
  if (modal) {
    updateLastBackupInfo();
    modal.style.display = 'flex';
    console.log('✅ Test scenario activated - Popup shown');
  } else {
    console.error('❌ Modal not found');
  }
};

console.log('✅ Backup Reminder Module Ready');
console.log('💡 Debug commands:');
console.log('   - window.showBackupReminderTest()  // Show popup');
console.log('   - window.resetBackupPreferences()  // Reset settings');
console.log('   - window.getBackupStats()          // View status');
console.log('   - window.forceBackup()             // Quick backup');
console.log('   - window.testBackupScenario()      // Test popup');

/**
 * ==========================================
 * QUICK ACTIONS CARD FLIP ANIMATION
 * ==========================================
 */

 let isFlipped = false;

/**
 * Toggle flip animation (Smart Handler)
 */
function toggleQuickActionsFlip(event) {
  // ✅ 1. Check if the click originated from a Checkbox or its Label
  if (event && event.target) {
    if (event.target.classList.contains('translation-exclusion-checkbox') || 
        event.target.closest('.translation-exclusion-checkbox')) {
      console.log('🛑 Clicked exclusion checkbox, blocking flip.');
      return; // STOP here, do not flip
    }
  }

  // ✅ 2. Proceed with Flip
  const flipCardInner = document.getElementById('flipCardInner');
  
  if (flipCardInner) {
    flipCardInner.classList.toggle('flipped');
    isFlipped = !isFlipped;
    console.log('✅ Card flipped:', isFlipped ? 'BACK (Buttons)' : 'FRONT (Quick Create)');
  }
}

// Ensure card starts in front position on page load
document.addEventListener('DOMContentLoaded', function() {
  const flipCardInner = document.getElementById('flipCardInner');
  if (flipCardInner) {
    flipCardInner.classList.remove('flipped');
    isFlipped = false;
    console.log('✅ Quick Actions card initialized (Front side visible)');
  }
});

console.log('✅ Quick Actions Flip Animation Loaded');



/**
 * ==========================================
 * MONTHLY BACKUP REMINDER SYSTEM
 * ==========================================
 */

/**
 * Check if backup reminder should be shown
 */
 function shouldShowBackupReminder() {
  const today = new Date();
  const dayOfMonth = today.getDate();
  
  // Only show during first 3 days of month
  if (dayOfMonth > 5) {
    console.log(`ℹ️ Day ${dayOfMonth} - Outside reminder window (1-5)`);
    return false;
  }
  
  // Check if user dismissed for this month
  const dismissedMonth = localStorage.getItem('backupReminderDismissedMonth');
  const currentMonth = `${today.getFullYear()}-${today.getMonth()}`;
  
  if (dismissedMonth === currentMonth) {
    console.log('ℹ️ User dismissed reminder for this month');
    return false;
  }
  
  // Check if backup was already done this month
  const lastBackupDate = localStorage.getItem('lastBackupDate');
  if (lastBackupDate) {
    const lastBackup = new Date(lastBackupDate);
    if (lastBackup.getMonth() === today.getMonth() && 
        lastBackup.getFullYear() === today.getFullYear()) {
      console.log('✅ Backup already completed this month');
      return false;
    }
  }
  
  console.log('⚠️ Backup reminder should be shown');
  return true;
}

/**
 * Show backup reminder popup
 */
function showBackupReminder() {
  const modal = document.getElementById('backupReminderModal');
  if (!modal) {
    console.error('❌ Backup reminder modal not found');
    return;
  }
  
  // Update last backup info
  updateLastBackupInfo();
  
  // Show modal with animation
  modal.style.display = 'flex';
  console.log('📅 Backup reminder shown');
}

/**
 * Hide backup reminder popup
 */
function hideBackupReminder() {
  const modal = document.getElementById('backupReminderModal');
  if (modal) {
    modal.style.display = 'none';
    console.log('✅ Backup reminder hidden');
  }
}

/**
 * Update last backup info text
 */
function updateLastBackupInfo() {
  const lastBackupText = document.getElementById('lastBackupText');
  const lastBackupInfo = document.getElementById('lastBackupInfo');
  
  if (!lastBackupText || !lastBackupInfo) return;
  
  const lastBackupDate = localStorage.getItem('lastBackupDate');
  
  if (lastBackupDate) {
    const lastBackup = new Date(lastBackupDate);
    const today = new Date();
    
    // Calculate days ago
    const diffTime = Math.abs(today - lastBackup);
    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
    
    const formattedDate = lastBackup.toLocaleDateString('en-US', {
      month: 'short',
      day: 'numeric',
      year: 'numeric'
    });
    
    if (diffDays === 0) {
      lastBackupText.textContent = `Last backup: Today`;
      lastBackupInfo.style.background = '#d1ecf1';
      lastBackupInfo.style.borderLeftColor = '#0dcaf0';
    } else if (diffDays === 1) {
      lastBackupText.textContent = `Last backup: Yesterday`;
      lastBackupInfo.style.background = '#d1ecf1';
      lastBackupInfo.style.borderLeftColor = '#0dcaf0';
    } else if (diffDays <= 7) {
      lastBackupText.textContent = `Last backup: ${diffDays} days ago (${formattedDate})`;
      lastBackupInfo.style.background = '#fff3cd';
      lastBackupInfo.style.borderLeftColor = '#ffc107';
    } else {
      lastBackupText.textContent = `Last backup: ${formattedDate} (${diffDays} days ago)`;
      lastBackupInfo.style.background = '#f8d7da';
      lastBackupInfo.style.borderLeftColor = '#dc3545';
    }
  } else {
    lastBackupText.textContent = 'No backup found this month';
    lastBackupInfo.style.background = '#fff3cd';
    lastBackupInfo.style.borderLeftColor = '#ffc107';
  }
}

/**
 * Cancel backup reminder
 */
function cancelBackupReminder() {
  const checkbox = document.getElementById('dontShowAgainCheckbox');
  
  // Check if user selected "don't show again"
  if (checkbox && checkbox.checked) {
    const today = new Date();
    const currentMonth = `${today.getFullYear()}-${today.getMonth()}`;
    localStorage.setItem('backupReminderDismissedMonth', currentMonth);
    console.log('✅ Reminder dismissed for this month');
  }
  
  hideBackupReminder();
  console.log('❌ User cancelled backup reminder');
}

/**
 * Start backup from reminder popup
 */
async function startBackupFromReminder() {
  console.log('📥 Starting backup from reminder...');
  
  const downloadButton = document.querySelector('.btn-backup-download');
  
  try {
    // Add loading state
    if (downloadButton) {
      downloadButton.classList.add('loading');
      downloadButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creating backup...';
    }
    
    // Call the actual backup function
    await sendBackupEmail();
    
    // Mark backup as completed
    markBackupCompleted();
    
    // Hide modal
    hideBackupReminder();
    
    console.log('✅ Backup completed from reminder');
    
  } catch (error) {
    console.error('❌ Backup failed:', error);
    
    // Reset button
    if (downloadButton) {
      downloadButton.classList.remove('loading');
      downloadButton.innerHTML = '<i class="bi bi-cloud-download me-2"></i>Backup Now';
    }
    
    alert('❌ Backup failed: ' + error.message);
  }
}

/**
 * Mark backup as completed
 */
function markBackupCompleted() {
  const now = new Date().toISOString();
  localStorage.setItem('lastBackupDate', now);
  console.log('✅ Backup marked as completed:', now);
}

/**
 * Initialize backup reminder on page load
 */
function initializeBackupReminder() {
  console.log('🔄 Initializing backup reminder system...');
  
  // Wait for page to fully load
  setTimeout(() => {
    if (shouldShowBackupReminder()) {
      showBackupReminder();
    } else {
      console.log('ℹ️ Backup reminder not needed');
    }
  }, 1500); // Show 1.5 seconds after page load
}

/**
 * Close modal when clicking outside
 */
document.addEventListener('click', function(event) {
  const modal = document.getElementById('backupReminderModal');
  if (modal && event.target === modal) {
    cancelBackupReminder();
  }
});

/**
 * Close modal with Escape key
 */
document.addEventListener('keydown', function(event) {
  if (event.key === 'Escape') {
    const modal = document.getElementById('backupReminderModal');
    if (modal && modal.style.display === 'flex') {
      cancelBackupReminder();
    }
  }
});

// Initialize on page load
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeBackupReminder);
} else {
  initializeBackupReminder();
}

console.log('✅ Backup Reminder System Loaded');


    
/**
 * ==========================================
 * USER DROPDOWN DISPLAY (Desktop + Mobile)
 * ==========================================
 */

/**
 * Initialize and update user dropdown display
 */
function initializeUserDisplay() {
  console.log('🔧 Initializing user dropdown...');
  
  // Listen for auth state changes
  if (window.auth) {
    window.auth.onAuthStateChanged((user) => {
      updateUserDropdownDisplay(user);
    });
  }
}

/**
 * ==========================================
 * USER DROPDOWN DISPLAY (Desktop + Mobile)
 * ==========================================
 */

/**
 * Update username display in dropdown (Both Desktop and Mobile)
 */
 function updateUserDropdownDisplay(user) {
  // Desktop elements
  const userNameElement = document.getElementById('userName');
  const userEmailDropdown = document.getElementById('userEmailDropdown');
  
  // Mobile elements
  const userNameMobile = document.getElementById('userNameMobile');
  const userEmailDropdownMobile = document.getElementById('userEmailDropdownMobile');
  
  if (user && user.email) {
    // Get shortened username
    const username = user.email.split('@')[0];
    
    // Update Desktop Header Username
    if (userNameElement) {
      userNameElement.textContent = username;
      userNameElement.title = user.email; // Tooltip with full email
    }
    
    // Update Desktop Dropdown Full Email
    if (userEmailDropdown) {
      userEmailDropdown.textContent = user.email;
    }
    
    // Update Mobile Header Username
    if (userNameMobile) {
      userNameMobile.textContent = username;
      userNameMobile.title = user.email; // Tooltip with full email
    }
    
    // Update Mobile Dropdown Full Email
    if (userEmailDropdownMobile) {
      userEmailDropdownMobile.textContent = user.email;
    }
    
    console.log('✅ User dropdown updated (Desktop + Mobile):', user.email);
    console.log('   - Username:', username);
  } else {
    // Not signed in - Update all elements
    if (userNameElement) {
      userNameElement.textContent = 'Guest';
      userNameElement.title = '';
    }
    if (userEmailDropdown) {
      userEmailDropdown.textContent = 'Not signed in';
    }
    if (userNameMobile) {
      userNameMobile.textContent = 'Guest';
      userNameMobile.title = '';
    }
    if (userEmailDropdownMobile) {
      userEmailDropdownMobile.textContent = 'Not signed in';
    }
    console.log('ℹ️ No user signed in - Guest mode');
  }
}

/**
 * Initialize user display on page load
 */
function initializeUserDisplay() {
  console.log('🔄 Initializing user display...');
  
  // Check if auth is available
  if (!window.auth) {
    console.error('❌ Firebase Auth not initialized');
    return;
  }
  
  // Listen for auth state changes
  window.auth.onAuthStateChanged((user) => {
    if (user) {
      console.log('✅ User authenticated:', user.email);
      updateUserDropdownDisplay(user);
    } else {
      console.log('⚠️ No user authenticated');
      updateUserDropdownDisplay(null);
    }
  });
}

/**
 * ==========================================
 * MOBILE NAVBAR TOGGLE FUNCTION
 * ==========================================
 */


/**
 * Toggle mobile navbar invoice section
 */
function toggleMobileNavbar() {
  const invoiceSection = document.getElementById('mobileInvoiceSection');
  const toggleIcon = document.getElementById('navbarToggleIcon');
  
  if (!invoiceSection || !toggleIcon) {
    console.error('❌ Mobile navbar elements not found');
    return;
  }
  
  if (!mobileNavbarExpanded) {
    // Expand: Show invoice buttons
    invoiceSection.style.display = 'block';
    toggleIcon.classList.remove('bi-chevron-down');
    toggleIcon.classList.add('bi-chevron-up');
    mobileNavbarExpanded = true;
    console.log('✅ Mobile navbar expanded');
  } else {
    // Collapse: Hide invoice buttons
    invoiceSection.style.display = 'none';
    toggleIcon.classList.remove('bi-chevron-up');
    toggleIcon.classList.add('bi-chevron-down');
    mobileNavbarExpanded = false;
    console.log('✅ Mobile navbar collapsed');
  }
}

/**
 * Auto-collapse mobile navbar when clicking outside
 */
function setupMobileNavbarAutoCollapse() {
  document.addEventListener('click', function(event) {
    const navbar = document.querySelector('.navbar');
    const invoiceSection = document.getElementById('mobileInvoiceSection');
    
    if (mobileNavbarExpanded && navbar && !navbar.contains(event.target)) {
      toggleMobileNavbar();
    }
  });
}

/**
 * ==========================================
 * QUICK ACTIONS CARD FLIP ANIMATION
 * ==========================================
 */



/**
 * Toggle flip animation for Quick Actions card
 */
function toggleQuickActionsFlip() {
  const flipCardInner = document.getElementById('flipCardInner');
  
  if (flipCardInner) {
    flipCardInner.classList.toggle('flipped');
    isFlipped = !isFlipped;
    console.log('✅ Card flipped:', isFlipped ? 'BACK (Buttons)' : 'FRONT (Quick Create)');
  } else {
    console.error('❌ Flip card element not found');
  }
}

/**
 * Ensure flip card starts in front position
 */
function initializeFlipCard() {
  const flipCardInner = document.getElementById('flipCardInner');
  if (flipCardInner) {
    flipCardInner.classList.remove('flipped');
    isFlipped = false;
    console.log('✅ Quick Actions card initialized (Front side visible)');
  }
}

/**
 * ==========================================
 * DROPDOWN BUTTON FIX (Prevent premature close)
 * ==========================================
 */

/**
 * Prevent dropdown from closing when clicking action buttons
 */
function setupDropdownButtonHandlers() {
  // Wait for Bootstrap dropdowns to be initialized
  setTimeout(() => {
    const dropdownButtons = document.querySelectorAll('.dropdown-item');
    
    dropdownButtons.forEach(button => {
      button.addEventListener('click', function(e) {
        // Only stop propagation for specific actions that need it
        const action = this.getAttribute('onclick');
        if (action && (action.includes('Backup') || action.includes('Restore'))) {
          // Allow dropdown to close after action
          setTimeout(() => {
            const dropdown = bootstrap.Dropdown.getInstance(this.closest('.dropdown-toggle'));
            if (dropdown) dropdown.hide();
          }, 100);
        }
      });
    });
    
    console.log('✅ Dropdown button handlers initialized');
  }, 500);
}

/**
 * ==========================================
 * INITIALIZATION ON PAGE LOAD
 * ==========================================
 */

/**
 * Main initialization function
 */
function initializeNavbar() {
  console.log('📄 Initializing navbar components...');
  
  // Initialize flip card
  initializeFlipCard();
  
  // Setup mobile navbar auto-collapse
  setupMobileNavbarAutoCollapse();
  
  // Setup dropdown button handlers
  setupDropdownButtonHandlers();
  
  // Wait for Firebase Auth
  const checkAuth = setInterval(() => {
    if (window.auth) {
      console.log('✅ Firebase Auth ready');
      clearInterval(checkAuth);
      initializeUserDisplay();
    }
  }, 100);
  
  // Timeout after 10 seconds
  setTimeout(() => {
    clearInterval(checkAuth);
    if (!window.auth) {
      console.warn('⚠️ Firebase Auth initialization timeout');
      // Still update UI with guest mode
      updateUserDropdownDisplay(null);
    }
  }, 10000);
}

/**
 * Wait for DOM to be fully loaded
 */
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeNavbar);
} else {
  // DOM already loaded
  initializeNavbar();
}

/**
 * ==========================================
 * UTILITY FUNCTIONS
 * ==========================================
 */

/**
 * Get current user
 */
function getCurrentUser() {
  if (window.auth && window.auth.currentUser) {
    return window.auth.currentUser;
  }
  return null;
}

/**
 * Check if user is authenticated
 */
function isUserAuthenticated() {
  const user = getCurrentUser();
  return user !== null;
}

/**
 * Get username from email
 */
function getUsernameFromEmail(email) {
  if (!email) return 'Guest';
  return email.split('@')[0];
}

/**
 * Log navbar status (for debugging)
 */
function logNavbarStatus() {
  console.log('📊 Navbar Status:');
  console.log('  - User authenticated:', isUserAuthenticated());
  console.log('  - Mobile navbar expanded:', mobileNavbarExpanded);
  console.log('  - Quick actions flipped:', isFlipped);
  
  const user = getCurrentUser();
  if (user) {
    console.log('  - Current user:', user.email);
  }
}

// Expose functions globally for debugging
window.navbarDebug = {
  logStatus: logNavbarStatus,
  getCurrentUser: getCurrentUser,
  isAuthenticated: isUserAuthenticated,
  toggleMobile: toggleMobileNavbar,
  toggleFlip: toggleQuickActionsFlip
};

console.log('✅ Navbar Module Loaded (Desktop + Mobile)');
console.log('💡 Debug commands available via window.navbarDebug');



/**
 * ==========================================
 * MOBILE NAVBAR TOGGLE FUNCTION
 * ==========================================
 */

 let mobileNavbarExpanded = false;

/**
 * Toggle mobile navbar invoice section
 */
function toggleMobileNavbar() {
  const invoiceSection = document.getElementById('mobileInvoiceSection');
  const toggleIcon = document.getElementById('navbarToggleIcon');
  
  if (!mobileNavbarExpanded) {
    // Expand: Show invoice buttons
    invoiceSection.style.display = 'block';
    toggleIcon.classList.remove('bi-chevron-down');
    toggleIcon.classList.add('bi-chevron-up');
    mobileNavbarExpanded = true;
    console.log('✅ Mobile navbar expanded');
  } else {
    // Collapse: Hide invoice buttons
    invoiceSection.style.display = 'none';
    toggleIcon.classList.remove('bi-chevron-up');
    toggleIcon.classList.add('bi-chevron-down');
    mobileNavbarExpanded = false;
    console.log('✅ Mobile navbar collapsed');
  }
}

// Optional: Auto-collapse when clicking outside
document.addEventListener('click', function(event) {
  const navbar = document.querySelector('.navbar');
  const invoiceSection = document.getElementById('mobileInvoiceSection');
  
  if (mobileNavbarExpanded && !navbar.contains(event.target)) {
    toggleMobileNavbar();
  }
});

console.log('✅ Mobile Navbar Toggle Loaded');
/**
 * ==========================================
 * VIEW SWITCHER FUNCTIONALITY (BUTTON GROUP)
 * ==========================================
 */


// Global variable to track current view
let currentView = 'inventory';


/**
 * Handle View Switch Click (Smart Handler)
 * Allows switching views even in Exclusion Mode, UNLESS the checkbox itself was clicked.
 */
function handleViewSwitchClick(event, viewName) {
  // 1. Check if the click hit the checkbox directly
  if (event && event.target) {
    if (event.target.classList.contains('translation-exclusion-checkbox') || 
        event.target.closest('.translation-exclusion-checkbox')) {
      console.log('🛑 Clicked exclusion checkbox on view button, blocking switch.');
      event.stopPropagation(); // Stop bubbling
      return; // Do nothing else
    }
  }

  // 2. If we are here, the user clicked the button text or icon (not the checkbox)
  // Proceed to switch view normally
  switchView(viewName);
}


/**
 * Switch between Inventory, Sales, and Purchases views
 * ✅ Re-attaches product click handlers when switching to inventory
 */
function switchView(view) {
  console.log(`🔄 Switching to ${view} view`);
  
  currentView = view;
  
  // ✅ Save current view to localStorage
  try {
    localStorage.setItem('lastSelectedView', view);
    console.log(`💾 Saved view preference: ${view}`);
  } catch (e) {
    console.warn('⚠️ Failed to save view preference:', e);
  }
  
  // ✅ Update active button state
  document.querySelectorAll('.btn-group .btn').forEach(btn => {
    btn.classList.remove('active');
  });
  const activeBtn = document.getElementById(`${view}-btn`);
  if (activeBtn) {
    activeBtn.classList.add('active');
  }
  
  // Hide all sections
  document.getElementById('inventorySection').style.display = 'none';
  document.getElementById('productsSection').style.display = 'none';
  document.getElementById('salesSection').style.display = 'none';
  document.getElementById('purchasesSection').style.display = 'none';
  
  // Get search input
  const searchInput = document.getElementById('productSearch');
  
  // Show relevant section based on view
  if (view === 'inventory') {
    // Show inventory section (products + bulk edit + all/photos)
    document.getElementById('inventorySection').style.display = 'block';
    document.getElementById('productsSection').style.display = 'block';
    
    searchInput.placeholder = '🔍 Search products...';
    
    // Load products
    if (typeof displayAllProducts === 'function') {
      displayAllProducts();
    }
    
    // ✅ RE-ATTACH PRODUCT CLICK HANDLERS
    setTimeout(() => {
      reattachProductClickHandlers();
      console.log('✅ Product click handlers re-attached for inventory view');
    }, 150);
    
  } else if (view === 'sales') {
    // Show sales section only
    document.getElementById('salesSection').style.display = 'block';
    
    searchInput.placeholder = '🔍 Search sales...';
    
    // Load sales data
    if (typeof loadRecentSales === 'function') {
      loadRecentSales();
    } else if (typeof renderSales === 'function') {
      renderSales();
    }
    
  } else if (view === 'purchases') {
    // Show purchases section only
    document.getElementById('purchasesSection').style.display = 'block';
    
    searchInput.placeholder = '🔍 Search purchases...';
    
    // Load purchases data
    if (typeof loadRecentPurchases === 'function') {
      loadRecentPurchases();
    }
  }
  
  // Clear search input
  searchInput.value = '';
  
  console.log(`✅ Switched to ${view} view`);
}


/**
 * ==========================================
 * RE-ATTACH PRODUCT CLICK HANDLERS
 * ==========================================
 * Re-attaches click handlers to product cards after view switch
 * Handles both normal mode and bulk edit mode
 */
function reattachProductClickHandlers() {
  console.log('🔗 Re-attaching product click handlers...');
  
  // ✅ DESKTOP - Table rows
  const tableRows = document.querySelectorAll('#productsTableBody tr[data-product-id]');
  tableRows.forEach(row => {
    const productId = row.getAttribute('data-product-id');
    
    // Remove any existing onclick to prevent duplicates
    row.onclick = null;
    
    // Re-attach onclick handler
    row.onclick = function(event) {
      // Ignore clicks on buttons
      if (event.target.closest('.btn')) {
        return;
      }
      
      // Check if bulk edit mode is active
      if (bulkEditMode && bulkEditMode.active) {
        // In bulk edit mode, handle selection instead
        event.stopPropagation();
        event.preventDefault();
        if (typeof toggleProductSelectionDesktop === 'function') {
          toggleProductSelectionDesktop(productId, row);
        }
        return;
      }
      
      // Normal mode - show product details
      event.preventDefault();
      if (typeof showProductDetails === 'function') {
        showProductDetails(productId);
      }
    };
  });
  
  // ✅ MOBILE - Product cards
  const mobileCards = document.querySelectorAll('.mobile-item[data-product-id]');
  mobileCards.forEach(card => {
    const productId = card.getAttribute('data-product-id');
    
    // Remove any existing onclick to prevent duplicates
    card.onclick = null;
    
    // Re-attach onclick handler
    card.onclick = function(event) {
      // Ignore clicks on buttons
      if (event.target.closest('.btn')) {
        return;
      }
      
      // Check if bulk edit mode is active
      if (bulkEditMode && bulkEditMode.active) {
        // In bulk edit mode, handle selection instead
        event.stopPropagation();
        event.preventDefault();
        if (typeof toggleProductSelectionMobile === 'function') {
          toggleProductSelectionMobile(productId, card);
        }
        return;
      }
      
      // Normal mode - show product details
      event.preventDefault();
      if (typeof showProductDetails === 'function') {
        showProductDetails(productId);
      }
    };
  });
  
  console.log(`✅ Re-attached handlers: ${tableRows.length} desktop rows, ${mobileCards.length} mobile cards`);
}


/**
 * Load saved view preference from localStorage
 */
function loadSavedViewPreference() {
  try {
    const savedView = localStorage.getItem('lastSelectedView');
    
    if (savedView && ['inventory', 'sales', 'purchases'].includes(savedView)) {
      console.log(`📂 Loading saved view preference: ${savedView}`);
      return savedView;
    } else {
      console.log('📦 No saved view preference, defaulting to inventory');
      return 'inventory';
    }
  } catch (e) {
    console.warn('⚠️ Failed to load view preference:', e);
    return 'inventory';
  }
}


/**
 * Handle search based on current view
 */
function handleSearch() {
  if (currentView === 'inventory') {
    if (typeof searchProducts === 'function') {
      searchProducts();
    }
  } else if (currentView === 'sales') {
    searchSales();
  } else if (currentView === 'purchases') {
    searchPurchases();
  }
}


/**
 * Search sales
 */
function searchSales() {
  const searchTerm = document.getElementById('productSearch').value.toLowerCase().trim();
  console.log(`🔍 Searching sales: "${searchTerm}"`);
  
  if (!searchTerm) {
    // Show all sales if search is empty
    const salesRows = document.querySelectorAll('#salesList tr');
    salesRows.forEach(row => {
      row.style.display = '';
    });
    return;
  }
  
  // Filter sales rows
  const salesRows = document.querySelectorAll('#salesList tr');
  salesRows.forEach(row => {
    const text = row.textContent.toLowerCase();
    if (text.includes(searchTerm)) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
}


/**
 * Search purchases
 */
function searchPurchases() {
  const searchTerm = document.getElementById('productSearch').value.toLowerCase().trim();
  console.log(`🔍 Searching purchases: "${searchTerm}"`);
  
  if (!searchTerm) {
    // Show all purchases if search is empty
    const purchaseRows = document.querySelectorAll('#purchasesList tr');
    purchaseRows.forEach(row => {
      row.style.display = '';
    });
    return;
  }
  
  // Filter purchase rows
  const purchaseRows = document.querySelectorAll('#purchasesList tr');
  purchaseRows.forEach(row => {
    const text = row.textContent.toLowerCase();
    if (text.includes(searchTerm)) {
      row.style.display = '';
    } else {
      row.style.display = 'none';
    }
  });
}


/**
 * Initialize view on page load
 */
document.addEventListener('DOMContentLoaded', function() {
  console.log('📦 Initializing view switcher...');
  
  // ✅ Load saved view preference or default to inventory
  const savedView = loadSavedViewPreference();
  
  // Small delay to ensure all elements are loaded
  setTimeout(() => {
    switchView(savedView);
    console.log('✅ View switcher initialized');
  }, 100);
});


/**
 * Optional: Reset view preference (for testing/debugging)
 */
function resetViewPreference() {
  localStorage.removeItem('lastSelectedView');
  console.log('🔄 View preference reset');
  switchView('inventory');
}


/**
 * ==========================================
 * PRODUCT SORTING - SEQUENCE NUMBER SYSTEM
 * ==========================================
 */

// Global variables
let productOrder = []; // Array to store custom order
let customOrderSequence = []; // Array to store sequence: [{id, order}, ...]
let customOrderMode = false;

/**
 * ==========================================
 * LOAD PRODUCT ORDER & SORT PREFERENCES
 * ==========================================
 */

/**
 * Load product order and sort preferences from localStorage
 */
function loadProductOrder() {
  try {
    // Load sort type and direction
    const sortType = localStorage.getItem('product_sort_type');
    const sortDirection = localStorage.getItem('product_sort_direction');
    
    console.log('📂 Loading sort preferences...');
    console.log('  Sort type:', sortType || 'none');
    console.log('  Sort direction:', sortDirection || 'none');
    
    // Load custom order if sort type is custom
    if (sortType === 'custom') {
      const savedOrder = localStorage.getItem('product_custom_order');
      
      if (savedOrder) {
        productOrder = JSON.parse(savedOrder);
        console.log('  Custom order:', productOrder.length, 'products');
      } else {
        productOrder = [];
        console.log('  No custom order found');
      }
    } else {
      productOrder = [];
    }
    
  } catch (e) {
    console.error('❌ Failed to load sort preferences:', e);
    productOrder = [];
  }
  
  return productOrder;
}

/**
 * Get products in correct order (respects saved sort preference)
 */
function getOrderedProducts() {
  if (!cachedProducts || cachedProducts.length === 0) {
    return [];
  }
  
  // Check saved sort type
  const sortType = localStorage.getItem('product_sort_type');
  const sortDirection = localStorage.getItem('product_sort_direction');
  
  console.log(`🔍 Getting ordered products - Type: ${sortType}, Direction: ${sortDirection}`);
  
  // Make a copy to avoid mutating cachedProducts
  let products = [...cachedProducts];
  
  // ✅ SORT BY NAME (A-Z or Z-A)
  if (sortType === 'name') {
    console.log(`🔤 Applying name sort: ${sortDirection}`);
    products.sort((a, b) => {
      const nameA = (a.name || '').toLowerCase();
      const nameB = (b.name || '').toLowerCase();
      
      if (sortDirection === 'asc') {
        return nameA.localeCompare(nameB);
      } else {
        return nameB.localeCompare(nameA);
      }
    });
    
    console.log(`✅ Sorted by name (${sortDirection})`);
    return products;
  }
  
  // ✅ SORT BY DATE (Latest or Oldest)
  else if (sortType === 'date') {
    console.log(`📅 Applying date sort: ${sortDirection}`);
    products.sort((a, b) => {
      const dateA = new Date(a.createdAt || a.updatedAt || 0);
      const dateB = new Date(b.createdAt || b.updatedAt || 0);
      
      if (sortDirection === 'latest') {
        return dateB - dateA; // Newest first
      } else {
        return dateA - dateB; // Oldest first
      }
    });
    
    console.log(`✅ Sorted by date (${sortDirection})`);
    return products;
  }
  
  // ✅ SORT BY CUSTOM ORDER (Sequence)
  else if (sortType === 'custom' && productOrder.length > 0) {
    console.log(`🎯 Applying custom order (${productOrder.length} products)`);
    
    const ordered = [];
    const unordered = [];
    
    // First, add products in custom order
    productOrder.forEach(productId => {
      const product = products.find(p => p.id === productId);
      if (product) {
        ordered.push(product);
      }
    });
    
    // Then, add any new products not in custom order
    products.forEach(product => {
      if (!productOrder.includes(product.id)) {
        unordered.push(product);
      }
    });
    
    const result = [...ordered, ...unordered];
    console.log(`✅ Custom order applied: ${ordered.length} custom + ${unordered.length} new`);
    return result;
  }
  
  // ✅ DEFAULT: Return as-is (no sorting)
  console.log('📦 No sort applied - using default order');
  return products;
}

/**
 * ==========================================
 * SORT MODAL & OPTIONS
 * ==========================================
 */

/**
 * Open sort options modal
 */
function openSortOptionsModal() {
  console.log('📋 Opening sort options modal...');
  
  const modal = new bootstrap.Modal(document.getElementById('sortOptionsModal'));
  modal.show();
}

/**
 * Toggle sort option (expand/collapse)
 */
function toggleSortOption(type) {
  const subOptions = document.getElementById(`sub-${type}`);
  const arrow = document.getElementById(`arrow-${type}`);
  
  // Close all other options
  ['name', 'date'].forEach(t => {
    if (t !== type) {
      const sub = document.getElementById(`sub-${t}`);
      const arr = document.getElementById(`arrow-${t}`);
      if (sub) sub.style.display = 'none';
      if (arr) arr.classList.remove('rotate');
    }
  });
  
  // Toggle current option
  if (subOptions.style.display === 'none') {
    subOptions.style.display = 'block';
    arrow.classList.add('rotate');
  } else {
    subOptions.style.display = 'none';
    arrow.classList.remove('rotate');
  }
}

/**
 * ==========================================
 * SORT BY NAME (A-Z or Z-A)
 * ==========================================
 */
function applySortByName(direction) {
  console.log(`🔤 Setting sort by name: ${direction}`);
  
  // ✅ DON'T sort cachedProducts directly - let getOrderedProducts() do it
  // Clear custom order
  localStorage.removeItem('product_custom_order');
  productOrder = [];
  
  // Save sort preference
  localStorage.setItem('product_sort_type', 'name');
  localStorage.setItem('product_sort_direction', direction);
  
  console.log('💾 Sort preference saved:', { type: 'name', direction });
  
  // Close modal
  const modal = bootstrap.Modal.getInstance(document.getElementById('sortOptionsModal'));
  if (modal) {
    modal.hide();
  }
  
  // Re-render (getOrderedProducts will apply the sort)
  renderProducts();
  
  console.log(`✅ Products will be sorted by name (${direction})`);
}

/**
 * ==========================================
 * SORT BY DATE (Latest or Oldest)
 * ==========================================
 */
function applySortByDate(direction) {
  console.log(`📅 Setting sort by date: ${direction}`);
  
  // ✅ DON'T sort cachedProducts directly - let getOrderedProducts() do it
  // Clear custom order
  localStorage.removeItem('product_custom_order');
  productOrder = [];
  
  // Save sort preference
  localStorage.setItem('product_sort_type', 'date');
  localStorage.setItem('product_sort_direction', direction);
  
  console.log('💾 Sort preference saved:', { type: 'date', direction });
  
  // Close modal
  const modal = bootstrap.Modal.getInstance(document.getElementById('sortOptionsModal'));
  if (modal) {
    modal.hide();
  }
  
  // Re-render (getOrderedProducts will apply the sort)
  renderProducts();
  
  console.log(`✅ Products will be sorted by date (${direction})`);
}

/**
 * ==========================================
 * SORT BY CUSTOM ORDER (Sequence Numbers)
 * ==========================================
 */

/**
 * Start custom order mode
 */
function startCustomOrderMode() {
  console.log('🎯 Starting custom order mode...');
  
  // Close sort modal
  const modal = bootstrap.Modal.getInstance(document.getElementById('sortOptionsModal'));
  if (modal) {
    modal.hide();
  }
  
  // Reset sequence
  customOrderSequence = [];
  customOrderMode = true;
  
  // Show action bar
  const actionBar = document.getElementById('customOrderActionBar');
  if (actionBar) {
    actionBar.style.display = 'flex';
  }
  
  // Disable save button initially
  const saveBtn = document.getElementById('saveCustomOrderBtn');
  if (saveBtn) {
    saveBtn.disabled = true;
  }
  
  // Add custom-order-active class to body
  document.body.classList.add('custom-order-active');
  
  // Enable product selection
  enableCustomOrderSelection();
  
  console.log('✅ Custom order mode activated - Click products to select');
}

/**
 * Enable product selection for custom order
 */
function enableCustomOrderSelection() {
  // Desktop table rows
  const tableRows = document.querySelectorAll('#productsTableBody tr[data-product-id]');
  tableRows.forEach(row => {
    row.onclick = function(event) {
      if (event.target.closest('.btn')) return; // Ignore button clicks
      toggleProductSequence(row);
    };
  });
  
  // Mobile cards
  const mobileCards = document.querySelectorAll('.mobile-item[data-product-id]');
  mobileCards.forEach(card => {
    card.onclick = function(event) {
      if (event.target.closest('.btn')) return; // Ignore button clicks
      toggleProductSequence(card);
    };
  });
}

/**
 * Toggle product in sequence (assign/remove number)
 */
function toggleProductSequence(element) {
  const productId = element.getAttribute('data-product-id');
  
  // Check if already in sequence
  const existingIndex = customOrderSequence.findIndex(item => item.id === productId);
  
  if (existingIndex !== -1) {
    // Remove from sequence
    customOrderSequence.splice(existingIndex, 1);
    console.log(`❌ Removed from sequence: ${productId}`);
  } else {
    // Add to sequence
    const order = customOrderSequence.length + 1;
    customOrderSequence.push({ id: productId, order });
    console.log(`✅ Added to sequence: ${productId} (#${order})`);
  }
  
  // Update UI
  updateSequenceUI();
  
  // Enable/disable save button
  const saveBtn = document.getElementById('saveCustomOrderBtn');
  if (saveBtn) {
    saveBtn.disabled = customOrderSequence.length === 0;
  }
}

/**
 * Update sequence numbers on UI (LEFT SIDE, GREEN)
 */
function updateSequenceUI() {
  // Remove all existing sequence badges
  document.querySelectorAll('.sequence-number').forEach(badge => badge.remove());
  
  // Add sequence badges to selected products
  customOrderSequence.forEach((item, index) => {
    const order = index + 1;
    
    // Desktop table - LEFT SIDE
    const tableRow = document.querySelector(`#productsTableBody tr[data-product-id="${item.id}"]`);
    if (tableRow) {
      const badge = document.createElement('div');
      badge.className = 'sequence-number';
      badge.textContent = order;
      
      // Ensure row has position relative
      tableRow.style.position = 'relative';
      tableRow.appendChild(badge);
    }
    
    // Mobile card - LEFT SIDE
    const mobileCard = document.querySelector(`.mobile-item[data-product-id="${item.id}"]`);
    if (mobileCard) {
      const badge = document.createElement('div');
      badge.className = 'sequence-number';
      badge.textContent = order;
      mobileCard.appendChild(badge);
    }
  });
  
  console.log(`🔢 Updated UI with ${customOrderSequence.length} sequence numbers`);
}

/**
 * Save custom order (FIXED - preserves previous sort for remaining products)
 */
 function saveCustomOrder() {
  if (customOrderSequence.length === 0) {
    alert('⚠️ Please select at least one product');
    return;
  }
  
  console.log('💾 Saving custom order...');
  
  // Create ordered product IDs array from sequence
  const orderedIds = customOrderSequence
    .sort((a, b) => a.order - b.order)
    .map(item => item.id);
  
  // ✅ FIX: Get remaining products from CURRENT sort order (not cachedProducts)
  const currentOrderedProducts = getOrderedProducts();
  
  // Filter out the custom selected products, keeping the rest in current order
  const remainingIds = currentOrderedProducts
    .filter(p => !orderedIds.includes(p.id))
    .map(p => p.id);
  
  console.log(`📊 Custom order: ${orderedIds.length} selected, ${remainingIds.length} remaining`);
  console.log(`  Selected:`, orderedIds);
  console.log(`  First 5 remaining:`, remainingIds.slice(0, 5));
  
  // Combine: custom ordered products first, then the rest (in their current sort order)
  const finalOrder = [...orderedIds, ...remainingIds];
  
  // Save to localStorage
  try {
    localStorage.setItem('product_custom_order', JSON.stringify(finalOrder));
    localStorage.setItem('product_sort_type', 'custom');
    
    // ✅ Also save the PREVIOUS sort info as fallback
    const previousSortType = localStorage.getItem('product_sort_type');
    const previousSortDirection = localStorage.getItem('product_sort_direction');
    
    if (previousSortType && previousSortType !== 'custom') {
      localStorage.setItem('product_previous_sort_type', previousSortType);
      localStorage.setItem('product_previous_sort_direction', previousSortDirection);
      console.log(`💾 Saved previous sort: ${previousSortType} (${previousSortDirection})`);
    }
    
    productOrder = finalOrder;
    
    console.log('✅ Custom order saved:', finalOrder.length, 'products');
    
    // Exit custom order mode
    cancelCustomOrder();
    
    // Re-render with new order
    renderProducts();
    
    alert(`✅ Custom order saved! ${orderedIds.length} products at top, remaining in ${previousSortType || 'default'} order.`);
    
  } catch (e) {
    console.error('❌ Failed to save custom order:', e);
    alert('❌ Failed to save order. Please try again.');
  }
}

/**
 * Cancel custom order mode
 */
function cancelCustomOrder() {
  console.log('✕ Cancelling custom order mode');
  
  customOrderMode = false;
  customOrderSequence = [];
  
  // Hide action bar
  const actionBar = document.getElementById('customOrderActionBar');
  if (actionBar) {
    actionBar.style.display = 'none';
  }
  
  // Remove custom-order-active class
  document.body.classList.remove('custom-order-active');
  
  // Remove all sequence badges
  document.querySelectorAll('.sequence-number').forEach(badge => badge.remove());
  
  // Remove click handlers
  const tableRows = document.querySelectorAll('#productsTableBody tr[data-product-id]');
  tableRows.forEach(row => {
    row.onclick = null;
    row.style.position = '';
  });
  
  const mobileCards = document.querySelectorAll('.mobile-item[data-product-id]');
  mobileCards.forEach(card => {
    card.onclick = null;
  });
  
  console.log('✅ Custom order mode cancelled');
}

/**
 * ==========================================
 * PAGE LOAD INITIALIZATION
 * ==========================================
 */
document.addEventListener('DOMContentLoaded', function() {
  console.log('✅ Page loaded - Initializing sort system');
  
  // Ensure custom order mode is off on page load
  customOrderMode = false;
  customOrderSequence = [];
  
  // Hide action bar
  const actionBar = document.getElementById('customOrderActionBar');
  if (actionBar) {
    actionBar.style.display = 'none';
  }
  
  // Remove custom-order-active class if present
  document.body.classList.remove('custom-order-active');
  
  console.log('✅ Sort system initialized');
});



console.log('✅ Brand Manager Module Loaded (Firebase)');

/**
 * ==========================================
 * DEBUG HELPER (Optional - can remove in production)
 * ==========================================
 */
function debugSortPreferences() {
  console.log('=== SORT PREFERENCES DEBUG ===');
  console.log('Sort type:', localStorage.getItem('product_sort_type'));
  console.log('Sort direction:', localStorage.getItem('product_sort_direction'));
  console.log('Custom order:', localStorage.getItem('product_custom_order'));
  console.log('productOrder variable:', productOrder);
  console.log('cachedProducts count:', cachedProducts ? cachedProducts.length : 0);
  
  if (cachedProducts && cachedProducts.length > 0) {
    const ordered = getOrderedProducts();
    console.log('Ordered products (first 5):', ordered.slice(0, 5).map(p => p.name));
  }
  console.log('==============================');
}

// Make debug function available in console
window.debugSortPreferences = debugSortPreferences;



/**
 * ==========================================
 * CATEGORY MANAGEMENT SYSTEM - FIREBASE VERSION
 * ==========================================
 */
/**
 * Load categories from Firestore and cache them
 */
 async function loadCategoryAutocompleteCache() {
  if (categoryCacheLoaded) {
    console.log('✅ Category cache already loaded');
    return;
  }
  
  const user = window.auth?.currentUser;
  
  if (!user) {
    console.log('⚠️ No user authenticated, skipping category cache load');
    return;
  }
  
  console.log('📥 Loading category autocomplete cache from Firestore...');
  
  try {
    const { collection, getDocs } = window.firebaseImports;
    
    const categoriesRef = collection(window.db, 'tenants', user.uid, 'categories');
    const snapshot = await getDocs(categoriesRef);
    
    const categories = [];
    snapshot.forEach((doc) => {
      const data = doc.data();
      const categoryName = data.name || data.categoryName;
      if (categoryName) {
        categories.push(categoryName);
      }
    });
    
    categoriesCache = categories;
    categoryAutocompleteCache = categories;
    categoryCacheLoaded = true;
    
    console.log('✅ Loaded', categories.length, 'categories into cache from Firestore');
    
  } catch (error) {
    console.error('❌ Error loading category cache from Firestore:', error);
    
    // Fallback: Extract from products
    try {
      const uniqueCategories = [...new Set(
        cachedProducts
          .map(p => p.category)
          .filter(c => c && c.trim() !== '')
      )];
      
      categoriesCache = uniqueCategories;
      categoryAutocompleteCache = uniqueCategories;
      categoryCacheLoaded = true;
      
      console.log('✅ Extracted', uniqueCategories.length, 'categories from products as fallback');
    } catch (fallbackError) {
      console.error('❌ Fallback category extraction failed:', fallbackError);
    }
  }
}
function navigateToCategories() {
  console.log('📂 Navigating to Categories');
  
  currentPage = 'categories';
  
  // Get page elements
  const mainApp = document.getElementById('mainApp');
  const allProductsPage = document.getElementById('allProductsPage');
  const productGroupsPage = document.getElementById('productGroupsPage');
  const customersPage = document.getElementById('customersPage');
  const groupDetailPage = document.getElementById('groupDetailPage');
  const brandsPage = document.getElementById('brandsPage');
  const sizesPage = document.getElementById('sizesPage');
  const categoriesPage = document.getElementById('categoriesPage');
  const unitTypesPage = document.getElementById('unitTypesPage');
  const vendorsPage = document.getElementById('vendorsPage');
  const invoiceCustomersPage = document.getElementById('invoiceCustomersPage'); // ✅ ADD THIS
  
  // Hide all other pages
  if (mainApp) {
    mainApp.style.display = 'none';
    mainApp.classList.remove('active');
  }
  
  if (allProductsPage) {
    allProductsPage.classList.remove('active');
    allProductsPage.style.display = 'none';
  }
  
  if (productGroupsPage) {
    productGroupsPage.classList.remove('active');
    productGroupsPage.style.display = 'none';
  }
  
  if (customersPage) {
    customersPage.classList.remove('active');
    customersPage.style.display = 'none';
  }
  
  if (groupDetailPage) {
    groupDetailPage.classList.remove('active');
    groupDetailPage.style.display = 'none';
  }
  
  if (brandsPage) {
    brandsPage.classList.remove('active');
    brandsPage.style.display = 'none';
  }
  
  if (sizesPage) {
    sizesPage.classList.remove('active');
    sizesPage.style.display = 'none';
  }
  
  if (unitTypesPage) {
    unitTypesPage.classList.remove('active');
    unitTypesPage.style.display = 'none';
  }
  
  if (vendorsPage) {
    vendorsPage.classList.remove('active');
    vendorsPage.style.display = 'none';
  }
  
  // ✅ ADD THIS - Hide invoice customers page
  if (invoiceCustomersPage) {
    invoiceCustomersPage.classList.remove('active');
    invoiceCustomersPage.style.display = 'none';
  }
  
  // ✅ Hide main app navbar
  const mainNavbar = document.getElementById('mainAppNavbar');
  if (mainNavbar) {
    mainNavbar.style.display = 'none';
  }
  
  const stickyNavbar = document.querySelector('.navbar.sticky-top');
  if (stickyNavbar) {
    stickyNavbar.style.display = 'none';
  }
  
  // Show categories page
  if (categoriesPage) {
    categoriesPage.classList.add('active');
    categoriesPage.style.display = 'block';
    categoriesPage.style.marginTop = '0';
    categoriesPage.style.paddingTop = '0';
    console.log('✅ Categories page displayed');
  } else {
    console.error('❌ categoriesPage element not found!');
    return;
  }
  
  // Load categories
  if (typeof loadCategories === 'function') {
    loadCategories();
  }
  
  // Close sidebar and scroll
  if (typeof closeSidebar === 'function') {
    closeSidebar();
  }
  
  window.scrollTo({ top: 0, behavior: 'smooth' });
}


/**
 * Load categories from Firebase
 */
 async function loadCategories() {
  try {
    console.log('📡 Fetching categories from Firebase...');
    
    const user = window.auth.currentUser;
    
    if (!user) {
      console.error('❌ No user authenticated');
      throw new Error('Please sign in first');
    }
    
    const { collection, getDocs } = window.firebaseImports;
    const userId = user.uid;
    
    const categoriesRef = collection(window.db, 'tenants', userId, 'categories');
    const categoriesSnap = await getDocs(categoriesRef);
    
    categoriesCache = [];
    categoriesSnap.forEach((doc) => {
      const data = doc.data();
      const categoryName = data.name || data.categoryName;
      if (categoryName) {
        categoriesCache.push(categoryName);
      }
    });
    
    console.log('✅ Loaded', categoriesCache.length, 'categories from Firebase');
    
    // Sync caches
    syncCategoryCaches();
    
    renderCategoriesList();
    
    // ✅ Update category dropdown in Add Product modal (if open)
    if (typeof populateCategoryDropdown === 'function') {
      populateCategoryDropdown();
    }
    
  } catch (error) {
    console.error('❌ Error loading categories:', error);
    
    const container = document.getElementById('categoriesListContainer');
    if (container) {
      container.innerHTML = `
        <div style="text-align:center; padding:40px; color:#dc3545;">
          <i class="bi bi-exclamation-circle" style="font-size:48px;"></i>
          <h4 style="margin-top:20px;">Error Loading Categories</h4>
          <p>${error.message}</p>
          <button class="btn btn-primary mt-3" onclick="loadCategories()">
            <i class="bi bi-arrow-clockwise"></i> Retry
          </button>
        </div>
      `;
    }
  }
}

/**
 * Render categories list
 */
function renderCategoriesList() {
  const container = document.getElementById('categoriesListContainer');
  const emptyState = document.getElementById('categoriesEmptyState');
  
  if (!container) return;
  
  if (categoriesCache.length === 0) {
    container.style.display = 'none';
    if (emptyState) emptyState.style.display = 'block';
    return;
  }
  
  container.style.display = 'grid';
  if (emptyState) emptyState.style.display = 'none';
  
  // Sort alphabetically
  const sortedCategories = [...categoriesCache].sort((a, b) => a.localeCompare(b));
  
  let html = '<div class="row g-3">';
  
  sortedCategories.forEach(category => {
    html += `
      <div class="col-12 col-sm-6 col-md-4 col-lg-3">
        <div class="card h-100" style="border-radius: 8px; transition: all 0.2s;">
          <div class="card-body d-flex align-items-center justify-content-between">
            <div>
              <h6 class="mb-0" style="font-weight: 600;">
                <i class="bi bi-grid-3x3-gap text-info"></i> ${category}
              </h6>
            </div>
            <button 
              class="btn btn-sm btn-outline-danger" 
              onclick="deleteCategory('${escapeHtml(category)}')"
              title="Delete">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  
  container.innerHTML = html;
}

/**
 * Filter categories (search)
 */
function filterCategories(query) {
  const cards = document.querySelectorAll('#categoriesListContainer .card');
  const lowerQuery = query.toLowerCase().trim();
  
  cards.forEach(card => {
    const text = card.textContent.toLowerCase();
    if (text.includes(lowerQuery)) {
      card.parentElement.style.display = 'block';
    } else {
      card.parentElement.style.display = 'none';
    }
  });
}

/**
 * Open Add Category Modal
 */
function openAddCategoryModal() {
  const modal = new bootstrap.Modal(document.getElementById('addCategoriesModal'));
  modal.show();
  
  // Clear previous data
  pendingCategories = [];
  updateCategoryPreviewList();
  
  // Focus on input
  setTimeout(() => {
    document.getElementById('categoryInput').focus();
  }, 300);
}

/**
 * Handle category input keydown (Enter or Comma)
 */
function handleCategoryInputKeydown(event) {
  const input = event.target;
  const value = input.value.trim();
  
  if (event.key === 'Enter' || event.key === ',') {
    event.preventDefault();
    
    if (!value || value.length === 0) {
      return;
    }
    
    if (pendingCategories.includes(value)) {
      alert('⚠️ Category already in list!');
      return;
    }
    
    pendingCategories.push(value);
    updateCategoryPreviewList();
    
    // Clear input
    input.value = '';
    window.lastCategoryInput = '';
    
    console.log('✅ Added category:', value);
  }
}

/**
 * Update category preview list
 */
function updateCategoryPreviewList() {
  const previewList = document.getElementById('categoryPreviewList');
  const previewCount = document.getElementById('categoryPreviewCount');
  
  if (pendingCategories.length === 0) {
    previewList.innerHTML = '<div style="padding: 15px; color: #999; text-align: center; font-size: 14px;">No categories added yet</div>';
    previewCount.textContent = '📝 Categories to Save (0):';
    return;
  }
  
  previewCount.textContent = `📝 Categories to Save (${pendingCategories.length}):`;
  
  let html = '';
  pendingCategories.forEach((category, index) => {
    html += `
      <div style="
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px;
        background: white;
        border-radius: 6px;
        margin-bottom: 8px;
        border: 1px solid #e0e0e0;
      ">
        <span style="font-weight: 500;"><i class="bi bi-grid-3x3-gap text-info"></i> ${category}</span>
        <button 
          onclick="removePendingCategory(${index})" 
          style="
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 18px;
          "
          title="Remove">
          <i class="bi bi-x-circle"></i>
        </button>
      </div>
    `;
  });
  
  previewList.innerHTML = html;
}

/**
 * Remove pending category
 */
function removePendingCategory(index) {
  const removed = pendingCategories.splice(index, 1);
  console.log('🗑️ Removed:', removed[0]);
  updateCategoryPreviewList();
}
/**
 * Save all categories to Firebase
 */
 async function saveAllCategories() {
  if (pendingCategories.length === 0) {
    alert('⚠️ Please add at least one category');
    return;
  }
  
  console.log('💾 Saving', pendingCategories.length, 'categories...');
  
  const user = window.auth.currentUser;
  
  if (!user) {
    alert('❌ Please sign in first');
    return;
  }
  
  try {
    const { collection, addDoc } = window.firebaseImports;
    const userId = user.uid;
    
    let successCount = 0;
    let skipCount = 0;
    
    for (const category of pendingCategories) {
      // Check if already exists
      if (categoriesCache.includes(category)) {
        skipCount++;
        console.log('⚠️ Skipped (already exists):', category);
        continue;
      }
      
      // Save to Firestore
      const categoriesRef = collection(window.db, 'tenants', userId, 'categories');
      await addDoc(categoriesRef, {
        name: category,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        userId: userId
      });
      
      successCount++;
      console.log('✅ Saved:', category);
    }
    
    console.log(`✅ Complete: ${successCount} saved, ${skipCount} skipped`);
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('addCategoriesModal'));
    if (modal) modal.hide();
    
    // Reload categories
    await loadCategories();
    
    // ✅ Update dropdown in Add Product modal
    if (typeof populateCategoryDropdown === 'function') {
      populateCategoryDropdown();
    }
    
    // Show result
    if (skipCount > 0) {
      alert(`✅ Saved ${successCount} category(ies)\nℹ️ ${skipCount} already existed`);
    } else {
      alert(`✅ Successfully saved ${successCount} category(ies)!`);
    }
    
  } catch (error) {
    console.error('❌ Error saving categories:', error);
    alert('❌ Error saving categories: ' + error.message);
  }
}

/**
 * Delete category
 */
async function deleteCategory(categoryName) {
  if (!confirm(`Delete category "${categoryName}"?`)) {
    return;
  }
  
  try {
    const user = window.auth.currentUser;
    if (!user) throw new Error('Not authenticated');
    
    const { collection, getDocs, deleteDoc, doc } = window.firebaseImports;
    const userId = user.uid;
    
    // Find and delete
    const categoriesRef = collection(window.db, 'tenants', userId, 'categories');
    const snapshot = await getDocs(categoriesRef);
    
    let deleted = false;
    for (const docSnapshot of snapshot.docs) {
      const data = docSnapshot.data();
      if ((data.name || data.categoryName) === categoryName) {
        await deleteDoc(doc(window.db, 'tenants', userId, 'categories', docSnapshot.id));
        deleted = true;
        break;
      }
    }
    
    if (deleted) {
      console.log('✅ Deleted category:', categoryName);
      await loadCategories();
    } else {
      console.warn('⚠️ Category not found:', categoryName);
    }
    
  } catch (error) {
    console.error('❌ Error deleting category:', error);
    alert('❌ Error deleting category: ' + error.message);
  }
}

/**
 * Sync category caches
 */
function syncCategoryCaches() {
  console.log('🔄 Syncing category caches...');
  categoryAutocompleteCache = [...categoriesCache];
  categoryAutocompleteCache = [...new Set(categoryAutocompleteCache)];
  console.log('✅ Sync complete -', categoryAutocompleteCache.length, 'categories');
}

/**
 * ==========================================
 * ADD PRODUCT MODAL - CATEGORY AUTOCOMPLETE
 * ==========================================
 */



// Make functions global
window.navigateToCategories = navigateToCategories;
window.loadCategories = loadCategories;
window.loadCategoryAutocompleteCache = loadCategoryAutocompleteCache;
window.renderCategoriesList = renderCategoriesList;
window.filterCategories = filterCategories;
window.openAddCategoryModal = openAddCategoryModal;
window.handleCategoryInputKeydown = handleCategoryInputKeydown;
window.updateCategoryPreviewList = updateCategoryPreviewList;
window.removePendingCategory = removePendingCategory;
window.saveAllCategories = saveAllCategories;
window.deleteCategory = deleteCategory;
window.syncCategoryCaches = syncCategoryCaches;


console.log('✅ Category management system loaded');




/**
 * ==========================================
 * UNIT TYPE MANAGEMENT SYSTEM - FIREBASE VERSION
 * ==========================================
 */

/**
 * Load unit types from Firestore and cache them
 */
 async function loadUnitTypeAutocompleteCache() {
  if (unitTypeCacheLoaded) {
    console.log('✅ Unit type cache already loaded');
    return;
  }
  
  const user = window.auth?.currentUser;
  
  if (!user) {
    console.log('⚠️ No user authenticated, skipping unit type cache load');
    return;
  }
  
  console.log('📥 Loading unit type autocomplete cache from Firestore...');
  
  try {
    const { collection, getDocs } = window.firebaseImports;
    
    const unitTypesRef = collection(window.db, 'tenants', user.uid, 'unitTypes');
    const snapshot = await getDocs(unitTypesRef);
    
    const unitTypes = [];
    snapshot.forEach((doc) => {
      const data = doc.data();
      const unitTypeName = data.name || data.unitTypeName;
      if (unitTypeName) {
        unitTypes.push(unitTypeName);
      }
    });
    
    unitTypesCache = unitTypes;
    unitTypeAutocompleteCache = unitTypes;
    unitTypeCacheLoaded = true;
    
    console.log('✅ Loaded', unitTypes.length, 'unit types into cache from Firestore');
    
  } catch (error) {
    console.error('❌ Error loading unit type cache from Firestore:', error);
    
    // Fallback: Extract from products
    try {
      const uniqueUnitTypes = [...new Set(
        cachedProducts
          .map(p => p.unitType)
          .filter(u => u && u.trim() !== '')
      )];
      
      unitTypesCache = uniqueUnitTypes;
      unitTypeAutocompleteCache = uniqueUnitTypes;
      unitTypeCacheLoaded = true;
      
      console.log('✅ Extracted', uniqueUnitTypes.length, 'unit types from products as fallback');
    } catch (fallbackError) {
      console.error('❌ Fallback unit type extraction failed:', fallbackError);
    }
  }
}
function navigateToUnitTypes() {
  console.log('📦 Navigating to Unit Types');
  
  currentPage = 'unitTypes';
  
  // Get page elements
  const mainApp = document.getElementById('mainApp');
  const allProductsPage = document.getElementById('allProductsPage');
  const productGroupsPage = document.getElementById('productGroupsPage');
  const customersPage = document.getElementById('customersPage');
  const groupDetailPage = document.getElementById('groupDetailPage');
  const brandsPage = document.getElementById('brandsPage');
  const sizesPage = document.getElementById('sizesPage');
  const categoriesPage = document.getElementById('categoriesPage');
  const unitTypesPage = document.getElementById('unitTypesPage');
  const vendorsPage = document.getElementById('vendorsPage');
  const invoiceCustomersPage = document.getElementById('invoiceCustomersPage'); // ✅ ADD THIS
  
  // Hide all other pages
  if (mainApp) {
    mainApp.style.display = 'none';
    mainApp.classList.remove('active');
  }
  
  if (allProductsPage) {
    allProductsPage.classList.remove('active');
    allProductsPage.style.display = 'none';
  }
  
  if (productGroupsPage) {
    productGroupsPage.classList.remove('active');
    productGroupsPage.style.display = 'none';
  }
  
  if (customersPage) {
    customersPage.classList.remove('active');
    customersPage.style.display = 'none';
  }
  
  if (groupDetailPage) {
    groupDetailPage.classList.remove('active');
    groupDetailPage.style.display = 'none';
  }
  
  if (brandsPage) {
    brandsPage.classList.remove('active');
    brandsPage.style.display = 'none';
  }
  
  if (sizesPage) {
    sizesPage.classList.remove('active');
    sizesPage.style.display = 'none';
  }
  
  if (categoriesPage) {
    categoriesPage.classList.remove('active');
    categoriesPage.style.display = 'none';
  }
  
  if (vendorsPage) {
    vendorsPage.classList.remove('active');
    vendorsPage.style.display = 'none';
  }
  
  // ✅ ADD THIS - Hide invoice customers page
  if (invoiceCustomersPage) {
    invoiceCustomersPage.classList.remove('active');
    invoiceCustomersPage.style.display = 'none';
  }
  
  // ✅ Hide main app navbar
  const mainNavbar = document.getElementById('mainAppNavbar');
  if (mainNavbar) {
    mainNavbar.style.display = 'none';
  }
  
  const stickyNavbar = document.querySelector('.navbar.sticky-top');
  if (stickyNavbar) {
    stickyNavbar.style.display = 'none';
  }
  
  // Show unit types page
  if (unitTypesPage) {
    unitTypesPage.classList.add('active');
    unitTypesPage.style.display = 'block';
    unitTypesPage.style.marginTop = '0';
    unitTypesPage.style.paddingTop = '0';
    console.log('✅ Unit Types page displayed');
  } else {
    console.error('❌ unitTypesPage element not found!');
    return;
  }
  
  // Load unit types
  if (typeof loadUnitTypes === 'function') {
    loadUnitTypes();
  }
  
  // Close sidebar and scroll
  if (typeof closeSidebar === 'function') {
    closeSidebar();
  }
  
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

/**
 * Load unit types from Firebase
 */
async function loadUnitTypes() {
  try {
    console.log('📡 Fetching unit types from Firebase...');
    
    const user = window.auth.currentUser;
    
    if (!user) {
      console.error('❌ No user authenticated');
      throw new Error('Please sign in first');
    }
    
    const { collection, getDocs } = window.firebaseImports;
    const userId = user.uid;
    
    const unitTypesRef = collection(window.db, 'tenants', userId, 'unitTypes');
    const unitTypesSnap = await getDocs(unitTypesRef);
    
    unitTypesCache = [];
    unitTypesSnap.forEach((doc) => {
      const data = doc.data();
      const unitTypeName = data.name || data.unitTypeName;
      if (unitTypeName) {
        unitTypesCache.push(unitTypeName);
      }
    });
    
    console.log('✅ Loaded', unitTypesCache.length, 'unit types from Firebase');
    
    // Sync caches
    syncUnitTypeCaches();
    
    renderUnitTypesList();
    
    // Update dropdown in Add Product modal (if open)
    if (typeof populateUnitTypeDropdown === 'function') {
      populateUnitTypeDropdown();
    }
    
  } catch (error) {
    console.error('❌ Error loading unit types:', error);
    
    const container = document.getElementById('unitTypesListContainer');
    if (container) {
      container.innerHTML = `
        <div style="text-align:center; padding:40px; color:#dc3545;">
          <i class="bi bi-exclamation-circle" style="font-size:48px;"></i>
          <h4 style="margin-top:20px;">Error Loading Unit Types</h4>
          <p>${error.message}</p>
          <button class="btn btn-primary mt-3" onclick="loadUnitTypes()">
            <i class="bi bi-arrow-clockwise"></i> Retry
          </button>
        </div>
      `;
    }
  }
}

/**
 * Render unit types list
 */
function renderUnitTypesList() {
  const container = document.getElementById('unitTypesListContainer');
  const emptyState = document.getElementById('unitTypesEmptyState');
  
  if (!container) return;
  
  if (unitTypesCache.length === 0) {
    container.style.display = 'none';
    if (emptyState) emptyState.style.display = 'block';
    return;
  }
  
  container.style.display = 'grid';
  if (emptyState) emptyState.style.display = 'none';
  
  // Sort alphabetically
  const sortedUnitTypes = [...unitTypesCache].sort((a, b) => a.localeCompare(b));
  
  let html = '<div class="row g-3">';
  
  sortedUnitTypes.forEach(unitType => {
    html += `
      <div class="col-12 col-sm-6 col-md-4 col-lg-3">
        <div class="card h-100" style="border-radius: 8px; transition: all 0.2s;">
          <div class="card-body d-flex align-items-center justify-content-between">
            <div>
              <h6 class="mb-0" style="font-weight: 600;">
                <i class="bi bi-card-text text-warning"></i> ${unitType}
              </h6>
            </div>
            <button 
              class="btn btn-sm btn-outline-danger" 
              onclick="deleteUnitType('${escapeHtml(unitType)}')"
              title="Delete">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  
  container.innerHTML = html;
}

/**
 * Filter unit types (search)
 */
function filterUnitTypes(query) {
  const cards = document.querySelectorAll('#unitTypesListContainer .card');
  const lowerQuery = query.toLowerCase().trim();
  
  cards.forEach(card => {
    const text = card.textContent.toLowerCase();
    if (text.includes(lowerQuery)) {
      card.parentElement.style.display = 'block';
    } else {
      card.parentElement.style.display = 'none';
    }
  });
}

/**
 * Open Add Unit Type Modal
 */
function openAddUnitTypeModal() {
  const modal = new bootstrap.Modal(document.getElementById('addUnitTypesModal'));
  modal.show();
  
  // Clear previous data
  pendingUnitTypes = [];
  updateUnitTypePreviewList();
  
  // Focus on input
  setTimeout(() => {
    document.getElementById('unitTypeInput').focus();
  }, 300);
}

/**
 * Handle unit type input keydown (Enter or Comma)
 */
function handleUnitTypeInputKeydown(event) {
  const input = event.target;
  const value = input.value.trim();
  
  if (event.key === 'Enter' || event.key === ',') {
    event.preventDefault();
    
    if (!value || value.length === 0) {
      return;
    }
    
    if (pendingUnitTypes.includes(value)) {
      alert('⚠️ Unit type already in list!');
      return;
    }
    
    pendingUnitTypes.push(value);
    updateUnitTypePreviewList();
    
    // Clear input
    input.value = '';
    window.lastUnitTypeInput = '';
    
    console.log('✅ Added unit type:', value);
  }
}

/**
 * Update unit type preview list
 */
function updateUnitTypePreviewList() {
  const previewList = document.getElementById('unitTypePreviewList');
  const previewCount = document.getElementById('unitTypePreviewCount');
  
  if (pendingUnitTypes.length === 0) {
    previewList.innerHTML = '<div style="padding: 15px; color: #999; text-align: center; font-size: 14px;">No unit types added yet</div>';
    previewCount.textContent = '📝 Unit Types to Save (0):';
    return;
  }
  
  previewCount.textContent = `📝 Unit Types to Save (${pendingUnitTypes.length}):`;
  
  let html = '';
  pendingUnitTypes.forEach((unitType, index) => {
    html += `
      <div style="
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px;
        background: white;
        border-radius: 6px;
        margin-bottom: 8px;
        border: 1px solid #e0e0e0;
      ">
        <span style="font-weight: 500;"><i class="bi bi-card-text text-warning"></i> ${unitType}</span>
        <button 
          onclick="removePendingUnitType(${index})" 
          style="
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 18px;
          "
          title="Remove">
          <i class="bi bi-x-circle"></i>
        </button>
      </div>
    `;
  });
  
  previewList.innerHTML = html;
}

/**
 * Remove pending unit type
 */
function removePendingUnitType(index) {
  const removed = pendingUnitTypes.splice(index, 1);
  console.log('🗑️ Removed:', removed[0]);
  updateUnitTypePreviewList();
}

/**
 * Save all unit types to Firebase
 */
async function saveAllUnitTypes() {
  if (pendingUnitTypes.length === 0) {
    alert('⚠️ Please add at least one unit type');
    return;
  }
  
  console.log('💾 Saving', pendingUnitTypes.length, 'unit types...');
  
  const user = window.auth.currentUser;
  
  if (!user) {
    alert('❌ Please sign in first');
    return;
  }
  
  try {
    const { collection, addDoc } = window.firebaseImports;
    const userId = user.uid;
    
    let successCount = 0;
    let skipCount = 0;
    
    for (const unitType of pendingUnitTypes) {
      // Check if already exists
      if (unitTypesCache.includes(unitType)) {
        skipCount++;
        console.log('⚠️ Skipped (already exists):', unitType);
        continue;
      }
      
      // Save to Firestore
      const unitTypesRef = collection(window.db, 'tenants', userId, 'unitTypes');
      await addDoc(unitTypesRef, {
        name: unitType,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        userId: userId
      });
      
      successCount++;
      console.log('✅ Saved:', unitType);
    }
    
    console.log(`✅ Complete: ${successCount} saved, ${skipCount} skipped`);
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('addUnitTypesModal'));
    if (modal) modal.hide();
    
    // Reload unit types
    await loadUnitTypes();
    
    // Update dropdown in Add Product modal
    if (typeof populateUnitTypeDropdown === 'function') {
      populateUnitTypeDropdown();
    }
    
    // Show result
    if (skipCount > 0) {
      alert(`✅ Saved ${successCount} unit type(s)\nℹ️ ${skipCount} already existed`);
    } else {
      alert(`✅ Successfully saved ${successCount} unit type(s)!`);
    }
    
  } catch (error) {
    console.error('❌ Error saving unit types:', error);
    alert('❌ Error saving unit types: ' + error.message);
  }
}

/**
 * Delete unit type
 */
async function deleteUnitType(unitTypeName) {
  if (!confirm(`Delete unit type "${unitTypeName}"?`)) {
    return;
  }
  
  try {
    const user = window.auth.currentUser;
    if (!user) throw new Error('Not authenticated');
    
    const { collection, getDocs, deleteDoc, doc } = window.firebaseImports;
    const userId = user.uid;
    
    // Find and delete
    const unitTypesRef = collection(window.db, 'tenants', userId, 'unitTypes');
    const snapshot = await getDocs(unitTypesRef);
    
    let deleted = false;
    for (const docSnapshot of snapshot.docs) {
      const data = docSnapshot.data();
      if ((data.name || data.unitTypeName) === unitTypeName) {
        await deleteDoc(doc(window.db, 'tenants', userId, 'unitTypes', docSnapshot.id));
        deleted = true;
        break;
      }
    }
    
    if (deleted) {
      console.log('✅ Deleted unit type:', unitTypeName);
      await loadUnitTypes();
    } else {
      console.warn('⚠️ Unit type not found:', unitTypeName);
    }
    
  } catch (error) {
    console.error('❌ Error deleting unit type:', error);
    alert('❌ Error deleting unit type: ' + error.message);
  }
}

/**
 * Sync unit type caches
 */
function syncUnitTypeCaches() {
  console.log('🔄 Syncing unit type caches...');
  unitTypeAutocompleteCache = [...unitTypesCache];
  unitTypeAutocompleteCache = [...new Set(unitTypeAutocompleteCache)];
  console.log('✅ Sync complete -', unitTypeAutocompleteCache.length, 'unit types');
}

/**
 * ==========================================
 * ADD PRODUCT MODAL - UNIT TYPE DROPDOWN
 * ==========================================
 */

/**
 * Populate unit type dropdown with unit types from cache
 */
async function populateUnitTypeDropdown() {
  const unitTypeSelect = document.getElementById('unitType');
  
  if (!unitTypeSelect) {
    console.warn('⚠️ Unit type dropdown not found');
    return;
  }
  
  // Load unit types if cache is empty
  if ((!unitTypesCache || unitTypesCache.length === 0) && !unitTypeCacheLoaded) {
    console.log('📥 Unit types not loaded, loading now...');
    
    const user = window.auth?.currentUser;
    if (user) {
      try {
        const { collection, getDocs } = window.firebaseImports;
        const unitTypesRef = collection(window.db, 'tenants', user.uid, 'unitTypes');
        const snapshot = await getDocs(unitTypesRef);
        
        const unitTypes = [];
        snapshot.forEach((doc) => {
          const data = doc.data();
          const unitTypeName = data.name || data.unitTypeName;
          if (unitTypeName) unitTypes.push(unitTypeName);
        });
        
        unitTypesCache = unitTypes;
        unitTypeAutocompleteCache = unitTypes;
        unitTypeCacheLoaded = true;
        
        console.log('✅ Loaded', unitTypes.length, 'unit types');
      } catch (error) {
        console.error('❌ Error loading unit types:', error);
      }
    }
  }
  
  // Clear existing options except the first (placeholder)
  unitTypeSelect.innerHTML = '<option value="">Select Unit Type</option>';
  
  // Check if unit types are loaded
  if (!unitTypesCache || unitTypesCache.length === 0) {
    console.log('⚠️ No unit types found in cache');
    unitTypeSelect.innerHTML = `
      <option value="">No unit types available</option>
      <option value="" disabled>➜ Add unit types from sidebar menu</option>
    `;
    return;
  }
  
  // Sort unit types alphabetically
  const sortedUnitTypes = [...unitTypesCache].sort((a, b) => a.localeCompare(b));
  
  // Add each unit type as an option
  sortedUnitTypes.forEach(unitType => {
    const option = document.createElement('option');
    option.value = unitType;
    option.textContent = unitType;
    unitTypeSelect.appendChild(option);
  });
  
  console.log('✅ Populated unit type dropdown with', sortedUnitTypes.length, 'unit types');
}


/**
 * ==========================================
 * SIZE MANAGEMENT SYSTEM - FIREBASE VERSION
 * ==========================================
 */



/**
 * Load sizes from Firestore and cache them
 */
async function loadSizeAutocompleteCache() {
  if (sizeCacheLoaded) {
    console.log('✅ Size cache already loaded');
    return;
  }
  
  const user = window.auth.currentUser;
  
  if (!user) {
    console.log('No user authenticated, skipping size cache load');
    return;
  }
  
  console.log('📥 Loading size autocomplete cache from Firestore...');
  
  try {
    const { collection, getDocs } = window.firebaseImports;
    
    const sizesRef = collection(window.db, 'tenants', user.uid, 'sizes');
    const snapshot = await getDocs(sizesRef);
    
    const sizes = [];
    snapshot.forEach((doc) => {
      const data = doc.data();
      const sizeName = data.name || data.sizeName;
      if (sizeName) {
        sizes.push(sizeName);
      }
    });
    
    sizeAutocompleteCache = sizes;
    sizeCacheLoaded = true;
    
    console.log('✅ Loaded', sizes.length, 'sizes into cache from Firestore');
    
  } catch (error) {
    console.error('❌ Error loading size cache from Firestore:', error);
    
    // Fallback: Extract from products
    try {
      const uniqueSizes = [...new Set(
        cachedProducts
          .map(p => p.size)
          .filter(s => s && s.trim() !== '')
      )];
      
      sizeAutocompleteCache = uniqueSizes;
      sizeCacheLoaded = true;
      
      console.log('✅ Extracted', uniqueSizes.length, 'sizes from products as fallback');
    } catch (fallbackError) {
      console.error('❌ Fallback size extraction failed:', fallbackError);
    }
  }
}
function navigateToSizes() {
  console.log('📏 Navigating to Sizes');
  
  currentPage = 'sizes';
  
  // Get page elements
  const mainApp = document.getElementById('mainApp');
  const allProductsPage = document.getElementById('allProductsPage');
  const productGroupsPage = document.getElementById('productGroupsPage');
  const customersPage = document.getElementById('customersPage');
  const groupDetailPage = document.getElementById('groupDetailPage');
  const brandsPage = document.getElementById('brandsPage');
  const sizesPage = document.getElementById('sizesPage');
  const categoriesPage = document.getElementById('categoriesPage');
  const unitTypesPage = document.getElementById('unitTypesPage');
  const vendorsPage = document.getElementById('vendorsPage');
  const invoiceCustomersPage = document.getElementById('invoiceCustomersPage'); // ✅ ADD THIS
  
  // Hide all other pages
  if (mainApp) {
    mainApp.style.display = 'none';
    mainApp.classList.remove('active');
  }
  
  if (allProductsPage) {
    allProductsPage.classList.remove('active');
    allProductsPage.style.display = 'none';
  }
  
  if (productGroupsPage) {
    productGroupsPage.classList.remove('active');
    productGroupsPage.style.display = 'none';
  }
  
  if (customersPage) {
    customersPage.classList.remove('active');
    customersPage.style.display = 'none';
  }
  
  if (groupDetailPage) {
    groupDetailPage.classList.remove('active');
    groupDetailPage.style.display = 'none';
  }
  
  if (brandsPage) {
    brandsPage.classList.remove('active');
    brandsPage.style.display = 'none';
  }
  
  if (categoriesPage) {
    categoriesPage.classList.remove('active');
    categoriesPage.style.display = 'none';
  }
  
  if (unitTypesPage) {
    unitTypesPage.classList.remove('active');
    unitTypesPage.style.display = 'none';
  }
  
  if (vendorsPage) {
    vendorsPage.classList.remove('active');
    vendorsPage.style.display = 'none';
  }
  
  // ✅ ADD THIS - Hide invoice customers page
  if (invoiceCustomersPage) {
    invoiceCustomersPage.classList.remove('active');
    invoiceCustomersPage.style.display = 'none';
  }
  
  // ✅ Hide main app navbar
  const mainNavbar = document.getElementById('mainAppNavbar');
  if (mainNavbar) {
    mainNavbar.style.display = 'none';
  }
  
  const stickyNavbar = document.querySelector('.navbar.sticky-top');
  if (stickyNavbar) {
    stickyNavbar.style.display = 'none';
  }
  
  // Show sizes page
  if (sizesPage) {
    sizesPage.classList.add('active');
    sizesPage.style.display = 'block';
    sizesPage.style.marginTop = '0';
    sizesPage.style.paddingTop = '0';
    console.log('✅ Sizes page displayed');
  } else {
    console.error('❌ sizesPage element not found!');
    return;
  }
  
  // Load sizes
  if (typeof loadSizes === 'function') {
    loadSizes();
  }
  
  // Close sidebar and scroll
  if (typeof closeSidebar === 'function') {
    closeSidebar();
  }
  
  window.scrollTo({ top: 0, behavior: 'smooth' });
}


/**
 * Load sizes from Firebase
 */
async function loadSizes() {
  try {
    console.log('📡 Fetching sizes from Firebase...');
    
    const user = window.auth.currentUser;
    
    if (!user) {
      console.error('❌ No user authenticated');
      throw new Error('Please sign in first');
    }
    
    const { collection, getDocs } = window.firebaseImports;
    const userId = user.uid;
    
    const sizesRef = collection(window.db, 'tenants', userId, 'sizes');
    const sizesSnap = await getDocs(sizesRef);
    
    sizesCache = [];
    sizesSnap.forEach((doc) => {
      const data = doc.data();
      const sizeName = data.name || data.sizeName;
      if (sizeName) {
        sizesCache.push(sizeName);
      }
    });
    
    console.log('✅ Loaded', sizesCache.length, 'sizes from Firebase');
    
    // Sync caches
    syncSizeCaches();
    
    renderSizesList();
    
  } catch (error) {
    console.error('❌ Error loading sizes:', error);
    
    const container = document.getElementById('sizesListContainer');
    if (container) {
      container.innerHTML = `
        <div style="text-align:center; padding:40px; color:#dc3545;">
          <i class="bi bi-exclamation-circle" style="font-size:48px;"></i>
          <h4 style="margin-top:20px;">Error Loading Sizes</h4>
          <p>${error.message}</p>
          <button class="btn btn-primary mt-3" onclick="loadSizes()">
            <i class="bi bi-arrow-clockwise"></i> Retry
          </button>
        </div>
      `;
    }
  }
}

/**
 * Render sizes list
 */
function renderSizesList() {
  const container = document.getElementById('sizesListContainer');
  const emptyState = document.getElementById('sizesEmptyState');
  
  if (!container) return;
  
  if (sizesCache.length === 0) {
    container.style.display = 'none';
    if (emptyState) emptyState.style.display = 'block';
    return;
  }
  
  container.style.display = 'grid';
  if (emptyState) emptyState.style.display = 'none';
  
  // Sort alphabetically
  const sortedSizes = [...sizesCache].sort((a, b) => a.localeCompare(b));
  
  let html = '<div class="row g-3">';
  
  sortedSizes.forEach(size => {
    html += `
      <div class="col-12 col-sm-6 col-md-4 col-lg-3">
        <div class="card h-100" style="border-radius: 8px; transition: all 0.2s;">
          <div class="card-body d-flex align-items-center justify-content-between">
            <div>
              <h6 class="mb-0" style="font-weight: 600;">
                <i class="bi bi-rulers text-primary"></i> ${size}
              </h6>
            </div>
            <button 
              class="btn btn-sm btn-outline-danger" 
              onclick="deleteSize('${escapeHtml(size)}')"
              title="Delete">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  
  container.innerHTML = html;
}

/**
 * Filter sizes (search)
 */
function filterSizes(query) {
  const cards = document.querySelectorAll('#sizesListContainer .card');
  const lowerQuery = query.toLowerCase().trim();
  
  cards.forEach(card => {
    const text = card.textContent.toLowerCase();
    if (text.includes(lowerQuery)) {
      card.parentElement.style.display = 'block';
    } else {
      card.parentElement.style.display = 'none';
    }
  });
}

/**
 * Open Add Size Modal
 */
function openAddSizeModal() {
  const modal = new bootstrap.Modal(document.getElementById('addSizesModal'));
  modal.show();
  
  // Clear previous data
  pendingSizes = [];
  updateSizePreviewList();
  
  // Focus on input
  setTimeout(() => {
    document.getElementById('sizeInput').focus();
  }, 300);
}

/**
 * Handle size input keydown (Enter or Comma)
 */
function handleSizeInputKeydown(event) {
  const input = event.target;
  const value = input.value.trim();
  
  if (event.key === 'Enter' || event.key === ',') {
    event.preventDefault();
    
    if (!value || value.length === 0) {
      return;
    }
    
    if (pendingSizes.includes(value)) {
      alert('⚠️ Size already in list!');
      return;
    }
    
    pendingSizes.push(value);
    updateSizePreviewList();
    
    // Clear input
    input.value = '';
    window.lastSizeInput = '';
    
    console.log('✅ Added size:', value);
  }
}

/**
 * Update size preview list
 */
function updateSizePreviewList() {
  const previewList = document.getElementById('sizePreviewList');
  const previewCount = document.getElementById('sizePreviewCount');
  
  if (pendingSizes.length === 0) {
    previewList.innerHTML = '<div style="padding: 15px; color: #999; text-align: center; font-size: 14px;">No sizes added yet</div>';
    previewCount.textContent = '📝 Sizes to Save (0):';
    return;
  }
  
  previewCount.textContent = `📝 Sizes to Save (${pendingSizes.length}):`;
  
  let html = '';
  pendingSizes.forEach((size, index) => {
    html += `
      <div style="
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px;
        background: white;
        border-radius: 6px;
        margin-bottom: 8px;
        border: 1px solid #e0e0e0;
      ">
        <span style="font-weight: 500;"><i class="bi bi-rulers text-primary"></i> ${size}</span>
        <button 
          onclick="removePendingSize(${index})" 
          style="
            background: none;
            border: none;
            color: #dc3545;
            cursor: pointer;
            font-size: 18px;
          "
          title="Remove">
          <i class="bi bi-x-circle"></i>
        </button>
      </div>
    `;
  });
  
  previewList.innerHTML = html;
}

/**
 * Remove pending size
 */
function removePendingSize(index) {
  const removed = pendingSizes.splice(index, 1);
  console.log('🗑️ Removed:', removed[0]);
  updateSizePreviewList();
}

/**
 * Save all sizes to Firebase
 */
async function saveAllSizes() {
  if (pendingSizes.length === 0) {
    alert('⚠️ Please add at least one size');
    return;
  }
  
  console.log('💾 Saving', pendingSizes.length, 'sizes...');
  
  const user = window.auth.currentUser;
  
  if (!user) {
    alert('❌ Please sign in first');
    return;
  }
  
  try {
    const { collection, addDoc } = window.firebaseImports;
    const userId = user.uid;
    
    let successCount = 0;
    let skipCount = 0;
    
    for (const size of pendingSizes) {
      // Check if already exists
      if (sizesCache.includes(size)) {
        skipCount++;
        console.log('⚠️ Skipped (already exists):', size);
        continue;
      }
      
      // Save to Firestore
      const sizesRef = collection(window.db, 'tenants', userId, 'sizes');
      await addDoc(sizesRef, {
        name: size,
        createdAt: new Date().toISOString(),
        updatedAt: new Date().toISOString(),
        userId: userId
      });
      
      successCount++;
      console.log('✅ Saved:', size);
    }
    
    console.log(`✅ Complete: ${successCount} saved, ${skipCount} skipped`);
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('addSizesModal'));
    if (modal) modal.hide();
    
    // Reload sizes
    await loadSizes();
    
    // Show result
    if (skipCount > 0) {
      alert(`✅ Saved ${successCount} size(s)\nℹ️ ${skipCount} already existed`);
    } else {
      alert(`✅ Successfully saved ${successCount} size(s)!`);
    }
    
  } catch (error) {
    console.error('❌ Error saving sizes:', error);
    alert('❌ Error saving sizes: ' + error.message);
  }
}

/**
 * Delete size
 */
async function deleteSize(sizeName) {
  if (!confirm(`Delete size "${sizeName}"?`)) {
    return;
  }
  
  try {
    const user = window.auth.currentUser;
    if (!user) throw new Error('Not authenticated');
    
    const { collection, getDocs, deleteDoc, doc } = window.firebaseImports;
    const userId = user.uid;
    
    // Find and delete
    const sizesRef = collection(window.db, 'tenants', userId, 'sizes');
    const snapshot = await getDocs(sizesRef);
    
    let deleted = false;
    for (const docSnapshot of snapshot.docs) {
      const data = docSnapshot.data();
      if ((data.name || data.sizeName) === sizeName) {
        await deleteDoc(doc(window.db, 'tenants', userId, 'sizes', docSnapshot.id));
        deleted = true;
        break;
      }
    }
    
    if (deleted) {
      console.log('✅ Deleted size:', sizeName);
      await loadSizes();
    } else {
      console.warn('⚠️ Size not found:', sizeName);
    }
    
  } catch (error) {
    console.error('❌ Error deleting size:', error);
    alert('❌ Error deleting size: ' + error.message);
  }
}

/**
 * Sync size caches
 */
function syncSizeCaches() {
  console.log('🔄 Syncing size caches...');
  sizeAutocompleteCache = [...sizesCache];
  sizeAutocompleteCache = [...new Set(sizeAutocompleteCache)];
  console.log('✅ Sync complete -', sizeAutocompleteCache.length, 'sizes');
}


/**
 * ==========================================
 * ADD PRODUCT MODAL - SIZE AUTOCOMPLETE FUNCTIONS
 * ==========================================
 */

/**
 * Show size suggestions for ADD PRODUCT modal
 */
 async function showSizeSuggestions() {
  const input = document.getElementById('size');
  if (!input) return;
  
  console.log('👆 Add Product size field clicked');
  
  // Load cache if empty
  if (!sizeAutocompleteCache || sizeAutocompleteCache.length === 0) {
    const user = window.auth.currentUser;
    if (user) {
      try {
        const { collection, getDocs } = window.firebaseImports;
        const sizesRef = collection(window.db, 'tenants', user.uid, 'sizes');
        const snapshot = await getDocs(sizesRef);
        
        const sizes = [];
        snapshot.forEach((doc) => {
          const data = doc.data();
          const sizeName = data.name || data.sizeName;
          if (sizeName) sizes.push(sizeName);
        });
        
        sizeAutocompleteCache = sizes;
        sizeCacheLoaded = true;
        console.log('✅ Force loaded', sizes.length, 'sizes for Add Product');
      } catch (error) {
        console.error('❌ Error:', error);
        return;
      }
    }
  }
  
  const inputValue = input.value.trim();
  
  if (!inputValue || inputValue.length === 0) {
    if (sizeAutocompleteCache && sizeAutocompleteCache.length > 0) {
      renderSizeSuggestions(sizeAutocompleteCache);
    }
  } else {
    filterSizeSuggestions(inputValue);
  }
}
/**
 * Filter size suggestions for ADD PRODUCT modal
 * ✅ Enhanced version with smooth UX
 */
 function filterSizeSuggestions(inputText) {
  const dropdown = document.getElementById('addProductSizeSuggestionsDropdown');
  const input = document.getElementById('size');
  
  if (!input) {
    console.warn('⚠️ Size input field not found');
    return;
  }
  
  // Check if input field is focused
  const isFocused = document.activeElement === input;
  
  // Normalize input
  const trimmedInput = inputText ? inputText.trim() : '';
  
  // ✅ CASE 1: Input is empty
  if (!trimmedInput || trimmedInput.length === 0) {
    // Show all sizes ONLY if field is focused
    if (isFocused) {
      if (sizeAutocompleteCache && sizeAutocompleteCache.length > 0) {
        renderSizeSuggestions(sizeAutocompleteCache);
        console.log('✅ Showing all', sizeAutocompleteCache.length, 'sizes (field focused, input empty)');
      } else {
        // No sizes in cache
        if (dropdown) {
          dropdown.innerHTML = `
            <div style="padding: 15px; text-align: center; color: #999;">
              <i class="bi bi-inbox"></i> No sizes available
            </div>
          `;
          dropdown.style.display = 'block';
        }
        console.log('ℹ️ No sizes in cache');
      }
    } else {
      // Field not focused, hide dropdown
      if (dropdown) dropdown.style.display = 'none';
    }
    
    // Hide save button when input is empty
    const saveBtn = document.getElementById('saveSizeInsideBtn');
    if (saveBtn) saveBtn.style.display = 'none';
    
    return;
  }
  
  // ✅ CASE 2: User is typing - filter sizes
  const query = trimmedInput.toLowerCase();
  const matches = sizeAutocompleteCache.filter(size => 
    size.toLowerCase().includes(query)
  );
  
  if (matches.length > 0) {
    // Show filtered results
    renderSizeSuggestions(matches);
    console.log('✅ Showing', matches.length, 'sizes matching "' + trimmedInput + '"');
  } else {
    // No matches found
    if (dropdown) {
      dropdown.innerHTML = `
        <div style="padding: 15px; text-align: center; color: #999;">
          <i class="bi bi-search"></i> No sizes match "<strong>${escapeHtml(trimmedInput)}</strong>"
        </div>
      `;
      dropdown.style.display = 'block';
    }
    console.log('ℹ️ No sizes match:', trimmedInput);
  }
  
  // Check if we should show save button for new size
  checkAndShowSaveSizeButton(trimmedInput);
}


/**
 * Render size suggestions for ADD PRODUCT modal
 */
function renderSizeSuggestions(matches) {
  const dropdown = document.getElementById('addProductSizeSuggestionsDropdown');
  if (!dropdown) return;
  
  const limitedMatches = matches.slice(0, 15);
  
  let html = '';
  limitedMatches.forEach(size => {
    const escaped = escapeHtml(size);
    html += `
      <div onclick="selectSizeSuggestion('${escaped}')" style="
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background 0.2s;
      " onmouseover="this.style.background='#f5f5f5'" 
         onmouseout="this.style.background='transparent'">
        <strong>${size}</strong>
      </div>
    `;
  });
  
  dropdown.innerHTML = html;
  dropdown.style.display = 'block';
  
  console.log('✅ Rendered', limitedMatches.length, 'sizes for Add Product');
}

/**
 * Select size for ADD PRODUCT modal
 */
function selectSizeSuggestion(sizeName) {
  const input = document.getElementById('size');
  const dropdown = document.getElementById('addProductSizeSuggestionsDropdown');
  
  if (input) {
    input.value = sizeName;
  }
  
  // Hide dropdown
  if (dropdown) dropdown.style.display = 'none';
  
  // Hide save button
  const saveBtn = document.getElementById('saveSizeInsideBtn');
  if (saveBtn) saveBtn.style.display = 'none';
  
  console.log('✅ Selected size:', sizeName);
}

/**
 * Hide size suggestions for ADD PRODUCT modal
 */
function hideSizeSuggestions() {
  const dropdown = document.getElementById('addProductSizeSuggestionsDropdown');
  if (dropdown) {
    dropdown.style.display = 'none';
  }
}

/**
 * Check if size exists and show/hide save button
 */
function checkAndShowSaveSizeButton(inputText) {
  const btn = document.getElementById('saveSizeInsideBtn');
  if (!btn) return;
  
  const input = inputText.trim();
  
  if (!input || input.length === 0) {
    btn.style.display = 'none';
    return;
  }
  
  const sizeExists = sizeAutocompleteCache.some(size => 
    size.toLowerCase() === input.toLowerCase()
  );
  
  if (!sizeExists) {
    btn.innerHTML = '💾';
    btn.style.background = '#007bff';
    btn.style.cursor = 'pointer';
    btn.disabled = false;
    btn.style.display = 'block';
  } else {
    btn.style.display = 'none';
  }
}

/**
 * Save new size from ADD PRODUCT field
 */
async function saveNewSizeFromProductField() {
  const input = document.getElementById('size');
  const sizeName = input.value.trim();
  const btn = document.getElementById('saveSizeInsideBtn');
  
  if (!sizeName || sizeName.length === 0) {
    return;
  }
  
  const user = window.auth.currentUser;
  
  if (!user) {
    console.log('No user authenticated');
    return;
  }
  
  const sizeExists = sizeAutocompleteCache.some(size => 
    size.toLowerCase() === sizeName.toLowerCase()
  );
  
  if (sizeExists) {
    if (btn) btn.style.display = 'none';
    return;
  }
  
  console.log('💾 Saving new size:', sizeName);
  
  if (btn) {
    btn.innerHTML = '✅ Saved';
    btn.style.background = '#0056b3';
    btn.disabled = true;
  }
  
  try {
    const { collection, addDoc } = window.firebaseImports;
    
    const sizesRef = collection(window.db, 'tenants', user.uid, 'sizes');
    await addDoc(sizesRef, {
      name: sizeName,
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
      userId: user.uid
    });
    
    console.log('✅ Size saved successfully:', sizeName);
    
    // Add to cache
    sizeAutocompleteCache.push(sizeName);
    
  } catch (error) {
    console.error('❌ Error saving size:', error);
    
    if (btn) {
      btn.innerHTML = '❌ Error';
      btn.style.background = '#dc3545';
      
      setTimeout(() => {
        btn.innerHTML = '💾';
        btn.style.background = '#007bff';
        btn.disabled = false;
      }, 2000);
    }
  }
}

// Make functions global
window.showSizeSuggestions = showSizeSuggestions;
window.filterSizeSuggestions = filterSizeSuggestions;
window.renderSizeSuggestions = renderSizeSuggestions;
window.selectSizeSuggestion = selectSizeSuggestion;
window.hideSizeSuggestions = hideSizeSuggestions;
window.checkAndShowSaveSizeButton = checkAndShowSaveSizeButton;
window.saveNewSizeFromProductField = saveNewSizeFromProductField;
window.navigateToSizes = navigateToSizes;
window.loadSizes = loadSizes;
window.loadSizeAutocompleteCache = loadSizeAutocompleteCache;

console.log('✅ Size autocomplete functions loaded');





// Make functions global
window.navigateToSizes = navigateToSizes;
window.loadSizes = loadSizes;
window.renderSizesList = renderSizesList;
window.filterSizes = filterSizes;
window.openAddSizeModal = openAddSizeModal;
window.handleSizeInputKeydown = handleSizeInputKeydown;
window.updateSizePreviewList = updateSizePreviewList;
window.removePendingSize = removePendingSize;
window.saveAllSizes = saveAllSizes;
window.deleteSize = deleteSize;
window.syncSizeCaches = syncSizeCaches;
window.loadSizeAutocompleteCache = loadSizeAutocompleteCache;

console.log('✅ Size management system loaded');



/**
 * ==========================================
 * MAKE ALL FUNCTIONS GLOBAL FOR BUTTONS
 * ==========================================
 */

// Make functions available globally for onclick attributes
window.generateInvoice = generateInvoice;
window.openRecordPurchaseModal = openRecordPurchaseModal;
window.showAllProducts = showAllProducts;
window.showPhotoProducts = showPhotoProducts;
window.toggleSidebar = toggleSidebar;
window.openSalesModal = openSalesModal;
window.openAddProduct = openAddProduct;
window.openProductByPhotoModal = openProductByPhotoModal;

// Navigation functions
window.navigateToHome = navigateToHome;
window.navigateToProducts = navigateToProducts;
window.navigateToSales = navigateToSales;
window.navigateToInvoices = navigateToInvoices;
window.navigateToPurchases = navigateToPurchases;
window.navigateToCustomers = navigateToCustomers;
window.navigateToBrands = navigateToBrands;

// Modal functions
window.saveProduct = saveProduct;
window.saveSale = saveSale;
window.saveInvoice = saveInvoice;
window.savePurchase = savePurchase;
window.saveCustomer = saveCustomer;

// Close functions
window.closeAddProductModal = closeAddProductModal;
window.closeRecordSaleModal = closeRecordSaleModal;
window.closeGenerateInvoiceModal = closeGenerateInvoiceModal;
window.closeRecordPurchaseModal = closeRecordPurchaseModal;

// Other functions
window.deleteProduct = deleteProduct;
window.editProduct = editProduct;
window.deleteSale = deleteSale;
window.deleteInvoice = deleteInvoice;
window.deletePurchase = deletePurchase;
window.deleteCustomer = deleteCustomer;

console.log('✅ All functions made globally available');




    /**
 * ==========================================
 * MAKE PURCHASE FUNCTIONS GLOBAL
 * ==========================================
 */
window.submitPurchaseEntry = submitPurchaseEntry;
window.loadRecentPurchases = loadRecentPurchases;
window.openRecordPurchaseModal = openRecordPurchaseModal;
window.closeRecordPurchaseModal = closeRecordPurchaseModal;
window.addPurchaseProductRow = addPurchaseProductRow;
window.removePurchaseProductRow = removePurchaseProductRow;
window.calculatePurchaseRowAmount = calculatePurchaseRowAmount;
window.viewPurchaseDetail = viewPurchaseDetail;
window.confirmDeletePurchase = confirmDeletePurchase;
window.handlePurchasePhotoUpload = handlePurchasePhotoUpload;
window.clearPurchasePhoto = clearPurchasePhoto;
window.openPurchaseCamera = openPurchaseCamera;
window.togglePaymentSection = togglePaymentSection;
window.triggerPhotoInput = triggerPhotoInput;
window.viewPurchasePhotoPreview = viewPurchasePhotoPreview;
window.openPurchasePhotoLightbox = openPurchasePhotoLightbox;
window.togglePaymentModeCheckmark = togglePaymentModeCheckmark;

console.log('✅ Purchase functions made globally available');


    /**
 * ==========================================
 * MAKE FUNCTIONS GLOBALLY AVAILABLE
 * ==========================================
 */
window.navigateToHome = navigateToHome;
window.navigateTo = navigateTo;
window.navigateToSales = navigateToSales;
window.navigateToPurchases = navigateToPurchases;
window.navigateToAllProducts = navigateToAllProducts;
window.navigateToCustomers = navigateToCustomers;
window.navigateToProductGroups = navigateToProductGroups;
window.navigateToBrands = navigateToBrands;
window.loadRecentSales = loadRecentSales;
window.loadRecentPurchases = loadRecentPurchases;

console.log('✅ Navigation functions made globally available');

/**
 * Make sales functions globally available
 */
window.loadRecentSales = loadRecentSales;
window.displayRecentSales = displayRecentSales;
window.saveSaleToSheet = saveSaleToSheet;
window.viewSaleDetail = viewSaleDetail;
window.confirmDeleteSale = confirmDeleteSale;

console.log('✅ Sales functions made globally available');

    


 /**
 * ==========================================
 * 📦 BULK EDIT MODULE - ALL OPERATIONS
 * ==========================================
 * Handles: Category, Unit Type, Stock, Selling Price, Brand, Size
 * Created: Nov 11, 2025
 * Fixed: Nov 11, 2025 - Cancel button & counter issues
 * ==========================================
 */

/**
 * ==========================================
 * 🎯 BULK EDIT - CATEGORY (DYNAMIC)
 * ==========================================
 */

/**
 * Populate bulk category dropdown from cache
 */
 async function populateBulkCategoryDropdown() {
  const dropdownMenu = document.getElementById('bulkCategoryDropdownMenu');
  
  if (!dropdownMenu) {
    console.warn('⚠️ Bulk category dropdown menu not found');
    return;
  }
  
  // ✅ Load categories if cache is empty
  if ((!categoriesCache || categoriesCache.length === 0) && !categoryCacheLoaded) {
    console.log('📥 Categories not loaded, loading now...');
    
    const user = window.auth?.currentUser;
    if (user) {
      try {
        const { collection, getDocs } = window.firebaseImports;
        const categoriesRef = collection(window.db, 'tenants', user.uid, 'categories');
        const snapshot = await getDocs(categoriesRef);
        
        const categories = [];
        snapshot.forEach((doc) => {
          const data = doc.data();
          const categoryName = data.name || data.categoryName;
          if (categoryName) categories.push(categoryName);
        });
        
        categoriesCache = categories;
        categoryAutocompleteCache = categories;
        categoryCacheLoaded = true;
        
        console.log('✅ Loaded', categories.length, 'categories for bulk edit');
      } catch (error) {
        console.error('❌ Error loading categories:', error);
      }
    }
  }
  
  // Clear existing items
  dropdownMenu.innerHTML = '';
  
  // Check if categories exist
  if (!categoriesCache || categoriesCache.length === 0) {
    dropdownMenu.innerHTML = `
      <li><a class="dropdown-item text-muted" href="javascript:void(0);">No categories available</a></li>
      <li><hr class="dropdown-divider"></li>
      <li><a class="dropdown-item text-info" href="javascript:void(0);" onclick="navigateTo('categories')">
        <i class="bi bi-plus-circle"></i> Add categories from sidebar
      </a></li>
    `;
    console.log('⚠️ No categories found');
    return;
  }
  
  // Sort categories alphabetically
  const sortedCategories = [...categoriesCache].sort((a, b) => a.localeCompare(b));
  
  // Add each category as a dropdown item
  sortedCategories.forEach(category => {
    const li = document.createElement('li');
    const button = document.createElement('button');
    button.type = 'button';
    button.className = 'dropdown-item';
    button.onclick = function() { selectBulkCategory(category); };
    button.innerHTML = `<i class="bi bi-grid-3x3-gap"></i> ${category}`;
    li.appendChild(button);
    dropdownMenu.appendChild(li);
  });
  
  console.log('✅ Populated bulk category dropdown with', sortedCategories.length, 'categories');
}

/**
 * Show Category Bulk Edit - WITH TRANSLATION
 */
 async function showCategoryBulkEdit() {
  console.log('📝 Opening category bulk edit mode...');
  
  // Reset state
  bulkEditMode = {
    active: false,
    field: null,
    value: null,
    selectedProducts: []
  };
  
  // ✅ Load categories into dropdown
  await populateBulkCategoryDropdown();
  
  // Hide main dropdown button
  const mainDropdownContainer = document.querySelector('#bulkEditDropdown').closest('.dropdown');
  if (mainDropdownContainer) {
    mainDropdownContainer.style.display = 'none';
  }
  
  // Show category selection UI and cancel button
  document.getElementById('categorySelectionDropdown').style.display = 'inline-block';
  document.getElementById('cancelBulkEditBtn').style.display = 'inline-block';
  document.getElementById('bulkEditInfoText').style.display = 'block';
  document.getElementById('bulkEditToolbar').classList.add('active');
  
  // ✅ Reset button text WITH TRANSLATION
  const lang = window.currentLanguage || 'en';
  const selectCategoryText = window.translations[lang].selectCategory || 'Select Category';
  document.getElementById('selectedCategoryText').textContent = selectCategoryText;
  document.getElementById('updateCategoryBtn').style.display = 'none';
  
  const countEl = document.getElementById('selectedCount');
  if (countEl) countEl.textContent = '0';
  
  console.log('✅ Category selection UI shown with dynamic categories');
}

/**
 * Select Bulk Category (Fixed Closing)
 */
 function selectBulkCategory(category) {
  console.log('📦 Selected category:', category);
  
  // ✅ 1. Update UI Text IMMEDIATELY (Visual feedback)
  document.getElementById('selectedCategoryText').textContent = category;

  // ✅ 2. FORCE CLOSE using the proven method (Simulate Body Click)
  // This guarantees the dropdown closes even if Bootstrap's internal state is confused
  setTimeout(() => {
    document.body.click();
  }, 10);

  // ✅ 3. Set Logic State
  setTimeout(() => {
    // Set bulk edit mode
    bulkEditMode = {
      active: true,
      field: 'category',
      value: category,
      selectedProducts: []
    };
    
    // Show Action Button
    document.getElementById('updateCategoryBtn').style.display = 'inline-block';
    document.getElementById('selectedCount').textContent = '0';
    
    // Enable product selection
    if (typeof enableProductSelection === 'function') {
      enableProductSelection();
    }
    
    console.log('✅ Category set:', category);
  }, 50);
}


/**
 * Apply Bulk Category Update - FIRESTORE VERSION
 */
async function applyBulkCategoryUpdate() {
  if (!bulkEditMode.selectedProducts || bulkEditMode.selectedProducts.length === 0) {
    alert('⚠️ Please select at least one product');
    return;
  }
  
  const category = bulkEditMode.value;
  const count = bulkEditMode.selectedProducts.length;
  
  if (!category || category === '') {
    alert('⚠️ Please select a category');
    return;
  }
  
  if (!confirm(`Update category to "${category}" for ${count} product(s)?`)) {
    return;
  }
  
  const btn = document.getElementById('updateCategoryBtn');
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Updating...';
  
  try {
    const user = window.auth?.currentUser;
    if (!user) {
      throw new Error('Not authenticated');
    }
    
    const { doc, setDoc } = window.firebaseImports;
    const userId = user.uid;
    
    console.log(`📝 Updating ${count} products to category: "${category}"`);
    
    // Update each product in Firestore
    let successCount = 0;
    let errorCount = 0;
    
    for (const productId of bulkEditMode.selectedProducts) {
      try {
        const product = cachedProducts.find(p => p.id === productId);
        if (!product) {
          errorCount++;
          continue;
        }
        
        // Update product data
        const updatedProduct = {
          ...product,
          category: category,
          updatedAt: new Date().toISOString()
        };
        
        // Save to Firestore
        const productRef = doc(window.db, 'tenants', userId, 'products', productId);
        await setDoc(productRef, updatedProduct);
        
        // Update local cache
        const cacheIdx = cachedProducts.findIndex(p => p.id === productId);
        if (cacheIdx !== -1) {
          cachedProducts[cacheIdx].category = category;
        }
        
        successCount++;
      } catch (error) {
        console.error('❌ Error updating product:', productId, error);
        errorCount++;
      }
    }
    
    // Update localStorage cache
    try {
      localStorage.setItem('inventory_products_cache', JSON.stringify(cachedProducts));
    } catch (e) {
      console.warn('⚠️ Failed to update cache:', e);
    }
    
    console.log(`✅ Complete: ${successCount} success, ${errorCount} errors`);
    
    // Cancel bulk edit mode
    cancelBulkEdit();
    
    // Re-render products
    if (typeof renderProducts === 'function') {
      renderProducts();
    }
    
    // Show result
    if (errorCount > 0) {
      alert(`✅ Updated ${successCount} product(s)\n⚠️ ${errorCount} error(s)`);
    } else {
      alert(`✅ Successfully updated ${successCount} product(s)!`);
    }
    
  } catch (error) {
    console.error('❌ Error:', error);
    alert('❌ Error updating products: ' + error.message);
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}

// ✅ Make functions global
window.populateBulkCategoryDropdown = populateBulkCategoryDropdown;
window.showCategoryBulkEdit = showCategoryBulkEdit;
window.selectBulkCategory = selectBulkCategory;
window.applyBulkCategoryUpdate = applyBulkCategoryUpdate;

console.log('✅ Bulk category edit functions loaded (dynamic)');

/**
 * ==========================================
 * 🎯 BULK EDIT - UNIT TYPE (DYNAMIC)
 * ==========================================
 */

/**
 * Populate bulk unit type dropdown from cache
 */
 async function populateBulkUnitTypeDropdown() {
  const dropdownMenu = document.getElementById('bulkUnitTypeDropdownMenu');
  
  if (!dropdownMenu) {
    console.warn('⚠️ Bulk unit type dropdown menu not found');
    return;
  }
  
  // Load unit types if cache is empty
  if ((!unitTypesCache || unitTypesCache.length === 0) && !unitTypeCacheLoaded) {
    console.log('📥 Unit types not loaded, loading now...');
    
    const user = window.auth?.currentUser;
    if (user) {
      try {
        const { collection, getDocs } = window.firebaseImports;
        const unitTypesRef = collection(window.db, 'tenants', user.uid, 'unitTypes');
        const snapshot = await getDocs(unitTypesRef);
        
        const unitTypes = [];
        snapshot.forEach((doc) => {
          const data = doc.data();
          const unitTypeName = data.name || data.unitTypeName;
          if (unitTypeName) unitTypes.push(unitTypeName);
        });
        
        unitTypesCache = unitTypes;
        unitTypeAutocompleteCache = unitTypes;
        unitTypeCacheLoaded = true;
        
        console.log('✅ Loaded', unitTypes.length, 'unit types for bulk edit');
      } catch (error) {
        console.error('❌ Error loading unit types:', error);
      }
    }
  }
  
  // Clear existing items
  dropdownMenu.innerHTML = '';
  
  // Check if unit types exist
  if (!unitTypesCache || unitTypesCache.length === 0) {
    dropdownMenu.innerHTML = `
      <li><a class="dropdown-item text-muted" href="javascript:void(0);">No unit types available</a></li>
      <li><hr class="dropdown-divider"></li>
      <li><a class="dropdown-item text-warning" href="javascript:void(0);" onclick="navigateTo('unitTypes')">
        <i class="bi bi-plus-circle"></i> Add unit types from sidebar
      </a></li>
    `;
    console.log('⚠️ No unit types found');
    return;
  }
  
  // Sort unit types alphabetically
  const sortedUnitTypes = [...unitTypesCache].sort((a, b) => a.localeCompare(b));
  
  // Add each unit type as a dropdown item
  sortedUnitTypes.forEach(unitType => {
    const li = document.createElement('li');
    const button = document.createElement('button');
    button.type = 'button';
    button.className = 'dropdown-item';
    button.onclick = function() { selectBulkUnitType(unitType); };
    button.innerHTML = `<i class="bi bi-card-text"></i> ${unitType}`;
    li.appendChild(button);
    dropdownMenu.appendChild(li);
  });
  
  console.log('✅ Populated bulk unit type dropdown with', sortedUnitTypes.length, 'unit types');
}
/**
 * Show Unit Type Bulk Edit - WITH TRANSLATION
 */
 async function showUnitTypeBulkEdit() {
  console.log('📝 Opening unit type bulk edit mode...');
  
  // Reset state
  bulkEditMode = {
    active: false,
    field: null,
    value: null,
    selectedProducts: []
  };
  
  // Load unit types into dropdown
  await populateBulkUnitTypeDropdown();
  
  // Hide main dropdown button
  const mainDropdownContainer = document.querySelector('#bulkEditDropdown').closest('.dropdown');
  if (mainDropdownContainer) {
    mainDropdownContainer.style.display = 'none';
  }
  
  // Show unit type selection UI and cancel button
  document.getElementById('unitTypeSelectionDropdown').style.display = 'inline-block';
  document.getElementById('cancelBulkEditBtn').style.display = 'inline-block';
  document.getElementById('bulkEditInfoText').style.display = 'block';
  document.getElementById('bulkEditToolbar').classList.add('active');
  
  // ✅ Reset button text WITH TRANSLATION
  const lang = window.currentLanguage || 'en';
  const selectUnitTypeText = window.translations[lang].selectUnitType || 'Select Unit Type';
  document.getElementById('selectedUnitTypeText').textContent = selectUnitTypeText;
  document.getElementById('updateUnitTypeBtn').style.display = 'none';
  
  const countEl = document.getElementById('selectedCountUnitType');
  if (countEl) countEl.textContent = '0';
  
  console.log('✅ Unit type selection UI shown with dynamic unit types');
}
/**
 * Select Bulk Unit Type (Fixed Closing)
 */
 function selectBulkUnitType(unitType) {
  console.log('📦 Selected unit type:', unitType);
  
  // ✅ 1. Update UI Text IMMEDIATELY
  document.getElementById('selectedUnitTypeText').textContent = unitType;

  // ✅ 2. FORCE CLOSE using the proven method (Simulate Body Click)
  setTimeout(() => {
    document.body.click();
  }, 10);
  
  // ✅ 3. Logic State
  setTimeout(() => {
    // Set bulk edit mode
    bulkEditMode = {
      active: true,
      field: 'unitType',
      value: unitType,
      selectedProducts: []
    };
    
    // Show Action Button
    document.getElementById('updateUnitTypeBtn').style.display = 'inline-block';
    document.getElementById('selectedCountUnitType').textContent = '0';
    
    // Enable product selection
    if (typeof enableProductSelection === 'function') {
      enableProductSelection();
    }
    
    console.log('✅ Unit type set:', unitType);
  }, 50);
}


/**
 * Apply Bulk Unit Type Update - FIRESTORE VERSION
 */
async function applyBulkUnitTypeUpdate() {
  if (!bulkEditMode.selectedProducts || bulkEditMode.selectedProducts.length === 0) {
    alert('⚠️ Please select at least one product');
    return;
  }
  
  const unitType = bulkEditMode.value;
  const count = bulkEditMode.selectedProducts.length;
  
  if (!unitType || unitType === '') {
    alert('⚠️ Please select a unit type');
    return;
  }
  
  if (!confirm(`Update unit type to "${unitType}" for ${count} product(s)?`)) {
    return;
  }
  
  const btn = document.getElementById('updateUnitTypeBtn');
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Updating...';
  
  try {
    const user = window.auth?.currentUser;
    if (!user) {
      throw new Error('Not authenticated');
    }
    
    const { doc, setDoc } = window.firebaseImports;
    const userId = user.uid;
    
    console.log(`📝 Updating ${count} products to unit type: "${unitType}"`);
    
    // Update each product in Firestore
    let successCount = 0;
    let errorCount = 0;
    
    for (const productId of bulkEditMode.selectedProducts) {
      try {
        const product = cachedProducts.find(p => p.id === productId);
        if (!product) {
          errorCount++;
          continue;
        }
        
        // Update product data
        const updatedProduct = {
          ...product,
          unitType: unitType,
          updatedAt: new Date().toISOString()
        };
        
        // Save to Firestore
        const productRef = doc(window.db, 'tenants', userId, 'products', productId);
        await setDoc(productRef, updatedProduct);
        
        // Update local cache
        const cacheIdx = cachedProducts.findIndex(p => p.id === productId);
        if (cacheIdx !== -1) {
          cachedProducts[cacheIdx].unitType = unitType;
        }
        
        successCount++;
      } catch (error) {
        console.error('❌ Error updating product:', productId, error);
        errorCount++;
      }
    }
    
    // Update localStorage cache
    try {
      localStorage.setItem('inventory_products_cache', JSON.stringify(cachedProducts));
    } catch (e) {
      console.warn('⚠️ Failed to update cache:', e);
    }
    
    console.log(`✅ Complete: ${successCount} success, ${errorCount} errors`);
    
    // Cancel bulk edit mode
    cancelBulkEdit();
    
    // Re-render products
    if (typeof renderProducts === 'function') {
      renderProducts();
    }
    
    // Show result
    if (errorCount > 0) {
      alert(`✅ Updated ${successCount} product(s)\n⚠️ ${errorCount} error(s)`);
    } else {
      alert(`✅ Successfully updated ${successCount} product(s)!`);
    }
    
  } catch (error) {
    console.error('❌ Error:', error);
    alert('❌ Error updating products: ' + error.message);
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}

// ✅ Make all functions global
window.loadUnitTypeAutocompleteCache = loadUnitTypeAutocompleteCache;
window.navigateToUnitTypes = navigateToUnitTypes;
window.loadUnitTypes = loadUnitTypes;
window.renderUnitTypesList = renderUnitTypesList;
window.filterUnitTypes = filterUnitTypes;
window.openAddUnitTypeModal = openAddUnitTypeModal;
window.handleUnitTypeInputKeydown = handleUnitTypeInputKeydown;
window.updateUnitTypePreviewList = updateUnitTypePreviewList;
window.removePendingUnitType = removePendingUnitType;
window.saveAllUnitTypes = saveAllUnitTypes;
window.deleteUnitType = deleteUnitType;
window.syncUnitTypeCaches = syncUnitTypeCaches;
window.populateUnitTypeDropdown = populateUnitTypeDropdown;
window.populateBulkUnitTypeDropdown = populateBulkUnitTypeDropdown;
window.showUnitTypeBulkEdit = showUnitTypeBulkEdit;
window.selectBulkUnitType = selectBulkUnitType;
window.applyBulkUnitTypeUpdate = applyBulkUnitTypeUpdate;

console.log('✅ Unit type management system loaded');

/**
 * ==========================================
 * 🎯 COMMON FUNCTIONS - SELECTION & CANCEL
 * ==========================================
 */

/**
 * Enable Product Selection Mode
 */
function enableProductSelection() {
  console.log('🖱️ Product selection mode enabled');
  enableProductSelectionDesktop();
  enableProductSelectionMobile();
}

/**
 * Enable Desktop Selection
 */
function enableProductSelectionDesktop() {
  const tableRows = document.querySelectorAll('#productsTableBody tr[data-product-id]');
  
  tableRows.forEach(row => {
    const productId = row.getAttribute('data-product-id');
    row.classList.add('product-selectable');
    row.onclick = null;
    row.onclick = function(event) {
      if (event.target.closest('.btn')) return;
      event.stopPropagation();
      event.preventDefault();
      toggleProductSelectionDesktop(productId, row);
    };
  });
  
  console.log('✅ Desktop selection enabled for', tableRows.length, 'rows');
}

/**
 * Enable Mobile Selection
 */
function enableProductSelectionMobile() {
  const mobileCards = document.querySelectorAll('.mobile-item[data-product-id]');
  
  mobileCards.forEach(card => {
    const productId = card.getAttribute('data-product-id');
    card.classList.add('product-selectable');
    card.onclick = null;
    card.onclick = function(event) {
      if (event.target.closest('.btn')) return;
      event.stopPropagation();
      event.preventDefault();
      toggleProductSelectionMobile(productId, card);
    };
  });
  
  console.log('✅ Mobile selection enabled for', mobileCards.length, 'cards');
}

/**
 * Toggle Desktop Product Selection - FIXED: Updates correct counter
 */
function toggleProductSelectionDesktop(productId, row) {
  if (!bulkEditMode.active) return;
  
  const index = bulkEditMode.selectedProducts.indexOf(productId);
  
  if (index > -1) {
    bulkEditMode.selectedProducts.splice(index, 1);
    row.classList.remove('product-selected');
  } else {
    bulkEditMode.selectedProducts.push(productId);
    row.classList.add('product-selected');
  }
  
  // ✅ FIXED: Update count based on field
  updateSelectedCount();
}

/**
 * Toggle Mobile Product Selection - FIXED: Updates correct counter
 */
function toggleProductSelectionMobile(productId, card) {
  if (!bulkEditMode.active) return;
  
  const indicator = card.querySelector('.selection-indicator');
  const index = bulkEditMode.selectedProducts.indexOf(productId);
  
  if (index > -1) {
    bulkEditMode.selectedProducts.splice(index, 1);
    card.classList.remove('product-selected');
    if (indicator) indicator.style.display = 'none';
  } else {
    bulkEditMode.selectedProducts.push(productId);
    card.classList.add('product-selected');
    if (indicator) indicator.style.display = 'flex';
  }
  
  // ✅ FIXED: Update count based on field
  updateSelectedCount();
}

/**
 * Update Selected Count - FIXED: Updates correct counter based on field
 */
/**
 * Update Selected Count - FIXED: Updates correct counter based on field
 */
function updateSelectedCount() {
  const count = bulkEditMode.selectedProducts.length;
  
  if (bulkEditMode.field === 'category') {
    const el = document.getElementById('selectedCount');
    if (el) el.textContent = count;
  } else if (bulkEditMode.field === 'unitType') {
    const el = document.getElementById('selectedCountUnitType');
    if (el) el.textContent = count;
  } else if (bulkEditMode.field === 'sellingPrice') {
    const el = document.getElementById('selectedCountSellingPrice');
    if (el) el.textContent = count;
  } else if (bulkEditMode.field === 'size') {
    const el = document.getElementById('selectedCountSize');
    if (el) el.textContent = count;
  } else if (bulkEditMode.field === 'brand') {
    const el = document.getElementById('selectedCountBrand');
    if (el) el.textContent = count;
  } else if (bulkEditMode.field === 'stockStatus') {
    const el = document.getElementById('selectedCountStockStatus');
    if (el) el.textContent = count;
  }
}


/**
 * Cancel Bulk Edit
 * ✅ Removes all highlighting and resets UI
 */
 function cancelBulkEdit() {
  console.log('✕ Cancelling bulk edit mode');
  
  // ✅ Reset state
  bulkEditMode = {
    active: false,
    field: null,
    value: null,
    selectedProducts: []
  };
  
  // ✅ REMOVE BODY CLASSES
  document.body.classList.remove('stock-status-edit-active');
  document.body.classList.remove('stock-adjustment-active');
  
  // ✅ REMOVE ALL HIGHLIGHTING
  removeStockStatusHighlighting();
  removeStockAdjustmentHighlighting();
  
  // ✅ SHOW MAIN DROPDOWN BUTTON BACK
  const mainDropdownContainer = document.querySelector('#bulkEditDropdown').closest('.dropdown');
  if (mainDropdownContainer) {
    mainDropdownContainer.style.display = 'inline-block';
  }
  
  // ✅ FIXED: Hide ALL UI elements
  hideElement('categorySelectionDropdown');
  hideElement('unitTypeSelectionDropdown');
  hideElement('sellingPriceInputContainer');
  hideElement('sizeInputContainer');
  hideElement('brandInputContainer');
  hideElement('stockAdjustmentContainer');
  hideElement('stockStatusSelectionDropdown');
  hideElement('updateCategoryBtn');
  hideElement('updateUnitTypeBtn');
  hideElement('updateSellingPriceBtn');
  hideElement('updateSizeBtn');
  hideElement('updateBrandBtn');
  hideElement('updateStockStatusBtn');
  hideElement('cancelBulkEditBtn');
  hideElement('updateStockChangesBtn');
  hideElement('bulkEditInfoText');
  
  // ✅ Hide brand/size specific cancel buttons
  hideElement('cancelBulkEditBrandBtn');
  hideElement('cancelBulkEditSizeBtn');
  
  const bulkToolbar = document.getElementById('bulkEditToolbar');
  if (bulkToolbar) bulkToolbar.classList.remove('active');
  
  // ✅ Reset text
  const selectedCategoryText = document.getElementById('selectedCategoryText');
  if (selectedCategoryText) selectedCategoryText.textContent = 'Select Category';
  
  const selectedUnitTypeText = document.getElementById('selectedUnitTypeText');
  if (selectedUnitTypeText) selectedUnitTypeText.textContent = 'Select Unit Type';
  
  const selectedStockStatusText = document.getElementById('selectedStockStatusText');
  if (selectedStockStatusText) selectedStockStatusText.textContent = 'Select Stock Status';
  
  const selectedCount = document.getElementById('selectedCount');
  if (selectedCount) selectedCount.textContent = '0';
  
  const selectedCountUnitType = document.getElementById('selectedCountUnitType');
  if (selectedCountUnitType) selectedCountUnitType.textContent = '0';
  
  const selectedCountSellingPrice = document.getElementById('selectedCountSellingPrice');
  if (selectedCountSellingPrice) selectedCountSellingPrice.textContent = '0';
  
  const selectedCountSize = document.getElementById('selectedCountSize');
  if (selectedCountSize) selectedCountSize.textContent = '0';
  
  const selectedCountBrand = document.getElementById('selectedCountBrand');
  if (selectedCountBrand) selectedCountBrand.textContent = '0';
  
  const selectedCountStockStatus = document.getElementById('selectedCountStockStatus');
  if (selectedCountStockStatus) selectedCountStockStatus.textContent = '0';
  
  // ✅ Clear inputs
  const priceInput = document.getElementById('sellingPriceInput');
  if (priceInput) priceInput.value = '';
  
  const bulkSizeInput = document.getElementById('bulkSizeInput');
  if (bulkSizeInput) bulkSizeInput.value = '';
  
  const bulkBrandInput = document.getElementById('bulkBrandInput');
  if (bulkBrandInput) bulkBrandInput.value = '';
  
  const stockInput = document.getElementById('stockAdjustmentInput');
  if (stockInput) stockInput.value = '10';
  
  // ✅ Hide suggestions dropdowns
  hideElement('brandSuggestionsDropdown');
  hideElement('sizeSuggestionsDropdown');
  
  // ✅ Remove selection classes
  document.querySelectorAll('.product-selected').forEach(el => {
    el.classList.remove('product-selected');
  });
  
  document.querySelectorAll('.selection-indicator').forEach(el => {
    el.style.display = 'none';
  });
  
  document.querySelectorAll('.product-selectable').forEach(el => {
    el.classList.remove('product-selectable');
    el.onclick = null;
  });
  
  // ✅ Remove stock adjustable classes
  document.querySelectorAll('.stock-adjustable').forEach(el => {
    el.classList.remove('stock-adjustable');
    el.onclick = null;
  });
  
  // ✅✅ FIX: Restore dropdown wrapper to full width display
  const dropdownWrapper = document.getElementById('bulkEditDropdownWrapper');
  if (dropdownWrapper) {
    dropdownWrapper.style.display = 'block';
    dropdownWrapper.style.width = '100%';
  }
  
  // ✅✅ FIX: Ensure main button stays full width
  const mainButton = document.getElementById('bulkEditDropdown');
  if (mainButton) {
    mainButton.style.width = '100%';
  }
  
  console.log('✅ Bulk edit mode cancelled and all highlights removed');
}



/**
 * Helper: Hide Element
 */
function hideElement(id) {
  const el = document.getElementById(id);
  if (el) el.style.display = 'none';
}




/**
 * ==========================================
 * REMOVE STOCK STATUS HIGHLIGHTING
 * ==========================================
 * Removes all highlighting from products
 */
 function removeStockStatusHighlighting() {
  console.log('🧹 Removing stock status highlighting...');
  
  // ✅ DESKTOP - Table rows
  const tableRows = document.querySelectorAll('#productsTableBody tr[data-product-id]');
  tableRows.forEach(row => {
    // Remove highlight class
    row.classList.remove('product-stock-status-eligible');
    
    // Remove inline styles
    row.style.opacity = '';
    row.style.filter = '';
    row.style.pointerEvents = '';
  });
  
  // ✅ MOBILE - Product cards
  const mobileCards = document.querySelectorAll('.mobile-item[data-product-id]');
  mobileCards.forEach(card => {
    // Remove highlight class
    card.classList.remove('product-stock-status-eligible');
    
    // Remove inline styles
    card.style.opacity = '';
    card.style.filter = '';
    card.style.pointerEvents = '';
  });
  
  console.log('✅ Stock status highlighting removed');
}


/**
 * ==========================================
 * CLOSE DROPDOWN ON OUTSIDE CLICK (ENHANCED)
 * ==========================================
 */

 (function() {
  let dropdownCloseHandler = null;
  
  /**
   * Attach click outside handler
   */
  function attachBrandDropdownCloseHandler() {
    // Remove old handler if exists
    if (dropdownCloseHandler) {
      document.removeEventListener('click', dropdownCloseHandler);
    }
    
    // Create new handler
    dropdownCloseHandler = function(event) {
      const dropdown = document.getElementById('brandSuggestionsDropdown');
      const input = document.getElementById('bulkBrandInput');
      const saveBtn = document.getElementById('saveBulkBrandInsideBtn');
      
      // Skip if dropdown doesn't exist or is hidden
      if (!dropdown || dropdown.style.display === 'none') {
        return;
      }
      
      // Check if click is on input, dropdown, or save button
      const clickedInsideInput = input && input.contains(event.target);
      const clickedInsideDropdown = dropdown && dropdown.contains(event.target);
      const clickedOnSaveBtn = saveBtn && saveBtn.contains(event.target);
      
      // Close dropdown if clicked outside
      if (!clickedInsideInput && !clickedInsideDropdown && !clickedOnSaveBtn) {
        dropdown.style.display = 'none';
        console.log('🔽 Dropdown closed (clicked outside)');
      }
    };
    
    // Attach handler
    document.addEventListener('click', dropdownCloseHandler);
    console.log('✅ Dropdown close handler attached');
  }
  
  /**
   * Remove click outside handler
   */
  function removeBrandDropdownCloseHandler() {
    if (dropdownCloseHandler) {
      document.removeEventListener('click', dropdownCloseHandler);
      dropdownCloseHandler = null;
      console.log('🗑️ Dropdown close handler removed');
    }
  }
  
  // Attach on page load
  attachBrandDropdownCloseHandler();
  
  // Also attach when bulk edit mode opens
  const originalShowBrandBulkEdit = window.showBrandBulkEdit;
  if (originalShowBrandBulkEdit) {
    window.showBrandBulkEdit = function() {
      originalShowBrandBulkEdit.apply(this, arguments);
      attachBrandDropdownCloseHandler();
    };
  }
  
  // Make functions global (optional - for manual control)
  window.attachBrandDropdownCloseHandler = attachBrandDropdownCloseHandler;
  window.removeBrandDropdownCloseHandler = removeBrandDropdownCloseHandler;
  
})();


/**
 * ==========================================
 * 🎯 BULK EDIT - SELLING PRICE
 * ==========================================
 */

/**
 * Show Selling Price Bulk Edit
 */
/**
 * Show Selling Price Bulk Edit - FIXED: Resets state properly
 */
function showSellingPriceBulkEdit() {
  console.log('📝 Opening selling price bulk edit mode...');
  
  // ✅ RESET STATE FIRST (prevents ghost selections)
  bulkEditMode = {
    active: false, // Not active until user enters a price
    field: null,
    value: null,
    selectedProducts: []
  };
  
  // ✅ HIDE THE MAIN DROPDOWN BUTTON
  const mainDropdownContainer = document.querySelector('#bulkEditDropdown').closest('.dropdown');
  if (mainDropdownContainer) {
    mainDropdownContainer.style.display = 'none';
  }
  
  // ✅ Show selling price input AND cancel button
  document.getElementById('sellingPriceInputContainer').style.display = 'flex';
  document.getElementById('updateSellingPriceBtn').style.display = 'inline-block';
  document.getElementById('cancelBulkEditBtn').style.display = 'inline-block';
  document.getElementById('bulkEditInfoText').style.display = 'block';
  document.getElementById('bulkEditToolbar').classList.add('active');
  
  // ✅ Reset counter to 0
  const countEl = document.getElementById('selectedCountSellingPrice');
  if (countEl) countEl.textContent = '0';
  
  // ✅ Set up input listener
  const priceInput = document.getElementById('sellingPriceInput');
  priceInput.value = ''; // Clear input
  
  // ✅ Listen for Enter key or input change
  priceInput.addEventListener('input', function() {
    const price = parseFloat(priceInput.value);
    if (!isNaN(price) && price > 0) {
      // ✅ Set bulk edit mode
      bulkEditMode = {
        active: true,
        field: 'sellingPrice',
        value: price,
        selectedProducts: []
      };
      
      // ✅ Enable product selection
      enableProductSelection();
      
      console.log('✅ Selling price set to:', price);
    }
  });
  
  // ✅ Focus on input
  setTimeout(() => priceInput.focus(), 100);
  
  console.log('✅ Selling price input shown');
}


/**
 * Apply Bulk Selling Price Update - FIRESTORE VERSION
 */
async function applyBulkSellingPriceUpdate() {
  const priceInput = document.getElementById('sellingPriceInput');
  const price = parseFloat(priceInput.value);
  
  if (isNaN(price) || price <= 0) {
    alert('⚠️ Please enter a valid selling price');
    priceInput.focus();
    return;
  }
  
  if (bulkEditMode.selectedProducts.length === 0) {
    alert('⚠️ Please select at least one product');
    return;
  }
  
  const count = bulkEditMode.selectedProducts.length;
  
  if (!confirm(`Update selling price to ₹${price} for ${count} product(s)?`)) {
    return;
  }
  
  const btn = document.getElementById('updateSellingPriceBtn');
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Updating...';
  
  try {
    const user = window.auth?.currentUser;
    if (!user) throw new Error('Not authenticated');
    
    const { doc, setDoc } = window.firebaseImports;
    const userId = user.uid;
    
    let successCount = 0;
    for (const productId of bulkEditMode.selectedProducts) {
      try {
        const product = cachedProducts.find(p => p.id === productId);
        if (!product) continue;
        
        const updatedProduct = {
          ...product,
          price: price,
          updatedAt: new Date().toISOString()
        };
        
        const productRef = doc(window.db, 'tenants', userId, 'products', productId);
        await setDoc(productRef, updatedProduct);
        
        const cacheIdx = cachedProducts.findIndex(p => p.id === productId);
        if (cacheIdx !== -1) {
          cachedProducts[cacheIdx].price = price;
        }
        
        successCount++;
      } catch (error) {
        console.error('Error updating product:', productId, error);
      }
    }
    
    localStorage.setItem('inventory_products_cache', JSON.stringify(cachedProducts));
    
    cancelBulkEdit();
    
    if (typeof renderProducts === 'function') {
      renderProducts();
    }
    
    alert(`✅ Updated ${successCount} products successfully!`);
    
  } catch (error) {
    console.error('❌ Error:', error);
    alert('❌ Error updating products: ' + error.message);
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}

/**
 * ==========================================
 * 🎯 BULK EDIT - SIZE (WITH AUTOCOMPLETE)
 * ==========================================
 */

/**
 * Show Size Bulk Edit
 */
 function showSizeBulkEdit() {
  console.log('📝 Opening size bulk edit mode...');
  
  // Reset state
  bulkEditMode = {
    active: false,
    field: null,
    value: null,
    selectedProducts: []
  };
  
  // Hide main dropdown button
  const mainDropdownContainer = document.querySelector('#bulkEditDropdown').closest('.dropdown');
  if (mainDropdownContainer) {
    mainDropdownContainer.style.display = 'none';
  }
  
  // Show size input and buttons
  document.getElementById('sizeInputContainer').style.display = 'flex';
  document.getElementById('updateSizeBtn').style.display = 'inline-block';
  document.getElementById('cancelBulkEditBtn').style.display = 'inline-block';
  document.getElementById('bulkEditInfoText').style.display = 'block';
  document.getElementById('bulkEditToolbar').classList.add('active');
  
  // Reset counter
  const countEl = document.getElementById('selectedCountSize');
  if (countEl) countEl.textContent = '0';
  
  // Clear input and reset save button
  const sizeInput = document.getElementById('bulkSizeInput');
  if (sizeInput) {
    sizeInput.value = '';
    
    // Hide save button
    const saveBtn = document.getElementById('saveBulkSizeInsideBtn');
    if (saveBtn) {
      saveBtn.style.display = 'none';
      saveBtn.innerHTML = '💾';
      saveBtn.style.background = '#007bff';
      saveBtn.disabled = false;
    }
    
    // Force load size cache if empty
    if (!sizeAutocompleteCache || sizeAutocompleteCache.length === 0) {
      console.log('⚠️ Size cache empty, loading...');
      if (typeof loadSizeAutocompleteCache === 'function') {
        loadSizeAutocompleteCache();
      }
    }
    
    // Focus
    setTimeout(() => {
      sizeInput.focus();
      console.log('✅ Input focused');
    }, 150);
  } else {
    console.error('❌ bulkSizeInput not found');
  }
  
  console.log('✅ Size bulk edit ready');
}

/**
 * Show bulk size suggestions
 */
async function showBulkSizeSuggestions() {
  const input = document.getElementById('bulkSizeInput');
  if (!input) return;
  
  console.log('👆 Bulk size field clicked');
  
  // Load cache if empty
  if (!sizeAutocompleteCache || sizeAutocompleteCache.length === 0) {
    const user = window.auth.currentUser;
    if (user) {
      try {
        const { collection, getDocs } = window.firebaseImports;
        const sizesRef = collection(window.db, 'tenants', user.uid, 'sizes');
        const snapshot = await getDocs(sizesRef);
        
        const sizes = [];
        snapshot.forEach((doc) => {
          const data = doc.data();
          const sizeName = data.name || data.sizeName;
          if (sizeName) sizes.push(sizeName);
        });
        
        sizeAutocompleteCache = sizes;
        console.log('✅ Loaded', sizes.length, 'sizes for Bulk Edit');
      } catch (error) {
        console.error('❌ Error loading sizes:', error);
        return;
      }
    }
  }
  
  const inputValue = input.value.trim();
  
  // Show all or filtered
  if (!inputValue) {
    if (sizeAutocompleteCache.length > 0) {
      renderBulkSizeSuggestions(sizeAutocompleteCache);
    }
  } else {
    filterBulkSizeSuggestions(inputValue);
  }
}
/**
 * Filter bulk size suggestions
 * ✅ Enhanced version with smooth UX
 */
 function filterBulkSizeSuggestions(inputText) {
  const dropdown = document.getElementById('sizeSuggestionsDropdown'); // Bulk edit dropdown
  const input = document.getElementById('bulkSize'); // Adjust ID if different
  
  if (!input) {
    console.warn('⚠️ Bulk size input field not found');
    // Try alternate IDs
    const altInput = document.getElementById('size') || document.querySelector('[data-bulk-size]');
    if (altInput) {
      console.log('✅ Found alternate size input');
    }
  }
  
  // Check if input field is focused (use the input if found)
  const targetInput = input || document.getElementById('size');
  const isFocused = targetInput && document.activeElement === targetInput;
  
  // Normalize input
  const trimmedInput = inputText ? inputText.trim() : '';
  
  // ✅ CASE 1: Input is empty
  if (!trimmedInput || trimmedInput.length === 0) {
    // Show all sizes ONLY if field is focused
    if (isFocused) {
      if (sizeAutocompleteCache && sizeAutocompleteCache.length > 0) {
        renderBulkSizeSuggestions(sizeAutocompleteCache);
        console.log('✅ Showing all', sizeAutocompleteCache.length, 'sizes in bulk (field focused, input empty)');
      } else {
        // No sizes in cache
        if (dropdown) {
          dropdown.innerHTML = `
            <div style="padding: 15px; text-align: center; color: #999;">
              <i class="bi bi-inbox"></i> No sizes available
            </div>
          `;
          dropdown.style.display = 'block';
        }
        console.log('ℹ️ No sizes in cache');
      }
    } else {
      // Field not focused, hide dropdown
      if (dropdown) dropdown.style.display = 'none';
    }
    
    return;
  }
  
  // ✅ CASE 2: User is typing - filter sizes
  const query = trimmedInput.toLowerCase();
  const matches = sizeAutocompleteCache.filter(size => 
    size.toLowerCase().includes(query)
  );
  
  if (matches.length > 0) {
    // Show filtered results
    renderBulkSizeSuggestions(matches);
    console.log('✅ Showing', matches.length, 'sizes in bulk matching "' + trimmedInput + '"');
  } else {
    // No matches found
    if (dropdown) {
      dropdown.innerHTML = `
        <div style="padding: 15px; text-align: center; color: #999;">
          <i class="bi bi-search"></i> No sizes match "<strong>${escapeHtml(trimmedInput)}</strong>"
        </div>
      `;
      dropdown.style.display = 'block';
    }
    console.log('ℹ️ No sizes match:', trimmedInput);
  }
}


/**
 * Render bulk size suggestions
 */
function renderBulkSizeSuggestions(matches) {
  const dropdown = document.getElementById('sizeSuggestionsDropdown'); // Bulk edit dropdown
  if (!dropdown) return;
  
  let html = '';
  matches.slice(0, 15).forEach(size => {
    const escaped = escapeHtml(size);
    html += `
      <div onclick="selectBulkSizeSuggestion('${escaped}')" style="
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
      " onmouseover="this.style.background='#f5f5f5'" 
         onmouseout="this.style.background='transparent'">
        <strong>${size}</strong>
      </div>
    `;
  });
  
  dropdown.innerHTML = html;
  dropdown.style.display = 'block';
  
  console.log('✅ Rendered', matches.length, 'sizes for Bulk Edit');
}

/**
 * Select size from bulk dropdown
 */
function selectBulkSizeSuggestion(sizeName) {
  const input = document.getElementById('bulkSizeInput');
  const dropdown = document.getElementById('sizeSuggestionsDropdown');
  
  if (input) {
    input.value = sizeName;
  }
  
  // Update bulkEditMode
  bulkEditMode = {
    active: true,
    field: 'size',
    value: sizeName,
    selectedProducts: bulkEditMode?.selectedProducts || []
  };
  
  // Enable product selection
  if (typeof enableProductSelection === 'function') {
    enableProductSelection();
  }
  
  console.log('✅ Selected size:', sizeName);
  console.log('  bulkEditMode:', bulkEditMode);
  
  // Hide dropdown
  if (dropdown) {
    dropdown.style.display = 'none';
  }
  
  // Hide save button (size already exists)
  const saveBtn = document.getElementById('saveBulkSizeInsideBtn');
  if (saveBtn) {
    saveBtn.style.display = 'none';
  }
}

/**
 * Update bulkEditMode when typing
 */
function updateBulkSizeMode(value) {
  const size = value.trim();
  
  console.log('🔄 updateBulkSizeMode:', size);
  
  if (size && size.length > 0) {
    bulkEditMode = {
      active: true,
      field: 'size',
      value: size,
      selectedProducts: bulkEditMode?.selectedProducts || []
    };
    
    if (typeof enableProductSelection === 'function') {
      enableProductSelection();
      console.log('✅ Product selection enabled');
    }
    
    console.log('✅ Bulk size set to:', size);
  } else {
    bulkEditMode.active = false;
    bulkEditMode.value = null;
  }
  
  // Check save button
  checkAndShowSaveBulkSizeButton(size);
}

/**
 * Check if size exists and show/hide save button
 */
function checkAndShowSaveBulkSizeButton(inputText) {
  const btn = document.getElementById('saveBulkSizeInsideBtn');
  if (!btn) return;
  
  const input = inputText.trim();
  
  if (!input || input.length === 0) {
    btn.style.display = 'none';
    return;
  }
  
  if (!sizeAutocompleteCache || sizeAutocompleteCache.length === 0) {
    btn.style.display = 'none';
    return;
  }
  
  const sizeExists = sizeAutocompleteCache.some(size => 
    size.toLowerCase() === input.toLowerCase()
  );
  
  if (!sizeExists) {
    btn.innerHTML = '💾';
    btn.style.background = '#007bff';
    btn.style.cursor = 'pointer';
    btn.disabled = false;
    btn.style.display = 'block';
  } else {
    btn.style.display = 'none';
  }
}

/**
 * Save new size from bulk field
 */
async function saveNewSizeFromBulkField() {
  const input = document.getElementById('bulkSizeInput');
  const sizeName = input.value.trim();
  const btn = document.getElementById('saveBulkSizeInsideBtn');
  
  if (!sizeName || sizeName.length === 0) {
    return;
  }
  
  const user = window.auth.currentUser;
  if (!user) {
    alert('Please sign in to save sizes');
    return;
  }
  
  const sizeExists = sizeAutocompleteCache.some(size => 
    size.toLowerCase() === sizeName.toLowerCase()
  );
  
  if (sizeExists) {
    if (btn) btn.style.display = 'none';
    return;
  }
  
  console.log('💾 Saving new size:', sizeName);
  
  if (btn) {
    btn.innerHTML = '⏳ Saving...';
    btn.style.background = '#6c757d';
    btn.disabled = true;
  }
  
  try {
    const { collection, addDoc } = window.firebaseImports;
    
    const sizesRef = collection(window.db, 'tenants', user.uid, 'sizes');
    await addDoc(sizesRef, {
      name: sizeName,
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
      userId: user.uid
    });
    
    console.log('✅ Size saved:', sizeName);
    
    // Add to caches
    sizeAutocompleteCache.push(sizeName);
    if (typeof sizesCache !== 'undefined') {
      sizesCache.push(sizeName);
    }
    
    if (btn) {
      btn.innerHTML = '✅ Saved';
      btn.style.background = '#0056b3';
    }
    
    if (typeof syncSizeCaches === 'function') {
      syncSizeCaches();
    }
    
  } catch (error) {
    console.error('❌ Error saving size:', error);
    
    if (btn) {
      btn.innerHTML = '❌ Error';
      btn.style.background = '#dc3545';
      
      setTimeout(() => {
        btn.innerHTML = '💾';
        btn.style.background = '#007bff';
        btn.disabled = false;
      }, 2000);
    }
    
    alert('Error saving size: ' + error.message);
  }
}

/**
 * Apply Bulk Size Update
 */
async function applyBulkSizeUpdate() {
  const sizeInput = document.getElementById('bulkSizeInput');
  if (!sizeInput) {
    alert('❌ Size input not found');
    return;
  }
  
  const size = sizeInput.value.trim();
  const finalSize = size || bulkEditMode.value;
  
  console.log('🔍 Applying bulk size update:');
  console.log('  Size:', finalSize);
  console.log('  Selected:', bulkEditMode.selectedProducts?.length || 0);
  
  if (!finalSize || finalSize.length === 0) {
    alert('⚠️ Please enter a size');
    sizeInput.focus();
    return;
  }
  
  if (!bulkEditMode.selectedProducts || bulkEditMode.selectedProducts.length === 0) {
    alert('⚠️ Please select at least one product');
    return;
  }
  
  const count = bulkEditMode.selectedProducts.length;
  
  if (!confirm(`Update size to "${finalSize}" for ${count} product(s)?`)) {
    return;
  }
  
  const btn = document.getElementById('updateSizeBtn');
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Updating...';
  
  try {
    const user = window.auth?.currentUser;
    if (!user) {
      throw new Error('Not authenticated');
    }
    
    const { doc, setDoc } = window.firebaseImports;
    const userId = user.uid;
    
    console.log(`📝 Updating ${count} products to size: "${finalSize}"`);
    
    let successCount = 0;
    let errorCount = 0;
    
    for (const productId of bulkEditMode.selectedProducts) {
      try {
        const product = cachedProducts.find(p => p.id === productId);
        if (!product) {
          errorCount++;
          continue;
        }
        
        const updatedProduct = {
          ...product,
          size: finalSize,
          updatedAt: new Date().toISOString()
        };
        
        const productRef = doc(window.db, 'tenants', userId, 'products', productId);
        await setDoc(productRef, updatedProduct);
        
        const cacheIdx = cachedProducts.findIndex(p => p.id === productId);
        if (cacheIdx !== -1) {
          cachedProducts[cacheIdx].size = finalSize;
        }
        
        successCount++;
        
      } catch (error) {
        console.error('❌ Error updating product:', productId, error);
        errorCount++;
      }
    }
    
    // Update cache
    try {
      localStorage.setItem('inventory_products_cache', JSON.stringify(cachedProducts));
    } catch (e) {
      console.warn('⚠️ Failed to update cache:', e);
    }
    
    console.log(`✅ Complete: ${successCount} success, ${errorCount} errors`);
    
    cancelBulkEdit();
    
    if (typeof renderProducts === 'function') {
      renderProducts();
    }
    
    if (errorCount > 0) {
      alert(`✅ Updated ${successCount} product(s)\n⚠️ ${errorCount} error(s)`);
    } else {
      alert(`✅ Successfully updated ${successCount} product(s)!`);
    }
    
  } catch (error) {
    console.error('❌ Error:', error);
    alert('❌ Error: ' + error.message);
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}

// ✅ Make all functions global
window.showSizeBulkEdit = showSizeBulkEdit;
window.showBulkSizeSuggestions = showBulkSizeSuggestions;
window.filterBulkSizeSuggestions = filterBulkSizeSuggestions;
window.renderBulkSizeSuggestions = renderBulkSizeSuggestions;
window.selectBulkSizeSuggestion = selectBulkSizeSuggestion;
window.updateBulkSizeMode = updateBulkSizeMode;
window.checkAndShowSaveBulkSizeButton = checkAndShowSaveBulkSizeButton;
window.saveNewSizeFromBulkField = saveNewSizeFromBulkField;
window.applyBulkSizeUpdate = applyBulkSizeUpdate;

console.log('✅ Bulk size edit functions loaded');



/**
 * ==========================================
 * 🎯 BULK EDIT - BRAND (SEPARATE DROPDOWN SYSTEM)
 * ==========================================
 */

/**
 * Show Brand Bulk Edit
 */
 function showBrandBulkEdit() {
  console.log('📝 Opening brand bulk edit mode...');
  
  // Reset state
  bulkEditMode = {
    active: false,
    field: null,
    value: null,
    selectedProducts: []
  };
  
  // Hide main dropdown button
  const mainDropdownContainer = document.querySelector('#bulkEditDropdown').closest('.dropdown');
  if (mainDropdownContainer) {
    mainDropdownContainer.style.display = 'none';
  }
  
  // Show brand input and buttons
  document.getElementById('brandInputContainer').style.display = 'flex';
  document.getElementById('updateBrandBtn').style.display = 'inline-block';
  document.getElementById('cancelBulkEditBtn').style.display = 'inline-block';
  document.getElementById('bulkEditInfoText').style.display = 'block';
  document.getElementById('bulkEditToolbar').classList.add('active');
  
  // Reset counter
  const countEl = document.getElementById('selectedCountBrand');
  if (countEl) countEl.textContent = '0';
  
  // Clear input and reset save button
  const brandInput = document.getElementById('bulkBrandInput');
  if (brandInput) {
    brandInput.value = '';
    
    // Hide save button
    const saveBtn = document.getElementById('saveBulkBrandInsideBtn');
    if (saveBtn) {
      saveBtn.style.display = 'none';
      saveBtn.innerHTML = '💾';
      saveBtn.style.background = '#28a745';
      saveBtn.disabled = false;
    }
    
    // Force load brand cache if empty
    if (!brandAutocompleteCache || brandAutocompleteCache.length === 0) {
      console.log('⚠️ Brand cache empty, loading...');
      if (typeof loadBrandAutocompleteCache === 'function') {
        loadBrandAutocompleteCache();
      }
    }
    
    // Focus and re-attach close handler
    setTimeout(() => {
      brandInput.focus();
      
      // Re-attach close handler
      if (typeof attachBrandDropdownCloseHandler === 'function') {
        attachBrandDropdownCloseHandler();
      }
      
      console.log('✅ Input focused');
    }, 150);
  } else {
    console.error('❌ bulkBrandInput not found');
  }
  
  console.log('✅ Brand bulk edit ready');
}

/**
 * Show bulk brand suggestions
 */
async function showBulkBrandSuggestions() {
  const input = document.getElementById('bulkBrandInput');
  if (!input) return;
  
  console.log('👆 Bulk brand field clicked');
  
  // Load cache if empty
  if (!brandAutocompleteCache || brandAutocompleteCache.length === 0) {
    const user = window.auth.currentUser;
    if (user) {
      try {
        const { collection, getDocs } = window.firebaseImports;
        const brandsRef = collection(window.db, 'tenants', user.uid, 'brands');
        const snapshot = await getDocs(brandsRef);
        
        const brands = [];
        snapshot.forEach((doc) => {
          const data = doc.data();
          const brandName = data.name || data.brandName;
          if (brandName) brands.push(brandName);
        });
        
        brandAutocompleteCache = brands;
        console.log('✅ Loaded', brands.length, 'brands for Bulk Edit');
      } catch (error) {
        console.error('❌ Error loading brands:', error);
        return;
      }
    }
  }
  
  const inputValue = input.value.trim();
  
  // Show all or filtered
  if (!inputValue) {
    if (brandAutocompleteCache.length > 0) {
      renderBulkBrandSuggestions(brandAutocompleteCache);
    }
  } else {
    filterBulkBrandSuggestions(inputValue);
  }
}
/**
 * Filter bulk brand suggestions
 * ✅ Enhanced version with smooth UX
 */
 function filterBulkBrandSuggestions(inputText) {
  const dropdown = document.getElementById('brandSuggestionsDropdown'); // Bulk edit dropdown
  const input = document.getElementById('bulkBrand'); // Adjust ID if different
  
  if (!input) {
    console.warn('⚠️ Bulk brand input field not found');
    // Try alternate IDs
    const altInput = document.getElementById('brand') || document.querySelector('[data-bulk-brand]');
    if (altInput) {
      console.log('✅ Found alternate brand input');
    }
  }
  
  // Check if input field is focused (use the input if found)
  const targetInput = input || document.getElementById('brand');
  const isFocused = targetInput && document.activeElement === targetInput;
  
  // Normalize input
  const trimmedInput = inputText ? inputText.trim() : '';
  
  // ✅ CASE 1: Input is empty
  if (!trimmedInput || trimmedInput.length === 0) {
    // Show all brands ONLY if field is focused
    if (isFocused) {
      if (brandAutocompleteCache && brandAutocompleteCache.length > 0) {
        renderBulkBrandSuggestions(brandAutocompleteCache);
        console.log('✅ Showing all', brandAutocompleteCache.length, 'brands in bulk (field focused, input empty)');
      } else {
        // No brands in cache
        if (dropdown) {
          dropdown.innerHTML = `
            <div style="padding: 15px; text-align: center; color: #999;">
              <i class="bi bi-inbox"></i> No brands available
            </div>
          `;
          dropdown.style.display = 'block';
        }
        console.log('ℹ️ No brands in cache');
      }
    } else {
      // Field not focused, hide dropdown
      if (dropdown) dropdown.style.display = 'none';
    }
    
    return;
  }
  
  // ✅ CASE 2: User is typing - filter brands
  const query = trimmedInput.toLowerCase();
  const matches = brandAutocompleteCache.filter(brand => 
    brand.toLowerCase().startsWith(query)
  );
  
  if (matches.length > 0) {
    // Show filtered results
    renderBulkBrandSuggestions(matches);
    console.log('✅ Showing', matches.length, 'brands in bulk matching "' + trimmedInput + '"');
  } else {
    // No matches found
    if (dropdown) {
      dropdown.innerHTML = `
        <div style="padding: 15px; text-align: center; color: #999;">
          <i class="bi bi-search"></i> No brands match "<strong>${escapeHtml(trimmedInput)}</strong>"
        </div>
      `;
      dropdown.style.display = 'block';
    }
    console.log('ℹ️ No brands match:', trimmedInput);
  }
}

/**
 * Render bulk brand suggestions
 */
function renderBulkBrandSuggestions(matches) {
  const dropdown = document.getElementById('brandSuggestionsDropdown'); // Bulk edit dropdown
  if (!dropdown) return;
  
  let html = '';
  matches.slice(0, 15).forEach(brand => {
    const escaped = escapeHtml(brand);
    html += `
      <div onclick="selectBulkBrandSuggestion('${escaped}')" style="
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
      " onmouseover="this.style.background='#f5f5f5'" 
         onmouseout="this.style.background='transparent'">
        <strong>${brand}</strong>
      </div>
    `;
  });
  
  dropdown.innerHTML = html;
  dropdown.style.display = 'block';
  
  console.log('✅ Rendered', matches.length, 'brands for Bulk Edit');
}

/**
 * Select brand from bulk dropdown
 */
function selectBulkBrandSuggestion(brandName) {
  const input = document.getElementById('bulkBrandInput');
  const dropdown = document.getElementById('brandSuggestionsDropdown');
  
  if (input) {
    input.value = brandName;
  }
  
  // Update bulkEditMode
  bulkEditMode = {
    active: true,
    field: 'brand',
    value: brandName,
    selectedProducts: bulkEditMode?.selectedProducts || []
  };
  
  // Enable product selection
  if (typeof enableProductSelection === 'function') {
    enableProductSelection();
  }
  
  console.log('✅ Selected brand:', brandName);
  console.log('  bulkEditMode:', bulkEditMode);
  
  // Hide dropdown
  if (dropdown) {
    dropdown.style.display = 'none';
  }
  
  // Hide save button (brand already exists)
  const saveBtn = document.getElementById('saveBulkBrandInsideBtn');
  if (saveBtn) {
    saveBtn.style.display = 'none';
  }
}

/**
 * Update bulkEditMode when typing
 */
function updateBulkBrandMode(value) {
  const brand = value.trim();
  
  console.log('🔄 updateBulkBrandMode:', brand);
  
  if (brand && brand.length > 0) {
    bulkEditMode = {
      active: true,
      field: 'brand',
      value: brand,
      selectedProducts: bulkEditMode?.selectedProducts || []
    };
    
    if (typeof enableProductSelection === 'function') {
      enableProductSelection();
      console.log('✅ Product selection enabled');
    }
    
    console.log('✅ Bulk brand set to:', brand);
  } else {
    bulkEditMode.active = false;
    bulkEditMode.value = null;
  }
  
  // Check save button
  checkAndShowSaveBulkBrandButton(brand);
}

/**
 * Check if brand exists and show/hide save button
 */
function checkAndShowSaveBulkBrandButton(inputText) {
  const btn = document.getElementById('saveBulkBrandInsideBtn');
  if (!btn) return;
  
  const input = inputText.trim();
  
  if (!input || input.length === 0) {
    btn.style.display = 'none';
    return;
  }
  
  if (!brandAutocompleteCache || brandAutocompleteCache.length === 0) {
    btn.style.display = 'none';
    return;
  }
  
  const brandExists = brandAutocompleteCache.some(brand => 
    brand.toLowerCase() === input.toLowerCase()
  );
  
  if (!brandExists) {
    btn.innerHTML = '💾';
    btn.style.background = '#28a745';
    btn.style.cursor = 'pointer';
    btn.disabled = false;
    btn.style.display = 'block';
  } else {
    btn.style.display = 'none';
  }
}

/**
 * Save new brand from bulk field
 */
async function saveNewBrandFromBulkField() {
  const input = document.getElementById('bulkBrandInput');
  const brandName = input.value.trim();
  const btn = document.getElementById('saveBulkBrandInsideBtn');
  
  if (!brandName || brandName.length === 0) {
    return;
  }
  
  const user = window.auth.currentUser;
  if (!user) {
    alert('Please sign in to save brands');
    return;
  }
  
  const brandExists = brandAutocompleteCache.some(brand => 
    brand.toLowerCase() === brandName.toLowerCase()
  );
  
  if (brandExists) {
    if (btn) btn.style.display = 'none';
    return;
  }
  
  console.log('💾 Saving new brand:', brandName);
  
  if (btn) {
    btn.innerHTML = '⏳ Saving...';
    btn.style.background = '#6c757d';
    btn.disabled = true;
  }
  
  try {
    const { collection, addDoc } = window.firebaseImports;
    
    const brandsRef = collection(window.db, 'tenants', user.uid, 'brands');
    await addDoc(brandsRef, {
      name: brandName,
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
      userId: user.uid
    });
    
    console.log('✅ Brand saved:', brandName);
    
    // Add to caches
    brandAutocompleteCache.push(brandName);
    if (typeof brandsCache !== 'undefined') {
      brandsCache.push(brandName);
    }
    
    if (btn) {
      btn.innerHTML = '✅ Saved';
      btn.style.background = '#218838';
    }
    
    if (typeof syncBrandCaches === 'function') {
      syncBrandCaches();
    }
    
  } catch (error) {
    console.error('❌ Error saving brand:', error);
    
    if (btn) {
      btn.innerHTML = '❌ Error';
      btn.style.background = '#dc3545';
      
      setTimeout(() => {
        btn.innerHTML = '💾';
        btn.style.background = '#28a745';
        btn.disabled = false;
      }, 2000);
    }
    
    alert('Error saving brand: ' + error.message);
  }
}

/**
 * Apply Bulk Brand Update
 */
async function applyBulkBrandUpdate() {
  const brandInput = document.getElementById('bulkBrandInput');
  if (!brandInput) {
    alert('❌ Brand input not found');
    return;
  }
  
  const brand = brandInput.value.trim();
  const finalBrand = brand || bulkEditMode.value;
  
  console.log('🔍 Applying bulk brand update:');
  console.log('  Brand:', finalBrand);
  console.log('  Selected:', bulkEditMode.selectedProducts?.length || 0);
  
  if (!finalBrand || finalBrand.length === 0) {
    alert('⚠️ Please enter a brand');
    brandInput.focus();
    return;
  }
  
  if (!bulkEditMode.selectedProducts || bulkEditMode.selectedProducts.length === 0) {
    alert('⚠️ Please select at least one product');
    return;
  }
  
  const count = bulkEditMode.selectedProducts.length;
  
  if (!confirm(`Update brand to "${finalBrand}" for ${count} product(s)?`)) {
    return;
  }
  
  const btn = document.getElementById('updateBrandBtn');
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Updating...';
  
  try {
    const user = window.auth?.currentUser;
    if (!user) {
      throw new Error('Not authenticated');
    }
    
    const { doc, setDoc } = window.firebaseImports;
    const userId = user.uid;
    
    console.log(`📝 Updating ${count} products to brand: "${finalBrand}"`);
    
    let successCount = 0;
    let errorCount = 0;
    
    for (const productId of bulkEditMode.selectedProducts) {
      try {
        const product = cachedProducts.find(p => p.id === productId);
        if (!product) {
          errorCount++;
          continue;
        }
        
        const updatedProduct = {
          ...product,
          brand: finalBrand,
          updatedAt: new Date().toISOString()
        };
        
        const productRef = doc(window.db, 'tenants', userId, 'products', productId);
        await setDoc(productRef, updatedProduct);
        
        const cacheIdx = cachedProducts.findIndex(p => p.id === productId);
        if (cacheIdx !== -1) {
          cachedProducts[cacheIdx].brand = finalBrand;
        }
        
        successCount++;
        
      } catch (error) {
        console.error('❌ Error updating product:', productId, error);
        errorCount++;
      }
    }
    
    // Update cache
    try {
      localStorage.setItem('inventory_products_cache', JSON.stringify(cachedProducts));
    } catch (e) {
      console.warn('⚠️ Failed to update cache:', e);
    }
    
    console.log(`✅ Complete: ${successCount} success, ${errorCount} errors`);
    
    cancelBulkEdit();
    
    if (typeof renderProducts === 'function') {
      renderProducts();
    }
    
    if (errorCount > 0) {
      alert(`✅ Updated ${successCount} product(s)\n⚠️ ${errorCount} error(s)`);
    } else {
      alert(`✅ Successfully updated ${successCount} product(s)!`);
    }
    
  } catch (error) {
    console.error('❌ Error:', error);
    alert('❌ Error: ' + error.message);
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}

// ✅ Make all functions global
window.showBrandBulkEdit = showBrandBulkEdit;
window.showBulkBrandSuggestions = showBulkBrandSuggestions;
window.filterBulkBrandSuggestions = filterBulkBrandSuggestions;
window.renderBulkBrandSuggestions = renderBulkBrandSuggestions;
window.selectBulkBrandSuggestion = selectBulkBrandSuggestion;
window.updateBulkBrandMode = updateBulkBrandMode;
window.checkAndShowSaveBulkBrandButton = checkAndShowSaveBulkBrandButton;
window.saveNewBrandFromBulkField = saveNewBrandFromBulkField;
window.applyBulkBrandUpdate = applyBulkBrandUpdate;

console.log('✅ Bulk brand edit functions loaded');

/**
 * ==========================================
 * 🎯 BULK EDIT - STOCK ADJUSTMENT (INSTANT CLICK)
 * ==========================================
 */

/**
 * Show Stock Adjustment Mode
 * ✅ Highlights eligible products
 */
 function showStockAdjustmentEdit() {
  console.log('📝 Opening stock adjustment mode...');
  
  // ✅ RESET STATE
  bulkEditMode = {
    active: true,
    field: 'stockAdjustment',
    value: null,
    operation: 'reduce',
    amount: 10,
    selectedProducts: []
  };
  
  // ✅ HIDE THE MAIN DROPDOWN BUTTON
  const mainDropdownContainer = document.querySelector('#bulkEditDropdown').closest('.dropdown');
  if (mainDropdownContainer) {
    mainDropdownContainer.style.display = 'none';
  }
  
  // ✅ Show stock adjustment UI AND both buttons
  document.getElementById('stockAdjustmentContainer').style.display = 'block';
  document.getElementById('cancelBulkEditBtn').style.display = 'inline-block';
  document.getElementById('updateStockChangesBtn').style.display = 'inline-block';
  document.getElementById('bulkEditInfoText').style.display = 'block';
  document.getElementById('bulkEditToolbar').classList.add('active');
  
  // ✅ ADD BODY CLASS for styling
  document.body.classList.add('stock-adjustment-active');
  
  // ✅ HIGHLIGHT ELIGIBLE PRODUCTS IMMEDIATELY
  highlightStockAdjustableProducts();
  
  // ✅ Set default operation
  setStockOperation('reduce');
  
  // ✅ Listen for input changes
  const stockInput = document.getElementById('stockAdjustmentInput');
  stockInput.addEventListener('input', function() {
    const amount = parseInt(stockInput.value);
    if (!isNaN(amount) && amount > 0) {
      bulkEditMode.amount = amount;
      console.log('✅ Stock adjustment amount set to:', amount);
    }
  });
  
  // ✅ Enable stock adjustment mode
  enableStockAdjustmentMode();
  
  console.log('✅ Stock adjustment mode active with highlighting');
}


/**
 * ==========================================
 * HIGHLIGHT ELIGIBLE PRODUCTS FOR STOCK ADJUSTMENT
 * ==========================================
 * Highlights products that have numeric stock
 */
 function highlightStockAdjustableProducts() {
  console.log('🎨 Highlighting stock adjustable products...');
  
  let eligibleCount = 0;
  
  // ✅ DESKTOP - Table rows
  const tableRows = document.querySelectorAll('#productsTableBody tr[data-product-id]');
  tableRows.forEach(row => {
    const productId = row.getAttribute('data-product-id');
    const product = cachedProducts.find(p => p.id === productId);
    
    // Check if product has NUMERIC stock
    if (product && typeof product.stock === 'number') {
      // ✅ Add highlight class
      row.classList.add('product-stock-adjustable-eligible');
      eligibleCount++;
    } else {
      // Non-eligible products - dim them
      row.classList.remove('product-stock-adjustable-eligible');
      row.style.opacity = '0.4';
      row.style.filter = 'grayscale(30%)';
      row.style.pointerEvents = 'none';
    }
  });
  
  // ✅ MOBILE - Product cards
  const mobileCards = document.querySelectorAll('.mobile-item[data-product-id]');
  mobileCards.forEach(card => {
    const productId = card.getAttribute('data-product-id');
    const product = cachedProducts.find(p => p.id === productId);
    
    // Check if product has NUMERIC stock
    if (product && typeof product.stock === 'number') {
      // ✅ Add highlight class
      card.classList.add('product-stock-adjustable-eligible');
      eligibleCount++;
    } else {
      // Non-eligible products - dim them
      card.classList.remove('product-stock-adjustable-eligible');
      card.style.opacity = '0.4';
      card.style.filter = 'grayscale(30%)';
      card.style.pointerEvents = 'none';
    }
  });
  
  console.log(`✅ Highlighted ${eligibleCount} stock adjustable products`);
  
  
}




/**
 * Set Stock Operation (Add or Reduce) - WITH TRANSLATION & FIXED CLOSING
 */
 function setStockOperation(operation) {
  bulkEditMode.operation = operation;
  
  const btn = document.getElementById('stockOperationBtn');
  const lang = window.currentLanguage || 'en';
  
  // ✅ 1. FORCE CLOSE dropdown (Simulate Body Click)
  // This ensures the "Add/Reduce" menu closes after clicking an item
  setTimeout(() => {
    document.body.click();
  }, 10);

  // ✅ 2. Update UI Logic
  if (operation === 'add') {
    // Get translated text
    const addByText = window.translations?.[lang]?.addBy || 'Add by';
    btn.innerHTML = '<i class="bi bi-plus-circle"></i> ' + addByText;
    btn.classList.remove('btn-outline-danger');
    btn.classList.add('btn-outline-success');
  } else {
    // Get translated text
    const reduceByText = window.translations?.[lang]?.reduceBy || 'Reduce by';
    btn.innerHTML = '<i class="bi bi-dash-circle"></i> ' + reduceByText;
    btn.classList.remove('btn-outline-success');
    btn.classList.add('btn-outline-danger');
  }
  
  console.log('✅ Stock operation set to:', operation);
}

/**
 * Enable Stock Adjustment Mode - Click to adjust
 */
/**
 * Enable Stock Adjustment Mode - Click to adjust (NO SELECTION INDICATORS)
 */
function enableStockAdjustmentMode() {
  console.log('🖱️ Stock adjustment mode enabled');
  
  // Desktop
  const tableRows = document.querySelectorAll('#productsTableBody tr[data-product-id]');
  tableRows.forEach(row => {
    const productId = row.getAttribute('data-product-id');
    const product = cachedProducts.find(p => p.id === productId);
    
    // Only enable for products with NUMERIC stock
    if (product && typeof product.stock === 'number') {
      row.classList.add('stock-adjustable');
      row.onclick = function(event) {
        if (event.target.closest('.btn')) return;
        event.stopPropagation();
        event.preventDefault();
        adjustProductStock(productId, row);
      };
    }
  });
  
  // Mobile - FIXED: Prevent selection indicator from appearing
  const mobileCards = document.querySelectorAll('.mobile-item[data-product-id]');
  mobileCards.forEach(card => {
    const productId = card.getAttribute('data-product-id');
    const product = cachedProducts.find(p => p.id === productId);
    
    // Only enable for products with NUMERIC stock
    if (product && typeof product.stock === 'number') {
      card.classList.add('stock-adjustable');
      
      // ✅ FIXED: Remove any existing selection indicator
      const indicator = card.querySelector('.selection-indicator');
      if (indicator) {
        indicator.style.display = 'none';
      }
      
      // ✅ FIXED: Prevent card from being selected
      card.classList.remove('product-selectable');
      card.classList.remove('product-selected');
      
      // ✅ Set click handler for stock adjustment (NO SELECTION)
      card.onclick = function(event) {
        if (event.target.closest('.btn')) return;
        event.stopPropagation();
        event.preventDefault();
        
        // ✅ FIXED: Ensure indicator stays hidden during adjustment
        if (indicator) indicator.style.display = 'none';
        
        adjustProductStock(productId, card);
      };
    }
  });
  
  console.log('✅ Stock adjustment enabled (selection disabled)');
}


/**
 * Adjust Product Stock - FIRESTORE VERSION
 * ✅ NO RE-RENDER - Updates display in-place
 */
 async function adjustProductStock(productId, element) {
  if (!bulkEditMode.active || bulkEditMode.field !== 'stockAdjustment') return;
  
  const operation = bulkEditMode.operation;
  const amount = bulkEditMode.amount;
  
  if (!amount || amount <= 0) {
    alert('⚠️ Please enter a valid amount');
    return;
  }
  
  const indicator = element.querySelector('.selection-indicator');
  if (indicator) indicator.style.display = 'none';
  
  element.classList.remove('product-selected');
  
  // ✅ Show animation BEFORE updating
  showStockAnimation(element, operation, amount);
  
  try {
    const user = window.auth?.currentUser;
    if (!user) throw new Error('Not authenticated');
    
    const { doc, setDoc } = window.firebaseImports;
    const userId = user.uid;
    
    // Get product
    const product = cachedProducts.find(p => p.id === productId);
    if (!product || typeof product.stock !== 'number') {
      throw new Error('Invalid product or stock type');
    }
    
    // Calculate new stock
    let newStock = product.stock;
    if (operation === 'add') {
      newStock += amount;
    } else {
      newStock = Math.max(0, newStock - amount);
    }
    
    console.log(`📊 Stock adjustment: ${product.stock} → ${newStock} (${operation} ${amount})`);
    
    // Update product
    const updatedProduct = {
      ...product,
      stock: newStock,
      updatedAt: new Date().toISOString()
    };
    
    // Save to Firestore
    const productRef = doc(window.db, 'tenants', userId, 'products', productId);
    await setDoc(productRef, updatedProduct);
    
    // Update cache
    const cacheIdx = cachedProducts.findIndex(p => p.id === productId);
    if (cacheIdx !== -1) {
      cachedProducts[cacheIdx].stock = newStock;
    }
    
    localStorage.setItem('inventory_products_cache', JSON.stringify(cachedProducts));
    
    console.log('✅ Stock saved to Firestore');
    
    // ✅ UPDATE STOCK DISPLAY IN-PLACE (NO RE-RENDER)
    updateStockDisplayOnly(productId, newStock, element, product.minStock);
    
    // ✅ Keep highlighting intact
    element.classList.add('product-stock-adjustable-eligible');
    element.style.opacity = '';
    element.style.filter = '';
    element.style.pointerEvents = '';
    
  } catch (error) {
    console.error('❌ Error adjusting stock:', error);
    alert('❌ Error: ' + error.message);
  }
}

/**
 * ==========================================
 * UPDATE STOCK DISPLAY ONLY
 * ==========================================
 * Updates the stock badge HTML without re-rendering entire product list
 * ✅ Works with stockBadgeHtml() function
 */
 function updateStockDisplayOnly(productId, newStock, element, minStock) {
  console.log('🔄 Updating stock display for product:', productId, 'New stock:', newStock);
  
  // ✅ Find the stock cell/div using data-field attribute
  const stockElement = element.querySelector('[data-field="stock"]');
  
  if (stockElement) {
    console.log('✅ Found stock element, updating with badge HTML...');
    
    // ✅ Generate new stock badge HTML
    const newStockBadgeHtml = stockBadgeHtml(newStock, minStock);
    
    // ✅ Update the innerHTML
    stockElement.innerHTML = newStockBadgeHtml;
    
    console.log('✅ Stock badge updated successfully');
  } else {
    console.warn('⚠️ Stock element not found, trying fallback selectors...');
    
    // ✅ FALLBACK: Try finding by position (6th td in desktop, or any element with stock text)
    if (element.tagName === 'TR') {
      // Desktop table row
      const cells = element.querySelectorAll('td');
      if (cells.length >= 6) {
        const stockCell = cells[5]; // 6th column (0-indexed)
        const newStockBadgeHtml = stockBadgeHtml(newStock, minStock);
        stockCell.innerHTML = newStockBadgeHtml;
        console.log('✅ Stock updated via fallback (desktop)');
      }
    } else {
      // Mobile card
      const stockDivs = element.querySelectorAll('div');
      stockDivs.forEach(div => {
        // Look for div that contains stock badge classes or numeric stock
        if (div.innerHTML.includes('IN STOCK') || 
            div.innerHTML.includes('OUT OF STOCK') || 
            div.innerHTML.includes('GOOD') ||
            div.innerHTML.includes('MEDIUM') ||
            div.innerHTML.includes('LOW') ||
            div.innerHTML.includes('URGENT')) {
          const newStockBadgeHtml = stockBadgeHtml(newStock, minStock);
          div.innerHTML = newStockBadgeHtml;
          console.log('✅ Stock updated via fallback (mobile)');
        }
      });
    }
  }
  
  // ✅ Keep highlighting intact
  element.classList.add('product-stock-adjustable-eligible');
  element.style.opacity = '';
  element.style.filter = '';
  element.style.pointerEvents = '';
}



/**
 * ==========================================
 * REMOVE STOCK ADJUSTMENT HIGHLIGHTING
 * ==========================================
 * Removes all highlighting from products
 */
 function removeStockAdjustmentHighlighting() {
  console.log('🧹 Removing stock adjustment highlighting...');
  
  // ✅ DESKTOP - Table rows
  const tableRows = document.querySelectorAll('#productsTableBody tr[data-product-id]');
  tableRows.forEach(row => {
    // Remove highlight class
    row.classList.remove('product-stock-adjustable-eligible');
    
    // Remove inline styles
    row.style.opacity = '';
    row.style.filter = '';
    row.style.pointerEvents = '';
  });
  
  // ✅ MOBILE - Product cards
  const mobileCards = document.querySelectorAll('.mobile-item[data-product-id]');
  mobileCards.forEach(card => {
    // Remove highlight class
    card.classList.remove('product-stock-adjustable-eligible');
    
    // Remove inline styles
    card.style.opacity = '';
    card.style.filter = '';
    card.style.pointerEvents = '';
  });
  
  console.log('✅ Stock adjustment highlighting removed');
}


/**
 * Show Stock Animation
 * ✅ Improved with better visual effects
 */
 function showStockAnimation(element, operation, amount) {
  // ✅ Create animation element
  const animationDiv = document.createElement('div');
  animationDiv.className = 'stock-animation' + (operation === 'reduce' ? ' reduce' : '');
  animationDiv.textContent = (operation === 'add' ? '+' : '-') + amount;
  
  // ✅ Add flash effect to card
  const flashClass = operation === 'add' ? 'stock-add-flash' : 'stock-reduce-flash';
  element.classList.add(flashClass);
  element.classList.add('stock-adjustment-flash');
  
  // ✅ Position relative to element
  element.style.position = 'relative';
  element.appendChild(animationDiv);
  
  // ✅ Remove animation after completion
  setTimeout(() => {
    animationDiv.remove();
    element.classList.remove(flashClass);
    element.classList.remove('stock-adjustment-flash');
  }, 1000);
  
  // ✅ Add haptic feedback (if supported)
  if (navigator.vibrate) {
    navigator.vibrate(operation === 'add' ? [50] : [100]);
  }
}

/**
 * Update Stock Changes - Sync webapp cache to Firestore
 * FIRESTORE VERSION
 * ✅ Fixed to properly close bulk edit mode
 */
 async function updateStockChanges() {
  console.log('🔄 Finalizing stock changes...');
  
  const btn = document.getElementById('updateStockChangesBtn');
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Finalizing...';
  
  try {
    // ✅ Show success message
    if (typeof showToast === 'function') {
      showToast('✅ Success', 'All stock changes have been saved to Firestore', 'success');
    } else {
      alert('✅ All stock changes saved successfully!');
    }
    
    console.log('✅ Stock changes finalized');
    
    // ✅ Cancel bulk edit mode and remove highlighting
    cancelBulkEdit();
    
    // ✅ Re-render products to show final state
    if (typeof renderProducts === 'function') {
      renderProducts();
    }
    
  } catch (error) {
    console.error('❌ Error:', error);
    alert('❌ Error: ' + error.message);
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}



/**
 * ==========================================
 * 🎯 BULK EDIT - STOCK STATUS
 * ==========================================
 */
/**
 * Show Stock Status Bulk Edit
 * ✅ Highlights eligible products
 */
 function showStockStatusBulkEdit() {
  console.log('📝 Opening stock status bulk edit mode...');
  
  // ✅ HIDE THE MAIN DROPDOWN BUTTON
  const mainDropdownContainer = document.querySelector('#bulkEditDropdown').closest('.dropdown');
  if (mainDropdownContainer) {
    mainDropdownContainer.style.display = 'none';
  }
  
  // ✅ Show stock status selection UI AND cancel button
  document.getElementById('stockStatusSelectionDropdown').style.display = 'inline-block';
  document.getElementById('cancelBulkEditBtn').style.display = 'inline-block';
  document.getElementById('bulkEditInfoText').style.display = 'block';
  document.getElementById('bulkEditToolbar').classList.add('active');
  
  // ✅ ADD BODY CLASS for styling
  document.body.classList.add('stock-status-edit-active');
  
  // ✅ HIGHLIGHT ELIGIBLE PRODUCTS IMMEDIATELY
  highlightStockStatusEligibleProducts();
  
  console.log('✅ Stock status selection UI shown with product highlighting');
}
/**
 * ==========================================
 * HIGHLIGHT ELIGIBLE PRODUCTS FOR STOCK STATUS UPDATE
 * ==========================================
 * Highlights products that have text-based stock status (GOOD, MEDIUM, LOW, URGENT)
 * ✅ NO BADGES - Only visual highlighting
 */
 function highlightStockStatusEligibleProducts() {
  console.log('🎨 Highlighting stock status eligible products...');
  
  let eligibleCount = 0;
  
  // ✅ DESKTOP - Table rows
  const tableRows = document.querySelectorAll('#productsTableBody tr[data-product-id]');
  tableRows.forEach(row => {
    const productId = row.getAttribute('data-product-id');
    const product = cachedProducts.find(p => p.id === productId);
    
    // Check if product has TEXT stock status
    if (product && typeof product.stock === 'string' && 
        ['GOOD', 'MEDIUM', 'LOW', 'URGENT'].includes(product.stock.toUpperCase())) {
      
      // ✅ Add highlight class ONLY
      row.classList.add('product-stock-status-eligible');
      eligibleCount++;
      
    } else {
      // Non-eligible products - dim them
      row.classList.remove('product-stock-status-eligible');
      row.style.opacity = '0.4';
      row.style.filter = 'grayscale(30%)';
      row.style.pointerEvents = 'none';
    }
  });
  
  // ✅ MOBILE - Product cards
  const mobileCards = document.querySelectorAll('.mobile-item[data-product-id]');
  mobileCards.forEach(card => {
    const productId = card.getAttribute('data-product-id');
    const product = cachedProducts.find(p => p.id === productId);
    
    // Check if product has TEXT stock status
    if (product && typeof product.stock === 'string' && 
        ['GOOD', 'MEDIUM', 'LOW', 'URGENT'].includes(product.stock.toUpperCase())) {
      
      // ✅ Add highlight class ONLY
      card.classList.add('product-stock-status-eligible');
      eligibleCount++;
      
    } else {
      // Non-eligible products - dim them
      card.classList.remove('product-stock-status-eligible');
      card.style.opacity = '0.4';
      card.style.filter = 'grayscale(30%)';
      card.style.pointerEvents = 'none';
    }
  });
  
  console.log(`✅ Highlighted ${eligibleCount} eligible products`);
  
 
}


/**
 * Select Bulk Stock Status - WITH TRANSLATION
 */
 function selectBulkStockStatus(status) {
  console.log('📦 Selected stock status:', status);
  
  // ✅ Close stock status dropdown
  document.getElementById('stockStatusDropdownBtn').click();
  
  setTimeout(() => {
    // ✅ Set bulk edit mode
    bulkEditMode = {
      active: true,
      field: 'stockStatus',
      value: status,
      selectedProducts: []
    };
    
    // ✅ Get current language and translations
    const lang = window.currentLanguage || 'en';
    const translations = window.translations[lang];
    
    // ✅ Update UI with emoji and translated text
    const statusMap = {
      'GOOD': '🟢 ' + (translations.good || 'Good'),
      'MEDIUM': '🟡 ' + (translations.medium || 'Medium'),
      'LOW': '🔴 ' + (translations.low || 'Low'),
      'URGENT': '🔵 ' + (translations.urgent || 'Urgent')
    };
    
    const displayText = statusMap[status] || status;
    
    document.getElementById('selectedStockStatusText').textContent = displayText;
    document.getElementById('updateStockStatusBtn').style.display = 'inline-block';
    document.getElementById('selectedCountStockStatus').textContent = '0';
    
    // ✅ Enable product selection (ONLY for products with TEXT stock status)
    enableProductSelectionStockStatus();
    
  }, 100);
}

/**
 * Enable Product Selection for Stock Status (ONLY TEXT stock status products)
 */
 function enableProductSelectionStockStatus() {
  console.log('🖱️ Stock status selection mode enabled');
  
  // Desktop
  const tableRows = document.querySelectorAll('#productsTableBody tr[data-product-id]');
  tableRows.forEach(row => {
    const productId = row.getAttribute('data-product-id');
    const product = cachedProducts.find(p => p.id === productId);
    
    // ✅ ONLY enable for products with TEXT stock status (not numeric)
    if (product && typeof product.stock === 'string' && ['GOOD', 'MEDIUM', 'LOW', 'URGENT'].includes(product.stock.toUpperCase())) {
      row.classList.add('product-selectable');
      
      // ✅ OVERRIDE onclick to prevent detail modal
      row.onclick = function(event) {
        // Ignore clicks on buttons
        if (event.target.closest('.btn')) return;
        
        // Stop propagation to prevent any parent handlers
        event.stopPropagation();
        event.preventDefault();
        
        // Only toggle selection, don't open modal
        toggleProductSelectionDesktop(productId, row);
      };
    }
  });
  
  // Mobile
  const mobileCards = document.querySelectorAll('.mobile-item[data-product-id]');
  mobileCards.forEach(card => {
    const productId = card.getAttribute('data-product-id');
    const product = cachedProducts.find(p => p.id === productId);
    
    // ✅ ONLY enable for products with TEXT stock status (not numeric)
    if (product && typeof product.stock === 'string' && ['GOOD', 'MEDIUM', 'LOW', 'URGENT'].includes(product.stock.toUpperCase())) {
      card.classList.add('product-selectable');
      
      // ✅ OVERRIDE onclick to prevent detail modal
      card.onclick = function(event) {
        // Ignore clicks on buttons
        if (event.target.closest('.btn')) return;
        
        // Stop propagation to prevent any parent handlers
        event.stopPropagation();
        event.preventDefault();
        
        // Only toggle selection, don't open modal
        toggleProductSelectionMobile(productId, card);
      };
    }
  });
  
  console.log('✅ Stock status selection enabled (TEXT status products only)');
}


/**
 * Apply Bulk Stock Status Update - FIRESTORE VERSION
 */
async function applyBulkStockStatusUpdate() {
  if (bulkEditMode.selectedProducts.length === 0) {
    alert('⚠️ Please select at least one product');
    return;
  }
  
  const status = bulkEditMode.value;
  const count = bulkEditMode.selectedProducts.length;
  
  const emoji = {
    'GOOD': '🟢 Good',
    'MEDIUM': '🟡 Medium',
    'LOW': '🔴 Low',
    'URGENT': '🔵 Urgent'
  }[status] || status;
  
  if (!confirm(`Update stock status to "${emoji}" for ${count} product(s)?`)) {
    return;
  }
  
  const btn = document.getElementById('updateStockStatusBtn');
  const originalText = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Updating...';
  
  try {
    const user = window.auth?.currentUser;
    if (!user) {
      throw new Error('Not authenticated');
    }
    
    const { doc, setDoc } = window.firebaseImports;
    const userId = user.uid;
    
    console.log(`📝 Updating stock status to "${status}" for ${count} products...`);
    
    // ✅ Update each product in Firestore
    let successCount = 0;
    for (const productId of bulkEditMode.selectedProducts) {
      try {
        const product = cachedProducts.find(p => p.id === productId);
        if (!product) {
          console.warn('⚠️ Product not found:', productId);
          continue;
        }
        
        // Update product data with stock status
        const updatedProduct = {
          ...product,
          stock: status,
          stockStatus: status.toLowerCase(),
          updatedAt: new Date().toISOString()
        };
        
        // Save to Firestore
        const productRef = doc(window.db, 'tenants', userId, 'products', productId);
        await setDoc(productRef, updatedProduct);
        
        // Update local cache
        const cacheIdx = cachedProducts.findIndex(p => p.id === productId);
        if (cacheIdx !== -1) {
          cachedProducts[cacheIdx].stock = status;
          cachedProducts[cacheIdx].stockStatus = status.toLowerCase();
        }
        
        successCount++;
        console.log(`✅ Updated product ${successCount}/${count}`);
        
      } catch (error) {
        console.error('❌ Error updating product:', productId, error);
      }
    }
    
    // Update localStorage cache
    try {
      localStorage.setItem('inventory_products_cache', JSON.stringify(cachedProducts));
      console.log('💾 Cache updated');
    } catch (e) {
      console.warn('⚠️ Failed to update cache:', e);
    }
    
    console.log(`✅ Bulk update complete: ${successCount}/${count} products updated`);
    
    // ✅ Cancel bulk edit mode
    cancelBulkEdit();
    
    // Re-render products
    if (typeof renderProducts === 'function') {
      renderProducts();
    }
    
    alert(`✅ Successfully updated ${successCount} product(s)!`);
    
  } catch (error) {
    console.error('❌ Error:', error);
    alert('❌ Error updating products: ' + error.message);
  } finally {
    btn.disabled = false;
    btn.innerHTML = originalText;
  }
}



/**
 * Toast Notification Helper
 */
function showToast(title, message, type = 'info') {
  let toastContainer = document.getElementById('toastContainer');
  if (!toastContainer) {
    toastContainer = document.createElement('div');
    toastContainer.id = 'toastContainer';
    toastContainer.style.cssText = 'position: fixed; top: 20px; right: 20px; z-index: 9999;';
    document.body.appendChild(toastContainer);
  }
  
  const bgColor = type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#0d6efd';
  
  const toastHTML = `
    <div class="toast show" role="alert" style="min-width: 300px; margin-bottom: 10px;">
      <div class="toast-header" style="background: ${bgColor}; color: white;">
        <strong class="me-auto">${title}</strong>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
      </div>
      <div class="toast-body">${message}</div>
    </div>
  `;
  
  toastContainer.insertAdjacentHTML('beforeend', toastHTML);
  
  setTimeout(() => {
    const toasts = toastContainer.querySelectorAll('.toast');
    if (toasts.length > 0) toasts[0].remove();
  }, 3000);
}

/**
 * ==========================================
 * 🎯 INITIALIZE ON DOM READY
 * ==========================================
 */
document.addEventListener('DOMContentLoaded', function() {
  console.log('✅ Bulk edit module initialized');
  
  // ✅ Make functions globally accessible
  window.showCategoryBulkEdit = showCategoryBulkEdit;
  window.selectBulkCategory = selectBulkCategory;
  window.applyBulkCategoryUpdate = applyBulkCategoryUpdate;
  
  window.showUnitTypeBulkEdit = showUnitTypeBulkEdit;
  window.selectBulkUnitType = selectBulkUnitType;
  window.applyBulkUnitTypeUpdate = applyBulkUnitTypeUpdate;
  
  window.showSellingPriceBulkEdit = showSellingPriceBulkEdit;
  window.applyBulkSellingPriceUpdate = applyBulkSellingPriceUpdate;
  
  window.showSizeBulkEdit = showSizeBulkEdit;
  window.applyBulkSizeUpdate = applyBulkSizeUpdate;
  
  window.showBrandBulkEdit = showBrandBulkEdit;
  window.applyBulkBrandUpdate = applyBulkBrandUpdate;
  
  window.showStockAdjustmentEdit = showStockAdjustmentEdit;
  window.setStockOperation = setStockOperation;
  window.updateStockChanges = updateStockChanges;
  
  window.showStockStatusBulkEdit = showStockStatusBulkEdit; // ← NEW
  window.selectBulkStockStatus = selectBulkStockStatus; // ← NEW
  window.applyBulkStockStatusUpdate = applyBulkStockStatusUpdate;
  window.highlightStockStatusEligibleProducts = highlightStockStatusEligibleProducts; // ✅ NEW
  window.removeStockStatusHighlighting = removeStockStatusHighlighting; // ✅ NEW
  
  window.cancelBulkEdit = cancelBulkEdit;
  window.showBrandBulkEdit = showBrandBulkEdit;
  window.showBrandBulkEdit = showBrandBulkEdit;
  window.applyBulkBrandUpdate = applyBulkBrandUpdate;
  window.updateBulkBrandMode = updateBulkBrandMode;
  window.checkAndShowSaveBulkBrandButton = checkAndShowSaveBulkBrandButton;
  window.saveNewBrandFromBulkField = saveNewBrandFromBulkField;
  window.updateBulkBrandMode = updateBulkBrandMode;
window.checkAndShowSaveBulkBrandButton = checkAndShowSaveBulkBrandButton;
window.saveNewBrandFromBulkField = saveNewBrandFromBulkField;
window.removeStockAdjustmentHighlighting = removeStockAdjustmentHighlighting;
window.updateStockDisplayOnly = updateStockDisplayOnly;


});

/**
 * Populate category dropdown with categories from cache
 */
 async function populateCategoryDropdown() {
  const categorySelect = document.getElementById('category');
  
  if (!categorySelect) {
    console.warn('⚠️ Category dropdown not found');
    return;
  }
  
  // ✅ Load categories if cache is empty
  if ((!categoriesCache || categoriesCache.length === 0) && !categoryCacheLoaded) {
    console.log('📥 Categories not loaded, loading now...');
    
    const user = window.auth?.currentUser;
    if (user) {
      try {
        const { collection, getDocs } = window.firebaseImports;
        const categoriesRef = collection(window.db, 'tenants', user.uid, 'categories');
        const snapshot = await getDocs(categoriesRef);
        
        const categories = [];
        snapshot.forEach((doc) => {
          const data = doc.data();
          const categoryName = data.name || data.categoryName;
          if (categoryName) categories.push(categoryName);
        });
        
        categoriesCache = categories;
        categoryAutocompleteCache = categories;
        categoryCacheLoaded = true;
        
        console.log('✅ Loaded', categories.length, 'categories');
      } catch (error) {
        console.error('❌ Error loading categories:', error);
      }
    }
  }
  
  // Clear existing options except the first (placeholder)
  categorySelect.innerHTML = '<option value="">Select Category</option>';
  
  // Check if categories are loaded
  if (!categoriesCache || categoriesCache.length === 0) {
    console.log('⚠️ No categories found in cache');
    categorySelect.innerHTML = `
      <option value="">No categories available</option>
      <option value="" disabled>➜ Add categories from sidebar menu</option>
    `;
    return;
  }
  
  // Sort categories alphabetically
  const sortedCategories = [...categoriesCache].sort((a, b) => a.localeCompare(b));
  
  // Add each category as an option
  sortedCategories.forEach(category => {
    const option = document.createElement('option');
    option.value = category;
    option.textContent = category;
    categorySelect.appendChild(option);
  });
  
  console.log('✅ Populated category dropdown with', sortedCategories.length, 'categories');
}

// Make it global
window.populateCategoryDropdown = populateCategoryDropdown;

/**
 * ==========================================
 * KEYBOARD DETECTION & MODAL SCROLL
 * ==========================================
 */

 let keyboardOpen = false;
let originalViewportHeight = window.innerHeight;

/**
 * Detect keyboard open/close using Visual Viewport API
 */
function setupKeyboardDetection() {
  if (!window.visualViewport) {
    console.warn('⚠️ Visual Viewport API not supported');
    return;
  }
  
  window.visualViewport.addEventListener('resize', () => {
    const currentHeight = window.visualViewport.height;
    const heightDifference = originalViewportHeight - currentHeight;
    
    // Keyboard is open if viewport height decreased significantly
    if (heightDifference > 150) {
      if (!keyboardOpen) {
        keyboardOpen = true;
        document.body.classList.add('keyboard-open');
        console.log('⌨️ Keyboard opened');
        
        // Scroll to show preview area
        setTimeout(() => {
          scrollPreviewIntoView();
        }, 100);
      }
    } else {
      if (keyboardOpen) {
        keyboardOpen = false;
        document.body.classList.remove('keyboard-open');
        console.log('⌨️ Keyboard closed');
      }
    }
  });
  
  // Update original height when page loads
  window.addEventListener('load', () => {
    originalViewportHeight = window.visualViewport.height;
  });
}

/**
 * Initialize keyboard detection when modal opens
 */
function initKeyboardDetection() {
  if (!window.keyboardDetectionInitialized) {
    setupKeyboardDetection();
    window.keyboardDetectionInitialized = true;
  }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', () => {
  initKeyboardDetection();
});

/**
 * ==========================================
 * RESET DATA FUNCTIONALITY - PASSWORD ONLY
 * ==========================================
 */

/**
 * Open Reset Data Modal
 */
 function openResetDataModal() {
  console.log('🗑️ Opening Reset Data Modal...');
  
  // Clear any previous inputs
  clearResetDataModal();
  
  // Show modal
  const resetModal = new bootstrap.Modal(document.getElementById('resetDataModal'));
  resetModal.show();
  
  // Focus on password input
  setTimeout(() => {
    document.getElementById('resetDataPassword').focus();
  }, 500);
}


/**
 * Clear Reset Data Modal inputs
 */
function clearResetDataModal() {
  const passwordInput = document.getElementById('resetDataPassword');
  const errorDiv = document.getElementById('resetPasswordError');
  const resetButton = document.getElementById('confirmResetButton');
  
  if (passwordInput) passwordInput.value = '';
  if (resetButton) {
    resetButton.disabled = false;
    resetButton.innerHTML = '<i class="bi bi-trash3 me-2"></i>Reset All Data';
  }
  if (errorDiv) {
    errorDiv.style.display = 'none';
    errorDiv.textContent = '';
  }
}


/**
 * Confirm and Execute Data Reset
 */
async function confirmResetData() {
  console.log('🚀 Starting data reset process...');
  
  const passwordInput = document.getElementById('resetDataPassword');
  const password = passwordInput.value.trim();
  const errorDiv = document.getElementById('resetPasswordError');
  const resetButton = document.getElementById('confirmResetButton');
  
  // Validate password input
  if (!password) {
    errorDiv.textContent = '⚠️ Please enter your password';
    errorDiv.style.display = 'block';
    passwordInput.focus();
    return;
  }
  
  // Disable button and show loading
  resetButton.disabled = true;
  resetButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Verifying...';
  
  try {
    // Get current user
    const user = window.auth?.currentUser;
    
    if (!user) {
      throw new Error('No user signed in');
    }
    
    console.log('🔐 Verifying password for:', user.email);
    
    // Get Firebase auth functions
    const { EmailAuthProvider, reauthenticateWithCredential } = window.firebaseImports;
    
    // Create credential and verify password
    const credential = EmailAuthProvider.credential(user.email, password);
    await reauthenticateWithCredential(user, credential);
    
    console.log('✅ Password verified successfully');
    
    // Update button to show deletion progress
    resetButton.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Deleting data...';
    
    // Execute data deletion
    await deleteAllUserData(user.uid);
    
    console.log('✅ All data deleted successfully');
    
    // Hide reset modal
    const resetModal = bootstrap.Modal.getInstance(document.getElementById('resetDataModal'));
    resetModal.hide();
    
    // Clear modal
    clearResetDataModal();
    
    // Show success modal
    const successModal = new bootstrap.Modal(document.getElementById('resetDataSuccessModal'));
    successModal.show();
    
    // Reload page after 2 seconds
    setTimeout(() => {
      window.location.reload();
    }, 2000);
    
  } catch (error) {
    console.error('❌ Reset data error:', error);
    
    // Show error message
    let errorMessage = 'Failed to reset data';
    
    if (error.code === 'auth/wrong-password' || error.code === 'auth/invalid-credential') {
      errorMessage = '❌ Incorrect password. Please try again.';
    } else if (error.code === 'auth/too-many-requests') {
      errorMessage = '⚠️ Too many failed attempts. Please try again later.';
    } else if (error.message) {
      errorMessage = `❌ Error: ${error.message}`;
    }
    
    errorDiv.textContent = errorMessage;
    errorDiv.style.display = 'block';
    
    // Re-enable button
    resetButton.disabled = false;
    resetButton.innerHTML = '<i class="bi bi-trash3 me-2"></i>Reset All Data';
    
    // Focus back on password
    passwordInput.focus();
    passwordInput.select();
  }
}
/**
 * Delete all user data from Firestore and LocalStorage
 */
 async function deleteAllUserData(userId) {
  console.log('🗑️ Deleting all data for user:', userId);
  
  try {
    const db = window.db;
    
    // Get Firebase functions
    const { collection, query, getDocs, deleteDoc } = window.firebaseImports;
    
    // ✅ COMPREHENSIVE LIST - Try both singular and plural forms
    const collections = [
      'brands',
      'brand',
      'categories',
      'category',
      'customers',
      'customer',
      'invoices',
      'invoice',
      'productGroups',
      'productGroup',
      'groups',
      'products',
      'product',
      'purchases',
      'purchase',
      'sales',
      'sale',
      'settings',
      'setting',
      'sizes',
      'size',
      'stock',
      'unitTypes',
      'unitType',
      'units',
      'unit'
    ];
    
    let totalDeleted = 0;
    let collectionsDeleted = [];
    
    // Delete data from each collection
    for (const collectionName of collections) {
      try {
        console.log(`📂 Checking ${collectionName}...`);
        
        const querySnapshot = await getDocs(
          query(
            collection(db, `tenants/${userId}/${collectionName}`)
          )
        );
        
        if (querySnapshot.size > 0) {
          // Delete each document
          const deletePromises = querySnapshot.docs.map(doc => 
            deleteDoc(doc.ref)
          );
          
          await Promise.all(deletePromises);
          
          totalDeleted += querySnapshot.size;
          collectionsDeleted.push(collectionName);
          console.log(`✅ Deleted ${querySnapshot.size} documents from ${collectionName}`);
        }
        
      } catch (error) {
        // Collection might not exist - continue
        console.log(`⚠️ Skipped ${collectionName}:`, error.message);
      }
    }
    
    // ✅ Clear ALL localStorage except auth
    console.log('🧹 Clearing localStorage...');
    
    const keysToKeep = ['firebase:authUser', 'firebase:host'];
    const allKeys = Object.keys(localStorage);
    
    let localStorageCleared = 0;
    
    allKeys.forEach(key => {
      if (!keysToKeep.some(keepKey => key.includes(keepKey))) {
        localStorage.removeItem(key);
        localStorageCleared++;
      }
    });
    
    console.log(`✅ Cleared ${localStorageCleared} localStorage items`);
    
    // ✅ Clear sessionStorage
    try {
      const sessionKeys = Object.keys(sessionStorage);
      sessionKeys.forEach(key => {
        if (!keysToKeep.some(keepKey => key.includes(keepKey))) {
          sessionStorage.removeItem(key);
        }
      });
      console.log(`✅ Cleared sessionStorage`);
    } catch (e) {
      console.log('ℹ️ No sessionStorage to clear');
    }
    
    // ✅ Final Summary
    console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
    console.log(`✅ DATA RESET COMPLETE!`);
    console.log(`   📊 Total documents deleted: ${totalDeleted}`);
    console.log(`   🗂️ Collections deleted: ${collectionsDeleted.length}`);
    console.log(`   📁 Collections: ${collectionsDeleted.join(', ')}`);
    console.log(`   🧹 LocalStorage cleared: ${localStorageCleared} items`);
    console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
    
  } catch (error) {
    console.error('❌ Error deleting data:', error);
    throw error;
  }
}


// ✅ TEST RESET DATA ON PAGE LOAD
document.addEventListener('DOMContentLoaded', function() {
  console.log('🧪 Testing Reset Data Setup...');
  console.log('- openResetDataModal:', typeof openResetDataModal);
  console.log('- Modal element:', document.getElementById('resetDataModal') ? '✅ Found' : '❌ Missing');
  console.log('- Password input:', document.getElementById('resetDataPassword') ? '✅ Found' : '❌ Missing');
  console.log('- Confirm button:', document.getElementById('confirmResetButton') ? '✅ Found' : '❌ Missing');
});


/**
 * ==========================================
 * i18n TRANSLATION SYSTEM - COMPLETE WITH BULK EDIT
 * ==========================================
 */

// ✅ STEP 1: Define translations FIRST (before anything else)
window.translations = {
  en: {
    // Navbar
    appTitle: "Tile & Sanitaryware Inventory",
    generateInvoice: "Generate Invoice",
    viewInvoices: "View Invoices",
    signOut: "Sign Out",
    backupData: "Backup Data",
    restoreData: "Restore Data",
    changePassword: "Change Password",
    resetData: "Reset Data",
    signedIn: "Signed In",
    
    // Dashboard Summary
    totalProducts: "Total Products",
    qtyInHand: "Qty in Hand",
    inStockItems: "In Stock Items",
    lowStockItems: "Low Stock Items",
    inventory: "Inventory",
    recentPurchases: "Recent Purchases",
    recentSales: "Recent Sales",
    quickCreate: "Quick Create",
    clickToFlip: "Click to flip",
    
    // Quick Actions
    instantProducts: "Instant Products",
    addProduct: "Add Product",
    recordPurchase: "Record Purchase",
    recordSale: "Record Sale",
    
    // Product Management
    editProduct: "Edit Product",
    productName: "Product Name",
    brand: "Brand",
    size: "Size",
    category: "Category",
    unitType: "Unit Type",
    quantity: "Quantity",
    price: "Price",
    
    // Bulk Edit (NEW)
    editProductsInBulk: "Edit Products in Bulk",
    updateCategory: "Update Category",
    updateUnitType: "Update Unit Type",
    updateStock: "Update Stock",
    updateSellingPrice: "Update Selling Price",
    updateStockStatus: "Update Stock Status",
    updateBrand: "Update Brand",
    updateSize: "Update Size",
    enterSellingPriceToUpdate: "Enter Selling Price to Update",
    enterBrandToUpdate: "Enter Brand to Update",
    selectStockStatus: "Select Stock Status",
    good: "Good",
    medium: "Medium",
    low: "Low",
    urgent: "Urgent",
    selectCategory: "Select Category",
    selectUnitType: "Select Unit Type",
    clickToSelect: "Click on products to select them",
    selected: "selected",
    addBy: "Add by",
    reduceBy: "Reduce by",
    update: "Update",
    sort: "Sort",
    sortProducts: "Sort Products",
    searchPlaceholder: "🔍 Search...",
    
    // Common
    save: "Save",
    cancel: "Cancel",
    delete: "Delete",
    edit: "Edit",
    close: "Close",
    search: "Search",
    loading: "Loading...",
    success: "Success!",
    
    // Reset Data Modal
    resetAllData: "Reset All Data",
    resetWarning: "WARNING: This action cannot be undone!",
    resetMessage: "All your inventory data will be permanently deleted:",
    productsAndStock: "Products & Stock",
    groupsAndBrands: "Groups & Brands",
    customersAndSales: "Customers & Sales",
    invoicesAndRecords: "Invoices & Records",
    enterPasswordToConfirm: "Enter your password to confirm:",
    yourCurrentPassword: "Your current password",
    allDataCleared: "All your data has been cleared. You can start fresh now.",
    gotIt: "Got it",
  },
  
  hi: {
    // Navbar
    appTitle: "टाइल और सेनेटरीवेयर इन्वेंटरी",
    generateInvoice: "बिल बनाएं",
    viewInvoices: "बिल देखें",
    signOut: "साइन आउट",
    backupData: "डेटा बैकअप",
    restoreData: "डेटा पुनर्स्थापित करें",
    changePassword: "पासवर्ड बदलें",
    resetData: "डेटा रीसेट करें",
    signedIn: "साइन इन किया गया",
    
    // Dashboard Summary
    totalProducts: "कुल उत्पाद",
    qtyInHand: "उपलब्ध मात्रा",
    inStockItems: "स्टॉक में वस्तुएं",
    lowStockItems: "कम स्टॉक वाली वस्तुएं",
    inventory: "इन्वेंटरी",
    recentPurchases: "हालिया खरीद",
    recentSales: "हाल की बिक्री",
    quickCreate: "त्वरित बनाएं",
    clickToFlip: "पलटने के लिए क्लिक करें",
    
    // Quick Actions
    instantProducts: "त्वरित उत्पाद",
    addProduct: "उत्पाद जोड़ें",
    recordPurchase: "खरीद रिकॉर्ड करें",
    recordSale: "बिक्री रिकॉर्ड करें",
    
    // Product Management
    editProduct: "उत्पाद संपादित करें",
    productName: "उत्पाद का नाम",
    brand: "ब्रांड",
    size: "साइज़",
    category: "श्रेणी",
    unitType: "इकाई प्रकार",
    quantity: "मात्रा",
    price: "कीमत",
    
    // Bulk Edit (NEW)
    editProductsInBulk: "थोक में उत्पाद संपादित करें",
    updateCategory: "श्रेणी अपडेट करें",
    updateUnitType: "इकाई प्रकार अपडेट करें",
    updateStock: "स्टॉक अपडेट करें",
    updateSellingPrice: "बिक्री मूल्य अपडेट करें",
    updateStockStatus: "स्टॉक स्थिति अपडेट करें",
    updateBrand: "ब्रांड अपडेट करें",
    updateSize: "साइज़ अपडेट करें",
    enterSellingPriceToUpdate: "अपडेट करने के लिए बिक्री मूल्य दर्ज करें",
    enterBrandToUpdate: "अपडेट करने के लिए ब्रांड दर्ज करें",
    selectStockStatus: "स्टॉक स्थिति चुनें",
    good: "अच्छा",
    medium: "मध्यम",
    low: "कम",
    urgent: "तत्काल",
    selectCategory: "श्रेणी चुनें",
    selectUnitType: "इकाई प्रकार चुनें",
    clickToSelect: "चयन करने के लिए उत्पादों पर क्लिक करें",
    selected: "चयनित",
    addBy: "जोड़ें",
    reduceBy: "घटाएं",
    update: "अपडेट करें",
    sort: "क्रमबद्ध करें",
    sortProducts: "उत्पाद क्रमबद्ध करें",
    searchPlaceholder: "🔍 खोजें...",
    
    // Common
    save: "सहेजें",
    cancel: "रद्द करें",
    delete: "हटाएं",
    edit: "संपादित करें",
    close: "बंद करें",
    search: "खोजें",
    loading: "लोड हो रहा है...",
    success: "सफल!",
    
    // Reset Data Modal
    resetAllData: "सभी डेटा रीसेट करें",
    resetWarning: "चेतावनी: यह कार्रवाई पूर्ववत नहीं की जा सकती!",
    resetMessage: "आपका सभी इन्वेंटरी डेटा स्थायी रूप से हटा दिया जाएगा:",
    productsAndStock: "उत्पाद और स्टॉक",
    groupsAndBrands: "समूह और ब्रांड",
    customersAndSales: "ग्राहक और बिक्री",
    invoicesAndRecords: "बिल और रिकॉर्ड",
    enterPasswordToConfirm: "पुष्टि करने के लिए अपना पासवर्ड दर्ज करें:",
    yourCurrentPassword: "आपका वर्तमान पासवर्ड",
    allDataCleared: "आपका सभी डेटा साफ़ कर दिया गया है। अब आप नए सिरे से शुरू कर सकते हैं।",
    gotIt: "समझ गया",
  }
};

// ✅ STEP 2: Initialize current language
window.currentLanguage = localStorage.getItem('appLanguage') || 'en';

console.log('✅ Translations loaded');


// ✅ STEP 3: Define functions AFTER translations object
/**
 * Get translated text
 */
function t(key) {
  const lang = window.currentLanguage || 'en';
  const translation = window.translations[lang]?.[key];
  
  if (!translation) {
    console.warn(`⚠️ Translation missing: ${key}`);
    return window.translations.en[key] || key;
  }
  
  return translation;
}



/**
 * Update language label
 */
function updateLanguageLabel(lang) {
  const label = document.getElementById('currentLanguageLabel');
  if (label) {
    label.textContent = lang === 'hi' ? 'हिं' : 'EN';
  }
}

/**
 * Update checkmarks
 */
function updateLanguageCheckmarks(lang) {
  const enCheck = document.getElementById('langEnCheck');
  const hiCheck = document.getElementById('langHiCheck');
  
  if (enCheck && hiCheck) {
    if (lang === 'en') {
      enCheck.className = 'bi bi-check-circle-fill me-2';
      enCheck.style.color = '#198754';
      hiCheck.className = 'bi bi-circle me-2';
      hiCheck.style.color = '#ccc';
    } else {
      enCheck.className = 'bi bi-circle me-2';
      enCheck.style.color = '#ccc';
      hiCheck.className = 'bi bi-check-circle-fill me-2';
      hiCheck.style.color = '#198754';
    }
  }
}

/**
 * Show language change toast
 */
function showLanguageToast(lang) {
  const message = lang === 'hi' 
    ? '✅ भाषा हिंदी में बदली गई' 
    : '✅ Language changed to English';
  
  // Create toast container if needed
  let container = document.getElementById('languageToastContainer');
  if (!container) {
    container = document.createElement('div');
    container.id = 'languageToastContainer';
    container.style.cssText = 'position: fixed; top: 80px; right: 20px; z-index: 99999;';
    document.body.appendChild(container);
  }
  
  // Create toast
  const toast = document.createElement('div');
  toast.className = 'alert alert-success alert-dismissible fade show';
  toast.style.cssText = 'min-width: 250px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); border-radius: 10px; animation: slideIn 0.3s ease;';
  toast.innerHTML = `
    <i class="bi bi-translate me-2"></i>${message}
    <button type="button" class="btn-close" onclick="this.parentElement.remove()"></button>
  `;
  
  container.appendChild(toast);
  
  // Auto remove
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

/**
 * Re-translate dynamic bulk edit buttons - COMPLETE VERSION
 */
 function retranslateBulkEditButtons() {
  const lang = window.currentLanguage || 'en';
  const translations = window.translations[lang];
  
  // Update stock operation button if visible
  const stockOperationBtn = document.getElementById('stockOperationBtn');
  if (stockOperationBtn && bulkEditMode.operation) {
    if (bulkEditMode.operation === 'add') {
      stockOperationBtn.innerHTML = '<i class="bi bi-plus-circle"></i> ' + (translations.addBy || 'Add by');
    } else {
      stockOperationBtn.innerHTML = '<i class="bi bi-dash-circle"></i> ' + (translations.reduceBy || 'Reduce by');
    }
  }
  
  // ✅ Update stock status text if a status is selected
  if (bulkEditMode.stockStatus) {
    const statusMap = {
      'GOOD': '🟢 ' + (translations.good || 'Good'),
      'MEDIUM': '🟡 ' + (translations.medium || 'Medium'),
      'LOW': '🔴 ' + (translations.low || 'Low'),
      'URGENT': '🔵 ' + (translations.urgent || 'Urgent')
    };
    
    const displayText = statusMap[bulkEditMode.stockStatus];
    const statusText = document.getElementById('selectedStockStatusText');
    if (statusText && displayText) {
      statusText.textContent = displayText;
    }
  }
  
  // ✅ Update category dropdown text if visible
  const categoryDropdown = document.getElementById('categorySelectionDropdown');
  if (categoryDropdown && categoryDropdown.style.display !== 'none') {
    const categoryText = document.getElementById('selectedCategoryText');
    if (categoryText && categoryText.textContent === 'Select Category' || categoryText.textContent === 'श्रेणी चुनें') {
      categoryText.textContent = translations.selectCategory || 'Select Category';
    }
  }
  
  // ✅ Update unit type dropdown text if visible
  const unitTypeDropdown = document.getElementById('unitTypeSelectionDropdown');
  if (unitTypeDropdown && unitTypeDropdown.style.display !== 'none') {
    const unitTypeText = document.getElementById('selectedUnitTypeText');
    if (unitTypeText && (unitTypeText.textContent === 'Select Unit Type' || unitTypeText.textContent === 'इकाई प्रकार चुनें')) {
      unitTypeText.textContent = translations.selectUnitType || 'Select Unit Type';
    }
  }
  
  // ✅ Update stock status dropdown text if not selected yet
  const stockStatusText = document.getElementById('selectedStockStatusText');
  if (stockStatusText && !bulkEditMode.stockStatus) {
    if (stockStatusText.textContent === 'Select Stock Status' || stockStatusText.textContent === 'स्टॉक स्थिति चुनें') {
      stockStatusText.textContent = translations.selectStockStatus || 'Select Stock Status';
    }
  }
  
  console.log('✅ Bulk edit buttons retranslated');
}




/**
 * Change language - WITH BULK EDIT SUPPORT
 */
 function changeLanguage(lang) {
  console.log(`🌐 Changing language to: ${lang}`);
  
  if (!window.translations || !window.translations[lang]) {
    console.error('❌ Translations not available');
    return;
  }
  
  localStorage.setItem('appLanguage', lang);
  window.currentLanguage = lang;
  
  translatePage();
  updateLanguageLabel(lang);
  updateLanguageCheckmarks(lang);
  
  // ✅ NEW - Retranslate dynamic bulk edit buttons
  if (typeof retranslateBulkEditButtons === 'function') {
    retranslateBulkEditButtons();
  }
  
  showLanguageToast(lang);
}

// ✅ STEP 4: Auto-translate on page load (LAST)
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initializeTranslation);
} else {
  // DOM already loaded
  initializeTranslation();
}

function initializeTranslation() {
  const savedLang = localStorage.getItem('appLanguage') || 'en';
  window.currentLanguage = savedLang;
  
  translatePage();
  updateLanguageLabel(savedLang);
  updateLanguageCheckmarks(savedLang);
  
  // ✅ NEW - Retranslate dynamic bulk edit buttons on load
  setTimeout(() => {
    if (typeof retranslateBulkEditButtons === 'function') {
      retranslateBulkEditButtons();
    }
  }, 500);
  
  console.log(`✅ i18n initialized: ${savedLang}`);
}
/**
 * ==========================================
 * TRANSLATION EXCLUSION SYSTEM (FIXED & COMPLETE)
 * ==========================================
 */

// 1. GLOBAL STATE
window.translationExclusions = window.translationExclusions || new Set();
window.isTranslationExclusionMode = window.isTranslationExclusionMode || false;

/**
 * 2. DROPDOWN & UI HELPERS
 * ------------------------------------------
 */

// ✅ Close language dropdown using the PROVEN method (Simulate Body Click)
function closeLanguageDropdown() {
  // Use a short timeout to let the current click event finish bubbling
  setTimeout(() => {
    document.body.click();
  }, 10);
}

// ✅ Change language and close
function changeLanguageAndClose(lang) {
  // 1. Logic first
  if (typeof changeLanguage === 'function') {
    changeLanguage(lang);
  }
  // 2. Then Close
  closeLanguageDropdown();
}

// ✅ Toggle mode and close dropdown
function toggleTranslationExclusionModeAndClose() {
  // 1. Logic
  setTimeout(() => {
    toggleTranslationExclusionMode();
  }, 50);
  
  // 2. Close
  closeLanguageDropdown();
}

/**
 * 3. CHECKBOX LOGIC (SYNC DUPLICATES)
 * ------------------------------------------
 */

// ✅ Handle click on ANY exclusion checkbox (Desktop or Mobile)
function handleTranslationCheckboxClick(event) {
  event.stopPropagation(); // Stop modal from opening

  const checkbox = event.target;
  const key = checkbox.getAttribute('data-i18n-key');

  if (!key) return;

  // Sync state to ALL other checkboxes with the same key
  const newState = checkbox.checked;
  document.querySelectorAll(`.translation-exclusion-checkbox[data-i18n-key="${key}"]`).forEach(cb => {
    cb.checked = newState;
  });
}

// ✅ Block action buttons when in exclusion mode
function runIfNotExclusionMode(event, actionFn) {
  if (window.isTranslationExclusionMode) {
    event.stopPropagation();
    event.preventDefault();
    return false;
  }
  if (typeof actionFn === 'function') {
    actionFn();
  }
  return false;
}

/**
 * 4. LOAD & SAVE (FIRESTORE)
 * ------------------------------------------
 */

// ✅ Load exclusions
async function loadTranslationExclusions() {
  try {
    if (!window.translationExclusions) window.translationExclusions = new Set();

    const user = window.auth?.currentUser;

    if (!user) {
      const stored = localStorage.getItem('translationExclusions');
      window.translationExclusions = new Set(stored ? JSON.parse(stored) : []);
      return;
    }

    const { doc, getDoc } = window.firebaseImports;
    const settingsRef = doc(window.db, 'tenants', user.uid, 'settings', 'translationPreferences');
    const snap = await getDoc(settingsRef);

    if (snap.exists()) {
      window.translationExclusions = new Set(snap.data().excludedKeys || []);
    } else {
      window.translationExclusions = new Set();
    }
    
    // Cache locally
    localStorage.setItem('translationExclusions', JSON.stringify([...window.translationExclusions]));
    
  } catch (e) {
    console.warn('⚠️ Failed to load exclusions, using cache', e);
    const stored = localStorage.getItem('translationExclusions');
    window.translationExclusions = new Set(stored ? JSON.parse(stored) : []);
  }
}

// ✅ Save exclusions
async function saveTranslationExclusionsToFirestore() {
  try {
    const user = window.auth?.currentUser;
    const exclusionsArray = [...window.translationExclusions];

    if (!user) {
      localStorage.setItem('translationExclusions', JSON.stringify(exclusionsArray));
      return true;
    }

    const { doc, setDoc } = window.firebaseImports;
    const settingsRef = doc(window.db, 'tenants', user.uid, 'settings', 'translationPreferences');

    await setDoc(settingsRef, {
      excludedKeys: exclusionsArray,
      updatedAt: new Date().toISOString()
    });

    localStorage.setItem('translationExclusions', JSON.stringify(exclusionsArray));
    return true;

  } catch (error) {
    console.error('❌ Failed to save translation exclusions:', error);
    return false;
  }
}
/**
 * 5. TOGGLE UI MODE (Fixed for Global Visibility)
 * ------------------------------------------
 */
 function toggleTranslationExclusionMode() {
  window.isTranslationExclusionMode = !window.isTranslationExclusionMode;

  const navbar = document.getElementById('mainNavbar');
  const controlButtons = document.getElementById('translationControlButtons');
  
  // ✅ UPDATE: Toggle class on BODY so it affects the whole page
  const body = document.body;

  if (!controlButtons) return;

  if (window.isTranslationExclusionMode) {
    // ENTER MODE
    body.classList.add('translation-exclusion-mode'); // Applied globally
    if (navbar) navbar.classList.add('translation-exclusion-mode'); // Keep for specific navbar styling if any
    
    controlButtons.style.display = 'flex';

    // Sync UI checkboxes with current Set
    document.querySelectorAll('.translation-exclusion-checkbox').forEach(cb => {
      const key = cb.getAttribute('data-i18n-key');
      cb.checked = key ? window.translationExclusions.has(key) : false;
    });

  } else {
    // EXIT MODE
    body.classList.remove('translation-exclusion-mode');
    if (navbar) navbar.classList.remove('translation-exclusion-mode');
    
    controlButtons.style.display = 'none';
  }
}


/**
 * 6. SAVE BUTTON ACTION
 * ------------------------------------------
 */
async function saveTranslationExclusions() {
  // 1. Build Set from currently checked boxes
  const newSet = new Set();
  document.querySelectorAll('.translation-exclusion-checkbox:checked').forEach(cb => {
    const key = cb.getAttribute('data-i18n-key');
    if (key) newSet.add(key);
  });

  window.translationExclusions = newSet;

  // 2. Save to Firestore
  const success = await saveTranslationExclusionsToFirestore();

  if (success) {
    // 3. Reload to confirm
    await loadTranslationExclusions();

    // 4. Exit mode
    if (window.isTranslationExclusionMode) {
      toggleTranslationExclusionMode();
    }

    // 5. Re-translate page (Vital Step!)
    if (typeof translatePage === 'function') {
      translatePage();
    }

    const lang = window.currentLanguage || 'en';
    if(typeof showLanguageToast === 'function') {
        showLanguageToast(lang === 'hi' ? '✅ अनुवाद प्राथमिकताएं सहेजी गईं' : '✅ Translation preferences saved');
    }
  } else {
    alert('Failed to save preferences. Please try again.');
  }
}

// ✅ Cancel Action
function cancelTranslationExclusions() {
  if (window.isTranslationExclusionMode) {
    toggleTranslationExclusionMode();
  }
}
/**
 * ==========================================
 * TRANSLATE PAGE (With Custom Text Names Priority)
 * ==========================================
 * Priority: Custom Names > Translation Exclusions > Normal Translations
 */
 function translatePage() {
  const lang = window.currentLanguage || 'en';
  const translationsData = window.translations;

  if (!translationsData || !translationsData[lang]) {
    // console.warn('Translations not loaded yet');
    return;
  }
  
  // Ensure data structures exist
  if (!window.translationExclusions) window.translationExclusions = new Set();
  if (!window.customTextNames) window.customTextNames = {};

  // Process all [data-i18n] elements
  document.querySelectorAll('[data-i18n]').forEach(element => {
    const key = element.getAttribute('data-i18n');
    if (!key) return;

    // ===== PRIORITY 1: CUSTOM TEXT NAMES (HIGHEST) =====
    const renameKey = element.getAttribute('data-custom-rename-key');
    if (renameKey && window.customTextNames[renameKey]) {
      if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
        element.placeholder = window.customTextNames[renameKey];
      } else {
        element.textContent = window.customTextNames[renameKey];
      }
      return; // STOP - Custom name applied
    }

    // ===== PRIORITY 2: TRANSLATION EXCLUSION =====
    if (window.translationExclusions.has(key)) {
      const engText = translationsData['en']?.[key] || key;
      if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
        element.placeholder = engText;
      } else {
        element.textContent = engText;
      }
      return; // STOP - English applied
    }

    // ===== PRIORITY 3: NORMAL TRANSLATION =====
    const translation = translationsData[lang][key];
    if (translation) {
      if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
        element.placeholder = translation;
      } else {
        element.textContent = translation;
      }
    }
  });
  
  // Process all [data-i18n-placeholder] elements
  document.querySelectorAll('[data-i18n-placeholder]').forEach(element => {
    const key = element.getAttribute('data-i18n-placeholder');
    if (!key) return;
    
    // Check custom name first
    const renameKey = element.getAttribute('data-custom-rename-key');
    if (renameKey && window.customTextNames[renameKey]) {
      element.placeholder = window.customTextNames[renameKey];
      return;
    }
    
    // Then exclusion
    if (window.translationExclusions.has(key)) {
      element.placeholder = translationsData['en']?.[key] || key;
      return;
    }

    // Then normal translation
    const translation = translationsData[lang][key];
    if (translation) {
      element.placeholder = translation;
    }
  });
}


/**
 * 8. INITIALIZE
 * ------------------------------------------
 */
async function initializeTranslation() {
  const savedLang = localStorage.getItem('appLanguage') || 'en';
  window.currentLanguage = savedLang;

  await loadTranslationExclusions();

  translatePage(); // Initial translate
  
  if (typeof updateLanguageLabel === 'function') {
    updateLanguageLabel(savedLang);
    updateLanguageCheckmarks(savedLang);
  }

  console.log(`✅ i18n initialized: ${savedLang}`);
}

/**
 * ==========================================
 * CUSTOM TEXT RENAME SYSTEM (Modal-Based)
 * ==========================================
 */

// Global State
window.customTextNames = window.customTextNames || {}; // Stores { key: "Custom Name" }
window.isCustomTextNameMode = false;
window.currentRenamingKey = null;
window.currentRenamingElement = null;

// ========================================
// 1. LOAD CUSTOM TEXT NAMES FROM FIRESTORE
// ========================================
async function loadCustomTextNamesFromFirestore() {
    try {
        console.log("📥 Loading custom text names...");
        
        // 1. Try LocalStorage first
        const stored = localStorage.getItem('customTextNames');
        if (stored) {
            window.customTextNames = JSON.parse(stored);
        } else {
            window.customTextNames = {};
        }

        // 2. Fetch from Firestore
        const user = window.auth?.currentUser;
        if (!user) {
            console.log("ℹ️ No user logged in, using LocalStorage only.");
            return;
        }

        const { doc, getDoc } = window.firebaseImports;
        const settingsRef = doc(window.db, 'tenants', user.uid, 'settings', 'customTextNames');
        const snap = await getDoc(settingsRef);

        if (snap.exists()) {
            const remoteData = snap.data().names || {};
            window.customTextNames = remoteData;
            localStorage.setItem('customTextNames', JSON.stringify(window.customTextNames));
            console.log(`✅ Loaded ${Object.keys(window.customTextNames).length} custom text names`);
        } else {
            console.log("ℹ️ No custom text names found in Firestore.");
        }
        
    } catch (e) {
        console.warn('⚠️ Failed to load custom text names:', e);
    }
}

// ========================================
// 2. APPLY CUSTOM TEXT NAMES TO UI
// ========================================
function applyCustomTextNamesToUI() {
    document.querySelectorAll('[data-custom-rename-key]').forEach(element => {
        const key = element.getAttribute('data-custom-rename-key');
        
        if (window.customTextNames[key]) {
            element.textContent = window.customTextNames[key];
        }
    });
}
// ========================================
// 3. TOGGLE CUSTOM TEXT NAME MODE
// ========================================
function toggleCustomTextNameModeAndClose() {
    // Close dropdown first
    setTimeout(() => { document.body.click(); }, 10);
    
    // Close translation exclusion mode if active
    if (window.isTranslationExclusionMode) {
        toggleTranslationExclusionModeAndClose();
    }

    window.isCustomTextNameMode = !window.isCustomTextNameMode;
    
    const indicator = document.getElementById('customTextModeIndicator');
    
    if (window.isCustomTextNameMode) {
        // ✅ ENABLE MODE - Show indicator
        console.log("✏️ Custom Text Name Mode ENABLING...");
        
        // Add body class for CSS
        document.body.classList.add('custom-text-rename-mode');
        
        // Force show indicator
        indicator.style.display = 'flex';
        indicator.style.visibility = 'visible';
        indicator.style.opacity = '1';
        indicator.style.pointerEvents = 'auto';
        indicator.classList.remove('d-none');
        
        // Add click listeners to all renameable elements
        document.querySelectorAll('[data-custom-rename-key]').forEach(element => {
            element.style.cursor = 'pointer';
            element.style.textDecoration = 'underline';
            element.style.textDecorationStyle = 'dotted';
            element.style.textDecorationColor = '#fd7e14';
            
            element.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                openRenameModal(element);
            };
        });
        
        console.log("✅ Custom Text Name Mode ENABLED - Indicator visible");
    } else {
        exitCustomTextNameMode();
    }
}

// ========================================
// 4. EXIT CUSTOM TEXT NAME MODE
// ========================================
function exitCustomTextNameMode() {
    console.log("❌ Exiting Custom Text Name Mode...");
    
    window.isCustomTextNameMode = false;
    
    // Remove body class
    document.body.classList.remove('custom-text-rename-mode');
    
    // Force hide indicator
    const indicator = document.getElementById('customTextModeIndicator');
    if (indicator) {
        indicator.style.display = 'none';
        indicator.style.visibility = 'hidden';
        indicator.style.opacity = '0';
        indicator.style.pointerEvents = 'none';
        indicator.classList.add('d-none');
    }
    
    // Remove click listeners and styles from all elements
    document.querySelectorAll('[data-custom-rename-key]').forEach(element => {
        element.style.cursor = '';
        element.style.textDecoration = '';
        element.style.textDecorationStyle = '';
        element.style.textDecorationColor = '';
        element.onclick = null;
    });
    
    console.log("✅ Custom Text Name Mode EXITED - Indicator hidden");
}

// ========================================
// 5. OPEN RENAME MODAL
// ========================================
function openRenameModal(element) {
    const key = element.getAttribute('data-custom-rename-key');
    const currentText = element.textContent.trim();
    
    window.currentRenamingKey = key;
    window.currentRenamingElement = element;
    
    // Populate modal
    document.getElementById('customTextInput').value = currentText;
    document.getElementById('currentTextPreview').textContent = currentText;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('customTextRenameModal'));
    modal.show();
    
    // Focus input
    setTimeout(() => {
        document.getElementById('customTextInput').focus();
        document.getElementById('customTextInput').select();
    }, 300);
}

// ========================================
// 6. SAVE CUSTOM TEXT RENAME
// ========================================
async function saveCustomTextRename() {
    const newText = document.getElementById('customTextInput').value.trim();
    
    if (!newText) {
        alert("Please enter a valid name!");
        return;
    }
    
    if (!window.currentRenamingKey) {
        alert("Error: No key selected!");
        return;
    }
    
    // Update global state
    window.customTextNames[window.currentRenamingKey] = newText;
    
    try {
        // Save to LocalStorage
        localStorage.setItem('customTextNames', JSON.stringify(window.customTextNames));
        
        // Save to Firestore
        const user = window.auth?.currentUser;
        if (user) {
            const { doc, setDoc } = window.firebaseImports;
            const settingsRef = doc(window.db, 'tenants', user.uid, 'settings', 'customTextNames');
            
            await setDoc(settingsRef, {
                names: window.customTextNames,
                updatedAt: new Date().toISOString()
            }, { merge: true });
            
            console.log("✅ Custom text name saved to Firestore");
        }
        
        // Update UI
        applyCustomTextNamesToUI();
        
        // Close modal
        bootstrap.Modal.getInstance(document.getElementById('customTextRenameModal')).hide();
        
        // Show success
        if (typeof showSyncIndicator === 'function') {
            showSyncIndicator("Text renamed!", 1500);
        }
        
    } catch (error) {
        console.error('❌ Failed to save custom text name:', error);
        alert('Failed to save. Check console.');
    }
}

// ========================================
// 7. RESET SINGLE CUSTOM TEXT
// ========================================
async function resetSingleCustomText() {
    if (!window.currentRenamingKey) return;
    
    if (!confirm("Reset this text to default?")) return;
    
    // Remove from global state
    delete window.customTextNames[window.currentRenamingKey];
    
    try {
        // Save to LocalStorage
        localStorage.setItem('customTextNames', JSON.stringify(window.customTextNames));
        
        // Save to Firestore
        const user = window.auth?.currentUser;
        if (user) {
            const { doc, setDoc } = window.firebaseImports;
            const settingsRef = doc(window.db, 'tenants', user.uid, 'settings', 'customTextNames');
            
            await setDoc(settingsRef, {
                names: window.customTextNames,
                updatedAt: new Date().toISOString()
            });
        }
        
        // Close modal
        bootstrap.Modal.getInstance(document.getElementById('customTextRenameModal')).hide();
        
        // Reload page to show default
        location.reload();
        
    } catch (error) {
        console.error('❌ Failed to reset text:', error);
    }
}

// ========================================
// 8. UPDATED: runIfNotExclusionMode
// ========================================
// Block actions if in EITHER exclusion mode OR custom text mode
function runIfNotExclusionMode(event, actionFn) {
    if (window.isTranslationExclusionMode) {
        event.stopPropagation();
        event.preventDefault();
        return false;
    }
    
    // NEW: Also block if in custom text name mode
    if (window.isCustomTextNameMode) {
        event.stopPropagation();
        event.preventDefault();
        return false;
    }
    
    if (typeof actionFn === 'function') {
        actionFn();
    }
    return false;
}
/**
 * ==========================================
 * HIDE CUSTOM TEXT MODE INDICATOR ON LOAD
 * ==========================================
 */
 (function hideCustomTextIndicatorOnLoad() {
    const indicator = document.getElementById('customTextModeIndicator');
    if (indicator) {
        // Only hide if body doesn't have the active class
        if (!document.body.classList.contains('custom-text-rename-mode')) {
            indicator.style.display = 'none';
            indicator.style.visibility = 'hidden';
            indicator.style.opacity = '0';
            indicator.style.pointerEvents = 'none';
            console.log('🔒 Custom text indicator hidden on load');
        }
    }
})();

// Also add to DOMContentLoaded
document.addEventListener('DOMContentLoaded', function() {
    const indicator = document.getElementById('customTextModeIndicator');
    if (indicator && !document.body.classList.contains('custom-text-rename-mode')) {
        indicator.style.display = 'none';
        indicator.style.visibility = 'hidden';
        indicator.style.opacity = '0';
        indicator.style.pointerEvents = 'none';
    }
});

/**
 * ==========================================
 * AUTO-ADJUST DROPDOWN POSITION ON MOBILE
 * ==========================================
 */
 document.addEventListener('DOMContentLoaded', function() {
    const languageDropdown = document.getElementById('languageDropdown');
    const dropdownMenu = languageDropdown?.nextElementSibling;
    
    if (languageDropdown && dropdownMenu) {
        languageDropdown.addEventListener('show.bs.dropdown', function() {
            const button = this;
            const menu = dropdownMenu;
            const buttonRect = button.getBoundingClientRect();
            const menuWidth = 200; // min-width of dropdown
            
            // Check if dropdown would overflow on the left
            const wouldOverflowLeft = buttonRect.left < menuWidth;
            
            // Check if dropdown would overflow on the right
            const wouldOverflowRight = (buttonRect.right + menuWidth) > window.innerWidth;
            
            console.log('Dropdown position check:', {
                buttonLeft: buttonRect.left,
                buttonRight: buttonRect.right,
                menuWidth: menuWidth,
                windowWidth: window.innerWidth,
                wouldOverflowLeft: wouldOverflowLeft,
                wouldOverflowRight: wouldOverflowRight
            });
            
            // Adjust classes based on overflow
            if (wouldOverflowLeft && !wouldOverflowRight) {
                // Align to right of button
                menu.classList.remove('dropdown-menu-start');
                menu.classList.add('dropdown-menu-end');
                console.log('✅ Adjusted dropdown to RIGHT alignment');
            } else if (wouldOverflowRight && !wouldOverflowLeft) {
                // Align to left of button
                menu.classList.remove('dropdown-menu-end');
                menu.classList.add('dropdown-menu-start');
                console.log('✅ Adjusted dropdown to LEFT alignment');
            } else {
                // Default to end (right) on small screens
                if (window.innerWidth < 768) {
                    menu.classList.remove('dropdown-menu-start');
                    menu.classList.add('dropdown-menu-end');
                    console.log('✅ Mobile view - using RIGHT alignment');
                }
            }
        });
    }
});

/**
 * ==========================================
 * VENDOR MANAGEMENT SYSTEM - FIREBASE VERSION
 * ==========================================
 */

// Global vendor cache
var vendorsCache = [];
var pendingVendors = [];

console.log('✅ Vendor Manager Module Loaded');


/**
 * ==========================================
 * NAVIGATION FUNCTION
 * ==========================================
 */
 function navigateToVendors() {
  console.log('🏢 Navigating to Vendors');
  
  currentPage = 'vendors';
  
  // Get page elements
  const mainApp = document.getElementById('mainApp');
  const allProductsPage = document.getElementById('allProductsPage');
  const productGroupsPage = document.getElementById('productGroupsPage');
  const customersPage = document.getElementById('customersPage');
  const groupDetailPage = document.getElementById('groupDetailPage');
  const brandsPage = document.getElementById('brandsPage');
  const sizesPage = document.getElementById('sizesPage');
  const categoriesPage = document.getElementById('categoriesPage');
  const unitTypesPage = document.getElementById('unitTypesPage');
  const vendorsPage = document.getElementById('vendorsPage');
  const invoiceCustomersPage = document.getElementById('invoiceCustomersPage'); // ✅ ADD THIS
  
  // Hide all other pages
  if (mainApp) mainApp.style.display = 'none';
  if (allProductsPage) allProductsPage.style.display = 'none';
  if (productGroupsPage) productGroupsPage.style.display = 'none';
  if (customersPage) customersPage.style.display = 'none';
  if (groupDetailPage) groupDetailPage.style.display = 'none';
  if (brandsPage) brandsPage.style.display = 'none';
  if (sizesPage) sizesPage.style.display = 'none';
  if (categoriesPage) categoriesPage.style.display = 'none';
  if (unitTypesPage) unitTypesPage.style.display = 'none';
  
  // ✅ ADD THIS - Hide invoice customers page
  if (invoiceCustomersPage) {
    invoiceCustomersPage.classList.remove('active');
    invoiceCustomersPage.style.display = 'none';
  }
  
  // Hide main navbar
  const mainNavbar = document.getElementById('mainAppNavbar');
  if (mainNavbar) {
    mainNavbar.style.display = 'none';
  }
  
  const stickyNavbar = document.querySelector('.navbar.sticky-top');
  if (stickyNavbar) {
    stickyNavbar.style.display = 'none';
  }
  
  // Show vendors page
  if (vendorsPage) {
    vendorsPage.classList.add('active');
    vendorsPage.style.display = 'block';
    vendorsPage.style.marginTop = '0';
    vendorsPage.style.paddingTop = '0';
    console.log('✅ Vendors page displayed');
  } else {
    console.error('❌ vendorsPage element not found!');
    return;
  }
  
  // Load vendors
  loadVendors();
  
  // Close sidebar and scroll
  if (typeof closeSidebar === 'function') {
    closeSidebar();
  }
  
  window.scrollTo({ top: 0, behavior: 'smooth' });
}



/**
 * ==========================================
 * DATA LOADING FUNCTIONS
 * ==========================================
 */
 async function loadVendors() {
  try {
    console.log('📡 Fetching vendors from Firebase...');
    
    const user = window.auth.currentUser;
    
    if (!user) {
      console.error('❌ No user authenticated');
      throw new Error('Please sign in first');
    }
    
    const { collection, getDocs } = window.firebaseImports;
    const userId = user.uid;
    
    const vendorsRef = collection(window.db, 'tenants', userId, 'vendors');
    const vendorsSnap = await getDocs(vendorsRef);
    
    vendorsCache = [];
    vendorsSnap.forEach((doc) => {
      const data = doc.data();
      if (data.name) {
        vendorsCache.push(data.name);
      }
    });
    
    console.log('✅ Loaded', vendorsCache.length, 'vendors from Firebase');
    
    // ✅ Sync autocomplete cache
    syncVendorCaches();
    
    renderVendorsList();
    
  } catch (error) {
    console.error('❌ Error loading vendors:', error);
    
    const container = document.getElementById('vendorsListContainer');
    if (container) {
      container.innerHTML = `
        <div style="text-align:center; padding:40px; color:#dc3545;">
          <i class="bi bi-exclamation-circle" style="font-size:48px;"></i>
          <h4 style="margin-top:20px;">Error Loading Vendors</h4>
          <p>${error.message}</p>
          <button class="btn btn-primary mt-3" onclick="loadVendors()">
            <i class="bi bi-arrow-clockwise"></i> Retry
          </button>
        </div>
      `;
    }
  }
}


/**
 * ==========================================
 * RENDERING FUNCTIONS
 * ==========================================
 */
function renderVendorsList() {
  console.log('🎨 Rendering vendors list...');
  
  const container = document.getElementById('vendorsListContainer');
  const emptyState = document.getElementById('vendorsEmptyState');
  
  if (!container) {
    console.error('❌ vendorsListContainer not found!');
    return;
  }
  
  if (!vendorsCache || vendorsCache.length === 0) {
    container.innerHTML = '';
    if (emptyState) {
      emptyState.style.display = 'block';
    }
    console.log('📋 No vendors to display');
    return;
  }
  
  if (emptyState) {
    emptyState.style.display = 'none';
  }
  
  const sortedVendors = [...vendorsCache].sort((a, b) => a.localeCompare(b));
  
  let html = '<div style="padding:20px; max-width:1200px; margin:0 auto;">';
  
  sortedVendors.forEach(vendor => {
    html += `
      <div class="card mb-3 shadow-sm" style="cursor:pointer; transition:transform 0.2s;" 
           onmouseover="this.style.transform='scale(1.02)'" 
           onmouseout="this.style.transform='scale(1)'">
        <div class="card-body">
          <div style="display:flex; justify-content:space-between; align-items:start;">
            <div style="flex:1;">
              <h5 class="mb-2">
                <i class="bi bi-building"></i> ${escapeHtml(vendor)}
              </h5>
            </div>
            <div style="display:flex; gap:8px;">
              <button class="btn btn-sm btn-danger" 
                      onclick="confirmDeleteVendor('${escapeHtml(vendor)}')"
                      title="Delete Vendor">
                <i class="bi bi-trash"></i> Delete
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  
  container.innerHTML = html;
  console.log(`✅ Rendered ${vendorsCache.length} vendors`);
}


function filterVendors(searchTerm) {
  if (!vendorsCache) {
    console.warn('⚠️ vendorsCache is empty');
    return;
  }
  
  const term = searchTerm.toLowerCase().trim();
  const container = document.getElementById('vendorsListContainer');
  const emptyState = document.getElementById('vendorsEmptyState');
  
  if (!container) return;
  
  if (!term || term.length === 0) {
    renderVendorsList();
    return;
  }
  
  const filtered = vendorsCache.filter(vendor => 
    vendor.toLowerCase().includes(term)
  );
  
  console.log(`🔍 Search: "${searchTerm}" - Found ${filtered.length} matches`);
  
  if (emptyState) {
    emptyState.style.display = 'none';
  }
  
  if (filtered.length === 0) {
    container.innerHTML = `
      <div style="text-align:center; padding:40px; color:#999;">
        <i class="bi bi-search" style="font-size:48px;"></i>
        <h4 style="margin-top:20px;">No vendors found</h4>
        <p>No vendors match "${escapeHtml(searchTerm)}"</p>
        <button class="btn btn-outline-primary mt-3" onclick="document.getElementById('searchVendorsInput').value=''; filterVendors('');">
          <i class="bi bi-x-circle"></i> Clear Search
        </button>
      </div>
    `;
    return;
  }
  
  const sortedFiltered = filtered.sort((a, b) => a.localeCompare(b));
  
  let html = '<div style="padding:20px; max-width:1200px; margin:0 auto;">';
  
  sortedFiltered.forEach(vendor => {
    html += `
      <div class="card mb-3 shadow-sm" style="cursor:pointer; transition:transform 0.2s;" 
           onmouseover="this.style.transform='scale(1.02)'" 
           onmouseout="this.style.transform='scale(1)'">
        <div class="card-body">
          <div style="display:flex; justify-content:space-between; align-items:start;">
            <div style="flex:1;">
              <h5 class="mb-2">
                <i class="bi bi-building"></i> ${escapeHtml(vendor)}
              </h5>
            </div>
            <div style="display:flex; gap:8px;">
              <button class="btn btn-sm btn-danger" 
                      onclick="confirmDeleteVendor('${escapeHtml(vendor)}')"
                      title="Delete Vendor">
                <i class="bi bi-trash"></i> Delete
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  container.innerHTML = html;
}


/**
 * ==========================================
 * MODAL FUNCTIONS
 * ==========================================
 */
function openAddVendorModal() {
  console.log('➕ Opening Add Vendors modal');
  
  // Reset pending vendors
  pendingVendors = [];
  
  // Clear input
  const input = document.getElementById('vendorInput');
  if (input) {
    input.value = '';
    window.lastVendorInput = '';
  }
  
  // Update preview (should show empty state)
  updateVendorPreviewList();
  
  // Open modal
  const modal = new bootstrap.Modal(document.getElementById('addVendorsModal'));
  modal.show();
  
  // Focus on input after modal opens
  setTimeout(() => {
    if (input) input.focus();
  }, 200);
}


/**
 * ==========================================
 * INPUT HANDLING
 * ==========================================
 */
function handleVendorInputKeydown(event) {
  const input = document.getElementById('vendorInput');
  if (!input) {
    console.error('❌ vendorInput not found');
    return;
  }
  
  // Check if Enter or Comma key
  if (event.key === 'Enter' || event.key === ',') {
    event.preventDefault();
    
    let value = window.lastVendorInput || input.value;
    value = value.trim();
    
    // Remove trailing comma if present
    if (value.endsWith(',')) {
      value = value.slice(0, -1).trim();
    }
    
    if (value && value.length > 0) {
      // Check if already in pending list
      if (pendingVendors.includes(value)) {
        alert('⚠️ This vendor is already in the list!');
      } else {
        // Add to pending vendors
        pendingVendors.push(value);
        console.log('✅ Vendor added to preview:', value);
        
        // Update preview
        updateVendorPreviewList();
      }
    }
    
    // Clear input
    input.value = '';
    window.lastVendorInput = '';
  }
}


function addVendorToList() {
  const input = document.getElementById('vendorInput');
  if (!input) {
    console.error('❌ vendorInput not found');
    return;
  }
  
  const vendorName = input.value.trim();
  
  if (!vendorName || vendorName.length === 0) {
    alert('⚠️ Please enter a vendor name');
    return;
  }
  
  if (pendingVendors.includes(vendorName)) {
    alert('⚠️ This vendor is already in the list!');
    input.value = '';
    return;
  }
  
  // Add to pending list
  pendingVendors.push(vendorName);
  console.log('✅ Vendor added:', vendorName);
  
  // Clear input
  input.value = '';
  window.lastVendorInput = '';
  
  // Update preview
  updateVendorPreviewList();
  
  // Focus back to input
  input.focus();
}


/**
 * ==========================================
 * PREVIEW LIST
 * ==========================================
 */
function updateVendorPreviewList() {
  const previewList = document.getElementById('vendorPreviewList');
  const previewCount = document.getElementById('vendorPreviewCount');
  
  if (!previewList) {
    console.error('❌ vendorPreviewList not found');
    return;
  }
  
  if (previewCount) {
    previewCount.textContent = `📝 Vendors to Save (${pendingVendors.length}):`;
  }
  
  if (pendingVendors.length === 0) {
    previewList.innerHTML = `
      <div style="padding: 15px; color: #999; text-align: center; font-size: 14px;">
        No vendors added yet
      </div>
    `;
    return;
  }
  
  let html = '';
  pendingVendors.forEach((vendor, index) => {
    html += `
      <div style="
        display: flex; justify-content: space-between; align-items: center;
        padding: 10px 12px; border-bottom: 1px solid #e0e0e0;
        background: white; transition: background 0.2s;
      " onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='white'">
        
        <span style="font-size: 14px; color: #333; flex: 1;">
          <strong style="color: #007bff;">${index + 1}.</strong> 
          <span style="margin-left: 8px;">${escapeHtml(vendor)}</span>
        </span>
        
        <button onclick="removePendingVendor(${index})" style="
          background: #dc3545; color: white; border: none; 
          padding: 5px 10px; border-radius: 5px; cursor: pointer;
          font-size: 12px; font-weight: 600; transition: background 0.2s;
        " onmouseover="this.style.background='#c82333'" onmouseout="this.style.background='#dc3545'">
          <i class="bi bi-x"></i>
        </button>
      </div>
    `;
  });
  
  previewList.innerHTML = html;
  console.log(`📋 Updated preview: ${pendingVendors.length} vendors`);
}


function removePendingVendor(index) {
  if (!pendingVendors || index < 0 || index >= pendingVendors.length) {
    console.error('❌ Invalid index:', index);
    return;
  }
  
  const removed = pendingVendors.splice(index, 1);
  console.log('🗑️ Removed vendor:', removed[0]);
  updateVendorPreviewList();
}


/**
 * ==========================================
 * SAVE VENDORS TO FIREBASE
 * ==========================================
 */
async function saveAllVendors() {
  if (pendingVendors.length === 0) {
    alert('⚠️ Please add at least one vendor');
    return;
  }
  
  console.log('💾 Saving', pendingVendors.length, 'vendors to Firebase...');
  
  const user = window.auth.currentUser;
  
  if (!user) {
    alert('❌ Please sign in first');
    return;
  }
  
  try {
    // Clear input field
    const input = document.getElementById('vendorInput');
    if (input) {
      input.value = '';
      window.lastVendorInput = '';
    }
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('addVendorsModal'));
    if (modal) {
      modal.hide();
    }
    
    // Add vendors to cache immediately
    const vendorsToSave = [...pendingVendors];
    vendorsCache.push(...vendorsToSave);
    
    // Refresh display
    renderVendorsList();
    
    // Show success
    alert(`✅ Success!\n\n${vendorsToSave.length} vendor(s) added!`);
    
    // Clear pending
    pendingVendors = [];
    
    // Save to Firebase
    const { collection, addDoc } = window.firebaseImports;
    const userId = user.uid;
    const vendorsRef = collection(window.db, 'tenants', userId, 'vendors');
    
    const savePromises = vendorsToSave.map(async (vendorName) => {
      try {
        await addDoc(vendorsRef, {
          name: vendorName,
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString(),
          userId: userId
        });
        console.log('✅ Firebase: Vendor saved:', vendorName);
        return { success: true, vendor: vendorName };
      } catch (error) {
        console.error('❌ Firebase: Failed to save vendor:', vendorName, error);
        return { success: false, vendor: vendorName, error };
      }
    });
    
    const results = await Promise.all(savePromises);
    const failed = results.filter(r => !r.success);
    
    if (failed.length > 0) {
      console.warn(`⚠️ ${failed.length} vendor(s) failed to save`);
      setTimeout(() => {
        loadVendors();
      }, 1000);
    } else {
      console.log(`✅ All ${vendorsToSave.length} vendors saved`);
    }
    
  } catch (error) {
    console.error('❌ Error saving vendors:', error);
    alert('❌ Error saving vendors. Please try again.');
    loadVendors();
  }
}


/**
 * ==========================================
 * DELETE VENDOR FROM FIREBASE
 * ==========================================
 */
function confirmDeleteVendor(vendor) {
  const confirmed = confirm(`🗑️ Delete "${vendor}"?\n\nThis cannot be undone.`);
  
  if (confirmed) {
    deleteVendor(vendor);
  }
}


async function deleteVendor(vendorName) {
  console.log('🗑️ Deleting vendor:', vendorName);
  
  const user = window.auth.currentUser;
  
  if (!user) {
    alert('❌ Please sign in first');
    return;
  }
  
  try {
    // Remove from local cache immediately (Optimistic UI)
    vendorsCache = vendorsCache.filter(v => v !== vendorName);
    
    console.log('🧹 Removed from local cache');
    
    // Refresh display immediately
    renderVendorsList();
    
    // Delete from Firebase
    const { collection, query, where, getDocs, deleteDoc } = window.firebaseImports;
    const userId = user.uid;
    
    const vendorsRef = collection(window.db, 'tenants', userId, 'vendors');
    const q = query(vendorsRef, where('name', '==', vendorName));
    const snapshot = await getDocs(q);
    
    console.log('📊 Firebase query found', snapshot.size, 'documents to delete');
    
    if (snapshot.empty) {
      console.warn('⚠️ Vendor not found in Firebase:', vendorName);
      alert(`⚠️ Vendor "${vendorName}" not found in database`);
      return;
    }
    
    // Delete all matching documents
    const deletePromises = [];
    snapshot.forEach((docSnap) => {
      console.log('  Deleting doc:', docSnap.id);
      deletePromises.push(deleteDoc(docSnap.ref));
    });
    
    await Promise.all(deletePromises);
    
    console.log('✅ Vendor deleted from Firebase:', vendorName);
    alert(`✅ Vendor "${vendorName}" deleted successfully!`);
    
  } catch (error) {
    console.error('❌ Error deleting vendor:', error);
    alert('❌ Error deleting vendor: ' + error.message);
    
    // Reload vendors to sync
    loadVendors();
  }
}


/**
 * ==========================================
 * HELPER FUNCTIONS
 * ==========================================
 */
function escapeHtml(text) {
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#39;'
  };
  return String(text).replace(/[&<>"']/g, m => map[m]);
}


// Make functions global
window.navigateToVendors = navigateToVendors;
window.loadVendors = loadVendors;
window.openAddVendorModal = openAddVendorModal;
window.saveAllVendors = saveAllVendors;
window.deleteVendor = deleteVendor;
window.confirmDeleteVendor = confirmDeleteVendor;
window.updateVendorPreviewList = updateVendorPreviewList;
window.removePendingVendor = removePendingVendor;

console.log('✅ Vendor Manager Module Loaded (Firebase)');


// ✅ ADD THESE FOR AUTOCOMPLETE
var vendorAutocompleteCache = [];
var vendorCacheLoaded = false;

/**
 * ==========================================
 * VENDOR AUTOCOMPLETE SYSTEM
 * ==========================================
 */

/**
 * Load vendor autocomplete cache
 */
 async function loadVendorAutocompleteCache() {
  if (vendorCacheLoaded) {
    console.log('✅ Vendor cache already loaded');
    return;
  }
  
  const user = window.auth.currentUser;
  
  if (!user) {
    console.log('No user authenticated, skipping vendor cache load');
    return;
  }
  
  console.log('📥 Loading vendor autocomplete cache from Firestore...');
  
  try {
    const { collection, getDocs } = window.firebaseImports;
    
    // Load from Firestore
    const vendorsRef = collection(window.db, 'tenants', user.uid, 'vendors');
    const snapshot = await getDocs(vendorsRef);
    
    const vendors = [];
    snapshot.forEach((doc) => {
      const data = doc.data();
      const vendorName = data.name || data.vendorName;
      if (vendorName) {
        vendors.push(vendorName);
      }
    });
    
    vendorAutocompleteCache = vendors;
    vendorCacheLoaded = true;
    
    console.log('✅ Loaded', vendors.length, 'vendors into autocomplete cache');
    
  } catch (error) {
    console.error('❌ Error loading vendor cache:', error);
  }
}


/**
 * Show vendor suggestions when field is clicked
 */
async function showVendorSuggestions() {
  const input = document.getElementById('purchaseVendorName');
  if (!input) return;
  
  console.log('👆 Purchase vendor field clicked');
  
  // Load cache if empty
  if (!vendorAutocompleteCache || vendorAutocompleteCache.length === 0) {
    const user = window.auth.currentUser;
    if (user) {
      try {
        const { collection, getDocs } = window.firebaseImports;
        const vendorsRef = collection(window.db, 'tenants', user.uid, 'vendors');
        const snapshot = await getDocs(vendorsRef);
        
        const vendors = [];
        snapshot.forEach((doc) => {
          const data = doc.data();
          const vendorName = data.name || data.vendorName;
          if (vendorName) vendors.push(vendorName);
        });
        
        vendorAutocompleteCache = vendors;
        vendorCacheLoaded = true;
        console.log('✅ Force loaded', vendors.length, 'vendors');
      } catch (error) {
        console.error('❌ Error:', error);
        return;
      }
    }
  }
  
  const inputValue = input.value.trim();
  
  // Show all vendors if field is empty
  if (!inputValue || inputValue.length === 0) {
    if (vendorAutocompleteCache && vendorAutocompleteCache.length > 0) {
      renderVendorSuggestions(vendorAutocompleteCache);
    }
  } else {
    filterVendorSuggestions(inputValue);
  }
}
/**
 * Filter vendor suggestions based on input
 * ✅ Enhanced version with smooth UX
 */
 function filterVendorSuggestions(inputText) {
  const dropdown = document.getElementById('purchaseVendorSuggestionsDropdown');
  const input = document.getElementById('purchaseVendorName');
  
  if (!input) {
    console.warn('⚠️ Vendor input field not found');
    return;
  }
  
  // Check if input field is focused
  const isFocused = document.activeElement === input;
  
  // Normalize input
  const trimmedInput = inputText ? inputText.trim() : '';
  
  // ✅ CASE 1: Input is empty
  if (!trimmedInput || trimmedInput.length === 0) {
    // Show all vendors ONLY if field is focused
    if (isFocused) {
      if (vendorAutocompleteCache && vendorAutocompleteCache.length > 0) {
        renderVendorSuggestions(vendorAutocompleteCache);
        console.log('✅ Showing all', vendorAutocompleteCache.length, 'vendors (field focused, input empty)');
      } else {
        // No vendors in cache
        if (dropdown) {
          dropdown.innerHTML = `
            <div style="padding: 15px; text-align: center; color: #999;">
              <i class="bi bi-inbox"></i> No vendors available
            </div>
          `;
          dropdown.style.display = 'block';
        }
        console.log('ℹ️ No vendors in cache');
      }
    } else {
      // Field not focused, hide dropdown
      if (dropdown) dropdown.style.display = 'none';
    }
    
    // Hide save button when input is empty
    const saveBtn = document.getElementById('saveVendorInsideBtn');
    if (saveBtn) saveBtn.style.display = 'none';
    
    return;
  }
  
  // ✅ CASE 2: User is typing - filter vendors
  const query = trimmedInput.toLowerCase();
  const matches = vendorAutocompleteCache.filter(vendor => 
    vendor.toLowerCase().startsWith(query)
  );
  
  if (matches.length > 0) {
    // Show filtered results
    renderVendorSuggestions(matches);
    console.log('✅ Showing', matches.length, 'vendors matching "' + trimmedInput + '"');
  } else {
    // No matches found
    if (dropdown) {
      dropdown.innerHTML = `
        <div style="padding: 15px; text-align: center; color: #999;">
          <i class="bi bi-search"></i> No vendors match "<strong>${escapeHtml(trimmedInput)}</strong>"
        </div>
      `;
      dropdown.style.display = 'block';
    }
    console.log('ℹ️ No vendors match:', trimmedInput);
  }
  
  // Check if we should show save button for new vendor
  checkAndShowSaveVendorButton(trimmedInput);
}


/**
 * Render vendor suggestions dropdown
 */
function renderVendorSuggestions(matches) {
  const dropdown = document.getElementById('purchaseVendorSuggestionsDropdown');
  if (!dropdown) return;
  
  const limitedMatches = matches.slice(0, 15);
  
  let html = '';
  limitedMatches.forEach(vendor => {
    const escaped = escapeHtml(vendor);
    html += `
      <div onclick="selectVendorSuggestion('${escaped}')" style="
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background 0.2s;
      " onmouseover="this.style.background='#f5f5f5'" 
         onmouseout="this.style.background='transparent'">
        <i class="bi bi-building" style="color: #28a745; margin-right: 8px;"></i>
        <strong>${vendor}</strong>
      </div>
    `;
  });
  
  dropdown.innerHTML = html;
  dropdown.style.display = 'block';
  
  console.log('✅ Rendered', limitedMatches.length, 'vendor suggestions');
}


/**
 * Select vendor from suggestions
 */
function selectVendorSuggestion(vendorName) {
  const input = document.getElementById('purchaseVendorName');
  const dropdown = document.getElementById('purchaseVendorSuggestionsDropdown');
  
  if (input) {
    input.value = vendorName;
  }
  
  // Hide dropdown
  if (dropdown) dropdown.style.display = 'none';
  
  // Hide save button
  const saveBtn = document.getElementById('saveVendorInsideBtn');
  if (saveBtn) saveBtn.style.display = 'none';
  
  console.log('✅ Selected vendor:', vendorName);
}


/**
 * Hide vendor suggestions dropdown
 */
function hideVendorSuggestions() {
  const dropdown = document.getElementById('purchaseVendorSuggestionsDropdown');
  if (dropdown) {
    dropdown.style.display = 'none';
  }
}


/**
 * Check if vendor exists and show/hide save button
 */
function checkAndShowSaveVendorButton(inputText) {
  const btn = document.getElementById('saveVendorInsideBtn');
  if (!btn) return;
  
  const input = inputText.trim();
  
  if (!input || input.length === 0) {
    btn.style.display = 'none';
    return;
  }
  
  const vendorExists = vendorAutocompleteCache.some(vendor => 
    vendor.toLowerCase() === input.toLowerCase()
  );
  
  if (!vendorExists) {
    btn.innerHTML = '💾';
    btn.style.background = '#28a745';
    btn.style.cursor = 'pointer';
    btn.disabled = false;
    btn.style.display = 'block';
  } else {
    btn.style.display = 'none';
  }
}


/**
 * Save new vendor from purchase field
 */
async function saveNewVendorFromPurchaseField() {
  const input = document.getElementById('purchaseVendorName');
  const vendorName = input.value.trim();
  const btn = document.getElementById('saveVendorInsideBtn');
  
  if (!vendorName || vendorName.length === 0) {
    return;
  }
  
  const user = window.auth.currentUser;
  
  if (!user) {
    console.log('No user authenticated');
    return;
  }
  
  const vendorExists = vendorAutocompleteCache.some(vendor => 
    vendor.toLowerCase() === vendorName.toLowerCase()
  );
  
  if (vendorExists) {
    if (btn) btn.style.display = 'none';
    return;
  }
  
  console.log('💾 Saving new vendor:', vendorName);
  
  if (btn) {
    btn.innerHTML = '✅ Saved';
    btn.style.background = '#218838';
    btn.disabled = true;
  }
  
  try {
    const { collection, addDoc } = window.firebaseImports;
    
    const vendorsRef = collection(window.db, 'tenants', user.uid, 'vendors');
    await addDoc(vendorsRef, {
      name: vendorName,
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
      userId: user.uid
    });
    
    console.log('✅ Vendor saved successfully:', vendorName);
    
    // Add to cache
    vendorAutocompleteCache.push(vendorName);
    vendorsCache.push(vendorName);
    
  } catch (error) {
    console.error('❌ Error saving vendor:', error);
    
    if (btn) {
      btn.innerHTML = '❌ Error';
      btn.style.background = '#dc3545';
      
      setTimeout(() => {
        btn.innerHTML = '💾';
        btn.style.background = '#28a745';
        btn.disabled = false;
      }, 2000);
    }
  }
}


/**
 * Sync autocomplete cache with vendors cache
 */
function syncVendorCaches() {
  console.log('🔄 Syncing vendor caches...');
  vendorAutocompleteCache = [...vendorsCache];
  vendorAutocompleteCache = [...new Set(vendorAutocompleteCache)];
  console.log('✅ Sync complete -', vendorAutocompleteCache.length, 'vendors');
}


/**
 * Refresh vendor cache
 */
function refreshVendorAutocompleteCache() {
  vendorCacheLoaded = false;
  loadVendorAutocompleteCache();
}


// Make functions global
window.loadVendorAutocompleteCache = loadVendorAutocompleteCache;
window.showVendorSuggestions = showVendorSuggestions;
window.filterVendorSuggestions = filterVendorSuggestions;
window.selectVendorSuggestion = selectVendorSuggestion;
window.hideVendorSuggestions = hideVendorSuggestions;
window.saveNewVendorFromPurchaseField = saveNewVendorFromPurchaseField;
window.syncVendorCaches = syncVendorCaches;
window.refreshVendorAutocompleteCache = refreshVendorAutocompleteCache;

/**
 * ==========================================
 * INVOICE CUSTOMER MANAGEMENT SYSTEM - FIREBASE VERSION
 * ==========================================
 */

// Global invoice customer cache
var invoiceCustomersCache = [];
var pendingInvoiceCustomers = [];

// Autocomplete cache
var invoiceCustomerAutocompleteCache = [];
var invoiceCustomerCacheLoaded = false;

console.log('✅ Invoice Customer Manager Module Loaded');


/**
 * ==========================================
 * NAVIGATION FUNCTION
 * ==========================================
 */
function navigateToInvoiceCustomers() {
  console.log('🧾 Navigating to Invoice Customers');
  
  currentPage = 'invoiceCustomers';
  
  // Get page elements
  const mainApp = document.getElementById('mainApp');
  const allProductsPage = document.getElementById('allProductsPage');
  const productGroupsPage = document.getElementById('productGroupsPage');
  const customersPage = document.getElementById('customersPage');
  const groupDetailPage = document.getElementById('groupDetailPage');
  const brandsPage = document.getElementById('brandsPage');
  const sizesPage = document.getElementById('sizesPage');
  const categoriesPage = document.getElementById('categoriesPage');
  const unitTypesPage = document.getElementById('unitTypesPage');
  const vendorsPage = document.getElementById('vendorsPage');
  const invoiceCustomersPage = document.getElementById('invoiceCustomersPage');
  
  // Hide all other pages
  if (mainApp) mainApp.style.display = 'none';
  if (allProductsPage) allProductsPage.style.display = 'none';
  if (productGroupsPage) productGroupsPage.style.display = 'none';
  if (customersPage) customersPage.style.display = 'none';
  if (groupDetailPage) groupDetailPage.style.display = 'none';
  if (brandsPage) brandsPage.style.display = 'none';
  if (sizesPage) sizesPage.style.display = 'none';
  if (categoriesPage) categoriesPage.style.display = 'none';
  if (unitTypesPage) unitTypesPage.style.display = 'none';
  if (vendorsPage) vendorsPage.style.display = 'none';
  
  // Hide main navbar
  const mainNavbar = document.getElementById('mainAppNavbar');
  if (mainNavbar) {
    mainNavbar.style.display = 'none';
  }
  
  const stickyNavbar = document.querySelector('.navbar.sticky-top');
  if (stickyNavbar) {
    stickyNavbar.style.display = 'none';
  }
  
  // Show invoice customers page
  if (invoiceCustomersPage) {
    invoiceCustomersPage.classList.add('active');
    invoiceCustomersPage.style.display = 'block';
    invoiceCustomersPage.style.marginTop = '0';
    invoiceCustomersPage.style.paddingTop = '0';
    console.log('✅ Invoice Customers page displayed');
  } else {
    console.error('❌ invoiceCustomersPage element not found!');
    return;
  }
  
  // Load invoice customers
  loadInvoiceCustomers();
  
  // Close sidebar and scroll
  if (typeof closeSidebar === 'function') {
    closeSidebar();
  }
  
  window.scrollTo({ top: 0, behavior: 'smooth' });
}


/**
 * ==========================================
 * DATA LOADING FUNCTIONS
 * ==========================================
 */
async function loadInvoiceCustomers() {
  try {
    console.log('📡 Fetching invoice customers from Firebase...');
    
    const user = window.auth.currentUser;
    
    if (!user) {
      console.error('❌ No user authenticated');
      throw new Error('Please sign in first');
    }
    
    const { collection, getDocs } = window.firebaseImports;
    const userId = user.uid;
    
    const invoiceCustomersRef = collection(window.db, 'tenants', userId, 'invoiceCustomers');
    const invoiceCustomersSnap = await getDocs(invoiceCustomersRef);
    
    invoiceCustomersCache = [];
    invoiceCustomersSnap.forEach((doc) => {
      const data = doc.data();
      if (data.name) {
        invoiceCustomersCache.push(data.name);
      }
    });
    
    console.log('✅ Loaded', invoiceCustomersCache.length, 'invoice customers from Firebase');
    
    // Sync autocomplete cache
    syncInvoiceCustomerCaches();
    
    renderInvoiceCustomersList();
    
  } catch (error) {
    console.error('❌ Error loading invoice customers:', error);
    
    const container = document.getElementById('invoiceCustomersListContainer');
    if (container) {
      container.innerHTML = `
        <div style="text-align:center; padding:40px; color:#dc3545;">
          <i class="bi bi-exclamation-circle" style="font-size:48px;"></i>
          <h4 style="margin-top:20px;">Error Loading Invoice Customers</h4>
          <p>${error.message}</p>
          <button class="btn btn-primary mt-3" onclick="loadInvoiceCustomers()">
            <i class="bi bi-arrow-clockwise"></i> Retry
          </button>
        </div>
      `;
    }
  }
}


/**
 * ==========================================
 * RENDERING FUNCTIONS
 * ==========================================
 */
function renderInvoiceCustomersList() {
  console.log('🎨 Rendering invoice customers list...');
  
  const container = document.getElementById('invoiceCustomersListContainer');
  const emptyState = document.getElementById('invoiceCustomersEmptyState');
  
  if (!container) {
    console.error('❌ invoiceCustomersListContainer not found!');
    return;
  }
  
  if (!invoiceCustomersCache || invoiceCustomersCache.length === 0) {
    container.innerHTML = '';
    if (emptyState) {
      emptyState.style.display = 'block';
    }
    console.log('📋 No invoice customers to display');
    return;
  }
  
  if (emptyState) {
    emptyState.style.display = 'none';
  }
  
  const sortedInvoiceCustomers = [...invoiceCustomersCache].sort((a, b) => a.localeCompare(b));
  
  let html = '<div style="padding:20px; max-width:1200px; margin:0 auto;">';
  
  sortedInvoiceCustomers.forEach(customer => {
    html += `
      <div class="card mb-3 shadow-sm" style="cursor:pointer; transition:transform 0.2s;" 
           onmouseover="this.style.transform='scale(1.02)'" 
           onmouseout="this.style.transform='scale(1)'">
        <div class="card-body">
          <div style="display:flex; justify-content:space-between; align-items:start;">
            <div style="flex:1;">
              <h5 class="mb-2">
                <i class="bi bi-person-vcard"></i> ${escapeHtml(customer)}
              </h5>
            </div>
            <div style="display:flex; gap:8px;">
              <button class="btn btn-sm btn-danger" 
                      onclick="confirmDeleteInvoiceCustomer('${escapeHtml(customer)}')"
                      title="Delete Customer">
                <i class="bi bi-trash"></i> Delete
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  
  container.innerHTML = html;
  console.log(`✅ Rendered ${invoiceCustomersCache.length} invoice customers`);
}


function filterInvoiceCustomers(searchTerm) {
  if (!invoiceCustomersCache) {
    console.warn('⚠️ invoiceCustomersCache is empty');
    return;
  }
  
  const term = searchTerm.toLowerCase().trim();
  const container = document.getElementById('invoiceCustomersListContainer');
  const emptyState = document.getElementById('invoiceCustomersEmptyState');
  
  if (!container) return;
  
  if (!term || term.length === 0) {
    renderInvoiceCustomersList();
    return;
  }
  
  const filtered = invoiceCustomersCache.filter(customer => 
    customer.toLowerCase().includes(term)
  );
  
  console.log(`🔍 Search: "${searchTerm}" - Found ${filtered.length} matches`);
  
  if (emptyState) {
    emptyState.style.display = 'none';
  }
  
  if (filtered.length === 0) {
    container.innerHTML = `
      <div style="text-align:center; padding:40px; color:#999;">
        <i class="bi bi-search" style="font-size:48px;"></i>
        <h4 style="margin-top:20px;">No customers found</h4>
        <p>No invoice customers match "${escapeHtml(searchTerm)}"</p>
        <button class="btn btn-outline-primary mt-3" onclick="document.getElementById('searchInvoiceCustomersInput').value=''; filterInvoiceCustomers('');">
          <i class="bi bi-x-circle"></i> Clear Search
        </button>
      </div>
    `;
    return;
  }
  
  const sortedFiltered = filtered.sort((a, b) => a.localeCompare(b));
  
  let html = '<div style="padding:20px; max-width:1200px; margin:0 auto;">';
  
  sortedFiltered.forEach(customer => {
    html += `
      <div class="card mb-3 shadow-sm" style="cursor:pointer; transition:transform 0.2s;" 
           onmouseover="this.style.transform='scale(1.02)'" 
           onmouseout="this.style.transform='scale(1)'">
        <div class="card-body">
          <div style="display:flex; justify-content:space-between; align-items:start;">
            <div style="flex:1;">
              <h5 class="mb-2">
                <i class="bi bi-person-vcard"></i> ${escapeHtml(customer)}
              </h5>
            </div>
            <div style="display:flex; gap:8px;">
              <button class="btn btn-sm btn-danger" 
                      onclick="confirmDeleteInvoiceCustomer('${escapeHtml(customer)}')"
                      title="Delete Customer">
                <i class="bi bi-trash"></i> Delete
              </button>
            </div>
          </div>
        </div>
      </div>
    `;
  });
  
  html += '</div>';
  container.innerHTML = html;
}


/**
 * ==========================================
 * MODAL FUNCTIONS
 * ==========================================
 */
function openAddInvoiceCustomerModal() {
  console.log('➕ Opening Add Invoice Customers modal');
  
  // Reset pending invoice customers
  pendingInvoiceCustomers = [];
  
  // Clear input
  const input = document.getElementById('invoiceCustomerInput');
  if (input) {
    input.value = '';
    window.lastInvoiceCustomerInput = '';
  }
  
  // Update preview (should show empty state)
  updateInvoiceCustomerPreviewList();
  
  // Open modal
  const modal = new bootstrap.Modal(document.getElementById('addInvoiceCustomersModal'));
  modal.show();
  
  // Focus on input after modal opens
  setTimeout(() => {
    if (input) input.focus();
  }, 200);
}


/**
 * ==========================================
 * INPUT HANDLING
 * ==========================================
 */
function handleInvoiceCustomerInputKeydown(event) {
  const input = document.getElementById('invoiceCustomerInput');
  if (!input) {
    console.error('❌ invoiceCustomerInput not found');
    return;
  }
  
  // Check if Enter or Comma key
  if (event.key === 'Enter' || event.key === ',') {
    event.preventDefault();
    
    let value = window.lastInvoiceCustomerInput || input.value;
    value = value.trim();
    
    // Remove trailing comma if present
    if (value.endsWith(',')) {
      value = value.slice(0, -1).trim();
    }
    
    if (value && value.length > 0) {
      // Check if already in pending list
      if (pendingInvoiceCustomers.includes(value)) {
        alert('⚠️ This customer is already in the list!');
      } else {
        // Add to pending invoice customers
        pendingInvoiceCustomers.push(value);
        console.log('✅ Invoice customer added to preview:', value);
        
        // Update preview
        updateInvoiceCustomerPreviewList();
      }
    }
    
    // Clear input
    input.value = '';
    window.lastInvoiceCustomerInput = '';
  }
}


function addInvoiceCustomerToList() {
  const input = document.getElementById('invoiceCustomerInput');
  if (!input) {
    console.error('❌ invoiceCustomerInput not found');
    return;
  }
  
  const customerName = input.value.trim();
  
  if (!customerName || customerName.length === 0) {
    alert('⚠️ Please enter a customer name');
    return;
  }
  
  if (pendingInvoiceCustomers.includes(customerName)) {
    alert('⚠️ This customer is already in the list!');
    input.value = '';
    return;
  }
  
  // Add to pending list
  pendingInvoiceCustomers.push(customerName);
  console.log('✅ Invoice customer added:', customerName);
  
  // Clear input
  input.value = '';
  window.lastInvoiceCustomerInput = '';
  
  // Update preview
  updateInvoiceCustomerPreviewList();
  
  // Focus back to input
  input.focus();
}


/**
 * ==========================================
 * PREVIEW LIST
 * ==========================================
 */
function updateInvoiceCustomerPreviewList() {
  const previewList = document.getElementById('invoiceCustomerPreviewList');
  const previewCount = document.getElementById('invoiceCustomerPreviewCount');
  
  if (!previewList) {
    console.error('❌ invoiceCustomerPreviewList not found');
    return;
  }
  
  if (previewCount) {
    previewCount.textContent = `📝 Customers to Save (${pendingInvoiceCustomers.length}):`;
  }
  
  if (pendingInvoiceCustomers.length === 0) {
    previewList.innerHTML = `
      <div style="padding: 15px; color: #999; text-align: center; font-size: 14px;">
        No customers added yet
      </div>
    `;
    return;
  }
  
  let html = '';
  pendingInvoiceCustomers.forEach((customer, index) => {
    html += `
      <div style="
        display: flex; justify-content: space-between; align-items: center;
        padding: 10px 12px; border-bottom: 1px solid #e0e0e0;
        background: white; transition: background 0.2s;
      " onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='white'">
        
        <span style="font-size: 14px; color: #333; flex: 1;">
          <strong style="color: #007bff;">${index + 1}.</strong> 
          <span style="margin-left: 8px;">${escapeHtml(customer)}</span>
        </span>
        
        <button onclick="removePendingInvoiceCustomer(${index})" style="
          background: #dc3545; color: white; border: none; 
          padding: 5px 10px; border-radius: 5px; cursor: pointer;
          font-size: 12px; font-weight: 600; transition: background 0.2s;
        " onmouseover="this.style.background='#c82333'" onmouseout="this.style.background='#dc3545'">
          <i class="bi bi-x"></i>
        </button>
      </div>
    `;
  });
  
  previewList.innerHTML = html;
  console.log(`📋 Updated preview: ${pendingInvoiceCustomers.length} invoice customers`);
}


function removePendingInvoiceCustomer(index) {
  if (!pendingInvoiceCustomers || index < 0 || index >= pendingInvoiceCustomers.length) {
    console.error('❌ Invalid index:', index);
    return;
  }
  
  const removed = pendingInvoiceCustomers.splice(index, 1);
  console.log('🗑️ Removed invoice customer:', removed[0]);
  updateInvoiceCustomerPreviewList();
}


/**
 * ==========================================
 * SAVE INVOICE CUSTOMERS TO FIREBASE
 * ==========================================
 */
async function saveAllInvoiceCustomers() {
  if (pendingInvoiceCustomers.length === 0) {
    alert('⚠️ Please add at least one customer');
    return;
  }
  
  console.log('💾 Saving', pendingInvoiceCustomers.length, 'invoice customers to Firebase...');
  
  const user = window.auth.currentUser;
  
  if (!user) {
    alert('❌ Please sign in first');
    return;
  }
  
  try {
    // Clear input field
    const input = document.getElementById('invoiceCustomerInput');
    if (input) {
      input.value = '';
      window.lastInvoiceCustomerInput = '';
    }
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('addInvoiceCustomersModal'));
    if (modal) {
      modal.hide();
    }
    
    // Add invoice customers to cache immediately
    const customersToSave = [...pendingInvoiceCustomers];
    invoiceCustomersCache.push(...customersToSave);
    
    // Refresh display
    renderInvoiceCustomersList();
    
    // Show success
    alert(`✅ Success!\n\n${customersToSave.length} invoice customer(s) added!`);
    
    // Clear pending
    pendingInvoiceCustomers = [];
    
    // Save to Firebase
    const { collection, addDoc } = window.firebaseImports;
    const userId = user.uid;
    const invoiceCustomersRef = collection(window.db, 'tenants', userId, 'invoiceCustomers');
    
    const savePromises = customersToSave.map(async (customerName) => {
      try {
        await addDoc(invoiceCustomersRef, {
          name: customerName,
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString(),
          userId: userId
        });
        console.log('✅ Firebase: Invoice customer saved:', customerName);
        return { success: true, customer: customerName };
      } catch (error) {
        console.error('❌ Firebase: Failed to save invoice customer:', customerName, error);
        return { success: false, customer: customerName, error };
      }
    });
    
    const results = await Promise.all(savePromises);
    const failed = results.filter(r => !r.success);
    
    if (failed.length > 0) {
      console.warn(`⚠️ ${failed.length} invoice customer(s) failed to save`);
      setTimeout(() => {
        loadInvoiceCustomers();
      }, 1000);
    } else {
      console.log(`✅ All ${customersToSave.length} invoice customers saved`);
    }
    
  } catch (error) {
    console.error('❌ Error saving invoice customers:', error);
    alert('❌ Error saving invoice customers. Please try again.');
    loadInvoiceCustomers();
  }
}


/**
 * ==========================================
 * DELETE INVOICE CUSTOMER FROM FIREBASE
 * ==========================================
 */
function confirmDeleteInvoiceCustomer(customer) {
  const confirmed = confirm(`🗑️ Delete "${customer}"?\n\nThis cannot be undone.`);
  
  if (confirmed) {
    deleteInvoiceCustomer(customer);
  }
}


async function deleteInvoiceCustomer(customerName) {
  console.log('🗑️ Deleting invoice customer:', customerName);
  
  const user = window.auth.currentUser;
  
  if (!user) {
    alert('❌ Please sign in first');
    return;
  }
  
  try {
    // Remove from local cache immediately (Optimistic UI)
    invoiceCustomersCache = invoiceCustomersCache.filter(c => c !== customerName);
    invoiceCustomerAutocompleteCache = invoiceCustomerAutocompleteCache.filter(c => c !== customerName);
    
    console.log('🧹 Removed from local cache');
    
    // Refresh display immediately
    renderInvoiceCustomersList();
    
    // Delete from Firebase
    const { collection, query, where, getDocs, deleteDoc } = window.firebaseImports;
    const userId = user.uid;
    
    const invoiceCustomersRef = collection(window.db, 'tenants', userId, 'invoiceCustomers');
    const q = query(invoiceCustomersRef, where('name', '==', customerName));
    const snapshot = await getDocs(q);
    
    console.log('📊 Firebase query found', snapshot.size, 'documents to delete');
    
    if (snapshot.empty) {
      console.warn('⚠️ Invoice customer not found in Firebase:', customerName);
      alert(`⚠️ Customer "${customerName}" not found in database`);
      return;
    }
    
    // Delete all matching documents
    const deletePromises = [];
    snapshot.forEach((docSnap) => {
      console.log('  Deleting doc:', docSnap.id);
      deletePromises.push(deleteDoc(docSnap.ref));
    });
    
    await Promise.all(deletePromises);
    
    console.log('✅ Invoice customer deleted from Firebase:', customerName);
    alert(`✅ Customer "${customerName}" deleted successfully!`);
    
  } catch (error) {
    console.error('❌ Error deleting invoice customer:', error);
    alert('❌ Error deleting customer: ' + error.message);
    
    // Reload invoice customers to sync
    loadInvoiceCustomers();
  }
}


/**
 * ==========================================
 * AUTOCOMPLETE SYSTEM
 * ==========================================
 */
async function loadInvoiceCustomerAutocompleteCache() {
  if (invoiceCustomerCacheLoaded) {
    console.log('✅ Invoice customer cache already loaded');
    return;
  }
  
  const user = window.auth.currentUser;
  
  if (!user) {
    console.log('No user authenticated, skipping invoice customer cache load');
    return;
  }
  
  console.log('📥 Loading invoice customer autocomplete cache from Firestore...');
  
  try {
    const { collection, getDocs } = window.firebaseImports;
    
    const invoiceCustomersRef = collection(window.db, 'tenants', user.uid, 'invoiceCustomers');
    const snapshot = await getDocs(invoiceCustomersRef);
    
    const customers = [];
    snapshot.forEach((doc) => {
      const data = doc.data();
      const customerName = data.name || data.customerName;
      if (customerName) {
        customers.push(customerName);
      }
    });
    
    invoiceCustomerAutocompleteCache = customers;
    invoiceCustomerCacheLoaded = true;
    
    console.log('✅ Loaded', customers.length, 'invoice customers into autocomplete cache');
    
  } catch (error) {
    console.error('❌ Error loading invoice customer cache:', error);
  }
}


function syncInvoiceCustomerCaches() {
  console.log('🔄 Syncing invoice customer caches...');
  invoiceCustomerAutocompleteCache = [...invoiceCustomersCache];
  invoiceCustomerAutocompleteCache = [...new Set(invoiceCustomerAutocompleteCache)];
  console.log('✅ Sync complete -', invoiceCustomerAutocompleteCache.length, 'invoice customers');
}


function refreshInvoiceCustomerAutocompleteCache() {
  invoiceCustomerCacheLoaded = false;
  loadInvoiceCustomerAutocompleteCache();
}


/**
 * ==========================================
 * HELPER FUNCTIONS
 * ==========================================
 */
function escapeHtml(text) {
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#39;'
  };
  return String(text).replace(/[&<>"']/g, m => map[m]);
}


// Make functions global
window.navigateToInvoiceCustomers = navigateToInvoiceCustomers;
window.loadInvoiceCustomers = loadInvoiceCustomers;
window.openAddInvoiceCustomerModal = openAddInvoiceCustomerModal;
window.saveAllInvoiceCustomers = saveAllInvoiceCustomers;
window.deleteInvoiceCustomer = deleteInvoiceCustomer;
window.confirmDeleteInvoiceCustomer = confirmDeleteInvoiceCustomer;
window.updateInvoiceCustomerPreviewList = updateInvoiceCustomerPreviewList;
window.removePendingInvoiceCustomer = removePendingInvoiceCustomer;
window.loadInvoiceCustomerAutocompleteCache = loadInvoiceCustomerAutocompleteCache;
window.syncInvoiceCustomerCaches = syncInvoiceCustomerCaches;
window.refreshInvoiceCustomerAutocompleteCache = refreshInvoiceCustomerAutocompleteCache;

console.log('✅ Invoice Customer Manager Module Loaded (Firebase)');

/**
 * ==========================================
 * INVOICE CUSTOMER AUTOCOMPLETE FOR INVOICE MODAL
 * ==========================================
 */

/**
 * Show invoice customer suggestions when field is clicked
 */
 async function showInvoiceCustomerSuggestions() {
  const input = document.getElementById('invoiceCustomerName');
  if (!input) return;
  
  console.log('👆 Invoice customer field clicked');
  
  // Load cache if empty
  if (!invoiceCustomerAutocompleteCache || invoiceCustomerAutocompleteCache.length === 0) {
    const user = window.auth.currentUser;
    if (user) {
      try {
        const { collection, getDocs } = window.firebaseImports;
        const invoiceCustomersRef = collection(window.db, 'tenants', user.uid, 'invoiceCustomers');
        const snapshot = await getDocs(invoiceCustomersRef);
        
        const customers = [];
        snapshot.forEach((doc) => {
          const data = doc.data();
          const customerName = data.name || data.customerName;
          if (customerName) customers.push(customerName);
        });
        
        invoiceCustomerAutocompleteCache = customers;
        invoiceCustomerCacheLoaded = true;
        console.log('✅ Force loaded', customers.length, 'invoice customers');
      } catch (error) {
        console.error('❌ Error:', error);
        return;
      }
    }
  }
  
  const inputValue = input.value.trim();
  
  // Show all customers if field is empty
  if (!inputValue || inputValue.length === 0) {
    if (invoiceCustomerAutocompleteCache && invoiceCustomerAutocompleteCache.length > 0) {
      renderInvoiceCustomerSuggestions(invoiceCustomerAutocompleteCache);
    }
  } else {
    filterInvoiceCustomerSuggestions(inputValue);
  }
}


/**
 * Filter invoice customer suggestions based on input
 * ✅ Enhanced version with smooth UX
 */
function filterInvoiceCustomerSuggestions(inputText) {
  const dropdown = document.getElementById('invoiceCustomerSuggestionsDropdown');
  const input = document.getElementById('invoiceCustomerName');
  
  if (!input) {
    console.warn('⚠️ Invoice customer input field not found');
    return;
  }
  
  // Check if input field is focused
  const isFocused = document.activeElement === input;
  
  // Normalize input
  const trimmedInput = inputText ? inputText.trim() : '';
  
  // ✅ CASE 1: Input is empty
  if (!trimmedInput || trimmedInput.length === 0) {
    // Show all customers ONLY if field is focused
    if (isFocused) {
      if (invoiceCustomerAutocompleteCache && invoiceCustomerAutocompleteCache.length > 0) {
        renderInvoiceCustomerSuggestions(invoiceCustomerAutocompleteCache);
        console.log('✅ Showing all', invoiceCustomerAutocompleteCache.length, 'invoice customers (field focused, input empty)');
      } else {
        // No customers in cache
        if (dropdown) {
          dropdown.innerHTML = `
            <div style="padding: 15px; text-align: center; color: #999;">
              <i class="bi bi-inbox"></i> No customers available
            </div>
          `;
          dropdown.style.display = 'block';
        }
        console.log('ℹ️ No invoice customers in cache');
      }
    } else {
      // Field not focused, hide dropdown
      if (dropdown) dropdown.style.display = 'none';
    }
    
    // Hide save button when input is empty
    const saveBtn = document.getElementById('saveInvoiceCustomerInsideBtn');
    if (saveBtn) saveBtn.style.display = 'none';
    
    return;
  }
  
  // ✅ CASE 2: User is typing - filter customers
  const query = trimmedInput.toLowerCase();
  const matches = invoiceCustomerAutocompleteCache.filter(customer => 
    customer.toLowerCase().startsWith(query)
  );
  
  if (matches.length > 0) {
    // Show filtered results
    renderInvoiceCustomerSuggestions(matches);
    console.log('✅ Showing', matches.length, 'invoice customers matching "' + trimmedInput + '"');
  } else {
    // No matches found
    if (dropdown) {
      dropdown.innerHTML = `
        <div style="padding: 15px; text-align: center; color: #999;">
          <i class="bi bi-search"></i> No customers match "<strong>${escapeHtml(trimmedInput)}</strong>"
        </div>
      `;
      dropdown.style.display = 'block';
    }
    console.log('ℹ️ No invoice customers match:', trimmedInput);
  }
  
  // Check if we should show save button for new customer
  checkAndShowSaveInvoiceCustomerButton(trimmedInput);
}


/**
 * Render invoice customer suggestions dropdown
 */
function renderInvoiceCustomerSuggestions(matches) {
  const dropdown = document.getElementById('invoiceCustomerSuggestionsDropdown');
  if (!dropdown) return;
  
  const limitedMatches = matches.slice(0, 15);
  
  let html = '';
  limitedMatches.forEach(customer => {
    const escaped = escapeHtml(customer);
    html += `
      <div onclick="selectInvoiceCustomerSuggestion('${escaped}')" style="
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background 0.2s;
      " onmouseover="this.style.background='#f5f5f5'" 
         onmouseout="this.style.background='transparent'">
        <i class="bi bi-person-vcard" style="color: #007bff; margin-right: 8px;"></i>
        <strong>${customer}</strong>
      </div>
    `;
  });
  
  dropdown.innerHTML = html;
  dropdown.style.display = 'block';
  
  console.log('✅ Rendered', limitedMatches.length, 'invoice customer suggestions');
}


/**
 * Select invoice customer from suggestions
 */
function selectInvoiceCustomerSuggestion(customerName) {
  const input = document.getElementById('invoiceCustomerName');
  const dropdown = document.getElementById('invoiceCustomerSuggestionsDropdown');
  
  if (input) {
    input.value = customerName;
  }
  
  // Hide dropdown
  if (dropdown) dropdown.style.display = 'none';
  
  // Hide save button
  const saveBtn = document.getElementById('saveInvoiceCustomerInsideBtn');
  if (saveBtn) saveBtn.style.display = 'none';
  
  console.log('✅ Selected invoice customer:', customerName);
}


/**
 * Hide invoice customer suggestions dropdown
 */
function hideInvoiceCustomerSuggestions() {
  const dropdown = document.getElementById('invoiceCustomerSuggestionsDropdown');
  if (dropdown) {
    dropdown.style.display = 'none';
  }
}


/**
 * Check if invoice customer exists and show/hide save button
 */
function checkAndShowSaveInvoiceCustomerButton(inputText) {
  const btn = document.getElementById('saveInvoiceCustomerInsideBtn');
  if (!btn) return;
  
  const input = inputText.trim();
  
  if (!input || input.length === 0) {
    btn.style.display = 'none';
    return;
  }
  
  const customerExists = invoiceCustomerAutocompleteCache.some(customer => 
    customer.toLowerCase() === input.toLowerCase()
  );
  
  if (!customerExists) {
    btn.innerHTML = '💾';
    btn.style.background = '#28a745';
    btn.style.cursor = 'pointer';
    btn.disabled = false;
    btn.style.display = 'block';
  } else {
    btn.style.display = 'none';
  }
}


/**
 * Save new invoice customer from invoice field
 */
async function saveNewInvoiceCustomerFromInvoiceField() {
  const input = document.getElementById('invoiceCustomerName');
  const customerName = input.value.trim();
  const btn = document.getElementById('saveInvoiceCustomerInsideBtn');
  
  if (!customerName || customerName.length === 0) {
    return;
  }
  
  const user = window.auth.currentUser;
  
  if (!user) {
    console.log('No user authenticated');
    return;
  }
  
  const customerExists = invoiceCustomerAutocompleteCache.some(customer => 
    customer.toLowerCase() === customerName.toLowerCase()
  );
  
  if (customerExists) {
    if (btn) btn.style.display = 'none';
    return;
  }
  
  console.log('💾 Saving new invoice customer:', customerName);
  
  if (btn) {
    btn.innerHTML = '✅ Saved';
    btn.style.background = '#218838';
    btn.disabled = true;
  }
  
  try {
    const { collection, addDoc } = window.firebaseImports;
    
    const invoiceCustomersRef = collection(window.db, 'tenants', user.uid, 'invoiceCustomers');
    await addDoc(invoiceCustomersRef, {
      name: customerName,
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
      userId: user.uid
    });
    
    console.log('✅ Invoice customer saved successfully:', customerName);
    
    // Add to cache
    invoiceCustomerAutocompleteCache.push(customerName);
    invoiceCustomersCache.push(customerName);
    
  } catch (error) {
    console.error('❌ Error saving invoice customer:', error);
    
    if (btn) {
      btn.innerHTML = '❌ Error';
      btn.style.background = '#dc3545';
      
      setTimeout(() => {
        btn.innerHTML = '💾';
        btn.style.background = '#28a745';
        btn.disabled = false;
      }, 2000);
    }
  }
}


// Make functions global
window.showInvoiceCustomerSuggestions = showInvoiceCustomerSuggestions;
window.filterInvoiceCustomerSuggestions = filterInvoiceCustomerSuggestions;
window.renderInvoiceCustomerSuggestions = renderInvoiceCustomerSuggestions;
window.selectInvoiceCustomerSuggestion = selectInvoiceCustomerSuggestion;
window.hideInvoiceCustomerSuggestions = hideInvoiceCustomerSuggestions;
window.checkAndShowSaveInvoiceCustomerButton = checkAndShowSaveInvoiceCustomerButton;
window.saveNewInvoiceCustomerFromInvoiceField = saveNewInvoiceCustomerFromInvoiceField;



/**
 * ==========================================
 * QUICK ITEM MODAL - FUNCTIONS
 * ==========================================
 */

// Global array to store quick items
window.quickItemsList = [];

/**
 * Open Quick Item Modal
 */
function openQuickItemModal() {
  console.log('⚡ Opening Quick Item Modal');
  
  // Reset input field
  const input = document.getElementById('quickItemInput');
  if (input) {
    input.value = '';
    
    // Focus on input after modal opens
    setTimeout(() => input.focus(), 300);
  }
  
  // Show modal
  const modal = new bootstrap.Modal(document.getElementById('quickItemModal'));
  modal.show();
}

/**
 * Close Quick Item Modal
 */
function closeQuickItemModal() {
  console.log('✅ Closing Quick Item Modal');
  
  const modal = bootstrap.Modal.getInstance(document.getElementById('quickItemModal'));
  if (modal) {
    modal.hide();
  }
}

/**
 * Add item to quick items list
 */
function addQuickItemToList() {
  const input = document.getElementById('quickItemInput');
  const itemName = input?.value?.trim();
  
  if (!itemName) {
    input?.focus();
    return;
  }
  
  console.log('⚡ Adding quick item:', itemName);
  
  // Add to array
  window.quickItemsList.push(itemName);
  
  // Add product row to Record Purchase modal
  addPurchaseProductRow({ name: itemName, qty: '', price: '', unitType: 'Box' });
  
  // Update preview
  updateQuickItemPreview();
  
  // Clear input and focus
  input.value = '';
  input.focus();
  
  console.log('✅ Quick item added. Total items:', window.quickItemsList.length);
}
/**
 * Update quick item preview area
 * ✅ Shows latest items at the top (reverse chronological order)
 */
 function updateQuickItemPreview() {
  const preview = document.getElementById('quickItemPreview');
  const count = document.getElementById('quickItemCount');
  
  if (!preview) return;
  
  // Update count
  if (count) {
    count.textContent = window.quickItemsList.length;
  }
  
  // Update preview content
  if (window.quickItemsList.length === 0) {
    preview.innerHTML = `
      <div style="text-align: center; color: #999; padding: 20px;">
        <i class="bi bi-inbox" style="font-size: 2rem; display: block; margin-bottom: 8px;"></i>
        No items added yet
      </div>
    `;
  } else {
    let html = '';
    
    // ✅ REVERSE THE ORDER - Show latest items first
    const reversedList = [...window.quickItemsList].reverse();
    
    reversedList.forEach((item, displayIndex) => {
      // Calculate original index (for removal)
      const originalIndex = window.quickItemsList.length - 1 - displayIndex;
      
      // Display number (latest = highest number)
      const displayNumber = originalIndex + 1;
      
      html += `
        <div style="
          background: white;
          padding: 10px 12px;
          margin-bottom: 8px;
          border-radius: 6px;
          display: flex;
          justify-content: space-between;
          align-items: center;
          border: 1px solid #e0e0e0;
          box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        ">
          <div style="display: flex; align-items: center; gap: 8px;">
            <span style="
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              color: white;
              width: 24px;
              height: 24px;
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
              font-size: 11px;
              font-weight: bold;
            ">${displayNumber}</span>
            <span style="font-weight: 500; color: #333;">${escapeHtml(item)}</span>
          </div>
          <button 
            type="button" 
            class="btn btn-sm btn-outline-danger" 
            onclick="removeQuickItem(${originalIndex})"
            style="padding: 2px 8px; font-size: 12px;">
            <i class="bi bi-x"></i>
          </button>
        </div>
      `;
    });
    
    preview.innerHTML = html;
  }
  
  console.log('✅ Preview updated with', window.quickItemsList.length, 'items (latest first)');
}
/**
 * Remove item from quick items list
 * ✅ Correctly removes corresponding product row
 */
 function removeQuickItem(index) {
  console.log('🗑️ Removing quick item at index:', index);
  
  if (!confirm('Remove "' + window.quickItemsList[index] + '"?')) {
    return;
  }
  
  // Remove from array
  window.quickItemsList.splice(index, 1);
  
  // Update preview
  updateQuickItemPreview();
  
  // Also remove corresponding product row from Record Purchase modal
  // Rows are added in the same order as quickItemsList
  const productRows = document.querySelectorAll('.purchase-product-row');
  if (productRows[index]) {
    productRows[index].remove();
  }
  
  console.log('✅ Quick item removed. Remaining items:', window.quickItemsList.length);
}

/**
 * Clear all quick items
 */
function clearQuickItems() {
  if (window.quickItemsList.length === 0) {
    return;
  }
  
  if (!confirm('Clear all ' + window.quickItemsList.length + ' items?')) {
    return;
  }
  
  console.log('🗑️ Clearing all quick items');
  
  // Clear array
  window.quickItemsList = [];
  
  // Update preview
  updateQuickItemPreview();
  
  // Clear input
  const input = document.getElementById('quickItemInput');
  if (input) {
    input.value = '';
    input.focus();
  }
  
  console.log('✅ All quick items cleared');
}

/**
 * Reset quick items when Record Purchase modal opens
 */
function resetQuickItems() {
  window.quickItemsList = [];
  updateQuickItemPreview();
}

// Make functions globally accessible
window.openQuickItemModal = openQuickItemModal;
window.closeQuickItemModal = closeQuickItemModal;
window.addQuickItemToList = addQuickItemToList;
window.updateQuickItemPreview = updateQuickItemPreview;
window.removeQuickItem = removeQuickItem;
window.clearQuickItems = clearQuickItems;
window.resetQuickItems = resetQuickItems;

/**
 * ==========================================
 * AUTOFILL MODE - QTY/RATE SMART ENTRY
 * ==========================================
 */

// ✅ Initialize global state FIRST (run immediately)
(function() {
  if (!window.autofillMode) {
    window.autofillMode = {
      active: false,
      currentField: null,
      currentRow: null,
      isUserScrolling: false,
      scrollTimeout: null
    };
    console.log('✅ Autofill mode state initialized');
  }
})();

/**
 * Confirm autofill mode activation
 */
function confirmAutofillMode() {
  const rows = document.querySelectorAll('.purchase-product-row');
  
  if (rows.length === 0) {
    alert('⚠️ Please add some products first!');
    return;
  }
  
  if (confirm('Enable smart autofill mode?\n\nThis will help you quickly fill Qty and Rate fields with auto-focus and auto-scroll.')) {
    activateAutofillMode();
  }
}
/**
 * Hide inline buttons
 */
 function hideInlineButtons() {
  // Hide floating panel if exists
  const floatingPanel = document.getElementById('autofillInlineButtons');
  if (floatingPanel) {
    floatingPanel.remove();
  }
  
  // Hide inline buttons inside fields
  document.querySelectorAll('.inline-buttons-container').forEach(container => {
    container.style.display = 'none';
    container.innerHTML = '';
  });
}
/**
 * Show inline buttons INSIDE the input field
 * ✅ Single Enter button only (Skip merged into Enter)
 */
 function showInlineButtons(field) {
  if (!field) return;
  
  // Hide all other inline buttons first
  document.querySelectorAll('.inline-buttons-container').forEach(container => {
    container.style.display = 'none';
    container.innerHTML = '';
  });
  
  // Find the button container for this field
  const wrapper = field.closest('.input-field-wrapper');
  if (!wrapper) return;
  
  const buttonContainer = wrapper.querySelector('.inline-buttons-container');
  if (!buttonContainer) return;
  
  // Clear existing buttons
  buttonContainer.innerHTML = '';
  
  // Style the button container
  buttonContainer.style.cssText = `
    position: absolute;
    right: 4px;
    top: 50%;
    transform: translateY(-50%);
    display: flex;
    gap: 2px;
    z-index: 10;
  `;
  
  // ✅ Create SINGLE Enter button (handles both enter and skip)
  const enterBtn = document.createElement('button');
  enterBtn.type = 'button';
  enterBtn.className = 'btn btn-success btn-sm';
  enterBtn.innerHTML = '<i class="bi bi-arrow-right"></i>';
  enterBtn.title = 'Next field (Enter)';
  enterBtn.style.cssText = `
    padding: 2px 8px;
    font-size: 14px;
    border-radius: 4px;
    border: none;
    line-height: 1;
    min-width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
  `;
  enterBtn.onclick = (e) => {
    e.preventDefault();
    e.stopPropagation();
    autofillEnter(field);
  };
  
  buttonContainer.appendChild(enterBtn);
  buttonContainer.style.display = 'flex';
  
  console.log('✅ Single Enter button shown inside field');
}

/**
 * Scroll to field smoothly - CENTERS ENTIRE ROW
 * ✅ Scrolls to show the whole row, not just the field
 */
function scrollToField(field) {
  if (!field || (window.autofillMode && window.autofillMode.isUserScrolling)) {
    return;
  }
  
  const modalBody = document.querySelector('#recordPurchaseModal .modal-body');
  if (!modalBody) {
    console.warn('⚠️ Modal body not found for scrolling');
    return;
  }
  
  // ✅ Get the entire row instead of just field
  const row = field.closest('.purchase-product-row');
  const targetElement = row || field;
  
  // Get element position
  const elementRect = targetElement.getBoundingClientRect();
  const modalRect = modalBody.getBoundingClientRect();
  
  // ✅ Calculate scroll position to center the ROW
  const elementCenter = elementRect.top + (elementRect.height / 2);
  const modalCenter = modalRect.top + (modalRect.height / 2);
  const scrollOffset = elementCenter - modalCenter;
  
  const newScrollTop = modalBody.scrollTop + scrollOffset;
  
  // Smooth scroll
  modalBody.scrollTo({
    top: newScrollTop,
    behavior: 'smooth'
  });
  
  console.log('📜 Auto-scrolled to center row');
}

/**
 * Focus field while keeping keyboard open
 * ✅ FIXED: Shows buttons for newly focused field
 */
function focusFieldWithKeyboard(field) {
  if (!field) return;
  
  // Remove previous highlight
  document.querySelectorAll('[data-field="qty"], [data-field="rate"]').forEach(f => {
    f.style.border = '';
    f.style.boxShadow = '';
  });
  
  // Scroll to field first
  scrollToField(field);
  
  // Focus without delay to prevent keyboard close
  field.focus();
  
  // Force keyboard to stay open (for mobile)
  field.click();
  
  // Highlight field
  field.style.border = '2px solid #4CAF50';
  field.style.boxShadow = '0 0 10px rgba(76, 175, 80, 0.5)';
  
  // ✅ SHOW BUTTONS FOR NEW FIELD (critical fix)
  setTimeout(() => {
    showInlineButtons(field);
  }, 50);
  
  console.log('🎯 Field focused with keyboard and buttons');
}

/**
 * Show completion toast notification
 * ✅ Better UX than alert dialog
 */
function showAutofillCompleteToast() {
  // Create toast element
  const toast = document.createElement('div');
  toast.id = 'autofillCompleteToast';
  toast.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    z-index: 10000;
    background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
    color: white;
    padding: 20px 40px;
    border-radius: 20px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
    font-size: 16px;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 12px;
    animation: fadeInOut 1s ease-in-out;
  `;
  
  toast.innerHTML = `
    <i class="bi bi-check-circle-fill" style="font-size: 24px;"></i>
    <span>All fields filled! ✅</span>
  `;
  
  // Add animation
  const style = document.createElement('style');
  style.textContent = `
    @keyframes fadeInOut {
      0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
      20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
      80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
      100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
    }
  `;
  document.head.appendChild(style);
  
  document.body.appendChild(toast);
  
  // Remove after animation
  setTimeout(() => {
    toast.remove();
    style.remove();
  }, 1000);
  
  console.log('✅ Toast notification shown');
}

/**
 * Exit autofill mode silently (no confirmation)
 * ✅ Used for auto-exit scenarios
 */
 function exitAutofillModeSilently() {
  console.log('🚪 Silently exiting autofill mode');
  
  if (!window.autofillMode) return;
  
  window.autofillMode.active = false;
  window.autofillMode.isUserScrolling = false;
  window.autofillMode.currentField = null;
  
  // Hide control panel
  const panel = document.getElementById('autofillControlPanel');
  if (panel) {
    panel.style.display = 'none';
  }
  
  // Hide inline buttons
  hideInlineButtons();
  
  // Remove field highlights
  document.querySelectorAll('[data-field="qty"], [data-field="rate"]').forEach(field => {
    field.style.border = '';
    field.style.boxShadow = '';
    field.removeAttribute('data-autofill-enabled');
  });
  
  // Remove scroll listener
  const modalBody = document.querySelector('#recordPurchaseModal .modal-body');
  if (modalBody) {
    modalBody.removeEventListener('scroll', handleManualScroll);
  }
  
  console.log('✅ Autofill mode exited silently');
}

/**
 * Focus next empty qty or rate field
 * ✅ FIXED: Properly tracks and skips to NEXT field
 * ✅ AUTO-EXITS when all fields are filled
 */
function focusNextEmptyField(skipCurrent = false) {
  if (!window.autofillMode || !window.autofillMode.active) {
    console.log('⚠️ Autofill mode not active');
    return;
  }
  
  const rows = Array.from(document.querySelectorAll('.purchase-product-row'));
  let allFields = [];
  
  // Collect all qty and rate fields
  rows.forEach(row => {
    const qtyField = row.querySelector('[data-field="qty"]');
    const rateField = row.querySelector('[data-field="rate"]');
    if (qtyField) allFields.push(qtyField);
    if (rateField) allFields.push(rateField);
  });
  
  console.log(`🔍 Checking ${allFields.length} fields for empty values`);
  
  // ✅ Find current field index
  let startIndex = 0;
  if (skipCurrent && window.autofillMode.currentField) {
    startIndex = allFields.indexOf(window.autofillMode.currentField) + 1;
    console.log(`⏭️ Skipping from index ${startIndex - 1} to ${startIndex}`);
  }
  
  // Find first empty field AFTER current index
  let targetField = null;
  for (let i = startIndex; i < allFields.length; i++) {
    const field = allFields[i];
    if (!field.value || field.value.trim() === '' || field.value === '0') {
      targetField = field;
      break;
    }
  }
  
  if (targetField) {
    window.autofillMode.currentField = targetField;
    
    // Focus and scroll WITHOUT closing keyboard
    focusFieldWithKeyboard(targetField);
    
    console.log('🎯 Focused on next empty field');
  } else {
    // ✅ AUTO-EXIT: No more empty fields - exit silently
    console.log('✅ All fields filled - auto-exiting autofill mode');
    
    // Show success toast notification instead of alert
    showAutofillCompleteToast();
    
    // Auto-exit after 1 second
    setTimeout(() => {
      exitAutofillModeSilently();
    }, 1000);
  }
}
/**
 * Handle Enter button click or keyboard Enter key
 * ✅ Works for both filled and empty fields
 * ✅ Moves to next empty field
 */
 function autofillEnter(currentField) {
  console.log('✅ Enter action triggered');
  
  // Calculate row amount if field has value
  if (currentField.value && currentField.value.trim() !== '' && currentField.value !== '0') {
    const row = currentField.closest('.purchase-product-row');
    if (row) {
      calculatePurchaseRowAmount(row.id);
    }
    console.log('💰 Row amount calculated');
  } else {
    console.log('⏭️ Empty field - skipping');
  }
  
  // Set current field in autofill state
  if (window.autofillMode && window.autofillMode.active) {
    window.autofillMode.currentField = currentField;
  }
  
  // Move to next empty field
  focusNextEmptyField(true);
}

/**
 * Handle Skip button click
 * ✅ Keeps buttons visible on next field
 */
function autofillSkip(currentField) {
  console.log('⏭️ Skip pressed');
  
  // Set current field
  window.autofillMode.currentField = currentField;
  
  // Move to next field (skip current)
  focusNextEmptyField(true);
}

/**
 * Add inline Enter/Skip buttons to qty and rate fields
 * ✅ Buttons appear for focused field
 * ✅ Better event handling
 */
function addAutofillButtons() {
  const rows = document.querySelectorAll('.purchase-product-row');
  
  console.log(`📝 Adding autofill handlers to ${rows.length} rows`);
  
  rows.forEach((row, index) => {
    const qtyField = row.querySelector('[data-field="qty"]');
    const rateField = row.querySelector('[data-field="rate"]');
    
    [qtyField, rateField].forEach(field => {
      if (!field) return;
      
      // Skip if already has handler
      if (field.getAttribute('data-autofill-enabled') === 'true') {
        return;
      }
      
      // Mark field as autofill-enabled
      field.setAttribute('data-autofill-enabled', 'true');
      
      // ✅ Add focus handler to show buttons
      field.addEventListener('focus', function(e) {
        if (window.autofillMode && window.autofillMode.active) {
          console.log('🎯 Field focused, showing buttons');
          setTimeout(() => {
            showInlineButtons(this);
          }, 100);
        }
      }, { passive: true });
      
      // ✅ Add input handler to keep buttons visible
      field.addEventListener('input', function(e) {
        if (window.autofillMode && window.autofillMode.active) {
          // Keep buttons visible while typing
          if (!document.getElementById('autofillInlineButtons')) {
            showInlineButtons(this);
          }
        }
      }, { passive: true });
      
      // Add click handler to re-enable autofocus
      field.addEventListener('click', function(e) {
        if (window.autofillMode && window.autofillMode.active) {
          if (window.autofillMode.isUserScrolling) {
            window.autofillMode.isUserScrolling = false;
            console.log('🎯 Re-enabled autofocus via field click');
          }
          window.autofillMode.currentField = this;
        }
      }, { passive: true });
    });
  });
  
  console.log('✅ Autofill handlers added');
}

/**
 * Handle manual scrolling
 */
function handleManualScroll() {
  if (!window.autofillMode || !window.autofillMode.active) return;
  
  // Detect manual scroll
  clearTimeout(window.autofillMode.scrollTimeout);
  
  window.autofillMode.scrollTimeout = setTimeout(() => {
    window.autofillMode.isUserScrolling = true;
    console.log('👆 Manual scroll detected - autofocus disabled');
  }, 100);
}
/**
 * Activate autofill mode
 */
 function activateAutofillMode() {
  console.log('⚡ Activating autofill mode');
  
  // ✅ Ensure global state exists
  if (!window.autofillMode) {
    window.autofillMode = {
      active: false,
      currentField: null,
      currentRow: null,
      isUserScrolling: false,
      scrollTimeout: null
    };
  }
  
  window.autofillMode.active = true;
  window.autofillMode.isUserScrolling = false;
  
  // ✅ Show control panel
  const panel = document.getElementById('autofillControlPanel');
  if (panel) {
    panel.style.display = 'flex';
  }
  
  // Add event handlers to all qty/rate fields
  addAutofillButtons();
  
  // Focus first empty field (with delay for rendering)
  setTimeout(() => {
    focusNextEmptyField(false);
  }, 150);
  
  // Track manual scrolling
  const modalBody = document.querySelector('#recordPurchaseModal .modal-body');
  if (modalBody) {
    modalBody.addEventListener('scroll', handleManualScroll);
  }
  
  console.log('✅ Autofill mode activated');
}


/**
 * Recentre - resume autofocus
 */
function recentreAutofill() {
  console.log('🎯 Recentring autofill');
  
  if (!window.autofillMode) return;
  
  window.autofillMode.isUserScrolling = false;
  
  // Focus current or next empty field
  if (window.autofillMode.currentField) {
    scrollToField(window.autofillMode.currentField);
    window.autofillMode.currentField.focus();
    showInlineButtons(window.autofillMode.currentField);
  } else {
    focusNextEmptyField(false);
  }
}

/**
 * Exit autofill mode WITH CONFIRMATION
 * ✅ Used when user clicks Exit button manually
 */
function exitAutofillMode() {
  console.log('🚪 Exiting autofill mode (with confirmation)');
  
  if (!confirm('Exit autofill mode?')) {
    return;
  }
  
  // Use silent exit after confirmation
  exitAutofillModeSilently();
}

// ✅ Make functions globally accessible
window.confirmAutofillMode = confirmAutofillMode;
window.activateAutofillMode = activateAutofillMode;
window.addAutofillButtons = addAutofillButtons;
window.autofillEnter = autofillEnter;
// ❌ REMOVED: window.autofillSkip
window.focusNextEmptyField = focusNextEmptyField;
window.focusFieldWithKeyboard = focusFieldWithKeyboard;
window.scrollToField = scrollToField;
window.handleManualScroll = handleManualScroll;
window.recentreAutofill = recentreAutofill;
window.exitAutofillMode = exitAutofillMode;
window.exitAutofillModeSilently = exitAutofillModeSilently;
window.showAutofillCompleteToast = showAutofillCompleteToast;
window.showInlineButtons = showInlineButtons;
window.hideInlineButtons = hideInlineButtons;

/**
 * ==========================================
 * 🔧 ADD PRODUCT MODAL SETTINGS
 * ==========================================
 */



/**
 * Load settings from Firestore
 */
async function loadAddProductModalSettings() {
  try {
    const user = window.auth?.currentUser;
    if (!user) return;
    
    const { doc, getDoc } = window.firebaseImports;
    const userId = user.uid;
    
    const settingsRef = doc(window.db, 'tenants', userId, 'settings', 'addProductModal');
    const settingsDoc = await getDoc(settingsRef);
    
    if (settingsDoc.exists()) {
      addProductModalSettings = settingsDoc.data();
      console.log('✅ Loaded Add Product Modal settings:', addProductModalSettings);
    } else {
      console.log('ℹ️ No settings found, using defaults');
    }
    
    // Apply settings
    applyAddProductModalSettings();
    
  } catch (error) {
    console.error('❌ Error loading settings:', error);
  }
}

/**
 * Save settings to Firestore
 */
async function saveAddProductModalSettingsToFirestore() {
  try {
    const user = window.auth?.currentUser;
    if (!user) {
      console.error('❌ No user signed in');
      return false;
    }
    
    const { doc, setDoc } = window.firebaseImports;
    const userId = user.uid;
    
    const settingsRef = doc(window.db, 'tenants', userId, 'settings', 'addProductModal');
    
    await setDoc(settingsRef, {
      ...addProductModalSettings,
      updatedAt: new Date().toISOString()
    });
    
    console.log('✅ Settings saved to Firestore:', addProductModalSettings);
    return true;
    
  } catch (error) {
    console.error('❌ Error saving settings:', error);
    return false;
  }
}

/**
 * Apply settings to modal
 */
function applyAddProductModalSettings() {
  console.log('🎨 Applying Add Product Modal settings...');
  
  // Category
  const categoryContainer = document.querySelector('[data-field="category"]');
  if (categoryContainer) {
    categoryContainer.style.display = addProductModalSettings.showCategory ? '' : 'none';
  }
  
  // Unit Type
  const unitTypeContainer = document.querySelector('[data-field="unitType"]');
  if (unitTypeContainer) {
    unitTypeContainer.style.display = addProductModalSettings.showUnitType ? '' : 'none';
  }
  
  // Selling Price
  const priceContainer = document.querySelector('[data-field="sellingPrice"]');
  if (priceContainer) {
    priceContainer.style.display = addProductModalSettings.showSellingPrice ? '' : 'none';
  }
  
  // Brand
  const brandContainer = document.querySelector('[data-field="brand"]');
  if (brandContainer) {
    brandContainer.style.display = addProductModalSettings.showBrand ? '' : 'none';
  }
  
  // Size
  const sizeContainer = document.querySelector('[data-field="size"]');
  if (sizeContainer) {
    sizeContainer.style.display = addProductModalSettings.showSize ? '' : 'none';
  }
  
  // Pieces per Box
  const piecesContainer = document.querySelector('[data-field="piecesPerBox"]');
  if (piecesContainer) {
    piecesContainer.style.display = addProductModalSettings.showPiecesPerBox ? '' : 'none';
  }
  
  // SFT per Box
  const sftContainer = document.querySelector('[data-field="sftPerBox"]');
  if (sftContainer) {
    sftContainer.style.display = addProductModalSettings.showSftPerBox ? '' : 'none';
  }
  
  // Adjust column sizes dynamically
  adjustProductModalColumns();
  
  console.log('✅ Settings applied');
}

/**
 * Adjust column sizes based on visible fields
 */
function adjustProductModalColumns() {
  // First row: Product Name + Category
  const productNameContainer = document.getElementById('productNameContainer');
  const categoryContainer = document.querySelector('[data-field="category"]');
  
  if (productNameContainer && categoryContainer) {
    if (addProductModalSettings.showCategory) {
      productNameContainer.className = 'col-md-8';
      categoryContainer.className = 'col-md-4';
    } else {
      productNameContainer.className = 'col-md-12';
    }
  }
  
  // Second row: Unit Type, Price, Stock
  const unitTypeContainer = document.querySelector('[data-field="unitType"]');
  const priceContainer = document.querySelector('[data-field="sellingPrice"]');
  const stockContainer = document.getElementById('stockContainer');
  
  let visibleCount = 0;
  if (addProductModalSettings.showUnitType) visibleCount++;
  if (addProductModalSettings.showSellingPrice) visibleCount++;
  visibleCount++; // Stock is always visible
  
  const colClass = visibleCount === 1 ? 'col-md-12' : visibleCount === 2 ? 'col-md-6' : 'col-md-4';
  
  if (unitTypeContainer) unitTypeContainer.className = addProductModalSettings.showUnitType ? colClass : 'col-md-4 d-none';
  if (priceContainer) priceContainer.className = addProductModalSettings.showSellingPrice ? colClass : 'col-md-4 d-none';
  if (stockContainer) stockContainer.className = colClass;
  
  // Advanced options: Brand & Size
  const brandContainer = document.querySelector('[data-field="brand"]');
  const sizeContainer = document.querySelector('[data-field="size"]');
  
  if (brandContainer && sizeContainer) {
    const showBrand = addProductModalSettings.showBrand;
    const showSize = addProductModalSettings.showSize;
    
    if (showBrand && showSize) {
      brandContainer.className = 'col-md-6';
      sizeContainer.className = 'col-md-6';
    } else if (showBrand && !showSize) {
      brandContainer.className = 'col-md-12';
    } else if (!showBrand && showSize) {
      sizeContainer.className = 'col-md-12';
    }
  }
  
  // Pieces per Box & SFT per Box
  const piecesContainer = document.querySelector('[data-field="piecesPerBox"]');
  const sftContainer = document.querySelector('[data-field="sftPerBox"]');
  
  if (piecesContainer && sftContainer) {
    const showPieces = addProductModalSettings.showPiecesPerBox;
    const showSft = addProductModalSettings.showSftPerBox;
    
    if (showPieces && showSft) {
      piecesContainer.className = 'col-md-6';
      sftContainer.className = 'col-md-6';
    } else if (showPieces && !showSft) {
      piecesContainer.className = 'col-md-12';
    } else if (!showPieces && showSft) {
      sftContainer.className = 'col-md-12';
    }
  }
}

/**
 * Open settings modal
 */
function openSettingsModal() {
  console.log('🔧 Opening settings modal');
  new bootstrap.Modal(document.getElementById('settingsModal')).show();
}

/**
 * Open Add Product Modal Settings
 */
 function openAddProductModalSettings() {
  console.log('📦 Opening Add Product Modal Settings');
  
  // Check if modal exists
  const modal = document.getElementById('addProductModalSettingsModal');
  if (!modal) {
    console.error('❌ Modal not found!');
    alert('Settings modal not found. Please refresh the page.');
    return;
  }
  
  // ✅ Load current settings into checkboxes (NO name attribute issues)
  const checkboxes = {
    showCategoryField: document.getElementById('showCategoryField'),
    showUnitTypeField: document.getElementById('showUnitTypeField'),
    showSellingPriceField: document.getElementById('showSellingPriceField'),
    showBrandField: document.getElementById('showBrandField'),
    showSizeField: document.getElementById('showSizeField'),
    showPiecesPerBoxField: document.getElementById('showPiecesPerBoxField'),
    showSftPerBoxField: document.getElementById('showSftPerBoxField')
  };
  
  // Check if all checkboxes exist
  const missingCheckboxes = Object.keys(checkboxes).filter(key => !checkboxes[key]);
  if (missingCheckboxes.length > 0) {
    console.error('❌ Missing checkboxes:', missingCheckboxes);
    alert('Some settings are missing. Please refresh.');
    return;
  }
  
  // ✅ Set checkbox states (multiple can be true)
  checkboxes.showCategoryField.checked = addProductModalSettings.showCategory !== false;
  checkboxes.showUnitTypeField.checked = addProductModalSettings.showUnitType !== false;
  checkboxes.showSellingPriceField.checked = addProductModalSettings.showSellingPrice !== false;
  checkboxes.showBrandField.checked = addProductModalSettings.showBrand !== false;
  checkboxes.showSizeField.checked = addProductModalSettings.showSize !== false;
  checkboxes.showPiecesPerBoxField.checked = addProductModalSettings.showPiecesPerBox !== false;
  checkboxes.showSftPerBoxField.checked = addProductModalSettings.showSftPerBox !== false;
  
  console.log('✅ Loaded settings:', addProductModalSettings);
  console.log('✅ Checkbox states:', {
    category: checkboxes.showCategoryField.checked,
    unitType: checkboxes.showUnitTypeField.checked,
    price: checkboxes.showSellingPriceField.checked,
    brand: checkboxes.showBrandField.checked,
    size: checkboxes.showSizeField.checked,
    pieces: checkboxes.showPiecesPerBoxField.checked,
    sft: checkboxes.showSftPerBoxField.checked
  });
  
  // Show modal
  new bootstrap.Modal(modal).show();
  console.log('✅ Modal opened');
}

// Ensure it's global
window.openAddProductModalSettings = openAddProductModalSettings;


/**
 * Save Add Product Modal Settings
 */
async function saveAddProductModalSettings() {
  const lang = window.currentLanguage || 'en';
  const translations = window.translations[lang];
  
  console.log('💾 Saving Add Product Modal settings...');
  
  // Get checkbox values
  addProductModalSettings = {
    showCategory: document.getElementById('showCategoryField').checked,
    showUnitType: document.getElementById('showUnitTypeField').checked,
    showSellingPrice: document.getElementById('showSellingPriceField').checked,
    showBrand: document.getElementById('showBrandField').checked,
    showSize: document.getElementById('showSizeField').checked,
    showPiecesPerBox: document.getElementById('showPiecesPerBoxField').checked,
    showSftPerBox: document.getElementById('showSftPerBoxField').checked
  };
  
  console.log('📝 New settings:', addProductModalSettings);
  
  // Save to Firestore
  const success = await saveAddProductModalSettingsToFirestore();
  
  if (success) {
    // Apply settings immediately
    applyAddProductModalSettings();
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('addProductModalSettingsModal'));
    if (modal) modal.hide();
    
    // Show success message
    if (typeof showSyncIndicator === 'function') {
      showSyncIndicator(translations.settingsSaved || 'Settings saved', 1500);
    } else {
      alert(translations.settingsSaved || '✅ Settings saved successfully!');
    }
  } else {
    alert(translations.settingsSaveFailed || '❌ Failed to save settings. Please try again.');
  }
}

/**
 * Initialize settings on page load
 */
window.addEventListener('DOMContentLoaded', () => {
  // Load settings after auth is ready
  if (window.auth?.currentUser) {
    loadAddProductModalSettings();
  }
});

// Make functions global
window.openSettingsModal = openSettingsModal;
window.openAddProductModalSettings = openAddProductModalSettings;
window.saveAddProductModalSettings = saveAddProductModalSettings;
window.applyAddProductModalSettings = applyAddProductModalSettings;

console.log('✅ Add Product Modal Settings functions loaded');


  </script>
<!-- ✅ RESET DATA MODAL - Password Verification ONLY -->
<div class="modal fade" id="resetDataModal" tabindex="-1" aria-labelledby="resetDataModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius: 15px; border: none; box-shadow: 0 10px 40px rgba(220, 53, 69, 0.3);">
      
      <!-- Modal Header -->
      <div class="modal-header" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; border-radius: 15px 15px 0 0; border: none;">
        <h5 class="modal-title" id="resetDataModalLabel">
          <i class="bi bi-exclamation-triangle-fill me-2"></i>
          Reset All Data
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" onclick="clearResetDataModal()"></button>
      </div>
      
      <!-- Modal Body -->
      <div class="modal-body" style="padding: 30px;">
        
        <!-- Warning Message -->
        <div class="alert alert-danger d-flex align-items-center mb-4" role="alert" style="border-radius: 10px; border-left: 4px solid #dc3545;">
          <i class="bi bi-exclamation-octagon-fill me-3" style="font-size: 2rem;"></i>
          <div>
            <strong>⚠️ WARNING: This action cannot be undone!</strong>
            <p class="mb-0 mt-2" style="font-size: 0.9rem;">All your inventory data will be permanently deleted:</p>
            <ul class="mb-0 mt-2" style="font-size: 0.85rem;">
              <li>Products & Stock</li>
              <li>Groups & Brands</li>
              <li>Customers & Sales</li>
              <li>Invoices & Records</li>
            </ul>
          </div>
        </div>
        
        <!-- Password Verification -->
        <div class="mb-3">
          <label for="resetDataPassword" class="form-label" style="font-weight: 600; color: #333;">
            <i class="bi bi-key me-2"></i>Enter your password to confirm:
          </label>
          <input type="password" 
                 class="form-control" 
                 id="resetDataPassword" 
                 placeholder="Your current password"
                 style="border-radius: 10px; padding: 12px; border: 2px solid #dee2e6;"
                 onkeypress="if(event.key === 'Enter') confirmResetData();"
                 required>
          <small id="resetPasswordError" class="text-danger" style="display: none; margin-top: 8px;"></small>
        </div>
        
      </div>
      
      <!-- Modal Footer -->
      <div class="modal-footer" style="border: none; padding: 20px 30px;">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="clearResetDataModal()" style="border-radius: 10px; padding: 10px 24px;">
          <i class="bi bi-x-circle me-2"></i>Cancel
        </button>
        <button type="button" 
                class="btn btn-danger" 
                id="confirmResetButton"
                onclick="confirmResetData()" 
                style="border-radius: 10px; padding: 10px 24px; font-weight: 600;">
          <i class="bi bi-trash3 me-2"></i>Reset All Data
        </button>
      </div>
      
    </div>
  </div>
</div>

<!-- ✅ RESET DATA SUCCESS MODAL -->
<div class="modal fade" id="resetDataSuccessModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius: 15px; border: none;">
      <div class="modal-body text-center" style="padding: 40px;">
        <i class="bi bi-check-circle-fill" style="font-size: 4rem; color: #198754;"></i>
        <h4 class="mt-3 mb-3" style="color: #198754; font-weight: 600;">Data Reset Complete!</h4>
        <p class="text-muted mb-4">All your data has been cleared. You can start fresh now.</p>
        <button type="button" class="btn btn-success" data-bs-dismiss="modal" style="border-radius: 10px; padding: 10px 30px;">
          <i class="bi bi-check2 me-2"></i>Got it
        </button>
      </div>
    </div>
  </div>
</div>


<!-- ✅ Change Password Modal - WITH TRANSLATION -->
<div id="changePasswordModal" class="modal fade" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header" style="background: linear-gradient(135deg, #25D366 0%, #1FAD5D 100%); color: white;">
        <h5 class="modal-title">
          <i class="bi bi-key me-2"></i><span data-i18n="changePassword">Change Password</span>
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <!-- Step 1: Verify Current Password -->
        <div id="verifyPasswordStep">
          <p class="text-muted" data-i18n="enterCurrentPasswordToContinue">Enter your current password to continue</p>
          <div class="mb-3">
            <label class="form-label" data-i18n="currentPassword">Current Password</label>
            <input 
              type="password" 
              id="currentPasswordInput" 
              class="form-control" 
              data-i18n-placeholder="enterCurrentPassword"
              placeholder="Enter current password"
              style="padding: 12px; font-size: 15px;"
              required
            >
          </div>
          <div class="d-grid">
            <button class="btn btn-primary" onclick="verifyCurrentPassword()" style="padding: 12px; font-weight: 600;">
              <span data-i18n="continue">Continue</span>
            </button>
          </div>
        </div>
        
        <!-- Step 2: Enter New Password -->
        <div id="newPasswordStep" style="display: none;">
          <p class="text-muted" data-i18n="chooseNewPassword">Choose a new password (minimum 6 characters)</p>
          <div class="mb-3">
            <label class="form-label" data-i18n="newPassword">New Password</label>
            <input 
              type="password" 
              id="newPasswordInput" 
              class="form-control" 
              data-i18n-placeholder="enterNewPassword"
              placeholder="Enter new password"
              style="padding: 12px; font-size: 15px;"
              minlength="6"
              required
            >
          </div>
          <div class="mb-3">
            <label class="form-label" data-i18n="confirmNewPassword">Confirm New Password</label>
            <input 
              type="password" 
              id="confirmPasswordInput" 
              class="form-control" 
              data-i18n-placeholder="reEnterNewPassword"
              placeholder="Re-enter new password"
              style="padding: 12px; font-size: 15px;"
              minlength="6"
              required
            >
          </div>
          <div class="d-grid">
            <button class="btn btn-success" onclick="submitNewPassword()" style="padding: 12px; font-weight: 600;">
              <i class="bi bi-check-circle me-2"></i><span data-i18n="changePassword">Change Password</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>





<!-- âœ… NEW: WhatsApp Number Input Modal -->
<div class="modal fade" id="whatsappNumberModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">
          <i class="bi bi-whatsapp"></i> Share Invoice on WhatsApp
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <i class="bi bi-info-circle"></i> Enter the recipient's WhatsApp number (with country code)
        </div>
        
        <div class="mb-3">
          <label class="form-label">WhatsApp Number</label>
          <div class="input-group">
            <span class="input-group-text">+91</span>
            <input type="tel" 
                   class="form-control" 
                   id="whatsappNumberInput" 
                   placeholder="9876543210" 
                   maxlength="10"
                   pattern="[0-9]{10}"
                   required>
          </div>
          <small class="text-muted">Enter 10-digit mobile number (without +91)</small>
        </div>
        
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="saveWhatsAppNumber">
          <label class="form-check-label" for="saveWhatsAppNumber">
            Remember this number for next time
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-success" onclick="sendInvoiceToWhatsApp()">
          <i class="bi bi-whatsapp"></i> Send to WhatsApp
        </button>
      </div>
    </div>
  </div>
</div>


<!-- ✅ Product Detail Modal -->
<div class="modal fade" id="productDetailModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <i class="bi bi-info-circle"></i> Product Details
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="productDetailModalBody">
        <!-- Content will be injected dynamically -->
        <div style="text-align: center; padding: 40px;">
          <div class="spinner-border text-primary"></div>
          <p class="mt-3">Loading...</p>
        </div>
      </div>
    </div>
  </div>
</div>





<!-- BULK MODAL FOR INVOICE -->
<div class="modal fade" id="bulkAddModal" tabindex="-1" backdrop="static">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title">
          <i class="bi bi-collection"></i> Add Items in Bulk - Invoice
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      
      <div class="modal-body">
        <input type="text" class="form-control mb-3" id="bulkSearchInput" 
               placeholder="Type to search products..."
               oninput="filterBulkProducts(this.value)">
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-height: 400px;">
          <div>
            <h6 class="border-bottom pb-2"><i class="bi bi-box"></i> Products</h6>
            <div id="bulkProductsList" style="overflow-y: auto; max-height: 350px; border: 1px solid #ddd; border-radius: 4px; background: white;"></div>
          </div>
          <div>
            <h6 class="border-bottom pb-2">
              <i class="bi bi-check-circle"></i> Selected 
              <span class="badge bg-info" id="bulkSelectedCount">0</span>
            </h6>
            <div style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">
              Total Qty: <strong id="bulkTotalQty">0</strong>
            </div>
            <div id="bulkSelectedItems" style="overflow-y: auto; max-height: 320px; border: 1px solid #ddd; border-radius: 4px; background: #f9f9f9;"></div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-info" onclick="addBulkProductsToInvoice()">
          <i class="bi bi-plus-circle"></i> Add Items
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ✅ INSTANT PRODUCTS MODAL - COMPACT WITH FLOATING CLOSE BUTTON -->
<div class="modal fade" id="instantProductsModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="position: relative;">
      
     <!-- ✅ CUSTOM CLOSE BUTTON WITH ICON -->
<button 
type="button" 
data-bs-dismiss="modal" 
aria-label="Close"
style="
  position: absolute;
  top: 10px;
  right: 10px;
  z-index: 1055;
  background: #dc3545;
  border: none;
  border-radius: 50%;
  width: 34px;
  height: 34px;
  padding: 0;
  box-shadow: 0 2px 8px rgba(220, 53, 69, 0.4);
  color: white;
  font-size: 20px;
  font-weight: 700;
  line-height: 34px;
  text-align: center;
  cursor: pointer;
  transition: all 0.2s ease;
"
onmouseover="this.style.background='#c82333'; this.style.transform='scale(1.1)'; this.style.boxShadow='0 4px 12px rgba(220, 53, 69, 0.5)'"
onmouseout="this.style.background='#dc3545'; this.style.transform='scale(1)'; this.style.boxShadow='0 2px 8px rgba(220, 53, 69, 0.4)'">
×
</button>

      
      <!-- ✅ NO MODAL HEADER -->
      
      <div class="modal-body" style="padding: 20px 20px 10px 20px;">
        
        <!-- ✅ Mode Toggle Buttons - AT THE TOP -->
        <div class="btn-group w-100 mb-3" role="group">
          <button 
            type="button" 
            id="productNameModeBtn"
            class="btn btn-outline-success active" 
            onclick="switchInstantProductMode('product')"
            style="font-size: 15px; font-weight: 600; padding: 12px;">
            <i class="bi bi-tag"></i> <span data-i18n="productNames">Product Names</span>
          </button>
          <button 
            type="button" 
            id="stockModeBtn"
            class="btn btn-outline-success" 
            onclick="switchInstantProductMode('stock')"
            style="font-size: 15px; font-weight: 600; padding: 12px;">
            <i class="bi bi-box-seam"></i> <span data-i18n="stockEntry">Stock Entry</span>
          </button>
        </div>
        
        <!-- Input Field Container -->
        <div style="position: relative; margin-bottom: 12px;">
          <input 
            id="instantProductInput" 
            type="text" 
            class="form-control form-control-lg mb-2" 
            data-i18n-placeholder="instantProductPlaceholder"
            placeholder="e.g., Tilecleaner, Grout, Adhesive..."
            onkeydown="handleInstantProductInputKeydown(event)"
            oninput="handleInstantProductInput(event)"
            autocomplete="off"
            style="padding: 14px 48px 14px 14px; font-size: 16px;">
          
          <!-- Skip Button (Hidden by default) -->
          <button 
            id="skipStockBtn"
            type="button"
            class="btn btn-sm btn-warning"
            onmousedown="event.preventDefault(); skipCurrentProduct();"
            style="position: absolute; right: 10px; top: 10px; display: none; z-index: 10; font-weight: 600; padding: 8px 12px; font-size: 13px;">
            <i class="bi bi-skip-forward"></i> <span data-i18n="skip">Skip</span>
          </button>
        </div>
        
        <!-- Add to List Button -->
        <button 
          type="button"
          id="addToListBtn"
          class="btn btn-success w-100"
          onmousedown="event.preventDefault(); handleAddToListClick();"
          style="padding: 12px; font-size: 17px; font-weight: 600; margin-bottom: 16px;">
          <i class="bi bi-plus-lg"></i> <span data-i18n="addToList">Add to List</span>
        </button>
        
        <!-- Preview Header -->
        <p style="font-weight: 600; margin-bottom: 12px; font-size: 16px; color: #333;" id="instantProductPreviewCount">
          <span data-i18n="productsToSave">📝 Products to Save</span> (<span id="productCount">0</span>):
        </p>
        
        <!-- Preview List Container -->
        <div id="instantProductPreviewList" style="background: #f8f9fa; border: 1px solid #e0e0e0; border-radius: 10px; max-height: 400px; overflow-y: auto; min-height: 150px; padding: 14px; padding-bottom: 60px;">
          <div style="padding: 15px; color: #999; text-align: center; font-size: 14px;" data-i18n="noProductsAddedYet">
            No products added yet
          </div>
        </div>
        
      </div>
      
      <div class="modal-footer">
        <button 
          type="button" 
          class="btn btn-secondary" 
          onclick="cancelInstantProducts()">
          <i class="bi bi-x-circle me-1"></i><span data-i18n="cancel">Cancel</span>
        </button>
        <button 
          type="button" 
          class="btn btn-success" 
          onclick="saveAllInstantProducts()">
          <i class="bi bi-check-circle me-1"></i><span data-i18n="saveAll">Save All</span>
        </button>
      </div>
      
    </div>
  </div>
</div>











  

<!-- BULK MODAL FOR SALE -->
<div class="modal fade" id="bulkAddModalForSale" tabindex="-1" backdrop="static">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <i class="bi bi-collection"></i> Add Items in Bulk - Sale
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      
      <div class="modal-body">
        <input type="text" class="form-control mb-3" id="bulkSearchInputSale" 
               placeholder="Type to search products..."
               oninput="filterBulkProductsSale(this.value)">
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-height: 400px;">
          <div>
            <h6 class="border-bottom pb-2"><i class="bi bi-box"></i> Products</h6>
            <div id="bulkProductsListSale" style="overflow-y: auto; max-height: 350px; border: 1px solid #ddd; border-radius: 4px; background: white;"></div>
          </div>
          <div>
            <h6 class="border-bottom pb-2">
              <i class="bi bi-check-circle"></i> Selected 
              <span class="badge bg-primary" id="bulkSelectedCountSale">0</span>
            </h6>
            <div style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">
              Total Qty: <strong id="bulkTotalQtySale">0</strong>
            </div>
            <div id="bulkSelectedItemsSale" style="overflow-y: auto; max-height: 320px; border: 1px solid #ddd; border-radius: 4px; background: #f9f9f9;"></div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="addBulkProductsToSale()">
          <i class="bi bi-plus-circle"></i> Add Items
        </button>
      </div>
    </div>
  </div>
</div>



  

<!-- BULK MODAL -->
<div class="modal fade" id="bulkAddModalForPurchase" tabindex="-1" backdrop="static">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">
          <i class="bi bi-collection"></i> Add Items in Bulk
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      
      <div class="modal-body">
        <input type="text" class="form-control mb-3" id="bulkSearchInputPurchase" 
               placeholder="Type to search products..."
               oninput="filterBulkProductsPurchase(this.value)">
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-height: 400px;">
          <div>
            <h6 class="border-bottom pb-2"><i class="bi bi-box"></i> Products</h6>
            <div id="bulkProductsListPurchase" style="overflow-y: auto; max-height: 350px; border: 1px solid #ddd; border-radius: 4px; background: white;"></div>
          </div>
          <div>
            <h6 class="border-bottom pb-2">
              <i class="bi bi-check-circle"></i> Selected 
              <span class="badge bg-primary" id="bulkSelectedCountPurchase">0</span>
            </h6>
            <div style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">
              Total Qty: <strong id="bulkTotalQtyPurchase">0</strong>
            </div>
            <div id="bulkSelectedItemsPurchase" style="overflow-y: auto; max-height: 320px; border: 1px solid #ddd; border-radius: 4px; background: #f9f9f9;"></div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" onclick="addBulkProductsToPurchase()">
          <i class="bi bi-plus-circle"></i> Add Items
        </button>
      </div>
    </div>
  </div>
</div>


<!-- ==========================================
     SORT OPTIONS MODAL (SEQUENCE NUMBER)
     ========================================== -->
     <div class="modal fade" id="sortOptionsModal" tabindex="-1" aria-labelledby="sortOptionsModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
          
          <!-- Modal Header -->
          <div class="modal-header">
            <h5 class="modal-title" id="sortOptionsModalLabel">
              <i class="bi bi-sort-down"></i> Sort Products
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          
          <!-- Modal Body -->
          <div class="modal-body" style="padding: 24px;">
            
            <!-- Option 1: Sort by Name -->
            <div class="sort-option-card" onclick="toggleSortOption('name')">
              <div class="sort-option-header">
                <i class="bi bi-sort-alpha-down text-primary"></i>
                <span>Sort by Name</span>
                <i class="bi bi-chevron-down arrow-icon" id="arrow-name"></i>
              </div>
            </div>
            <div class="sort-sub-options" id="sub-name" style="display: none;">
              <button class="sort-sub-btn" onclick="applySortByName('asc')">
                <i class="bi bi-sort-alpha-down"></i> Ascending (A → Z)
              </button>
              <button class="sort-sub-btn" onclick="applySortByName('desc')">
                <i class="bi bi-sort-alpha-up"></i> Descending (Z → A)
              </button>
            </div>
            
            <!-- Option 2: Sort by Date -->
            <div class="sort-option-card" onclick="toggleSortOption('date')">
              <div class="sort-option-header">
                <i class="bi bi-calendar-event text-success"></i>
                <span>Sort by Date</span>
                <i class="bi bi-chevron-down arrow-icon" id="arrow-date"></i>
              </div>
            </div>
            <div class="sort-sub-options" id="sub-date" style="display: none;">
              <button class="sort-sub-btn" onclick="applySortByDate('latest')">
                <i class="bi bi-arrow-down"></i> Latest First
              </button>
              <button class="sort-sub-btn" onclick="applySortByDate('oldest')">
                <i class="bi bi-arrow-up"></i> Oldest First
              </button>
            </div>
            
            <!-- Option 3: Sort by Custom Order -->
            <div class="sort-option-card" onclick="startCustomOrderMode()">
              <div class="sort-option-header">
                <i class="bi bi-hand-index text-warning"></i>
                <span>Sort by Custom Order</span>
                <i class="bi bi-chevron-right"></i>
              </div>
            </div>
            
          </div>
          
        </div>
      </div>
    </div>
    
    <!-- ==========================================
     CUSTOM ORDER ACTION BAR (Hidden Initially)
     ========================================== -->
<div id="customOrderActionBar" style="display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 1050; background: white; padding: 16px 24px; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.2); gap: 12px; align-items: center;">
  <span style="font-weight: 600; color: #333;">
    <i class="bi bi-cursor"></i> Select products to order
  </span>
  <button class="btn btn-success btn-sm" onclick="saveCustomOrder()" id="saveCustomOrderBtn" disabled>
    <i class="bi bi-check-circle"></i> Save Order
  </button>
  <button class="btn btn-secondary btn-sm" onclick="cancelCustomOrder()">
    <i class="bi bi-x-circle"></i> Cancel
  </button>
</div>

    
<!-- ==========================================
     RECORD PURCHASE MODAL (WITH TRANSLATION)
     ========================================== -->
     <div class="modal fade" id="recordPurchaseModal" tabindex="-1" backdrop="static" keyboard="false">
      <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
          
          <!-- Header -->
          <div class="modal-header" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 8px 12px;">
            <h6 class="modal-title" style="font-size: 0.95rem; font-weight: 600; margin: 0;">
              <span data-i18n="recordPurchase">📦 RECORD PURCHASE</span>
            </h6>
            <button type="button" class="btn-close btn-close-white btn-sm" onclick="closeRecordPurchaseModal()" style="padding: 4px;"></button>
          </div>
          
          <!-- Body -->
          <div class="modal-body" style="background: #fff; padding: 10px; overflow-y: auto;">
            
            <!-- Styles -->
            <style>
              #recordPurchaseModal .form-label {
                font-size: 11px;
                font-weight: 700;
                color: #333;
                margin: 0 0 3px 0;
                display: block;
                text-transform: uppercase;
                letter-spacing: 0.5px;
              }
              #recordPurchaseModal .form-control,
              #recordPurchaseModal .form-select {
                font-size: 14px;
                padding: 5px 8px;
                border: 1px solid #ccc;
                border-radius: 3px;
                height: 32px;
              }
              #recordPurchaseModal .form-control:focus,
              #recordPurchaseModal .form-select:focus {
                border-color: #28a745;
                box-shadow: 0 0 0 0.15rem rgba(40, 167, 69, 0.2);
                outline: none;
              }
              #recordPurchaseModal .btn-sm {
                font-size: 12px;
                padding: 4px 10px;
                height: 28px;
              }
              #recordPurchaseModal .section-gap {
                height: 8px;
              }
              #purchasePhotoPreview {
                border: 1.5px dashed #ccc;
                border-radius: 4px;
                padding: 6px;
                text-align: center;
                background: #fafafa;
                cursor: pointer;
                min-height: 50px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
              }
              #purchasePhotoPreview i {
                font-size: 1.5rem;
                color: #999;
              }
              #purchasePhotoPreview p {
                font-size: 10px;
                color: #666;
                margin: 2px 0 0 0;
              }
              /* Product rows - DARKER GRAY */
              .purchase-product-row {
                padding: 8px 0;
                margin-bottom: 10px;
                background: #e0e0e0;
                border: 1px solid #bdbdbd;
                border-radius: 5px;
                position: relative;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
              }
              /* Mobile: 3 separate lines */
              @media (max-width: 767px) {
                .purchase-product-row {
                  display: block;
                  padding: 8px;
                }
                .product-name-line { margin-bottom: 6px; }
                .product-details-line {
                  display: grid;
                  grid-template-columns: 1fr 1fr 1fr;
                  gap: 6px;
                  margin-bottom: 6px;
                }
                .product-amount-line { display: block; }
                .purchase-field-label {
                  font-size: 9px; font-weight: 600; color: #666; margin-bottom: 2px; text-transform: uppercase;
                }
                .purchase-remove-btn {
                  position: absolute; top: 4px; right: 4px; width: 24px; height: 24px; padding: 0; font-size: 14px; border-radius: 3px;
                }
              }
              /* Desktop - FORCE WIDE GRID & CONTAINER */
              @media (min-width: 768px) {
                #recordPurchaseModal .modal-dialog {
                  max-width: 1400px !important;
                  min-width: 900px !important;
                  width: 95vw !important;
                  margin: 1.75rem auto !important;
                }
                #recordPurchaseModal .modal-content,
                #recordPurchaseModal .modal-body {
                  width: 100% !important;
                  min-width: 0 !important;
                  box-sizing: border-box !important;
                  padding: 16px 30px !important;
                }
                .purchase-product-row {
                  display: grid;
                  grid-template-columns: 7fr 2fr 2fr 2.2fr 2.2fr 80px;
                  gap: 16px;
                  align-items: center;
                  padding: 10px 12px;
                  width: 100% !important;
                  max-width: 100% !important;
                  box-sizing: border-box !important;
                }
                .purchase-field-label { display: none; }
                .product-name-line,
                .product-details-line,
                .product-amount-line { display: contents; }
                /* All product row inputs full width */
                .purchase-product-row input,
                .purchase-product-row select {
                  width: 100% !important;
                  min-width: 0 !important;
                  max-width: none !important;
                }
                /* Product grid container and parent always full width */
                #purchaseProductRows,
                .desktop-product-layout,
                .desktop-product-layout > div {
                  width: 100% !important;
                  min-width: 0 !important;
                  max-width: 100% !important;
                  box-sizing: border-box !important;
                }
                /* Desktop header columns - match exactly */
                .desktop-header > div {
                  display: grid !important;
                  grid-template-columns: 7fr 2fr 2fr 2.2fr 2.2fr 80px !important;
                  gap: 16px !important;
                  width: 100% !important;
                  box-sizing: border-box !important;
                }
              }
              /* Payment hidden by default */
              #paymentSection { display: none; }
              #paymentSection.show { display: block; }
              .payment-toggle {
                font-size: 12px; color: #28a745; cursor: pointer; text-decoration: underline; margin-top: 4px; display: inline-block;
              }
            </style>
    
            <!-- Photo -->
            <label class="form-label" data-i18n="photoOptional">📷 Photo (Optional)</label>
            <div id="purchasePhotoPreview" onclick="triggerPhotoInput()" style="
              border: 2px dashed #ccc;
              padding: 20px;
              text-align: center;
              cursor: pointer;
              border-radius: 8px;
              background: #f8f9fa;
              transition: all 0.2s;
              min-height: 120px;
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: center;
            ">
              <i class="bi bi-camera" style="font-size: 2rem; color: #999;"></i>
              <p style="color: #999; margin: 8px 0 0 0; font-size: 0.9rem;" data-i18n="tapOrPastePhoto">Tap or paste photo</p>
            </div>
    
            <input type="file" id="purchasePhotoInput" accept="image/*" style="display: none;" onchange="handlePurchasePhotoUpload(this)">
    
            <div style="margin-top: 8px; display: flex; gap: 8px;">
              <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearPurchasePhoto()" id="clearPurchasePhotoBtn" style="display: none;">
                <i class="bi bi-x"></i> <span data-i18n="remove">Remove</span>
              </button>
            </div>
    
            <div class="section-gap"></div>
    
           <!-- ✅ Vendor with Autocomplete -->
<label class="form-label" data-i18n="vendorName">🏢 Vendor Name</label>

<div style="position: relative;">
  <!-- Input Field Container -->
  <div style="position: relative;">
    <input 
      id="purchaseVendorName" 
      class="form-control" 
      type="text"
      autocomplete="off"
      oninput="filterVendorSuggestions(this.value); checkAndShowSaveVendorButton(this.value)"
      onfocus="showVendorSuggestions()"
      onblur="setTimeout(() => hideVendorSuggestions(), 200)"
      data-i18n-placeholder="vendorNamePlaceholder"
      placeholder="Type to search vendors..."
      style="padding-right: 40px;">
    
    <!-- 💾 Save Vendor Button -->
    <button id="saveVendorInsideBtn" 
      type="button"
      onclick="saveNewVendorFromPurchaseField()"
      title="Save this vendor"
      style="
        display: none;
        position: absolute;
        right: 8px;
        top: 50%;
        transform: translateY(-50%);
        background: #28a745;
        color: white;
        border: none;
        padding: 6px 10px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
        font-weight: bold;
        transition: all 0.2s;
        z-index: 10;
      "
      onmouseover="this.style.background='#218838'"
      onmouseout="this.style.background='#28a745'">
      💾
    </button>
  </div>
  
  <!-- Vendor Suggestions Dropdown -->
  <div id="purchaseVendorSuggestionsDropdown" style="
    display: none;
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: white;
    border: 1px solid #ddd;
    border-top: none;
    border-radius: 0 0 8px 8px;
    max-height: 200px;
    overflow-y: auto;
    z-index: 1050;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    margin-top: -1px;
  ">
    <!-- Suggestions rendered here -->
  </div>
</div>

    
            <div class="section-gap"></div>
            
            <!-- Products -->
<div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px;">
  <label class="form-label" style="margin: 0;" data-i18n="productsPurchased">📦 Products Purchased</label>
  
  <!-- ✅ Fill Qty/Rate Button (Mobile Only) -->
  <button 
    type="button" 
    id="fillQtyRateBtn"
    class="btn btn-sm d-md-none" 
    onclick="confirmAutofillMode()"
    style="
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 100%);
      border: none;
      color: white;
      padding: 6px 12px;
      font-size: 11px;
      font-weight: 600;
      border-radius: 5px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      box-shadow: 0 2px 4px rgba(255, 107, 107, 0.3);
    ">
    <i class="bi bi-pencil-square"></i>
    <span>Fill Qty/Rate</span>
  </button>
</div>

<div id="purchaseProductRows" style="margin-bottom: 6px;">
  <!-- Dynamic rows -->
</div>

 

<!-- ✅ UNIFORM BUTTONS - Same size, layout, design -->
<div style="display: flex; gap: 8px; flex-wrap: wrap;">
  <!-- Row Button -->
  <button 
    type="button" 
    class="btn btn-sm" 
    onclick="addPurchaseProductRow()"
    style="
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      color: white;
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 600;
      border-radius: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
    "
    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(102, 126, 234, 0.4)'"
    onmouseout="this.style.transform=''; this.style.boxShadow='0 2px 4px rgba(102, 126, 234, 0.3)'">
    <i class="bi bi-plus-lg"></i>
    <span data-i18n="row">Row</span>
  </button>

  <!-- Bulk Button -->
  <button 
    type="button" 
    class="btn btn-sm" 
    onclick="openBulkAddModalForPurchase()"
    style="
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      color: white;
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 600;
      border-radius: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
    "
    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(102, 126, 234, 0.4)'"
    onmouseout="this.style.transform=''; this.style.boxShadow='0 2px 4px rgba(102, 126, 234, 0.3)'">
    <i class="bi bi-box-seam"></i>
    <span data-i18n="bulk">Bulk</span>
  </button>

  <!-- Quick Item Button -->
  <button 
    type="button" 
    class="btn btn-sm" 
    onclick="openQuickItemModal()"
    style="
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      color: white;
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 600;
      border-radius: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: all 0.2s;
      box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
    "
    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(102, 126, 234, 0.4)'"
    onmouseout="this.style.transform=''; this.style.boxShadow='0 2px 4px rgba(102, 126, 234, 0.3)'">
    <i class="bi bi-lightning-charge-fill"></i>
    <span data-i18n="quickItem">Quick Item</span>
  </button>
</div>


            
            
            <div class="section-gap"></div>
            
            <!-- Total -->
            <label class="form-label" data-i18n="totalAmount">💰 Total Amount</label>
            <div class="input-group input-group-sm">
              <span class="input-group-text" style="padding: 5px 8px; font-size: 13px;">₹</span>
              <input type="number" class="form-control" id="purchaseTotalAmount" placeholder="0.00" step="0.01" min="0" style="font-weight: 600;">
            </div>
            
            <!-- Optional Payment Toggle -->
            <span class="payment-toggle" onclick="togglePaymentSection()" data-i18n="addPaymentDetails">+ Add payment details</span>
            
            <!-- Payment Section (Hidden) -->
            <div id="paymentSection">
              <div class="section-gap"></div>
              <label class="form-label" data-i18n="paymentModeOptional">💳 Payment Mode (Optional)</label>
              
              <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px;">
                <div style="position: relative; flex-shrink: 0;">
                  <input type="checkbox" id="purchasePaymentCash" 
                         onchange="togglePaymentModeCheckmark(this, 'cashCheckmark')"
                         style="width: 20px; height: 20px; cursor: pointer; accent-color: #28a745;">
                  <span id="cashCheckmark" style="display: none; position: absolute; top: 1px; left: 3px; font-size: 15px; color: white; pointer-events: none;">✓</span>
                </div>
                <label for="purchasePaymentCash" style="flex: 0 0 50px; font-size: 12px; font-weight: 600; margin: 0;" data-i18n="cash">Cash</label>
                <div style="flex: 1; display: flex;">
                  <span style="padding: 5px 8px; background: #f5f5f5; border: 1px solid #ccc; border-right: none; border-radius: 3px 0 0 3px; font-size: 13px;">₹</span>
                  <input type="number" class="form-control" id="purchasePaymentCashAmount" placeholder="0" step="0.01" min="0" style="border-radius: 0 3px 3px 0; flex: 1;">
                </div>
              </div>
              
              <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px;">
                <div style="position: relative; flex-shrink: 0;">
                  <input type="checkbox" id="purchasePaymentOnline"
                         onchange="togglePaymentModeCheckmark(this, 'onlineCheckmark')"
                         style="width: 20px; height: 20px; cursor: pointer; accent-color: #28a745;">
                  <span id="onlineCheckmark" style="display: none; position: absolute; top: 1px; left: 3px; font-size: 15px; color: white; pointer-events: none;">✓</span>
                </div>
                <label for="purchasePaymentOnline" style="flex: 0 0 50px; font-size: 12px; font-weight: 600; margin: 0;" data-i18n="online">Online</label>
                <div style="flex: 1; display: flex;">
                  <span style="padding: 5px 8px; background: #f5f5f5; border: 1px solid #ccc; border-right: none; border-radius: 3px 0 0 3px; font-size: 13px;">₹</span>
                  <input type="number" class="form-control" id="purchasePaymentOnlineAmount" placeholder="0" step="0.01" min="0" style="border-radius: 0 3px 3px 0; flex: 1;">
                </div>
              </div>
              
              <div style="display: flex; align-items: center; gap: 6px;">
                <div style="position: relative; flex-shrink: 0;">
                  <input type="checkbox" id="purchasePaymentCredit"
                         onchange="togglePaymentModeCheckmark(this, 'creditCheckmark')"
                         style="width: 20px; height: 20px; cursor: pointer; accent-color: #28a745;">
                  <span id="creditCheckmark" style="display: none; position: absolute; top: 1px; left: 3px; font-size: 15px; color: white; pointer-events: none;">✓</span>
                </div>
                <label for="purchasePaymentCredit" style="flex: 0 0 50px; font-size: 12px; font-weight: 600; margin: 0;" data-i18n="credit">Credit</label>
                <div style="flex: 1; display: flex;">
                  <span style="padding: 5px 8px; background: #f5f5f5; border: 1px solid #ccc; border-right: none; border-radius: 3px 0 0 3px; font-size: 13px;">₹</span>
                  <input type="number" class="form-control" id="purchasePaymentCreditAmount" placeholder="0" step="0.01" min="0" style="border-radius: 0 3px 3px 0; flex: 1;">
                </div>
              </div>
              
              <div class="section-gap"></div>
              
              <!-- Notes -->
              <label class="form-label" data-i18n="notes">📝 Notes</label>
              <textarea class="form-control" id="purchaseOtherInfo" rows="2" data-i18n-placeholder="optional" placeholder="Optional" style="font-size: 13px; padding: 5px 8px; resize: none;"></textarea>
            </div>
            
          </div>
          
          <!-- Footer -->
          <div class="modal-footer" style="padding: 6px 10px; gap: 6px; background: #f8f9fa; border-top: 1px solid #ddd;">
            <button type="button" class="btn btn-sm btn-secondary" onclick="closeRecordPurchaseModal()" style="flex: 1; height: 32px;">
              <span data-i18n="cancel">Cancel</span>
            </button>
            <button type="button" class="btn btn-sm btn-success" onclick="submitPurchaseEntry()" style="flex: 1; height: 32px;">
              <i class="bi bi-check"></i> <span data-i18n="submit">Submit</span>
            </button>
          </div>
          
        </div>
      </div>
    </div>
 

<!-- ==========================================
     QUICK ITEM MODAL - Add Multiple Items Quickly
     ========================================== -->
     <div class="modal fade" id="quickItemModal" tabindex="-1" backdrop="static" keyboard="false">
      <div class="modal-dialog modal-dialog-centered" style="max-width: 500px;">
        <div class="modal-content" style="border-radius: 12px; overflow: hidden;">
          
          <!-- Header -->
          <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 12px 16px;">
            <h6 class="modal-title" style="font-size: 1rem; font-weight: 600; margin: 0;">
              <i class="bi bi-lightning-charge-fill"></i> Quick Item Entry
            </h6>
            <button type="button" class="btn-close btn-close-white" onclick="closeQuickItemModal()" style="padding: 4px;"></button>
          </div>
          
          <!-- Body -->
          <div class="modal-body" style="padding: 16px;">
            
            <!-- Input Section -->
            <div style="margin-bottom: 16px;">
              <label style="font-size: 12px; font-weight: 600; color: #666; margin-bottom: 6px; display: block;">
                ITEM NAME
              </label>
              <div style="display: flex; gap: 8px;">
                <input 
                  type="text" 
                  id="quickItemInput" 
                  class="form-control" 
                  placeholder="Enter item name (e.g., Redtile)"
                  style="flex: 1; font-size: 14px; padding: 8px 12px; border: 2px solid #ddd; border-radius: 6px;"
                  onkeypress="if(event.key==='Enter') addQuickItemToList()">
                <button 
                  type="button" 
                  class="btn btn-primary" 
                  onclick="addQuickItemToList()"
                  style="padding: 8px 16px; font-size: 14px; font-weight: 600; border-radius: 6px; white-space: nowrap;">
                  <i class="bi bi-plus-lg"></i> Add
                </button>
              </div>
              <div style="font-size: 11px; color: #999; margin-top: 4px;">
                💡 Press Enter to add quickly
              </div>
            </div>
            
            <!-- Preview Area -->
            <div style="margin-bottom: 12px;">
              <!-- ✅ ITEMS ADDED HEADER WITH DONE BUTTON -->
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
                <label style="font-size: 12px; font-weight: 600; color: #666; margin: 0;">
                  ITEMS ADDED (<span id="quickItemCount">0</span>)
                </label>
                <button 
                  type="button" 
                  class="btn btn-success btn-sm" 
                  onclick="closeQuickItemModal()"
                  style="padding: 4px 12px; font-size: 11px; font-weight: 600;">
                  <i class="bi bi-check-circle"></i> Done
                </button>
              </div>
              
              <div id="quickItemPreview" style="
                min-height: 120px;
                max-height: 300px;
                overflow-y: auto;
                background: #f8f9fa;
                border: 2px dashed #ddd;
                border-radius: 8px;
                padding: 12px;
              ">
                <div style="text-align: center; color: #999; padding: 20px;">
                  <i class="bi bi-inbox" style="font-size: 2rem; display: block; margin-bottom: 8px;"></i>
                  No items added yet
                </div>
              </div>
            </div>
            
          </div>
          
          <!-- Footer -->
          <div class="modal-footer" style="padding: 12px 16px; gap: 8px; background: #f8f9fa; border-top: 1px solid #ddd;">
            <button 
              type="button" 
              class="btn btn-outline-secondary" 
              onclick="clearQuickItems()"
              style="flex: 1; padding: 8px;">
              <i class="bi bi-trash"></i> Clear All
            </button>
            <button 
              type="button" 
              class="btn btn-success" 
              onclick="closeQuickItemModal()"
              style="flex: 2; padding: 8px; font-weight: 600;">
              <i class="bi bi-check-circle"></i> Done
            </button>
          </div>
          
        </div>
      </div>
    </div>
    







  
</body>
</html>










































































































































































































































































































































































































































































































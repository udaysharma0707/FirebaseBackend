<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>Tile & Sanitarywaree Inventory</title>

<!-- PWA Manifest -->
<link rel="manifest" href="manifest.json">

<!-- Theme Color -->
<meta name="theme-color" content="#1976D2">

<!-- Apple Touch Icon -->
<link rel="apple-touch-icon" href="icon-192.png">

<!-- Apple Mobile Web App Capable -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Inventory">

<!-- Firebase SDK -->
<script type="module">
  // Import Firebase modules
  import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-app.js';
  import { 
    getAuth, 
    signInWithEmailAndPassword, 
    createUserWithEmailAndPassword, 
    onAuthStateChanged, 
    signOut 
  } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js';
  import { 
    getFirestore, 
    collection, 
    doc, 
    addDoc, 
    getDoc, 
    getDocs, 
    setDoc, 
    updateDoc, 
    deleteDoc, 
    query, 
    where, 
    orderBy, 
    limit 
  } from 'https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore.js';
  
  // Your Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyAZ5gxZQIMVthFPlPh7pumEVZujBCqnWcY",
    authDomain: "tileinventoryapp.firebaseapp.com",
    projectId: "tileinventoryapp",
    storageBucket: "tileinventoryapp.firebasestorage.app",
    messagingSenderId: "593208886238",
    appId: "1:593208886238:web:ca118d33b30a667fb56d4f"
  };
  
  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  
  // Make available globally
  window.auth = auth;
  window.db = db;
  window.firebaseImports = {
    collection, 
    doc, 
    addDoc, 
    getDoc, 
    getDocs, 
    setDoc, 
    updateDoc, 
    deleteDoc, 
    query, 
    where, 
    orderBy, 
    limit,
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    onAuthStateChanged,
    signOut
  };
  
  console.log("‚úÖ Firebase SDK loaded successfully!");
  
  // ‚úÖ Authentication state handler (using already imported onAuthStateChanged)
  onAuthStateChanged(auth, (user) => {
    if (user) {
      console.log('‚úÖ User signed in:', user.email);
      window.currentUser = {
        email: user.email,
        uid: user.uid
      };
      
      showApp();
      
      if (typeof syncFromFirestore === 'function') {
        setTimeout(() => syncFromFirestore(), 500);
      }
    } else {
      console.log('‚ùå No user signed in');
      window.currentUser = null;
      showAuthScreen();
    }
  });
  
  function showApp() {
    const authScreen = document.getElementById('authScreen');
    const loginPage = document.getElementById('loginPage');
    const mainApp = document.getElementById('mainApp');
    
    if (authScreen) authScreen.style.display = 'none';
    if (loginPage) loginPage.style.display = 'none';
    if (mainApp) mainApp.style.display = 'block';
  }
  
  function showAuthScreen() {
    const authScreen = document.getElementById('authScreen');
    const loginPage = document.getElementById('loginPage');
    const mainApp = document.getElementById('mainApp');
    
    if (authScreen) authScreen.style.display = 'block';
    if (loginPage) loginPage.style.display = 'block';
    if (mainApp) mainApp.style.display = 'none';
  }
</script>

  
  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">

  <!-- √¢≈ì‚Ä¶ html2canvas for image generation -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- √É¬¢√Ö‚Äú√¢‚Ç¨¬¶ ADD THIS LINE -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- ‚úÖ NEW: Link to External CSS File -->
  <link rel="stylesheet" href="styles.css">

 <script src="customers.js"></script>
  <script src="brand-manager.js"></script>
<!-- ‚úÖ Bulk Edit Module -->
<script src="bulk-edit.js"></script>





  
  
</head>
<body>

<!-- ==========================================
     SIDEBAR MENU (Zoho-style)
     ========================================== -->

<!-- Hamburger Menu Button -->
<button class="sidebar-toggle-btn" id="sidebarToggleBtn" onclick="toggleSidebar()">
  <i class="bi bi-list"></i>
</button>

<!-- Sidebar Overlay -->
<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

<!-- Sidebar Menu -->
<nav class="sidebar-menu" id="sidebarMenu">
  
  <!-- Sidebar Header -->
  <div class="sidebar-header">
    <i class="bi bi-boxes" style="font-size: 32px;"></i>
    <h4>Menu</h4>
  </div>
  
  <!-- Home -->
  <div class="sidebar-item" onclick="navigateTo('dashboard')">
    <i class="bi bi-house-door"></i>
    <span>Home</span>
  </div>
  
  <!-- GENERAL Section -->
  <div class="sidebar-section-title">GENERAL</div>
  
  <div class="sidebar-item disabled" onclick="sidebarAction('addUsers')">
    <i class="bi bi-person-plus"></i>
    <span>Add Users</span>
  </div>
  

<div class="sidebar-item" onclick="navigateTo('allProducts')">
  <i class="bi bi-box"></i>
  <span>All Products</span>
</div>


<div class="sidebar-item" onclick="navigateTo('productGroups')">
  <i class="bi bi-collection"></i>
  <span>Products in Group</span>
</div>

  
  <div class="sidebar-item disabled" onclick="sidebarAction('inventoryAdjustments')">
    <i class="bi bi-sliders"></i>
    <span>Inventory Adjustments</span>
  </div>
  
  <!-- SALES Section -->
  <div class="sidebar-section-title">SALES</div>
  
<!-- Customer -->
<div class="sidebar-item" onclick="navigateTo('customers')">
  <i class="bi bi-people"></i>
  <span>Customer</span>
</div>


  <div class="sidebar-item" onclick="navigateTo('invoices')">
  <i class="bi bi-receipt"></i>
  <span>Invoices</span>
</div>

<!-- MANAGEMENT Section (add this new section) -->
<div class="sidebar-section-title">MANAGEMENT</div>

<div class="sidebar-item" onclick="navigateTo('brands')">
  <i class="bi bi-tag"></i>
  <span>Brands</span>
</div>




  
  <div class="sidebar-item disabled" onclick="sidebarAction('salesReceipts')">
    <i class="bi bi-cash-stack"></i>
    <span>Sales Receipts</span>
  </div>
  
  <div class="sidebar-item disabled" onclick="sidebarAction('salesOrder')">
    <i class="bi bi-cart-check"></i>
    <span>Sales Order</span>
  </div>
  
  <div class="sidebar-item disabled" onclick="sidebarAction('packages')">
    <i class="bi bi-box-seam"></i>
    <span>Packages</span>
  </div>
  
  <div class="sidebar-item disabled" onclick="sidebarAction('shipment')">
    <i class="bi bi-truck"></i>
    <span>Shipment</span>
  </div>
  
  <div class="sidebar-item disabled" onclick="sidebarAction('customerPayment')">
    <i class="bi bi-credit-card"></i>
    <span>Customer Payment</span>
  </div>
  
  <div class="sidebar-item disabled" onclick="sidebarAction('creditNotes')">
    <i class="bi bi-file-text"></i>
    <span>Credit Notes</span>
  </div>
  
  <!-- PURCHASES Section -->
  <div class="sidebar-section-title">PURCHASES</div>
  
  <div class="sidebar-item disabled" onclick="sidebarAction('vendor')">
    <i class="bi bi-building"></i>
    <span>Vendor</span>
  </div>
  
  <div class="sidebar-item disabled" onclick="sidebarAction('expenses')">
    <i class="bi bi-cash-coin"></i>
    <span>Expenses</span>
  </div>
  
  <div class="sidebar-item disabled" onclick="sidebarAction('bills')">
    <i class="bi bi-file-earmark-text"></i>
    <span>Bills</span>
  </div>
  
  <div class="sidebar-item" onclick="navigateToPurchaseOrders()">
  <i class="bi bi-bag-check"></i>
  <span>Purchase Orders</span>
</div>

  
  <div class="sidebar-item disabled" onclick="sidebarAction('purchaseReceives')">
    <i class="bi bi-inbox"></i>
    <span>Purchase Receives</span>
  </div>
  
  <div class="sidebar-item disabled" onclick="sidebarAction('vendorPayment')">
    <i class="bi bi-wallet2"></i>
    <span>Vendor Payment</span>
  </div>
  
  <div class="sidebar-item disabled" onclick="sidebarAction('vendorCredits')">
    <i class="bi bi-arrow-left-circle"></i>
    <span>Vendor Credits</span>
  </div>
  
  <!-- Settings -->
  <div class="sidebar-section-title">SYSTEM</div>
  
  <div class="sidebar-item disabled" onclick="sidebarAction('settings')">
    <i class="bi bi-gear"></i>
    <span>Settings</span>
  </div>
  
</nav>


<div id="authScreen" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); z-index: 9999;">
  <div class="container d-flex justify-content-center align-items-center" style="min-height: 100vh;">
    <div class="card shadow-lg" style="max-width: 420px; width: 100%; border-radius: 15px;">
      <div class="card-body text-center p-5">
        <div class="mb-4">
          <i class="bi bi-building" style="font-size: 4rem; color: #0d6efd;"></i>
        </div>
        <h2 class="mb-3">Tile & Sanitaryware Inventory</h2>
        <p class="text-muted mb-4">Sign in to access inventory</p>
        
        <!-- √É¬¢√Ö‚Äú√¢‚Ç¨¬¶ NEW: Email + Password Form -->
        <form id="emailAuthForm" onsubmit="handleEmailPasswordAuth(event)">
          <div class="mb-3">
            <input 
              type="email" 
              id="userEmailInput" 
              class="form-control form-control-lg" 
              placeholder="Email address" 
              required
              autocomplete="email"
              style="border-radius: 10px; text-align: center;"
            >
          </div>
          
          <!-- √É¬¢√Ö‚Äú√¢‚Ç¨¬¶ NEW: Password Input with Toggle -->
          <div class="mb-3 position-relative">
            <input 
              type="password" 
              id="userPasswordInput" 
              class="form-control form-control-lg" 
              placeholder="Password" 
              required
              autocomplete="current-password"
              style="border-radius: 10px; text-align: center; padding-right: 45px;"
            >
            <button 
              type="button" 
              class="btn btn-link position-absolute" 
              onclick="togglePasswordVisibility()"
              style="right: 10px; top: 50%; transform: translateY(-50%); text-decoration: none; color: #6c757d;"
            >
              <i id="passwordToggleIcon" class="bi bi-eye"></i>
            </button>
          </div>
          
          <button type="submit" id="loginButton" class="btn btn-primary btn-lg w-100" style="border-radius: 10px;">
            <i class="bi bi-box-arrow-in-right me-2"></i>Sign In
          </button>
        </form>
        
        <div class="text-muted mt-4" style="font-size: 0.875rem;">
          <i class="bi bi-lock-fill me-1"></i> Secure access with password
        </div>
      </div>
    </div>
  </div>
</div>





 <!-- YOUR EXISTING NAVBAR, DASHBOARD, ETC. GOES HERE -->

  
  <!-- Sync indicator -->
  <div id="syncIndicator" class="sync-indicator"><i class="bi bi-arrow-repeat"></i> <span id="syncText">Syncing...</span></div>

  <!-- Navbar -->
  <nav class="navbar navbar-dark bg-primary sticky-top">
    <div class="container-fluid">
      <span class="navbar-brand mb-0 h1"><i class="bi bi-boxes"></i> Tile & Sanitaryware Inventory</span>
      <div>
        <button id="refreshBtn" class="btn btn-light btn-sm me-2" onclick="manualRefresh()"><i id="refreshIcon" class="bi bi-arrow-clockwise"></i> Refresh</button>
        <button class="btn btn-light btn-sm me-2" onclick="exportData()"><i class="bi bi-download"></i> Backup</button>
        <button class="btn btn-light btn-sm" onclick="importData()"><i class="bi bi-upload"></i> Restore</button>
        <div class="d-flex align-items-center">
  <i class="bi bi-person-circle me-2" style="font-size: 1.5rem;"></i>
  <span id="userName" class="me-3">User</span>

  <!-- √É¬¢√Ö‚Äú√¢‚Ç¨¬¶ NEW: Background sync indicator -->
  <div id="backgroundSyncStatus">
    <i class="bi bi-cloud-upload-fill"></i>
    <span>Syncing</span>
  </div>


          
  <!-- √É¬¢√Ö‚Äú√¢‚Ç¨¬¶ NEW: Change Password Button -->
  <button class="btn btn-outline-light btn-sm me-2" onclick="openChangePasswordModal()">
    <i class="bi bi-key me-1"></i>Change Password
  </button>
  
  <button class="btn btn-outline-light btn-sm" onclick="signOut()">
    <i class="bi bi-box-arrow-right me-1"></i>Sign Out
  </button>
</div>



        <!-- NEW: View Invoices Button -->
      <button class="btn btn-success btn-sm" onclick="viewSavedInvoices()">
        <i class="bi bi-receipt-cutoff"></i> View Invoices
      </button>
    </div>
  </div>
      </div>
    </div>
  </nav>


 <div class="container-fluid py-4">
  <!-- Actions -->
  <div class="row mb-4">
    <div class="text-center my-3">
      
      
   <!-- ‚úÖ UPDATED ACTION BUTTONS - Navbar Green (#25D366) -->
<button class="btn me-2" style="background: linear-gradient(135deg, #25D366 0%, #1FAD5D 100%); color: white; font-weight: 600; border: none; border-radius: 10px; padding: 12px 24px; box-shadow: 0 2px 8px rgba(37, 211, 102, 0.2); transition: all 0.3s ease;" onclick="showAddProduct()">
  <i class="bi bi-plus-circle"></i> Add Product
</button>

<button class="btn me-2" style="background: linear-gradient(135deg, #25D366 0%, #1FAD5D 100%); color: #1FAD5D; font-weight: 600; border: 1px solid rgba(37, 211, 102, 0.2); border-radius: 10px; padding: 12px 24px; transition: all 0.3s ease;" onclick="openPhotoProductModal()">
  <i class="bi bi-camera"></i> Product by Photo
</button>

<button class="btn me-2" style="background: linear-gradient(135deg, #25D366 0%, #1FAD5D 100%); color: #1FAD5D; font-weight: 600; border: 1px solid rgba(37, 211, 102, 0.2); border-radius: 10px; padding: 12px 24px; transition: all 0.3s ease;" onclick="openSalesModal()">
  <i class="bi bi-cart"></i> Record Sale
</button>

<button class="btn" style="background: linear-gradient(135deg, #25D366 0%, #1FAD5D 100%); color: #1FAD5D; font-weight: 600; border: 1px solid rgba(37, 211, 102, 0.2); border-radius: 10px; padding: 12px 24px; transition: all 0.3s ease;" onclick="generateInvoice()">
  <i class="bi bi-receipt"></i> Generate Invoice
</button>

  
    

<!-- ‚úÖ NEW: Record Purchase Button -->
<button onclick="openRecordPurchaseModal()" class="btn" style="
  background: #28a745;
  color: white;
  border: none;
  padding: 10px 20px;
  border-radius: 8px;
  font-weight: 600;
  margin-left: 10px;
  cursor: pointer;
  transition: background 0.3s;
"
onmouseover="this.style.background='#218838'"
onmouseout="this.style.background='#28a745'">
  üì¶ Record Purchase
</button>



      
    </div>
  </div>
</div>

      

<!-- Summary - 2 Columns Mobile (UPDATED WITH GREEN BORDER) -->
<div class="row mb-4" style="gap: 0.5rem;">
  
  <!-- 1. Total Products -->
  <div style="width: calc(50% - 0.25rem); margin-bottom: 0.5rem;">
    <div class="card summary-card text-center shadow-sm h-100">
      <div class="card-body p-2">
        <i class="bi bi-box-seam text-primary" style="font-size:2rem"></i>
        <h3 id="totalProducts" class="mt-2 mb-1" style="font-size:1.5rem; color: var(--primary-green); font-weight: 700;">0</h3>
        <p class="text-muted mb-0" style="font-size:0.75rem;">Total Products</p>
      </div>
    </div>
  </div>
  
  <!-- 2. Products in Group -->
  <div style="width: calc(50% - 0.25rem); margin-bottom: 0.5rem;">
    <div class="card summary-card text-center shadow-sm h-100">
      <div class="card-body p-2">
        <i class="bi bi-collection text-info" style="font-size:2rem; color: var(--primary-green);"></i>
        <h3 id="productsInGroup" class="mt-2 mb-1" style="font-size:1.5rem; color: var(--primary-green); font-weight: 700;">0</h3>
        <p class="text-muted mb-0" style="font-size:0.75rem;">Products in Group</p>
      </div>
    </div>
  </div>
  
  <!-- 3. Low Stock Items -->
  <div style="width: calc(50% - 0.25rem); margin-bottom: 0.5rem;">
    <div class="card summary-card text-center shadow-sm h-100">
      <div class="card-body p-2">
        <i class="bi bi-exclamation-triangle text-danger" style="font-size:2rem; color: #DC2626;"></i>
        <h3 id="lowStock" class="mt-2 mb-1" style="font-size:1.5rem; color: #DC2626; font-weight: 700;">0</h3>
        <p class="text-muted mb-0" style="font-size:0.75rem;">Low Stock Items</p>
      </div>
    </div>
  </div>
  
  <!-- 4. Inventory Summary -->
  <div style="width: calc(50% - 0.25rem); margin-bottom: 0.5rem;">
    <div class="card summary-card shadow-sm h-100">
      <div class="card-body p-2">
        <div class="text-center mb-2">
          <i class="bi bi-layers text-success" style="font-size:2rem; color: var(--primary-green);"></i>
          <p class="text-muted mb-0 mt-1" style="font-size:0.75rem;"><strong>Inventory</strong></p>
        </div>
        <div class="d-flex justify-content-between align-items-center mb-2 pb-2" style="border-bottom: 1px solid rgba(18, 140, 126, 0.1);">
          <span class="text-muted" style="font-size:0.7rem;">Qty in Hand</span>
          <span class="fw-bold" id="quantityInHand" style="font-size:0.9rem; color: var(--primary-green);">0</span>
        </div>
        <div class="d-flex justify-content-between align-items-center">
          <span class="text-muted" style="font-size:0.7rem;">To Receive</span>
          <span class="fw-bold" id="quantityToBeReceived" style="font-size:0.9rem; color: var(--primary-green);">0</span>
        </div>
      </div>
    </div>
  </div>
  
</div>


    <!-- Search -->
    <div class="row mb-3">
      <div class="col-md-6 mx-auto">
        <!-- Search bar with view toggle -->
<div class="d-flex justify-content-between align-items-center mb-3">
  <input type="text" id="productSearch" class="form-control" placeholder="üîç Search products..." onkeyup="searchProducts()">

<!-- ==========================================
     üî• BULK EDIT TOOLBAR - WITH UNIT TYPE
     ========================================== -->
<div id="bulkEditToolbar" style="margin: 20px 0; padding: 15px; background: #f8f9fa; border-radius: 8px; display: flex; flex-wrap: wrap; gap: 12px; align-items: center;">
  
  <!-- Main Dropdown Button -->
  <div class="dropdown">
    <button class="btn btn-primary dropdown-toggle" 
            type="button" 
            id="bulkEditDropdown" 
            data-bs-toggle="dropdown" 
            aria-expanded="false" 
            style="font-weight: 600;">
      <i class="bi bi-pencil-square"></i> Edit Products in Bulk
    </button>
    <ul class="dropdown-menu shadow" aria-labelledby="bulkEditDropdown" style="min-width: 250px;">
      <li>
        <button type="button" class="dropdown-item d-flex justify-content-between align-items-center" onclick="showCategoryBulkEdit();">
          <span><i class="bi bi-tag"></i> Update Category</span>
          <i class="bi bi-chevron-right text-muted"></i>
        </button>
      </li>
      <li><hr class="dropdown-divider"></li>
      <!-- ‚úÖ UNIT TYPE - NOW ACTIVE -->
      <li>
        <button type="button" class="dropdown-item d-flex justify-content-between align-items-center" onclick="showUnitTypeBulkEdit();">
          <span><i class="bi bi-card-text"></i> Update Unit Type</span>
          <i class="bi bi-chevron-right text-muted"></i>
        </button>
      </li>
      <li><hr class="dropdown-divider"></li>
      <li>
  <button type="button" class="dropdown-item d-flex justify-content-between align-items-center" onclick="showStockAdjustmentEdit();">
    <span><i class="bi bi-boxes"></i> Update Stock</span>
    <i class="bi bi-chevron-right text-muted"></i>
  </button>
</li>

     <li>
  <button type="button" class="dropdown-item d-flex justify-content-between align-items-center" onclick="showSellingPriceBulkEdit();">
    <span><i class="bi bi-currency-rupee"></i> Update Selling Price</span>
    <i class="bi bi-chevron-right text-muted"></i>
  </button>
</li>

<li>
  <button type="button" class="dropdown-item d-flex justify-content-between align-items-center" onclick="showStockStatusBulkEdit();">
    <span><i class="bi bi-circle-fill"></i> Update Stock Status</span>
    <i class="bi bi-chevron-right text-muted"></i>
  </button>
</li>


      
      <li>
  <button type="button" class="dropdown-item d-flex justify-content-between align-items-center" onclick="showBrandBulkEdit();">
    <span><i class="bi bi-award"></i> Update Brand</span>
    <i class="bi bi-chevron-right text-muted"></i>
  </button>
</li>

      <li>
  <button type="button" class="dropdown-item d-flex justify-content-between align-items-center" onclick="showSizeBulkEdit();">
    <span><i class="bi bi-rulers"></i> Update Size</span>
    <i class="bi bi-chevron-right text-muted"></i>
  </button>
</li>

    </ul>
  </div>

<!-- ===== SELLING PRICE SECTION ===== -->

<!-- Selling Price Input Container (Hidden Initially) -->
<div id="sellingPriceInputContainer" style="display: none;"> <!-- ‚úÖ FIXED: Added display:none -->
  <label style="font-size: 14px; font-weight: 600; color: #495057;">
    Enter Selling Price to Update
  </label>
  <div style="display: flex; align-items: center; gap: 8px;">
    <div class="input-group" style="max-width: 200px;">
      <span class="input-group-text">‚Çπ</span>
      <input 
        type="number" 
        id="sellingPriceInput" 
        class="form-control" 
        placeholder="400" 
        min="0" 
        step="0.01"
        style="font-weight: 600;">
    </div>
  </div>
</div>

<!-- Update Selling Price Button (Hidden Initially) -->
<button id="updateSellingPriceBtn" 
        class="btn btn-success" 
        style="display: none; font-weight: 600; color: white;" 
        onclick="applyBulkSellingPriceUpdate()">
  <i class="bi bi-currency-rupee"></i> Update Selling Price 
  (<span id="selectedCountSellingPrice" style="font-weight: 700;">0</span> selected)
</button>

<!-- ===== SIZE SECTION ===== -->

<!-- Size Input Container (Hidden Initially) -->
<div id="sizeInputContainer" style="display: none;">
  <label style="font-size: 14px; font-weight: 600; color: #495057;">
    Enter Size to Update
  </label>
  <div style="display: flex; align-items: center; gap: 8px;">
    <input 
      type="text" 
      id="sizeInput" 
      class="form-control" 
      placeholder="e.g., 2*2" 
      style="max-width: 200px; font-weight: 600;">
  </div>
</div>

<!-- Update Size Button (Hidden Initially) -->
<button id="updateSizeBtn" 
        class="btn btn-success" 
        style="display: none; font-weight: 600; color: white;" 
        onclick="applyBulkSizeUpdate()">
  <i class="bi bi-rulers"></i> Update Size 
  (<span id="selectedCountSize" style="font-weight: 700;">0</span> selected)
</button>



  <!-- ===== BRAND SECTION ===== -->

<!-- Brand Input Container (Hidden Initially) -->
<div id="brandInputContainer" style="display: none;">
  <label style="font-size: 14px; font-weight: 600; color: #495057;">
    Enter Brand to Update
  </label>
  <div style="display: flex; align-items: center; gap: 8px;">
    <input 
      type="text" 
      id="brandInput" 
      class="form-control" 
      placeholder="e.g., Somany" 
      style="max-width: 200px; font-weight: 600;">
  </div>
</div>

<!-- Update Brand Button (Hidden Initially) -->
<button id="updateBrandBtn" 
        class="btn btn-success" 
        style="display: none; font-weight: 600; color: white;" 
        onclick="applyBulkBrandUpdate()">
  <i class="bi bi-award"></i> Update Brand 
  (<span id="selectedCountBrand" style="font-weight: 700;">0</span> selected)
</button>

<!-- ===== STOCK ADJUSTMENT SECTION ===== -->

<!-- Stock Adjustment Container (Hidden Initially) -->
<div id="stockAdjustmentContainer" style="display: none;">
  <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
    <!-- Number Input -->
    <div class="input-group" style="max-width: 150px;">
      <input 
        type="number" 
        id="stockAdjustmentInput" 
        class="form-control" 
        placeholder="10" 
        min="1" 
        step="1"
        value="10"
        style="font-weight: 600;">
    </div>
    
    <!-- Add/Reduce Toggle Dropdown -->
    <div class="dropdown">
      <button class="btn btn-outline-primary dropdown-toggle" type="button" id="stockOperationBtn" data-bs-toggle="dropdown" aria-expanded="false" style="font-weight: 600;">
        <i class="bi bi-dash-circle"></i> Reduce by
      </button>
      <ul class="dropdown-menu" aria-labelledby="stockOperationBtn">
        <li><button class="dropdown-item" onclick="setStockOperation('add')">
          <i class="bi bi-plus-circle text-success"></i> Add by
        </button></li>
        <li><button class="dropdown-item" onclick="setStockOperation('reduce')">
          <i class="bi bi-dash-circle text-danger"></i> Reduce by
        </button></li>
      </ul>
    </div>
  </div>
  
  <small class="text-muted mt-2" style="display: block;">
    <i class="bi bi-info-circle"></i> Click on any product with numeric stock to adjust
  </small>
</div>

<!-- Stock Adjustment Animation Styles -->
<style>
.stock-animation {
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 32px;
  font-weight: 700;
  color: #28a745;
  z-index: 1000;
  pointer-events: none;
  animation: stockPulse 1s ease-out forwards;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
}

.stock-animation.reduce {
  color: #dc3545;
}

@keyframes stockPulse {
  0% {
    opacity: 1;
    transform: translate(-50%, -50%) scale(0.5);
  }
  50% {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1.2);
  }
  100% {
    opacity: 0;
    transform: translate(-50%, -100%) scale(1);
  }
}

/* Product clickable indicator */
.stock-adjustable {
  cursor: pointer;
  position: relative;
}

.stock-adjustable:hover {
  background-color: #e7f5ff !important;
  transform: scale(1.02);
  transition: all 0.2s ease;
}
</style>


<!-- ===== STOCK STATUS SELECTION SECTION ===== -->

<!-- Stock Status Selection Dropdown (Hidden Initially) -->
<div class="dropdown" id="stockStatusSelectionDropdown" style="display: none;">
  <button class="btn btn-outline-primary dropdown-toggle" type="button" id="stockStatusDropdownBtn" data-bs-toggle="dropdown" aria-expanded="false" style="font-weight: 600;">
    <i class="bi bi-circle-fill"></i> <span id="selectedStockStatusText">Select Stock Status</span>
  </button>
  <ul class="dropdown-menu" aria-labelledby="stockStatusDropdownBtn">
    <li><button class="dropdown-item" onclick="selectBulkStockStatus('GOOD')">
      <span style="color: #28a745;">üü¢</span> Good
    </button></li>
    <li><button class="dropdown-item" onclick="selectBulkStockStatus('MEDIUM')">
      <span style="color: #ffc107;">üü°</span> Medium
    </button></li>
    <li><button class="dropdown-item" onclick="selectBulkStockStatus('LOW')">
      <span style="color: #dc3545;">üî¥</span> Low
    </button></li>
    <li><button class="dropdown-item" onclick="selectBulkStockStatus('URGENT')">
      <span style="color: #6f42c1;">üîµ</span> Urgent
    </button></li>
  </ul>
</div>

<!-- Update Stock Status Button (Hidden Initially) -->
<button id="updateStockStatusBtn" class="btn btn-success" style="display: none; font-weight: 600;" onclick="applyBulkStockStatusUpdate()">
  <i class="bi bi-check-circle"></i> Update Stock Status (<span id="selectedCountStockStatus">0</span> selected)
</button>



  
  
  <!-- ===== CATEGORY SECTION ===== -->
  
  <!-- Category Selection Dropdown (Hidden Initially) -->
  <div id="categorySelectionDropdown" class="dropdown" style="display: none;">
    <button class="btn btn-outline-primary dropdown-toggle" 
            type="button" 
            id="categoryDropdownBtn" 
            data-bs-toggle="dropdown" 
            aria-expanded="false" 
            style="font-weight: 600;">
      <i class="bi bi-funnel"></i> <span id="selectedCategoryText">Select Category</span>
    </button>
    <ul class="dropdown-menu shadow" aria-labelledby="categoryDropdownBtn">
      <li>
        <button type="button" class="dropdown-item" onclick="selectBulkCategory('Tiles');">
          <i class="bi bi-grid-3x3-gap"></i> Tiles
        </button>
      </li>
      <li>
        <button type="button" class="dropdown-item" onclick="selectBulkCategory('Sanitaryware');">
          <i class="bi bi-droplet"></i> Sanitaryware
        </button>
      </li>
      <li>
        <button type="button" class="dropdown-item" onclick="selectBulkCategory('Accessories');">
          <i class="bi bi-wrench"></i> Accessories
        </button>
      </li>
      <li>
        <button type="button" class="dropdown-item" onclick="selectBulkCategory('Custom');">
          <i class="bi bi-star"></i> Custom
        </button>
      </li>
    </ul>
  </div>
  
  <!-- Update Category Button (Hidden Initially) -->
  <button id="updateCategoryBtn" 
          class="btn btn-success" 
          style="display: none; font-weight: 600;" 
          onclick="applyBulkCategoryUpdate()">
    <i class="bi bi-check-circle"></i> Update Category 
    (<span id="selectedCount" style="font-weight: 700;">0</span> selected)
  </button>
  
  <!-- ===== UNIT TYPE SECTION ===== -->
  
  <!-- Unit Type Selection Dropdown (Hidden Initially) -->
  <div id="unitTypeSelectionDropdown" class="dropdown" style="display: none;">
    <button class="btn btn-outline-info dropdown-toggle" 
            type="button" 
            id="unitTypeDropdownBtn" 
            data-bs-toggle="dropdown" 
            aria-expanded="false" 
            style="font-weight: 600;">
      <i class="bi bi-card-text"></i> <span id="selectedUnitTypeText">Select Unit Type</span>
    </button>
    <ul class="dropdown-menu shadow" aria-labelledby="unitTypeDropdownBtn">
      <li>
        <button type="button" class="dropdown-item" onclick="selectBulkUnitType('Box');">
          <i class="bi bi-box"></i> Box
        </button>
      </li>
      <li>
        <button type="button" class="dropdown-item" onclick="selectBulkUnitType('Piece');">
          <i class="bi bi-circle"></i> Piece
        </button>
      </li>
      <li>
        <button type="button" class="dropdown-item" onclick="selectBulkUnitType('Square Feet');">
          <i class="bi bi-square"></i> Square Feet
        </button>
      </li>
      <li>
        <button type="button" class="dropdown-item" onclick="selectBulkUnitType('Meter');">
          <i class="bi bi-rulers"></i> Meter
        </button>
      </li>
      <li>
        <button type="button" class="dropdown-item" onclick="selectBulkUnitType('Set');">
          <i class="bi bi-collection"></i> Set
        </button>
      </li>
    </ul>
  </div>
  
  <!-- Update Unit Type Button (Hidden Initially) -->
  <button id="updateUnitTypeBtn" 
          class="btn btn-info" 
          style="display: none; font-weight: 600; color: white;" 
          onclick="applyBulkUnitTypeUpdate()">
    <i class="bi bi-check-circle"></i> Update Unit Type 
    (<span id="selectedCountUnitType" style="font-weight: 700;">0</span> selected)
  </button>
  
  <!-- ===== COMMON BUTTONS ===== -->
  
  <!-- Cancel Button (Hidden Initially) -->
  <button id="cancelBulkEditBtn" 
          class="btn btn-secondary" 
          style="display: none;" 
          onclick="cancelBulkEdit()">
    <i class="bi bi-x-circle"></i> Cancel
  </button>

<!-- NEW: Update Button (for Stock Adjustment mode) -->
<button id="updateStockChangesBtn" 
        class="btn btn-primary" 
        style="display: none; font-weight: 600;" 
        onclick="updateStockChanges()">
  <i class="bi bi-check-circle"></i> Update
</button>


  
  <!-- Info Text -->
  <div id="bulkEditInfoText" 
       style="display: none; margin-left: auto; color: #6c757d; font-size: 14px; font-weight: 500;">
    <i class="bi bi-info-circle"></i> Click on products to select them
  </div>
</div>

 <!-- View Toggle Buttons -->
        <div class="btn-group" role="group">
          <button type="button" class="btn btn-outline-secondary btn-sm active" id="btnAllView" onclick="showAllProducts()">
            <i class="bi bi-list"></i> All
          </button>
          <button type="button" class="btn btn-outline-primary btn-sm" id="btnPhotoView" onclick="showPhotoProducts()">
            <i class="bi bi-images"></i> Photos
          </button>
          <button type="button" class="btn btn-outline-success btn-sm" id="btnGroupsView" onclick="showGroupsView()">
            <i class="bi bi-folder"></i> Groups
          </button>
        </div>
        
      </div>
    </div>
  </div>
</div>

<!-- Photo Product Grid (Hidden by default) -->
<div id="photoProductGrid" style="display:none; width:100%;">
  <!-- Photo grid content inserted here -->
</div>

<!-- Groups View Container (Hidden by default) -->
<div id="groupsViewContainer" style="display: none;">
  
  <!-- ===== GROUPS LIST VIEW ===== -->
  
  <!-- Header with Create Button -->
  <div id="groupsHeader" class="d-flex justify-content-between align-items-center mb-3">
    <h5 class="mb-0">Product Groups</h5>
    <button class="btn btn-success btn-sm" onclick="openCreateGroupModal()">
      <i class="bi bi-plus-circle"></i> New Group
    </button>
  </div>
  
  <!-- Search Groups -->
  <div id="searchGroupsContainer" class="mb-3">
    <input 
      type="text" 
      class="form-control" 
      id="searchGroups" 
      placeholder="üîç Search groups..." 
      oninput="filterProductGroups(this.value)"
    >
  </div>
  
  <!-- Loading State -->
  <div id="groupsLoadingState" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2">Loading groups...</p>
  </div>
  
  <!-- Empty State -->
  <div id="groupsEmptyState" class="text-center py-5" style="display: none;">
    <div style="font-size: 48px; margin-bottom: 16px;">üìÅ</div>
    <h4>No Product Groups Yet</h4>
    <p class="text-muted">Create groups to organize product variants</p>
    <button class="btn btn-primary mt-3" onclick="openCreateGroupModal()">
      <i class="bi bi-plus-circle"></i> Create First Group
    </button>
  </div>
  
  <!-- Groups List -->
  <div id="groupsListContainer" style="display: none;"></div>
  
  <!-- ===== VARIANTS VIEW ===== -->
  
  <!-- Header with Back Button -->
  <div id="variantsHeader" class="d-flex justify-content-between align-items-center mb-3" style="display: none !important;">
    <button class="btn btn-secondary btn-sm" onclick="backToGroupsList()">
      <i class="bi bi-arrow-left"></i> Back to Groups
    </button>
    <h5 class="mb-0" id="currentGroupName"></h5>
    <div style="width: 120px;"></div>
  </div>
  
  <!-- Search Variants -->
  <div id="searchVariantsContainer" class="mb-3" style="display: none;">
    <input 
      type="text" 
      class="form-control" 
      id="searchVariants" 
      placeholder="üîç Search variants..." 
      oninput="filterGroupVariants(this.value)"
    >
  </div>
  
  <!-- Loading State (Variants) -->
  <div id="variantsLoadingState" class="text-center py-5" style="display: none;">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2">Loading variants...</p>
  </div>
  
  <!-- Empty State (Variants) -->
  <div id="variantsEmptyState" class="text-center py-5" style="display: none;">
    <div style="font-size: 48px; margin-bottom: 16px;">üì¶</div>
    <h4>No Variants in This Group</h4>
    <p class="text-muted">This group doesn't have any variants yet</p>
  </div>
  
  <!-- Variants List -->
  <div id="variantsListContainer" style="display: none;"></div>
  
</div>
<!-- End Groups View Container -->

  
  

  
  <!-- Products table (desktop) & mobile list -->
<div class="row mb-4">
  <div class="col-12 desktop-table">
    <div class="table-explorer">
      <table class="table table-sm table-striped mb-0">
        <thead>
          <tr>
            <th style="width:80px">Photo</th>
            <th>Product</th>
            <th>Category</th>
            <th>Brand</th>
            <th>Size</th>
            <th style="width:140px">Stock</th>
            <th style="width:140px">Price</th>
            <th style="width:150px">Actions</th>
          </tr>
        </thead>
        <tbody id="productsTableBody"></tbody>
      </table>
    </div>
  </div>


      <div class="col-12 mobile-list" id="mobileProductsList" style="margin-top:6px;"></div>
    </div>



  
      
  <!-- Recent Sales -->
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4 class="mb-0">Recent Sales</h4>
            <button class="btn btn-outline-danger btn-sm" onclick="openClearSalesPopup()">
                <i class="bi bi-trash"></i> Clear Sales
            </button>
        </div>
        <div class="table-responsive">

          <table class="table table-striped">
            <thead class="table-primary"><tr><th>Date & Time</th><th>Product</th><th>Quantity</th><th>Unit</th><th>Amount</th></tr></thead>
            <tbody id="salesList"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

<!-- Recent Purchases -->
<div class="row mt-4">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4 class="mb-0">Recent Purchases</h4>
      <button class="btn btn-outline-success btn-sm" onclick="loadRecentPurchases()">
        <i class="bi bi-arrow-clockwise"></i> Refresh
      </button>
    </div>
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead class="table-success">
          <tr>
            <th>Serial No.</th>
            <th>Date & Time</th>
            <th>Photo</th>
            <th>Products</th>
            <th>Vendor</th>
            <th>Total Amount</th>
            <th>Payment Mode</th>
            <th>Other Info</th>
          </tr>
        </thead>
        <tbody id="purchasesList">
          <tr>
            <td colspan="8" style="text-align: center; padding: 20px; color: #999;">
              <i class="bi bi-hourglass-split"></i> Loading purchases...
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>


  

<!-- ‚úÖ NEW: All Products Page -->
<div class="page-view" id="allProductsPage">
  <div class="page-header">
    <button class="back-btn" onclick="navigateTo('dashboard')">
      <i class="bi bi-arrow-left"></i> Back
    </button>
    <h3>All Products</h3>
    <button class="btn btn-success" onclick="openAddProduct()">
      <i class="bi bi-plus-lg"></i> Add
    </button>
  </div>
  
  <!-- Search Bar -->
  <div class="mb-3">
    <input type="text" 
           class="form-control" 
           id="allProductsSearch" 
           placeholder="üîç Search products by name, category, brand..." 
           onkeyup="filterAllProducts()">
  </div>
  
  <!-- Filter Buttons -->
  <div class="mb-3 d-flex gap-2 flex-wrap">
    <button class="btn btn-sm btn-outline-primary" onclick="filterByCategory('all')">All</button>
    <button class="btn btn-sm btn-outline-primary" onclick="filterByCategory('Tiles')">Tiles</button>
    <button class="btn btn-sm btn-outline-primary" onclick="filterByCategory('Sanitaryware')">Sanitaryware</button>
    <button class="btn btn-sm btn-outline-primary" onclick="filterByCategory('Accessories')">Accessories</button>
  </div>
  
  <!-- Products List -->
  <div class="product-list-compact" id="allProductsList">
    <!-- Products will be rendered here -->
  </div>
</div>

<!-- ‚úÖ NEW: Product Groups Page -->
<div class="page-view" id="productGroupsPage">
  <div class="page-header">
       <button class="back-btn" onclick="navigateTo('dashboard')">
      <i class="bi bi-arrow-left"></i> Back
    </button>

    <h3>Products in Group</h3>
    <button class="btn btn-success" onclick="openCreateGroupModal()">
      <i class="bi bi-plus-lg"></i> Create
    </button>
  </div>
  
  <!-- Groups List -->
  <div id="productGroupsList">
    <!-- Groups will be rendered here -->
  </div>
  
  <!-- Empty State -->
  <div id="groupsEmptyState" style="display:none; text-align:center; padding:60px 20px;">
    <i class="bi bi-collection" style="font-size:64px; color:#ccc;"></i>
    <h4 style="margin-top:20px; color:#666;">No Product Groups Yet</h4>
    <p style="color:#999;">Create your first product group to manage variants</p>
    <button class="btn btn-primary mt-3" onclick="openCreateGroupModal()">
      <i class="bi bi-plus-lg"></i> Create First Group
    </button>
  </div>
</div>



<!-- ‚úÖ‚úÖ‚úÖ CUSTOMERS PAGE ‚úÖ‚úÖ‚úÖ -->
<div class="page-view" id="customersPage">
  <!-- Header -->
  <div class="page-header">
   <button class="back-btn" onclick="navigateTo('dashboard')">
    <i class="bi bi-arrow-left"></i> Back
  </button>
    <h3>Customers</h3>
    <button class="btn btn-success" onclick="openAddCustomerModal()">
      <i class="bi bi-plus-lg"></i> Add
    </button>
  </div>
  
  <!-- Search Box -->
  <div class="container-fluid" style="padding: 20px;">
    <input 
      type="text" 
      class="form-control mb-3" 
      id="searchCustomersInput" 
      placeholder="üîç Search customers..." 
      onkeyup="filterCustomers(this.value)"
      style="max-width: 600px; margin: 0 auto;"
    >
    
    <!-- Customers List Container -->
    <div id="customersListContainer">
      <!-- Customer cards will be rendered here by JavaScript -->
    </div>
    
    <!-- Empty State -->
    <div id="customersEmptyState" style="display:none; text-align:center; padding:60px 20px;">
      <i class="bi bi-people" style="font-size:64px; color:#ccc;"></i>
      <h4 style="margin-top:20px;">No Customers Yet</h4>
      <p>Add your first customer to get started</p>
      <button class="btn btn-primary mt-3" onclick="openAddCustomerModal()">
        <i class="bi bi-plus-lg"></i> Add First Customer
      </button>
    </div>
  </div>
</div>

  <!-- ‚úÖ‚úÖ‚úÖ BRANDS PAGE ‚úÖ‚úÖ‚úÖ -->
<div class="page-view" id="brandsPage">
  <!-- Header -->
  <div class="page-header">
    <button class="back-btn" onclick="navigateTo('dashboard')">
      <i class="bi bi-arrow-left"></i> Back
    </button>
    <h3>Brands</h3>
    <button class="btn btn-success" onclick="openAddBrandModal()">
      <i class="bi bi-plus-lg"></i> Add
    </button>
  </div>
  
  <!-- Search Box -->
  <div class="container-fluid" style="padding: 20px;">
    <input 
      type="text" 
      class="form-control mb-3" 
      id="searchBrandsInput" 
      placeholder="üîç Search brands..." 
      onkeyup="filterBrands(this.value)"
      style="max-width: 600px; margin: 0 auto;"
    >
    
    <!-- Brands List Container -->
    <div id="brandsListContainer">
      <!-- Brand cards will be rendered here by JavaScript -->
    </div>
    
    <!-- Empty State -->
    <div id="brandsEmptyState" style="display:none; text-align:center; padding:60px 20px;">
      <i class="bi bi-tags" style="font-size:64px; color:#ccc;"></i>
      <h4 style="margin-top:20px;">No Brands Yet</h4>
      <p>Add your first brand to get started</p>
      <button class="btn btn-primary mt-3" onclick="openAddBrandModal()">
        <i class="bi bi-plus-lg"></i> Add First Brand
      </button>
    </div>
  </div>
</div>



    
  <!--  Sales Modal -->
<div class="modal fade" id="clearSalesModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Clear Sales History</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">Clear sales records between specific dates:</p>
                
                <div class="mb-3">
                    <label class="form-label">From Date:</label>
                    <input type="date" class="form-control" id="clearFromDate" required>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">To Date:</label>
                    <input type="date" class="form-control" id="clearToDate" required>
                </div>
                
                <div class="alert alert-warning">
                    <i class="bi bi-exclamation-triangle"></i>
                    <strong>Note:</strong> This will clear sales from display only. 
                    Google Sheets data remains unchanged.
                </div>
                
                <div id="clearSalesCount" class="alert alert-info" style="display: none;">
                    <i class="bi bi-info-circle"></i>
                    Found <strong id="salesCountNumber">0</strong> sales records in this date range.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="clearSalesInDateRange()">
                    <i class="bi bi-trash"></i> Clear Sales
                </button>
            </div>
        </div>
    </div>
</div>


  <!-- INVOICE MODAL -->
<div class="modal fade" id="invoiceModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <i class="bi bi-receipt"></i> Create Invoice
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      
      <div class="modal-body">
        <form id="invoiceForm">
          
          <!-- Customer Name -->
          <div class="mb-3">
            <label class="form-label">Customer Name *</label>
            <input type="text" class="form-control" id="invoiceCustomerName" 
                   required placeholder="Enter customer name">
          </div>
          
          <!-- Invoice Details Row -->
          <div class="row mb-3">
            <div class="col-md-3">
              <label class="form-label">Invoice Number *</label>
              <div class="input-group">
                <input type="text" class="form-control" id="invoiceNumber" required readonly>
                <button class="btn btn-outline-secondary" type="button" 
                        onclick="regenerateInvoiceNumber()" title="Regenerate">
                  <i class="bi bi-arrow-clockwise"></i>
                </button>
              </div>
            </div>
            
            <div class="col-md-3">
              <label class="form-label">Invoice Date *</label>
              <input type="date" class="form-control" id="invoiceDate" required>
            </div>
            
            <div class="col-md-3">
              <label class="form-label">Payment Terms</label>
              <select class="form-select" id="paymentTerms" onchange="calculateDueDate()">
                <option value="0">Due on Receipt</option>
                <option value="7">Net 7</option>
                <option value="15" selected>Net 15</option>
                <option value="30">Net 30</option>
                <option value="45">Net 45</option>
                <option value="60">Net 60</option>
              </select>
            </div>
            
            <div class="col-md-3">
              <label class="form-label">Due Date</label>
              <input type="date" class="form-control" id="invoiceDueDate">
            </div>
          </div>
          
                       <!-- Invoice Items (Purchase-Style Layout) -->
          <div class="mb-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <h6 class="mb-0">
                <i class="bi bi-list-check"></i> Invoice Items
              </h6>
              <div>
                <button type="button" class="btn btn-sm btn-outline-primary me-2" onclick="addInvoiceRow()">
                  <i class="bi bi-plus-circle"></i> Add Row
                </button>
                <button type="button" class="btn btn-sm btn-outline-success" onclick="openBulkAddModal()">
                  <i class="bi bi-collection"></i> Add Items in Bulk
                </button>
              </div>
            </div>
            
            <!-- Items Container (No Table, Pure Grid like Purchase) -->
            <div id="invoiceItemsBody" style="
              display: flex;
              flex-direction: column;
              gap: 8px;
              padding: 10px;
              background: #f8f9fa;
              border-radius: 8px;
              border: 1px solid #dee2e6;
              max-height: 400px;
              overflow-y: auto;
            ">
              <!-- Rows populated dynamically by JavaScript -->
            </div>
          </div>



          
          
          <!-- Totals Section -->
          <div class="row">
            <div class="col-md-6"></div>
            <div class="col-md-6">
              <table class="table table-sm">
                <tr>
                  <td class="text-end"><strong>Sub Total:</strong></td>
                  <td class="text-end" style="width: 150px" id="invoiceSubtotal">‚Çπ0.00</td>
                </tr>
                <tr>
                  <td class="text-end">
                    <span class="me-2">Discount:</span>
                    <input type="number" class="form-control form-control-sm d-inline-block" 
                           style="width: 70px" id="invoiceDiscount" value="0" min="0" 
                           oninput="calculateInvoiceTotal()">
                    <select class="form-select form-select-sm d-inline-block" 
                            style="width: 60px" id="invoiceDiscountType" 
                            onchange="calculateInvoiceTotal()">
                      <option value="amount">‚Çπ</option>
                      <option value="percent">%</option>
                    </select>
                  </td>
                  <td class="text-end text-danger" id="invoiceDiscountAmount">-‚Çπ0.00</td>
                </tr>
                <tr>
                  <td class="text-end">
                    <span class="me-2">Tax (GST):</span>
                    <select class="form-select form-select-sm d-inline-block" 
                            style="width: 90px" id="invoiceTaxRate" 
                            onchange="calculateInvoiceTotal()">
                      <option value="0">No Tax</option>
                      <option value="5">5%</option>
                      <option value="12">12%</option>
                      <option value="18" selected>18%</option>
                      <option value="28">28%</option>
                    </select>
                  </td>
                  <td class="text-end" id="invoiceTaxAmount">‚Çπ0.00</td>
                </tr>
                <tr class="table-success fw-bold">
                  <td class="text-end"><h5 class="mb-0">Total (‚Çπ):</h5></td>
                  <td class="text-end"><h5 class="mb-0" id="invoiceGrandTotal">‚Çπ0.00</h5></td>
                </tr>
              </table>
            </div>
          </div>
          
          <!-- Customer Notes -->
          <div class="mb-3">
            <label class="form-label">Customer Notes</label>
            <textarea class="form-control" id="invoiceNotes" rows="2" 
                      placeholder="Add notes for customer (e.g., delivery instructions, thank you message)">Thanks for your business.</textarea>
            <small class="text-muted">Optional message to include on the invoice</small>
          </div>
          
          <!-- Terms & Conditions -->
          <div class="mb-3">
            <label class="form-label">
              Terms & Conditions
              <button type="button" class="btn btn-sm btn-link p-0" onclick="loadDefaultTerms()">
                <i class="bi bi-arrow-clockwise"></i> Use Default
              </button>
            </label>
            <textarea class="form-control" id="invoiceTerms" rows="4" 
                      placeholder="Enter payment terms and conditions"></textarea>
          </div>
          
        </form>
      </div>
      
      <div class="modal-footer">
  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
    <i class="bi bi-x-circle"></i> Close
  </button>
  <button type="button" class="btn btn-info" onclick="previewInvoice()">
    <i class="bi bi-eye"></i> Preview
  </button>
  
  <!-- √¢≈ì‚Ä¶ FIXED: Share Invoice Dropdown with proper attributes -->
  <div class="btn-group" role="group">
    <button type="button" class="btn btn-primary dropdown-toggle" 
            data-bs-toggle="dropdown" 
            aria-expanded="false">
      <i class="bi bi-share"></i> Share Invoice
    </button>
    <ul class="dropdown-menu">
      <li>
        <a class="dropdown-item" href="javascript:void(0);" onclick="shareInvoiceAsImage()">
          <i class="bi bi-image"></i> Share as Image (Recommended)
        </a>
      </li>
      <li>
        <a class="dropdown-item" href="javascript:void(0);" onclick="shareInvoiceAsPDF()">
          <i class="bi bi-file-pdf"></i> Share as PDF
        </a>
      </li>
      <li><hr class="dropdown-divider"></li>

 <!-- √¢≈ì‚Ä¶ NEW: Share image on specific WhatsApp number -->
  <li>
    <a class="dropdown-item" href="javascript:void(0);" onclick="shareImageToWhatsAppNumber()">
      <i class="bi bi-whatsapp text-success"></i> Share Image on WhatsApp
    </a>
  </li>
      
      <li>
        <a class="dropdown-item" href="javascript:void(0);" onclick="shareViaWhatsApp()">
          <i class="bi bi-whatsapp text-success"></i> WhatsApp (Text)
        </a>
      </li>
      <li>
        <a class="dropdown-item" href="javascript:void(0);" onclick="shareViaEmail()">
          <i class="bi bi-envelope"></i> Email (Text)
        </a>
      </li>
      <li>
        <a class="dropdown-item" href="javascript:void(0);" onclick="shareViaSMS()">
          <i class="bi bi-phone"></i> SMS (Text)
        </a>
      </li>
    </ul>
  </div>
  
  <button type="button" class="btn btn-success" onclick="saveInvoice()">
    <i class="bi bi-save"></i> Save Invoice
  </button>
</div>
      
    </div>
  </div>
</div>

<!-- VIEW INVOICES MODAL -->
<div class="modal fade" id="viewInvoicesModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">
          <i class="bi bi-receipt-cutoff"></i> Saved Invoices
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      
      <div class="modal-body">
        <div id="invoicesListContainer">
          <!-- Populated by JavaScript -->
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>



<!-- Add/Edit Product Modal -->
<div class="modal fade" id="productModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 id="modalTitle" class="modal-title">Add New Product</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      
      <div class="modal-body">
        <form id="productForm">
          <input type="hidden" id="productId">
          
          <!-- ‚úÖ PHOTO UPLOAD SECTION (TOP) -->
          <div class="row mb-3">
            <div class="col-12">
              <label class="form-label">Product Photo</label>
              
              <!-- Upload Area -->
              <div 
                id="productPhotoUploadArea"
                onclick="document.getElementById('productPhotoFileInput').click()"
                style="
                  border: 2px dashed #2196F3;
                  border-radius: 10px;
                  padding: 25px;
                  cursor: pointer;
                  transition: all 0.3s ease;
                  background: #f8f9ff;
                  text-align: center;
                ">
                <div style="font-size: 2.5rem; margin-bottom: 10px;">üì∑</div>
                <div style="color: #666; font-size: 0.95rem; font-weight: 500;">Click to upload or take photo</div>
                <div style="color: #999; font-size: 0.85rem; margin-top: 5px;">JPG, PNG (Max 5MB)</div>
              </div>
              
              <!-- Hidden File Input -->
              <input 
                type="file" 
                id="productPhotoFileInput" 
                accept="image/*" 
                style="display:none" 
                onchange="handleProductPhotoSelect(event)">
              
              <!-- Photo Preview -->
              <div id="productPhotoPreviewContainer" style="display: none; margin-top: 15px;">
                <div style="text-align: center;">
                  <img id="productPhotoPreviewImage" style="
                    max-width: 100%;
                    max-height: 200px;
                    border-radius: 8px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                    margin-bottom: 12px;
                    object-fit: cover;
                  ">
                </div>
                <div style="display: flex; gap: 8px; justify-content: center;">
                  <button type="button" class="btn btn-sm btn-warning" onclick="clearProductPhotoSelection()">
                    <i class="bi bi-arrow-counterclockwise"></i> Change Photo
                  </button>
                  <button type="button" class="btn btn-sm btn-secondary" onclick="removeProductPhoto()">
                    <i class="bi bi-trash"></i> Remove
                  </button>
                </div>
              </div>
            </div>
          </div>
          
          <!-- ESSENTIAL FIELDS -->
          <hr>
          
          <!-- Product Name & Category -->
          <div class="row mb-3">
            <div class="col-md-8">
              <label class="form-label">Product Name *</label>
              <input id="productName" class="form-control" required/>
            </div>
            <div class="col-md-4">
              <label class="form-label">Category *</label>
              <select id="category" class="form-select" required>
                <option value="">Select</option>
                <option value="Tiles">Tiles</option>
                <option value="Sanitaryware">Sanitaryware</option>
                <option value="Accessories">Accessories</option>
              </select>
            </div>
          </div>
          
        <!-- Unit Type, Price, Current Stock (OPTIONAL) -->
<div class="row mb-3">
  <div class="col-md-3">
    <label class="form-label">Unit Type *</label>
    <select id="unitType" class="form-select" required>
      <option value="Box">Box</option>
      <option value="Piece">Piece</option>
      <option value="SFT">Square Feet</option>
    </select>
  </div>
  <div class="col-md-3">
    <label class="form-label">Selling price *</label>
    <input id="price" class="form-control" type="number" step="0.01" required/>
  </div>
  <div class="col-md-3">
    <label class="form-label">Current Stock (Optional)</label>
    <input id="productCurrentStock" class="form-control" type="number" min="0" max="9999" placeholder="Leave empty"/>
    <small class="text-muted">For exact quantity</small>
  </div>
  <div class="col-md-3">
    <label class="form-label">Minimum Stock</label>
    <input id="minStock" class="form-control" type="number" value="5"/>
  </div>
</div>

<!-- Stock Status Selection -->
<div class="row mb-3">
  <div class="col-md-12">
    <label class="form-label">Stock Status *</label>
    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px;">
      <!-- Good -->
      <button type="button" class="btn stock-btn" 
              id="stockBtn-good" 
              onclick="selectStockStatus('good')"
              style="background: #28a745; color: white; padding: 10px; border-radius: 6px; font-weight: bold; border: 2px solid transparent; font-size: 12px;">
        üü¢ Good
      </button>
      
      <!-- Medium -->
      <button type="button" class="btn stock-btn" 
              id="stockBtn-medium" 
              onclick="selectStockStatus('medium')"
              style="background: #ffc107; color: black; padding: 10px; border-radius: 6px; font-weight: bold; border: 2px solid transparent; font-size: 12px;">
        üü° Medium
      </button>
      
      <!-- Low -->
      <button type="button" class="btn stock-btn" 
              id="stockBtn-low" 
              onclick="selectStockStatus('low')"
              style="background: #dc3545; color: white; padding: 10px; border-radius: 6px; font-weight: bold; border: 2px solid transparent; font-size: 12px;">
        üî¥ Low
      </button>
      
      <!-- Urgent -->
      <button type="button" class="btn stock-btn" 
              id="stockBtn-urgent" 
              onclick="selectStockStatus('urgent')"
              style="background: #6f42c1; color: white; padding: 10px; border-radius: 6px; font-weight: bold; border: 2px solid transparent; font-size: 12px;">
        üîµ Urgent
      </button>
    </div>
    
    <!-- Hidden input to track selected status -->
    <input type="hidden" id="selectedStockStatus" value="">
  </div>
</div>


          
          <!-- ‚úÖ ADVANCED OPTIONS (EXPANDABLE) -->
          <div style="margin-bottom: 15px;">
            <button 
              type="button" 
              class="btn btn-link btn-sm" 
              onclick="toggleAdvancedOptions()"
              style="padding: 0; text-decoration: none;">
              <i class="bi bi-chevron-down" id="advOptionsIcon"></i>
              <span style="color: #007bff; font-weight: 500;">+ Advanced Options</span>
            </button>
          </div>
          
          <!-- Advanced Options Container (Hidden by default) -->
          <div id="advancedOptionsContainer" style="display: none; background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #007bff; margin-bottom: 15px;">
            
            <!-- Brand & Size -->
            <div class="row mb-3">
              <!-- Brand Field -->
              <div class="col-md-6" style="position: relative;">
                <label class="form-label">Brand</label>
                
                <!-- Input Field Container -->
                <div style="position: relative;">
                  <input 
                    id="brand" 
                    class="form-control" 
                    type="text"
                    autocomplete="off"
                    oninput="filterBrandSuggestions(this.value); checkAndShowSaveBrandButton(this.value)"
                    onfocus="showBrandSuggestions()"
                    onblur="setTimeout(() => hideBrandSuggestions(), 200)"
                    placeholder="Type to search brands..."
                    style="padding-right: 40px;">
                  
                  <!-- üíæ Save Brand Button (Inside Field) -->
                  <button id="saveBrandInsideBtn" 
                    type="button"
                    onclick="saveNewBrandFromProductField()"
                    style="
                      display: none;
                      position: absolute;
                      right: 8px;
                      top: 50%;
                      transform: translateY(-50%);
                      background: #28a745;
                      color: white;
                      border: none;
                      padding: 6px 10px;
                      border-radius: 4px;
                      cursor: pointer;
                      font-size: 14px;
                      font-weight: bold;
                      transition: all 0.2s;
                      z-index: 10;
                    "
                    onmouseover="this.style.background='#218838'"
                    onmouseout="this.style.background='#28a745'"
                    title="Save this brand">
                    üíæ
                  </button>
                </div>
                
                <!-- Brand Suggestions Dropdown -->
                <div id="brandSuggestionsDropdown" style="
                  display: none;
                  position: absolute;
                  top: 100%;
                  left: 0;
                  right: 0;
                  background: white;
                  border: 1px solid #ddd;
                  border-top: none;
                  max-height: 200px;
                  overflow-y: auto;
                  z-index: 1000;
                  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
                  margin-top: -1px;
                ">
                  <!-- Suggestions rendered here -->
                </div>
              </div>
              
              <!-- Size Field -->
              <div class="col-md-6">
                <label class="form-label">Size</label>
                <input id="size" class="form-control" placeholder="e.g., 2x2 feet or Standard"/>
              </div>
            </div>
            
            <!-- Pieces per Box & SFT per Box -->
            <div class="row mb-0">
              <div class="col-md-6">
                <label class="form-label">Pieces per Box</label>
                <input id="piecesPerBox" class="form-control" type="number" value="1"/>
              </div>
              <div class="col-md-6">
                <label class="form-label">SFT per Box</label>
                <input id="sftPerBox" class="form-control" type="number" step="0.01"/>
              </div>
            </div>
            
          </div>
          
        </form>
      </div>
      
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" onclick="saveProduct()">Save Product</button>
      </div>
    </div>
  </div>
</div>



  <!-- SALES MODAL (grid) - top buttons removed, kept within body below grid -->
  <div class="modal fade" id="salesModal" tabindex="-1"><div class="modal-dialog modal-xl"><div class="modal-content">
    <div class="modal-header bg-info text-white">
      <h5 class="modal-title">Record New Sale</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
    </div>

    <div class="modal-body">

      <!-- √É∆í√Ç¬¢√É‚Ä¶√¢‚Ç¨≈ì√É¬¢√¢‚Äö¬¨√Ç¬¶ NEW: Multi-Select Product Picker -->
  <div class="mb-3">
    <label class="form-label fw-bold">
      <i class="bi bi-lightning-charge-fill text-warning"></i> Quick Add Products (Multi-Select)
    </label>
    <div class="multi-select-dropdown">
      <button type="button" class="form-control text-start multi-select-toggle" id="multiSelectToggle" onclick="toggleMultiSelect()">
        <span id="multiSelectLabel">Click to select multiple products...</span>
        <i class="bi bi-chevron-down float-end"></i>
      </button>
      <div class="multi-select-options" id="multiSelectOptions">
        <input type="text" class="form-control form-control-sm mb-2" 
               placeholder="√É∆í√Ç¬∞√É‚Ä¶√Ç¬∏√É¬¢√¢‚Äö¬¨√Ç¬ù√É‚Äö√Ç¬ç Search products..." 
               id="multiSelectSearch" 
               oninput="filterMultiSelectOptions()">
        <div class="multi-select-list" id="multiSelectList">
          <!-- Checkboxes populated by JS -->
        </div>
      </div>
    </div>
    <small class="text-muted">Select multiple products to auto-fill rows below</small>
  </div>



      
      <!-- NEW: Buttons at TOP -->
  <div class="mb-3 text-end">
    <button class="btn btn-outline-primary btn-sm me-2" onclick="addMoreRows()">
      <i class="bi bi-plus-circle"></i> Add More Rows
    </button>


    <!-- ‚úÖ NEW: Add Products in Bulk Button (EXACTLY LIKE INVOICE) -->
  <button class="btn btn-outline-success btn-sm" onclick="openBulkAddModalForSale()">
    <i class="bi bi-collection"></i> Add Products in Bulk
  </button>

    
    <button class="btn btn-outline-success btn-sm" onclick="openCustomProductPopup()">
      <i class="bi bi-pencil-square"></i> Add Custom Product
    </button>
  </div>
      <div class="table-responsive">
        <table class="table table-sm grid-table mb-0">
          <thead><tr><th class="grid-row-number">#</th><th>Product Name</th><th style="width:130px">Size</th><th style="width:90px">Qty</th><th style="width:110px">Unit</th><th style="width:120px">Price</th><th style="width:140px">Total</th><th style="width:60px"></th></tr></thead>
          <tbody id="product-grid-body"></tbody>
        </table>
      </div>

      <!-- Keep Add buttons only here (below grid) -->
      <div class="mt-3 d-flex justify-content-between align-items-center">
        <div>
          <button class="btn btn-outline-primary btn-sm" onclick="addMoreRows()"><i class="bi bi-plus-circle"></i> Add More Rows</button>
          <button class="btn btn-outline-success btn-sm ms-2" onclick="openCustomProductPopup()"><i class="bi bi-pencil-square"></i> Add Custom Product</button>
        </div>
        <div class="text-end" style="min-width:320px;">
          <table class="table table-borderless mb-0">
            <tr><td class="text-end small-muted"><strong>Subtotal:</strong></td><td id="subtotal" class="text-end">‚Çπ0.00</td></tr>
            <tr style="font-size:1.25rem;color:#28a745"><td class="text-end"><strong>GRAND TOTAL:</strong></td><td id="grandTotal" class="text-end">‚Çπ0.00</td></tr>
          </table>
        </div>
      </div>
    </div>

   <div class="modal-footer">
  <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
  <button class="btn btn-info" onclick="generateInvoice()">
    <i class="bi bi-receipt"></i> Generate Invoice
  </button>
  <button class="btn btn-success" onclick="completeSale()">Complete Sale</button>
</div>

  </div></div></div>

  <!-- CUSTOM PRODUCT MODAL (NEW fields) -->
  <div class="modal fade" id="customProductModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title">Add Custom Product</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <form id="customProductForm">
        <div class="mb-3"><label class="form-label">Product Name *</label><input id="customName" class="form-control" required/></div>
        <div class="mb-3"><label class="form-label">Size</label><input id="customSize" class="form-control" placeholder="e.g., 3x3 feet or Standard"/></div>
        <div class="row">
        
          <div class="col-md-6 mb-3"><label class="form-label">Unit Type *</label><select id="customUnit" class="form-select"><option>Box</option><option>Piece</option><option>SFT</option></select></div>
        </div>
        <div class="mb-3"><label class="form-label">Unit Price *</label><input id="customPrice" type="number" class="form-control" min="0.01" step="0.01" value="0"/></div>
         <div class="col-md-6 mb-3"><label class="form-label">Quantity (for this sale) *</label><input id="customQty" type="number" class="form-control" min="1" value="1"/></div>


        <div class="mb-3"><label class="form-label">Total</label><div id="customTotal" class="fw-bold">‚Çπ0.00</div></div>
      </form>
    </div>

<!-- INVOICE MODAL -->
<div class="modal fade" id="invoiceModal" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">Create Invoice</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      
      <div class="modal-body">
        <form id="invoiceForm">
          
          <!-- Customer Name -->
          <div class="mb-3">
            <label class="form-label">Customer Name *</label>
            <input type="text" class="form-control" id="invoiceCustomerName" required placeholder="Enter customer name">
          </div>
          
          <!-- Invoice Details Row -->
          <div class="row mb-3">
            <div class="col-md-3">
              <label class="form-label">Invoice Number *</label>
              <div class="input-group">
                <input type="text" class="form-control" id="invoiceNumber" required readonly>
                <button class="btn btn-outline-secondary" type="button" onclick="regenerateInvoiceNumber()" title="Regenerate">
                  <i class="bi bi-arrow-clockwise"></i>
                </button>
              </div>
            </div>
            
            <div class="col-md-3">
              <label class="form-label">Invoice Date *</label>
              <input type="date" class="form-control" id="invoiceDate" required>
            </div>
            
            <div class="col-md-3">
              <label class="form-label">Payment Terms</label>
              <select class="form-select" id="paymentTerms" onchange="calculateDueDate()">
                <option value="0">Due on Receipt</option>
                <option value="7">Net 7</option>
                <option value="15" selected>Net 15</option>
                <option value="30">Net 30</option>
                <option value="45">Net 45</option>
                <option value="60">Net 60</option>
              </select>
            </div>
            
            <div class="col-md-3">
              <label class="form-label">Due Date</label>
              <input type="date" class="form-control" id="invoiceDueDate">
            </div>
          </div>
          
          <!-- Items Table -->
          <div class="mb-3">
            <h6>Invoice Items</h6>
            <div class="table-responsive">
              <table class="table table-bordered table-sm">
                <thead class="table-light">
                  <tr>
                    <th style="width: 40%">Item Details</th>
                    <th style="width: 15%">Quantity</th>
                    <th style="width: 15%">Rate</th>
                    <th style="width: 20%">Amount</th>
                    <th style="width: 10%"></th>
                  </tr>
                </thead>
                <tbody id="invoiceItemsBody">
                  <!-- Populated by JavaScript -->
                </tbody>
              </table>
            </div>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="addInvoiceRow()">
              <i class="bi bi-plus-circle"></i> Add Row
            </button>
          </div>
          
          <!-- Totals Section -->
          <div class="row">
            <div class="col-md-7"></div>
            <div class="col-md-5">
              <table class="table table-sm">
                <tr>
                  <td class="text-end"><strong>Sub Total:</strong></td>
                  <td class="text-end" id="invoiceSubtotal">‚Çπ0.00</td>
                </tr>
                <tr>
                  <td class="text-end">
                    Discount:
                    <input type="number" class="form-control form-control-sm d-inline-block" 
                           style="width: 80px" id="invoiceDiscount" value="0" min="0" 
                           oninput="calculateInvoiceTotal()">
                    <select class="form-select form-select-sm d-inline-block" 
                            style="width: 60px" id="invoiceDiscountType" 
                            onchange="calculateInvoiceTotal()">
                      <option value="amount">‚Çπ</option>
                      <option value="percent">%</option>
                    </select>
                  </td>
                  <td class="text-end text-danger" id="invoiceDiscountAmount">-‚Çπ0.00</td>
                </tr>
                <tr>
                  <td class="text-end">
                    Tax:
                    <select class="form-select form-select-sm d-inline-block" 
                            style="width: 100px" id="invoiceTaxRate" 
                            onchange="calculateInvoiceTotal()">
                      <option value="0">No Tax</option>
                      <option value="5">GST 5%</option>
                      <option value="12">GST 12%</option>
                      <option value="18" selected>GST 18%</option>
                      <option value="28">GST 28%</option>
                    </select>
                  </td>
                  <td class="text-end" id="invoiceTaxAmount">‚Çπ0.00</td>
                </tr>
                <tr class="table-success">
                  <td class="text-end"><h5>Total (‚Çπ):</h5></td>
                  <td class="text-end"><h5 id="invoiceGrandTotal">‚Çπ0.00</h5></td>
                </tr>
              </table>
            </div>
          </div>
          
          <!-- Customer Notes -->
          <div class="mb-3">
            <label class="form-label">Customer Notes</label>
            <textarea class="form-control" id="invoiceNotes" rows="2" 
                      placeholder="Add notes for customer...">Thanks for your business.</textarea>
          </div>
          
          <!-- Terms & Conditions -->
          <div class="mb-3">
            <label class="form-label">
              Terms & Conditions
              <button type="button" class="btn btn-sm btn-link" onclick="loadDefaultTerms()">Use Default</button>
            </label>
            <textarea class="form-control" id="invoiceTerms" rows="3" 
                      placeholder="Enter terms and conditions"></textarea>
          </div>
          
        </form>
      </div>
      
      <div class="modal-footer">
  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
    <i class="bi bi-x-circle"></i> Close
  </button>
  <button type="button" class="btn btn-info" onclick="previewInvoice()">
    <i class="bi bi-eye"></i> Preview
  </button>
  
  <!-- √¢≈ì‚Ä¶ NEW: Share Invoice Dropdown -->
  <div class="btn-group">
    <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">
      <i class="bi bi-share"></i> Share Invoice
    </button>
    <ul class="dropdown-menu">
      <li>
        <a class="dropdown-item" href="#" onclick="shareInvoiceAsImage(); return false;">
          <i class="bi bi-image"></i> Share as Image (Recommended)
        </a>
      </li>
      <li>
        <a class="dropdown-item" href="#" onclick="shareInvoiceAsPDF(); return false;">
          <i class="bi bi-file-pdf"></i> Share as PDF
        </a>
      </li>
      <li><hr class="dropdown-divider"></li>
      <li>
        <a class="dropdown-item" href="#" onclick="shareViaWhatsApp(); return false;">
          <i class="bi bi-whatsapp text-success"></i> WhatsApp (Text)
        </a>
      </li>
      <li>
        <a class="dropdown-item" href="#" onclick="shareViaEmail(); return false;">
          <i class="bi bi-envelope"></i> Email (Text)
        </a>
      </li>
      <li>
        <a class="dropdown-item" href="#" onclick="shareViaSMS(); return false;">
          <i class="bi bi-phone"></i> SMS (Text)
        </a>
      </li>
    </ul>
  </div>
  
  <button type="button" class="btn btn-success" onclick="saveInvoice()">
    <i class="bi bi-save"></i> Save Invoice
  </button>
</div>

      
    </div>
  </div>
</div>

    
    <div class="modal-footer">
      <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      <button class="btn btn-success" onclick="addCustomProductToGrid()">Add to Sale</button>
    </div>
  </div></div></div>




<!-- ==========================================
     PRODUCT GROUPS - CREATE GROUP MODAL (MOBILE-OPTIMIZED)
     ========================================== -->

<div class="fullscreen-modal" id="createGroupModal">
  <div class="modal-header-mobile">
    <button class="btn-cancel-modal" onclick="closeCreateGroupModal()">
      ‚úï Cancel
    </button>
    <h3>New Item Group</h3>
    <div style="width: 80px;"></div> <!-- Spacer for centering -->
  </div>
  
  <form id="createGroupForm" class="mobile-form" onsubmit="handleCreateGroup(event)">
    
    <!-- Basic Information Section -->
    <div class="form-section">
      <div class="section-title">Basic Information</div>
      
      <label class="form-label">
        Item Group Name <span class="required">*</span>
      </label>
      <input 
        type="text" 
        id="groupName" 
        name="groupName"
        placeholder="e.g., T-Shirts, Tiles, Sanitaryware" 
        required
        autocomplete="off">
      
      <label class="form-label">Description</label>
      <textarea 
        id="groupDescription" 
        name="groupDescription"
        placeholder="Optional: Add a description for this group"
        rows="3"></textarea>
      
      <label class="form-label">Manufacturer / Brand</label>
      <input 
        type="text" 
        id="groupManufacturer" 
        name="groupManufacturer"
        placeholder="e.g., Nike, Somany"
        autocomplete="off">
      
      <label class="form-label">Category</label>
      <select id="groupCategory" name="groupCategory">
        <option value="">Select Category</option>
        <option value="Tiles">Tiles</option>
        <option value="Sanitaryware">Sanitaryware</option>
        <option value="Accessories">Accessories</option>
        <option value="Apparel">Apparel</option>
        <option value="Custom">Custom</option>
      </select>
    </div>
    
    <!-- Attributes Section -->
    <div class="form-section">
      <div class="section-title">Create Attributes & Options</div>
      <div class="section-description">
        Add attributes like Size, Color, Material, etc. Each combination will create a variant.
      </div>
      
      <div id="attributesContainer">
        <!-- Attribute rows will be added here dynamically -->
      </div>
      
      <button type="button" class="btn-add-more" onclick="addAttributeRow()">
        ‚ûï Add Attribute
      </button>
    </div>
    
    <!-- Variant Preview Section -->
    <div class="form-section">
      <div class="variant-preview-section">
        <div class="variant-count-badge">
          <span id="variantCount">0</span> Variants Will Be Created
        </div>
        <div class="variant-preview-list" id="variantPreviewContainer">
          <div class="variant-preview-item">
            Add attributes to see preview...
          </div>
        </div>
      </div>
    </div>
    
    <!-- Fixed Bottom Actions -->
    <div class="form-actions-bottom">
      <button type="button" class="btn-secondary-bottom" onclick="closeCreateGroupModal()">
        Cancel
      </button>
      <button type="submit" class="btn-primary-bottom" id="btnSaveGroup">
        üíæ Save & Generate
      </button>
    </div>
    
  </form>
</div>


<!-- ==========================================
     PRODUCT GROUPS - EDIT VARIANT MODAL (MOBILE-OPTIMIZED)
     ========================================== -->

<div class="fullscreen-modal" id="editVariantModal">
  <div class="modal-header-mobile">
    <button class="btn-cancel-modal" onclick="closeEditVariantModal()">
      ‚úï Cancel
    </button>
    <h3>Edit Variant</h3>
    <div style="width: 80px;"></div>
  </div>
  
  <form id="editVariantForm" class="mobile-form" onsubmit="handleUpdateVariant(event)">
    <input type="hidden" id="editVariantId">
    <input type="hidden" id="editVariantGroupId">
    
    <!-- Variant Info (Read-only) -->
    <div class="form-section">
      <div class="section-title">Variant Information</div>
      
      <label class="form-label">Variant Name</label>
      <input 
        type="text" 
        id="editVariantName" 
        readonly
        style="background: #f5f5f5; color: #666;">
      
      <label class="form-label">Attributes</label>
      <div id="editVariantAttributes" style="padding: 12px; background: #f5f5f5; border-radius: 8px; font-size: 14px; color: #666;">
        <!-- Attributes will be displayed here -->
      </div>
    </div>
    
    <!-- Pricing Section -->
    <div class="form-section">
      <div class="section-title">Pricing</div>
      
      <label class="form-label">Cost Price</label>
      <input 
        type="number" 
        id="editVariantCostPrice" 
        name="costPrice"
        placeholder="0.00"
        step="0.01"
        min="0">
      
      <label class="form-label">Selling Price <span class="required">*</span></label>
      <input 
        type="number" 
        id="editVariantSellingPrice" 
        name="sellingPrice"
        placeholder="0.00"
        step="0.01"
        min="0"
        required>
    </div>
    
    <!-- Inventory Section -->
    <div class="form-section">
      <div class="section-title">Inventory</div>
      
      <label class="form-label">Stock Quantity <span class="required">*</span></label>
      <input 
        type="number" 
        id="editVariantStock" 
        name="stock"
        placeholder="0"
        min="0"
        required>
      
      <label class="form-label">Minimum Stock Alert</label>
      <input 
        type="number" 
        id="editVariantMinStock" 
        name="minStock"
        placeholder="0"
        min="0">
      
      <label class="form-label">Unit Type</label>
      <select id="editVariantUnitType" name="unitType">
        <option value="Piece">Piece</option>
        <option value="Box">Box</option>
        <option value="SFT">SFT</option>
        <option value="Set">Set</option>
        <option value="Unit">Unit</option>
      </select>
    </div>
    
    <!-- Fixed Bottom Actions -->
    <div class="form-actions-bottom">
      <button type="button" class="btn-secondary-bottom" onclick="closeEditVariantModal()">
        Cancel
      </button>
      <button type="submit" class="btn-primary-bottom">
        üíæ Save Changes
      </button>
    </div>
    
  </form>
</div>


<!-- ==========================================
     SUCCESS MESSAGE OVERLAY
     ========================================== -->

<div class="success-overlay" id="successOverlay">
  <div style="font-size: 32px; margin-bottom: 8px;">‚úÖ</div>
  <div id="successMessage">Success!</div>
</div>

  

  <!-- Hidden file input for import -->
  <input type="file" id="fileInput" accept=".json" style="display:none" onchange="handleFileImport(event)">



    <!-- √¢≈ì‚Ä¶ NEW: Photo Product Modal -->
<div class="modal fade" id="photoProductModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">√∞≈∏‚Äú‚Ä¢ Add Product by Photo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        
        <!-- Photo Upload Area -->
        <div class="upload-area" id="photoUploadArea" onclick="document.getElementById('photoFileInput').click()">
          <div class="upload-icon">√∞≈∏‚Äú‚Ä¢</div>
          <div class="upload-text">Click to take photo or select from gallery</div>
        </div>
        
        <!-- Hidden file inputs -->
        <input type="file" id="photoFileInput" accept="image/*" style="display:none" onchange="handlePhotoSelect(event)">
        <input type="file" id="photoCameraInput" accept="image/*" capture="environment" style="display:none" onchange="handlePhotoSelect(event)">
        
        <!-- Photo Preview -->
        <div id="photoPreviewContainer" class="preview-container">
          <img id="photoPreviewImage" class="preview-image" alt="Product Photo">
          <button type="button" class="btn btn-sm btn-warning" onclick="clearPhotoSelection()">Change Photo</button>
        </div>
        
        <!-- Loading Spinner -->
        <div id="photoLoadingSpinner" class="loading-spinner">
          <div class="spinner"></div>
          <p>Uploading photo...</p>
        </div>
        
        <!-- Product Details Form -->
        <div class="mb-3">
          <label class="form-label">Product Name <span class="text-danger">*</span></label>
          <input type="text" id="photoProductName" class="form-control" placeholder="e.g., White Marble Tile" required>
        </div>
        
        <div class="row">
          <div class="col-6 mb-3">
            <label class="form-label">Brand</label>
            <input type="text" id="photoProductBrand" class="form-control" placeholder="Optional">
          </div>
          <div class="col-6 mb-3">
            <label class="form-label">Size</label>
            <input type="text" id="photoProductSize" class="form-control" placeholder="e.g., 2x2">
          </div>
        </div>
        
        <div class="row">
          <div class="col-6 mb-3">
            <label class="form-label">Current Stock</label>
            <input type="number" id="photoProductStock" class="form-control" min="0" placeholder="0">
          </div>
          <div class="col-6 mb-3">
            <label class="form-label">Unit Price (‚Çπ)</label>
            <input type="number" id="photoProductPrice" class="form-control" min="0" step="0.01" placeholder="0.00">
          </div>
        </div>
        
        <div class="alert alert-info">
          <small><i class="bi bi-info-circle"></i> Only products with stock and price can be sold.</small>
        </div>
        
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="savePhotoProduct()">
          <i class="bi bi-check-circle"></i> Save Product
        </button>
      </div>
    </div>
  </div>
</div>

<!-- √¢≈ì‚Ä¶ NEW: View Photo Modal (Enlarged View) -->
<div class="modal fade" id="viewPhotoModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="viewPhotoModalTitle">Product Photo</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="viewPhotoModalBody">
        <!-- Content will be dynamically loaded -->
      </div>
    </div>
  </div>
</div>


  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script src="brand-manager.js"></script>

  <script>

// ==========================================
// FIREBASE AUTHENTICATION
// ==========================================

let currentUser = null;
let userEmail = null;
    
 // ==========================================
// FIREBASE CONFIGURATION
// ==========================================
// Firebase imports are in <head> section - no need to redeclare here
// Access via: window.db, window.auth, window.firebaseImports

// Get current user ID (for multi-tenancy)
function getCurrentUserId() {
  const user = window.auth.currentUser;
  return user ? user.uid : null;
}

// Get tenant collection path
function getTenantCollection(collectionName) {
  const userId = getCurrentUserId();
  if (!userId) {
    throw new Error('User not authenticated');
  }
  return `tenants/${userId}/${collectionName}`;
}


    
  let cachedProducts = [];
  let cachedSales = [];

 // ‚úÖ NEW: Product Groups cache
let cachedProductGroups = [];
let cachedGroupVariants = [];

// ‚úÖ NEW: Page state management
let currentPage = 'home'; // home, allProducts, productGroups, groupDetail
let currentGroupId = null; // For group detail view

// ‚úÖ PRODUCT PHOTO VARIABLES
let productPhotoBase64 = null;
let productPhotoFileName = null;








let deletedSaleIds = []; // NEW: Track manually deleted sales

// NEW: Load deleted IDs from localStorage on page load
try {
    const stored = localStorage.getItem('deletedSaleIds');
    if (stored) {
        deletedSaleIds = JSON.parse(stored);
        console.log('√É∆í√Ü‚Äô√É‚Äö√Ç¬∞√É∆í√¢‚Ç¨¬¶√É‚Äö√Ç¬∏√É∆í√Ç¬¢√É¬¢√¢‚Ç¨≈°√Ç¬¨√É‚Ä¶√¢‚Ç¨≈ì√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬ù Loaded', deletedSaleIds.length, 'deleted sale IDs from localStorage');
    }
} catch (e) {
    console.warn('Could not load deletedSaleIds from localStorage', e);
}
    
  let hasInitialLoaded = false;

  // Keep custom products added into the current sale (persist across grid re-builds)
  let customProductsInSale = []; // { id, name, size, unitType, price, quantity, isPersistedToInventory:false/true, tempProductId }




/**
 * Handle Email + Password Sign In
 */
async function handleEmailPasswordAuth(event) {
  event.preventDefault();
  
  const emailInput = document.getElementById('userEmailInput');
  const passwordInput = document.getElementById('userPasswordInput');
  const signInBtn = document.getElementById('signInBtn');
  
  const email = emailInput?.value?.trim();
  const password = passwordInput?.value;
  
  // Validation
  if (!email || !password) {
    alert('Please enter both email and password');
    return;
  }
  
  // Disable button during login
  if (signInBtn) {
    signInBtn.disabled = true;
    signInBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Signing in...';
  }
  
  try {
    console.log('üîê Attempting to sign in with:', email);
    
    // Use Firebase Auth from window.firebaseImports
    const { signInWithEmailAndPassword } = window.firebaseImports;
    const userCredential = await signInWithEmailAndPassword(window.auth, email, password);
    
    console.log('‚úÖ Sign in successful!', userCredential.user.email);
    
    // Auth state listener will handle showing the app automatically
    // No need to manually call showApp() here
    
  } catch (error) {
    console.error('‚ùå Sign in error:', error);
    
    // User-friendly error messages
    let errorMessage = 'Login failed. Please try again.';
    
    if (error.code === 'auth/wrong-password') {
      errorMessage = 'Incorrect password. Please try again.';
    } else if (error.code === 'auth/user-not-found') {
      errorMessage = 'No account found with this email. Please sign up first.';
    } else if (error.code === 'auth/invalid-email') {
      errorMessage = 'Invalid email address.';
    } else if (error.code === 'auth/too-many-requests') {
      errorMessage = 'Too many failed attempts. Please try again later.';
    } else if (error.code === 'auth/invalid-credential') {
      errorMessage = 'Invalid email or password. Please check and try again.';
    }
    
    alert(errorMessage);
    
    // Re-enable button
    if (signInBtn) {
      signInBtn.disabled = false;
      signInBtn.innerHTML = '<i class="bi bi-box-arrow-in-right me-2"></i>Sign In';
    }
  }
}


    /**
 * Handle Sign Up (Create Account)
 */
async function handleSignUp(event) {
  event.preventDefault();
  
  const emailInput = document.getElementById('signUpEmailInput');
  const passwordInput = document.getElementById('signUpPasswordInput');
  const signUpBtn = document.getElementById('signUpBtn');
  
  const email = emailInput?.value?.trim();
  const password = passwordInput?.value;
  
  // Validation
  if (!email || !password) {
    alert('Please enter both email and password');
    return;
  }
  
  if (password.length < 6) {
    alert('Password must be at least 6 characters long');
    return;
  }
  
  // Disable button
  if (signUpBtn) {
    signUpBtn.disabled = true;
    signUpBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Creating account...';
  }
  
  try {
    console.log('üìù Creating account for:', email);
    
    const { createUserWithEmailAndPassword } = window.firebaseImports;
    const userCredential = await createUserWithEmailAndPassword(window.auth, email, password);
    
    console.log('‚úÖ Account created successfully!', userCredential.user.email);
    alert('Account created successfully! Welcome!');
    
    // Auth state listener will handle showing the app automatically
    
  } catch (error) {
    console.error('‚ùå Sign up error:', error);
    
    let errorMessage = 'Failed to create account.';
    
    if (error.code === 'auth/email-already-in-use') {
      errorMessage = 'An account with this email already exists. Please sign in instead.';
    } else if (error.code === 'auth/invalid-email') {
      errorMessage = 'Invalid email address.';
    } else if (error.code === 'auth/weak-password') {
      errorMessage = 'Password is too weak. Please use at least 6 characters.';
    }
    
    alert(errorMessage);
    
    // Re-enable button
    if (signUpBtn) {
      signUpBtn.disabled = false;
      signUpBtn.innerHTML = '<i class="bi bi-person-plus me-2"></i>Sign Up';
    }
  }
}




  /***********************
   * Helpers
   ***********************/
  function showSyncIndicator(msg='Syncing...', hideAfterMs=null) {
    const el = document.getElementById('syncIndicator');
    document.getElementById('syncText').textContent = msg;
    el.style.display = 'block';
    if (hideAfterMs) setTimeout(()=> el.style.display = 'none', hideAfterMs);
  }
  function hideSyncIndicator(){ document.getElementById('syncIndicator').style.display='none'; }

  function safeParseResponse(res) {
    return res.text().then(txt => {
      try { return { ok: res.ok, json: JSON.parse(txt), text: txt }; }
      catch(e) { return { ok: res.ok, json: null, text: txt }; }
    });
  }
  function formatCurrency(n){ return '‚Çπ' + Number(n||0).toLocaleString('en-IN',{minimumFractionDigits:2,maximumFractionDigits:2}); }
  function generateId(){ return 'TMP_' + Date.now().toString(36) + Math.random().toString(36).substr(2); }
  function escapeHtml(s){ if (s===null||s===undefined) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }




/**
 * ==========================================
 * SYNC FROM FIRESTORE - KEEP LATEST VERSION
 * ==========================================
 */

async function syncFromFirestore() {
  const user = window.auth.currentUser;
  
  if (!user) {
    console.warn('‚ö†Ô∏è No user authenticated');
    showAuthScreen();
    return;
  }

  showSyncIndicator('Refreshing...');
  
  try {
    const { collection, getDocs, query, orderBy } = window.firebaseImports;
    const userId = user.uid;
    
    console.log('üîÑ Syncing data for user:', userId);
    
    // ‚úÖ Fetch products from Firestore
    const productsRef = collection(window.db, 'tenants', userId, 'products');
    const productsSnap = await getDocs(productsRef);
    
    // ‚úÖ STEP 1: Collect all products
    const allProducts = [];
    productsSnap.forEach((doc) => {
      allProducts.push({
        id: doc.id,
        ...doc.data()
      });
    });
    
    console.log(`üì¶ Fetched ${allProducts.length} products from Firestore`);
    
    // ‚úÖ STEP 2: Remove duplicates - KEEP LATEST BY updatedAt
    const uniqueProductsMap = new Map();
    
    allProducts.forEach(product => {
      const existingProduct = uniqueProductsMap.get(product.id);
      
      if (!existingProduct) {
        // First time seeing this ID - add it
        uniqueProductsMap.set(product.id, product);
      } else {
        // Duplicate ID found - keep the one with latest updatedAt
        const existingTime = existingProduct.updatedAt ? new Date(existingProduct.updatedAt).getTime() : 0;
        const newTime = product.updatedAt ? new Date(product.updatedAt).getTime() : 0;
        
        if (newTime > existingTime) {
          console.log('üîÑ Replacing old product with newer version:', product.name);
          console.log('   - Old time:', existingProduct.updatedAt);
          console.log('   - New time:', product.updatedAt);
          uniqueProductsMap.set(product.id, product);
        } else {
          console.log('‚è≠Ô∏è Keeping existing (newer) product:', existingProduct.name);
        }
      }
    });
    
    // ‚úÖ STEP 3: Convert map back to array
    cachedProducts = Array.from(uniqueProductsMap.values());
    
    console.log(`‚úÖ Loaded ${cachedProducts.length} unique products (kept latest versions)`);
    
    // ‚úÖ STEP 4: Check for duplicate names with different IDs
    const nameMap = {};
    cachedProducts.forEach(product => {
      const name = product.name?.toLowerCase().trim();
      if (name) {
        if (!nameMap[name]) {
          nameMap[name] = [];
        }
        nameMap[name].push({
          id: product.id,
          name: product.name,
          stock: product.stock,
          updatedAt: product.updatedAt
        });
      }
    });
    
    // ‚úÖ STEP 5: For duplicate names, keep only the latest one
    const idsToRemove = [];
    
    Object.keys(nameMap).forEach(name => {
      if (nameMap[name].length > 1) {
        console.warn(`‚ö†Ô∏è Found ${nameMap[name].length} products with name "${name}"`);
        
        // Sort by updatedAt (newest first)
        const sorted = nameMap[name].sort((a, b) => {
          const timeA = a.updatedAt ? new Date(a.updatedAt).getTime() : 0;
          const timeB = b.updatedAt ? new Date(b.updatedAt).getTime() : 0;
          return timeB - timeA;
        });
        
        // Keep the first (newest), mark others for removal
        const toKeep = sorted[0];
        console.log(`‚úÖ Keeping latest:`, toKeep.id, '| Updated:', toKeep.updatedAt);
        
        for (let i = 1; i < sorted.length; i++) {
          console.log(`üóëÔ∏è Marking for removal:`, sorted[i].id, '| Updated:', sorted[i].updatedAt);
          idsToRemove.push(sorted[i].id);
        }
      }
    });
    
    // ‚úÖ STEP 6: Remove old duplicates from cache
    if (idsToRemove.length > 0) {
      console.log(`üóëÔ∏è Removing ${idsToRemove.length} old duplicate products from cache`);
      cachedProducts = cachedProducts.filter(p => !idsToRemove.includes(p.id));
    }
    
    // Sort products by name
    cachedProducts.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
    
    console.log(`‚úÖ Final: ${cachedProducts.length} unique products loaded`);
    
    // ‚úÖ Save to cache
    try {
      localStorage.setItem('inventory_products_cache', JSON.stringify(cachedProducts));
      console.log('üíæ Products saved to cache');
    } catch (cacheError) {
      console.warn('‚ö†Ô∏è Failed to save products cache:', cacheError);
    }
    
    // ‚úÖ Fetch sales from Firestore
    try {
      const salesRef = collection(window.db, 'tenants', userId, 'sales');
      
      try {
        const salesQuery = query(salesRef, orderBy('date', 'desc'));
        const salesSnap = await getDocs(salesQuery);
        
        let allSales = [];
        salesSnap.forEach((doc) => {
          allSales.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        let deletedSaleIds = JSON.parse(localStorage.getItem('deletedSaleIds') || '[]');
        cachedSales = allSales.filter(sale => !deletedSaleIds.includes(sale.id));
        
        console.log(`üìä Loaded ${allSales.length} sales, showing ${cachedSales.length}`);
        
      } catch (orderError) {
        console.warn('‚ö†Ô∏è OrderBy failed, fetching all sales:', orderError.message);
        
        const salesSnap = await getDocs(salesRef);
        
        let allSales = [];
        salesSnap.forEach((doc) => {
          allSales.push({
            id: doc.id,
            ...doc.data()
          });
        });
        
        allSales.sort((a, b) => {
          const dateA = a.date ? new Date(a.date).getTime() : 0;
          const dateB = b.date ? new Date(b.date).getTime() : 0;
          return dateB - dateA;
        });
        
        let deletedSaleIds = JSON.parse(localStorage.getItem('deletedSaleIds') || '[]');
        cachedSales = allSales.filter(sale => !deletedSaleIds.includes(sale.id));
        
        console.log(`üìä Loaded ${allSales.length} sales (sorted in JS), showing ${cachedSales.length}`);
      }
      
      try {
        localStorage.setItem('inventory_sales_cache', JSON.stringify(cachedSales));
      } catch (e) {
        console.warn('‚ö†Ô∏è Failed to save sales cache:', e);
      }
      
    } catch (salesError) {
      console.error('‚ùå Failed to load sales:', salesError.message);
      cachedSales = [];
    }
    
    hasInitialLoaded = true;
    
    // ‚úÖ Render
    try {
      renderProducts();
    } catch (e) {
      console.error('‚ùå Failed to render products:', e.message);
    }
    
    try {
      renderSales();
    } catch (e) {
      console.error('‚ùå Failed to render sales:', e.message);
    }
    
    try {
      updateSummaryFromCache();
    } catch (e) {
      console.error('‚ùå Failed to update summary:', e.message);
    }
    
    try {
      if (typeof loadRecentSales === 'function') {
        loadRecentSales();
      }
    } catch (e) {
      console.error('‚ùå Failed to load recent sales:', e.message);
    }
    
    showSyncIndicator('Synced!', 900);
    
  } catch (err) {
    console.error('‚ùå Sync error:', err.message);
    showSyncIndicator('Sync failed', 1500);
    
    try {
      cachedProducts = JSON.parse(localStorage.getItem('inventory_products_cache') || '[]');
      cachedSales = JSON.parse(localStorage.getItem('inventory_sales_cache') || '[]');
      
      const uniqueMap = new Map();
      cachedProducts.forEach(p => {
        if (!uniqueMap.has(p.id)) {
          uniqueMap.set(p.id, p);
        }
      });
      cachedProducts = Array.from(uniqueMap.values());
      
      renderProducts();
      renderSales();
    } catch (e) {
      console.error('Failed to load from cache:', e);
    }
  }
}


    
// Manual refresh function
async function manualRefresh() {
  const btn = document.getElementById('refreshBtn');
  const icon = document.getElementById('refreshIcon');
  btn.disabled = true;
  icon.className = 'bi bi-arrow-clockwise spinner-border spinner-border-sm';
  await syncFromFirestore();
  icon.className = 'bi bi-arrow-clockwise';
  btn.disabled = false;
}


 /***********************
   * Load sale product select helper (if needed elsewhere)
   ***********************/
  function loadProductsForSaleFromCache(){
    // not used directly now (we populate selects per-row), but keep for compatibility
  }




    

/**
 * Fallback function to load products and sales from Firestore
 * ‚úÖ FIREBASE VERSION
 */
async function fallbackGetProductsAndSales() {
  const user = window.auth.currentUser;
  
  if (!user) {
    console.warn('No user authenticated, skipping fallback load');
    return;
  }
  
  try {
    const { collection, getDocs } = window.firebaseImports;
    
    // Load products
    try {
      const productsRef = collection(window.db, 'tenants', user.uid, 'products');
      const productsSnapshot = await getDocs(productsRef);
      
      const products = [];
      productsSnapshot.forEach((doc) => {
        products.push({
          id: doc.id,
          ...doc.data()
        });
      });
      
      cachedProducts = products;
      console.log('‚úÖ Fallback: Loaded', products.length, 'products from Firestore');
    } catch (e) {
      console.warn('‚ùå Fallback products failed:', e);
    }
    
    // Load sales
    try {
      const salesRef = collection(window.db, 'tenants', user.uid, 'sales');
      const salesSnapshot = await getDocs(salesRef);
      
      const sales = [];
      salesSnapshot.forEach((doc) => {
        sales.push({
          id: doc.id,
          ...doc.data()
        });
      });
      
      cachedSales = sales;
      console.log('‚úÖ Fallback: Loaded', sales.length, 'sales from Firestore');
    } catch (e) {
      console.warn('‚ùå Fallback sales failed:', e);
    }
    
    hasInitialLoaded = true;
    renderProducts();
    renderSales();
    
  } catch (error) {
    console.error('‚ùå Fallback load failed:', error);
  }
}
/**
 * Manual refresh button handler
 * ‚úÖ FIREBASE VERSION
 */
async function manualRefresh() {
  const btn = document.getElementById('refreshBtn');
  const icon = document.getElementById('refreshIcon');
  
  if (!btn || !icon) {
    console.warn('Refresh button or icon not found');
    return;
  }
  
  // Disable button and show spinner
  btn.disabled = true;
  icon.className = 'bi bi-arrow-clockwise spinner-border spinner-border-sm';
  
  try {
    // Sync from Firestore (calls syncFromFirestore which you already converted)
    if (typeof syncFromFirestore === 'function') {
      await syncFromFirestore();
    } else if (typeof syncFromGoogleSheets === 'function') {
      // Fallback to renamed function if exists
      await syncFromGoogleSheets();
    } else {
      console.warn('No sync function found, calling fallback');
      await fallbackGetProductsAndSales();
    }
    
    console.log('‚úÖ Manual refresh complete');
    
  } catch (error) {
    console.error('‚ùå Manual refresh failed:', error);
    alert('Refresh failed: ' + error.message);
  } finally {
    // Re-enable button and remove spinner
    icon.className = 'bi bi-arrow-clockwise';
    btn.disabled = false;
  }
}

/***********************
 * Rendering
 ***********************/
function categoryIconColor(cat){
  if(!cat) return '#6c757d';
  const c = cat.toLowerCase();
  if(c.includes('tile')) return '#0d6efd';
  if(c.includes('sanitary')) return '#198754';
  if(c.includes('access')) return '#fd7e14';
  return '#6c757d';
}

/**
 * Generate stock badge HTML - handles both TEXT status and exact quantities
 */
function stockBadgeHtml(stock, minStock){
  console.log('üìä stockBadgeHtml called with stock:', stock, 'minStock:', minStock);
  
  // Check if stock is TEXT status (GOOD/MEDIUM/LOW/URGENT)
  if (typeof stock === 'string') {
    const statusUpper = stock.toUpperCase();
    
    if (statusUpper === 'GOOD') {
      return `<span class="stock-badge" style="background: #28a745; color: white; padding: 6px 12px; border-radius: 20px; font-weight: bold; display: inline-block;">üü¢ Good</span>`;
    }
    if (statusUpper === 'MEDIUM') {
      return `<span class="stock-badge" style="background: #ffc107; color: black; padding: 6px 12px; border-radius: 20px; font-weight: bold; display: inline-block;">üü° Medium</span>`;
    }
    if (statusUpper === 'LOW') {
      return `<span class="stock-badge" style="background: #dc3545; color: white; padding: 6px 12px; border-radius: 20px; font-weight: bold; display: inline-block;">üî¥ Low Stock</span>`;
    }
    if (statusUpper === 'URGENT') {
      return `<span class="stock-badge" style="background: #6f42c1; color: white; padding: 6px 12px; border-radius: 20px; font-weight: bold; display: inline-block;">üîµ Urgent</span>`;
    }
  }
  
  // ‚úÖ Handle NUMERIC stock (exact quantities)
  minStock = (typeof minStock === 'number') ? minStock : Number(minStock) || 5;
  stock = Number(stock) || 0;
  
  if (stock === 0) {
    return `<span class="stock-badge bg-danger text-white" style="padding: 6px 12px; border-radius: 20px; display: inline-block;">Out of Stock</span>`;
  }
  if (stock <= minStock) {
    return `<span class="stock-badge bg-warning text-dark" style="padding: 6px 12px; border-radius: 20px; display: inline-block;">Low (${stock})</span>`;
  }
  return `<span class="stock-badge bg-success text-white" style="padding: 6px 12px; border-radius: 20px; display: inline-block;">In Stock (${stock})</span>`;
}

/**
 * ==========================================
 * RENDER PRODUCTS - UPDATED WITH VARIANT INDICATORS
 * ==========================================
 */
function renderProducts(){
  const tbody = document.getElementById('productsTableBody');
  
  if(!hasInitialLoaded){
    tbody.innerHTML = `<tr><td colspan="8" class="text-center py-4"><div class="spinner-border"></div><div class="mt-2 text-muted">Loading inventory‚Ä¶</div></td></tr>`;
  } 
  else if(!cachedProducts || cachedProducts.length===0){
    tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted py-4">No products yet</td></tr>`;
  } 
  else {
    let html = '';
    cachedProducts.forEach((p, index) => {
      const priceText = (p.price!==undefined && p.price!==null) ? `‚Çπ${parseFloat(p.price).toFixed(2)}/${p.unitType}` : '-';
      
      // ‚úÖ ADD VARIANT BADGE
      const variantBadge = p.isGroupVariant ? 
        `<span style="background: #667eea; color: white; padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: bold; margin-left: 6px;">üì¶ GROUP</span>` : 
        '';
      
      // Photo thumbnail HTML
      const photoHtml = (p.imageUrl && p.imageUrl !== '' && p.imageUrl !== 'uploading...') ? 
        `<img src="${p.imageUrl}" 
             class="photo-thumbnail-small" 
             alt="Photo" 
             onclick="viewPhotoProduct('${p.id}')"
             style="cursor:pointer; width:60px; height:60px; object-fit:cover; border-radius:8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">` : 
        `<div style="width:60px; height:60px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius:8px; display:flex; align-items:center; justify-content:center;">
          <i class="bi bi-image" style="font-size:1.8rem; color:white;"></i>
         </div>`;
      
      const isSelected = bulkEditMode.active && bulkEditMode.selectedProducts.includes(p.id);
      const rowClass = isSelected ? 'product-selected' : '';
      
      html += `<tr class="${rowClass}" data-product-id="${p.id}" data-product-index="${index}">
        <td style="text-align: center;">${photoHtml}</td>
        <td><strong>${escapeHtml(p.name)}</strong>${variantBadge}</td>
        <td>${escapeHtml(p.category||'')}</td>
        <td>${escapeHtml(p.brand||'')}</td>
        <td><strong>${escapeHtml(p.size||'')}</strong></td>
        <td>${stockBadgeHtml(p.stock,p.minStock)}</td>
        <td><strong>${priceText}</strong></td>
        <td>
          <button class="btn btn-sm btn-primary btn-action-sm me-1" onclick="event.stopPropagation(); editProduct('${p.id}', ${p.isGroupVariant})"><i class="bi bi-pencil"></i> Edit</button>
          <button class="btn btn-sm btn-danger btn-action-sm" onclick="event.stopPropagation(); deleteProduct('${p.id}', ${p.isGroupVariant})"><i class="bi bi-trash"></i> Delete</button>
        </td>
      </tr>`;
    });
    tbody.innerHTML = html;
    
    if (bulkEditMode.active) {
      enableProductSelectionDesktop();
    }
  }
  
  // ‚úÖ MOBILE LIST (with variant badge)
  const container = document.getElementById('mobileProductsList');
  if(!hasInitialLoaded){ 
    container.innerHTML=`<div class="mobile-item text-center"><div class="spinner-border"></div><div class="mt-2 text-muted">Loading inventory‚Ä¶</div></div>`; 
  }
  else if(!cachedProducts || cachedProducts.length===0){ 
    container.innerHTML=`<div class="mobile-item text-center text-muted">No products yet</div>`; 
  }
  else {
    let html = '';
    cachedProducts.forEach((p, index) => {
      // ‚úÖ ADD VARIANT BADGE FOR MOBILE
      const variantBadge = p.isGroupVariant ? 
        `<span style="background: #667eea; color: white; padding: 4px 10px; border-radius: 12px; font-size: 12px; font-weight: bold; display: inline-block; margin-top: 6px;">üì¶ Group Variant</span>` : 
        '';
      
      const mobilePhoto = (p.imageUrl && p.imageUrl !== '' && p.imageUrl !== 'uploading...') ? 
        `<img src="${p.imageUrl}" 
             alt="Photo" 
             onclick="viewPhotoProduct('${p.id}')"
             style="cursor:pointer; width:70px; height:70px; object-fit:cover; border-radius:12px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">` : 
        `<div style="width:70px; height:70px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius:12px; display:flex; align-items:center; justify-content:center;">
          <i class="bi bi-image" style="font-size:2.2rem; color:white;"></i>
         </div>`;
      
      const isSelected = bulkEditMode.active && bulkEditMode.selectedProducts.includes(p.id);
      const cardClass = isSelected ? 'product-selected' : '';
      
      html += `<div class="mobile-item ${cardClass} d-flex align-items-start justify-content-between" 
                    data-product-id="${p.id}" 
                    data-product-index="${index}" 
                    style="gap:1rem; position:relative;">
        
        <div class="selection-indicator" style="display: ${isSelected ? 'flex' : 'none'};">
          <i class="bi bi-check-circle-fill"></i>
        </div>
        
        <div style="display:flex;gap:1rem;align-items:flex-start;flex:1;">
          <div style="flex-shrink:0;">${mobilePhoto}</div>
          <div style="flex:1;">
            <div style="font-weight:600;font-size:1rem;margin-bottom:4px;">${escapeHtml(p.name)}</div>
            ${variantBadge}
            <div class="small-muted">${escapeHtml(p.category||'')} ‚Ä¢ ${escapeHtml(p.brand||'')}</div>
            <div class="small-muted"><strong>${escapeHtml(p.size||'')}</strong></div>
            <div style="margin-top:8px;"><strong>‚Çπ${parseFloat(p.price||0).toFixed(2)}</strong>/${p.unitType}</div>
            <div style="margin-top:8px;">${stockBadgeHtml(p.stock,p.minStock)}</div>
          </div>
        </div>
        <div style="text-align:right;flex-shrink:0;">
          <div style="display:flex;flex-direction:column;gap:8px;">
            <button class="btn btn-sm btn-primary btn-action-sm" onclick="event.stopPropagation(); editProduct('${p.id}', ${p.isGroupVariant})"><i class="bi bi-pencil"></i> Edit</button>
            <button class="btn btn-sm btn-danger btn-action-sm" onclick="event.stopPropagation(); deleteProduct('${p.id}', ${p.isGroupVariant})"><i class="bi bi-trash"></i> Delete</button>
          </div>
        </div>
      </div>`;
    });
    container.innerHTML = html;
    
    if (bulkEditMode.active) {
      enableProductSelectionMobile();
    }
  }
  
  updateSummaryFromCache();
  loadProductsForSaleFromCache();
}




  function renderSales(){
    const tbody = document.getElementById('salesList');
    
    if(!hasInitialLoaded){ tbody.innerHTML = `<tr><td colspan="5" class="text-center py-4"><div class="spinner-border"></div><div class="mt-2 text-muted">Loading sales√É∆í√Ü‚Äô√É‚Äö√Ç¬¢√É∆í√Ç¬¢√É¬¢√¢‚Äö¬¨√Ö¬°√É‚Äö√Ç¬¨√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬¶</div></td></tr>`; return; }
    
    if(!cachedSales || cachedSales.length===0){ tbody.innerHTML=`<tr><td colspan="5" class="text-center text-muted py-4">No sales recorded yet</td></tr>`; return; }
    
    let html = '';
    
    const recent = (cachedSales || []).slice(0,100);
    recent.forEach(sale => {
      const d = new Date(sale.date||'');
      const formatted = d && !isNaN(d) ? (d.toLocaleDateString('en-IN') + ' ' + d.toLocaleTimeString('en-IN',{hour:'2-digit',minute:'2-digit'})) : sale.date;
      html += `<tr><td>${formatted}</td><td>${escapeHtml(sale.productName)}</td><td>${sale.quantity}</td><td>${escapeHtml(sale.unitType)}</td><td class="text-success fw-bold">‚Çπ${parseFloat(sale.totalAmount||0).toFixed(2)}</td></tr>`;
    });
    tbody.innerHTML = html;
    updateSummaryFromCache();
  }

/**
 * ==========================================
 * UPDATE SUMMARY - WITH VARIANT COUNTS
 * ==========================================
 */
function updateSummaryFromCache() {
  // ‚úÖ Count ONLY regular products (not variants)
  const regularProducts = cachedProducts.filter(p => !p.isGroupVariant);
  const totalProductsEl = document.getElementById('totalProducts');
  if (totalProductsEl) {
    totalProductsEl.textContent = regularProducts.length;
  }
  
  // ‚úÖ Low stock items (ALL products including variants)
  const lowStockCount = cachedProducts.filter(p => {
    const stock = Number(p.stock) || 0;
    const minStock = Number(p.minStock) || 5;
    return stock <= minStock && stock >= 0; // Exclude invalid values
  }).length;
  const lowStockEl = document.getElementById('lowStock');
  if (lowStockEl) {
    lowStockEl.textContent = lowStockCount;
  }
  
  // ‚úÖ Products in Group (count ONLY variants)
  const variantProducts = cachedProducts.filter(p => p.isGroupVariant);
  const productsInGroupEl = document.getElementById('productsInGroup');
  if (productsInGroupEl) {
    productsInGroupEl.textContent = variantProducts.length;
  }
  
  // ‚úÖ Inventory Summary - Total stock across ALL products
  const quantityInHandEl = document.getElementById('quantityInHand');
  if (quantityInHandEl) {
    const totalStock = cachedProducts.reduce((sum, p) => {
      const stock = Number(p.stock) || 0;
      return sum + (stock >= 0 ? stock : 0); // Only count valid positive numbers
    }, 0);
    quantityInHandEl.textContent = totalStock;
  }
  
  const quantityToBeReceivedEl = document.getElementById('quantityToBeReceived');
  if (quantityToBeReceivedEl) {
    quantityToBeReceivedEl.textContent = '0'; // TODO: Calculate from purchase orders
  }
}


  /***********************
   * Utility: build product selects including custom in-sale items
   ***********************/
  function populateProductSelectForRow(rowIndex){
    const sel = document.getElementById(`product-${rowIndex}`);
    if(!sel) return;
    const current = sel.value;
    sel.innerHTML = `<option value="">-- Select Product --</option>`;
    // Add cachedProducts first
    (cachedProducts || []).forEach(p => {
      const opt = document.createElement('option');
      opt.value = p.id;
      opt.dataset.size = p.size || '';
      opt.dataset.unit = p.unitType || '';
      opt.dataset.price = p.price;
      opt.dataset.stock = p.stock;
      opt.text = `${p.name} (Stock: ${p.stock} ${p.unitType})`;
      sel.appendChild(opt);
    });
    // Add custom in-sale products (those not in cachedProducts yet)
    (customProductsInSale || []).forEach(cp => {
      // If a matching id already exists in cachedProducts skip
      if((cachedProducts||[]).find(p => p.id === cp.tempId)) return;
      const opt = document.createElement('option');
      opt.value = cp.tempId;
      opt.dataset.size = cp.size || '';
      opt.dataset.unit = cp.unitType || '';
      opt.dataset.price = cp.price;
      opt.dataset.stock = cp.quantity; // treat its available stock as sale-qty (or 9999)
      opt.text = `${cp.name} (Custom)`;
      sel.appendChild(opt);
    });
    if(current) sel.value = current;
  }
/**
 * ==========================================
 * SAVE PRODUCT TO FIRESTORE - FIXED
 * ==========================================
 */
async function saveProductToSheet(product, isUpdate = false) {
  console.log('üíæ saveProductToSheet called');
  console.log('   - Is update:', isUpdate);
  console.log('   - Product ID:', product.id);
  
  try {
    const user = window.auth?.currentUser;
    if (!user) {
      console.error('‚ùå No user signed in');
      return { success: false, error: 'Not authenticated' };
    }
    
    const { doc, setDoc, collection, getDocs, query, where } = window.firebaseImports;
    const userId = user.uid;
    
    // ‚úÖ CHECK FOR DUPLICATES BEFORE SAVING
    if (isUpdate) {
      console.log('üîç Checking for duplicate products...');
      
      const productsRef = collection(window.db, 'tenants', userId, 'products');
      const snapshot = await getDocs(productsRef);
      
      let duplicateFound = false;
      snapshot.forEach(doc => {
        const data = doc.data();
        // Check if another document has same name but different ID
        if (data.name === product.name && doc.id !== product.id) {
          console.warn('‚ö†Ô∏è Found duplicate product with different ID:', doc.id);
          duplicateFound = true;
        }
      });
      
      if (duplicateFound) {
        console.error('‚ùå Duplicate product exists - aborting save');
        return { success: false, error: 'Duplicate product found' };
      }
    }
    
    // ‚úÖ Create product reference with the product ID
    const productRef = doc(window.db, 'tenants', userId, 'products', product.id);
    
    // ‚úÖ Prepare clean product data
    const productData = {
      id: product.id,
      name: product.name,
      category: product.category,
      brand: product.brand || '',
      size: product.size || '',
      unitType: product.unitType || 'Box',
      piecesPerBox: product.piecesPerBox || 1,
      sftPerBox: product.sftPerBox || 0,
      price: product.price || 0,
      stock: product.stock,
      minStock: product.minStock || 5,
      imageUrl: product.imageUrl || '',
      stockStatus: product.stockStatus || 'exact',
      stockValue: product.stockValue || null,
      updatedAt: new Date().toISOString(),
      isGroupVariant: product.isGroupVariant || false,
      groupId: product.groupId || '',
      variantId: product.variantId || ''
    };
    
    console.log('üì§ Saving to Firestore:', productData);
    
    // ‚úÖ Use setDoc to create or update
    await setDoc(productRef, productData);
    
    console.log('‚úÖ Product saved to Firestore successfully');
    console.log('   - Document ID:', product.id);
    console.log('   - Updated stock:', productData.stock);
    
    return { 
      success: true, 
      id: product.id 
    };
    
  } catch (error) {
    console.error('‚ùå Error saving product to Firestore:', error);
    return { 
      success: false, 
      error: error.message 
    };
  }
}


/**
 * ==========================================
 * SAVE SALE TO FIRESTORE - FINAL VERSION
 * ==========================================
 */
async function saveSaleToSheet(item) {
  const user = window.auth.currentUser;
  
  if (!user) {
    showAuthError('Please sign in to save sale');
    return null;
  }
  
  try {
    const { collection, addDoc, doc, updateDoc, getDoc } = window.firebaseImports;
    const userId = user.uid;
    
    // ‚úÖ Save sale
    const salesRef = collection(window.db, 'tenants', userId, 'sales');
    const docRef = await addDoc(salesRef, {
      ...item,
      date: item.date || new Date().toISOString(), // Ensure date exists
      createdAt: new Date().toISOString(),
      userId: userId
    });
    
    console.log('‚úÖ Sale saved:', docRef.id);
    
    // ‚úÖ UPDATE PRODUCT STOCK (if product ID exists)
    if (item.productId) {
      try {
        const productRef = doc(window.db, 'tenants', userId, 'products', item.productId);
        const productSnap = await getDoc(productRef);
        
        if (productSnap.exists()) {
          const currentStock = productSnap.data().stock || 0;
          const newStock = currentStock - (item.quantity || 0);
          
          await updateDoc(productRef, {
            stock: Math.max(0, newStock) // Don't go negative
          });
          
          console.log(`‚úÖ Stock updated: ${item.productId} (${currentStock} ‚Üí ${newStock})`);
        } else {
          console.warn(`‚ö†Ô∏è Product ${item.productId} not found, skipping stock update`);
        }
      } catch (stockError) {
        console.warn('‚ö†Ô∏è Could not update stock:', stockError.message);
        // ‚úÖ Don't fail the sale if stock update fails
      }
    }
    
    // ‚úÖ AUTO-RELOAD SALES LIST (for homepage Recent Sales)
    setTimeout(() => {
      if (typeof loadRecentSales === 'function') {
        loadRecentSales();
      }
    }, 500);
    
    // ‚úÖ ALSO UPDATE CACHED SALES (for main sales page)
    setTimeout(() => {
      if (typeof syncFromFirestore === 'function') {
        syncFromFirestore();
      }
    }, 1000);
    
    return { success: true, id: docRef.id };
    
  } catch (error) {
    console.error('‚ùå Error saving sale:', error);
    return { success: false, error: error.message };
  }
}

    
    // ==========================================
// HELPER: Delay function
// ==========================================
function delay(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

// ==========================================
// HELPER: Success Toast Notification
// ==========================================
// Show success toast notification
function showSuccessToast(message) {
  showToast(message, 'success');
}

// Show error toast notification
function showErrorToast(message) {
  showToast(message, 'error');
}

// Universal toast function
function showToast(message, type = 'success') {
  // Remove existing toasts
  const existingToasts = document.querySelectorAll('.toast-notification');
  existingToasts.forEach(toast => toast.remove());
  
  // Create toast element
  const toast = document.createElement('div');
  toast.className = 'toast-notification';
  toast.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    padding: 16px 24px;
    border-radius: 8px;
    color: white;
    font-weight: 600;
    font-size: 16px;
    z-index: 999999;
    animation: slideInRight 0.3s ease-out;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    max-width: 400px;
    ${type === 'success' ? 'background: #4caf50;' : 'background: #f44336;'}
  `;
  toast.textContent = message;
  
  // Add animation
  const style = document.createElement('style');
  style.textContent = `
    @keyframes slideInRight {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }
  `;
  
  if (!document.querySelector('#toast-animations')) {
    style.id = 'toast-animations';
    document.head.appendChild(style);
  }
  
  // Append to body
  document.body.appendChild(toast);
  
  // Auto remove after 4 seconds
  setTimeout(() => {
    toast.style.animation = 'slideOutRight 0.3s ease-in';
    setTimeout(() => toast.remove(), 300);
  }, 4000);
  
  // Click to dismiss
  toast.addEventListener('click', () => {
    toast.style.animation = 'slideOutRight 0.3s ease-in';
    setTimeout(() => toast.remove(), 300);
  });
}


// ==========================================
// HELPER: Update sync indicator
// ==========================================
function updateSyncIndicator(active) {
  const indicator = document.getElementById('backgroundSyncStatus');
  if (indicator) {
    indicator.style.display = active ? 'flex' : 'none';
  }
}





/**
 * ==========================================
 * DELETE PRODUCT FROM FIRESTORE - IMPROVED
 * ==========================================
 */
async function deleteProductFromSheet(id) {
  console.log('üóëÔ∏è deleteProductFromSheet called. ID:', id);
  
  const user = window.auth?.currentUser;
  
  if (!user) {
    console.error('‚ùå No user authenticated');
    alert('Please sign in to delete product');
    return false;
  }
  
  try {
    const { doc, deleteDoc } = window.firebaseImports;
    const userId = user.uid;
    
    console.log('üóëÔ∏è Deleting from Firestore...');
    console.log('   - User ID:', userId);
    console.log('   - Product ID:', id);
    
    // ‚úÖ Create reference to product document
    const productRef = doc(window.db, 'tenants', userId, 'products', id);
    
    // ‚úÖ Delete from Firestore
    await deleteDoc(productRef);
    
    console.log('‚úÖ Product deleted from Firestore:', id);
    return true;
    
  } catch (error) {
    console.error('‚ùå Error deleting product from Firestore:', error);
    console.error('   - Error code:', error.code);
    console.error('   - Error message:', error.message);
    return false;
  }
}

// Make globally available
window.deleteProductFromSheet = deleteProductFromSheet;

/**
 * Toggle Advanced Options in Product Modal
 */
function toggleAdvancedOptions() {
  const container = document.getElementById('advancedOptionsContainer');
  const icon = document.getElementById('advOptionsIcon');
  
  if (container.style.display === 'none') {
    container.style.display = 'block';
    icon.style.transform = 'rotate(180deg)';
    icon.style.transition = 'transform 0.3s ease';
    console.log('üìÇ Advanced options opened');
  } else {
    container.style.display = 'none';
    icon.style.transform = 'rotate(0deg)';
    icon.style.transition = 'transform 0.3s ease';
    console.log('üìÇ Advanced options closed');
  }
}
/**
 * ==========================================
 * BACKGROUND QUEUE PROCESSOR - FIXED (NO AUTO-SYNC)
 * ==========================================
 */
const backgroundSaveQueue = [];
let isProcessingQueue = false;
let backgroundSyncActive = false;

async function processBackgroundSaveQueue() {
  if (isProcessingQueue) {
    console.log('‚è≥ Queue processor already running');
    return;
  }
  
  if (backgroundSaveQueue.length === 0) {
    console.log('‚úÖ Queue empty, processor stopping');
    backgroundSyncActive = false;
    updateSyncIndicator(false);
    return;
  }
  
  isProcessingQueue = true;
  backgroundSyncActive = true;
  updateSyncIndicator(true);
  
  console.log(`üîÑ Processing ${backgroundSaveQueue.length} items in background queue...`);
  
  while (backgroundSaveQueue.length > 0) {
    const item = backgroundSaveQueue[0];
    
    console.log(`üì§ Background saving: "${item.productName}" (${backgroundSaveQueue.length} remaining)`);
    
    let saved = false;
    for (let attempt = 1; attempt <= 3; attempt++) {
      try {
        const response = await saveSaleToSheet(item);
        
        if (response && response.success) {
          console.log(`‚úÖ Background saved: "${item.productName}"`);
          saved = true;
          break;
        }
        
        if (attempt < 3) {
          console.log(`‚ö†Ô∏è Retry ${attempt}/3 for "${item.productName}" in ${attempt}s...`);
          await delay(1000 * attempt);
        }
        
      } catch (error) {
        console.error(`‚ùå Attempt ${attempt}/3 failed for "${item.productName}":`, error);
        
        if (attempt < 3) {
          await delay(1000 * attempt);
        }
      }
    }
    
    if (saved) {
      backgroundSaveQueue.shift();
    } else {
      console.error(`‚ùå PERMANENT FAILURE: Could not save "${item.productName}" after 3 attempts`);
      backgroundSaveQueue.shift();
      
      try {
        const failedItems = JSON.parse(localStorage.getItem('failedSales') || '[]');
        failedItems.push({
          item: item,
          timestamp: new Date().toISOString(),
          error: 'Max retries exceeded'
        });
        localStorage.setItem('failedSales', JSON.stringify(failedItems));
        console.log('üíæ Failed item saved to localStorage for recovery');
      } catch (e) {
        console.error('Could not save to localStorage:', e);
      }
    }
    
    if (backgroundSaveQueue.length > 0) {
      await delay(500);
    }
  }
  
  isProcessingQueue = false;
  backgroundSyncActive = false;
  updateSyncIndicator(false);
  
  console.log('‚úÖ Background queue processing complete!');
  
  // ‚úÖ REMOVED AUTO-SYNC - DON'T SYNC AFTER EVERY QUEUE PROCESS
  // Only sync when user manually refreshes or on initial load
}

    

/**
 * Load products from Firestore (called by syncFromFirestore)
 * This function is now integrated into syncFromFirestore()
 * Keep this for backward compatibility if needed
 */
async function loadProducts() {
  console.log('üì¶ Loading products from Firestore...');
  
  const user = window.auth.currentUser;
  
  if (!user) {
    console.error('‚ùå No user authenticated');
    alert('Please sign in first');
    showAuthScreen();
    return;
  }
  
  try {
    const { collection, getDocs } = window.firebaseImports;
    const userId = user.uid;
    
    const productsRef = collection(window.db, 'tenants', userId, 'products');
    const productsSnap = await getDocs(productsRef);
    
    cachedProducts = [];
    productsSnap.forEach((doc) => {
      const data = doc.data();
      cachedProducts.push({
        id: doc.id,
        ...data,
        stockStatus: data.stockStatus || 'medium',
        stockValue: data.stockValue || 0
      });
    });
    
    console.log('‚úÖ Loaded', cachedProducts.length, 'products');
    
    if (cachedProducts.length > 0) {
      console.log('üìä Sample product:', cachedProducts[0]);
    }
    
    // Cache locally
    try {
      localStorage.setItem('inventory_products_cache', JSON.stringify(cachedProducts));
    } catch (e) {
      console.warn('‚ö†Ô∏è Cache save failed:', e);
    }
    
    renderProducts();
    
  } catch (err) {
    console.error('‚ùå Error loading products:', err);
    
    // Fallback to cache
    try {
      cachedProducts = JSON.parse(localStorage.getItem('inventory_products_cache') || '[]');
      renderProducts();
    } catch (e) {
      console.error('Failed to load from cache:', e);
      cachedProducts = [];
      renderProducts();
    }
  }
}


/***********************
 * Product CRUD UI - FIREBASE VERSION
 ***********************/
let editingProductId = null;

function showAddProduct() { 
  editingProductId = null; 
  document.getElementById('modalTitle').textContent = 'Add New Product'; 
  document.getElementById('productForm').reset(); 
  document.getElementById('productId').value = ''; 
  
  // ‚úÖ Clear variant flags
  const form = document.getElementById('productForm');
  form.dataset.isVariant = 'false';
  form.dataset.groupId = '';
  form.dataset.variantId = '';
  
  new bootstrap.Modal(document.getElementById('productModal')).show(); 
}

function editProduct(id, isVariant = false) {
  console.log('‚úèÔ∏è Editing product ID:', id, 'Is variant:', isVariant);
  
  const p = (cachedProducts||[]).find(x => x.id === id);
  if (!p) { 
    alert('‚ùå Product not found'); 
    return; 
  }
  
  console.log('üì¶ Found product:', p);
  
  // ‚úÖ CHECK IF THIS IS A VARIANT
  if (isVariant || p.isGroupVariant) {
    openEditVariantModalFromProduct(p);
    return;
  }
  
  // ‚úÖ CRITICAL: Set editingProductId BEFORE opening modal
  editingProductId = id;
  console.log('‚úÖ Set editingProductId to:', editingProductId);
  
  document.getElementById('modalTitle').textContent = 'Edit Product';
  document.getElementById('productId').value = id; // Use actual ID
  document.getElementById('productName').value = p.name;
  document.getElementById('category').value = p.category;
  document.getElementById('brand').value = p.brand || '';
  document.getElementById('size').value = p.size || '';
  document.getElementById('unitType').value = p.unitType;
  document.getElementById('piecesPerBox').value = p.piecesPerBox || 1;
  document.getElementById('sftPerBox').value = p.sftPerBox || '';
  document.getElementById('price').value = p.price;
  document.getElementById('minStock').value = p.minStock;
  
  window.editingProductImageUrl = p.imageUrl || '';
  
  // Stock handling (keep your existing code)
  resetStockSelection();
  document.getElementById('productCurrentStock').value = '';
  
  const stockValue = p.stock;
  const stockType = typeof stockValue;
  
  if (stockType === 'number' && !isNaN(stockValue) && stockValue >= 0) {
    document.getElementById('productCurrentStock').value = stockValue;
  } 
  else if (stockType === 'string' && stockValue) {
    const parsedNumber = parseFloat(stockValue);
    
    if (!isNaN(parsedNumber) && parsedNumber >= 0) {
      document.getElementById('productCurrentStock').value = parsedNumber;
    } else {
      const statusLower = stockValue.toString().toLowerCase().trim();
      
      if (['good', 'medium', 'low', 'urgent'].includes(statusLower)) {
        selectStockStatus(statusLower);
      }
    }
  }
  
  // Photo handling (keep your existing code)
  if (p.imageUrl) {
    document.getElementById('productPhotoPreviewImage').src = p.imageUrl;
    document.getElementById('productPhotoPreviewContainer').style.display = 'block';
    document.getElementById('productPhotoUploadArea').style.display = 'none';
  } else {
    document.getElementById('productPhotoPreviewContainer').style.display = 'none';
    document.getElementById('productPhotoUploadArea').style.display = 'block';
  }
  
  productPhotoBase64 = null;
  productPhotoFileName = null;
  
  new bootstrap.Modal(document.getElementById('productModal')).show();
  console.log('‚úÖ Edit modal opened for product:', editingProductId);
}


// ‚úÖ Open edit modal for variant (KEEP SAME)
function openEditVariantModalFromProduct(variant) {
  console.log('üìù Opening variant edit modal:', variant);
  
  editingProductId = variant.id || variant.variantId;
  
  const form = document.getElementById('productForm');
  form.dataset.isVariant = 'true';
  form.dataset.groupId = variant.groupId || '';
  form.dataset.variantId = variant.variantId || variant.id;
  
  document.getElementById('modalTitle').textContent = 'Edit Variant';
  document.getElementById('productId').value = variant.variantId || variant.id;
  document.getElementById('productName').value = variant.name || variant.variantName;
  document.getElementById('category').value = variant.category || '';
  document.getElementById('brand').value = variant.brand || '';
  document.getElementById('size').value = variant.size || '';
  document.getElementById('unitType').value = variant.unitType || 'Box';
  document.getElementById('price').value = variant.price || variant.sellingPrice || 0;
  document.getElementById('minStock').value = variant.minStock || 0;
  
  document.getElementById('productCurrentStock').value = variant.stock || 0;
  
  // Make name/brand/size readonly for variants
  document.getElementById('productName').readOnly = true;
  document.getElementById('brand').readOnly = true;
  document.getElementById('size').readOnly = true;
  
  document.getElementById('productName').style.background = '#f0f0f0';
  document.getElementById('brand').style.background = '#f0f0f0';
  document.getElementById('size').style.background = '#f0f0f0';
  
  new bootstrap.Modal(document.getElementById('productModal')).show();
}


async function saveProduct() {
  console.log('üíæ saveProduct called. Editing ID:', editingProductId);
  
  // ‚úÖ CHECK IF THIS IS A VARIANT EDIT
  const form = document.getElementById('productForm');
  const isVariant = form.dataset.isVariant === 'true';
  
  if (isVariant) {
    console.log('üìù Saving as variant');
    await saveVariantData();
    return;
  }
  
  // ‚úÖ GET FORM VALUES
  const name = document.getElementById('productName').value.trim();
  const category = document.getElementById('category').value;
  const brand = document.getElementById('brand').value.trim();
  const size = document.getElementById('size').value.trim();
  const unitType = document.getElementById('unitType').value;
  const piecesPerBox = parseInt(document.getElementById('piecesPerBox').value) || 1;
  const sftPerBox = parseFloat(document.getElementById('sftPerBox').value) || 0;
  const price = parseFloat(document.getElementById('price').value);
  
  // ‚úÖ GET STOCK DATA
  const stockData = getStockData();
  if (!stockData) {
    return;
  }
  
  const minStock = parseInt(document.getElementById('minStock').value) || 5;
  
  console.log('üîç Form data:', { name, category, brand, price, stockData, editingProductId });
  
  // ‚úÖ VALIDATION
  if (!name || !category || isNaN(price)) {
    console.error('‚ùå Validation failed');
    alert('Fill required fields');
    return;
  }
  
  // ‚úÖ DETERMINE IF EDITING OR CREATING NEW
  const isEditing = !!editingProductId;
  let productId;
  
  if (isEditing) {
    // ‚úÖ EDITING: Use existing ID
    productId = editingProductId;
    console.log('‚úèÔ∏è Editing existing product:', productId);
  } else {
    // ‚úÖ NEW: Generate new ID
    productId = Date.now().toString(36) + Math.random().toString(36).substr(2);
    console.log('‚ûï Creating new product:', productId);
  }
  
  // ‚úÖ CREATE PRODUCT OBJECT
  const product = {
    id: productId,
    name: name,
    category: category,
    brand: brand,
    size: size,
    unitType: unitType,
    piecesPerBox: piecesPerBox,
    sftPerBox: sftPerBox,
    price: price,
    stock: stockData.stockStatus === 'exact' 
      ? stockData.stockValue 
      : stockData.stockStatus.toUpperCase(),
    minStock: minStock,
    imageUrl: window.editingProductImageUrl || '',
    stockStatus: stockData.stockStatus,
    stockValue: stockData.stockValue || null,
    updatedAt: new Date().toISOString()
  };
  
  console.log('üì¶ Product object:', product);
  
  // ‚úÖ UPDATE LOCAL CACHE FIRST
  const idx = cachedProducts.findIndex(p => p.id === productId);
  const previous = idx !== -1 ? Object.assign({}, cachedProducts[idx]) : null;
  
  if (idx !== -1) {
    // ‚úÖ EDITING: Update existing product
    console.log('üîÑ Updating existing product in cache at index:', idx);
    cachedProducts[idx] = product;
  } else {
    // ‚úÖ NEW: Add new product
    console.log('‚ûï Adding new product to cache');
    cachedProducts.push(product);
  }
  
  // ‚úÖ CLOSE MODAL EARLY
  const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
  if (modal) modal.hide();
  
  // ‚úÖ RENDER IMMEDIATELY WITH LOCAL DATA
  renderProducts();
  
  // ‚úÖ Refresh brand cache (if function exists)
  if (typeof refreshBrandAutocompleteCache === 'function') {
    refreshBrandAutocompleteCache();
  }
  
  showSyncIndicator('Saving product...');
  
  // ‚úÖ UPLOAD PHOTO FIRST (if available)
  if (productPhotoBase64) {
    console.log('üì∑ Uploading product photo...');
    
    if (typeof uploadProductPhotoToFirebase === 'function') {
      const photoUrl = await uploadProductPhotoToFirebase(productId, productPhotoBase64);
      
      if (photoUrl) {
        product.imageUrl = photoUrl;
        const localIdx = cachedProducts.findIndex(p => p.id === productId);
        if (localIdx !== -1) {
          cachedProducts[localIdx].imageUrl = photoUrl;
          renderProducts();
        }
      }
    }
  }
  
  // ‚úÖ SAVE PRODUCT TO FIRESTORE
  try {
    console.log('üíæ Saving to Firestore. Is editing:', isEditing, 'ID:', productId);
    const resp = await saveProductToSheet(product, isEditing);
    console.log('üì• saveProductToSheet response:', resp);
    
    if (resp && resp.success) {
      console.log('‚úÖ Product saved successfully to Firestore');
      console.log('   - Product ID:', productId);
      console.log('   - Stock value:', product.stock);
      
      // ‚úÖ CRITICAL: Force update cache with final saved data
      const cacheIdx = cachedProducts.findIndex(p => p.id === productId);
      if (cacheIdx !== -1) {
        // Create a clean copy with all data
        cachedProducts[cacheIdx] = {
          ...product,
          id: productId // Ensure ID is preserved
        };
        console.log('‚úÖ Updated product in cache at index:', cacheIdx);
        console.log('   - Cached stock:', cachedProducts[cacheIdx].stock);
      }
      
      // ‚úÖ SAVE TO LOCALSTORAGE IMMEDIATELY
      try {
        localStorage.setItem('inventory_products_cache', JSON.stringify(cachedProducts));
        console.log('üíæ Cache saved to localStorage with', cachedProducts.length, 'products');
      } catch (cacheError) {
        console.warn('‚ö†Ô∏è Failed to save cache:', cacheError);
      }
      
      // ‚úÖ Force UI update with cached data
      renderProducts();
      
      showSyncIndicator('Saved', 900);
      
      if (typeof resetStockSelection === 'function') {
        resetStockSelection();
      }
      
    } else {
      console.error('‚ö†Ô∏è Save failed:', resp);
      
      // ‚úÖ REVERT TO PREVIOUS STATE
      if (previous && idx !== -1) {
        cachedProducts[idx] = previous;
      } else if (!previous && idx !== -1) {
        cachedProducts.splice(idx, 1);
      }
      
      renderProducts();
      
      try {
        localStorage.setItem('inventory_products_cache', JSON.stringify(cachedProducts));
      } catch (error) {
        console.warn('‚ö†Ô∏è Cache revert failed:', error);
      }
      
      alert('Save failed - reverted locally.');
      showSyncIndicator('Save failed', 2000);
    }
  } catch (err) {
    console.error('‚ùå Error in saveProduct:', err);
    console.error('   - Error message:', err.message);
    console.error('   - Error stack:', err.stack);
    
    // ‚úÖ REVERT TO PREVIOUS STATE
    if (previous && idx !== -1) {
      cachedProducts[idx] = previous;
      console.log('‚Ü©Ô∏è Reverted to previous product state');
    } else if (!isEditing) {
      // Only remove if it was a new product
      const removeIdx = cachedProducts.findIndex(p => p.id === productId);
      if (removeIdx !== -1) {
        cachedProducts.splice(removeIdx, 1);
        console.log('üóëÔ∏è Removed unsaved product from cache');
      }
    }
    
    renderProducts();
    
    try {
      localStorage.setItem('inventory_products_cache', JSON.stringify(cachedProducts));
    } catch (error) {
      console.warn('‚ö†Ô∏è Cache revert failed:', error);
    }
    
    alert('Save failed - reverted locally. Check console for details.');
    showSyncIndicator('Save failed', 2000);
  }
  
  // ‚úÖ CLEAR TEMPORARY VARIABLES
  editingProductId = null;
  window.editingProductImageUrl = '';
  productPhotoBase64 = null;
  productPhotoFileName = null;
  
  console.log('‚úÖ saveProduct completed');
}




// ‚úÖ Save Variant Data - FIREBASE VERSION
async function saveVariantData() {
  console.log('üíæ Saving variant to Firestore...');
  
  const submitBtn = document.querySelector('#productModal .btn-primary');
  const originalText = submitBtn ? submitBtn.innerHTML : 'Save Product';
  
  if (submitBtn) {
    submitBtn.disabled = true;
    submitBtn.innerHTML = '‚è≥ Saving...';
  }
  
  try {
    const user = window.auth.currentUser;
    
    if (!user) {
      throw new Error('User not authenticated');
    }
    
    const form = document.getElementById('productForm');
    
    // Get variant ID
    let variantId = document.getElementById('productId')?.value;
    if (!variantId || variantId === '') {
      variantId = form.dataset.variantId;
    }
    
    const groupId = form.dataset.groupId;
    
    console.log('üîç Debug info:', {
      variantId: variantId,
      groupId: groupId
    });
    
    // Validation
    if (!variantId || variantId === '' || variantId === 'undefined') {
      throw new Error('Variant ID is missing. Please close and reopen the edit form.');
    }
    
    if (!groupId || groupId === '' || groupId === 'undefined') {
      throw new Error('Group ID is missing. Please close and reopen the edit form.');
    }
    
    // Get field values
    const getFieldValue = (id, defaultValue = 0) => {
      const field = document.getElementById(id);
      return field ? (field.value || defaultValue) : defaultValue;
    };
    
    const sellingPrice = parseFloat(getFieldValue('price', 0));
    const stock = parseInt(getFieldValue('productCurrentStock', 0));
    const minStock = parseInt(getFieldValue('minStock', 0));
    const unitType = getFieldValue('unitType', 'Piece');
    
    if (isNaN(sellingPrice) || sellingPrice < 0) {
      throw new Error('Invalid selling price');
    }
    
    if (isNaN(stock) || stock < 0) {
      throw new Error('Invalid stock value');
    }
    
    // ‚úÖ PREPARE UPDATE DATA FOR FIRESTORE
    const updateData = {
      sellingPrice: sellingPrice,
      stock: stock,
      minStock: minStock,
      unitType: unitType,
      updatedAt: new Date().toISOString()
    };
    
    console.log('üì§ Updating variant in Firestore:', updateData);
    
    const { collection, doc, updateDoc } = window.firebaseImports;
    const userId = user.uid;
    
    // Update variant in Firestore
    const variantRef = doc(window.db, 'tenants', userId, 'variants', variantId);
    await updateDoc(variantRef, updateData);
    
    console.log('‚úÖ Variant updated successfully');
    
    // Update local cache
    if (typeof cachedGroupVariants !== 'undefined') {
      const variantIndex = cachedGroupVariants.findIndex(v => v.variantId === variantId);
      if (variantIndex !== -1) {
        cachedGroupVariants[variantIndex] = {
          ...cachedGroupVariants[variantIndex],
          ...updateData
        };
      }
    }
    
    // Show success message
    if (typeof showSuccessToast === 'function') {
      showSuccessToast('‚úÖ Variant updated successfully!');
    } else {
      alert('‚úÖ Variant updated successfully!');
    }
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
    if (modal) modal.hide();
    
    // Clear flags
    form.dataset.isVariant = 'false';
    form.dataset.groupId = '';
    form.dataset.variantId = '';
    
    // Reset readonly fields
    const resetField = (id) => {
      const field = document.getElementById(id);
      if (field) {
        field.readOnly = false;
        field.style.background = '';
        field.style.color = '';
      }
    };
    
    resetField('productName');
    resetField('brand');
    resetField('size');
    
    // Refresh variants list
    setTimeout(() => {
      if (typeof loadGroupVariants === 'function') {
        loadGroupVariants(groupId);
      }
    }, 500);
    
  } catch (error) {
    console.error('‚ùå Error updating variant:', error);
    alert(`Error: ${error.message}\n\nPlease check the console for details.`);
  } finally {
    if (submitBtn) {
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalText;
    }
  }
}





    
  

/**
 * ==========================================
 * DELETE PRODUCT - ENHANCED WITH BETTER LOGGING
 * ==========================================
 */
async function deleteProduct(id) {
  console.log('üóëÔ∏è deleteProduct called. ID:', id);
  
  if (!id) {
    console.error('‚ùå No product ID provided');
    alert('Error: Invalid product ID');
    return;
  }
  
  // Find product in cache
  const product = cachedProducts.find(p => p.id === id);
  if (!product) {
    console.error('‚ùå Product not found in cache:', id);
    alert('Product not found');
    return;
  }
  
  // Confirm deletion with product name
  if (!confirm(`Delete "${product.name}"?\n\nThis action cannot be undone.`)) {
    console.log('‚è≠Ô∏è Delete cancelled by user');
    return;
  }
  
  console.log('üóëÔ∏è Deleting product:', product.name, '| ID:', id);
  
  // Backup current state
  const prev = cachedProducts.slice();
  
  // Remove from cache (optimistic update)
  cachedProducts = cachedProducts.filter(p => p.id !== id);
  console.log('‚úÖ Removed from local cache. Remaining:', cachedProducts.length);
  
  renderProducts();
  
  // Also update photo grid if currently viewing it
  if (document.getElementById('btnPhotoView')?.classList.contains('active')) {
    if (typeof showPhotoProducts === 'function') {
      showPhotoProducts();
    }
  }
  
  showSyncIndicator('Deleting...');
  
  // ‚úÖ DELETE FROM FIRESTORE
  try {
    console.log('üíæ Calling deleteProductFromSheet...');
    const success = await deleteProductFromSheet(id);
    
    if (success) {
      console.log('‚úÖ Product deleted successfully from Firestore');
      showSyncIndicator('Deleted', 900);
      
      // Update cache
      try {
        localStorage.setItem('inventory_products_cache', JSON.stringify(cachedProducts));
        console.log('üíæ Cache updated after delete');
      } catch (e) {
        console.warn('‚ö†Ô∏è Cache update failed:', e);
      }
      
      // Update stats
      if (typeof updateSummaryFromCache === 'function') {
        updateSummaryFromCache();
      }
      
    } else {
      console.error('‚ùå deleteProductFromSheet returned false');
      
      // Revert
      cachedProducts = prev;
      renderProducts();
      
      if (document.getElementById('btnPhotoView')?.classList.contains('active')) {
        if (typeof showPhotoProducts === 'function') {
          showPhotoProducts();
        }
      }
      
      alert('Delete failed - product restored.');
      showSyncIndicator('Delete failed', 2000);
    }
    
  } catch (err) {
    console.error('‚ùå Delete error:', err);
    console.error('   - Error message:', err.message);
    console.error('   - Error stack:', err.stack);
    
    // Revert
    cachedProducts = prev;
    renderProducts();
    
    if (document.getElementById('btnPhotoView')?.classList.contains('active')) {
      if (typeof showPhotoProducts === 'function') {
        showPhotoProducts();
      }
    }
    
    alert('Delete failed - product restored. Check console for details.');
    showSyncIndicator('Delete failed', 2000);
  }
}

// Make globally available
window.deleteProduct = deleteProduct;


    

/**
 * ==========================================
 * PRODUCT PHOTO UPLOAD FUNCTIONS
 * ==========================================
 */

/**
 * Handle product photo selection
 */
function handleProductPhotoSelect(event) {
  const file = event.target.files[0];
  if (!file || !file.type.startsWith('image/')) {
    alert('Please select a valid image file');
    return;
  }
  
  productPhotoFileName = `product_${Date.now()}.jpg`;
  
  const reader = new FileReader();
  reader.onload = (e) => {
    const img = new Image();
    img.onload = () => {
      // Compress image
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      
      const maxWidth = 1920;
      const maxHeight = 1080;
      let width = img.width;
      let height = img.height;
      
      if (width > height) {
        if (width > maxWidth) {
          height = (maxWidth / width) * height;
          width = maxWidth;
        }
      } else {
        if (height > maxHeight) {
          width = (maxHeight / height) * width;
          height = maxHeight;
        }
      }
      
      canvas.width = width;
      canvas.height = height;
      ctx.drawImage(img, 0, 0, width, height);
      
      productPhotoBase64 = canvas.toDataURL('image/jpeg', 0.7);
      
      // Show preview
      document.getElementById('productPhotoPreviewImage').src = productPhotoBase64;
      document.getElementById('productPhotoPreviewContainer').style.display = 'block';
      
      console.log('‚úÖ Product photo selected and compressed');
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

/**
 * Clear product photo selection
 */
function clearProductPhotoSelection() {
  document.getElementById('productPhotoFileInput').value = '';
  document.getElementById('productPhotoPreviewContainer').style.display = 'none';
  productPhotoBase64 = null;
  productPhotoFileName = null;
}

/**
 * Remove product photo
 */
function removeProductPhoto() {
  clearProductPhotoSelection();
  window.editingProductImageUrl = '';
}

/**
 * Upload product photo to Firebase Storage
 */
async function uploadProductPhotoToFirebase(productId, photoBase64) {
  try {
    if (!photoBase64) {
      console.log('‚ö†Ô∏è No photo to upload');
      return null;
    }
    
    console.log('üì§ Uploading product photo to Firebase Storage...');
    
    // Note: Firebase Storage requires additional import
    // For now, we'll store base64 in Firestore (quick solution)
    // Later, you can upgrade to Firebase Storage for better performance
    
    // Option 1: Store base64 directly in product document (simple but not recommended for production)
    const user = window.auth.currentUser;
    if (!user) {
      console.error('User not authenticated');
      return null;
    }
    
    // For production, you should use Firebase Storage instead
    // This is a temporary solution
    console.log('‚úÖ Photo prepared for Firestore (base64)');
    return photoBase64; // Return base64 to store in product document
    
    // TODO: Implement Firebase Storage upload for production
    // const storage = getStorage();
    // const storageRef = ref(storage, `products/${user.uid}/${productId}.jpg`);
    // const uploadTask = await uploadString(storageRef, photoBase64, 'data_url');
    // const downloadURL = await getDownloadURL(uploadTask.ref);
    // return downloadURL;
    
  } catch (error) {
    console.error('‚ùå Photo upload error:', error);
    return null;
  }
}

// Keep backward compatibility
async function uploadProductPhotoToBackend(productId, photoBase64) {
  return await uploadProductPhotoToFirebase(productId, photoBase64);
}

/**
 * ==========================================
 * RECORD PURCHASE - FIREBASE VERSION
 * ==========================================
 */

// Global variables - NO CHANGES NEEDED
let purchasePhotoBase64 = null;
let purchaseProductRowCounter = 0;

/**
 * Initialize purchases on page load
 */
document.addEventListener('DOMContentLoaded', function() {
  console.log('üîÑ Initializing purchases module...');
  
  // Auto-load purchases when user is authenticated
  const checkAndLoad = setInterval(() => {
    if (window.auth && window.auth.currentUser) {
      clearInterval(checkAndLoad);
      console.log('üë§ User authenticated, loading purchases...');
      
      // Check if we're on purchases page
      const purchasesPage = document.getElementById('purchasesPage');
      if (purchasesPage && purchasesPage.style.display !== 'none') {
        loadRecentPurchases();
      }
    }
  }, 500);
  
  // Stop checking after 10 seconds
  setTimeout(() => clearInterval(checkAndLoad), 10000);
});


    
/**
 * Submit purchase entry to Firestore
 */
async function submitPurchaseEntry() {
  console.log('üì§ submitPurchaseEntry called');
  
  const user = window.auth.currentUser;
  if (!user) {
    alert('Please sign in first');
    return;
  }
  
  try {
    // Get form values
    const vendorName = document.getElementById('purchaseVendorName')?.value?.trim();
    const totalAmount = parseFloat(document.getElementById('purchaseTotalAmount')?.value || 0);
    const otherInfo = document.getElementById('purchaseOtherInfo')?.value?.trim() || '';
    
    if (!vendorName) {
      alert('‚ùå Please enter vendor name');
      return;
    }
    
    // Get products
    const productRows = document.querySelectorAll('.purchase-product-row');
    if (productRows.length === 0) {
      alert('‚ùå Please add at least one product');
      return;
    }
    
    const products = [];
    for (const row of productRows) {
      const name = row.querySelector('[data-field="name"]')?.value?.trim();
      const qty = parseFloat(row.querySelector('[data-field="qty"]')?.value || 0);
      const rate = parseFloat(row.querySelector('[data-field="rate"]')?.value || 0);
      const unit = row.querySelector('[data-field="unit"]')?.value || 'Pieces';
      const amount = qty * rate;
      
      if (name && qty > 0 && rate > 0) {
        products.push({
          name: name,
          qty: qty,
          rate: rate,
          unit: unit,
          amount: amount.toFixed(2)
        });
      }
    }
    
    if (products.length === 0) {
      alert('‚ùå Please add valid products with quantity and rate');
      return;
    }
    
    if (totalAmount <= 0) {
      alert('‚ùå Please enter total amount');
      return;
    }
    
    // Get payment modes
    const paymentModes = {};
    const cashCheckbox = document.getElementById('purchasePaymentCash');
    const onlineCheckbox = document.getElementById('purchasePaymentOnline');
    const creditCheckbox = document.getElementById('purchasePaymentCredit');
    
    if (cashCheckbox?.checked) {
      paymentModes.cash = parseFloat(document.getElementById('purchasePaymentCashAmount')?.value || 0);
    }
    if (onlineCheckbox?.checked) {
      paymentModes.online = parseFloat(document.getElementById('purchasePaymentOnlineAmount')?.value || 0);
    }
    if (creditCheckbox?.checked) {
      paymentModes.credit = parseFloat(document.getElementById('purchasePaymentCreditAmount')?.value || 0);
    }
    
    // Build purchase data
    const purchaseData = {
      vendorName: vendorName,
      products: products,
      totalAmount: totalAmount,
      paymentModes: paymentModes,
      otherInfo: otherInfo,
      photoBase64: window.purchasePhotoBase64 || '',
      date: new Date().toISOString(),
      userId: user.uid,
      userEmail: user.email
    };
    
    console.log('üì¶ Submitting purchase to Firestore:', purchaseData);
    
    // Disable submit button
    const submitBtn = document.querySelector('#recordPurchaseModal button[onclick*="submitPurchaseEntry"]') || 
                      document.getElementById('submitPurchaseBtn');
    const originalBtnHTML = submitBtn?.innerHTML || 'Submit';
    
    if (submitBtn) {
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Submitting...';
    }
    
    // Save to Firestore
    const { collection, addDoc } = window.firebaseImports;
    const purchasesRef = collection(window.db, 'tenants', user.uid, 'purchases');
    
    const docRef = await addDoc(purchasesRef, purchaseData);
    
    console.log('‚úÖ Purchase saved to Firestore:', docRef.id);
    
    alert('‚úÖ Purchase recorded successfully!\n\nVendor: ' + vendorName + '\nTotal: ‚Çπ' + totalAmount);
    
    // Close modal
    const modal = document.getElementById('recordPurchaseModal');
    if (modal) {
      const bsModal = bootstrap.Modal.getInstance(modal);
      if (bsModal) bsModal.hide();
    }
    
    // Reset form
    document.getElementById('purchaseVendorName').value = '';
    document.getElementById('purchaseTotalAmount').value = '';
    document.getElementById('purchaseOtherInfo').value = '';
    document.querySelectorAll('.purchase-product-row').forEach(row => row.remove());
    window.purchasePhotoBase64 = '';
    
    // Reload purchases list
    setTimeout(async () => {
      console.log('üîÑ Reloading purchases list...');
      if (typeof loadRecentPurchases === 'function') {
        await loadRecentPurchases();
      }
    }, 500);
    
  } catch (error) {
    console.error('‚ùå Submit error:', error);
    alert('‚ùå Failed to record purchase:\n' + error.message);
  } finally {
    const submitBtn = document.querySelector('#recordPurchaseModal button[onclick*="submitPurchaseEntry"]') || 
                      document.getElementById('submitPurchaseBtn');
    if (submitBtn) {
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<i class="bi bi-check-circle"></i> Submit Purchase';
    }
  }
}


    
/**
 * Open Record Purchase Modal
 */
/**
 * Open Record Purchase Modal (SAFE VERSION)
 */
function openRecordPurchaseModal() {
  console.log('üì¶ Opening Record Purchase Modal');
  
  try {
    // Reset form fields
    const vendorNameInput = document.getElementById('purchaseVendorName');
    const totalAmountInput = document.getElementById('purchaseTotalAmount');
    const otherInfoInput = document.getElementById('purchaseOtherInfo');
    const productRowsContainer = document.getElementById('purchaseProductRows');
    
    if (vendorNameInput) vendorNameInput.value = '';
    if (totalAmountInput) totalAmountInput.value = '';
    if (otherInfoInput) otherInfoInput.value = '';
    if (productRowsContainer) productRowsContainer.innerHTML = '';
    
    // Reset payment modes
    const cashCheckbox = document.getElementById('purchasePaymentCash');
    const onlineCheckbox = document.getElementById('purchasePaymentOnline');
    const creditCheckbox = document.getElementById('purchasePaymentCredit');
    
    if (cashCheckbox) cashCheckbox.checked = false;
    if (onlineCheckbox) onlineCheckbox.checked = false;
    if (creditCheckbox) creditCheckbox.checked = false;
    
    const cashAmount = document.getElementById('purchasePaymentCashAmount');
    const onlineAmount = document.getElementById('purchasePaymentOnlineAmount');
    const creditAmount = document.getElementById('purchasePaymentCreditAmount');
    
    if (cashAmount) cashAmount.value = '';
    if (onlineAmount) onlineAmount.value = '';
    if (creditAmount) creditAmount.value = '';
    
    // Clear photo (safe)
    clearPurchasePhoto();
    
    // Reset counters
    window.purchaseProductRowCounter = 0;
    
    // Add one initial product row
    addPurchaseProductRow();
    
    // Show modal
    const modal = document.getElementById('recordPurchaseModal');
    if (modal) {
      const bsModal = new bootstrap.Modal(modal);
      bsModal.show();
    } else {
      console.error('‚ùå Modal element not found: recordPurchaseModal');
      alert('‚ùå Error: Modal not found. Please refresh the page.');
    }
    
  } catch (error) {
    console.error('‚ùå Error opening modal:', error);
    alert('‚ùå Failed to open modal: ' + error.message);
  }
}


/**
 * Close Record Purchase Modal
 */
function closeRecordPurchaseModal() {
  const modal = bootstrap.Modal.getInstance(document.getElementById('recordPurchaseModal'));
  if (modal) {
    modal.hide();
  }
}

/**
 * Add product row
 */
/**
 * Add product row (MOBILE RESPONSIVE)
 */
/**
 * Add product row (FIXED: Product name on Line 1, Qty/Rate/Unit on Line 2)
 */
function addPurchaseProductRow(product = null) {
  purchaseProductRowCounter++;
  const rowId = `purchaseRow${purchaseProductRowCounter}`;
  const container = document.getElementById('purchaseProductRows');

  const productName = product ? (product.size ? `${product.name} (${product.size})` : product.name) : '';
  const qty = product ? product.qty : '';
  const rate = product ? product.price : '';
  const unit = product ? product.unitType : 'Pieces';
  const amount = product ? (product.qty * product.price).toFixed(2) : '0.00';

  const rowDiv = document.createElement('div');
  rowDiv.id = rowId;
  rowDiv.className = 'purchase-product-row';

  rowDiv.innerHTML = `
    <input type="text" class="form-control" placeholder="Product name"
           value="${escapeHtml(productName)}" data-field="name">
    <input type="number" class="form-control" placeholder="Qty" min="1"
           value="${qty}" oninput="calculatePurchaseRowAmount('${rowId}')" data-field="qty">
    <input type="number" class="form-control" placeholder="Rate" min="0" step="0.01"
           value="${rate}" oninput="calculatePurchaseRowAmount('${rowId}')" data-field="rate">
    <select class="form-select" data-field="unit">
      <option value="Pieces" ${unit === 'Pieces' ? 'selected' : ''}>Pcs</option>
      <option value="Boxes" ${unit === 'Boxes' ? 'selected' : ''}>Box</option>
      <option value="Kg" ${unit === 'Kg' ? 'selected' : ''}>Kg</option>
      <option value="Liters" ${unit === 'Liters' ? 'selected' : ''}>L</option>
    </select>
    <input type="number" class="form-control" placeholder="Amount" readonly
           value="${amount}" data-field="amount"
           style="background: #e8f5e9; font-weight: 600; color: #2e7d32;">
    <button type="button" class="btn btn-danger purchase-remove-btn"
        onclick="removePurchaseProductRow('${rowId}')"
        style="font-size:22px;padding:0;min-width:36px;height:36px;">
      √ó
    </button>
  `;

  container.appendChild(rowDiv);
}



/**
 * Toggle payment section
 */
function togglePaymentSection() {
  const section = document.getElementById('paymentSection');
  section.classList.toggle('show');
}

/**
 * Trigger photo input (for click or paste)
 */
function triggerPhotoInput() {
  document.getElementById('purchasePhotoInput').click();
}

/**
 * Handle paste event for photo
 */
document.addEventListener('DOMContentLoaded', function() {
  const photoPreview = document.getElementById('purchasePhotoPreview');
  
  if (photoPreview) {
    // Handle paste event
    photoPreview.addEventListener('paste', function(e) {
      const items = e.clipboardData.items;
      for (let i = 0; i < items.length; i++) {
        if (items[i].type.indexOf('image') !== -1) {
          const blob = items[i].getAsFile();
          const reader = new FileReader();
          reader.onload = function(event) {
            purchasePhotoBase64 = event.target.result;
            document.getElementById('purchasePhotoImg').src = event.target.result;
            document.getElementById('purchasePhotoImg').style.display = 'block';
            photoPreview.querySelector('p').style.display = 'none';
            photoPreview.querySelector('i').style.display = 'none';
            document.getElementById('clearPurchasePhotoBtn').style.display = 'inline-block';
            console.log('‚úÖ Photo pasted');
          };
          reader.readAsDataURL(blob);
        }
      }
    });
  }
});





/**
 * Load recent purchases from Firestore
 */
async function loadRecentPurchases() {
  console.log('üì¶ Loading recent purchases from Firestore...');
  
  const user = window.auth.currentUser;
  if (!user) {
    console.error('User not authenticated');
    return;
  }
  
  const tbody = document.getElementById('purchasesList');
  tbody.innerHTML = `
    <tr>
      <td colspan="8" style="text-align: center; padding: 20px; color: #999;">
        <span class="spinner-border spinner-border-sm"></span> Loading purchases...
      </td>
    </tr>
  `;
  
  try {
    const { collection, getDocs, query, orderBy } = window.firebaseImports;
    
    const purchasesRef = collection(window.db, 'tenants', user.uid, 'purchases');
    const q = query(purchasesRef, orderBy('date', 'desc'));
    const snapshot = await getDocs(q);
    
    const purchases = [];
    snapshot.forEach((doc) => {
      purchases.push({
        purchaseId: doc.id,
        ...doc.data()
      });
    });
    
    console.log(`‚úÖ Loaded ${purchases.length} purchases`);
    
    displayPurchases(purchases);
    
  } catch (error) {
    console.error('‚ùå Error loading purchases:', error.message);
    tbody.innerHTML = `
      <tr>
        <td colspan="8" style="text-align: center; padding: 20px; color: #dc3545;">
          <i class="bi bi-exclamation-triangle"></i> Failed to load purchases<br>
          <small style="color: #666;">${error.message}</small>
        </td>
      </tr>
    `;
  }
}

/**
 * ==========================================
 * DISPLAY PURCHASES - FIXED VERSION
 * ==========================================
 */
function displayPurchases(purchases) {
  const tbody = document.getElementById('purchasesList');
  
  if (!purchases || purchases.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="8" style="text-align: center; padding: 20px; color: #999;">
          <i class="bi bi-inbox"></i> No purchases yet. Click "Record Purchase" to add one!
        </td>
      </tr>
    `;
    return;
  }
  
  let html = '';
  
  purchases.forEach((purchase, index) => {
    // ‚úÖ Format products string - handle array properly
    let productsStr = '-';
    if (Array.isArray(purchase.products)) {
      productsStr = purchase.products
        .map(p => `${p.name} (${p.qty})`)
        .join(', ');
    } else if (typeof purchase.products === 'string') {
      productsStr = purchase.products;
    }
    
    // ‚úÖ Format date
    const dateStr = purchase.date 
      ? new Date(purchase.date).toLocaleString('en-IN', {
          day: '2-digit',
          month: 'short',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        })
      : '-';
    
    // ‚úÖ Check if photo exists (photoBase64 field)
    const hasPhoto = purchase.photoBase64 && purchase.photoBase64.length > 0;
    
    html += `
      <tr onclick="viewPurchaseDetail(${index})" style="cursor: pointer;">
        <td style="text-align: center; font-weight: 600;">${index + 1}</td>
        <td style="white-space: nowrap;">${dateStr}</td>
        <td style="text-align: center;">
          ${hasPhoto ? `
            <img 
              src="${purchase.photoBase64}" 
              onclick="event.stopPropagation(); openPurchasePhotoLightbox(${index})" 
              style="width: 80px; height: 80px; object-fit: cover; border-radius: 8px; cursor: pointer; transition: transform 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" 
              onmouseover="this.style.transform='scale(1.05)'" 
              onmouseout="this.style.transform='scale(1)'"
              alt="Purchase Photo"
              title="Click to view full size">
          ` : '<span style="color: #999;">-</span>'}
        </td>
        <td style="max-width: 250px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(productsStr)}">${escapeHtml(productsStr)}</td>
        <td>${escapeHtml(purchase.vendorName || '-')}</td>
        <td style="font-weight: 600; color: #28a745;">‚Çπ${Number(purchase.totalAmount || 0).toFixed(2)}</td>
        <td style="font-size: 0.9rem;">${formatPaymentModes(purchase.paymentModes) || '-'}</td>
        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(purchase.otherInfo || '')}">${escapeHtml(purchase.otherInfo || '-')}</td>
      </tr>
    `;
  });
  
  tbody.innerHTML = html;
  window.currentPurchases = purchases;
  
  console.log('‚úÖ Displayed', purchases.length, 'purchases');
}

// Helper function
function formatPaymentModes(modes) {
  if (!modes || typeof modes !== 'object') return '';
  const parts = [];
  if (modes.cash && modes.cash > 0) parts.push(`Cash: ‚Çπ${modes.cash}`);
  if (modes.online && modes.online > 0) parts.push(`Online: ‚Çπ${modes.online}`);
  if (modes.credit && modes.credit > 0) parts.push(`Credit: ‚Çπ${modes.credit}`);
  return parts.join(', ') || 'Not specified';
}


   /**
 * ==========================================
 * OPEN PURCHASE PHOTO LIGHTBOX - FIXED
 * ==========================================
 */
function openPurchasePhotoLightbox(purchaseIndex) {
  const purchase = window.currentPurchases[purchaseIndex];
  
  if (!purchase) {
    alert('‚ùå Purchase not found');
    return;
  }
  
  // ‚úÖ Check for photo in photoBase64 field
  if (!purchase.photoBase64 || purchase.photoBase64.length === 0) {
    alert('‚ùå No photo available for this purchase');
    return;
  }
  
  console.log('üì∏ Opening purchase photo lightbox');
  
  // Create or get lightbox modal
  let lightbox = document.getElementById('purchasePhotoLightboxModal');
  
  if (!lightbox) {
    lightbox = document.createElement('div');
    lightbox.id = 'purchasePhotoLightboxModal';
    lightbox.className = 'modal fade';
    lightbox.setAttribute('tabindex', '-1');
    lightbox.innerHTML = `
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content" style="background: transparent; border: none;">
          <div class="modal-header" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); border: none; color: white;">
            <h5 class="modal-title" id="purchasePhotoLightboxTitle">
              <i class="bi bi-camera"></i> Purchase Photo
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body text-center" style="padding: 20px; background: #fff;">
            <img 
              id="purchasePhotoLightboxImg" 
              src="" 
              style="width: 100%; max-height: 65vh; object-fit: contain; border-radius: 8px;" 
              alt="Purchase Photo"
              onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
            <div id="purchasePhotoLoadError" style="display:none; padding: 40px; color: #dc3545;">
              <i class="bi bi-exclamation-triangle" style="font-size: 3rem;"></i>
              <p style="margin-top: 15px;">Failed to load photo</p>
            </div>
          </div>
          <div class="modal-footer" style="border-top: 1px solid #dee2e6; background: #f8f9fa;">
            <strong style="color: #495057;">Vendor:</strong>
            <span id="purchasePhotoVendorName" style="margin-left: 10px; color: #6c757d;">-</span>
          </div>
        </div>
      </div>
    `;
    document.body.appendChild(lightbox);
  }
  
  // ‚úÖ Update modal content
  document.getElementById('purchasePhotoLightboxTitle').innerHTML = `
    <i class="bi bi-camera"></i> ${escapeHtml(purchase.vendorName || 'Purchase Photo')}
  `;
  
  const imgElement = document.getElementById('purchasePhotoLightboxImg');
  imgElement.style.display = 'block';
  imgElement.src = purchase.photoBase64; // ‚úÖ Use photoBase64 field
  
  document.getElementById('purchasePhotoVendorName').textContent = purchase.vendorName || '-';
  document.getElementById('purchasePhotoLoadError').style.display = 'none';
  
  // Show modal
  const bsLightbox = new bootstrap.Modal(lightbox);
  bsLightbox.show();
}



/**
 * ==========================================
 * VIEW PURCHASE DETAIL - FIXED VERSION
 * ==========================================
 */
function viewPurchaseDetail(index) {
  const purchase = window.currentPurchases[index];
  if (!purchase) return;
  
  // ‚úÖ Format products properly
  let productsHTML = '';
  if (Array.isArray(purchase.products) && purchase.products.length > 0) {
    productsHTML = `
      <table class="table table-sm table-bordered">
        <thead class="table-light">
          <tr>
            <th>Product</th>
            <th>Qty</th>
            <th>Unit</th>
            <th>Rate</th>
            <th>Amount</th>
          </tr>
        </thead>
        <tbody>
    `;
    
    purchase.products.forEach(p => {
      productsHTML += `
        <tr>
          <td>${escapeHtml(p.name || '-')}</td>
          <td>${p.qty || 0}</td>
          <td>${p.unit || 'pcs'}</td>
          <td>‚Çπ${Number(p.rate || 0).toFixed(2)}</td>
          <td style="font-weight: 600;">‚Çπ${Number(p.amount || 0).toFixed(2)}</td>
        </tr>
      `;
    });
    
    productsHTML += `
        </tbody>
      </table>
    `;
  } else if (typeof purchase.products === 'string') {
    productsHTML = `<p style="white-space: pre-wrap; margin: 0;">${escapeHtml(purchase.products)}</p>`;
  } else {
    productsHTML = '<p class="text-muted">No products listed</p>';
  }
  
  // ‚úÖ Format date
  const dateStr = purchase.date
    ? new Date(purchase.date).toLocaleString('en-IN', {
        day: '2-digit',
        month: 'short',
        year: 'numeric',
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
      })
    : 'Not specified';
  
  let html = `
    <div style="padding: 15px;">
      
      <div class="row mb-3">
        <div class="col-md-6">
          <strong>Serial No.:</strong> ${index + 1}
        </div>
        <div class="col-md-6">
          <strong>Date & Time:</strong> ${dateStr}
        </div>
      </div>
      
      ${purchase.photoBase64 ? `
        <div class="text-center mb-3">
          <img 
            src="${purchase.photoBase64}" 
            onclick="openPurchasePhotoLightbox(${index})" 
            style="max-width: 100%; max-height: 300px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer;" 
            alt="Purchase Photo"
            title="Click to view full size">
        </div>
      ` : ''}
      
      <div class="card mb-3">
        <div class="card-header bg-success text-white">
          <strong>Vendor Information</strong>
        </div>
        <div class="card-body">
          <h5>${escapeHtml(purchase.vendorName || 'Not specified')}</h5>
        </div>
      </div>
      
      <div class="card mb-3">
        <div class="card-header bg-success text-white">
          <strong>Products Purchased</strong>
        </div>
        <div class="card-body">
          ${productsHTML}
        </div>
      </div>
      
      <div class="card mb-3">
        <div class="card-header bg-success text-white">
          <strong>Payment Details</strong>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <strong>Total Amount:</strong>
              <div style="font-size: 1.5rem; color: #28a745; font-weight: 700;">‚Çπ${Number(purchase.totalAmount || 0).toFixed(2)}</div>
            </div>
            <div class="col-md-6">
              <strong>Payment Mode:</strong>
              <div>${formatPaymentModes(purchase.paymentModes) || 'Not specified'}</div>
            </div>
          </div>
        </div>
      </div>
      
      ${purchase.otherInfo ? `
        <div class="card">
          <div class="card-header bg-warning">
            <strong>Additional Information</strong>
          </div>
          <div class="card-body">
            <p style="white-space: pre-wrap; margin: 0;">${escapeHtml(purchase.otherInfo)}</p>
          </div>
        </div>
      ` : ''}
      
      <div class="text-center mt-3">
        <button class="btn btn-danger" onclick="confirmDeletePurchase('${purchase.purchaseId}')">
          <i class="bi bi-trash"></i> Delete Purchase
        </button>
      </div>
      
    </div>
  `;
  
  // Create modal if not exists
  let modal = document.getElementById('purchaseDetailModal');
  if (!modal) {
    modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'purchaseDetailModal';
    modal.innerHTML = `
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header bg-success text-white">
            <h5 class="modal-title">
              <i class="bi bi-receipt"></i> Purchase Details
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="purchaseDetailContent"></div>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }
  
  document.getElementById('purchaseDetailContent').innerHTML = html;
  
  const bsModal = new bootstrap.Modal(modal);
  bsModal.show();
}


/**
 * Confirm delete purchase - FIREBASE VERSION
 */
async function confirmDeletePurchase(purchaseId) {
  if (!confirm('Are you sure you want to delete this purchase? This cannot be undone.')) {
    return;
  }
  
  const user = window.auth.currentUser;
  if (!user) {
    alert('Please sign in first');
    return;
  }
  
  try {
    const { doc, deleteDoc } = window.firebaseImports;
    
    const purchaseDoc = doc(window.db, 'tenants', user.uid, 'purchases', purchaseId);
    await deleteDoc(purchaseDoc);
    
    alert('‚úÖ Purchase deleted successfully!');
    
    // Close detail modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('purchaseDetailModal'));
    if (modal) modal.hide();
    
    // Reload list
    await loadRecentPurchases();
    
  } catch (error) {
    console.error('‚ùå Error deleting purchase:', error);
    alert('‚ùå Failed to delete purchase: ' + error.message);
  }
}

/**
 * Remove product row
 */
function removePurchaseProductRow(rowId) {
  const row = document.getElementById(rowId);
  if (row) {
    row.remove();
    console.log('‚ùå Removed product row:', rowId);
  }
}

/**
 * Calculate row amount
 */
function calculatePurchaseRowAmount(rowId) {
  const row = document.getElementById(rowId);
  if (!row) return;
  
  const qtyInput = row.querySelector('[data-field="qty"]');
  const rateInput = row.querySelector('[data-field="rate"]');
  const amountInput = row.querySelector('[data-field="amount"]');
  
  const qty = parseFloat(qtyInput.value) || 0;
  const rate = parseFloat(rateInput.value) || 0;
  const amount = qty * rate;
  
  amountInput.value = amount.toFixed(2);
}
/**
 * ==========================================
 * HANDLE PHOTO UPLOAD WITH COMPRESSION
 * ==========================================
 */
function handlePurchasePhotoUpload(input) {
  const file = input.files[0];
  
  if (!file) {
    console.log('‚ö†Ô∏è No file selected');
    return;
  }
  
  console.log('üì∑ Photo selected:', file.name, file.size, 'bytes');
  
  // Check file type
  if (!file.type.startsWith('image/')) {
    alert('‚ùå Please select an image file.');
    input.value = '';
    return;
  }
  
  // ‚úÖ COMPRESS IMAGE IF TOO LARGE
  const reader = new FileReader();
  
  reader.onload = function(e) {
    const img = new Image();
    
    img.onload = function() {
      // ‚úÖ COMPRESS TO MAX 800px WIDTH
      const MAX_WIDTH = 800;
      const MAX_HEIGHT = 800;
      let width = img.width;
      let height = img.height;
      
      // Calculate new dimensions
      if (width > height) {
        if (width > MAX_WIDTH) {
          height = height * (MAX_WIDTH / width);
          width = MAX_WIDTH;
        }
      } else {
        if (height > MAX_HEIGHT) {
          width = width * (MAX_HEIGHT / height);
          height = MAX_HEIGHT;
        }
      }
      
      // Create canvas and compress
      const canvas = document.createElement('canvas');
      canvas.width = width;
      canvas.height = height;
      
      const ctx = canvas.getContext('2d');
      ctx.drawImage(img, 0, 0, width, height);
      
      // Convert to base64 with compression (0.7 quality = 70%)
      const compressedBase64 = canvas.toDataURL('image/jpeg', 0.7);
      
      // Check if still too large
      const sizeInBytes = (compressedBase64.length * 3) / 4;
      const sizeInKB = (sizeInBytes / 1024).toFixed(0);
      const sizeInMB = (sizeInBytes / (1024 * 1024)).toFixed(2);
      
      console.log(`‚úÖ Photo compressed: ${file.size} ‚Üí ${sizeInBytes} bytes (${sizeInKB} KB)`);
      
      // If still > 1MB, compress more
      if (sizeInBytes > 1000000) {
        console.warn('‚ö†Ô∏è Photo still too large, compressing further...');
        const extraCompressed = canvas.toDataURL('image/jpeg', 0.5);
        const newSize = (extraCompressed.length * 3) / 4;
        
        if (newSize > 1000000) {
          alert('‚ùå Photo is too large even after compression!\n\nPlease use a smaller photo (< 2MB original size).');
          input.value = '';
          return;
        }
        
        window.purchasePhotoBase64 = extraCompressed;
        console.log(`‚úÖ Extra compression applied: ${newSize} bytes`);
      } else {
        window.purchasePhotoBase64 = compressedBase64;
      }
      
      // ‚úÖ SHOW MOBILE-OPTIMIZED PHOTO PREVIEW
      const previewContainer = document.getElementById('purchasePhotoPreview');
      if (previewContainer) {
        previewContainer.innerHTML = `
          <div style="position: relative; width: 100%; max-width: 300px;">
            <img 
              src="${window.purchasePhotoBase64}" 
              onclick="viewPurchasePhotoPreview(); event.stopPropagation();"
              style="
                width: 100%; 
                height: auto;
                max-height: 200px; 
                object-fit: cover; 
                border-radius: 8px; 
                box-shadow: 0 2px 8px rgba(0,0,0,0.15);
                cursor: pointer;
                transition: transform 0.2s;
              "
              onmouseover="this.style.transform='scale(1.02)'"
              onmouseout="this.style.transform='scale(1)'"
              title="Click to view full size"
              alt="Purchase Photo Preview">
            <div style="
              position: absolute;
              top: 8px;
              right: 8px;
              background: rgba(220, 53, 69, 0.9);
              color: white;
              width: 32px;
              height: 32px;
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
              cursor: pointer;
              font-size: 1.2rem;
              font-weight: bold;
              box-shadow: 0 2px 6px rgba(0,0,0,0.3);
              transition: all 0.2s;
            "
            onclick="clearPurchasePhoto(); event.stopPropagation();"
            onmouseover="this.style.background='rgba(220, 53, 69, 1)'; this.style.transform='scale(1.1)'"
            onmouseout="this.style.background='rgba(220, 53, 69, 0.9)'; this.style.transform='scale(1)'"
            title="Remove photo">
              ‚úï
            </div>
          </div>
          <div style="
            margin-top: 10px; 
            color: #28a745; 
            font-size: 0.85rem; 
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
          ">
            <i class="bi bi-check-circle-fill"></i>
            <span>${file.name} (${sizeInKB} KB)</span>
          </div>
        `;
        
        previewContainer.style.border = '2px solid #28a745';
        previewContainer.style.background = '#f0f9f4';
        previewContainer.style.padding = '15px';
      }
    };
    
    img.src = e.target.result;
  };
  
  reader.onerror = function(error) {
    console.error('‚ùå Error reading photo:', error);
    alert('‚ùå Failed to read photo. Please try again.');
  };
  
  reader.readAsDataURL(file);
}


/**
 * View purchase photo preview in lightbox
 */
/**
 * View purchase photo preview in full screen (Mobile-Optimized)
 */
function viewPurchasePhotoPreview() {
  if (!window.purchasePhotoBase64) {
    alert('‚ùå No photo available');
    return;
  }
  
  // Create full-screen overlay
  const overlay = document.createElement('div');
  overlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.95);
    z-index: 99999;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 20px;
  `;
  
  // Header
  const header = document.createElement('div');
  header.style.cssText = `
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    padding: 15px 20px;
    font-size: 1.1rem;
    font-weight: 600;
    text-align: center;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  `;
  header.innerHTML = '<i class="bi bi-camera"></i> Photo Preview';
  overlay.appendChild(header);
  
  // Image
  const img = document.createElement('img');
  img.src = window.purchasePhotoBase64;
  img.style.cssText = `
    max-width: 95%;
    max-height: 80vh;
    object-fit: contain;
    border-radius: 8px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5);
    margin-top: 60px;
  `;
  overlay.appendChild(img);
  
  // Close button
  const closeBtn = document.createElement('button');
  closeBtn.innerHTML = '‚úï';
  closeBtn.style.cssText = `
    position: absolute;
    top: 70px;
    right: 15px;
    background: white;
    border: none;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    font-size: 1.6rem;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    z-index: 100000;
    transition: transform 0.2s;
  `;
  closeBtn.onmouseover = () => closeBtn.style.transform = 'scale(1.1)';
  closeBtn.onmouseout = () => closeBtn.style.transform = 'scale(1)';
  closeBtn.onclick = () => document.body.removeChild(overlay);
  overlay.appendChild(closeBtn);
  
  // Close on background click
  overlay.onclick = (e) => {
    if (e.target === overlay) {
      document.body.removeChild(overlay);
    }
  };
  
  // Add to body
  document.body.appendChild(overlay);
  
  console.log('üì∏ Opened photo preview');
}



    
/**
 * Clear photo
 */
/**
 * Clear photo (SAFE VERSION - checks if elements exist)
/**
 * Clear photo and reset preview area
 */
/**
 * Clear photo and reset preview (Mobile-Optimized)
 */
function clearPurchasePhoto() {
  console.log('üóëÔ∏è Clearing purchase photo');
  
  try {
    // Reset photo base64
    window.purchasePhotoBase64 = null;
    
    // Clear file input
    const photoInput = document.getElementById('purchasePhotoInput');
    if (photoInput) {
      photoInput.value = '';
    }
    
    // Reset preview container to original state
    const previewContainer = document.getElementById('purchasePhotoPreview');
    if (previewContainer) {
      previewContainer.innerHTML = `
        <i class="bi bi-camera" style="font-size: 2rem; color: #999;"></i>
        <p style="color: #999; margin: 8px 0 0 0; font-size: 0.9rem;">Tap or paste photo</p>
      `;
      
      previewContainer.style.border = '2px dashed #ccc';
      previewContainer.style.background = '#f8f9fa';
      previewContainer.style.padding = '20px';
      previewContainer.onclick = () => triggerPhotoInput();
    }
    
    // Hide remove button
    const removeBtn = document.getElementById('clearPurchasePhotoBtn');
    if (removeBtn) {
      removeBtn.style.display = 'none';
    }
    
    console.log('‚úÖ Photo cleared');
  } catch (e) {
    console.log('‚ö†Ô∏è Error clearing photo:', e.message);
  }
}


/**
 * Open camera
 */
function openPurchaseCamera() {
  const input = document.getElementById('purchasePhotoInput');
  input.setAttribute('capture', 'environment');
  input.click();
}



/**
 * ==========================================
 * BULK ADD PRODUCTS FOR PURCHASE 
 * ==========================================
 */
let selectedBulkProductsPurchase = {};

function openBulkAddModalForPurchase() {
  console.log('üì¶ Opening Bulk Add Modal for Purchase');
  
  // ‚úÖ ALWAYS RESET COMPLETELY
  document.getElementById('bulkSearchInputPurchase').value = '';
  selectedBulkProductsPurchase = {};
  
  // Render products
  renderBulkProductsListPurchase('');
  
  // ‚úÖ Clear selected items panel
  const selectedContainer = document.getElementById('bulkSelectedItemsPurchase');
  if (selectedContainer) {
    selectedContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">No items selected</div>';
  }
  
  // ‚úÖ Reset counters
  updateBulkCountersPurchase();
  
  // Show modal
  const modal = new bootstrap.Modal(document.getElementById('bulkAddModalForPurchase'));
  modal.show();
  
  console.log('‚úÖ Modal opened with clean state');
}

function filterBulkProductsPurchase(query) {
  renderBulkProductsListPurchase(query);
}

function renderBulkProductsListPurchase(searchQuery) {
  const container = document.getElementById('bulkProductsListPurchase');
  if (!container) return;
  
  const products = cachedProducts || [];
  let filtered = products;
  
  if (searchQuery && searchQuery.trim().length > 0) {
    const query = searchQuery.toLowerCase();
    filtered = products.filter(product => {
      const name = (product.name || '').toLowerCase();
      const brand = (product.brand || '').toLowerCase();
      const category = (product.category || '').toLowerCase();
      return name.includes(query) || brand.includes(query) || category.includes(query);
    });
  }
  
  if (filtered.length === 0) {
    container.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">No products found</div>';
    return;
  }
  
  let html = '';
  filtered.forEach(product => {
    const isSelected = selectedBulkProductsPurchase[product.id];
    const displayName = product.size ? `${product.name} (${product.size})` : product.name;
    const priceText = product.price ? `‚Çπ${product.price}` : 'N/A';
    
    html += `
      <div onclick="toggleBulkProductSelectionPurchase('${product.id}')"
           style="
             padding: 12px;
             border-bottom: 1px solid #f0f0f0;
             cursor: pointer;
             transition: background-color 0.2s;
             display: flex;
             justify-content: space-between;
             align-items: center;
             ${isSelected ? 'background-color: #e3f2fd;' : 'background-color: white;'}
           "
           onmouseover="this.style.backgroundColor='#f5f5f5'"
           onmouseout="this.style.backgroundColor='${isSelected ? '#e3f2fd' : 'white'}'">
        <div style="flex: 1;">
          <strong>${escapeHtml(displayName)}</strong>
          <div style="font-size: 0.85rem; color: #666;">${priceText}</div>
        </div>
        <div>${isSelected ? '‚úì' : ''}</div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

function toggleBulkProductSelectionPurchase(productId) {
  const product = cachedProducts.find(p => p.id === productId);
  if (!product) return;
  
  if (selectedBulkProductsPurchase[productId]) {
    delete selectedBulkProductsPurchase[productId];
  } else {
    selectedBulkProductsPurchase[productId] = {
      id: product.id,
      name: product.name,
      size: product.size || '',
      price: product.price || 0,
      unitType: product.unitType || 'Pieces',
      qty: 1
    };
  }
  
  renderBulkProductsListPurchase(document.getElementById('bulkSearchInputPurchase').value);
  renderBulkSelectedItemsPurchase();
}

function renderBulkSelectedItemsPurchase() {
  const container = document.getElementById('bulkSelectedItemsPurchase');
  if (!container) return;
  
  const selectedArray = Object.values(selectedBulkProductsPurchase);
  
  if (selectedArray.length === 0) {
    container.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">No items selected</div>';
    updateBulkCountersPurchase();
    return;
  }
  
  let html = '';
  selectedArray.forEach(product => {
    const displayName = product.size ? `${product.name} (${product.size})` : product.name;
    
    html += `
      <div style="padding: 12px; border-bottom: 1px solid #ddd;">
        <div style="margin-bottom: 8px;">
          <strong>${escapeHtml(displayName)}</strong>
          <div style="font-size: 0.85rem; color: #666;">‚Çπ${product.price}</div>
        </div>
        
        <div style="display: flex; justify-content: space-between; align-items: center; gap: 8px;">
          <div style="display: flex; align-items: center; gap: 4px;">
            <button type="button" onclick="updateBulkQtyPurchase('${product.id}', -1)"
                    style="padding: 6px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">‚àí</button>
            <input type="number" value="${product.qty}" min="1"
                   style="width: 50px; text-align: center; padding: 6px; border: 1px solid #ddd; border-radius: 4px;"
                   onchange="updateBulkQtyDirectPurchase('${product.id}', this.value)">
            <button type="button" onclick="updateBulkQtyPurchase('${product.id}', 1)"
                    style="padding: 6px 10px; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">+</button>
          </div>
          <button type="button" onclick="toggleBulkProductSelectionPurchase('${product.id}')"
                  style="padding: 6px 10px; font-size: 16px; cursor: pointer; color: #dc3545; background: none; border: none;">‚úï</button>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
  updateBulkCountersPurchase();
}

function updateBulkQtyPurchase(productId, change) {
  if (selectedBulkProductsPurchase[productId]) {
    const newQty = Math.max(1, selectedBulkProductsPurchase[productId].qty + change);
    selectedBulkProductsPurchase[productId].qty = newQty;
    renderBulkSelectedItemsPurchase();
  }
}

function updateBulkQtyDirectPurchase(productId, value) {
  if (selectedBulkProductsPurchase[productId]) {
    const newQty = Math.max(1, parseInt(value) || 1);
    selectedBulkProductsPurchase[productId].qty = newQty;
    renderBulkSelectedItemsPurchase();
  }
}

function updateBulkCountersPurchase() {
  const selectedArray = Object.values(selectedBulkProductsPurchase);
  const selectedCount = selectedArray.length;
  const totalQty = selectedArray.reduce((sum, p) => sum + p.qty, 0);
  
  document.getElementById('bulkSelectedCountPurchase').textContent = selectedCount;
  document.getElementById('bulkTotalQtyPurchase').textContent = totalQty;
}

/**
 * ‚úÖ ADD BULK PRODUCTS - MERGE DUPLICATES & AUTO-CLOSE
 */
function addBulkProductsToPurchase() {
  const selectedArray = Object.values(selectedBulkProductsPurchase);
  
  if (selectedArray.length === 0) {
    alert('‚ùå Please select at least one product');
    return;
  }
  
  console.log('üì¶ Adding', selectedArray.length, 'products to purchase');
  
  const container = document.getElementById('purchaseProductRows');
  if (!container) return;
  
  // ‚úÖ GET ALL EXISTING ROWS
  const existingRows = container.querySelectorAll('.purchase-product-row');
  
  selectedArray.forEach(product => {
    const productName = product.size ? `${product.name} (${product.size})` : product.name;
    
    // ‚úÖ CHECK IF PRODUCT ALREADY EXISTS
    let existingRow = null;
    existingRows.forEach(row => {
      const nameInput = row.querySelector('input[data-field="name"]');
      if (nameInput && nameInput.value.trim() === productName) {
        existingRow = row;
      }
    });
    
    if (existingRow) {
      // ‚úÖ PRODUCT EXISTS - MERGE QUANTITY
      const qtyInput = existingRow.querySelector('input[data-field="qty"]');
      if (qtyInput) {
        const currentQty = parseFloat(qtyInput.value) || 0;
        const newQty = currentQty + product.qty;
        qtyInput.value = newQty;
        
        // Trigger amount recalculation
        const rowId = existingRow.id;
        if (rowId && typeof calculatePurchaseRowAmount === 'function') {
          calculatePurchaseRowAmount(rowId);
        }
        
        console.log(`‚úÖ Merged: ${productName} - Updated qty to ${newQty}`);
      }
    } else {
      // ‚úÖ NEW PRODUCT - ADD TO TOP
      purchaseProductRowCounter++;
      const rowId = `purchaseRow${purchaseProductRowCounter}`;
      
      const rowDiv = document.createElement('div');
      rowDiv.id = rowId;
      rowDiv.className = 'purchase-product-row';

      rowDiv.innerHTML = `
        <input type="text" class="form-control" placeholder="Product name"
               value="${escapeHtml(productName)}" data-field="name">
        <input type="number" class="form-control" placeholder="Qty" min="1"
               value="${product.qty}" oninput="calculatePurchaseRowAmount('${rowId}')" data-field="qty">
        <input type="number" class="form-control" placeholder="Rate" min="0" step="0.01"
               value="${product.price}" oninput="calculatePurchaseRowAmount('${rowId}')" data-field="rate">
        <select class="form-select" data-field="unit">
          <option value="Pieces" ${product.unitType === 'Pieces' ? 'selected' : ''}>Pcs</option>
          <option value="Boxes" ${product.unitType === 'Boxes' ? 'selected' : ''}>Box</option>
          <option value="Kg" ${product.unitType === 'Kg' ? 'selected' : ''}>Kg</option>
          <option value="Liters" ${product.unitType === 'Liters' ? 'selected' : ''}>L</option>
        </select>
        <input type="number" class="form-control" placeholder="Amount" readonly
               value="${(product.qty * product.price).toFixed(2)}" data-field="amount"
               style="background: #e8f5e9; font-weight: 600; color: #2e7d32;">
        <button type="button" class="btn btn-danger purchase-remove-btn"
            onclick="removePurchaseProductRow('${rowId}')"
            style="font-size:22px;padding:0;min-width:36px;height:36px;">
          √ó
        </button>
      `;

      container.insertBefore(rowDiv, container.firstChild);
      console.log(`‚úÖ Added new: ${productName} - Qty ${product.qty}`);
    }
  });
  
  // ‚úÖ CLEAR SELECTIONS & CLOSE MODAL
  selectedBulkProductsPurchase = {};
  
  const modal = bootstrap.Modal.getInstance(document.getElementById('bulkAddModalForPurchase'));
  if (modal) {
    modal.hide();
  }
  
  console.log('‚úÖ Products added/merged successfully! Modal closed.');
}

/**
 * ‚úÖ HANDLE MODAL CLOSE EVENTS - FORCE RESET
 */
document.addEventListener('DOMContentLoaded', function() {
  const bulkModal = document.getElementById('bulkAddModalForPurchase');
  if (bulkModal) {
    bulkModal.addEventListener('hidden.bs.modal', function () {
      // ‚úÖ Force clear when modal closes by ANY method
      selectedBulkProductsPurchase = {};
      console.log('‚úÖ Bulk modal closed - selections cleared');
    });
  }
});


/**
 * Toggle checkmark visibility for payment modes
 */
function togglePaymentModeCheckmark(checkbox, checkmarkId) {
  const checkmark = document.getElementById(checkmarkId);
  if (checkmark) {
    if (checkbox.checked) {
      checkmark.style.display = 'block';
      console.log('‚úì Checkmark shown for', checkmarkId);
    } else {
      checkmark.style.display = 'none';
      console.log('‚úó Checkmark hidden for', checkmarkId);
    }
  }
}


/**
 * Toggle collapsible sections on mobile
 */
function toggleSection(sectionId) {
  // Only work on mobile
  if (window.innerWidth > 767) return;
  
  const section = document.getElementById(sectionId);
  const icon = document.getElementById(sectionId + 'Icon');
  
  if (section && icon) {
    section.classList.toggle('open');
    icon.classList.toggle('open');
    console.log('üì± Toggled section:', sectionId);
  }
}









    
    

  /***********************
   * SALES GRID: create rows, populate selects, mobile behavior
   ***********************/
  function openSalesModal(){
  initSalesGrid();
  populateMultiSelect(); // √É∆í√Ç¬¢√É‚Ä¶√¢‚Ç¨≈ì√É¬¢√¢‚Äö¬¨√Ç¬¶ NEW: Populate multi-select
  new bootstrap.Modal(document.getElementById('salesModal')).show();
}

// √¢≈ì‚Ä¶ CORRECTED: Multi-Select Functions with Photo Support
function populateMultiSelect() {
    const container = document.getElementById('multiSelectList');
    if (!container) return;
    
    let html = '';
    
    cachedProducts
        .filter(p => {
            // Include photo products ONLY if they have stock AND price
            if (p.imageUrl && p.imageUrl !== '' && p.imageUrl !== 'uploading...') {
                const hasStockAndPrice = p.stock > 0 && p.price > 0;
                console.log(`Photo product "${p.name}": stock=${p.stock}, price=${p.price}, showing=${hasStockAndPrice}`);
                return hasStockAndPrice;
            }
            // Include regular products with stock
            return p.stock > 0;
        })
        .forEach(product => {
            // Add photo thumbnail if available
            const photoHTML = (product.imageUrl && product.imageUrl !== 'uploading...') ? 
                `<img src="${product.imageUrl}" 
                     class="photo-thumbnail-small" 
                     alt="${escapeHtml(product.name)}" 
                     style="width:40px; height:40px; object-fit:cover; border-radius:4px; border:2px solid #e0e0e0; margin-right:8px; vertical-align:middle;"
                     onerror="this.style.display='none'; console.error('Failed to load image for: ${escapeHtml(product.name)}');">` : '';
            
            html += `
                <div class="multi-select-item">
                    <div class="form-check">
                        <input class="form-check-input multi-select-checkbox" type="checkbox" 
                               id="multi-${product.id}" 
                               value="${product.id}"
                               onchange="onMultiSelectChange()">
                        ${photoHTML}
                        <label class="form-check-label" for="multi-${product.id}">
                            ${escapeHtml(product.name)} 
                            <small class="text-muted">(Stock: ${product.stock} ${product.unitType})</small>
                        </label>
                    </div>
                </div>
            `;
        });
    
    container.innerHTML = html || '<small class="text-muted">No products available</small>';
    
    // Debug: Log how many products are shown
    console.log(`Multi-select populated with ${cachedProducts.filter(p => p.stock > 0).length} products`);
}



function toggleMultiSelect() {
    const options = document.getElementById('multiSelectOptions');
    options.classList.toggle('show');
}

function filterMultiSelectOptions() {
    const searchTerm = document.getElementById('multiSelectSearch').value.toLowerCase();
    const items = document.querySelectorAll('.multi-select-item');
    
    items.forEach(item => {
        const text = item.textContent.toLowerCase();
        item.style.display = text.includes(searchTerm) ? '' : 'none';
    });
}

function onMultiSelectChange() {
    const checkedProducts = [];
    
    // Get all checked checkboxes
    document.querySelectorAll('.multi-select-checkbox:checked').forEach(checkbox => {
        const productId = checkbox.value;
        const product = cachedProducts.find(p => p.id === productId);
        if (product) {
            checkedProducts.push(product);
        }
    });
    
    // Update label
    const label = document.getElementById('multiSelectLabel');
    if (checkedProducts.length === 0) {
        label.innerHTML = 'Click to select multiple products...';
    } else {
        label.innerHTML = `<strong>${checkedProducts.length} product${checkedProducts.length > 1 ? 's' : ''} selected</strong>`;
    }
    
    // Auto-populate rows
    ensureEnoughRows(checkedProducts.length);
    populateRowsWithSelectedProducts(checkedProducts);
}

function ensureEnoughRows(needed) {
    const currentRows = document.querySelectorAll('#product-grid-body tr').length;
    if (needed > currentRows) {
        const rowsToAdd = needed - currentRows;
        for (let i = 0; i < rowsToAdd; i++) {
            const currentCount = document.querySelectorAll('#product-grid-body tr').length;
            appendEmptyRow(currentCount + 1);
        }
        updateRowNumbers();
    }
}

function populateRowsWithSelectedProducts(products) {
    products.forEach((product, index) => {
        const rowIndex = index + 1;
        
        // Select product in dropdown
        const select = document.getElementById(`product-${rowIndex}`);
        if (select) {
            select.value = product.id;
            onProductSelect(rowIndex); // Trigger auto-fill
        }
    });
    
    updateGrandTotal();
}

// Close multi-select when clicking outside
document.addEventListener('click', function(e) {
    const dropdown = document.querySelector('.multi-select-dropdown');
    const options = document.getElementById('multiSelectOptions');
    if (dropdown && !dropdown.contains(e.target) && options) {
        options.classList.remove('show');
    }
});



    
  function initSalesGrid(){
    const body = document.getElementById('product-grid-body');
    body.innerHTML = '';
    for(let i=1;i<=3;i++) appendEmptyRow(i);
    updateRowNumbers();
    updateGrandTotal();
  }

  function appendEmptyRow(index){
    const tbody = document.getElementById('product-grid-body');
    const tr = document.createElement('tr');
    tr.className = 'product-row';
    tr.dataset.custom = 'false';
    tr.innerHTML = `
      <td class="grid-row-number"></td>
      <td>
        <select class="form-select product-select" id="product-${index}" onchange="onProductSelect(${index})">
          <option value="">-- Select Product --</option>
        </select>
      </td>
      <td><input type="text" class="form-control size-input readonly-input" id="size-${index}" readonly /></td>
      <td><input type="number" class="form-control qty-input" id="qty-${index}" min="1" disabled placeholder="Enter quantity" oninput="onQtyChange(${index})"></td>

      <td><input type="text" class="form-control unit-input readonly-input" id="unit-${index}" readonly /></td>
      <td><input type="number" class="form-control price-input readonly-input" id="price-${index}" readonly /></td>
      <td><div id="total-${index}" class="fw-bold">‚Çπ0.00</div></td>
      <td><button class="btn btn-sm btn-outline-danger" onclick="removeRow(this)"><i class="bi bi-x"></i></button></td>
    `;
    tbody.appendChild(tr);
    populateProductSelectForRow(index);
  }

  function addMoreRows(){
    const currentCount = document.querySelectorAll('#product-grid-body .product-row').length;
    for(let i=1;i<=3;i++) appendEmptyRow(currentCount+i);
    updateRowNumbers();
  }

 function removeRow(btn) {
  const tr = btn.closest('tr')
  if(!tr) return
  
  // √É∆í√Ç¬¢√É‚Ä¶√¢‚Ç¨≈ì√É¬¢√¢‚Äö¬¨√Ç¬¶ FIX: Don't actually delete the row - just clear/reset it
  const select = tr.querySelector('.product-select')
  const sizeEl = tr.querySelector('.size-input')
  const qtyEl = tr.querySelector('.qty-input')
  const unitEl = tr.querySelector('.unit-input')
  const priceEl = tr.querySelector('.price-input')
  const totalEl = tr.querySelector('[id^="total-"]')
  
  // If custom product, remove from array
  if(select && select.value && select.value.startsWith('CUST_TMP_')) {
    customProductsInSale = customProductsInSale.filter(c => c.tempId !== select.value)
  }
  
  // Reset all fields to empty/default state
  if(select) {
    select.value = ''
    select.disabled = false
  }
  if(sizeEl) sizeEl.value = ''
  if(unitEl) unitEl.value = ''
  if(priceEl) priceEl.value = ''
  if(qtyEl) {
    qtyEl.value = ''
    qtyEl.disabled = true // Disable until product selected
    qtyEl.removeAttribute('max')
  }
  if(totalEl) totalEl.textContent = formatCurrency(0)
  
  // √É∆í√Ç¬¢√É‚Ä¶√¢‚Ç¨≈ì√É¬¢√¢‚Äö¬¨√Ç¬¶ CRITICAL: Get row index and re-attach event listener
  const rowIndex = Array.from(tr.parentNode.children).indexOf(tr) + 1;
  
  if(select) {
    // Re-populate select options
    populateProductSelectForRow(rowIndex);
    
    // Re-attach onchange handler
    select.onchange = function() {
      onProductSelect(rowIndex);
    };
  }
  
  updateGrandTotal()
}


  function updateRowNumbers(){
    const rows = document.querySelectorAll('#product-grid-body .product-row');
    rows.forEach((r,i)=>{
      const idx = i+1;
      r.querySelector('.grid-row-number').textContent = idx;
      // update element ids to keep consistent
      const sel = r.querySelector('.product-select'); if(sel) sel.id = `product-${idx}`;
      const sizeEl = r.querySelector('.size-input'); if(sizeEl) sizeEl.id = `size-${idx}`;
      const qtyEl = r.querySelector('.qty-input'); if(qtyEl){ qtyEl.id = `qty-${idx}`; qtyEl.setAttribute('oninput', `onQtyChange(${idx})`); }
      const unitEl = r.querySelector('.unit-input'); if(unitEl) unitEl.id = `unit-${idx}`;
      const priceEl = r.querySelector('.price-input'); if(priceEl) priceEl.id = `price-${idx}`;
      const totalEl = r.querySelector('[id^=total-]'); if(totalEl) totalEl.id = `total-${idx}`;
      // ensure options refreshed (keeps custom options)
      populateProductSelectForRow(idx);
    });
  }


    // ========== NEW: Sort sales by date (newest first) ==========
function sortSalesByDateDescending() {
    cachedSales.sort((a, b) => {
        const dateA = new Date(a.date);
        const dateB = new Date(b.date);
        return dateB - dateA; // Newest first
    });
    console.log('√É∆í√Ü‚Äô√É‚Äö√Ç¬∞√É∆í√¢‚Ç¨¬¶√É‚Äö√Ç¬∏√É∆í√Ç¬¢√É¬¢√¢‚Ç¨≈°√Ç¬¨√É‚Äö√Ç¬ù√É∆í√Ç¬¢√É¬¢√¢‚Ç¨≈°√Ç¬¨√É‚Ä¶√Ç¬æ Sales sorted: newest first');
}

  /***********************
   * Row interactions
   ***********************/
  function onProductSelect(rowIndex){
    const sel = document.getElementById(`product-${rowIndex}`);
    const sizeEl = document.getElementById(`size-${rowIndex}`);
    const unitEl = document.getElementById(`unit-${rowIndex}`);
    const priceEl = document.getElementById(`price-${rowIndex}`);
    const qtyEl = document.getElementById(`qty-${rowIndex}`);
    if(!sel) return;
    const val = sel.value;
    if(!val){
      if(sizeEl) sizeEl.value=''; if(unitEl) unitEl.value=''; if(priceEl) priceEl.value=''; if(qtyEl){ qtyEl.value=''; qtyEl.disabled=true; qtyEl.removeAttribute('max'); }
      document.getElementById(`total-${rowIndex}`).textContent = formatCurrency(0);
      updateGrandTotal(); return;
    }
    // if this value is a custom temporary product
    if(val.startsWith('CUST_TMP_')){
      const cp = customProductsInSale.find(c => c.tempId === val);
      if(cp){
        sizeEl.value = cp.size || 'N/A';
        unitEl.value = cp.unitType;
        priceEl.value = cp.price;
        qtyEl.disabled = false;
        qtyEl.max = cp.quantity || '';
        qtyEl.value = cp.quantity || '';
        document.getElementById(`total-${rowIndex}`).textContent = formatCurrency(cp.price * (cp.quantity||0));
        updateGrandTotal();
      }
      return;
    }
    // Normal product from cachedProducts
    const product = (cachedProducts || []).find(p => p.id === val);
    if(!product){ sizeEl.value=''; unitEl.value=''; priceEl.value=''; if(qtyEl){ qtyEl.disabled=true; qtyEl.value=''; } return; }
    sizeEl.value = product.size || 'N/A';
    unitEl.value = product.unitType || '';
    priceEl.value = product.price || 0;
    qtyEl.disabled = false;
    qtyEl.value = '';
    qtyEl.max = product.stock || '';
    document.getElementById(`total-${rowIndex}`).textContent = formatCurrency(0);
    updateGrandTotal();
  }

  function onQtyChange(rowIndex){
    const qtyEl = document.getElementById(`qty-${rowIndex}`);
    if(!qtyEl) return;
    const qty = Number(qtyEl.value || 0);
    const max = Number(qtyEl.max || Infinity);
    if(qty > max){
      alert(`√É∆í√Ç¬¢√É‚Äö√Ç¬ù√É‚Ä¶√¢‚Ç¨‚Ñ¢ Quantity exceeds available stock (${max}). Adjusting to max.`);
      qtyEl.value = max;
    }
    updateRowTotal(rowIndex);
    updateGrandTotal();
  }

  function updateRowTotal(rowIndex){
    const price = Number(document.getElementById(`price-${rowIndex}`).value || 0);
    const qty = Number(document.getElementById(`qty-${rowIndex}`).value || 0);
    const total = price * qty;
    const el = document.getElementById(`total-${rowIndex}`);
    if(el) el.textContent = formatCurrency(total);
    return total;
  }

  function updateGrandTotal(){
    let grand = 0;
    const rows = document.querySelectorAll('#product-grid-body .product-row');
    rows.forEach((r,i)=>{
      const idx = i+1;
      const sel = document.getElementById(`product-${idx}`);
      if(!sel) return;
      if(!sel.value && r.dataset.custom!=='true') return;
      const qty = Number(document.getElementById(`qty-${idx}`)?.value || 0);
      const price = Number(document.getElementById(`price-${idx}`)?.value || 0);
      const line = qty * price;
      grand += line;
      const totalEl = document.getElementById(`total-${idx}`);
      if(totalEl) totalEl.textContent = formatCurrency(line);
    });
    document.getElementById('grandTotal').textContent = formatCurrency(grand);
    document.getElementById('subtotal').textContent = formatCurrency(grand);
  }

  /***********************
   * CUSTOM PRODUCT: open, validate, add to grid (and optionally inventory)
   ***********************/
function openCustomProductPopup() {
  document.getElementById('customProductForm').reset();
  document.getElementById('customTotal').textContent = '‚Çπ0.00';
  new bootstrap.Modal(document.getElementById('customProductModal'), {backdrop: 'static'}).show();
  setTimeout(() => document.getElementById('customName').focus(), 200);
}

  function updateCustomTotalDisplay(){
    const qty = Number(document.getElementById('customQty').value || 0);
    const price = Number(document.getElementById('customPrice').value || 0);
    document.getElementById('customTotal').textContent = formatCurrency(qty * price);
  }
  // Attach in case DOM ready
  document.addEventListener('input', (e)=>{
    if(e.target && (e.target.id==='customQty' || e.target.id==='customPrice')) updateCustomTotalDisplay();
  });

function validateCustomProduct() {
  const name = document.getElementById('customName').value.trim();
  const qty = Number(document.getElementById('customQty').value || 0);
  const price = Number(document.getElementById('customPrice').value || 0);
  
  if (!name || name.length < 2) {
    alert('√É∆í√Ç¬¢√É‚Äö√Ç¬ù√É‚Ä¶√¢‚Ç¨‚Ñ¢ Product name required (min 2 chars)');
    return false;
  }
  
  if (!qty || qty < 1) {
    alert('√É∆í√Ç¬¢√É‚Äö√Ç¬ù√É‚Ä¶√¢‚Ç¨‚Ñ¢ Quantity must be at least 1');
    return false;
  }
  
  if (!price || price <= 0) {
    alert('√É∆í√Ç¬¢√É‚Äö√Ç¬ù√É‚Ä¶√¢‚Ç¨‚Ñ¢ Unit price must be greater than 0');
    return false;
  }
  
  return true;
}


function addCustomProductToGrid() {
  if (!validateCustomProduct()) return;
  
  const name = document.getElementById('customName').value.trim();
  const size = document.getElementById('customSize').value.trim() || 'N/A';
  const qty = Number(document.getElementById('customQty').value || 0);
  const unitType = document.getElementById('customUnit').value || 'Box';
  const price = Number(document.getElementById('customPrice').value || 0);
  
  const tempId = 'CUST_TMP_' + Date.now().toString(36); // Unique temp id
  
  // Store in persistent array
  const cp = {
    tempId: tempId,
    name: name,
    size: size,
    unitType: unitType,
    price: price,
    quantity: qty
  };
  
  customProductsInSale.push(cp);
  
  // Find first empty row or append new row
  let idx = findFirstEmptyRowIndex();
  if (!idx) {
    const count = document.querySelectorAll('#product-grid-body .product-row').length;
    appendEmptyRow(count + 1);
    updateRowNumbers();
    idx = count + 1;
  }
  
  // Populate row with custom data
  populateRowWithCustom(idx, cp);
  updateGrandTotal();
  
  // Close modal
  const modal = bootstrap.Modal.getInstance(document.getElementById('customProductModal'));
  if (modal) modal.hide();
  
  // Show success
  alert(`√É∆í√Ç¬¢√É‚Ä¶√¢‚Ç¨≈ì√É¬¢√¢‚Äö¬¨√Ç¬¶ Custom product "${name}" added to sale!`);
}


function populateRowWithCustom(rowIndex, cp){
    const sel = document.getElementById(`product-${rowIndex}`);
    if(!sel) return;
    // ensure select contains this option (populateProductSelectForRow will add it)
    populateProductSelectForRow(rowIndex);
    // create or update option
    let opt = Array.from(sel.options).find(o=>o.value===cp.tempId);
    if(!opt){
      opt = document.createElement('option');
      opt.value = cp.tempId;
      opt.text = `${cp.name} (Custom)`;
      opt.dataset.size = cp.size;
      opt.dataset.unit = cp.unitType;
      opt.dataset.price = cp.price;
      opt.dataset.stock = cp.quantity;
      sel.appendChild(opt);
    }
    sel.value = cp.tempId;
    document.getElementById(`size-${rowIndex}`).value = cp.size;
    document.getElementById(`unit-${rowIndex}`).value = cp.unitType;
    document.getElementById(`price-${rowIndex}`).value = cp.price;
    
    // √É∆í√Ç¬¢√É‚Ä¶√¢‚Ç¨≈ì√É¬¢√¢‚Äö¬¨√Ç¬¶ FIX: Make quantity editable for custom products
    const qtyEl = document.getElementById(`qty-${rowIndex}`);
    qtyEl.disabled = false;  // √É∆í√Ç¬¢√É‚Ä¶√¢‚Ç¨≈ì√É¬¢√¢‚Äö¬¨√Ç¬¶ Keep enabled
    qtyEl.readOnly = false;  // √É∆í√Ç¬¢√É‚Ä¶√¢‚Ç¨≈ì√É¬¢√¢‚Äö¬¨√Ç¬¶ Not read-only
    qtyEl.value = cp.quantity;
    qtyEl.max = cp.quantity; // Can increase up to this amount
    
    // √É∆í√Ç¬¢√É‚Ä¶√¢‚Ç¨≈ì√É¬¢√¢‚Äö¬¨√Ç¬¶ NEW: Add event listener to update total when quantity changes
    qtyEl.addEventListener('input', function() {
        const newQty = parseFloat(this.value) || 0;
        const price = parseFloat(document.getElementById(`price-${rowIndex}`).value) || 0;
        const total = newQty * price;
        document.getElementById(`total-${rowIndex}`).textContent = formatCurrency(total);
        updateGrandTotal();
    });
    
    // Set initial total
    document.getElementById(`total-${rowIndex}`).textContent = formatCurrency(cp.price * cp.quantity);
}



  function findFirstEmptyRowIndex(){
    const rows = document.querySelectorAll('#product-grid-body .product-row');
    for(let i=0;i<rows.length;i++){
      const idx = i+1;
      const sel = document.getElementById(`product-${idx}`);
      if(!sel || !sel.value) return idx;
    }
    return null;
  }


/**
 * ==========================================
 * COMPLETE SALE - SAFE VERSION WITH AUTO-RELOAD
 * ==========================================
 */
async function completeSale() {
  const user = window.auth.currentUser;
  if (!user) {
    alert('Please sign in first');
    return;
  }
  
  // Collect valid sale items from the form
  const saleItems = [];
  const rows = document.querySelectorAll('#product-grid-body .product-row');
  const saleId = 'SALE_' + Date.now().toString(36);
  
  rows.forEach((r, i) => {
    const idx = i + 1;
    const sel = document.getElementById(`product-${idx}`);
    const qtyEl = document.getElementById(`qty-${idx}`);
    
    if (!sel || !sel.value || !qtyEl || !qtyEl.value || Number(qtyEl.value) <= 0) {
      return;
    }
    
    const productId = sel.value;
    const quantity = Number(qtyEl.value);
    const unitPrice = Number(document.getElementById(`price-${idx}`).value || 0);
    const totalAmount = quantity * unitPrice;
    const size = document.getElementById(`size-${idx}`).value || 'N/A';
    const unitType = document.getElementById(`unit-${idx}`).value || '';
    
    const isCustom = productId.startsWith('CUST_TMP_');
    let productName = '';
    
    if (isCustom) {
      const cp = customProductsInSale.find(c => c.tempId === productId);
      productName = cp ? cp.name : 'Custom Product';
    } else {
      const prod = cachedProducts.find(p => p.id === productId);
      productName = prod ? prod.name : 'Unknown Product';
    }
    
    saleItems.push({
      saleId: saleId,
      productId: isCustom ? '' : productId,
      productName: productName,
      size: size,
      quantity: quantity,
      unitType: unitType,
      unitPrice: unitPrice,
      totalAmount: totalAmount,
      isCustomProduct: isCustom
    });
  });
  
  // Validation
  if (saleItems.length === 0) {
    alert('‚ö†Ô∏è No products selected. Please add at least one product to complete the sale.');
    return;
  }
  
  const totalAmount = saleItems.reduce((sum, item) => sum + item.totalAmount, 0);
  
  if (!confirm(`üì¶ Complete sale with ${saleItems.length} item(s)?\n\nTotal: ${formatCurrency(totalAmount)}`)) {
    return;
  }
  
  console.log(`‚úÖ Sale confirmed: ${saleItems.length} items, total ${formatCurrency(totalAmount)}`);
  
  // ==========================================
  // ‚úÖ STEP 1: INSTANT UI UPDATES (< 100ms)
  // ==========================================
  
  saleItems.forEach(item => {
    const newSale = {
      id: generateId(),
      saleId: item.saleId,
      productId: item.productId,
      productName: item.productName,
      size: item.size,
      quantity: item.quantity,
      unitType: item.unitType,
      unitPrice: item.unitPrice,
      totalAmount: item.totalAmount,
      date: new Date().toISOString(),
      isCustomProduct: item.isCustomProduct,
      userId: user.uid
    };
    cachedSales.unshift(newSale);
    
    // Update stock locally (for non-custom products)
    if (!item.isCustomProduct && item.productId) {
      const prod = cachedProducts.find(p => p.id === item.productId);
      if (prod) {
        prod.stock = Math.max(0, prod.stock - item.quantity);
      }
    }
  });
  
  // Re-render UI immediately
  try {
    renderProducts();
  } catch (e) {
    console.error('‚ùå Failed to render products:', e.message);
  }
  
  try {
    renderSales();
  } catch (e) {
    console.error('‚ùå Failed to render sales:', e.message);
  }
  
  try {
    updateSummaryFromCache();
  } catch (e) {
    console.error('‚ùå Failed to update summary:', e.message);
  }
  
  // Close modal immediately
  const modal = bootstrap.Modal.getInstance(document.getElementById('salesModal'));
  if (modal) modal.hide();
  
  // Reset custom products array
  customProductsInSale = [];
  
  // Show success toast notification
  showSuccessToast(`‚úÖ Sale completed! ${saleItems.length} item(s) recorded.`);
  
  console.log(`‚úÖ UI updated instantly - ${saleItems.length} items displayed`);
  
  // ==========================================
  // üîÑ STEP 2: BACKGROUND SAVE TO FIRESTORE
  // ==========================================
  
  (async () => {
    try {
      const { collection, addDoc, doc, updateDoc, getDoc } = window.firebaseImports;
      const salesRef = collection(window.db, 'tenants', user.uid, 'sales');
      
      // ‚úÖ Save each sale item to Firestore
      console.log('üì§ Saving sales to Firestore...');
      
      const savePromises = saleItems.map(item => {
        return addDoc(salesRef, {
          ...item,
          date: new Date().toISOString(), // ‚úÖ Ensure date field
          createdAt: new Date().toISOString(),
          userId: user.uid
        });
      });
      
      await Promise.all(savePromises);
      
      console.log(`‚úÖ ${saleItems.length} sales saved to Firestore`);
      
      // ‚úÖ Update product stock in Firestore (SAFE VERSION)
      console.log('üì¶ Updating product stock in Firestore...');
      
      for (const item of saleItems) {
        if (!item.isCustomProduct && item.productId) {
          try {
            // ‚úÖ Check if product exists first
            const productRef = doc(window.db, 'tenants', user.uid, 'products', item.productId);
            const productSnap = await getDoc(productRef);
            
            if (productSnap.exists()) {
              const prod = cachedProducts.find(p => p.id === item.productId);
              if (prod) {
                await updateDoc(productRef, {
                  stock: Math.max(0, prod.stock), // Don't go negative
                  updatedAt: new Date().toISOString()
                });
                console.log(`‚úÖ Stock updated for ${item.productId}`);
              }
            } else {
              console.warn(`‚ö†Ô∏è Product ${item.productId} not found, skipping stock update`);
            }
          } catch (stockError) {
            console.warn(`‚ö†Ô∏è Could not update stock for ${item.productId}:`, stockError.message);
            // ‚úÖ Continue with other products
          }
        }
      }
      
      console.log('‚úÖ Product stock updated in Firestore');
      
      // ‚úÖ AUTO-RELOAD RECENT SALES (for homepage)
      setTimeout(() => {
        if (typeof loadRecentSales === 'function') {
          loadRecentSales();
          console.log('‚úÖ Recent sales reloaded');
        }
      }, 500);
      
      console.log('‚úÖ 1 sales saved to Firestore in background');
      
    } catch (error) {
      console.error('‚ùå Background save error:', error.message);
      // ‚úÖ Show subtle warning but don't block user
      showWarningToast('‚ö†Ô∏è Sale saved locally, syncing in background...');
    }
  })(); // ‚úÖ IIFE - runs in background without blocking UI
}


    // ==========================================
// SUCCESS TOAST NOTIFICATION
// ==========================================

function showSuccessToast(message) {
  // Remove existing toast if any
  const existingToast = document.getElementById('successToast');
  if (existingToast) {
    existingToast.remove();
  }
  
  // Create toast element
  const toast = document.createElement('div');
  toast.id = 'successToast';
  toast.className = 'toast-notification';
  toast.innerHTML = `
    <div class="d-flex align-items-center">
      <i class="bi bi-check-circle-fill text-success me-2" style="font-size: 1.5rem;"></i>
      <div>${message}</div>
    </div>
  `;
  
  document.body.appendChild(toast);
  
  // Show toast
  setTimeout(() => {
    toast.classList.add('show');
  }, 100);
  
  // Hide after 3 seconds
  setTimeout(() => {
    toast.classList.remove('show');
    setTimeout(() => {
      toast.remove();
    }, 300);
  }, 3000);
}

  
  


  



/**
 * ==========================================
 * STOCK STATUS SELECTION SYSTEM (FRONTEND)
 * ==========================================
 */

let selectedStockStatus = '';

/**
 * Select stock status (Good/Medium/Low/Urgent)
 */
function selectStockStatus(status) {
  console.log('üìä Selected stock status:', status);
  
  selectedStockStatus = status;
  document.getElementById('selectedStockStatus').value = status;
  
  // Clear exact quantity when status selected
  document.getElementById('productCurrentStock').value = '';
  
  // Update button styling
  document.querySelectorAll('.stock-btn').forEach(btn => {
    btn.style.border = '2px solid transparent';
    btn.style.opacity = '0.7';
  });
  
  // Highlight selected button
  const selectedBtn = document.getElementById(`stockBtn-${status}`);
  if (selectedBtn) {
    selectedBtn.style.border = '2px solid white';
    selectedBtn.style.opacity = '1';
  }
}



    /**
 * Stock Status Selection Handler
 */
function selectStockStatus(status) {
  console.log('üìä Selected stock status:', status);
  
  selectedStockStatus = status;
  document.getElementById('selectedStockStatus').value = status;
  
  // Clear exact quantity when status selected
  document.getElementById('productCurrentStock').value = '';
  
  // Update button styling
  document.querySelectorAll('.stock-btn').forEach(btn => {
    btn.style.border = '2px solid transparent';
    btn.style.opacity = '0.7';
  });
  
  // Highlight selected button
  const selectedBtn = document.getElementById(`stockBtn-${status}`);
  if (selectedBtn) {
    selectedBtn.style.border = '2px solid white';
    selectedBtn.style.opacity = '1';
  }
  
  console.log('‚úÖ Stock status set to:', status);
}

/**
 * Get stock data before saving
 */
/**
 * Get stock status - can be from buttons OR exact quantity
 */
/**
 * Get stock data - MANDATORY: user must choose either exact quantity OR status
 */
function getStockData() {
  const statusSelected = document.getElementById('selectedStockStatus')?.value || '';
  const exactStockInput = document.getElementById('productCurrentStock')?.value || '';
  
  console.log('üîç getStockData called');
  console.log('üìä Status selected:', statusSelected);
  console.log('üìä Exact stock input:', exactStockInput);
  
  // ‚úÖ CHECK 1: If exact number entered, use it
  if (exactStockInput && exactStockInput.trim() !== '') {
    const exactStock = parseInt(exactStockInput);
    
    if (!isNaN(exactStock) && exactStock >= 0) {
      console.log('‚úÖ Using exact stock:', exactStock);
      return {
        stockStatus: 'exact',
        stockValue: exactStock
      };
    } else {
      alert('‚ö†Ô∏è Invalid stock quantity. Please enter a valid number (0 or greater).');
      return null;
    }
  }
  
  // ‚úÖ CHECK 2: If status button selected, use it
  if (statusSelected && ['good', 'medium', 'low', 'urgent'].includes(statusSelected)) {
    console.log('‚úÖ Using status:', statusSelected);
    return {
      stockStatus: statusSelected,
      stockValue: null
    };
  }
  
  // ‚ùå ERROR: User didn't choose anything
  alert('‚ö†Ô∏è Stock information required!\n\nPlease either:\n1Ô∏è‚É£ Enter an exact quantity (e.g., 30)\n2Ô∏è‚É£ OR select a status (Good/Medium/Low/Urgent)');
  return null;
}




/**
 * ==========================================
 * HELPER FUNCTIONS - STOCK DISPLAY
 * ==========================================
 */

/**
 * Parse stock data from product (handles new & old formats)
 */
function parseProductStockData(product) {
  // ‚úÖ NEW: Column J has TEXT status directly
  const stockText = (product.stock || 'MEDIUM').toString().toUpperCase();
  
  if (['GOOD', 'MEDIUM', 'LOW', 'URGENT'].includes(stockText)) {
    return {
      stockStatus: stockText.toLowerCase(),
      stockValue: 0,
      displayStatus: stockText.toLowerCase()
    };
  }
  
  // Fallback
  return { stockStatus: 'medium', stockValue: 0, displayStatus: 'medium' };
}



    
/**
 * Convert stock status to display badge
 */
function getStockBadge(stockStatus, stockValue) {
  if (stockStatus === 'exact' && stockValue) {
    return { 
      icon: 'üì¶', 
      text: `In Stock (${stockValue})`, 
      color: '#17a2b8',
      bgColor: '#d1ecf1'
    };
  }
  
  const badges = {
    'good': { 
      icon: 'üü¢', 
      text: 'Good Stock', 
      color: '#155724', 
      bgColor: '#d4edda' 
    },
    'medium': { 
      icon: 'üü°', 
      text: 'Medium Stock', 
      color: '#856404', 
      bgColor: '#fff3cd' 
    },
    'low': { 
      icon: 'üî¥', 
      text: 'Low Stock', 
      color: '#721c24', 
      bgColor: '#f8d7da' 
    },
    'urgent': { 
      icon: 'üîµ', 
      text: 'Urgent', 
      color: '#664399', 
      bgColor: '#e2d5f0' 
    }
  };
  
  return badges[stockStatus] || { 
    icon: '‚ö™', 
    text: 'Unknown', 
    color: '#6c757d',
    bgColor: '#e2e3e5'
  };
}

/**
 * Reset stock selection when opening modal
 */
function resetStockSelection() {
  selectedStockStatus = '';
  document.getElementById('selectedStockStatus').value = '';
  document.getElementById('productCurrentStock').value = '';
  document.querySelectorAll('.stock-btn').forEach(btn => {
    btn.style.border = '2px solid transparent';
    btn.style.opacity = '0.7';
  });
}








    
  /***********************
   * Backup/Import
   ***********************/
  function exportData(){
    const data = { products: cachedProducts, sales: cachedSales, exportDate: new Date().toISOString() };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type:'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href = url; a.download = `inventory-backup-${new Date().toISOString().split('T')[0]}.json`; a.click();
    alert('√É∆í√Ü‚Äô√É‚Äö√Ç¬¢√É∆í√¢‚Ç¨¬¶√É¬¢√¢‚Äö¬¨√Ö‚Äú√É∆í√Ç¬¢√É¬¢√¢‚Ç¨≈°√Ç¬¨√É‚Äö√Ç¬¶ Backup downloaded');
  }
  function importData(){ document.getElementById('fileInput').click(); }
  function handleFileImport(e){ const file = e.target.files[0]; if(!file) return; const reader = new FileReader(); reader.onload = function(evt){ try{ const data = JSON.parse(evt.target.result); if(data.products) cachedProducts = data.products; if(data.sales) cachedSales = data.sales; hasInitialLoaded=true; renderProducts(); renderSales(); alert('√É∆í√Ü‚Äô√É‚Äö√Ç¬¢√É∆í√¢‚Ç¨¬¶√É¬¢√¢‚Äö¬¨√Ö‚Äú√É∆í√Ç¬¢√É¬¢√¢‚Ç¨≈°√Ç¬¨√É‚Äö√Ç¬¶ Data restored (local)'); }catch(err){ alert('√É∆í√Ç¬¢√É‚Äö√Ç¬ù√É‚Ä¶√¢‚Ç¨‚Ñ¢ Invalid file'); } }; reader.readAsText(file); }

      function searchProducts() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
    
    // If empty, display all products
    if (!searchTerm) {
        displayAllProducts();
        return;
    }
    
    // Filter products
    const filteredProducts = cachedProducts.filter(product => {
        const name = (product.name || '').toLowerCase();
        const category = (product.category || '').toLowerCase();
        const brand = (product.brand || '').toLowerCase();
        const size = (product.size || '').toLowerCase();
        
        return name.includes(searchTerm) ||
               category.includes(searchTerm) ||
               brand.includes(searchTerm) ||
               size.includes(searchTerm);
    });
    
    // Display filtered products
    displayProducts(filteredProducts);
}

/**
 * ==========================================
 * DISPLAY PRODUCTS - DESKTOP & MOBILE
 * ==========================================
 */
function displayProducts(products) {
    const tbody = document.getElementById('productsTableBody');
    
    if (products.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="8" class="text-center py-4 text-muted">
                    <i class="bi bi-search"></i>
                    <p>No products found matching your search</p>
                </td>
            </tr>
        `;
        return;
    }
    
    let html = '';
    products.forEach(product => {
        // ‚úÖ Get stock badge using stockBadgeHtml function
        const stockBadge = stockBadgeHtml(product.stock, product.minStock);
        
        // ‚úÖ PHOTO COLUMN (first column now) - shows actual product photo or placeholder
        const photoHtml = product.imageUrl 
            ? `<img src="${product.imageUrl}" alt="${escapeHtml(product.name)}" 
                    style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.1);" 
                    onclick="viewProductImage('${product.imageUrl}')">`
            : `<div style="width: 60px; height: 60px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                <i class="bi bi-image" style="font-size: 1.8rem; color: white;"></i>
               </div>`;
        
        html += `
            <tr>
                <td>${photoHtml}</td>
                <td><strong>${escapeHtml(product.name)}</strong></td>
                <td>${escapeHtml(product.category)}</td>
                <td>${escapeHtml(product.brand) || '-'}</td>
                <td><strong>${escapeHtml(product.size) || 'N/A'}</strong></td>
                <td>${stockBadge}</td>
                <td><strong>‚Çπ${product.price.toFixed(2)}</strong>/${product.unitType}</td>
                <td>
                    <button class="btn btn-sm btn-primary btn-action-sm me-1" onclick="editProduct('${product.id}')">
                        <i class="bi bi-pencil"></i> Edit
                    </button>
                    <button class="btn btn-sm btn-danger btn-action-sm" onclick="deleteProduct('${product.id}')">
                        <i class="bi bi-trash"></i> Delete
                    </button>
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
    
    // ‚úÖ MOBILE LIST (with product photos)
    const container = document.getElementById('mobileProductsList');
    if (products.length === 0) {
        container.innerHTML = '<div class="mobile-item text-center text-muted">No products found</div>';
        return;
    }
    
    let mobileHtml = '';
    products.forEach(p => {
        const stockBadge = stockBadgeHtml(p.stock, p.minStock);
        
        // ‚úÖ MOBILE PHOTO - larger for mobile
        const mobilePhoto = p.imageUrl 
            ? `<img src="${p.imageUrl}" alt="${escapeHtml(p.name)}" 
                    style="width: 70px; height: 70px; object-fit: cover; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);" 
                    onclick="viewProductImage('${p.imageUrl}')">`
            : `<div style="width: 70px; height: 70px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 12px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
                <i class="bi bi-image" style="font-size: 2.2rem; color: white;"></i>
               </div>`;
        
        mobileHtml += `
            <div class="mobile-item d-flex align-items-start justify-content-between" style="gap: 1rem;">
                <div style="display:flex;gap:1rem;align-items:flex-start;flex:1;">
                    <div style="flex-shrink:0;">
                        ${mobilePhoto}
                    </div>
                    <div style="flex:1;">
                        <div style="font-weight:600;font-size:1rem;margin-bottom:4px;">${escapeHtml(p.name)}</div>
                        <div class="small-muted">${escapeHtml(p.category)} ‚Ä¢ ${escapeHtml(p.brand) || 'No Brand'}</div>
                        <div class="small-muted"><strong>${escapeHtml(p.size) || 'N/A'}</strong></div>
                        <div style="margin-top:8px;"><strong>‚Çπ${parseFloat(p.price || 0).toFixed(2)}</strong>/${p.unitType}</div>
                        <div style="margin-top:8px;">${stockBadge}</div>
                    </div>
                </div>
                <div style="text-align:right;flex-shrink:0;">
                    <div style="display:flex;flex-direction:column;gap:8px;">
                        <button class="btn btn-sm btn-primary btn-action-sm" onclick="editProduct('${p.id}')" style="white-space:nowrap;">
                            <i class="bi bi-pencil"></i> Edit
                        </button>
                        <button class="btn btn-sm btn-danger btn-action-sm" onclick="deleteProduct('${p.id}')" style="white-space:nowrap;">
                            <i class="bi bi-trash"></i> Delete
                        </button>
                    </div>
                </div>
            </div>
        `;
    });
    container.innerHTML = mobileHtml;
}

function displayAllProducts() {
    displayProducts(cachedProducts);
}


    // Open Clear Sales popup
function openClearSalesPopup() {
    // Set default dates (last 30 days to today)
    const today = new Date();
    const thirtyDaysAgo = new Date();
    thirtyDaysAgo.setDate(today.getDate() - 30);
    
    document.getElementById('clearFromDate').value = formatDateForInput(thirtyDaysAgo);
    document.getElementById('clearToDate').value = formatDateForInput(today);
    
    // Reset count display
    document.getElementById('clearSalesCount').style.display = 'none';
    
    // Add event listeners to count on date change
    document.getElementById('clearFromDate').addEventListener('change', updateClearSalesCount);
    document.getElementById('clearToDate').addEventListener('change', updateClearSalesCount);
    
    // Open modal
    const modal = new bootstrap.Modal(document.getElementById('clearSalesModal'));
    modal.show();
    
    // Initial count
    updateClearSalesCount();
}

// Format date for input field (YYYY-MM-DD)
function formatDateForInput(date) {
    const year = date.getFullYear();
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// Update count of sales in selected date range
function updateClearSalesCount() {
    const fromDate = new Date(document.getElementById('clearFromDate').value);
    const toDate = new Date(document.getElementById('clearToDate').value);
    
    if (!fromDate || !toDate) return;
    
    if (fromDate > toDate) {
        alert('√É∆í√Ç¬¢√É‚Äö√Ç¬ù√É‚Ä¶√¢‚Ç¨‚Ñ¢ "From Date" cannot be after "To Date"');
        return;
    }
    
    // Count sales in range
    const salesInRange = cachedSales.filter(sale => {
        const saleDate = new Date(sale.date);
        return saleDate >= fromDate && saleDate <= toDate;
    });
    
    // Display count
    const countDiv = document.getElementById('clearSalesCount');
    const countNumber = document.getElementById('salesCountNumber');
    
    countNumber.textContent = salesInRange.length;
    countDiv.style.display = salesInRange.length > 0 ? 'block' : 'none';
}

// Clear sales in date range
function clearSalesInDateRange() {
    const fromDate = new Date(document.getElementById('clearFromDate').value);
    const toDate = new Date(document.getElementById('clearToDate').value);
    
    if (!fromDate || !toDate) {
        alert('√É∆í√Ç¬¢√É‚Äö√Ç¬ù√É‚Ä¶√¢‚Ç¨‚Ñ¢ Please select both From and To dates');
        return;
    }
    
    // Set time to start/end of day for accurate comparison
    fromDate.setHours(0, 0, 0, 0);
    toDate.setHours(23, 59, 59, 999);
    
    if (fromDate > toDate) {
        alert('√É∆í√Ç¬¢√É‚Äö√Ç¬ù√É‚Ä¶√¢‚Ç¨‚Ñ¢ "From Date" cannot be after "To Date"');
        return;
    }
    
    // Find sales in date range
    const salesInRange = cachedSales.filter(sale => {
        const saleDate = new Date(sale.date);
        return saleDate >= fromDate && saleDate <= toDate;
    });
    
    if (salesInRange.length === 0) {
        alert('√É∆í√Ü‚Äô√É‚Äö√Ç¬¢√É∆í√Ç¬¢√É¬¢√¢‚Ç¨≈°√Ç¬¨√É‚Ä¶√Ç¬æ√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬π√É∆í√Ü‚Äô√É‚Äö√Ç¬Ø√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬∏√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬è No sales found in the selected date range');
        return;
    }
    
    // Confirm deletion
    const fromStr = fromDate.toLocaleDateString('en-IN');
    const toStr = toDate.toLocaleDateString('en-IN');
    const confirmMsg = `Are you sure you want to hide ${salesInRange.length} sales records between ${fromStr} and ${toStr}?\n\n√É∆í√Ü‚Äô√É‚Äö√Ç¬¢√É∆í√¢‚Ç¨¬¶√É‚Äö√Ç¬° √É∆í√Ü‚Äô√É‚Äö√Ç¬Ø√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬∏√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬è This will hide them from display only.\nGoogle Sheets data remains unchanged.\n\nYou can restore them later by clearing browser data.`;
    
    if (!confirm(confirmMsg)) return;
    
    // √É∆í√Ü‚Äô√É‚Äö√Ç¬¢√É∆í√¢‚Ç¨¬¶√É¬¢√¢‚Äö¬¨√Ö‚Äú√É∆í√Ç¬¢√É¬¢√¢‚Ç¨≈°√Ç¬¨√É‚Äö√Ç¬¶ FIX: Store deleted IDs persistently
    salesInRange.forEach(sale => {
        if (sale.id && !deletedSaleIds.includes(sale.id)) {
            deletedSaleIds.push(sale.id);
        }
    });
    
    // Save to localStorage for persistence across sessions and page reloads
    try {
        localStorage.setItem('deletedSaleIds', JSON.stringify(deletedSaleIds));
        console.log('√É∆í√Ü‚Äô√É‚Äö√Ç¬∞√É∆í√¢‚Ç¨¬¶√É‚Äö√Ç¬∏√É∆í√Ç¬¢√É¬¢√¢‚Ç¨≈°√Ç¬¨√É¬¢√¢‚Ç¨≈æ√Ç¬¢√É∆í√¢‚Ç¨≈°√É‚Äö√Ç¬æ Saved', deletedSaleIds.length, 'deleted sale IDs to localStorage');
    } catch (e) {
        console.warn('Could not save deletedSaleIds to localStorage', e);
    }
    
    // Filter out sales in the date range
    cachedSales = cachedSales.filter(sale => {
        const saleDate = new Date(sale.date);
        return saleDate < fromDate || saleDate > toDate;
    });
    
    // Update display
    displaySalesFromCache();
    updateSummaryFromCache();
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('clearSalesModal'));
    modal.hide();
    
    // Show success message
    alert(`√É∆í√Ü‚Äô√É‚Äö√Ç¬¢√É∆í√¢‚Ç¨¬¶√É¬¢√¢‚Äö¬¨√Ö‚Äú√É∆í√Ç¬¢√É¬¢√¢‚Ç¨≈°√Ç¬¨√É‚Äö√Ç¬¶ Successfully cleared ${salesInRange.length} sales records!\n\nNote: They're hidden from display only. Google Sheets data is unchanged.\n\nTo restore: Clear browser data or use developer console to run:\nlocalStorage.removeItem('deletedSaleIds')`);
}


   function displaySalesFromCache() {
  const salesList = document.getElementById('salesList');
  
  if (cachedSales.length === 0) {
    salesList.innerHTML = `
      <tr>
        <td colspan="5" class="text-center text-muted py-4">
          No sales recorded yet
        </td>
      </tr>
    `;
    return;
  }
  
  salesList.innerHTML = '';
  
  // √É∆í√Ç¬¢√É‚Ä¶√¢‚Ç¨≈ì√É¬¢√¢‚Äö¬¨√Ç¬¶ FIX: Show only last 100 sales (most recent)
  const recentSales = cachedSales.slice(0, 100);
  
  recentSales.forEach(sale => {
    const date = new Date(sale.date);
    const formattedDate = date.toLocaleDateString('en-IN') + ' ' + 
                         date.toLocaleTimeString('en-IN', {hour: '2-digit', minute: '2-digit'});
    
    const row = `
      <tr>
        <td>${formattedDate}</td>
        <td>${sale.productName}</td>
        <td>${sale.quantity}</td>
        <td>${sale.unitType}</td>
        <td class="text-success fw-bold">‚Çπ${parseFloat(sale.totalAmount).toFixed(2)}</td>
      </tr>
    `;
    
    salesList.innerHTML += row;
  });
  
  // √É∆í√Ç¬¢√É‚Ä¶√¢‚Ç¨≈ì√É¬¢√¢‚Äö¬¨√Ç¬¶ FIX: Show count if more than 100 sales exist
  if (cachedSales.length > 100) {
    salesList.innerHTML += `
      <tr>
        <td colspan="5" class="text-center text-muted">
          <small>Showing 100 most recent sales. Total: ${cachedSales.length} sales</small>
        </td>
      </tr>
    `;
  }
}

/**
 * ==========================================
 * √¢≈ì‚Ä¶ PHOTO PRODUCT FUNCTIONALITY
 * ==========================================
 */

// Photo selection variables
let selectedPhotoFile = null;
let selectedPhotoBase64 = null;

// Open photo product modal
function openPhotoProductModal() {
  // Reset form
  document.getElementById('photoProductName').value = '';
  document.getElementById('photoProductBrand').value = '';
  document.getElementById('photoProductSize').value = '';
  document.getElementById('photoProductStock').value = '';
  document.getElementById('photoProductPrice').value = '';
  document.getElementById('photoPreviewContainer').style.display = 'none';
  document.getElementById('photoLoadingSpinner').style.display = 'none';
  selectedPhotoFile = null;
  selectedPhotoBase64 = null;
  
  // Show modal
  const modal = new bootstrap.Modal(document.getElementById('photoProductModal'));
  modal.show();
}

// Handle photo selection
function handlePhotoSelect(event) {
  const file = event.target.files[0];
  if (!file || !file.type.startsWith('image/')) {
    alert('Please select a valid image file');
    return;
  }
  
  selectedPhotoFile = file;
  
  const reader = new FileReader();
  reader.onload = (e) => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      
      const maxWidth = 1920;
      const maxHeight = 1080;
      let width = img.width;
      let height = img.height;
      
      if (width > height) {
        if (width > maxWidth) {
          height = (maxWidth / width) * height;
          width = maxWidth;
        }
      } else {
        if (height > maxHeight) {
          width = (maxHeight / height) * width;
          height = maxHeight;
        }
      }
      
      canvas.width = width;
      canvas.height = height;
      ctx.drawImage(img, 0, 0, width, height);
      
      selectedPhotoBase64 = canvas.toDataURL('image/jpeg', 0.7);
      
      document.getElementById('photoPreviewImage').src = selectedPhotoBase64;
      document.getElementById('photoPreviewContainer').style.display = 'block';
      
      console.log('Photo selected and compressed:', file.name);
    };
    img.src = e.target.result;
  };
  reader.readAsDataURL(file);
}

// Clear photo selection
function clearPhotoSelection() {
  selectedPhotoFile = null;
  selectedPhotoBase64 = null;
  document.getElementById('photoFileInput').value = '';
  document.getElementById('photoCameraInput').value = '';
  document.getElementById('photoPreviewContainer').style.display = 'none';
}

// Save photo product
async function savePhotoProduct() {
  const productName = document.getElementById('photoProductName').value.trim();
  if (!productName) {
    alert('Product name is required!');
    return;
  }
  
  if (!selectedPhotoBase64) {
    alert('Please take or select a photo!');
    return;
  }
  
  const productData = {
    id: generateId(),
    name: productName,
    category: 'Photo Products',
    brand: document.getElementById('photoProductBrand').value.trim() || '',
    size: document.getElementById('photoProductSize').value.trim() || '',
    unitType: 'Piece',
    piecesPerBox: '',
    sftPerBox: '',
    price: parseFloat(document.getElementById('photoProductPrice').value) || 0,
    stock: parseFloat(document.getElementById('photoProductStock').value) || 0,
    minStock: 0,
    imageUrl: 'uploading...'
  };
  
  cachedProducts.push(productData);
  renderProducts();
  
  const modalEl = document.getElementById('photoProductModal');
  const modal = bootstrap.Modal.getInstance(modalEl);
  modal.hide();
  
  showSuccessToast('Photo product added! Uploading image...');
  
  uploadPhotoToBackend(productData, selectedPhotoBase64);
}

/**
 * Upload photo to Firebase (temp solution - stores base64)
 * TODO: Upgrade to Firebase Storage for production
 */
async function uploadPhotoToBackend(productData, photoBase64) {
  try {
    console.log('Saving photo product to Firebase...');
    
    const user = window.auth.currentUser;
    if (!user) {
      throw new Error('User not authenticated');
    }
    
    // For now, store base64 directly in product
    productData.imageUrl = photoBase64;
    
    const productIndex = cachedProducts.findIndex(p => p.id === productData.id);
    if (productIndex !== -1) {
      cachedProducts[productIndex].imageUrl = photoBase64;
    }
    
    // Save to Firestore
    await saveProductToSheet(productData);
    
    renderProducts();
    showSuccessToast('‚úÖ Photo product saved!');
    
    console.log('‚úÖ Photo product saved to Firestore');
    
    // TODO: For production, use Firebase Storage:
    // const storage = getStorage();
    // const storageRef = ref(storage, `products/${user.uid}/${productData.id}.jpg`);
    // const uploadTask = await uploadString(storageRef, photoBase64, 'data_url');
    // const photoUrl = await getDownloadURL(uploadTask.ref);
    // return photoUrl;
    
  } catch (error) {
    console.error('Photo upload error:', error);
    alert('Failed to save photo product. Please try again.');
    
    productData.imageUrl = '';
    const productIndex = cachedProducts.findIndex(p => p.id === productData.id);
    if (productIndex !== -1) {
      cachedProducts[productIndex].imageUrl = '';
    }
    
    renderProducts();
  }
}


/**
 * ==========================================
 * VIEW SWITCHING FUNCTIONS - WITH GROUPS
 * ==========================================
 */

/**
 * Show All Products (Table View)
 */
function showAllProducts() {
  console.log('üìã Switching to All Products view');
  
  // ‚úÖ Update button states
  const btnAll = document.getElementById('btnAllView');
  const btnPhoto = document.getElementById('btnPhotoView');
  const btnGroups = document.getElementById('btnGroupsView');
  
  if (btnAll) btnAll.classList.add('active');
  if (btnPhoto) btnPhoto.classList.remove('active');
  if (btnGroups) btnGroups.classList.remove('active');
  
  // ‚úÖ Hide photo grid
  const photoGrid = document.getElementById('photoProductGrid');
  if (photoGrid) {
    photoGrid.style.display = 'none';
    photoGrid.style.visibility = 'hidden';
    console.log('‚úÖ Photo grid hidden');
  }
  
  // ‚úÖ Hide groups view
  const groupsView = document.getElementById('groupsViewContainer');
  if (groupsView) {
    groupsView.style.display = 'none';
    groupsView.style.visibility = 'hidden';
    console.log('‚úÖ Groups view hidden');
  }
  
  // ‚úÖ Show table explorer
  let tableExplorer = document.querySelector('.table-explorer');
  if (!tableExplorer) {
    tableExplorer = document.querySelector('[class*="table"]');
  }
  
  if (tableExplorer) {
    tableExplorer.style.display = 'block';
    tableExplorer.style.visibility = 'visible';
    console.log('‚úÖ Table explorer shown');
  } else {
    console.warn('‚ö†Ô∏è Table explorer element not found!');
  }
  
  // ‚úÖ Show mobile list
  const mobileList = document.getElementById('mobileProductsList');
  if (mobileList) {
    mobileList.style.display = 'block';
    console.log('‚úÖ Mobile list shown');
  }
  
  // ‚úÖ Render products
  if (typeof renderProducts === 'function') {
    renderProducts();
  }
  
  console.log('‚úÖ All Products view activated');
}


/**
 * Show Photo Products (Grid View)
 */
function showPhotoProducts() {
  console.log('üì∑ Switching to Photo Products view');
  
  // ‚úÖ Update button states
  const btnAll = document.getElementById('btnAllView');
  const btnPhoto = document.getElementById('btnPhotoView');
  const btnGroups = document.getElementById('btnGroupsView');
  
  if (btnAll) btnAll.classList.remove('active');
  if (btnPhoto) btnPhoto.classList.add('active');
  if (btnGroups) btnGroups.classList.remove('active');
  
  // ‚úÖ Hide table explorer
  let tableExplorer = document.querySelector('.table-explorer');
  if (!tableExplorer) {
    tableExplorer = document.querySelector('[class*="table"]');
  }
  
  if (tableExplorer) {
    tableExplorer.style.display = 'none';
    tableExplorer.style.visibility = 'hidden';
    console.log('‚úÖ Table explorer hidden');
  }
  
  // ‚úÖ Hide mobile list
  const mobileList = document.getElementById('mobileProductsList');
  if (mobileList) {
    mobileList.style.display = 'none';
    console.log('‚úÖ Mobile list hidden');
  }
  
  // ‚úÖ Hide groups view
  const groupsView = document.getElementById('groupsViewContainer');
  if (groupsView) {
    groupsView.style.display = 'none';
    groupsView.style.visibility = 'hidden';
    console.log('‚úÖ Groups view hidden');
  }
  
  // ‚úÖ Show photo grid
  const photoGrid = document.getElementById('photoProductGrid');
  if (photoGrid) {
    photoGrid.style.display = 'grid';
    photoGrid.style.visibility = 'visible';
    console.log('‚úÖ Photo grid shown');
  } else {
    console.error('‚ùå Photo grid element not found!');
  }
  
  // ‚úÖ Render photo products
  if (typeof renderPhotoProductsGrid === 'function') {
    renderPhotoProductsGrid();
  }
  
  console.log('‚úÖ Photo Products view activated');
}


/**
 * Show Groups View
 */
function showGroupsView() {
  console.log('üìÅ Switching to Groups view');
  
  // ‚úÖ Update button states
  const btnAll = document.getElementById('btnAllView');
  const btnPhoto = document.getElementById('btnPhotoView');
  const btnGroups = document.getElementById('btnGroupsView');
  
  if (btnAll) btnAll.classList.remove('active');
  if (btnPhoto) btnPhoto.classList.remove('active');
  if (btnGroups) btnGroups.classList.add('active');
  
  // ‚úÖ Hide table explorer
  let tableExplorer = document.querySelector('.table-explorer');
  if (!tableExplorer) {
    tableExplorer = document.querySelector('[class*="table"]');
  }
  
  if (tableExplorer) {
    tableExplorer.style.display = 'none';
    tableExplorer.style.visibility = 'hidden';
    console.log('‚úÖ Table explorer hidden');
  }
  
  // ‚úÖ Hide mobile list
  const mobileList = document.getElementById('mobileProductsList');
  if (mobileList) {
    mobileList.style.display = 'none';
    console.log('‚úÖ Mobile list hidden');
  }
  
  // ‚úÖ Hide photo grid
  const photoGrid = document.getElementById('photoProductGrid');
  if (photoGrid) {
    photoGrid.style.display = 'none';
    photoGrid.style.visibility = 'hidden';
    console.log('‚úÖ Photo grid hidden');
  }
  
  // ‚úÖ Show groups view
  const groupsView = document.getElementById('groupsViewContainer');
  if (groupsView) {
    groupsView.style.display = 'block';
    groupsView.style.visibility = 'visible';
    console.log('‚úÖ Groups view shown');
  } else {
    console.error('‚ùå Groups view container not found!');
  }
  
  // ‚úÖ Load groups (uses existing function)
  if (typeof loadProductGroups === 'function') {
    loadProductGroups();
  } else {
    console.error('‚ùå loadProductGroups function not found!');
  }
  
  console.log('‚úÖ Groups view activated');
}


/**
 * Make functions globally accessible
 */
window.showAllProducts = showAllProducts;
window.showPhotoProducts = showPhotoProducts;
window.showGroupsView = showGroupsView;

console.log('‚úÖ View switching functions loaded');

function renderPhotoProductsGrid() {
  const photoGrid = document.getElementById('photoProductGrid');
  if (!photoGrid) {
    console.error('‚ùå Photo grid not found');
    return;
  }
  
  photoGrid.innerHTML = ''; // Clear first
  
  const photoProducts = cachedProducts.filter(p => {
    const hasImage = p.imageUrl && p.imageUrl !== '' && p.imageUrl !== 'uploading...';
    return hasImage;
  });
  
  console.log(`üì∏ Found ${photoProducts.length} photo products`);
  
  if (photoProducts.length === 0) {
    photoGrid.innerHTML = `
      <div style="grid-column: 1 / -1;">
        <div class="alert alert-info text-center">
          <i class="bi bi-images" style="font-size: 3rem;"></i><br>
          <strong>No photo products yet.</strong><br>
          Click <strong>"Product by Photo"</strong> to add one!
        </div>
      </div>
    `;
    return;
  }
  
  photoProducts.forEach(product => {
    const stockBadge = product.stock > 0 ? 
      `<span class="badge bg-success">Stock: ${product.stock}</span>` : 
      `<span class="badge bg-danger">Out of Stock</span>`;
    
    const priceDisplay = product.price > 0 ? `‚Çπ${product.price.toFixed(2)}` : 'Price not set';
    
    const cardDiv = document.createElement('div');
    cardDiv.className = 'card h-100 shadow-sm';
    cardDiv.style.display = 'flex';
    cardDiv.style.flexDirection = 'column';
    
    cardDiv.innerHTML = `
      <img src="${product.imageUrl}" 
           class="card-img-top" 
           alt="${escapeHtml(product.name)}" 
           style="height:150px; object-fit:cover; cursor:pointer; flex-shrink: 0;" 
           onclick="viewPhotoProduct('${product.id}')"
           onerror="this.onerror=null; this.src='https://via.placeholder.com/200?text=Image';">
      <div class="card-body p-2" style="flex: 1;">
        <h6 class="card-title" style="font-size:0.9rem; margin-bottom: 5px;">${escapeHtml(product.name)}</h6>
        <p class="card-text small mb-2" style="font-size:0.75rem;">
          ${product.brand ? `<strong>Brand:</strong> ${escapeHtml(product.brand)}<br>` : ''}
          ${product.size ? `<strong>Size:</strong> ${escapeHtml(product.size)}<br>` : ''}
          ${stockBadge}<br>
          <strong>Price:</strong> ${priceDisplay}
        </p>
      </div>
      <div class="card-footer bg-white border-0 d-flex gap-2 p-2">
        <button class="btn btn-sm btn-primary flex-fill" onclick="editProduct('${product.id}')">
          <i class="bi bi-pencil"></i> Edit
        </button>
        <button class="btn btn-sm btn-danger flex-fill" onclick="deleteProduct('${product.id}')">
          <i class="bi bi-trash"></i> Delete
        </button>
      </div>
    `;
    
    photoGrid.appendChild(cardDiv);
  });
  
  console.log('‚úÖ Photo grid rendered');
}


    

// View photo product enlarged
function viewPhotoProduct(productId) {
  const product = cachedProducts.find(p => p.id === productId);
  if (!product) {
    alert('Product not found');
    return;
  }
  
  document.getElementById('viewPhotoModalTitle').textContent = product.name;
  document.getElementById('viewPhotoModalBody').innerHTML = `
    <div class="text-center">
      <img src="${product.imageUrl}" 
           class="img-fluid mb-3" 
           alt="${product.name}"
           style="max-height: 500px; border-radius: 10px;"
           onerror="this.src='https://via.placeholder.com/500?text=Image+Not+Found'">
      <table class="table table-bordered mt-3">
        <tr><th>Product Name</th><td>${product.name}</td></tr>
        <tr><th>Category</th><td>${product.category || 'N/A'}</td></tr>
        <tr><th>Brand</th><td>${product.brand || 'N/A'}</td></tr>
        <tr><th>Size</th><td>${product.size || 'N/A'}</td></tr>
        <tr><th>Stock</th><td>${product.stock || 0} ${product.unitType || 'Pieces'}</td></tr>
        <tr><th>Price</th><td>‚Çπ${formatCurrency(product.price || 0)}</td></tr>
        <tr><th>Minimum Stock Alert</th><td>${product.minStock || 0}</td></tr>
      </table>
    </div>
  `;
  
  const modal = new bootstrap.Modal(document.getElementById('viewPhotoModal'));
  modal.show();
}



/**
 * ==========================================
 * INITIALIZATION ON PAGE LOAD - FIREBASE VERSION
 * ==========================================
 */

document.addEventListener('DOMContentLoaded', async function() {
  console.log('üöÄ Initializing Inventory App with Firebase...');
  
  // Set initial page
  currentPage = 'home';
  
  // Hide all pages initially
  const allProductsPage = document.getElementById('allProductsPage');
  const productGroupsPage = document.getElementById('productGroupsPage');
  const groupDetailPage = document.getElementById('groupDetailPage');
  
  if (allProductsPage) allProductsPage.classList.remove('active');
  if (productGroupsPage) productGroupsPage.classList.remove('active');
  if (groupDetailPage) groupDetailPage.classList.remove('active');
  
  // Show main dashboard
  const mainApp = document.getElementById('mainApp');
  if (mainApp) {
    mainApp.style.display = 'block';
    console.log('‚úÖ Main dashboard visible');
  }
  
  // Reset product modal on close
  const productModal = document.getElementById('productModal');
  if (productModal) {
    productModal.addEventListener('hidden.bs.modal', function() {
      const saveBrandBtn = document.getElementById('saveBrandInsideBtn');
      if (saveBrandBtn) {
        saveBrandBtn.style.display = 'none';
        saveBrandBtn.innerHTML = 'üíæ';
        saveBrandBtn.style.background = '#28a745';
        saveBrandBtn.disabled = false;
      }
      
      const brandField = document.getElementById('brand');
      if (brandField) brandField.value = '';
      
      if (typeof clearProductPhotoSelection === 'function') {
        clearProductPhotoSelection();
      }
      
      const dropdown = document.getElementById('brandSuggestionsDropdown');
      if (dropdown) dropdown.style.display = 'none';
      
      console.log('üîÑ Product modal reset');
    });
  }
  
  // Load brand cache (if function exists)
  if (typeof loadBrandAutocompleteCache === 'function') {
    loadBrandAutocompleteCache();
  }
  
  // ‚úÖ FIREBASE INITIALIZATION: Firebase Auth will handle sync
  // The auth state listener in handleEmailPasswordAuth will trigger syncFromFirestore()
  console.log('üì± Waiting for Firebase authentication...');
  
  // Load from localStorage cache first (instant display)
  try {
    cachedProducts = JSON.parse(localStorage.getItem('inventory_products_cache') || '[]');
    cachedSales = JSON.parse(localStorage.getItem('inventory_sales_cache') || '[]');
    renderProducts();
    renderSales();
    console.log('‚úÖ Displayed cached data');
  } catch (e) {
    console.warn('Cache load failed:', e);
  }
  
  // Load purchases (if function exists)
  if (typeof loadRecentPurchases === 'function') {
    console.log('üì¶ Loading purchases...');
    await loadRecentPurchases();
  }
  
  // Load customer invoices (if function exists)
  if (typeof loadCustomerInvoices === 'function') {
    console.log('üìÑ Loading customer invoices...');
    await loadCustomerInvoices();
  }
  
  console.log('‚úÖ App initialization complete');
});


/**
 * ==========================================
 * BULK ADD PRODUCTS FOR RECORD SALE
 * ==========================================
 */

// Global variable to store selected products for sale
let selectedBulkProductsSale = {};

/**
 * Open Bulk Add Modal for Sale
 */
/**
 * Open Bulk Add Modal for Sale (WITH SAFETY CHECKS)
 */
function openBulkAddModalForSale() {
  console.log('üì¶ Opening Bulk Add Modal for Sale');
  
  // ‚úÖ SAFE: Reset search input (check if exists first)
  const searchInput = document.getElementById('bulkSearchInputSale');
  if (searchInput) {
    searchInput.value = '';
  } else {
    console.warn('‚ö†Ô∏è bulkSearchInputSale element not found');
  }
  
  // ‚úÖ ALWAYS RESET COMPLETELY
  selectedBulkProductsSale = {};
  
  // ‚úÖ Clear selected items panel
  const selectedContainer = document.getElementById('bulkSelectedItemsSale');
  if (selectedContainer) {
    selectedContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">No items selected</div>';
  }
  
  // ‚úÖ Reset counters
  updateBulkCountersSale();
  
  // Render all products
  renderBulkProductsListSale('');
  
  // Show modal
  const modalElement = document.getElementById('bulkAddModalForSale');
  if (modalElement) {
    const modal = new bootstrap.Modal(modalElement);
    modal.show();
    console.log('‚úÖ Modal opened with clean state');
  } else {
    console.error('‚ùå bulkAddModalForSale element not found!');
    alert('Error: Bulk Add Modal not found. Please check your HTML.');
  }
}


/**
 * Filter products by search query (SAFE)
 */
function filterBulkProductsSale(query) {
  console.log('üîç Filtering bulk products for sale:', query);
  renderBulkProductsListSale(query);
}

/**
 * Render products list on left side (WITH SAFETY CHECKS)
 */
function renderBulkProductsListSale(searchQuery) {
  const container = document.getElementById('bulkProductsListSale');
  if (!container) {
    console.error('‚ùå bulkProductsListSale container not found');
    return;
  }
  
  const products = cachedProducts || [];
  let filtered = products;
  
  // Filter by search query
  if (searchQuery && searchQuery.trim().length > 0) {
    const query = searchQuery.toLowerCase();
    filtered = products.filter(product => {
      const name = (product.name || '').toLowerCase();
      const brand = (product.brand || '').toLowerCase();
      const category = (product.category || '').toLowerCase();
      
      return name.includes(query) || brand.includes(query) || category.includes(query);
    });
  }
  
  if (filtered.length === 0) {
    container.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">No products found</div>';
    return;
  }
  
  let html = '';
  filtered.forEach(product => {
    const isSelected = selectedBulkProductsSale[product.id];
    const displayName = product.size ? `${product.name} (${product.size})` : product.name;
    const rateText = product.price ? `‚Çπ${product.price.toFixed(2)}` : 'N/A';
    const stockText = product.stock ? `Stock: ${product.stock}` : '';
    
    html += `
      <div onclick="toggleBulkProductSelectionSale('${product.id}', '${escapeHtml(product.name)}', '${escapeHtml(product.size || '')}', ${product.price || 0})"
           style="
             padding: 12px;
             border-bottom: 1px solid #f0f0f0;
             cursor: pointer;
             transition: background-color 0.2s;
             display: flex;
             justify-content: space-between;
             align-items: center;
             ${isSelected ? 'background-color: #e3f2fd;' : 'background-color: white;'}
           "
           onmouseover="this.style.backgroundColor='#f5f5f5'"
           onmouseout="this.style.backgroundColor='${isSelected ? '#e3f2fd' : 'white'}'"
      >
        <div style="flex: 1;">
          <strong>${escapeHtml(displayName)}</strong>
          <div style="font-size: 0.85rem; color: #666;">
            ${rateText} ${stockText ? '‚Ä¢ ' + stockText : ''}
          </div>
        </div>
        <div style="
          width: 24px;
          height: 24px;
          display: flex;
          align-items: center;
          justify-content: center;
          margin-left: 10px;
        ">
          ${isSelected ? '‚úì' : ''}
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
  console.log('‚úÖ Rendered', filtered.length, 'products for sale');
}

/**
 * Update counters (WITH SAFETY CHECKS)
 */
function updateBulkCountersSale() {
  const selectedArray = Object.values(selectedBulkProductsSale);
  const selectedCount = selectedArray.length;
  const totalQty = selectedArray.reduce((sum, p) => sum + p.qty, 0);
  
  const countElement = document.getElementById('bulkSelectedCountSale');
  const qtyElement = document.getElementById('bulkTotalQtySale');
  
  if (countElement) {
    countElement.textContent = selectedCount;
  }
  if (qtyElement) {
    qtyElement.textContent = totalQty;
  }
  
  console.log('üìä Counters: Selected=' + selectedCount + ', TotalQty=' + totalQty);
}

/**
 * Toggle product selection for sale
 */
function toggleBulkProductSelectionSale(productId, productName, productSize, productPrice) {
  console.log('‚úì Toggle product for sale:', productName);
  
  if (selectedBulkProductsSale[productId]) {
    // Remove if already selected
    delete selectedBulkProductsSale[productId];
    console.log('‚ùå Removed:', productName);
  } else {
    // Add if not selected
    selectedBulkProductsSale[productId] = {
      id: productId,
      name: productName,
      size: productSize,
      price: productPrice,
      qty: 1
    };
    console.log('‚úÖ Added:', productName);
  }
  
  // Refresh both panels
  renderBulkProductsListSale(document.getElementById('bulkSearchInputSale').value);
  renderBulkSelectedItemsSale();
}

/**
 * Render selected items with horizontal buttons
 */
function renderBulkSelectedItemsSale() {
  const container = document.getElementById('bulkSelectedItemsSale');
  if (!container) return;
  
  const selectedArray = Object.values(selectedBulkProductsSale);
  
  if (selectedArray.length === 0) {
    container.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">No items selected</div>';
    updateBulkCountersSale();
    return;
  }
  
  let html = '';
  selectedArray.forEach((product, idx) => {
    const displayName = product.size ? `${product.name} (${product.size})` : product.name;
    
    html += `
      <div style="
        padding: 12px;
        border-bottom: 1px solid #ddd;
      ">
        <!-- Product Info (always on top) -->
        <div style="margin-bottom: 8px;">
          <strong style="display: block; font-size: 14px; margin-bottom: 4px;">
            ${escapeHtml(displayName)}
          </strong>
          <div style="font-size: 0.85rem; color: #666;">
            ‚Çπ${product.price.toFixed(2)}
          </div>
        </div>
        
        <!-- Quantity Controls (ALWAYS HORIZONTAL) -->
        <div style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          gap: 8px;
          flex-wrap: nowrap;
        ">
          <!-- LEFT: Minus, Qty, Plus (HORIZONTAL) -->
          <div style="
            display: flex;
            align-items: center;
            gap: 4px;
            flex-wrap: nowrap;
            min-width: 0;
          ">
            <!-- Minus Button -->
            <button type="button" class="bulk-qty-btn" 
                    onclick="updateBulkQtySale('${product.id}', -1)"
                    style="
                      padding: 6px 10px;
                      font-size: 16px;
                      background: #dc3545;
                      color: white;
                      border: none;
                      border-radius: 4px;
                      cursor: pointer;
                      min-width: 40px;
                      min-height: 40px;
                      font-weight: bold;
                      transition: background 0.2s;
                      flex-shrink: 0;
                    "
                    onmouseover="this.style.background='#c82333'"
                    onmouseout="this.style.background='#dc3545'">
              ‚àí
            </button>
            
            <!-- Quantity Input -->
            <input type="number" value="${product.qty}" 
                   class="bulk-qty-input"
                   style="
                     width: 50px;
                     padding: 6px;
                     text-align: center;
                     font-size: 14px;
                     font-weight: bold;
                     border: 1px solid #ddd;
                     border-radius: 4px;
                     flex-shrink: 0;
                   "
                   onchange="updateBulkQtyDirectSale('${product.id}', this.value)">
            
            <!-- Plus Button -->
            <button type="button" class="bulk-qty-btn" 
                    onclick="updateBulkQtySale('${product.id}', 1)"
                    style="
                      padding: 6px 10px;
                      font-size: 16px;
                      background: #28a745;
                      color: white;
                      border: none;
                      border-radius: 4px;
                      cursor: pointer;
                      min-width: 40px;
                      min-height: 40px;
                      font-weight: bold;
                      transition: background 0.2s;
                      flex-shrink: 0;
                    "
                    onmouseover="this.style.background='#218838'"
                    onmouseout="this.style.background='#28a745'">
              +
            </button>
          </div>
          
          <!-- RIGHT: Remove Button -->
          <button type="button" class="btn btn-sm btn-link text-danger bulk-remove-btn" 
                  onclick="toggleBulkProductSelectionSale('${product.id}', '${escapeHtml(product.name)}', '${product.size}', ${product.price})"
                  style="
                    padding: 6px 10px;
                    font-size: 16px;
                    min-width: 40px;
                    min-height: 40px;
                    cursor: pointer;
                    flex-shrink: 0;
                  ">
            ‚úï
          </button>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
  updateBulkCountersSale();
  console.log('‚úÖ Rendered', selectedArray.length, 'selected items for sale');
}

/**
 * Update quantity (increment/decrement)
 */
function updateBulkQtySale(productId, change) {
  if (selectedBulkProductsSale[productId]) {
    const newQty = Math.max(1, selectedBulkProductsSale[productId].qty + change);
    selectedBulkProductsSale[productId].qty = newQty;
    renderBulkSelectedItemsSale();
    console.log('üìä Updated qty:', newQty);
  }
}

/**
 * Update quantity (direct input)
 */
function updateBulkQtyDirectSale(productId, value) {
  if (selectedBulkProductsSale[productId]) {
    const newQty = Math.max(1, parseInt(value) || 1);
    selectedBulkProductsSale[productId].qty = newQty;
    renderBulkSelectedItemsSale();
    console.log('üìä Updated qty directly:', newQty);
  }
}

/**
 * Add all selected products to Record Sale Grid
 */
/**
 * Add all selected products to Record Sale
 */
function addBulkProductsToSale() {
  const selectedArray = Object.values(selectedBulkProductsSale);
  
  if (selectedArray.length === 0) {
    alert('‚ùå Please select at least one product');
    return;
  }
  
  console.log('üì¶ Adding', selectedArray.length, 'products to Record Sale');
  
  const tbody = document.getElementById('product-grid-body');
  if (!tbody) {
    console.error('‚ùå Record Sale table body not found');
    return;
  }
  
  // Add each product as a new row
  selectedArray.forEach((product, index) => {
    // Get current number of rows
    const rowIndex = tbody.querySelectorAll('tr').length + 1;
    
    // Create new row element
    const tr = document.createElement('tr');
    tr.className = 'product-row';
    tr.setAttribute('data-index', rowIndex);
    
    const displayName = product.size ? `${product.name} (${product.size})` : product.name;
    
    // ‚úÖ Build row HTML (MATCHING YOUR EXISTING TABLE STRUCTURE)
    tr.innerHTML = `
      <td class="grid-row-number">${rowIndex}</td>
      <td>
        <select class="form-select product-select" id="product-${rowIndex}" onchange="onProductSelect(${rowIndex})">
          <option value="">-- Select Product --</option>
        </select>
      </td>
      <td><input type="text" class="form-control size-input readonly-input" id="size-${rowIndex}" readonly /></td>
      <td><input type="number" class="form-control qty-input" id="qty-${rowIndex}" min="1" placeholder="Enter quantity" oninput="onQtyChange(${rowIndex})"></td>
      <td><input type="text" class="form-control unit-input readonly-input" id="unit-${rowIndex}" readonly /></td>
      <td><input type="number" class="form-control price-input readonly-input" id="price-${rowIndex}" readonly /></td>
      <td><div id="total-${rowIndex}" class="fw-bold">‚Çπ0.00</div></td>
      <td><button class="btn btn-sm btn-outline-danger" onclick="removeRow(this)"><i class="bi bi-x"></i></button></td>
    `;
    
    tbody.appendChild(tr);
    
    // ‚úÖ CRITICAL: Populate the product select dropdown FIRST
    populateProductSelectForRow(rowIndex);
    
    // ‚úÖ CRITICAL: Set the select value to the product ID
    const select = document.getElementById(`product-${rowIndex}`);
    if (select) {
      select.value = product.id;
      console.log('‚úÖ Set product select value:', product.id);
    }
    
    // ‚úÖ NOW trigger onProductSelect to auto-fill all fields
    onProductSelect(rowIndex);
    
    // ‚úÖ Set quantity
    const qtyInput = document.getElementById(`qty-${rowIndex}`);
    if (qtyInput) {
      qtyInput.value = product.qty;
      console.log('‚úÖ Set quantity:', product.qty);
    }
    
    // ‚úÖ Trigger calculation
    onQtyChange(rowIndex);
    
    console.log('‚úÖ Added row', rowIndex, ':', displayName, 'x' + product.qty);
  });
  
  // ‚úÖ Calculate grand total AFTER all rows added
  setTimeout(() => {
    updateGrandTotal();
    updateRowNumbers();
    console.log('‚úÖ Record Sale totals calculated');
  }, 100);
  
  // Clear selections
  selectedBulkProductsSale = {};
  
  // Close modal
  const modal = bootstrap.Modal.getInstance(document.getElementById('bulkAddModalForSale'));
  if (modal) {
    modal.hide();
  }
  
  console.log('‚úÖ All', selectedArray.length, 'products added successfully!');
}

/**
 * Calculate Record Sale totals
 */
function calculateRecordSaleTotal() {
  const tbody = document.getElementById('product-grid-body');
  if (!tbody) return;
  
  let subtotal = 0;
  const rows = tbody.querySelectorAll('tr');
  
  rows.forEach((row, index) => {
    const qtyInput = row.querySelector(`input[id^="saleQty-"]`);
    const priceInput = row.querySelector(`input[id^="salePrice-"]`);
    const totalSpan = row.querySelector(`span[id^="saleRowTotal-"]`);
    
    if (qtyInput && priceInput) {
      const qty = parseInt(qtyInput.value) || 0;
      const price = parseFloat(priceInput.value) || 0;
      const rowTotal = qty * price;
      
      if (totalSpan) {
        totalSpan.textContent = `‚Çπ${rowTotal.toFixed(2)}`;
      }
      
      subtotal += rowTotal;
    }
  });
  
  // Update totals
  const subtotalSpan = document.getElementById('subtotal');
  const grandTotalSpan = document.getElementById('grandTotal');
  
  if (subtotalSpan) {
    subtotalSpan.textContent = `‚Çπ${subtotal.toFixed(2)}`;
  }
  if (grandTotalSpan) {
    grandTotalSpan.textContent = `‚Çπ${subtotal.toFixed(2)}`;
  }
}

/**
 * Delete sale row
 */
function deleteSaleRow(rowIndex) {
  const tbody = document.getElementById('product-grid-body');
  if (!tbody) return;
  
  const row = tbody.querySelector(`tr[data-index="${rowIndex}"]`);
  if (row) {
    row.remove();
    calculateRecordSaleTotal();
  }
}










    

  /**
 * ==========================================
 * INVOICE GENERATOR 
 * ==========================================
 */

// Global variable to store invoice number counter
let invoiceCounter = parseInt(localStorage.getItem('lastInvoiceNumber') || '0');

function generateInvoice() {
  // ‚úÖ REMOVED: No longer require products from sale grid
  // Users can now open invoice modal directly and add items manually
  
  console.log('üìÑ Opening invoice generator...');
  
  // Store empty items temporarily (user can add manually in modal)
  window.tempInvoiceItems = [];
  
  // Close Sales Modal if open
  const salesModal = bootstrap.Modal.getInstance(document.getElementById('salesModal'));
  if (salesModal) {
    salesModal.hide();
    console.log('‚úÖ Sales modal closed');
  }
  
  // Wait for modal to close, then open invoice modal
  setTimeout(() => {
    openInvoiceModal();
  }, 300);
}

function openInvoiceModal() {
  console.log('üöÄ Opening invoice modal...');
  
  // Check if modal exists
  const modalEl = document.getElementById('invoiceModal');
  
  if (!modalEl) {
    console.error('‚ùå Invoice modal not found');
    alert('‚ùå Invoice modal not found. Please refresh the page.');
    return;
  }
  
  // Generate invoice number
  invoiceCounter++;
  const invoiceNo = 'INV-' + String(invoiceCounter).padStart(6, '0');
  
  const invoiceNumEl = document.getElementById('invoiceNumber');
  if (invoiceNumEl) {
    invoiceNumEl.value = invoiceNo;
  }
  
  localStorage.setItem('lastInvoiceNumber', invoiceCounter);
  console.log('‚úÖ Invoice number generated:', invoiceNo);
  
  // Set today's date
  const today = new Date().toISOString().split('T')[0];
  const dateEl = document.getElementById('invoiceDate');
  if (dateEl) {
    dateEl.value = today;
  }
  
  calculateDueDate();
  populateInvoiceItems();
  loadDefaultTerms();
  
  // Show modal
  try {
    const bsModal = new bootstrap.Modal(modalEl);
    bsModal.show();
    console.log('‚úÖ Invoice modal opened');
  } catch (error) {
    console.error('‚ùå Error opening modal:', error);
  }
}

// Regenerate Invoice Number
function regenerateInvoiceNumber() {
  invoiceCounter++;
  const invoiceNo = 'INV-' + String(invoiceCounter).padStart(6, '0');
  document.getElementById('invoiceNumber').value = invoiceNo;
  localStorage.setItem('lastInvoiceNumber', invoiceCounter);
  console.log('‚úÖ Invoice number regenerated:', invoiceNo);
}

// Calculate Due Date based on Payment Terms
function calculateDueDate() {
  const invoiceDate = new Date(document.getElementById('invoiceDate').value);
  const terms = parseInt(document.getElementById('paymentTerms').value);
  
  const dueDate = new Date(invoiceDate);
  dueDate.setDate(dueDate.getDate() + terms);
  
  document.getElementById('invoiceDueDate').value = dueDate.toISOString().split('T')[0];
}

// Populate Invoice Items from Sale
function populateInvoiceItems() {
  const tbody = document.getElementById('invoiceItemsBody');
  tbody.innerHTML = '';
  
  // ‚úÖ CHANGED: If no items, create empty row for user to add
  if (!window.tempInvoiceItems || window.tempInvoiceItems.length === 0) {
    console.log('üìù No items from sale, adding empty row for manual entry');
    const emptyItem = {
      name: '',
      size: '',
      quantity: 1,
      rate: 0,
      amount: 0
    };
    tbody.innerHTML += createInvoiceRow(emptyItem, 0);
    calculateInvoiceTotal();
    return;
  }
  
  window.tempInvoiceItems.forEach((item, index) => {
    const row = createInvoiceRow(item, index);
    tbody.innerHTML += row;
  });
  
  calculateInvoiceTotal();
}

/**
 * Create Invoice Row HTML (UPDATED - matches Purchase style)
 */
/**
 * Create Invoice Row HTML (GRID LAYOUT - MATCHES PURCHASE)
 */
/**
 * Create Invoice Row HTML (3-LINE MOBILE LAYOUT - MATCHES PURCHASE)
 */
function createInvoiceRow(item, index) {
  const itemName = item.size ? `${item.name} (${item.size})` : item.name;
  const amount = (item.quantity * item.rate).toFixed(2);
  
  return `
    <div class="invoice-product-row" id="invoiceRow${index}" data-index="${index}">
      <!-- Line 1: Product Name -->
      <div class="invoice-name-line">
        <div class="invoice-field-label">Product Name</div>
        <input type="text" class="form-control" placeholder="Product name"
               id="invoiceProduct-${index}"
               value="${escapeHtml(itemName)}">
      </div>
      
      <!-- Line 2: Qty & Rate -->
      <div class="invoice-details-line">
        <div>
          <div class="invoice-field-label">Quantity</div>
          <input type="number" class="form-control" placeholder="Qty" min="1"
                 id="invoiceQty-${index}"
                 value="${item.quantity}"
                 oninput="updateInvoiceRowTotal(${index}); calculateInvoiceTotal();">
        </div>
        <div>
          <div class="invoice-field-label">Rate</div>
          <input type="number" class="form-control" placeholder="Rate" min="0" step="0.01"
                 id="invoiceRate-${index}"
                 value="${item.rate}"
                 oninput="updateInvoiceRowTotal(${index}); calculateInvoiceTotal();">
        </div>
      </div>
      
      <!-- Line 3: Amount -->
      <div class="invoice-amount-line">
        <div class="invoice-field-label">Amount</div>
        <input type="text" class="form-control" placeholder="Amount" readonly
               id="invoiceRowTotal-${index}"
               value="‚Çπ${amount}"
               style="background: #e8f5e9; font-weight: 600; color: #2e7d32;">
      </div>
      
      <!-- Remove Button (Top-Right on Mobile, Inline on Desktop) -->
      <button type="button" class="btn btn-danger invoice-remove-btn"
              onclick="deleteInvoiceRow(${index})">
        √ó
      </button>
    </div>
  `;
}

/**
 * Update individual row total (FIXED - direct TD update like Purchase)
 */
/**
 * Add a new empty invoice row (GRID LAYOUT - MATCHES PURCHASE)
 */
/**
 * Add a new empty invoice row (3-LINE MOBILE LAYOUT)
 */
/**
 * Add a new empty invoice row (USES createInvoiceRow FOR CONSISTENCY)
 */
function addInvoiceRow() {
  const container = document.getElementById('invoiceItemsBody');
  if (!container) {
    console.error('‚ùå Invoice container not found');
    return;
  }
  
  // Get current number of rows
  const rowIndex = container.querySelectorAll('.invoice-product-row').length;
  
  // ‚úÖ Create empty item object
  const emptyItem = {
    name: '',
    size: '',
    quantity: 1,
    rate: 0
  };
  
  // ‚úÖ Use createInvoiceRow function to ensure consistency
  const rowHTML = createInvoiceRow(emptyItem, rowIndex);
  
  // Add row to container
  container.insertAdjacentHTML('beforeend', rowHTML);
  
  console.log('‚úÖ Added new invoice row', rowIndex);
}



/**
 * Update individual row total (GRID LAYOUT VERSION)
 */
function updateInvoiceRowTotal(rowIndex) {
  console.log('üîÑ Updating row', rowIndex, 'total...');
  
  const qtyInput = document.getElementById(`invoiceQty-${rowIndex}`);
  const rateInput = document.getElementById(`invoiceRate-${rowIndex}`);
  const totalInput = document.getElementById(`invoiceRowTotal-${rowIndex}`);
  
  if (!qtyInput || !rateInput || !totalInput) {
    console.warn('‚ö†Ô∏è Row', rowIndex, 'missing required elements');
    return;
  }
  
  const qty = parseFloat(qtyInput.value) || 0;
  const rate = parseFloat(rateInput.value) || 0;
  const total = qty * rate;
  
  totalInput.value = '‚Çπ' + total.toFixed(2);
  
  console.log('‚úÖ Row', rowIndex, 'updated:', qty, 'x', rate, '=', total);
}



    
/**
 * Delete invoice row and recalculate totals
 */
/**
 * Delete invoice row and recalculate totals (GRID VERSION)
 */
/**
 * Delete invoice row and recalculate totals (WITH RENUMBERING)
 */
function deleteInvoiceRow(rowIndex) {
  console.log('üóëÔ∏è Deleting row', rowIndex);
  
  const row = document.getElementById(`invoiceRow${rowIndex}`);
  if (row) {
    row.remove();
    console.log('‚úÖ Row', rowIndex, 'deleted');
    
    // ‚úÖ Renumber remaining rows
    renumberInvoiceRows();
  }
  
  // Recalculate totals
  calculateInvoiceTotal();
}




/**
 * Calculate and update invoice totals (UPDATED FOR GRID LAYOUT)
 */
function calculateInvoiceTotal() {
  console.log('üìä Calculating invoice totals...');
  
  const container = document.getElementById('invoiceItemsBody');
  if (!container) {
    console.warn('‚ö†Ô∏è Invoice container not found');
    return;
  }
  
  let subtotal = 0;
  const rows = container.querySelectorAll('.invoice-product-row');
  
  console.log('üîç Processing', rows.length, 'rows');
  
  // Process each row
  rows.forEach((row, rowIdx) => {
    const rowIndex = row.getAttribute('data-index');
    
    const qtyInput = document.getElementById(`invoiceQty-${rowIndex}`);
    const rateInput = document.getElementById(`invoiceRate-${rowIndex}`);
    const totalInput = document.getElementById(`invoiceRowTotal-${rowIndex}`);
    
    if (qtyInput && rateInput && totalInput) {
      const qty = parseFloat(qtyInput.value) || 0;
      const rate = parseFloat(rateInput.value) || 0;
      const rowTotal = qty * rate;
      
      // Update row total display
      totalInput.value = '‚Çπ' + rowTotal.toFixed(2);
      
      subtotal += rowTotal;
      
      console.log('  Row', rowIdx, ':', qty, 'x', rate, '=', rowTotal);
    }
  });
  
  console.log('‚úÖ Subtotal calculated:', subtotal);
  
  // Get discount
  const discountInput = document.getElementById('invoiceDiscount');
  const discountTypeSelect = document.getElementById('invoiceDiscountType');
  let discountAmount = 0;
  
  if (discountInput && discountTypeSelect) {
    const discountValue = parseFloat(discountInput.value) || 0;
    const discountType = discountTypeSelect.value;
    
    if (discountType === 'percent') {
      discountAmount = (subtotal * discountValue) / 100;
    } else {
      discountAmount = discountValue;
    }
  }
  
  // Get tax rate
  const taxSelect = document.getElementById('invoiceTaxRate');
  let taxRate = 0;
  
  if (taxSelect) {
    taxRate = parseFloat(taxSelect.value) || 0;
  }
  
  // Calculate amounts
  const afterDiscount = subtotal - discountAmount;
  const taxAmount = (afterDiscount * taxRate) / 100;
  const grandTotal = afterDiscount + taxAmount;
  
  // Update display elements
  const subtotalSpan = document.getElementById('invoiceSubtotal');
  const discountAmountSpan = document.getElementById('invoiceDiscountAmount');
  const taxAmountSpan = document.getElementById('invoiceTaxAmount');
  const grandTotalSpan = document.getElementById('invoiceGrandTotal');
  
  if (subtotalSpan) {
    subtotalSpan.textContent = '‚Çπ' + subtotal.toFixed(2);
  }
  
  if (discountAmountSpan) {
    discountAmountSpan.textContent = '-‚Çπ' + discountAmount.toFixed(2);
  }
  
  if (taxAmountSpan) {
    taxAmountSpan.textContent = '‚Çπ' + taxAmount.toFixed(2);
  }
  
  if (grandTotalSpan) {
    grandTotalSpan.textContent = '‚Çπ' + grandTotal.toFixed(2);
  }
  
  console.log('‚úÖ Totals updated:', {
    subtotal: subtotal.toFixed(2),
    discount: discountAmount.toFixed(2),
    tax: taxAmount.toFixed(2),
    grandTotal: grandTotal.toFixed(2)
  });
}

// Load Default Terms & Conditions
function loadDefaultTerms() {
  const defaultTerms = `1. Payment due within 14 days of invoice date
2. Late payments subject to 2% monthly interest charge
3. Goods once sold cannot be returned or exchanged
4. Delivery charges may apply for orders under ‚Çπ10,000
5. Company not responsible for damages during transit`;
  
  document.getElementById('invoiceTerms').value = defaultTerms;
}

/**
 * ==========================================
 * OPTIONAL: SAVE INVOICE TO FIREBASE
 * ==========================================
 */

/**
 * Save generated invoice to Firestore
 */
async function saveInvoiceToFirebase() {
  const user = window.auth.currentUser;
  if (!user) {
    alert('Please sign in to save invoice');
    return;
  }
  
  try {
    // Get invoice data from form
    const invoiceNo = document.getElementById('invoiceNumber')?.value;
    const invoiceDate = document.getElementById('invoiceDate')?.value;
    const dueDate = document.getElementById('invoiceDueDate')?.value;
    const customerName = document.getElementById('customerName')?.value;
    const customerEmail = document.getElementById('customerEmail')?.value;
    const customerPhone = document.getElementById('customerPhone')?.value;
    const customerAddress = document.getElementById('customerAddress')?.value;
    
    // Get items
    const items = [];
    const container = document.getElementById('invoiceItemsBody');
    const rows = container.querySelectorAll('.invoice-product-row');
    
    rows.forEach((row) => {
      const rowIndex = row.getAttribute('data-index');
      const product = document.getElementById(`invoiceProduct-${rowIndex}`)?.value;
      const qty = parseFloat(document.getElementById(`invoiceQty-${rowIndex}`)?.value) || 0;
      const rate = parseFloat(document.getElementById(`invoiceRate-${rowIndex}`)?.value) || 0;
      
      if (product && qty > 0 && rate > 0) {
        items.push({
          product: product,
          quantity: qty,
          rate: rate,
          amount: qty * rate
        });
      }
    });
    
    // Get totals
    const subtotal = parseFloat(document.getElementById('invoiceSubtotal')?.textContent.replace('‚Çπ', '') || 0);
    const discount = parseFloat(document.getElementById('invoiceDiscountAmount')?.textContent.replace('-‚Çπ', '') || 0);
    const tax = parseFloat(document.getElementById('invoiceTaxAmount')?.textContent.replace('‚Çπ', '') || 0);
    const grandTotal = parseFloat(document.getElementById('invoiceGrandTotal')?.textContent.replace('‚Çπ', '') || 0);
    
    // Get terms
    const terms = document.getElementById('invoiceTerms')?.value;
    
    // Build invoice object
    const invoiceData = {
      invoiceNumber: invoiceNo,
      invoiceDate: invoiceDate,
      dueDate: dueDate,
      customer: {
        name: customerName,
        email: customerEmail,
        phone: customerPhone,
        address: customerAddress
      },
      items: items,
      subtotal: subtotal,
      discount: discount,
      tax: tax,
      grandTotal: grandTotal,
      terms: terms,
      status: 'pending',
      createdAt: new Date().toISOString(),
      userId: user.uid
    };
    
    console.log('üíæ Saving invoice to Firebase:', invoiceData);
    
    // Save to Firestore
    const { collection, addDoc } = window.firebaseImports;
    const invoicesRef = collection(window.db, 'tenants', user.uid, 'invoices');
    
    const docRef = await addDoc(invoicesRef, invoiceData);
    
    console.log('‚úÖ Invoice saved to Firebase:', docRef.id);
    
    showSuccessToast(`‚úÖ Invoice ${invoiceNo} saved successfully!`);
    
    return docRef.id;
    
  } catch (error) {
    console.error('‚ùå Error saving invoice:', error);
    alert('Failed to save invoice: ' + error.message);
    return null;
  }
}

/**
 * Load customer invoices from Firestore
 */
async function loadCustomerInvoices() {
  const user = window.auth.currentUser;
  if (!user) {
    console.log('No user authenticated, skipping invoice load');
    return;
  }
  
  try {
    const { collection, getDocs, query, orderBy } = window.firebaseImports;
    
    const invoicesRef = collection(window.db, 'tenants', user.uid, 'invoices');
    const q = query(invoicesRef, orderBy('createdAt', 'desc'));
    const snapshot = await getDocs(q);
    
    const invoices = [];
    snapshot.forEach((doc) => {
      invoices.push({
        id: doc.id,
        ...doc.data()
      });
    });
    
    console.log(`‚úÖ Loaded ${invoices.length} invoices from Firebase`);
    
    // Store in global variable for display
    window.cachedInvoices = invoices;
    
    // If you have a display function, call it here
    if (typeof displayInvoices === 'function') {
      displayInvoices(invoices);
    }
    
    return invoices;
    
  } catch (error) {
    console.error('‚ùå Error loading invoices:', error);
    return [];
  }
}




/**
 * ==========================================
 * INVOICE BULK ADD MODAL
 * ==========================================
 */

// Global variable to store selected products
let selectedBulkProducts = {};

/**
 * Open Bulk Add Modal
 */
/**
 * Open Bulk Add Modal (WITH SAFETY CHECKS)
 */
function openBulkAddModal() {
  console.log('üì¶ Opening Bulk Add Modal for Invoice');
  
  // ‚úÖ SAFE: Reset search input (check if exists first)
  const searchInput = document.getElementById('bulkSearchInput');
  if (searchInput) {
    searchInput.value = '';
  } else {
    console.warn('‚ö†Ô∏è bulkSearchInput element not found');
  }
  
  // ‚úÖ ALWAYS RESET COMPLETELY
  selectedBulkProducts = {};
  
  // ‚úÖ Clear selected items panel
  const selectedContainer = document.getElementById('bulkSelectedItems');
  if (selectedContainer) {
    selectedContainer.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">No items selected</div>';
  }
  
  // ‚úÖ Reset counters
  updateBulkCounters();
  
  // Render all products
  renderBulkProductsList('');
  
  // Show modal
  const modalElement = document.getElementById('bulkAddModal');
  if (modalElement) {
    const modal = new bootstrap.Modal(modalElement);
    modal.show();
    console.log('‚úÖ Modal opened with clean state');
  } else {
    console.error('‚ùå bulkAddModal element not found!');
    alert('Error: Bulk Add Modal not found. Please check your HTML.');
  }
}


/**
 * Filter products by search query
 */
function filterBulkProducts(query) {
  console.log('üîç Filtering bulk products:', query);
  renderBulkProductsList(query);
}

/**
 * Render products list on left side
 */
function renderBulkProductsList(searchQuery) {
  const container = document.getElementById('bulkProductsList');
  if (!container) return;
  
  const products = cachedProducts || [];
  let filtered = products;
  
  // Filter by search query
  if (searchQuery && searchQuery.trim().length > 0) {
    const query = searchQuery.toLowerCase();
    filtered = products.filter(product => {
      const name = product.name.toLowerCase();
      const brand = (product.brand || '').toLowerCase();
      const category = (product.category || '').toLowerCase();
      
      return name.includes(query) || brand.includes(query) || category.includes(query);
    });
  }
  
  if (filtered.length === 0) {
    container.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">No products found</div>';
    return;
  }
  
  let html = '';
  filtered.forEach(product => {
    const isSelected = selectedBulkProducts[product.id];
    const displayName = product.size ? `${product.name} (${product.size})` : product.name;
    const rateText = product.price ? `‚Çπ${product.price.toFixed(2)}` : 'N/A';
    const stockText = product.stock ? `Stock: ${product.stock}` : '';
    
    html += `
      <div onclick="toggleBulkProductSelection('${product.id}', '${escapeHtml(product.name)}', '${escapeHtml(product.size || '')}', ${product.price || 0})"
           style="
             padding: 12px;
             border-bottom: 1px solid #f0f0f0;
             cursor: pointer;
             transition: background-color 0.2s;
             display: flex;
             justify-content: space-between;
             align-items: center;
             ${isSelected ? 'background-color: #e3f2fd;' : 'background-color: white;'}
           "
           onmouseover="this.style.backgroundColor='#f5f5f5'"
           onmouseout="this.style.backgroundColor='${isSelected ? '#e3f2fd' : 'white'}'"
      >
        <div style="flex: 1;">
          <strong>${escapeHtml(displayName)}</strong>
          <div style="font-size: 0.85rem; color: #666;">
            ${rateText} ${stockText ? '‚Ä¢ ' + stockText : ''}
          </div>
        </div>
        <div style="
          width: 24px;
          height: 24px;
          display: flex;
          align-items: center;
          justify-content: center;
          margin-left: 10px;
        ">
          ${isSelected ? '‚úì' : ''}
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
  console.log('‚úÖ Rendered', filtered.length, 'products');
}

/**
 * Toggle product selection
 */
function toggleBulkProductSelection(productId, productName, productSize, productPrice) {
  console.log('‚úì Toggle product:', productName);
  
  if (selectedBulkProducts[productId]) {
    // Remove if already selected
    delete selectedBulkProducts[productId];
    console.log('‚ùå Removed:', productName);
  } else {
    // Add if not selected
    selectedBulkProducts[productId] = {
      id: productId,
      name: productName,
      size: productSize,
      price: productPrice,
      qty: 1
    };
    console.log('‚úÖ Added:', productName);
  }
  
  // Refresh both panels
  renderBulkProductsList(document.getElementById('bulkSearchInput').value);
  renderBulkSelectedItems();
}


/**
 * Render selected items with FIXED HORIZONTAL BUTTONS
 */
function renderBulkSelectedItems() {
  const container = document.getElementById('bulkSelectedItems');
  if (!container) return;
  
  const selectedArray = Object.values(selectedBulkProducts);
  
  if (selectedArray.length === 0) {
    container.innerHTML = '<div style="padding: 20px; text-align: center; color: #999;">No items selected</div>';
    updateBulkCounters();
    return;
  }
  
  let html = '';
  selectedArray.forEach((product, idx) => {
    const displayName = product.size ? `${product.name} (${product.size})` : product.name;
    
    html += `
      <div style="
        padding: 12px;
        border-bottom: 1px solid #ddd;
      ">
        <!-- Product Info (always on top) -->
        <div style="margin-bottom: 8px;">
          <strong style="display: block; font-size: 14px; margin-bottom: 4px;">
            ${escapeHtml(displayName)}
          </strong>
          <div style="font-size: 0.85rem; color: #666;">
            ‚Çπ${product.price.toFixed(2)}
          </div>
        </div>
        
        <!-- Quantity Controls (ALWAYS HORIZONTAL) -->
        <div style="
          display: flex;
          justify-content: space-between;
          align-items: center;
          gap: 8px;
          flex-wrap: nowrap;
        ">
          <!-- LEFT: Minus, Qty, Plus (HORIZONTAL) -->
          <div style="
            display: flex;
            align-items: center;
            gap: 4px;
            flex-wrap: nowrap;
            min-width: 0;
          ">
            <!-- Minus Button -->
            <button type="button" class="bulk-qty-btn" 
                    onclick="updateBulkQty('${product.id}', -1)"
                    style="
                      padding: 6px 10px;
                      font-size: 16px;
                      background: #dc3545;
                      color: white;
                      border: none;
                      border-radius: 4px;
                      cursor: pointer;
                      min-width: 40px;
                      min-height: 40px;
                      font-weight: bold;
                      transition: background 0.2s;
                      flex-shrink: 0;
                    "
                    onmouseover="this.style.background='#c82333'"
                    onmouseout="this.style.background='#dc3545'">
              ‚àí
            </button>
            
            <!-- Quantity Input -->
            <input type="number" value="${product.qty}" 
                   class="bulk-qty-input"
                   style="
                     width: 50px;
                     padding: 6px;
                     text-align: center;
                     font-size: 14px;
                     font-weight: bold;
                     border: 1px solid #ddd;
                     border-radius: 4px;
                     flex-shrink: 0;
                   "
                   onchange="updateBulkQtyDirect('${product.id}', this.value)">
            
            <!-- Plus Button -->
            <button type="button" class="bulk-qty-btn" 
                    onclick="updateBulkQty('${product.id}', 1)"
                    style="
                      padding: 6px 10px;
                      font-size: 16px;
                      background: #28a745;
                      color: white;
                      border: none;
                      border-radius: 4px;
                      cursor: pointer;
                      min-width: 40px;
                      min-height: 40px;
                      font-weight: bold;
                      transition: background 0.2s;
                      flex-shrink: 0;
                    "
                    onmouseover="this.style.background='#218838'"
                    onmouseout="this.style.background='#28a745'">
              +
            </button>
          </div>
          
          <!-- RIGHT: Remove Button -->
          <button type="button" class="btn btn-sm btn-link text-danger bulk-remove-btn" 
                  onclick="toggleBulkProductSelection('${product.id}', '${escapeHtml(product.name)}', '${product.size}', ${product.price})"
                  style="
                    padding: 6px 10px;
                    font-size: 16px;
                    min-width: 40px;
                    min-height: 40px;
                    cursor: pointer;
                    flex-shrink: 0;
                  ">
            ‚úï
          </button>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
  updateBulkCounters();
  console.log('‚úÖ Rendered', selectedArray.length, 'selected items (horizontal buttons)');
}

/**
 * Update quantity (increment/decrement)
 */
function updateBulkQty(productId, change) {
  if (selectedBulkProducts[productId]) {
    const newQty = Math.max(1, selectedBulkProducts[productId].qty + change);
    selectedBulkProducts[productId].qty = newQty;
    renderBulkSelectedItems();
    console.log('üìä Updated qty:', newQty);
  }
}

/**
 * Update quantity (direct input)
 */
function updateBulkQtyDirect(productId, value) {
  if (selectedBulkProducts[productId]) {
    const newQty = Math.max(1, parseInt(value) || 1);
    selectedBulkProducts[productId].qty = newQty;
    renderBulkSelectedItems();
    console.log('üìä Updated qty directly:', newQty);
  }
}

/**
 * Update counters (selected count, total qty)
 */
function updateBulkCounters() {
  const selectedArray = Object.values(selectedBulkProducts);
  const selectedCount = selectedArray.length;
  const totalQty = selectedArray.reduce((sum, p) => sum + p.qty, 0);
  
  document.getElementById('bulkSelectedCount').textContent = selectedCount;
  document.getElementById('bulkTotalQty').textContent = totalQty;
  
  console.log('üìä Counters: Selected=' + selectedCount + ', TotalQty=' + totalQty);
}

/**
 * ‚úÖ Renumber all invoice rows after adding/removing (PREVENTS INDEX CONFLICTS)
 */
function renumberInvoiceRows() {
  const container = document.getElementById('invoiceItemsBody');
  if (!container) return;
  
  const rows = container.querySelectorAll('.invoice-product-row');
  
  rows.forEach((row, newIndex) => {
    const oldIndex = row.getAttribute('data-index');
    
    // Update row data-index
    row.setAttribute('data-index', newIndex);
    row.id = `invoiceRow${newIndex}`;
    
    // Update all input IDs
    const productInput = row.querySelector('input[id^="invoiceProduct-"]');
    const qtyInput = row.querySelector('input[id^="invoiceQty-"]');
    const rateInput = row.querySelector('input[id^="invoiceRate-"]');
    const totalInput = row.querySelector('input[id^="invoiceRowTotal-"]');
    const deleteBtn = row.querySelector('button[onclick*="deleteInvoiceRow"]');
    
    if (productInput) productInput.id = `invoiceProduct-${newIndex}`;
    if (qtyInput) {
      qtyInput.id = `invoiceQty-${newIndex}`;
      qtyInput.setAttribute('oninput', `updateInvoiceRowTotal(${newIndex}); calculateInvoiceTotal();`);
    }
    if (rateInput) {
      rateInput.id = `invoiceRate-${newIndex}`;
      rateInput.setAttribute('oninput', `updateInvoiceRowTotal(${newIndex}); calculateInvoiceTotal();`);
    }
    if (totalInput) totalInput.id = `invoiceRowTotal-${newIndex}`;
    if (deleteBtn) {
      deleteBtn.setAttribute('onclick', `deleteInvoiceRow(${newIndex})`);
    }
    
    console.log(`  Row ${oldIndex} ‚Üí ${newIndex}`);
  });
  
  console.log('‚úÖ Renumbered', rows.length, 'invoice rows');
}

/**
 * ‚úÖ Add all selected products to invoice (FIXED DUPLICATE MATCHING)
 */
function addBulkProductsToInvoice() {
  const selectedArray = Object.values(selectedBulkProducts);
  
  if (selectedArray.length === 0) {
    alert('‚ùå Please select at least one product');
    return;
  }
  
  console.log('üì¶ Adding', selectedArray.length, 'products to invoice');
  
  const container = document.getElementById('invoiceItemsBody');
  if (!container) {
    console.error('‚ùå Invoice container not found');
    return;
  }
  
  selectedArray.forEach(product => {
    const productName = product.size ? `${product.name} (${product.size})` : product.name;
    
    // ‚úÖ FIX: Get fresh list of rows and check each one's product name input
    const allRows = container.querySelectorAll('.invoice-product-row');
    let existingRow = null;
    
    allRows.forEach(row => {
      const rowIndex = row.getAttribute('data-index');
      const nameInput = document.getElementById(`invoiceProduct-${rowIndex}`);
      
      // Check if product name matches (exact match, trimmed)
      if (nameInput && nameInput.value.trim() === productName) {
        existingRow = row;
      }
    });
    
    if (existingRow) {
      // ‚úÖ PRODUCT EXISTS - MERGE QUANTITY
      const rowIndex = existingRow.getAttribute('data-index');
      const qtyInput = document.getElementById(`invoiceQty-${rowIndex}`);
      
      if (qtyInput) {
        const currentQty = parseFloat(qtyInput.value) || 0;
        const newQty = currentQty + product.qty;
        qtyInput.value = newQty;
        
        // Update total
        updateInvoiceRowTotal(parseInt(rowIndex));
        
        console.log(`‚úÖ Merged: ${productName} - Updated qty from ${currentQty} to ${newQty}`);
      }
    } else {
      // ‚úÖ NEW PRODUCT - ADD TO TOP
      // Get fresh count for new index
      const currentRowCount = container.querySelectorAll('.invoice-product-row').length;
      const newRowIndex = currentRowCount;
      
      const item = {
        name: product.name,
        size: product.size || '',
        quantity: product.qty,
        rate: product.price
      };
      
      // ‚úÖ Use createInvoiceRow function
      const rowHTML = createInvoiceRow(item, newRowIndex);
      
      // Add to top of container
      container.insertAdjacentHTML('afterbegin', rowHTML);
      
      console.log(`‚úÖ Added new: ${productName} - Qty ${product.qty} at index ${newRowIndex}`);
    }
  });
  
  // ‚úÖ After all products added, renumber all rows to fix indices
  renumberInvoiceRows();
  
  // Calculate totals
  setTimeout(() => {
    calculateInvoiceTotal();
  }, 50);
  
  // Clear selections and close modal
  selectedBulkProducts = {};
  const modal = bootstrap.Modal.getInstance(document.getElementById('bulkAddModal'));
  if (modal) {
    modal.hide();
  }
  
  console.log('‚úÖ All products added/merged successfully!');
}


/**
 * Helper: Escape HTML characters
 */
function escapeHtml(text) {
  const map = {
    '&': '&amp;',
    '<': '&lt;',
    '>': '&gt;',
    '"': '&quot;',
    "'": '&#039;'
  };
  return String(text).replace(/[&<>"']/g, m => map[m]);
}









    



/**
 * ==========================================
 * SAVE INVOICE - FIREBASE VERSION
 * ==========================================
 */

async function saveInvoice() {
  console.log('üíæ Save Invoice clicked');
  
  const user = window.auth.currentUser;
  if (!user) {
    alert('Please sign in to save invoice');
    return;
  }
  
  try {
    const customerName = document.getElementById('invoiceCustomerName')?.value.trim();
    
    if (!customerName) {
      alert('‚ö†Ô∏è Please enter customer name');
      return;
    }
    
    // Collect items from GRID LAYOUT (SKIP EMPTY ROWS)
    const items = [];
    const container = document.getElementById('invoiceItemsBody');
    
    if (container) {
      const rows = container.querySelectorAll('.invoice-product-row');
      
      rows.forEach(row => {
        const rowIndex = row.getAttribute('data-index');
        
        const nameInput = document.getElementById(`invoiceProduct-${rowIndex}`);
        const qtyInput = document.getElementById(`invoiceQty-${rowIndex}`);
        const rateInput = document.getElementById(`invoiceRate-${rowIndex}`);
        
        if (nameInput && qtyInput && rateInput) {
          const name = nameInput.value.trim();
          const qty = parseFloat(qtyInput.value) || 0;
          const rate = parseFloat(rateInput.value) || 0;
          
          if (name && (qty > 0 || rate > 0)) {
            items.push({
              name: name,
              quantity: qty,
              rate: rate,
              amount: qty * rate
            });
          }
        }
      });
    }
    
    if (items.length === 0) {
      alert('‚ö†Ô∏è Please add at least one product to the invoice');
      return;
    }
    
    // Calculate totals
    let subtotal = 0;
    items.forEach(item => {
      subtotal += item.amount;
    });
    
    const discount = parseFloat(document.getElementById('invoiceDiscount')?.value) || 0;
    const taxRate = parseFloat(document.getElementById('invoiceTaxRate')?.value) || 0;
    const taxableAmount = subtotal - discount;
    const tax = (taxableAmount * taxRate) / 100;
    const total = taxableAmount + tax;
    
    // Create invoice object
    const invoiceData = {
      invoiceNumber: document.getElementById('invoiceNumber').value,
      customerName: customerName,
      invoiceDate: document.getElementById('invoiceDate').value,
      dueDate: document.getElementById('invoiceDueDate').value,
      items: items,
      subtotal: subtotal,
      discount: discount,
      tax: tax,
      total: total,
      notes: document.getElementById('invoiceNotes')?.value || '',
      terms: document.getElementById('invoiceTerms')?.value || '',
      createdAt: new Date().toISOString(),
      userId: user.uid,
      userEmail: user.email
    };
    
    console.log('‚úÖ Invoice data ready:', invoiceData);
    
    // ‚úÖ Save to localStorage (immediate backup)
    let invoices = JSON.parse(localStorage.getItem('customerInvoices') || '[]');
    invoices.push(invoiceData);
    localStorage.setItem('customerInvoices', JSON.stringify(invoices));
    console.log('‚úÖ Saved to localStorage');
    
    // ‚úÖ Save to Firestore (cloud backup)
    let cloudSyncSuccess = false;
    let cloudSyncError = null;
    
    try {
      console.log('‚òÅÔ∏è Saving invoice to Firestore...');
      
      const { collection, addDoc } = window.firebaseImports;
      const invoicesRef = collection(window.db, 'tenants', user.uid, 'invoices');
      
      const docRef = await addDoc(invoicesRef, invoiceData);
      
      cloudSyncSuccess = true;
      console.log('‚úÖ Invoice saved to Firestore:', docRef.id);
      
    } catch (firebaseError) {
      cloudSyncError = firebaseError;
      console.error('‚ùå Firestore save error:', firebaseError);
    }
    
    // Show appropriate message
    if (cloudSyncSuccess) {
      alert(`‚úÖ Invoice saved successfully!\n\nüìÑ Invoice: ${invoiceData.invoiceNumber}\nüë§ Customer: ${customerName}\nüì¶ Items: ${items.length}\nüí∞ Total: ‚Çπ${total.toFixed(2)}\n\n‚òÅÔ∏è Saved to cloud (Firestore)`);
    } else {
      alert(`‚úÖ Invoice saved locally!\n\nüìÑ Invoice: ${invoiceData.invoiceNumber}\nüí∞ Total: ‚Çπ${total.toFixed(2)}\n\n‚ö†Ô∏è Cloud sync failed: ${cloudSyncError?.message || 'Unknown error'}\n\nThe invoice is saved on this device.`);
    }
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('invoiceModal'));
    if (modal) {
      modal.hide();
    }
    
    // Reload invoices list (if function exists)
    if (typeof loadCustomerInvoices === 'function') {
      setTimeout(() => {
        loadCustomerInvoices();
      }, 500);
    }
    
  } catch (error) {
    console.error('‚ùå Error saving invoice:', error);
    alert('‚ùå Error: ' + error.message);
  }
}


  
function previewInvoice() {
  console.log('üëÅÔ∏è Opening invoice preview...');
  
  // Collect invoice data
  const customerName = document.getElementById('invoiceCustomerName')?.value || 'Customer';
  const invoiceNumber = document.getElementById('invoiceNumber')?.value || 'INV-0000';
  const invoiceDate = document.getElementById('invoiceDate')?.value || new Date().toISOString().split('T')[0];
  const dueDate = document.getElementById('invoiceDueDate')?.value || invoiceDate;
  const paymentTerms = document.getElementById('paymentTerms')?.selectedOptions[0]?.text || 'Net 15';
  
  // ‚úÖ FIX: Get invoice items from GRID LAYOUT (not table rows)
  const container = document.getElementById('invoiceItemsBody');
  let items = [];
  let subtotal = 0;
  
  console.log('üìã Parsing invoice items from grid layout...');
  
  if (container) {
    // ‚úÖ Get all invoice-product-row divs (not tr elements)
    const rows = container.querySelectorAll('.invoice-product-row');
    console.log('‚úÖ Found', rows.length, 'product rows');
    
    rows.forEach((row, idx) => {
      const rowIndex = row.getAttribute('data-index');
      
      // Get inputs by ID (more reliable)
      const nameInput = document.getElementById(`invoiceProduct-${rowIndex}`);
      const qtyInput = document.getElementById(`invoiceQty-${rowIndex}`);
      const rateInput = document.getElementById(`invoiceRate-${rowIndex}`);
      
      if (nameInput && qtyInput && rateInput) {
        const name = nameInput.value.trim();
        const qty = parseFloat(qtyInput.value) || 0;
        const rate = parseFloat(rateInput.value) || 0;
        const amount = qty * rate;
        
        console.log('  Row', idx, ':', name, 'x', qty, '@', rate, '=', amount);
        
       if (name && (qty > 0 || rate > 0)) { 
          items.push({
            name: name || 'Unnamed Item',
            quantity: qty,
            rate: rate,
            amount: amount
          });
          subtotal += amount;
        }
      } else {
        console.log('  ‚è≠Ô∏è Skipped empty row');
      }
    });
  }
  
  console.log('‚úÖ Total items parsed:', items.length, 'Subtotal:', subtotal);
  
  // Get discount
  const discountInput = document.getElementById('invoiceDiscount');
  const discountTypeSelect = document.getElementById('invoiceDiscountType');
  let discountAmount = 0;
  
  if (discountInput && discountTypeSelect) {
    const discountValue = parseFloat(discountInput.value) || 0;
    const discountType = discountTypeSelect.value;
    
    if (discountType === 'percent') {
      discountAmount = (subtotal * discountValue) / 100;
    } else {
      discountAmount = discountValue;
    }
  }
  
  // Get tax
  const taxSelect = document.getElementById('invoiceTaxRate');
  let taxRate = 0;
  if (taxSelect) {
    taxRate = parseFloat(taxSelect.value) || 0;
  }
  
  const afterDiscount = subtotal - discountAmount;
  const tax = (afterDiscount * taxRate) / 100;
  const grandTotal = afterDiscount + tax;
  
  // Get notes and terms
  const notes = document.getElementById('invoiceNotes')?.value || '';
  const terms = document.getElementById('invoiceTerms')?.value || '';
  
  // Build items HTML
  let itemsHTML = '';
  if (items.length > 0) {
    items.forEach((item, index) => {
      itemsHTML += `
        <tr>
          <td style="text-align: center">${index + 1}</td>
          <td>${escapeHtml(item.name)}</td>
          <td style="text-align: center">${item.quantity}</td>
          <td style="text-align: right">‚Çπ${item.rate.toFixed(2)}</td>
          <td style="text-align: right">‚Çπ${item.amount.toFixed(2)}</td>
        </tr>
      `;
    });
  } else {
    itemsHTML = `<tr><td colspan="5" style="text-align: center; color: #999; padding: 20px;">No items added to invoice</td></tr>`;
  }
  
  // Generate HTML
  const invoiceHTML = `
    <!DOCTYPE html>
    <html>
    <head>
      <title>Invoice ${invoiceNumber}</title>
      <style>
        body { 
          font-family: Arial, sans-serif; 
          padding: 40px; 
          background: #f5f5f5;
          margin: 0;
        }
        .invoice-container {
          background: white;
          max-width: 900px;
          margin: 0 auto;
          padding: 30px;
          border-radius: 8px;
          box-shadow: 0 2 8px rgba(0,0,0,0.1);
        }
        .invoice-header { 
          text-align: center; 
          margin-bottom: 30px;
          border-bottom: 2px solid #007bff;
          padding-bottom: 20px;
        }
        .invoice-header h1 { margin: 0; color: #333; font-size: 32px; }
        .invoice-header h3 { margin: 5px 0 0 0; color: #666; font-size: 16px; }
        .invoice-details { 
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 30px;
          margin-bottom: 30px;
          padding-bottom: 20px;
          border-bottom: 1px solid #ddd;
        }
        .detail-group p {
          margin: 8px 0;
          font-size: 14px;
          line-height: 1.6;
        }
        .detail-group strong {
          color: #333;
          font-weight: 600;
        }
        table { 
          width: 100%; 
          border-collapse: collapse; 
          margin-bottom: 20px; 
        }
        th, td { 
          border: 1px solid #ddd; 
          padding: 12px; 
          font-size: 14px;
          text-align: left;
        }
        th { 
          background-color: #007bff;
          color: white;
          font-weight: bold;
        }
        tbody tr:nth-child(even) { background-color: #f9f9f9; }
        .totals-table {
          width: 450px;
          margin-left: auto;
          margin-bottom: 30px;
          border-collapse: collapse;
        }
        .totals-table td {
          border: 1px solid #ddd;
          padding: 12px;
          font-size: 14px;
        }
        .totals-table .label {
          font-weight: 600;
          color: #333;
          width: 70%;
        }
        .totals-table .amount {
          text-align: right;
          width: 30%;
          font-weight: 600;
          color: #333;
        }
        .totals-table .total-row {
          background-color: #d4edda;
          font-weight: bold;
          font-size: 16px;
        }
        .notes-section {
          margin-top: 30px;
          padding: 15px;
          border-top: 1px solid #ddd;
          font-size: 13px;
          color: #555;
        }
        .notes-section h4 {
          margin: 0 0 10px 0;
          color: #333;
          font-size: 14px;
          font-weight: 600;
        }
        .notes-section p {
          margin: 0;
          line-height: 1.5;
        }
        .terms-section {
          margin-top: 20px;
          font-size: 12px;
          color: #666;
          white-space: pre-wrap;
          background: #f9f9f9;
          padding: 15px;
          border-radius: 4px;
          border-left: 3px solid #007bff;
        }
        .terms-section strong {
          color: #333;
          display: block;
          margin-bottom: 10px;
          font-size: 13px;
        }
        .print-button {
          margin-top: 30px;
          text-align: center;
          padding-top: 20px;
          border-top: 1px solid #ddd;
        }
        .print-button button {
          padding: 12px 30px;
          font-size: 14px;
          background: #28a745;
          color: white;
          border: none;
          border-radius: 4px;
          cursor: pointer;
          margin-right: 10px;
          font-weight: 600;
          transition: background 0.2s;
        }
        .print-button button:hover {
          background: #218838;
        }
        .print-button button.close-btn {
          background: #6c757d;
        }
        .print-button button.close-btn:hover {
          background: #5a6268;
        }
        @media print {
          body { background: white; padding: 0; }
          .invoice-container { box-shadow: none; }
          .print-button { display: none; }
          .invoice-details { border-bottom: 1px solid #000; }
        }
      </style>
    </head>
    <body>
      <div class="invoice-container">
        <div class="invoice-header">
          <h1>INVOICE</h1>
          <h3>Tile & Sanitaryware Inventory</h3>
        </div>
        
        <div class="invoice-details">
          <div class="detail-group">
            <p><strong>Invoice Number:</strong> ${invoiceNumber}</p>
            <p><strong>Invoice Date:</strong> ${new Date(invoiceDate).toLocaleDateString('en-IN')}</p>
            <p><strong>Payment Terms:</strong> ${paymentTerms}</p>
          </div>
          <div class="detail-group">
            <p><strong>Customer Name:</strong> ${escapeHtml(customerName)}</p>
            <p><strong>Due Date:</strong> ${new Date(dueDate).toLocaleDateString('en-IN')}</p>
          </div>
        </div>
        
        <table>
          <thead>
            <tr>
              <th style="width: 50px; text-align: center">#</th>
              <th>Item Description</th>
              <th style="width: 100px; text-align: center">Quantity</th>
              <th style="width: 120px; text-align: right">Rate</th>
              <th style="width: 120px; text-align: right">Amount</th>
            </tr>
          </thead>
          <tbody>
            ${itemsHTML}
          </tbody>
        </table>
        
        <table class="totals-table">
          <tr>
            <td class="label">Sub Total:</td>
            <td class="amount">‚Çπ${subtotal.toFixed(2)}</td>
          </tr>
          <tr>
            <td class="label">Discount:</td>
            <td class="amount">-‚Çπ${discountAmount.toFixed(2)}</td>
          </tr>
          <tr>
            <td class="label">Tax (${taxRate}%):</td>
            <td class="amount">‚Çπ${tax.toFixed(2)}</td>
          </tr>
          <tr class="total-row">
            <td class="label">Grand Total:</td>
            <td class="amount">‚Çπ${grandTotal.toFixed(2)}</td>
          </tr>
        </table>
        
        ${notes ? `
        <div class="notes-section">
          <h4>Customer Notes</h4>
          <p>${escapeHtml(notes)}</p>
        </div>
        ` : ''}
        
        ${terms ? `
        <div class="terms-section">
          <strong>Terms & Conditions:</strong>
          ${escapeHtml(terms)}
        </div>
        ` : ''}
        
        <div class="print-button">
          <button onclick="window.print()">üñ®Ô∏è Print Invoice</button>
          <button class="close-btn" onclick="window.close()">‚úï Close</button>
        </div>
      </div>
    </body>
    </html>
  `;
  
  // Open preview
  const previewWindow = window.open('', 'invoicePreview', 'width=950,height=1100');
  if (previewWindow) {
    previewWindow.document.write(invoiceHTML);
    previewWindow.document.close();
    console.log('‚úÖ Preview opened with', items.length, 'items');
  } else {
    alert('‚ùå Preview window blocked. Please allow pop-ups.');
  }
}


 


/**
 * ==========================================
 * VIEW SAVED INVOICES 
 * ==========================================
 */

/**
 * ‚úÖ UPDATED: View Invoices (with cloud sync)
 */
async function viewSavedInvoices() {
  console.log('üìÑ Opening saved invoices...');
  
  // Show loading modal
  const loadingModal = `
    <div class="modal fade" id="invoiceListModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static">
      <div class="modal-dialog modal-fullscreen-md-down modal-xl">
        <div class="modal-content">
          <div class="modal-header" style="background: #007bff; color: white;">
            <h5 class="modal-title">üìÑ Saved Invoices</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="invoiceListContent" style="min-height: 400px;">
            <div style="text-align: center; padding: 60px 20px;">
              <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
              <p style="margin-top: 20px; color: #666; font-size: 16px;">Loading invoices from cloud...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
  
  // Remove existing modal
  const existing = document.getElementById('invoiceListModal');
  if (existing) existing.remove();
  
  // Add modal
  document.body.insertAdjacentHTML('beforeend', loadingModal);
  
  // Show modal
  const modal = new bootstrap.Modal(document.getElementById('invoiceListModal'));
  modal.show();
  
  // Load invoices from cloud + localStorage
  try {
    const invoices = await loadCustomerInvoices();
    displayInvoiceList(invoices);
  } catch (error) {
    console.error('‚ùå Error loading invoices:', error);
    document.getElementById('invoiceListContent').innerHTML = `
      <div style="text-align: center; padding: 40px; color: #dc3545;">
        <i class="bi bi-exclamation-triangle" style="font-size: 48px;"></i>
        <p style="margin-top: 15px;">Failed to load invoices</p>
        <p style="font-size: 14px; color: #666;">${error.message}</p>
      </div>
    `;
  }
  
  // Cleanup on close
  document.getElementById('invoiceListModal').addEventListener('hidden.bs.modal', function() {
    this.remove();
  });
}

/**
 * ‚úÖ Display invoice list in modal
 */
/**
 * ‚úÖ FIXED: Display invoice list in modal
 * Uses invoiceNumber instead of index to avoid sort conflicts
 */
function displayInvoiceList(invoices) {
  const container = document.getElementById('invoiceListContent');
  
  if (!invoices || invoices.length === 0) {
    container.innerHTML = `
      <div style="text-align: center; padding: 60px 20px; color: #999;">
        <i class="bi bi-inbox" style="font-size: 64px;"></i>
        <p style="margin-top: 20px; font-size: 18px;">No invoices found</p>
        <p style="font-size: 14px;">Create your first invoice to get started</p>
      </div>
    `;
    return;
  }
  
  // Sort by date (newest first)
  invoices.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  
  let html = '<div class="table-responsive"><table class="table table-hover table-bordered">';
  html += '<thead style="background: #f8f9fa;"><tr>';
  html += '<th>Invoice #</th>';
  html += '<th>Customer</th>';
  html += '<th>Date</th>';
  html += '<th>Total</th>';
  html += '<th style="width: 150px; text-align: center;">Actions</th>';
  html += '</tr></thead><tbody>';
  
  invoices.forEach((invoice) => {
    const invoiceDate = new Date(invoice.invoiceDate).toLocaleDateString('en-IN');
    const total = parseFloat(invoice.total || 0).toFixed(2);
    
    html += '<tr>';
    html += `<td><strong>${escapeHtml(invoice.invoiceNumber)}</strong></td>`;
    html += `<td>${escapeHtml(invoice.customerName)}</td>`;
    html += `<td>${invoiceDate}</td>`;
    html += `<td><strong>‚Çπ${total}</strong></td>`;
    html += `<td style="text-align: center;">
      <button class="btn btn-sm btn-primary" onclick="previewSavedInvoice('${invoice.invoiceNumber}')" title="View Invoice">
        <i class="bi bi-eye"></i>
      </button>
      <button class="btn btn-sm btn-danger" onclick="deleteSavedInvoice('${invoice.invoiceNumber}')" title="Delete Invoice">
        <i class="bi bi-trash"></i>
      </button>
    </td>`;
    html += '</tr>';
  });
  
  html += '</tbody></table></div>';
  html += `<div style="padding: 15px; background: #f8f9fa; border-top: 1px solid #dee2e6; margin-top: 20px;">
    <p style="margin: 0; font-size: 14px; color: #666;">
      <i class="bi bi-info-circle"></i> Total Invoices: <strong>${invoices.length}</strong>
    </p>
  </div>`;
  
  container.innerHTML = html;
  console.log(`‚úÖ Displayed ${invoices.length} invoices`);
}


/**
 * Initialize invoice list when View Invoices page loads
 */
async function initInvoiceListPage() {
  console.log('üìÑ Initializing invoice list page...');
  
  // Show loading
  const invoiceListContainer = document.getElementById('invoiceListContainer');
  if (invoiceListContainer) {
    invoiceListContainer.innerHTML = `
      <div style="text-align: center; padding: 40px;">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p style="margin-top: 15px; color: #666;">Loading invoices...</p>
      </div>
    `;
  }
  
  // Load invoices from cloud + localStorage
  const invoices = await loadCustomerInvoices();
  
  // Display invoices
  displayCustomerInvoiceList(invoices);
}

/**
 * Display customer invoice list
 */
function displayCustomerInvoiceList(invoices) {
  const container = document.getElementById('invoiceListContainer');
  
  if (!container) {
    console.error('‚ùå Invoice list container not found');
    return;
  }
  
  if (!invoices || invoices.length === 0) {
    container.innerHTML = `
      <div style="text-align: center; padding: 40px; color: #999;">
        <i class="bi bi-inbox" style="font-size: 48px;"></i>
        <p style="margin-top: 15px;">No invoices found</p>
      </div>
    `;
    return;
  }
  
  // Sort by date (newest first)
  invoices.sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
  
  let html = '<div class="table-responsive"><table class="table table-hover">';
  html += '<thead><tr>';
  html += '<th>Invoice #</th>';
  html += '<th>Customer</th>';
  html += '<th>Date</th>';
  html += '<th>Total</th>';
  html += '<th>Actions</th>';
  html += '</tr></thead><tbody>';
  
  invoices.forEach(invoice => {
    const invoiceDate = new Date(invoice.invoiceDate).toLocaleDateString('en-IN');
    const total = parseFloat(invoice.total || 0).toFixed(2);
    
    html += '<tr>';
    html += `<td><strong>${invoice.invoiceNumber}</strong></td>`;
    html += `<td>${invoice.customerName}</td>`;
    html += `<td>${invoiceDate}</td>`;
    html += `<td>‚Çπ${total}</td>`;
    html += `<td>
      <button class="btn btn-sm btn-primary" onclick="viewInvoicePreview('${invoice.invoiceNumber}')">
        <i class="bi bi-eye"></i> View
      </button>
      <button class="btn btn-sm btn-danger" onclick="deleteCustomerInvoice('${invoice.invoiceNumber}')">
        <i class="bi bi-trash"></i>
      </button>
    </td>`;
    html += '</tr>';
  });
  
  html += '</tbody></table></div>';
  container.innerHTML = html;
  
  console.log(`‚úÖ Displayed ${invoices.length} invoices`);
}


/**
 * ‚úÖ FIXED: Preview saved invoice by invoiceNumber (not index)
 * Works correctly with sorted lists
 */
function previewSavedInvoice(invoiceNumber) {
  console.log('üëÅÔ∏è Previewing invoice:', invoiceNumber);
  
  try {
    // Get invoice from localStorage
    const invoices = JSON.parse(localStorage.getItem('customerInvoices') || '[]');
    
    // ‚úÖ FIX: Find invoice by invoiceNumber (not by index)
    const inv = invoices.find(invoice => invoice.invoiceNumber === invoiceNumber);
    
    if (!inv) {
      alert('‚ùå Invoice not found: ' + invoiceNumber);
      console.error('‚ùå Invoice not found:', invoiceNumber);
      return;
    }
    
    console.log('üìÑ Invoice data:', inv);
    
    // Detect mobile
    const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent) || window.innerWidth < 768;
    
    // Close parent modal first
    const parentModal = document.getElementById('invoiceListModal');
    if (parentModal) {
      const bsModal = bootstrap.Modal.getInstance(parentModal);
      if (bsModal) {
        bsModal.hide();
      }
    }
    
    // Wait for modal to close, then show preview
    setTimeout(() => {
      if (isMobile) {
        showInvoiceModal(inv);
      } else {
        showInvoiceWindow(inv);
      }
    }, 300);
    
  } catch (error) {
    console.error('‚ùå Error:', error);
    alert('‚ùå Error: ' + error.message);
  }
}

/**
 * ‚úÖ Show invoice in modal (mobile-optimized)
 */
function showInvoiceModal(inv) {
  const invoiceHTML = generateInvoiceHTML(inv);
  
  const modalHTML = `
    <div class="modal fade" id="invoicePreviewModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
      <div class="modal-dialog modal-fullscreen">
        <div class="modal-content">
          <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; position: sticky; top: 0; z-index: 1000;">
            <h5 class="modal-title">
              <i class="bi bi-file-earmark-text"></i> 
              Invoice ${escapeHtml(inv.invoiceNumber)}
            </h5>
            <button type="button" class="btn-close btn-close-white" onclick="closeInvoicePreview()"></button>
          </div>
          <div class="modal-body" style="padding: 0; background: #f5f5f5; overflow-y: auto;">
            ${invoiceHTML}
          </div>
          <div class="modal-footer" style="position: sticky; bottom: 0; background: white; border-top: 2px solid #dee2e6; z-index: 999;">
            <button type="button" class="btn btn-secondary" onclick="closeInvoicePreview()">
              <i class="bi bi-arrow-left"></i> Back
            </button>
            <button type="button" class="btn btn-success" onclick="printInvoiceFromModal('${inv.invoiceNumber}')">
              <i class="bi bi-printer"></i> Print
            </button>
          </div>
        </div>
      </div>
    </div>
  `;
  
  // Remove existing modals
  document.querySelectorAll('#invoicePreviewModal').forEach(el => el.remove());
  
  // Add new modal
  document.body.insertAdjacentHTML('beforeend', modalHTML);
  
  // Show modal with a slight delay
  setTimeout(() => {
    const modal = new bootstrap.Modal(document.getElementById('invoicePreviewModal'), {
      backdrop: 'static',
      keyboard: false
    });
    modal.show();
    console.log('‚úÖ Invoice modal opened');
  }, 100);
}

/**
 * ‚úÖ Close invoice preview and reopen invoice list
 */
function closeInvoicePreview() {
  const previewModal = document.getElementById('invoicePreviewModal');
  if (previewModal) {
    const bsModal = bootstrap.Modal.getInstance(previewModal);
    if (bsModal) {
      bsModal.hide();
    }
    
    // Remove modal after animation
    setTimeout(() => {
      previewModal.remove();
      
      // Reopen invoice list
      viewSavedInvoices();
    }, 300);
  }
}

/**
 * ‚úÖ Show invoice in window (for laptop)
 */
function showInvoiceWindow(inv) {
  const invoiceHTML = generateInvoiceHTML(inv);
  
  const fullHTML = `
    <!DOCTYPE html>
    <html>
    <head>
      <title>Invoice ${escapeHtml(inv.invoiceNumber)}</title>
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <style>
        body { 
          font-family: Arial, sans-serif; 
          margin: 0; 
          padding: 0;
          background: #f5f5f5;
        }
        .print-buttons {
          text-align: center;
          padding: 20px;
          background: white;
          border-top: 2px solid #dee2e6;
          position: sticky;
          bottom: 0;
          box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
        }
        .print-buttons button {
          padding: 12px 30px;
          font-size: 14px;
          font-weight: 600;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          margin: 0 5px;
          transition: all 0.2s;
        }
        .print-btn {
          background: #28a745;
          color: white;
        }
        .print-btn:hover {
          background: #218838;
          transform: translateY(-2px);
          box-shadow: 0 4px 8px rgba(40,167,69,0.3);
        }
        .close-btn {
          background: #6c757d;
          color: white;
        }
        .close-btn:hover {
          background: #5a6268;
          transform: translateY(-2px);
          box-shadow: 0 4px 8px rgba(108,117,125,0.3);
        }
        @media print {
          body { background: white; }
          .print-buttons { display: none; }
        }
      </style>
    </head>
    <body>
      ${invoiceHTML}
      <div class="print-buttons">
        <button class="print-btn" onclick="window.print()">
          <i class="bi bi-printer"></i> üñ®Ô∏è Print Invoice
        </button>
        <button class="close-btn" onclick="window.close()">
          ‚úï Close Window
        </button>
      </div>
    </body>
    </html>
  `;
  
  const win = window.open('', 'InvoicePreview', 'width=950,height=1100,scrollbars=yes');
  if (win) {
    win.document.write(fullHTML);
    win.document.close();
    console.log('‚úÖ Invoice window opened');
  } else {
    alert('‚ùå Pop-up blocked. Please allow pop-ups and try again.');
  }
}


/**
 * ‚úÖ Generate invoice HTML (mobile responsive)
 */
function generateInvoiceHTML(inv) {
  // Build items table
  let itemsHTML = '';
  if (inv.items && inv.items.length > 0) {
    inv.items.forEach((item, idx) => {
      itemsHTML += `
        <tr>
          <td style="text-align: center; font-weight: 600; color: #666;">${idx + 1}</td>
          <td style="font-weight: 500;">${escapeHtml(item.name)}</td>
          <td style="text-align: center; font-weight: 600;">${item.quantity}</td>
          <td style="text-align: right; color: #28a745; font-weight: 600;">‚Çπ${parseFloat(item.rate || 0).toFixed(2)}</td>
          <td style="text-align: right; color: #007bff; font-weight: 700;">‚Çπ${parseFloat(item.amount || 0).toFixed(2)}</td>
        </tr>
      `;
    });
  } else {
    itemsHTML = `<tr><td colspan="5" style="text-align: center; color: #999; padding: 30px;">No items</td></tr>`;
  }
  
  const subtotal = parseFloat(inv.subtotal || 0);
  const discount = parseFloat(inv.discount || 0);
  const tax = parseFloat(inv.tax || 0);
  const total = parseFloat(inv.total || 0);
  
  return `
    <style>
      .invoice-container {
        background: white;
        max-width: 900px;
        margin: 0 auto;
        padding: 30px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      }
      .invoice-header {
        text-align: center;
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 3px solid #667eea;
        background: linear-gradient(135deg, #667eea22 0%, #764ba222 100%);
        padding: 20px;
        border-radius: 8px;
      }
      .invoice-header h1 {
        margin: 0;
        color: #667eea;
        font-size: 36px;
        font-weight: 800;
        letter-spacing: 2px;
      }
      .invoice-header h3 {
        margin: 8px 0 0 0;
        color: #666;
        font-size: 16px;
        font-weight: 400;
      }
      .invoice-details {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 20px;
        margin-bottom: 30px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 8px;
      }
      .detail-group p {
        margin: 10px 0;
        font-size: 14px;
        line-height: 1.8;
      }
      .detail-group strong {
        color: #333;
        font-weight: 700;
      }
      table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      }
      th, td {
        border: 1px solid #dee2e6;
        padding: 14px;
        font-size: 14px;
      }
      th {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }
      tbody tr:nth-child(even) {
        background-color: #f8f9fa;
      }
      tbody tr:hover {
        background-color: #e9ecef;
      }
      .totals-table {
        width: 100%;
        max-width: 450px;
        margin-left: auto;
        margin-bottom: 30px;
        border: 2px solid #dee2e6;
        border-radius: 8px;
        overflow: hidden;
      }
      .totals-table td {
        padding: 14px;
        font-size: 15px;
        border: none;
        border-bottom: 1px solid #dee2e6;
      }
      .totals-table tr:last-child td {
        border-bottom: none;
      }
      .totals-table .label {
        font-weight: 600;
        color: #495057;
      }
      .totals-table .amount {
        text-align: right;
        font-weight: 700;
        color: #212529;
      }
      .totals-table .total-row {
        background: linear-gradient(135deg, #667eea22 0%, #764ba222 100%);
        font-size: 18px;
      }
      .totals-table .total-row .amount {
        color: #667eea;
        font-size: 20px;
      }
      .notes-section {
        margin-top: 30px;
        padding: 20px;
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        border-radius: 4px;
      }
      .notes-section h4 {
        margin: 0 0 10px 0;
        color: #856404;
        font-size: 16px;
      }
      .terms-section {
        margin-top: 20px;
        padding: 20px;
        background: #d4edda;
        border-left: 4px solid #28a745;
        border-radius: 4px;
        font-size: 13px;
        color: #155724;
      }
      .terms-section strong {
        display: block;
        margin-bottom: 10px;
        font-size: 15px;
        color: #155724;
      }
      
      /* Mobile Responsive */
      @media (max-width: 768px) {
        .invoice-container {
          padding: 15px;
        }
        .invoice-header h1 {
          font-size: 28px;
        }
        .invoice-details {
          grid-template-columns: 1fr;
          gap: 10px;
          padding: 15px;
        }
        .detail-group p {
          font-size: 13px;
          margin: 8px 0;
        }
        table {
          font-size: 12px;
        }
        th, td {
          padding: 10px 8px;
        }
        .totals-table {
          width: 100%;
        }
        .totals-table td {
          padding: 12px;
          font-size: 14px;
        }
        .notes-section, .terms-section {
          padding: 15px;
          font-size: 12px;
        }
      }
      
      @media print {
        body {
          background: white;
        }
        .invoice-container {
          box-shadow: none;
          padding: 20px;
        }
      }
    </style>
    
    <div class="invoice-container">
      <div class="invoice-header">
        <h1>INVOICE</h1>
        <h3>Tile & Sanitaryware Inventory</h3>
      </div>
      
      <div class="invoice-details">
        <div class="detail-group">
          <p><strong>Invoice #:</strong> ${escapeHtml(inv.invoiceNumber)}</p>
          <p><strong>Invoice Date:</strong> ${new Date(inv.invoiceDate).toLocaleDateString('en-IN')}</p>
          <p><strong>Created:</strong> ${new Date(inv.createdAt).toLocaleDateString('en-IN')}</p>
        </div>
        <div class="detail-group">
          <p><strong>Customer:</strong> ${escapeHtml(inv.customerName)}</p>
          <p><strong>Due Date:</strong> ${new Date(inv.dueDate).toLocaleDateString('en-IN')}</p>
        </div>
      </div>
      
      <table>
        <thead>
          <tr>
            <th style="width: 40px; text-align: center">#</th>
            <th>Description</th>
            <th style="width: 80px; text-align: center">Qty</th>
            <th style="width: 100px; text-align: right">Rate</th>
            <th style="width: 120px; text-align: right">Amount</th>
          </tr>
        </thead>
        <tbody>
          ${itemsHTML}
        </tbody>
      </table>
      
      <table class="totals-table">
        <tr>
          <td class="label">Sub Total:</td>
          <td class="amount">‚Çπ${subtotal.toFixed(2)}</td>
        </tr>
        <tr>
          <td class="label">Discount:</td>
          <td class="amount">-‚Çπ${discount.toFixed(2)}</td>
        </tr>
        <tr>
          <td class="label">Tax (GST):</td>
          <td class="amount">‚Çπ${tax.toFixed(2)}</td>
        </tr>
        <tr class="total-row">
          <td class="label">GRAND TOTAL:</td>
          <td class="amount">‚Çπ${total.toFixed(2)}</td>
        </tr>
      </table>
      
      ${inv.notes ? `
      <div class="notes-section">
        <h4>üìù Notes</h4>
        <p style="margin: 0; line-height: 1.6;">${escapeHtml(inv.notes)}</p>
      </div>
      ` : ''}
      
      ${inv.terms ? `
      <div class="terms-section">
        <strong>üìú Terms & Conditions</strong>
        <div style="white-space: pre-wrap; line-height: 1.6;">${escapeHtml(inv.terms)}</div>
      </div>
      ` : ''}
    </div>
  `;
}

    


/**
 * Load customer invoices from Firestore
 * ‚úÖ FIREBASE VERSION
 */
async function loadCustomerInvoices() {
  console.log('‚òÅÔ∏è Loading customer invoices from Firestore...');
  
  const user = window.auth.currentUser;
  
  if (!user) {
    console.log('No user authenticated, loading from localStorage only');
    const localInvoices = JSON.parse(localStorage.getItem('customerInvoices') || '[]');
    return localInvoices;
  }
  
  try {
    const { collection, getDocs, query, orderBy } = window.firebaseImports;
    
    const invoicesRef = collection(window.db, 'tenants', user.uid, 'invoices');
    const q = query(invoicesRef, orderBy('createdAt', 'desc'));
    const snapshot = await getDocs(q);
    
    const cloudInvoices = [];
    snapshot.forEach((doc) => {
      cloudInvoices.push({
        id: doc.id,
        ...doc.data()
      });
    });
    
    console.log(`‚úÖ Loaded ${cloudInvoices.length} invoices from Firestore`);
    
    // Merge with localStorage invoices
    const localInvoices = JSON.parse(localStorage.getItem('customerInvoices') || '[]');
    const invoiceMap = new Map();
    
    // Cloud invoices first (source of truth)
    cloudInvoices.forEach(inv => {
      invoiceMap.set(inv.invoiceNumber, inv);
    });
    
    // Add local invoices not in cloud
    localInvoices.forEach(inv => {
      if (!invoiceMap.has(inv.invoiceNumber)) {
        invoiceMap.set(inv.invoiceNumber, inv);
      }
    });
    
    const mergedInvoices = Array.from(invoiceMap.values());
    
    // Save merged data to localStorage
    localStorage.setItem('customerInvoices', JSON.stringify(mergedInvoices));
    
    console.log(`‚úÖ Total invoices: ${mergedInvoices.length} (${cloudInvoices.length} from cloud + ${localInvoices.length} local)`);
    
    // Store in global variable
    window.cachedInvoices = mergedInvoices;
    
    return mergedInvoices;
    
  } catch (error) {
    console.error('‚ùå Error loading invoices from Firestore:', error.message);
    
    // Fallback to localStorage
    const localInvoices = JSON.parse(localStorage.getItem('customerInvoices') || '[]');
    console.log(`‚ö†Ô∏è Cloud load failed, using ${localInvoices.length} local invoices`);
    
    return localInvoices;
  }
}


  

/**
 * Delete invoice from localStorage and Firestore
 * ‚úÖ FIREBASE VERSION
 */
async function deleteSavedInvoice(invoiceNumber) {
  console.log('üóëÔ∏è Deleting invoice:', invoiceNumber);
  
  if (!confirm(`Are you sure you want to delete invoice ${invoiceNumber}?\n\nThis action cannot be undone.`)) {
    return;
  }
  
  const user = window.auth.currentUser;
  
  try {
    // Get invoices from localStorage
    let invoices = JSON.parse(localStorage.getItem('customerInvoices') || '[]');
    
    // Find invoice by invoiceNumber
    const invoiceIndex = invoices.findIndex(inv => inv.invoiceNumber === invoiceNumber);
    
    if (invoiceIndex === -1) {
      alert('‚ùå Invoice not found: ' + invoiceNumber);
      return;
    }
    
    // Remove from array
    invoices.splice(invoiceIndex, 1);
    
    // Save back to localStorage
    localStorage.setItem('customerInvoices', JSON.stringify(invoices));
    console.log('‚úÖ Deleted from localStorage');
    
    // Delete from Firestore
    if (user) {
      try {
        const { collection, query, where, getDocs, deleteDoc, doc } = window.firebaseImports;
        
        const invoicesRef = collection(window.db, 'tenants', user.uid, 'invoices');
        const q = query(invoicesRef, where('invoiceNumber', '==', invoiceNumber));
        const snapshot = await getDocs(q);
        
        if (!snapshot.empty) {
          // Delete all matching invoices (should be only one)
          const deletePromises = [];
          snapshot.forEach((docSnapshot) => {
            const docRef = doc(window.db, 'tenants', user.uid, 'invoices', docSnapshot.id);
            deletePromises.push(deleteDoc(docRef));
          });
          
          await Promise.all(deletePromises);
          console.log('‚úÖ Deleted from Firestore');
        } else {
          console.warn('‚ö†Ô∏è Invoice not found in Firestore');
        }
        
      } catch (firebaseError) {
        console.error('‚ùå Failed to delete from Firestore:', firebaseError);
        alert(`‚ö†Ô∏è Invoice deleted locally but cloud deletion failed.\n\n${firebaseError.message}`);
      }
    } else {
      console.log('No user authenticated, skipped cloud deletion');
    }
    
    alert(`‚úÖ Invoice ${invoiceNumber} deleted successfully`);
    
    // Refresh the list
    viewSavedInvoices();
    
  } catch (error) {
    console.error('‚ùå Delete error:', error);
    alert('‚ùå Error deleting invoice: ' + error.message);
  }
}


// ==========================================
// SHARE INVOICE FEATURE
// ==========================================

// Share Invoice as Image (Primary Method)
async function shareInvoiceAsImage() {
  // Validate customer name
  const customerName = document.getElementById('invoiceCustomerName').value.trim();
  if (!customerName) {
    alert('√¢¬ù≈í Please enter customer name before sharing');
    return;
  }
  
  showLoading('Generating image...');
  
  try {
    // Get invoice data
    const invoiceData = collectInvoiceData();
    
    // Generate invoice HTML in hidden container
    const tempContainer = document.createElement('div');
    tempContainer.style.cssText = 'position:absolute;left:-9999px;top:0;background:white;width:800px;padding:40px;';
    tempContainer.innerHTML = generateInvoiceHTMLForImage(invoiceData);
    document.body.appendChild(tempContainer);
    
    // Wait for fonts to load
    await document.fonts.ready;
    
    // Convert to canvas
    const canvas = await html2canvas(tempContainer, {
      backgroundColor: '#ffffff',
      scale: 2,
      logging: false,
      windowWidth: 800,
      windowHeight: tempContainer.scrollHeight
    });
    
    // Remove temp container
    document.body.removeChild(tempContainer);
    
    hideLoading();
    
    // Convert canvas to blob
    canvas.toBlob(async (blob) => {
      const fileName = `Invoice_${invoiceData.invoiceNumber}_${invoiceData.customerName.replace(/\s+/g, '_')}.png`;
      const file = new File([blob], fileName, { type: 'image/png' });
      
      // Try Web Share API (mobile & modern browsers)
      if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
        try {
          await navigator.share({
            title: `Invoice ${invoiceData.invoiceNumber}`,
            text: `Invoice for ${invoiceData.customerName} - ‚Çπ${invoiceData.total.toFixed(2)}`,
            files: [file]
          });
          console.log('√¢≈ì‚Ä¶ Invoice shared successfully');
        } catch (err) {
          if (err.name !== 'AbortError') {
            console.error('Share failed:', err);
            fallbackDownloadImage(canvas, fileName);
          }
        }
      } else {
        // Fallback: Download image
        fallbackDownloadImage(canvas, fileName);
      }
    }, 'image/png', 0.95);
    
  } catch (error) {
    hideLoading();
    console.error('Error generating image:', error);
    alert('√¢¬ù≈í Error generating invoice image. Please try again.');
  }
}

/**
 * ==========================================
 * √¢≈ì‚Ä¶ NEW: Share Invoice Image on WhatsApp Number
 * ==========================================
 */

// Open WhatsApp number input modal
function shareImageToWhatsAppNumber() {
  // Validate customer name first
  const customerName = document.getElementById('invoiceCustomerName').value.trim();
  if (!customerName) {
    alert('√¢¬ù≈í Please enter customer name before sharing');
    return;
  }
  
  // Load saved number if exists
  const savedNumber = localStorage.getItem('whatsappNumber');
  if (savedNumber) {
    document.getElementById('whatsappNumberInput').value = savedNumber;
    document.getElementById('saveWhatsAppNumber').checked = true;
  }
  
  // Show modal
  const modal = new bootstrap.Modal(document.getElementById('whatsappNumberModal'));
  modal.show();
  
  // Focus input after modal opens
  setTimeout(() => {
    document.getElementById('whatsappNumberInput').focus();
  }, 500);
}

// Send invoice image to specific WhatsApp number (FINAL FIX - NO STRING ESCAPING ISSUES)
async function sendInvoiceToWhatsApp() {
  const numberInput = document.getElementById('whatsappNumberInput');
  const phoneNumber = numberInput.value.trim();
  
  // Validation
  if (!phoneNumber) {
    alert('‚ùå Please enter WhatsApp number');
    numberInput.focus();
    return;
  }
  
  if (!/^[0-9]{10}$/.test(phoneNumber)) {
    alert('‚ùå Please enter a valid 10-digit mobile number');
    numberInput.focus();
    return;
  }
  
  // Save number if checkbox checked
  if (document.getElementById('saveWhatsAppNumber').checked) {
    localStorage.setItem('whatsappNumber', phoneNumber);
  }
  
  // Close number input modal
  const numberModal = bootstrap.Modal.getInstance(document.getElementById('whatsappNumberModal'));
  if (numberModal) {
    numberModal.hide();
  }
  
  // Detect iOS
  const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
  
  // Show loading
  showLoading('Preparing invoice for WhatsApp...');
  
  try {
    // Get invoice data
    const invoiceData = collectInvoiceData();
    
    // Generate invoice HTML
    const tempContainer = document.createElement('div');
    tempContainer.style.cssText = 'position:absolute;left:-9999px;top:0;background:white;width:800px;padding:40px;';
    tempContainer.innerHTML = generateInvoiceHTMLForImage(invoiceData);
    document.body.appendChild(tempContainer);
    
    await document.fonts.ready;
    
    // Convert to canvas
    const canvas = await html2canvas(tempContainer, {
      backgroundColor: '#ffffff',
      scale: 2,
      logging: false,
      windowWidth: 800,
      windowHeight: tempContainer.scrollHeight
    });
    
    document.body.removeChild(tempContainer);
    
    hideLoading();
    
    // Full phone number with country code
    const fullNumber = '91' + phoneNumber;
    
    // Convert canvas to blob
    canvas.toBlob(async (blob) => {
      const fileName = 'Invoice_' + invoiceData.invoiceNumber + '_' + invoiceData.customerName.replace(/\s+/g, '_') + '.png';
      
      // iOS FIX: Different handling for iPhone
      if (isIOS) {
        // Step 1: Show the image in a new window for user to save manually
        const imageUrl = canvas.toDataURL('image/png');
        const newWindow = window.open('', '_blank');
        
        if (newWindow) {
          // ‚úÖ FINAL FIX: Build HTML using DOM methods (no string escaping needed!)
          const doc = newWindow.document;
          doc.open();
          doc.write('<!DOCTYPE html><html><head>');
          doc.write('<meta name="viewport" content="width=device-width, initial-scale=1">');
          doc.write('<title>Invoice Image</title>');
          
          // Add styles
          const style = doc.createElement('style');
          style.textContent = 
            'body { margin: 0; padding: 20px; text-align: center; background: #f0f0f0; font-family: Arial, sans-serif; }' +
            'img { max-width: 100%; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); margin-top: 20px; }' +
            '.instructions { background: white; padding: 20px; border-radius: 10px; margin: 20px auto; max-width: 90%; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }' +
            'button { background: #25D366; color: white; border: none; padding: 15px 30px; border-radius: 25px; font-size: 16px; font-weight: bold; margin: 10px; cursor: pointer; }' +
            'ol { text-align: left; line-height: 1.8; }';
          doc.head.appendChild(style);
          doc.write('</head><body>');
          
          // Add instructions
          doc.write('<div class="instructions">');
          doc.write('<h2 style="color: #25D366;">üì± Save & Share Invoice</h2>');
          doc.write('<ol>');
          doc.write('<li><strong>Tap and hold</strong> on the invoice image below</li>');
          doc.write('<li>Select <strong>"Add to Photos"</strong> or <strong>"Save Image"</strong></li>');
          doc.write('<li>Click the <strong>"Open WhatsApp"</strong> button below</li>');
          doc.write('<li>In WhatsApp, tap <strong>üìé</strong> ‚Üí <strong>Gallery</strong> ‚Üí Select invoice ‚Üí Send</li>');
          doc.write('</ol>');
          doc.write('<button id="waBtn">üì± Open WhatsApp Chat</button>');
          doc.write('</div>');
          
          // Add image
          doc.write('<img src="' + imageUrl + '" alt="Invoice">');
          
          doc.write('</body></html>');
          doc.close();
          
          // Add WhatsApp button click handler
          const waBtn = doc.getElementById('waBtn');
          if (waBtn) {
            waBtn.onclick = function() {
              const waUrl = 'whatsapp://send?phone=' + fullNumber + '&text=' + 
                encodeURIComponent('Invoice ' + invoiceData.invoiceNumber + ' - ‚Çπ' + invoiceData.total.toFixed(2));
              newWindow.location.href = waUrl;
            };
          }
          
        } else {
          // Popup blocked - fallback to download
          const link = document.createElement('a');
          link.download = fileName;
          link.href = imageUrl;
          link.click();
          
          // Open WhatsApp after short delay
          setTimeout(function() {
            window.location.href = 'whatsapp://send?phone=' + fullNumber + '&text=' + 
              encodeURIComponent('Invoice ' + invoiceData.invoiceNumber);
          }, 500);
        }
        
      } else {
        // Android/Desktop: Standard download method
        const link = document.createElement('a');
        link.download = fileName;
        link.href = canvas.toDataURL('image/png');
        link.click();
        
        // Show notification
        alert('‚úÖ Invoice downloaded: ' + fileName + '\n\nüì± WhatsApp will open now. Attach the downloaded invoice from Gallery.');
        
        // Open WhatsApp
        setTimeout(function() {
          const message = encodeURIComponent(
            'üìÑ Invoice ' + invoiceData.invoiceNumber + '\n' +
            'Customer: ' + invoiceData.customerName + '\n' +
            'Amount: ‚Çπ' + invoiceData.total.toFixed(2)
          );
          window.location.href = 'whatsapp://send?phone=' + fullNumber + '&text=' + message;
        }, 1000);
      }
      
    }, 'image/png', 0.95);
    
  } catch (error) {
    hideLoading();
    console.error('Error generating invoice image:', error);
    alert('‚ùå Error generating invoice image. Please try again.');
  }
}


// Helper: Detect mobile device
function isMobileDevice() {
  return /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
}

// Helper: Download invoice image
function downloadInvoiceImage(canvas, fileName) {
  const link = document.createElement('a');
  link.download = fileName;
  link.href = canvas.toDataURL('image/png');
  link.click();
}

// Fallback: Download image and open WhatsApp
function fallbackWhatsAppShare(phoneNumber, invoiceData, canvas, fileName) {
  // Download image
  downloadInvoiceImage(canvas, fileName);
  
  // Prepare WhatsApp message
  const message = encodeURIComponent(
    `√∞≈∏‚Äú‚Äû Invoice ${invoiceData.invoiceNumber}\n` +
    `Customer: ${invoiceData.customerName}\n` +
    `Amount: ‚Çπ${invoiceData.total.toFixed(2)}`
  );
  
  // Open WhatsApp with the specific number
  const whatsappUrl = isMobileDevice() 
    ? `whatsapp://send?phone=${phoneNumber}&text=${message}`
    : `https://wa.me/${phoneNumber}?text=${message}`;
  
  if (isMobileDevice()) {
    // Mobile: Open WhatsApp app directly
    window.location.href = whatsappUrl;
    
    setTimeout(() => {
      alert('√∞≈∏‚Äú¬± Steps to send invoice:\n\n1. Tap attach button (√∞≈∏‚Äú≈Ω)\n2. Select "Gallery" or "Photos"\n3. Choose the downloaded invoice\n4. Tap Send √¢≈ì‚Äú\n\nThe invoice image is saved in your downloads/gallery.');
    }, 1000);
  } else {
    // Desktop: Open WhatsApp Web
    window.open(whatsappUrl, '_blank');
    alert('√¢≈ì‚Ä¶ Invoice image downloaded!\n√∞≈∏‚Äú¬± WhatsApp Web opened - please attach the downloaded image and send.');
  }
}


// Fallback: Open WhatsApp Web with message and download image
function fallbackWhatsAppShare(phoneNumber, invoiceData, canvas, fileName) {
  // Download image
  const link = document.createElement('a');
  link.download = fileName;
  link.href = canvas.toDataURL('image/png');
  link.click();
  
  // Open WhatsApp Web with pre-filled message
  const message = encodeURIComponent(
    `√∞≈∏‚Äú‚Äû Invoice ${invoiceData.invoiceNumber}\n` +
    `Customer: ${invoiceData.customerName}\n` +
    `Amount: ‚Çπ${invoiceData.total.toFixed(2)}\n\n` +
    `Invoice image downloaded. Please attach and send.`
  );
  
  const whatsappUrl = `https://wa.me/${phoneNumber}?text=${message}`;
  window.open(whatsappUrl, '_blank');
  
  alert('√¢≈ì‚Ä¶ Invoice image downloaded!\n√∞≈∏‚Äú¬± WhatsApp opened - please attach the downloaded image and send.');
}




    
// Fallback: Download image if share not supported
function fallbackDownloadImage(canvas, fileName) {
  const link = document.createElement('a');
  link.download = fileName;
  link.href = canvas.toDataURL('image/png');
  link.click();
  alert('√¢≈ì‚Ä¶ Invoice image downloaded! You can now share it from your downloads.');
}

// Generate clean invoice HTML for image conversion
function generateInvoiceHTMLForImage(data) {
  let itemsHTML = '';
  data.items.forEach((item, index) => {
    itemsHTML += `
      <tr>
        <td style="text-align:center;padding:8px;border:1px solid #ddd;">${index + 1}</td>
        <td style="padding:8px;border:1px solid #ddd;">${escapeHtml(item.name)}</td>
        <td style="text-align:center;padding:8px;border:1px solid #ddd;">${item.quantity}</td>
        <td style="text-align:right;padding:8px;border:1px solid #ddd;">‚Çπ${item.rate.toFixed(2)}</td>
        <td style="text-align:right;padding:8px;border:1px solid #ddd;">‚Çπ${item.amount.toFixed(2)}</td>
      </tr>
    `;
  });
  
  return `
    <div style="font-family:Arial,sans-serif;padding:20px;max-width:800px;margin:0 auto;">
      <div style="text-align:center;margin-bottom:30px;border-bottom:3px solid #0d6efd;padding-bottom:20px;">
        <h1 style="margin:0;font-size:36px;color:#0d6efd;">INVOICE</h1>
        <h2 style="margin:10px 0;font-size:20px;color:#333;">Tile & Sanitaryware Inventory</h2>
      </div>
      
      <div style="display:flex;justify-content:space-between;margin-bottom:30px;">
        <div style="flex:1;">
          <p style="margin:5px 0;"><strong>Invoice Number:</strong> ${data.invoiceNumber}</p>
          <p style="margin:5px 0;"><strong>Customer Name:</strong> ${escapeHtml(data.customerName)}</p>
        </div>
        <div style="flex:1;text-align:right;">
          <p style="margin:5px 0;"><strong>Invoice Date:</strong> ${new Date(data.invoiceDate).toLocaleDateString('en-IN')}</p>
          <p style="margin:5px 0;"><strong>Due Date:</strong> ${new Date(data.dueDate).toLocaleDateString('en-IN')}</p>
        </div>
      </div>
      
      <table style="width:100%;border-collapse:collapse;margin-bottom:20px;">
        <thead>
          <tr style="background:#f8f9fa;">
            <th style="padding:10px;border:1px solid #ddd;text-align:center;width:50px;">#</th>
            <th style="padding:10px;border:1px solid #ddd;text-align:left;">Item Description</th>
            <th style="padding:10px;border:1px solid #ddd;text-align:center;width:80px;">Quantity</th>
            <th style="padding:10px;border:1px solid #ddd;text-align:right;width:100px;">Rate</th>
            <th style="padding:10px;border:1px solid #ddd;text-align:right;width:120px;">Amount</th>
          </tr>
        </thead>
        <tbody>
          ${itemsHTML}
        </tbody>
      </table>
      
      <div style="text-align:right;margin-bottom:20px;">
        <table style="margin-left:auto;width:300px;">
          <tr>
            <td style="padding:5px;"><strong>Sub Total:</strong></td>
            <td style="padding:5px;text-align:right;">‚Çπ${data.subtotal.toFixed(2)}</td>
          </tr>
          <tr>
            <td style="padding:5px;color:#dc3545;"><strong>Discount:</strong></td>
            <td style="padding:5px;text-align:right;color:#dc3545;">-‚Çπ${data.discount.toFixed(2)}</td>
          </tr>
          <tr>
            <td style="padding:5px;"><strong>Tax:</strong></td>
            <td style="padding:5px;text-align:right;">‚Çπ${data.tax.toFixed(2)}</td>
          </tr>
          <tr style="border-top:2px solid #000;">
            <td style="padding:10px;font-size:18px;"><strong>Grand Total:</strong></td>
            <td style="padding:10px;text-align:right;font-size:18px;"><strong>‚Çπ${data.total.toFixed(2)}</strong></td>
          </tr>
        </table>
      </div>
      
      ${data.notes ? `
        <div style="margin-bottom:20px;">
          <p style="margin:5px 0;"><strong>Customer Notes:</strong></p>
          <p style="margin:5px 0;padding:10px;background:#f8f9fa;border-left:3px solid #0d6efd;">${escapeHtml(data.notes)}</p>
        </div>
      ` : ''}
      
      ${data.terms ? `
        <div style="margin-bottom:20px;">
          <p style="margin:5px 0;"><strong>Terms & Conditions:</strong></p>
          <p style="margin:5px 0;white-space:pre-line;font-size:12px;color:#666;">${escapeHtml(data.terms)}</p>
        </div>
      ` : ''}
      
      <div style="text-align:center;margin-top:30px;padding-top:20px;border-top:1px solid #ddd;color:#666;font-size:12px;">
        <p>Thank you for your business!</p>
      </div>
    </div>
  `;
}

// Share Invoice as PDF
async function shareInvoiceAsPDF() {
  alert('√∞≈∏‚Äú‚Äû PDF sharing coming soon! For now, use Preview √¢‚Ä†‚Äô Print to save as PDF.');
  // You can implement PDF generation using jsPDF or html2pdf.js later
}

// Share via WhatsApp (Text message)
function shareViaWhatsApp() {
  const invoiceData = collectInvoiceData();
  
  if (!invoiceData.customerName) {
    alert('√¢¬ù≈í Please enter customer name');
    return;
  }
  
  const message = generateShareText(invoiceData);
  const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
  window.open(whatsappUrl, '_blank');
}

// Share via Email (Text)
function shareViaEmail() {
  const invoiceData = collectInvoiceData();
  
  if (!invoiceData.customerName) {
    alert('√¢¬ù≈í Please enter customer name');
    return;
  }
  
  const subject = `Invoice ${invoiceData.invoiceNumber} from Tile & Sanitaryware Inventory`;
  const body = generateShareText(invoiceData);
  const mailtoUrl = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
  window.location.href = mailtoUrl;
}

// Share via SMS (Text)
function shareViaSMS() {
  const invoiceData = collectInvoiceData();
  
  if (!invoiceData.customerName) {
    alert('√¢¬ù≈í Please enter customer name');
    return;
  }
  
  const message = generateShareText(invoiceData);
  const smsUrl = `sms:?body=${encodeURIComponent(message)}`;
  window.location.href = smsUrl;
}

// Generate text message for sharing
function generateShareText(data) {
  let text = `√∞≈∏¬ß¬æ INVOICE\n\n`;
  text += `Invoice No: ${data.invoiceNumber}\n`;
  text += `Customer: ${data.customerName}\n`;
  text += `Date: ${new Date(data.invoiceDate).toLocaleDateString('en-IN')}\n`;
  text += `Due Date: ${new Date(data.dueDate).toLocaleDateString('en-IN')}\n\n`;
  
  text += `ITEMS:\n`;
  data.items.forEach((item, i) => {
    text += `${i + 1}. ${item.name} x ${item.quantity} = ‚Çπ${item.amount.toFixed(2)}\n`;
  });
  
  text += `\n`;
  text += `Sub Total: ‚Çπ${data.subtotal.toFixed(2)}\n`;
  if (data.discount > 0) {
    text += `Discount: -‚Çπ${data.discount.toFixed(2)}\n`;
  }
  if (data.tax > 0) {
    text += `Tax: ‚Çπ${data.tax.toFixed(2)}\n`;
  }
  text += `√¢‚Äù¬Å√¢‚Äù¬Å√¢‚Äù¬Å√¢‚Äù¬Å√¢‚Äù¬Å√¢‚Äù¬Å√¢‚Äù¬Å√¢‚Äù¬Å√¢‚Äù¬Å√¢‚Äù¬Å√¢‚Äù¬Å√¢‚Äù¬Å√¢‚Äù¬Å√¢‚Äù¬Å√¢‚Äù¬Å√¢‚Äù¬Å\n`;
  text += `TOTAL: ‚Çπ${data.total.toFixed(2)}\n\n`;
  
  text += `Thank you for your business!\n`;
  text += `- Tile & Sanitaryware Inventory`;
  
  return text;
}

// Show loading indicator
function showLoading(message = 'Loading...') {
  // Check if loading div already exists
  let loadingDiv = document.getElementById('globalLoading');
  
  if (!loadingDiv) {
    // Create loading indicator
    loadingDiv = document.createElement('div');
    loadingDiv.id = 'globalLoading';
    loadingDiv.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    `;
    
    loadingDiv.innerHTML = `
      <div style="background: white; padding: 30px; border-radius: 12px; text-align: center;">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <div style="margin-top: 15px; color: #333;" id="loadingMessage">${message}</div>
      </div>
    `;
    
    document.body.appendChild(loadingDiv);
  } else {
    // Update message
    const messageEl = document.getElementById('loadingMessage');
    if (messageEl) {
      messageEl.textContent = message;
    }
    loadingDiv.style.display = 'flex';
  }
}

// Hide loading indicator
function hideLoading() {
  const loadingDiv = document.getElementById('globalLoading');
  if (loadingDiv) {
    loadingDiv.style.display = 'none';
  }
}


/**
 * ==========================================
 * SIDEBAR MENU FUNCTIONALITY
 * ==========================================
 */

// Toggle Sidebar
function toggleSidebar() {
  const sidebar = document.getElementById('sidebarMenu');
  const overlay = document.getElementById('sidebarOverlay');
  
  if (sidebar.classList.contains('open')) {
    closeSidebar();
  } else {
    sidebar.classList.add('open');
    overlay.classList.add('show');
  }
}

// Close Sidebar
function closeSidebar() {
  const sidebar = document.getElementById('sidebarMenu');
  const overlay = document.getElementById('sidebarOverlay');
  
  sidebar.classList.remove('open');
  overlay.classList.remove('show');
}

// ‚úÖ UPDATE: Go to Home function
function goToHome() {
  closeSidebar();
  navigateToHome();
}

// ‚úÖ UPDATE: Sidebar Action function
function sidebarAction(action) {
  console.log('Sidebar action:', action);
  
  // Show coming soon for disabled items
  alert('‚è≥ "' + action.replace(/([A-Z])/g, ' $1').trim() + '" feature coming soon!\n\nThis will be implemented in the next phase.');
  
  closeSidebar();
}


// Navigate to All Products page - UPDATED FIX
// Navigate to All Products page - UPDATED FIX
function navigateToAllProducts() {
  console.log('üì¶ Navigating to All Products');
  
  currentPage = 'allProducts';
  
  // === STEP 1: Get all page elements ===
  const mainApp = document.getElementById('mainApp');
  const allProductsPage = document.getElementById('allProductsPage');
  const productGroupsPage = document.getElementById('productGroupsPage');
  const customersPage = document.getElementById('customersPage');
  const groupDetailPage = document.getElementById('groupDetailPage');
  
  // === STEP 2: HIDE ALL other pages ===
  if (mainApp) {
    mainApp.style.display = 'none';
    mainApp.classList.remove('active');
  }
  
  if (productGroupsPage) {
    productGroupsPage.style.display = 'none';
    productGroupsPage.classList.remove('active');
  }
  
  if (customersPage) {
    customersPage.style.display = 'none';
    customersPage.classList.remove('active');
  }
  
  if (groupDetailPage) {
    groupDetailPage.style.display = 'none';
    groupDetailPage.classList.remove('active');
  }
  
  // Remove dynamic containers
  const dynamicContainers = ['productGroupsPageContainer', 'groupVariantsPageContainer'];
  dynamicContainers.forEach(id => {
    const el = document.getElementById(id);
    if (el) el.remove();
  });
  
  // === STEP 3: SHOW All Products page ===
  if (allProductsPage) {
    allProductsPage.style.display = 'block';
    allProductsPage.classList.add('active');
    console.log('‚úÖ All Products page displayed');
  }
  
  // === STEP 4: Hide the blue navbar ===
  const navbar = document.querySelector('.navbar.navbar-dark.bg-primary');
  if (navbar) {
    navbar.style.display = 'none';
  }
  
  // === STEP 5: Render products and auto-trigger "ALL" filter ===
  if (typeof renderAllProductsList === 'function') {
    renderAllProductsList();
    console.log('‚úÖ All Products HTML rendered');
  }
  
  // === STEP 6: ‚úÖ Create synthetic event and call filterByCategory ===
  setTimeout(() => {
    // Create a fake event object that filterByCategory() expects
    const fakeEvent = {
      target: {
        textContent: 'All',
        classList: {
          add: function() {},
          remove: function() {}
        }
      }
    };
    
    // Call filterByCategory with the fake event
    if (typeof filterByCategory === 'function') {
      filterByCategory(fakeEvent);
      console.log('‚úÖ "ALL" filter applied - products now loading');
    }
  }, 100);
  
  // === STEP 7: Close sidebar and scroll ===
  if (typeof closeSidebar === 'function') {
    closeSidebar();
  }
  
  window.scrollTo({ top: 0, behavior: 'smooth' });
}












let currentGroupName = null;
let attributeRowCounter = 0;


/**
 * ==========================================
 * NAVIGATION - PRODUCT GROUPS
 * ==========================================
 */

// Navigate to Product Groups List Page - UPDATED FOR INVOICE NAVIGATION
function navigateToProductGroups() {
  console.log('üìÅ Navigating to Product Groups');
  
  currentPage = 'productGroups';
  
  // === STEP 1: Hide navbar ===
  const navbar = document.querySelector('.navbar.navbar-dark.bg-primary');
  if (navbar) navbar.style.display = 'none';
  
  // === STEP 2: Hide main app ===
  const mainApp = document.getElementById('mainApp');
  if (mainApp) mainApp.style.display = 'none';
  
  // === STEP 3: Hide other pages ===
  const allProductsPage = document.getElementById('allProductsPage');
  const customersPage = document.getElementById('customersPage');
  const groupDetailPage = document.getElementById('groupDetailPage');
  
  if (allProductsPage) {
    allProductsPage.style.display = 'none';
    allProductsPage.classList.remove('active');
  }
  if (customersPage) {
    customersPage.style.display = 'none';
    customersPage.classList.remove('active');
  }
  if (groupDetailPage) {
    groupDetailPage.style.display = 'none';
    groupDetailPage.classList.remove('active');
  }
  
  // === STEP 4: Remove old container if exists ===
  const oldContainer = document.getElementById('productGroupsPageContainer');
  if (oldContainer) oldContainer.remove();
  
  // === STEP 5: Build full-screen page ===
  document.body.innerHTML += `
    <div id="productGroupsPageContainer" style="position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: #f8f9fa; z-index: 99999; overflow-y: auto;">
      
      <!-- Header -->
      <div class="modal-header-mobile">
               <button onclick="location.reload()" style="background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer;">
          ‚Üê Back to Home
        </button>

        <h3>Products in Group</h3>
        <button class="btn-primary-bottom" onclick="openCreateGroupModal()" style="padding: 8px 16px; min-height: auto; flex: none; font-size: 14px;">
          + Create
        </button>
      </div>
      
      <!-- Search -->
      <div style="padding: 16px;">
        <input 
          type="text" 
          id="searchGroupsInput" 
          placeholder="üîç Search groups..."
          style="width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px;"
          onkeyup="filterProductGroups(this.value)">
      </div>
      
      <!-- Loading State -->
      <div id="groupsLoadingState" class="loading-spinner">
        <div class="spinner"></div>
        <p>Loading product groups...</p>
      </div>
      
      <!-- Groups List -->
      <div id="groupsListContainer" style="display: none;">
        <!-- Groups will be rendered here -->
      </div>
      
      <!-- Empty State -->
      <div id="groupsEmptyState" class="empty-state" style="display: none;">
        <div class="empty-state-icon">üìÅ</div>
        <h3>No Product Groups Yet</h3>
        <p>Create your first product group to manage variants</p>
        <button class="btn-primary-bottom" onclick="openCreateGroupModal()" style="max-width: 200px; margin: 0 auto;">
          + Create First Group
        </button>
      </div>
      
    </div>
  `;
  
  // === STEP 6: Close sidebar ===
  if (typeof closeSidebar === 'function') {
    closeSidebar();
  }
  
  // === STEP 7: Load data ===
  loadProductGroups();
  
  // === STEP 8: Scroll to top ===
  window.scrollTo({ top: 0, behavior: 'smooth' });
}



/**
 * Navigate to Group Variants - HOMEPAGE VERSION (No Page Navigation)
 */
function navigateToGroupVariants(groupId, groupName) {
  console.log('üì¶ Showing variants for group:', groupName);
  console.log('   - Group ID:', groupId);
  
  // Store current group
  window.currentGroupId = groupId;
  window.currentGroupName = groupName;
  
  // ‚úÖ HIDE: Groups list elements
  const groupsHeader = document.getElementById('groupsHeader');
  const searchGroupsContainer = document.getElementById('searchGroupsContainer');
  const groupsLoadingState = document.getElementById('groupsLoadingState');
  const groupsEmptyState = document.getElementById('groupsEmptyState');
  const groupsListContainer = document.getElementById('groupsListContainer');
  
  if (groupsHeader) groupsHeader.style.display = 'none';
  if (searchGroupsContainer) searchGroupsContainer.style.display = 'none';
  if (groupsLoadingState) groupsLoadingState.style.display = 'none';
  if (groupsEmptyState) groupsEmptyState.style.display = 'none';
  if (groupsListContainer) groupsListContainer.style.display = 'none';
  
  // ‚úÖ SHOW: Variants elements
  const variantsHeader = document.getElementById('variantsHeader');
  const searchVariantsContainer = document.getElementById('searchVariantsContainer');
  const variantsLoadingState = document.getElementById('variantsLoadingState');
  const currentGroupNameEl = document.getElementById('currentGroupName');
  
  if (variantsHeader) variantsHeader.style.display = 'flex';
  if (searchVariantsContainer) searchVariantsContainer.style.display = 'block';
  if (variantsLoadingState) variantsLoadingState.style.display = 'block';
  if (currentGroupNameEl) currentGroupNameEl.textContent = groupName;
  
  console.log('‚úÖ Switched to variants view');
  
  // ‚úÖ Load variants from Firestore
  if (typeof loadGroupVariants === 'function') {
    loadGroupVariants(groupId);
  } else {
    console.error('‚ùå loadGroupVariants function not found!');
  }
}

window.navigateToGroupVariants = navigateToGroupVariants;


    /**
 * Back to Groups List - Return from Variants View
 */
function backToGroupsList() {
  console.log('‚¨ÖÔ∏è Returning to groups list');
  
  // Clear current group data
  delete window.currentGroupId;
  delete window.currentGroupName;
  
  // ‚úÖ HIDE: Variants elements
  const variantsHeader = document.getElementById('variantsHeader');
  const searchVariantsContainer = document.getElementById('searchVariantsContainer');
  const variantsLoadingState = document.getElementById('variantsLoadingState');
  const variantsEmptyState = document.getElementById('variantsEmptyState');
  const variantsListContainer = document.getElementById('variantsListContainer');
  
  if (variantsHeader) variantsHeader.style.display = 'none';
  if (searchVariantsContainer) searchVariantsContainer.style.display = 'none';
  if (variantsLoadingState) variantsLoadingState.style.display = 'none';
  if (variantsEmptyState) variantsEmptyState.style.display = 'none';
  if (variantsListContainer) variantsListContainer.style.display = 'none';
  
  // ‚úÖ SHOW: Groups list elements
  const groupsHeader = document.getElementById('groupsHeader');
  const searchGroupsContainer = document.getElementById('searchGroupsContainer');
  const groupsListContainer = document.getElementById('groupsListContainer');
  
  if (groupsHeader) groupsHeader.style.display = 'flex';
  if (searchGroupsContainer) searchGroupsContainer.style.display = 'block';
  if (groupsListContainer) groupsListContainer.style.display = 'block';
  
  console.log('‚úÖ Returned to groups list');
}

window.backToGroupsList = backToGroupsList;


// Close Group Variants Page
function closeGroupVariantsPage() {
  const page = document.getElementById('groupVariantsPageContainer');
  if (page) page.remove();
  
  // Refresh groups list
  loadProductGroups();
}


/**
 * ==========================================
 * DATA LOADING FUNCTIONS
 * ==========================================
 */

/**
 * ==========================================
 * DATA LOADING FUNCTIONS - FIREBASE VERSION
 * ==========================================
 */

// Load Product Groups from Firestore
async function loadProductGroups() {
  const user = window.auth.currentUser;
  
  if (!user) {
    console.log('No user authenticated');
    const loadingState = document.getElementById('groupsLoadingState');
    if (loadingState) {
      loadingState.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">üîí</div>
          <h3>Please Sign In</h3>
          <p>Sign in to view your product groups</p>
        </div>
      `;
    }
    return;
  }
  
  try {
    console.log('üì° Fetching product groups from Firestore...');
    
    const { collection, getDocs, query, orderBy } = window.firebaseImports;
    
    const groupsRef = collection(window.db, 'tenants', user.uid, 'productGroups');
    const q = query(groupsRef, orderBy('createdAt', 'desc'));
    const snapshot = await getDocs(q);
    
    const groups = [];
    snapshot.forEach((doc) => {
      groups.push({
        groupId: doc.id,
        ...doc.data()
      });
    });
    
    cachedProductGroups = groups;
    console.log('‚úÖ Loaded', groups.length, 'groups from Firestore');
    
    // Hide loading
    const loadingState = document.getElementById('groupsLoadingState');
    if (loadingState) loadingState.style.display = 'none';
    
    // Show appropriate view
    if (groups.length === 0) {
      const emptyState = document.getElementById('groupsEmptyState');
      if (emptyState) emptyState.style.display = 'flex';
    } else {
      renderProductGroups(groups);
    }
    
  } catch (error) {
    console.error('‚ùå Error loading groups from Firestore:', error);
    
    const loadingState = document.getElementById('groupsLoadingState');
    if (loadingState) {
      loadingState.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">‚ö†Ô∏è</div>
          <h3>Error Loading Groups</h3>
          <p>${error.message}</p>
          <button class="btn-primary-bottom" onclick="loadProductGroups()" style="max-width: 200px; margin: 16px auto 0;">
            üîÑ Retry
          </button>
        </div>
      `;
    }
  }
}

// Load Group Variants from Firestore
async function loadGroupVariants(groupId) {
  const user = window.auth.currentUser;
  
  if (!user) {
    console.log('No user authenticated');
    return;
  }
  
  try {
    console.log('üì° Fetching variants for group:', groupId);
    
    const { collection, getDocs, query, where } = window.firebaseImports;
    
    // Get variants that belong to this group
    const variantsRef = collection(window.db, 'tenants', user.uid, 'products');
    const q = query(variantsRef, where('groupId', '==', groupId));
    const snapshot = await getDocs(q);
    
    const variants = [];
    snapshot.forEach((doc) => {
      variants.push({
        variantId: doc.id,
        ...doc.data()
      });
    });
    
    cachedGroupVariants = variants;
    console.log('‚úÖ Loaded', variants.length, 'variants from Firestore');
    
    // Hide loading
    const loadingState = document.getElementById('variantsLoadingState');
    if (loadingState) loadingState.style.display = 'none';
    
    // Show appropriate view
    if (variants.length === 0) {
      const emptyState = document.getElementById('variantsEmptyState');
      if (emptyState) emptyState.style.display = 'flex';
    } else {
      renderGroupVariants(variants);
    }
    
  } catch (error) {
    console.error('‚ùå Error loading variants from Firestore:', error);
    
    const loadingState = document.getElementById('variantsLoadingState');
    if (loadingState) {
      loadingState.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">‚ö†Ô∏è</div>
          <h3>Error Loading Variants</h3>
          <p>${error.message}</p>
          <button class="btn-primary-bottom" onclick="loadGroupVariants('${groupId}')" style="max-width: 200px; margin: 16px auto 0;">
            üîÑ Retry
          </button>
        </div>
      `;
    }
  }
}


/**
 * ==========================================
 * RENDERING FUNCTIONS
 * ==========================================
 */

// Render Product Groups List
function renderProductGroups(groups) {
  const container = document.getElementById('groupsListContainer');
  if (!container) return;
  
  let html = '';
  
  groups.forEach(group => {
    const variantText = group.totalVariants === 1 ? '1 variant' : `${group.totalVariants} variants`;
    const categoryText = group.category || 'Uncategorized';
    
    html += `
      <div class="group-card" onclick="navigateToGroupVariants('${group.groupId}', '${escapeHtml(group.groupName)}')">
        <div class="group-icon">üìÅ</div>
        
        <div class="group-info">
          <div class="group-name">${escapeHtml(group.groupName)}</div>
          <div class="group-description">${escapeHtml(group.description || 'No description')}</div>
          <div class="group-meta">
            <span class="group-meta-item">üì¶ ${variantText}</span>
            <span class="group-meta-item">üè∑Ô∏è ${categoryText}</span>
          </div>
        </div>
        
        <div class="group-actions" onclick="event.stopPropagation()">
          <button class="btn-icon-small btn-delete-small" onclick="confirmDeleteGroup('${group.groupId}', '${escapeHtml(group.groupName)}')">
            üóëÔ∏è
          </button>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
  container.style.display = 'block';
}

// Render Group Variants List - FIXED
function renderGroupVariants(variants) {
  const container = document.getElementById('variantsListContainer');
  if (!container) return;

  if (!variants || variants.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">üì¶</div>
        <h3>No Variants Yet</h3>
        <p>This group doesn't have any variants</p>
      </div>
    `;
    return;
  }

  let html = '';
  
  variants.forEach(variant => {
    // Parse attributes
    let attributesText = '';
    try {
      const attrs = typeof variant.attributes === 'string' 
        ? JSON.parse(variant.attributes) 
        : variant.attributes;
      const attrArray = Object.entries(attrs).map(([key, value]) => `${key}: ${value}`);
      attributesText = attrArray.join(' ‚Ä¢ ');
    } catch (e) {
      attributesText = '';
    }

    // Stock status
    const stockClass = variant.stock <= variant.minStock ? 'low' : 'good';
    const stockIcon = variant.stock <= variant.minStock ? '‚ö†Ô∏è' : '‚úÖ';
    const stockText = `${stockIcon} ${variant.stock}`;

    // Price
    const priceText = variant.sellingPrice > 0 ? `‚Çπ${variant.sellingPrice.toFixed(2)}` : '‚Çπ0.00';

    html += `
      <div class="variant-card">
        <div class="variant-icon">üì¶</div>
        <div class="variant-info">
          <div class="variant-name">${escapeHtml(variant.variantName)}</div>
          ${attributesText ? `<div class="variant-attributes">${attributesText}</div>` : ''}
          <div class="variant-details">
            <span class="variant-stock ${stockClass}">${stockText}</span>
            <span class="variant-price">${priceText}</span>
          </div>
        </div>
        <div class="variant-actions">
          <button class="btn-icon-small btn-edit-small" onclick="openEditVariantModal('${variant.variantId}')">
            <i class="bi bi-pencil"></i>
          </button>
          <button class="btn-icon-small btn-delete-small" onclick="confirmDeleteVariant('${variant.variantId}', '${escapeHtml(variant.variantName)}')">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </div>
    `;
  });

  container.innerHTML = html;
  container.style.display = 'block';
}





/**
 * ==========================================
 * FILTER FUNCTIONS
 * ==========================================
 */

// Filter Product Groups
function filterProductGroups(searchText) {
  if (!searchText || searchText.trim() === '') {
    renderProductGroups(cachedProductGroups);
    return;
  }
  
  const filtered = cachedProductGroups.filter(group => 
    group.groupName.toLowerCase().includes(searchText.toLowerCase()) ||
    (group.description && group.description.toLowerCase().includes(searchText.toLowerCase())) ||
    (group.category && group.category.toLowerCase().includes(searchText.toLowerCase()))
  );
  
  renderProductGroups(filtered);
}


// Filter Group Variants
function filterGroupVariants(searchText) {
  if (!searchText || searchText.trim() === '') {
    renderGroupVariants(cachedGroupVariants);
    return;
  }
  
  const filtered = cachedGroupVariants.filter(variant => 
    variant.variantName.toLowerCase().includes(searchText.toLowerCase())
  );
  
  renderGroupVariants(filtered);
}


/**
 * ==========================================
 * CREATE GROUP MODAL FUNCTIONS
 * ==========================================
 */

function openCreateGroupModal() {
  console.log('üìù Opening Create Group Modal');

  // Remove any existing injected modal to avoid duplicates
  const existing = document.getElementById('createGroupModal');
  if (existing) existing.remove();

  const html = `
    <div id="createGroupModal" class="fullscreen-modal active keep-in-dom-remove"
         style="display:block!important;position:fixed;top:0;left:0;width:100%;height:100vh;background:#fff;z-index:9999999;overflow-y:auto">
      <div class="modal-header-mobile" style="position:sticky;top:0;background:#fff;padding:12px 16px;border-bottom:1px solid #e0e0e0;z-index:100;display:flex;justify-content:space-between;align-items:center">
        <button class="btn-cancel-modal" onclick="closeCreateGroupModal()" style="background:#dc3545;color:#fff;border:none;padding:8px 12px;border-radius:6px;cursor:pointer">‚úï Cancel</button>
        <h3 style="margin:0;font-size:18px;font-weight:600">New Item Group</h3>
        <div style="width:80px"></div>
      </div>

      <form id="createGroupForm" class="mobile-form" onsubmit="handleCreateGroup(event)" style="padding:16px;padding-bottom:100px">
        <div class="form-section" style="margin-bottom:24px;background:#f8f9fa;padding:16px;border-radius:12px">
          <div class="section-title" style="font-size:16px;font-weight:600;margin-bottom:12px">Basic Information</div>
          <label style="display:block;font-weight:600;margin-bottom:6px">Item Group Name <span style="color:#dc3545">*</span></label>
          <input id="groupName" required placeholder="e.g., T-Shirts, Tiles" style="width:100%;padding:12px;font-size:16px;border:1px solid #ddd;border-radius:8px">

          <label style="display:block;font-weight:600;margin:16px 0 6px">Description</label>
          <textarea id="groupDescription" rows="3" placeholder="Optional" style="width:100%;padding:12px;font-size:16px;border:1px solid #ddd;border-radius:8px"></textarea>

          <label style="display:block;font-weight:600;margin:16px 0 6px">Manufacturer/Brand</label>
          <input id="groupManufacturer" placeholder="e.g., Somany" style="width:100%;padding:12px;font-size:16px;border:1px solid #ddd;border-radius:8px">

          <label style="display:block;font-weight:600;margin:16px 0 6px">Category</label>
          <select id="groupCategory" style="width:100%;padding:12px;font-size:16px;border:1px solid #ddd;border-radius:8px">
            <option value="">Select Category</option>
            <option value="Tiles">Tiles</option>
            <option value="Sanitaryware">Sanitaryware</option>
            <option value="Accessories">Accessories</option>
            <option value="Apparel">Apparel</option>
            <option value="Custom">Custom</option>
          </select>
        </div>

        <div class="form-section" style="margin-bottom:24px;background:#f8f9fa;padding:16px;border-radius:12px">
          <div class="section-title" style="font-size:16px;font-weight:600;margin-bottom:8px">Create Attributes</div>
          <div class="section-description" style="font-size:13px;color:#666;margin-bottom:12px">Add attributes like Size, Color, Material</div>
          <div id="attributesContainer"></div>
          <button type="button" onclick="addAttributeRow()" style="width:100%;padding:12px;background:#007bff;color:#fff;border:none;border-radius:8px;font-weight:600;margin-top:8px">‚ûï Add Attribute</button>
        </div>

        <div class="form-section" style="background:#fff;padding:16px;border-radius:12px;border:2px solid #e3f2fd">
          <div style="display:inline-block;background:#667eea;color:#fff;padding:6px 12px;border-radius:16px;font-weight:600">
            <span id="variantCount">0</span> Variants Will Be Created
          </div>
          <div id="variantPreviewContainer" style="max-height:240px;overflow-y:auto;margin-top:10px">
            <div style="padding:10px 12px;background:#e3f2fd;border-radius:8px;color:#1976d2">Add attributes to see preview...</div>
          </div>
        </div>

        <div style="position:fixed;bottom:0;left:0;right:0;background:#fff;padding:12px 16px;box-shadow:0 -2px 8px rgba(0,0,0,.1);display:flex;gap:12px;z-index:1000">
          <button type="button" onclick="closeCreateGroupModal()" style="flex:1;padding:12px;background:#6c757d;color:#fff;border:none;border-radius:8px;font-weight:600">Cancel</button>
          <button type="submit" id="btnSaveGroup" style="flex:2;padding:12px;background:#28a745;color:#fff;border:none;border-radius:8px;font-weight:600">üíæ Save & Generate</button>
        </div>
      </form>
    </div>
  `;

  document.body.insertAdjacentHTML('beforeend', html);

  // mark as removable
  const modal = document.getElementById('createGroupModal');
  if (modal) modal.classList.add('keep-in-dom');

  // Prevent body scroll
  document.body.style.overflow = 'hidden';

  // Reset attributes and add first row (guarded)
  if (typeof attributeRowCounter === 'undefined') window.attributeRowCounter = 0;
  const container = document.getElementById('attributesContainer');
  if (container) {
    container.innerHTML = '';
    if (typeof addAttributeRow === 'function') {
      addAttributeRow();
    } else {
      console.warn('addAttributeRow is not defined yet');
    }
  }

  console.log('‚úÖ Create Group Modal injected and opened');
}






// Close Create Group Modal - FIXED
function closeCreateGroupModal() {
  console.log('üîí Closing Create Group Modal');
  
  const modal = document.getElementById('createGroupModal');
  if (modal) {
    // Remove active class
    modal.classList.remove('active');
    
    // Hide with inline styles
    modal.style.display = 'none';
  }
  
  // Restore body scroll
  document.body.style.overflow = '';
  
  // Reset form
  const form = document.getElementById('createGroupForm');
  if (form) {
    form.reset();
  }
  
  // Clear attributes container
  const container = document.getElementById('attributesContainer');
  if (container) {
    container.innerHTML = '';
  }
  
  // Reset attribute counter
  attributeRowCounter = 0;
  
  // Reset button
  const submitBtn = document.getElementById('btnSaveGroup');
  if (submitBtn) {
    submitBtn.disabled = false;
    submitBtn.innerHTML = 'üíæ Save & Generate';
  }
  
  console.log('‚úÖ Modal closed and reset');
}


    
// Add Attribute Row - MOBILE OPTIMIZED
function addAttributeRow() {
  const container = document.getElementById('attributesContainer');
  if (!container) return;
  
  const rowId = `attributeRow${Date.now()}`;
  
  const row = document.createElement('div');
  row.className = 'attribute-row';
  row.id = rowId;
  row.style.cssText = 'display: flex; gap: 8px; margin-bottom: 12px; align-items: center;';
  
  row.innerHTML = `
    <input 
      type="text" 
      class="attr-name" 
      placeholder="Attribute (e.g., Size)" 
      style="flex: 1; padding: 12px; font-size: 16px; border: 1px solid #ddd; border-radius: 8px;"
      autocomplete="off"
      autocorrect="off"
      autocapitalize="words"
      oninput="updateVariantPreview()"
    >
    <input 
      type="text" 
      class="attr-options" 
      placeholder="Options (e.g., Small, Large)" 
      style="flex: 2; padding: 12px; font-size: 16px; border: 1px solid #ddd; border-radius: 8px;"
      autocomplete="off"
      autocorrect="off"
      autocapitalize="words"
      oninput="updateVariantPreview()"
    >
    <button 
      type="button" 
      onclick="removeAttributeRow('${rowId}')" 
      style="padding: 10px 12px; background: #dc3545; color: #fff; border: none; border-radius: 8px; font-size: 18px;"
      aria-label="Remove attribute"
    >
      √ó
    </button>
  `;
  
  container.appendChild(row);
  
  // Focus on the attribute name input (mobile-friendly)
  setTimeout(() => {
    const nameInput = row.querySelector('.attr-name');
    if (nameInput) {
      nameInput.focus();
    }
  }, 100);
  
  updateVariantPreview();
  
  console.log(`‚úÖ Added attribute row: ${rowId}`);
}

// Remove Attribute Row
function removeAttributeRow(rowId) {
  const row = document.getElementById(`attributeRow${rowId}`);
  if (row) {
    row.remove();
    updateVariantPreview();
  }
}

// Remove Attribute Row
function removeAttributeRow(rowId) {
  const row = document.getElementById(`attributeRow${rowId}`);
  if (row) {
    row.remove();
    updateVariantPreview();
  }
}


/**
 * ==========================================
 * VARIANT GENERATION & PREVIEW
 * ==========================================
 */
// Parse Attributes from Form - MOBILE OPTIMIZED
function parseAttributesFromForm() {
  console.log('üîç Parsing attributes from form...');
  
  const attributes = {};
  const rows = document.querySelectorAll('.attribute-row');
  
  console.log(`Found ${rows.length} attribute rows`);
  
  rows.forEach((row, index) => {
    // Try multiple selector strategies for mobile compatibility
    const nameInput = row.querySelector('.attr-name') || 
                     row.querySelector('input[placeholder*="Size"]') ||
                     row.querySelector('input[type="text"]:first-child');
    
    const optionsInput = row.querySelector('.attr-options') || 
                        row.querySelector('input[placeholder*="Small"]') ||
                        row.querySelector('input[type="text"]:last-child');
    
    if (nameInput && optionsInput) {
      // Get values with fallback for mobile
      const attrName = (nameInput.value || '').trim();
      const optionsText = (optionsInput.value || '').trim();
      
      console.log(`Row ${index + 1}:`, {
        name: attrName,
        options: optionsText
      });
      
      if (attrName && optionsText) {
        // Parse options - handle multiple separators
        const attrOptions = optionsText
          .split(/[,;|]/) // Split by comma, semicolon, or pipe
          .map(opt => opt.trim())
          .filter(opt => opt.length > 0);
        
        if (attrOptions.length > 0) {
          attributes[attrName] = attrOptions;
          console.log(`‚úÖ Added attribute: ${attrName} = [${attrOptions.join(', ')}]`);
        } else {
          console.warn(`‚ö†Ô∏è No valid options for attribute: ${attrName}`);
        }
      } else {
        console.warn(`‚ö†Ô∏è Row ${index + 1} - Empty name or options`);
      }
    } else {
      console.error(`‚ùå Row ${index + 1} - Could not find inputs`);
    }
  });
  
  console.log('üì¶ Final parsed attributes:', attributes);
  console.log('üìä Total attributes:', Object.keys(attributes).length);
  
  return attributes;
}



// Generate Variant Combinations
function generateVariantCombinations(attributes) {
  const keys = Object.keys(attributes);
  
  if (keys.length === 0) {
    return [];
  }
  
  // Get all arrays of options
  const optionArrays = keys.map(key => attributes[key]);
  
  // Generate cartesian product
  function cartesianProduct(arrays) {
    if (arrays.length === 0) return [[]];
    if (arrays.length === 1) return arrays[0].map(item => [item]);
    
    const [first, ...rest] = arrays;
    const restProduct = cartesianProduct(rest);
    
    const result = [];
    for (let i = 0; i < first.length; i++) {
      for (let j = 0; j < restProduct.length; j++) {
        result.push([first[i], ...restProduct[j]]);
      }
    }
    return result;
  }
  
  const combinations = cartesianProduct(optionArrays);
  
  // Convert arrays to objects
  return combinations.map(combo => {
    const variant = {};
    keys.forEach((key, index) => {
      variant[key] = combo[index];
    });
    return variant;
  });
}


// Generate Variant Name
function generateVariantName(groupName, attributes) {
  const values = Object.values(attributes);
  if (values.length === 0) return groupName;
  return `${groupName}-${values.join('-')}`;
}


// Update Variant Preview (Real-time)
function updateVariantPreview() {
  const groupName = document.getElementById('groupName').value.trim() || 'Product';
  const attributes = parseAttributesFromForm();
  const variants = generateVariantCombinations(attributes);
  
  // Update count
  document.getElementById('variantCount').textContent = variants.length;
  
  // Update preview list
  const container = document.getElementById('variantPreviewContainer');
  if (!container) return;
  
  if (variants.length === 0) {
    container.innerHTML = `
      <div class="variant-preview-item">
        Add attributes to see preview...
      </div>
    `;
    return;
  }
  
  // Show first 10 variants
  const previewLimit = 10;
  let html = '';
  
  variants.slice(0, previewLimit).forEach(attr => {
    const variantName = generateVariantName(groupName, attr);
    html += `
      <div class="variant-preview-item">
        <span class="icon">‚úì</span>
        ${escapeHtml(variantName)}
      </div>
    `;
  });
  
  // Show "and X more" if needed
  if (variants.length > previewLimit) {
    html += `
      <div class="variant-preview-more">
        ... and ${variants.length - previewLimit} more
      </div>
    `;
  }
  
  container.innerHTML = html;
}

    

// Navigate to Group Detail - FIXED
function navigateToGroupDetail(groupId, groupName) {
  console.log('üì¶ Navigating to Group Detail:', groupName);
  
  currentPage = 'groupDetail';
  currentGroupId = groupId;
  
  const mainApp = document.getElementById('mainApp');
  const allProductsPage = document.getElementById('allProductsPage');
  const productGroupsPage = document.getElementById('productGroupsPage');
  const groupDetailPage = document.getElementById('groupDetailPage');
  
  // HIDE the main dashboard
  if (mainApp) {
    mainApp.style.display = 'none';
  }
  
  // ‚úÖ HIDE THE BLUE NAVBAR
  const navbar = document.querySelector('.navbar');
  if (navbar) {
    navbar.style.display = 'none';
  }
  
  // SHOW Group Detail page
  if (groupDetailPage) {
    groupDetailPage.classList.add('active');
  }
  
  if (allProductsPage) allProductsPage.classList.remove('active');
  if (productGroupsPage) productGroupsPage.classList.remove('active');
  
  // Set group title
  const groupTitleEl = document.getElementById('groupDetailTitle');
  if (groupTitleEl) {
    groupTitleEl.textContent = groupName;
  }
  
  // Load variants
  if (typeof syncGroupVariants === 'function') {
    syncGroupVariants(groupId);
  }
  
  window.scrollTo({ top: 0, behavior: 'smooth' });
}




    
/**
 * ==========================================
 * FORM SUBMISSION HANDLERS - FIREBASE VERSION
 * ==========================================
 */

// Handle Create Group Form Submission
async function handleCreateGroup(event) {
  event.preventDefault();
  console.log('üìù Creating product group...');
  
  const user = window.auth.currentUser;
  if (!user) {
    alert('Please sign in first');
    return;
  }
  
  const submitBtn = document.getElementById('btnSaveGroup');
  const originalText = submitBtn.innerHTML;
  
  if (submitBtn.disabled) {
    console.log('‚ö†Ô∏è Already submitting...');
    return;
  }
  
  submitBtn.disabled = true;
  submitBtn.innerHTML = '‚è≥ Creating...';
  
  try {
    // Collect form data
    const groupName = document.getElementById('groupName').value.trim();
    const description = document.getElementById('groupDescription').value.trim();
    const manufacturer = document.getElementById('groupManufacturer').value.trim();
    const category = document.getElementById('groupCategory').value;
    
    console.log('üìã Form data:', { groupName, description, manufacturer, category });
    
    // Parse attributes
    const attributes = parseAttributesFromForm();
    
    // Validation
    if (!groupName) {
      throw new Error('‚ùå Group name is required');
    }
    
    if (groupName.length < 2) {
      throw new Error('‚ùå Group name must be at least 2 characters');
    }
    
    if (Object.keys(attributes).length === 0) {
      throw new Error('‚ùå Please add at least one attribute with options.\n\nExample:\nAttribute: Size\nOptions: Small, Large');
    }
    
    // Validate each attribute has options
    for (const [attrName, attrOptions] of Object.entries(attributes)) {
      if (attrOptions.length === 0) {
        throw new Error(`‚ùå Attribute "${attrName}" has no options.\n\nPlease enter options separated by commas.\n\nExample: Small, Medium, Large`);
      }
    }
    
    console.log('‚úÖ Validation passed!');
    
    // Generate variants
    const variants = generateVariantCombinations(attributes);
    console.log(`üìä Will create ${variants.length} variants`);
    
    const { collection, addDoc } = window.firebaseImports;
    
    // Save product group
    const groupsRef = collection(window.db, 'tenants', user.uid, 'productGroups');
    const groupDocRef = await addDoc(groupsRef, {
      groupName: groupName,
      description: description,
      manufacturer: manufacturer,
      brand: manufacturer,
      category: category,
      attributes: attributes,
      totalVariants: variants.length,
      createdBy: user.email,
      createdAt: new Date().toISOString(),
      userId: user.uid
    });
    
    console.log('‚úÖ Group created:', groupDocRef.id);
    
    // Save all variants
    const productsRef = collection(window.db, 'tenants', user.uid, 'products');
    const variantPromises = variants.map(attrs => {
      const variantName = generateVariantName(groupName, attrs);
      
      return addDoc(productsRef, {
        name: variantName,
        variantName: variantName,
        groupId: groupDocRef.id,
        groupName: groupName,
        category: category,
        brand: manufacturer,
        manufacturer: manufacturer,
        attributes: attrs,
        unitType: 'Piece',
        price: 0,
        sellingPrice: 0,
        costPrice: 0,
        stock: 0,
        minStock: 0,
        size: attrs.Size || '',
        createdAt: new Date().toISOString(),
        userId: user.uid
      });
    });
    
    await Promise.all(variantPromises);
    
    console.log(`‚úÖ Created ${variants.length} variants`);
    
    // Show success message
    showSuccessToast(`‚úÖ Created "${groupName}" with ${variants.length} variants!`);
    
    // Close modal
    closeCreateGroupModal();
    
    // Reload groups list
    setTimeout(() => {
      loadProductGroups();
    }, 500);
    
  } catch (error) {
    console.error('‚ùå Error creating product group:', error);
    alert(`Error: ${error.message}`);
    
    submitBtn.disabled = false;
    submitBtn.innerHTML = originalText;
  }
}


/**
 * ==========================================
 * EDIT VARIANT MODAL FUNCTIONS
 * ==========================================
 */

// Open Edit Variant Modal - AGGRESSIVE FORCE SHOW VERSION
function openEditVariantModal(variantId) {
  console.log('üîç Opening edit modal for variant:', variantId);
  
  // Find variant in cache
  const variant = cachedGroupVariants.find(v => v.variantId === variantId);
  
  if (!variant) {
    alert('Variant not found');
    return;
  }

  // Use the existing Bootstrap product modal
  const modal = document.getElementById('productModal');
  
  if (!modal) {
    console.error('‚ùå productModal not found in DOM!');
    alert('Error: Edit modal not found. Please refresh the page.');
    return;
  }

  // Set modal title
  const modalTitle = document.getElementById('productModalLabel');
  if (modalTitle) {
    modalTitle.textContent = 'Edit Variant';
  }

  // ‚úÖ SAFE FIELD POPULATION
  const setFieldValue = (id, value) => {
    const field = document.getElementById(id);
    if (field) {
      field.value = value;
      return true;
    } else {
      console.warn(`‚ö†Ô∏è Field not found: ${id}`);
      return false;
    }
  };

  // Populate form fields
  setFieldValue('productId', variant.variantId);
  setFieldValue('productName', variant.variantName);
  setFieldValue('brand', variant.manufacturer || variant.brand || '');
  setFieldValue('size', extractAttributeValue(variant.attributes, 'Size') || '');
  setFieldValue('category', variant.category || 'Tiles');
  setFieldValue('unitType', variant.unitType || 'Piece');
  setFieldValue('piecesPerBox', 0);
  setFieldValue('sftPerBox', 0);
  setFieldValue('price', variant.sellingPrice || 0);
  setFieldValue('stock', variant.stock || 0);
  setFieldValue('minStock', variant.minStock || 0);

  // Store that this is a variant edit
  const form = document.getElementById('productForm');
  if (form) {
    form.dataset.isVariant = 'true';
    form.dataset.groupId = variant.groupId;
  }

  // Make fields readonly
  const makeReadonly = (id) => {
    const field = document.getElementById(id);
    if (field) {
      field.readOnly = true;
      field.style.background = '#f8f9fa';
      field.style.color = '#6c757d';
    }
  };

  makeReadonly('productName');
  makeReadonly('brand');
  makeReadonly('size');

  // ‚úÖ FORCE SHOW MODAL - Multiple methods
  console.log('Attempting to show modal...');
  
  // Method 1: Try Bootstrap 5 Modal API
  try {
    let bootstrapModal = bootstrap.Modal.getInstance(modal);
    if (!bootstrapModal) {
      bootstrapModal = new bootstrap.Modal(modal);
    }
    bootstrapModal.show();
    console.log('‚úÖ Bootstrap modal.show() called');
  } catch (e) {
    console.error('‚ùå Bootstrap Modal failed:', e);
    
    // Method 2: Manual show with jQuery (fallback)
    if (typeof $ !== 'undefined' && $.fn.modal) {
      $(modal).modal('show');
      console.log('‚úÖ jQuery modal.show() called');
    } else {
      // Method 3: Direct CSS manipulation (last resort)
      modal.classList.add('show');
      modal.style.display = 'block';
      modal.setAttribute('aria-modal', 'true');
      modal.removeAttribute('aria-hidden');
      document.body.classList.add('modal-open');
      
      // Add backdrop manually
      const backdrop = document.createElement('div');
      backdrop.className = 'modal-backdrop fade show';
      backdrop.id = 'variantModalBackdrop';
      document.body.appendChild(backdrop);
      
      console.log('‚úÖ Manual modal display applied');
    }
  }

  // ‚úÖ AGGRESSIVE FORCE TO FOREGROUND (Works regardless of Bootstrap method)
  setTimeout(() => {
    // Force modal container
    modal.style.cssText = `
      display: block !important;
      z-index: 999999 !important;
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      width: 100% !important;
      height: 100% !important;
      overflow-y: auto !important;
      background: rgba(0, 0, 0, 0.5) !important;
    `;
    
    // Force modal dialog
    const modalDialog = modal.querySelector('.modal-dialog');
    if (modalDialog) {
      modalDialog.style.cssText = `
        z-index: 1000000 !important;
        position: relative !important;
        margin: 1.75rem auto !important;
        max-width: 500px !important;
        pointer-events: auto !important;
      `;
    }
    
    // Force modal content
    const modalContent = modal.querySelector('.modal-content');
    if (modalContent) {
      modalContent.style.cssText = `
        background: white !important;
        border-radius: 8px !important;
        box-shadow: 0 10px 30px rgba(0,0,0,0.5) !important;
        position: relative !important;
        display: flex !important;
        flex-direction: column !important;
      `;
    }
    
    // Force backdrop if exists
    const backdrop = document.querySelector('.modal-backdrop');
    if (backdrop) {
      backdrop.style.cssText = `
        z-index: 999998 !important;
        opacity: 0.5 !important;
      `;
    }
    
    // Lower z-index of page views
    const pageViews = document.querySelectorAll('.page-view');
    pageViews.forEach(view => {
      view.style.zIndex = '1';
    });
    
    console.log('‚úÖ Modal FORCED to foreground with inline styles');
  }, 100);

  console.log('‚úÖ Edit variant modal opened for:', variant.variantName);
}

// Helper function to extract attribute value from JSON
function extractAttributeValue(attributes, key) {
  try {
    const attrs = typeof attributes === 'string' 
      ? JSON.parse(attributes) 
      : attributes;
    return attrs[key] || '';
  } catch (e) {
    return '';
  }
}

// Close Edit Variant Modal - COMPLETE FIX
function closeEditVariantModal() {
  console.log('Closing edit variant modal');
  
  const modal = document.getElementById('editVariantModal');
  if (modal) {
    modal.classList.remove('active');
    modal.style.display = 'none'; // Hide it
    
    // Restore body scroll
    document.body.style.overflow = '';
  }

  // Reset form
  const form = document.getElementById('editVariantForm');
  if (form) {
    form.reset();
  }
  
  console.log('Modal closed');
}
// Handle Update Variant - FIREBASE VERSION
async function handleUpdateVariant(event) {
  event.preventDefault();
  
  console.log('üíæ Updating variant...');
  
  const user = window.auth.currentUser;
  if (!user) {
    alert('Please sign in first');
    return;
  }
  
  const submitBtn = event.target.querySelector('button[type="submit"]');
  const originalText = submitBtn.innerHTML;
  submitBtn.disabled = true;
  submitBtn.innerHTML = '‚è≥ Saving...';
  
  try {
    // Collect form data (using product form fields)
    const variantId = document.getElementById('productId').value;
    const price = parseFloat(document.getElementById('price').value) || 0;
    const stock = parseInt(document.getElementById('stock').value) || 0;
    const minStock = parseInt(document.getElementById('minStock').value) || 0;
    
    // Validate
    if (price < 0 || stock < 0 || minStock < 0) {
      throw new Error('Values cannot be negative');
    }
    
    console.log('üì§ Updating variant:', variantId);
    
    // Update in Firestore
    const { doc, updateDoc } = window.firebaseImports;
    const variantRef = doc(window.db, 'tenants', user.uid, 'products', variantId);
    
    await updateDoc(variantRef, {
      price: price,
      sellingPrice: price,
      stock: stock,
      minStock: minStock,
      updatedAt: new Date().toISOString()
    });
    
    console.log('‚úÖ Variant updated in Firestore');
    
    // Update local cache
    const cachedVariant = cachedProducts.find(p => p.id === variantId);
    if (cachedVariant) {
      cachedVariant.price = price;
      cachedVariant.stock = stock;
      cachedVariant.minStock = minStock;
    }
    
    // Show success message
    showSuccessToast('Variant updated successfully!');
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('productModal'));
    if (modal) modal.hide();
    
    // Refresh variants list
    setTimeout(() => {
      if (currentGroupId) {
        loadGroupVariants(currentGroupId);
      }
    }, 500);
    
  } catch (error) {
    console.error('‚ùå Error updating variant:', error);
    alert('Error: ' + error.message);
    
    submitBtn.disabled = false;
    submitBtn.innerHTML = originalText;
  }
}


/**
 * ==========================================
 * DELETE FUNCTIONS - FIREBASE VERSION
 * ==========================================
 */

// ‚úÖ NO CHANGES NEEDED
function confirmDeleteGroup(groupId, groupName) { /* Keep as is */ }

// Delete Product Group - FIREBASE VERSION
async function deleteProductGroup(groupId, groupName) {
  console.log('üóëÔ∏è Deleting group:', groupId);
  
  const user = window.auth.currentUser;
  if (!user) {
    alert('Please sign in first');
    return;
  }
  
  try {
    showLoadingOverlay('Deleting group...');
    
    const { doc, deleteDoc, collection, query, where, getDocs } = window.firebaseImports;
    
    // Delete the group document
    const groupRef = doc(window.db, 'tenants', user.uid, 'productGroups', groupId);
    await deleteDoc(groupRef);
    
    // Delete all variants in this group
    const productsRef = collection(window.db, 'tenants', user.uid, 'products');
    const q = query(productsRef, where('groupId', '==', groupId));
    const snapshot = await getDocs(q);
    
    const deletePromises = [];
    snapshot.forEach((docSnapshot) => {
      const variantRef = doc(window.db, 'tenants', user.uid, 'products', docSnapshot.id);
      deletePromises.push(deleteDoc(variantRef));
    });
    
    await Promise.all(deletePromises);
    
    hideLoadingOverlay();
    
    console.log(`‚úÖ Group deleted along with ${deletePromises.length} variants`);
    
    showSuccessToast(`Deleted "${groupName}" and all its variants`);
    
    setTimeout(() => {
      loadProductGroups();
    }, 500);
    
  } catch (error) {
    hideLoadingOverlay();
    console.error('‚ùå Error deleting group:', error);
    alert('Error: ' + error.message);
  }
}

// ‚úÖ NO CHANGES NEEDED
function confirmDeleteVariant(variantId, variantName) { /* Keep as is */ }

// Delete Variant - FIREBASE VERSION
async function deleteVariant(variantId, variantName) {
  console.log('üóëÔ∏è Deleting variant:', variantId);
  
  const user = window.auth.currentUser;
  if (!user) {
    alert('Please sign in first');
    return;
  }
  
  try {
    showLoadingOverlay('Deleting variant...');
    
    const { doc, deleteDoc } = window.firebaseImports;
    
    const variantRef = doc(window.db, 'tenants', user.uid, 'products', variantId);
    await deleteDoc(variantRef);
    
    hideLoadingOverlay();
    
    console.log('‚úÖ Variant deleted from Firestore');
    
    showSuccessToast(`Deleted "${variantName}"`);
    
    setTimeout(() => {
      loadGroupVariants(currentGroupId);
    }, 500);
    
  } catch (error) {
    hideLoadingOverlay();
    console.error('‚ùå Error deleting variant:', error);
    alert('Error: ' + error.message);
  }
}


  // Open Add Product modal (from All Products page) - FIXED
function openAddProduct() {
  console.log('üìù Opening Add Product modal');
  loadBrandAutocompleteCache();
  // Reset product modal
  const modalTitle = document.getElementById('modalTitle');
  const productForm = document.getElementById('productForm');
  const productId = document.getElementById('productId');
  const currentPhotoUrl = document.getElementById('currentPhotoUrl');
  const photoPreview = document.getElementById('photoPreview');
  
  if (modalTitle) modalTitle.textContent = 'Add New Product';
  if (productForm) productForm.reset();
  if (productId) productId.value = '';
  if (currentPhotoUrl) currentPhotoUrl.value = '';
  if (photoPreview) photoPreview.style.display = 'none';
  
  // Show modal - FIXED Bootstrap 5 syntax
  const productModal = document.getElementById('productModal');
  if (productModal) {
    const modal = new bootstrap.Modal(productModal);
    modal.show();
    console.log('‚úÖ Product modal opened');
  } else {
    console.error('‚ùå Product modal not found');
    alert('Error: Product modal not found. Please refresh the page.');
  }
}  

/**
 * ==========================================
 * RENDERING FUNCTIONS
 * ==========================================
 */

// Render All Products List - UPDATED
function renderAllProductsList() {
  const container = document.getElementById('allProductsList');
  
  if (!container) {
    console.error('‚ùå allProductsList container not found');
    return;
  }
  
  if (!cachedProducts || cachedProducts.length === 0) {
    container.innerHTML = `
      <div style="text-align:center; padding:60px 20px; color:#999;">
        <i class="bi bi-box-seam" style="font-size:64px;"></i>
        <h4 style="margin-top:20px;">No Products Yet</h4>
        <p>Add your first product to get started</p>
      </div>
    `;
    return;
  }
  
  let html = '';
  
  cachedProducts.forEach(product => {
    const stockBadge = product.stock <= product.minStock 
      ? `<span style="color:#dc3545;">‚ö†Ô∏è Low (${product.stock})</span>`
      : `<span style="color:#28a745;">‚úì ${product.stock}</span>`;
    
    const productIcon = getProductIcon(product.category);
    
    // ‚úÖ REMOVED EYE BUTTON, MADE CARD CLICKABLE
    html += `
      <div class="product-item-compact" onclick="showProductDetails('${product.id}')" style="cursor: pointer;">
        <div class="product-item-icon">${productIcon}</div>
        <div class="product-item-info">
          <div class="product-item-name">${product.name}</div>
          <div class="product-item-details">
            <span><i class="bi bi-tag"></i> ${product.category}</span>
            ${product.brand ? `<span><i class="bi bi-award"></i> ${product.brand}</span>` : ''}
            ${product.size ? `<span><i class="bi bi-rulers"></i> ${product.size}</span>` : ''}
            <span>${stockBadge}</span>
            <span><i class="bi bi-currency-rupee"></i>${product.price.toFixed(2)}</span>
          </div>
        </div>
        <div class="product-item-actions" onclick="event.stopPropagation()">
          <button class="btn-edit-compact" onclick="editProduct('${product.id}')">
            <i class="bi bi-pencil"></i>
          </button>
          <button class="btn-delete-compact" onclick="confirmDeleteProduct('${product.id}')">
            <i class="bi bi-trash"></i>
          </button>
        </div>
      </div>
    `;
  });
  
  container.innerHTML = html;
}

// Show Product Details (when card is clicked) - NEW FUNCTION
function showProductDetails(productId) {
  console.log('üëÅÔ∏è Showing details for product:', productId);
  
  // Find the product
  const product = cachedProducts.find(p => p.id === productId);
  
  if (!product) {
    console.error('Product not found:', productId);
    return;
  }
  
  // Create modal content
  const modalContent = `
    <div style="padding: 20px;">
      ${product.imageUrl ? `<img src="${product.imageUrl}" style="width:100%; max-height:300px; object-fit:cover; border-radius:8px; margin-bottom:20px;" />` : ''}
      <h3 style="margin-bottom: 20px;">${product.name}</h3>
      <table style="width:100%; border-collapse: collapse;">
        <tr style="border-bottom: 1px solid #eee;">
          <td style="padding: 10px; font-weight: 600;">Category:</td>
          <td style="padding: 10px;">${product.category}</td>
        </tr>
        ${product.brand ? `
        <tr style="border-bottom: 1px solid #eee;">
          <td style="padding: 10px; font-weight: 600;">Brand:</td>
          <td style="padding: 10px;">${product.brand}</td>
        </tr>` : ''}
        ${product.size ? `
        <tr style="border-bottom: 1px solid #eee;">
          <td style="padding: 10px; font-weight: 600;">Size:</td>
          <td style="padding: 10px;">${product.size}</td>
        </tr>` : ''}
        <tr style="border-bottom: 1px solid #eee;">
          <td style="padding: 10px; font-weight: 600;">Unit Type:</td>
          <td style="padding: 10px;">${product.unitType || 'Piece'}</td>
        </tr>
        ${product.piecesPerBox ? `
        <tr style="border-bottom: 1px solid #eee;">
          <td style="padding: 10px; font-weight: 600;">Pieces/Box:</td>
          <td style="padding: 10px;">${product.piecesPerBox}</td>
        </tr>` : ''}
        ${product.sftPerBox ? `
        <tr style="border-bottom: 1px solid #eee;">
          <td style="padding: 10px; font-weight: 600;">SFT/Box:</td>
          <td style="padding: 10px;">${product.sftPerBox}</td>
        </tr>` : ''}
        <tr style="border-bottom: 1px solid #eee;">
          <td style="padding: 10px; font-weight: 600;">Price:</td>
          <td style="padding: 10px; font-size: 18px; color: #007bff; font-weight: 600;">‚Çπ${product.price.toFixed(2)}</td>
        </tr>
        <tr style="border-bottom: 1px solid #eee;">
          <td style="padding: 10px; font-weight: 600;">Stock:</td>
          <td style="padding: 10px;">
            <span style="color: ${product.stock <= product.minStock ? '#dc3545' : '#28a745'}; font-weight: 600;">
              ${product.stock} ${product.unitType || 'pieces'}
            </span>
          </td>
        </tr>
        <tr style="border-bottom: 1px solid #eee;">
          <td style="padding: 10px; font-weight: 600;">Min Stock Alert:</td>
          <td style="padding: 10px;">${product.minStock}</td>
        </tr>
      </table>
    </div>
  `;
  
  // Show in a Bootstrap modal (reuse existing modal or create new one)
  const modalEl = document.getElementById('productDetailModal');
  if (modalEl) {
    document.getElementById('productDetailModalBody').innerHTML = modalContent;
    const modal = new bootstrap.Modal(modalEl);
    modal.show();
  } else {
    // Fallback: show as alert if modal doesn't exist
    alert(`Product: ${product.name}\nPrice: ‚Çπ${product.price}\nStock: ${product.stock}\nCategory: ${product.category}`);
  }
}

// Confirm delete with better UX
function confirmDeleteProduct(productId) {
  const product = cachedProducts.find(p => p.id === productId);
  const productName = product ? product.name : 'this product';
  
  if (confirm(`‚ö†Ô∏è Delete "${productName}"?\n\nThis action cannot be undone.`)) {
    deleteProduct(productId);
  }
}


    /**
 * ==========================================
 * FILTER & SEARCH FUNCTIONS
 * ==========================================
 */

// Filter All Products by search
function filterAllProducts() {
  const searchText = document.getElementById('allProductsSearch').value.toLowerCase();
  
  const filteredProducts = cachedProducts.filter(product => {
    return product.name.toLowerCase().includes(searchText) ||
           product.category.toLowerCase().includes(searchText) ||
           (product.brand && product.brand.toLowerCase().includes(searchText)) ||
           (product.size && product.size.toLowerCase().includes(searchText));
  });
  
  // Temporarily update cachedProducts for rendering
  const originalProducts = cachedProducts;
  cachedProducts = filteredProducts;
  renderAllProductsList();
  cachedProducts = originalProducts;
}

// Filter by category
let currentCategoryFilter = 'all';

function filterByCategory(category) {
  currentCategoryFilter = category;
  
  // Update button states
  const buttons = document.querySelectorAll('#allProductsPage .btn-outline-primary');
  buttons.forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');
  
  if (category === 'all') {
    renderAllProductsList();
    return;
  }
  
  const filteredProducts = cachedProducts.filter(p => p.category === category);
  
  // Temporarily update for rendering
  const originalProducts = cachedProducts;
  cachedProducts = filteredProducts;
  renderAllProductsList();
  cachedProducts = originalProducts;
}

    /**
 * ==========================================
 * PLACEHOLDER FUNCTIONS (TO BE IMPLEMENTED)
 * ==========================================
 */

// View product details (placeholder)
function viewProductDetails(productId) {
  const product = cachedProducts.find(p => p.id === productId);
  
  if (!product) {
    showError('Product not found');
    return;
  }
  
  // Simple alert for now - can be replaced with modal later
  let details = `üì¶ ${product.name}\n\n`;
  details += `Category: ${product.category}\n`;
  if (product.brand) details += `Brand: ${product.brand}\n`;
  if (product.size) details += `Size: ${product.size}\n`;
  details += `Price: ‚Çπ${product.price.toFixed(2)} / ${product.unitType}\n`;
  details += `Stock: ${product.stock}\n`;
  details += `Min Stock: ${product.minStock}\n`;
  
  alert(details);
}


/**
 * Navigate to Brands Page
 */
/**
 * Navigate to Brands Page
 */
function navigateToBrands() {
  console.log('üè∑Ô∏è Navigating to Brands');
  
  currentPage = 'brands';
  
  // === STEP 1: Get page elements ===
  const mainApp = document.getElementById('mainApp');
  const allProductsPage = document.getElementById('allProductsPage');
  const productGroupsPage = document.getElementById('productGroupsPage');
  const customersPage = document.getElementById('customersPage');
  const groupDetailPage = document.getElementById('groupDetailPage');
  const brandsPage = document.getElementById('brandsPage');
  
  // === STEP 2: Hide all other pages ===
  if (mainApp) {
    mainApp.style.display = 'none';
    mainApp.classList.remove('active');
  }
  
  if (allProductsPage) {
    allProductsPage.classList.remove('active');
    allProductsPage.style.display = 'none';
  }
  
  if (productGroupsPage) {
    productGroupsPage.classList.remove('active');
    productGroupsPage.style.display = 'none';
  }
  
  if (customersPage) {
    customersPage.classList.remove('active');
    customersPage.style.display = 'none';
  }
  
  if (groupDetailPage) {
    groupDetailPage.classList.remove('active');
    groupDetailPage.style.display = 'none';
  }
  
  // === STEP 3: Show brands page ===
  if (brandsPage) {
    brandsPage.classList.add('active');
    brandsPage.style.display = 'block';
    console.log('‚úÖ Brands page displayed');
  } else {
    console.error('‚ùå brandsPage element not found!');
    return;
  }
  
  // === STEP 4: Hide the blue navbar ===
  const navbar = document.querySelector('.navbar.navbar-dark.bg-primary');
  if (navbar) {
    navbar.style.display = 'none';
  }
  
  // === STEP 5: Load brands from backend ===
  if (typeof loadBrands === 'function') {
    loadBrands();
    console.log('‚úÖ Brands data loaded');
  } else {
    console.warn('‚ö†Ô∏è loadBrands function not found');
  }
  
  // === STEP 6: Close sidebar and scroll ===
  if (typeof closeSidebar === 'function') {
    closeSidebar();
  }
  
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

    
/**
 * ==========================================
 * UI HELPER FUNCTIONS
 * ==========================================
 */

// Show success message
function showSuccessMessage(message) {
  const toast = document.createElement('div');
  toast.style.cssText = `
    position: fixed;
    top: 20px;
    right: 20px;
    background: #4caf50;
    color: white;
    padding: 16px 24px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    z-index: 10000;
    animation: slideIn 0.3s ease-out;
  `;
  toast.textContent = message;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideOut 0.3s ease-out';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}


// Show Loading Overlay
function showLoadingOverlay(message = 'Loading...') {
  // Remove existing overlay if any
  let overlay = document.getElementById('loadingOverlayCustom');
  if (overlay) overlay.remove();
  
  // Create new overlay
  overlay = document.createElement('div');
  overlay.id = 'loadingOverlayCustom';
  overlay.style.cssText = `
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    background: rgba(0, 0, 0, 0.7);
    z-index: 100000;
    display: flex;
    align-items: center;
    justify-content: center;
  `;
  
  overlay.innerHTML = `
    <div style="background: white; padding: 32px; border-radius: 12px; text-align: center;">
      <div class="spinner"></div>
      <p style="margin-top: 16px; font-size: 16px; color: #333;">${message}</p>
    </div>
  `;
  
  document.body.appendChild(overlay);
}


// Hide Loading Overlay
function hideLoadingOverlay() {
  const overlay = document.getElementById('loadingOverlayCustom');
  if (overlay) {
    overlay.remove();
  }
}


// Escape HTML to prevent XSS
function escapeHtml(text) {
  if (!text) return '';
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

/**
 * ==========================================
 * BRAND AUTOCOMPLETE SYSTEM - FIREBASE VERSION
 * ==========================================
 */

// Global brand cache
let brandAutocompleteCache = [];
let brandCacheLoaded = false;

/**
 * Load brands from Firestore and cache them
 * ‚úÖ FIREBASE VERSION
 */
async function loadBrandAutocompleteCache() {
  if (brandCacheLoaded) {
    console.log('‚úÖ Brand cache already loaded');
    return;
  }
  
  const user = window.auth.currentUser;
  
  if (!user) {
    console.log('No user authenticated, skipping brand cache load');
    return;
  }
  
  console.log('üì• Loading brand autocomplete cache from Firestore...');
  
  try {
    const { collection, getDocs } = window.firebaseImports;
    
    // Load from Firestore
    const brandsRef = collection(window.db, 'tenants', user.uid, 'brands');
    const snapshot = await getDocs(brandsRef);
    
    const brands = [];
    snapshot.forEach((doc) => {
      brands.push(doc.data().brandName);
    });
    
    brandAutocompleteCache = brands;
    brandCacheLoaded = true;
    
    console.log('‚úÖ Loaded', brands.length, 'brands into cache from Firestore');
    
  } catch (error) {
    console.error('‚ùå Error loading brand cache from Firestore:', error);
    
    // Fallback: Try to extract unique brands from products
    try {
      const uniqueBrands = [...new Set(
        cachedProducts
          .map(p => p.brand)
          .filter(b => b && b.trim() !== '')
      )];
      
      brandAutocompleteCache = uniqueBrands;
      brandCacheLoaded = true;
      
      console.log('‚úÖ Extracted', uniqueBrands.length, 'brands from products as fallback');
    } catch (fallbackError) {
      console.error('‚ùå Fallback brand extraction failed:', fallbackError);
    }
  }
}

/**
 * Filter and show brand suggestions
 */
function filterBrandSuggestions(inputText) {
  const dropdown = document.getElementById('brandSuggestionsDropdown');
  
  if (!inputText || inputText.trim().length === 0) {
    hideBrandSuggestions();
    return;
  }
  
  const query = inputText.toLowerCase().trim();
  
  // Filter brands that START with query (case-insensitive)
  const matches = brandAutocompleteCache.filter(brand => 
    brand.toLowerCase().startsWith(query)
  );
  
  if (matches.length > 0) {
    renderBrandSuggestions(matches);
    dropdown.style.display = 'block';
  } else {
    hideBrandSuggestions();
  }
  
  // ‚úÖ Also check if we should show save button
  checkAndShowSaveBrandButton(inputText);
}


/**
 * Render brand suggestions in dropdown
 */
function renderBrandSuggestions(matches) {
  const dropdown = document.getElementById('brandSuggestionsDropdown');
  
  // Limit to max 15 suggestions
  const limitedMatches = matches.slice(0, 15);
  
  let html = '';
  limitedMatches.forEach(brand => {
    html += `
      <div onclick="selectBrandSuggestion('${escapeHtml(brand)}')" style="
        padding: 10px;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background 0.2s;
      " onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='transparent'">
        <strong>${brand}</strong>
      </div>
    `;
  });
  
  dropdown.innerHTML = html;
  dropdown.style.display = 'block';
  
  console.log('üéØ Rendered', limitedMatches.length, 'brand suggestions');
}

/**
 * Select brand from dropdown
 */
function selectBrandSuggestion(brandName) {
  document.getElementById('brand').value = brandName;
  
  // ‚úÖ Hide save button when brand is selected
  document.getElementById('saveBrandInsideBtn').style.display = 'none';
  
  hideBrandSuggestions();
  console.log('‚úÖ Selected brand:', brandName);
}


/**
 * Show suggestions (when field is focused)
 */
/**
 * Show all brands when field is focused (clicked)
 * If user has typed text, show filtered suggestions
 */
function showBrandSuggestions() {
  const input = document.getElementById('brand');
  if (!input) return;
  
  const inputValue = input.value.trim();
  
  // ‚úÖ If field is empty, show ALL brands
  if (!inputValue || inputValue.length === 0) {
    if (brandAutocompleteCache && brandAutocompleteCache.length > 0) {
      renderBrandSuggestions(brandAutocompleteCache);
      console.log('üìã Showing all', brandAutocompleteCache.length, 'brands');
    } else {
      console.warn('‚ö†Ô∏è No brands in cache');
    }
  } else {
    // If user has typed something, filter based on input
    filterBrandSuggestions(inputValue);
  }
}


/**
 * Hide suggestions dropdown
 */
function hideBrandSuggestions() {
  const dropdown = document.getElementById('brandSuggestionsDropdown');
  dropdown.style.display = 'none';
}

/**
 * Check if brand exists and show/hide save button
 */
/**
 * Check if brand exists and show/hide save button
 * Hides "Saved" state when user modifies the field
 */
function checkAndShowSaveBrandButton(inputText) {
  const btn = document.getElementById('saveBrandInsideBtn');
  const input = inputText.trim();
  
  // Hide button if input is empty
  if (!input || input.length === 0) {
    btn.style.display = 'none';
    return;
  }
  
  // Check if brand already exists in cache
  const brandExists = brandAutocompleteCache.some(brand => 
    brand.toLowerCase() === input.toLowerCase()
  );
  
  // Show button ONLY if brand doesn't exist
  if (!brandExists) {
    // ‚úÖ Reset to save icon when user modifies field
    btn.innerHTML = 'üíæ';
    btn.style.background = '#28a745';
    btn.style.cursor = 'pointer';
    btn.disabled = false;
    btn.style.display = 'block';
    
    console.log('‚úÖ Show save button - new brand:', input);
  } else {
    btn.style.display = 'none';
    console.log('‚ÑπÔ∏è Hide save button - brand already exists:', input);
  }
}

/**
 * Save new brand to Firestore
 * ‚úÖ FIREBASE VERSION
 */
async function saveNewBrandFromProductField() {
  const input = document.getElementById('brand');
  const brandName = input.value.trim();
  const btn = document.getElementById('saveBrandInsideBtn');
  
  if (!brandName || brandName.length === 0) {
    return;
  }
  
  const user = window.auth.currentUser;
  
  if (!user) {
    console.log('No user authenticated');
    return;
  }
  
  // Check if brand already exists
  const brandExists = brandAutocompleteCache.some(brand => 
    brand.toLowerCase() === brandName.toLowerCase()
  );
  
  if (brandExists) {
    btn.style.display = 'none';
    return;
  }
  
  console.log('üíæ Saving new brand to Firestore:', brandName);
  
  // Instant feedback
  btn.innerHTML = '‚úÖ Saved';
  btn.style.background = '#218838';
  btn.disabled = true;
  btn.style.cursor = 'default';
  
  try {
    const { collection, addDoc } = window.firebaseImports;
    
    // Save to Firestore
    const brandsRef = collection(window.db, 'tenants', user.uid, 'brands');
    await addDoc(brandsRef, {
      brandName: brandName,
      createdAt: new Date().toISOString(),
      userId: user.uid
    });
    
    console.log('‚úÖ Brand saved successfully in Firestore:', brandName);
    
    // Add to cache
    brandAutocompleteCache.push(brandName);
    
    // Button stays as "‚úÖ Saved"
    
  } catch (error) {
    console.error('‚ùå Error saving brand to Firestore:', error);
    
    // Show error on button
    btn.innerHTML = '‚ùå Error';
    btn.style.background = '#dc3545';
    
    // Reset after 2 seconds
    setTimeout(() => {
      btn.innerHTML = 'üíæ';
      btn.style.background = '#28a745';
      btn.disabled = false;
      btn.style.cursor = 'pointer';
    }, 2000);
  }
}


    
/**
 * Refresh brand cache
 * ‚úÖ Updated for Firebase
 */
function refreshBrandAutocompleteCache() {
  brandCacheLoaded = false;
  loadBrandAutocompleteCache();
}



    
/**
 * ==========================================
 * INITIALIZE ON PAGE LOAD
 * ==========================================
 */

// Add event listeners when DOM is ready
document.addEventListener('DOMContentLoaded', function() {
  console.log('üé® Product Groups UI initialized');
 // ‚úÖ ADD THIS LINE - Load brand cache on page load
  loadBrandAutocompleteCache();

  
  // Add event listener for group name input (real-time preview)
  const groupNameInput = document.getElementById('groupName');
  if (groupNameInput) {
    groupNameInput.addEventListener('input', updateVariantPreview);
  }
  
  // Close modals on ESC key
  document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
      const createModal = document.getElementById('createGroupModal');
      const editModal = document.getElementById('editVariantModal');
      
      if (createModal && createModal.classList.contains('active')) {
        closeCreateGroupModal();
      }
      
      if (editModal && editModal.classList.contains('active')) {
        closeEditVariantModal();
      }
    }
  });
});


/**
 * ==========================================
 * UTILITY: Navigate to Home (Override if needed)
 * ==========================================
 */


/**
 * Create Product Group - FIREBASE VERSION
 * ‚úÖ This is the older/duplicate function - update to match the newer one
 */
async function createProductGroup(groupData) {
  const user = window.auth.currentUser;
  
  if (!user) {
    alert('Please sign in first');
    return;
  }
  
  try {
    const btn = document.getElementById('btnSaveGroup');
    if (btn) { 
      btn.disabled = true; 
      btn.innerHTML = '‚è≥ Creating...'; 
    }
    
    console.log('üì¶ Creating product group in Firestore:', groupData);
    
    const { collection, addDoc } = window.firebaseImports;
    
    // Save product group
    const groupsRef = collection(window.db, 'tenants', user.uid, 'productGroups');
    const groupDocRef = await addDoc(groupsRef, {
      groupName: groupData.groupName,
      description: groupData.description || '',
      manufacturer: groupData.manufacturer || '',
      brand: groupData.brand || groupData.manufacturer || '',
      category: groupData.category || '',
      attributes: groupData.attributes || {},
      totalVariants: 0, // Will be updated after variants are created
      createdBy: user.email,
      createdAt: new Date().toISOString(),
      userId: user.uid
    });
    
    console.log('‚úÖ Group created in Firestore:', groupDocRef.id);
    
    alert(`Success! Group "${groupData.groupName}" created.`);
    
    closeCreateGroupModal();
    
    setTimeout(() => {
      loadProductGroups();
    }, 500);
    
  } catch (error) {
    console.error('‚ùå Error creating product group:', error);
    alert('Error: ' + error.message);
  } finally {
    const btn = document.getElementById('btnSaveGroup');
    if (btn) { 
      btn.disabled = false; 
      btn.innerHTML = 'üíæ Save & Generate'; 
    }
  }
}













    

/**
 * ==========================================
 * NAVIGATE TO HOME - UPDATED WITH AUTO-LOAD
 * ==========================================
 */
function navigateToHome() {
  console.log('üè† Navigating to Home');
  
  currentPage = 'home';
  
  const mainApp = document.getElementById('mainApp');
  const allProductsPage = document.getElementById('allProductsPage');
  const productGroupsPage = document.getElementById('productGroupsPage');
  const customersPage = document.getElementById('customersPage');
  const groupDetailPage = document.getElementById('groupDetailPage');
  const brandsPage = document.getElementById('brandsPage');
  
  // Show main app
  if (mainApp) mainApp.style.display = 'block';
  
  // Hide all other pages
  if (allProductsPage) {
    allProductsPage.classList.remove('active');
    allProductsPage.style.display = 'none';
  }
  if (productGroupsPage) {
    productGroupsPage.classList.remove('active');
    productGroupsPage.style.display = 'none';
  }
  if (customersPage) {
    customersPage.classList.remove('active');
    customersPage.style.display = 'none';
  }
  if (brandsPage) {
    brandsPage.classList.remove('active');
    brandsPage.style.display = 'none';
  }
  if (groupDetailPage) {
    groupDetailPage.classList.remove('active');
    groupDetailPage.style.display = 'none';
  }
  
  // Show navbar
  const navbar = document.querySelector('.navbar');
  if (navbar) navbar.style.display = 'flex';
  
  window.scrollTo({ top: 0, behavior: 'smooth' });
  
  // ‚úÖ AUTO-LOAD SALES AND PURCHASES FOR HOMEPAGE
  console.log('üîÑ Loading sales and purchases...');
  
  if (typeof loadRecentSales === 'function') {
    loadRecentSales().catch(err => {
      console.error('‚ùå Failed to load sales:', err.message);
    });
  }
  
  if (typeof loadRecentPurchases === 'function') {
    loadRecentPurchases().catch(err => {
      console.error('‚ùå Failed to load purchases:', err.message);
    });
  }
  
  console.log('‚úÖ Home displayed');
}

/**
 * ==========================================
 * CENTRALIZED NAVIGATION FUNCTION - UPDATED
 * ==========================================
 */
function navigateTo(page) {
  console.log('üî∑ navigateTo called with:', page);
  
  if (page === 'dashboard') {
    navigateToHome();
  } else if (page === 'allProducts') {
    navigateToAllProducts();
  } else if (page === 'customers') {
    navigateToCustomers();
  } else if (page === 'productGroups') {
    navigateToProductGroups();
  } else if (page === 'brands') {
    navigateToBrands();
  } else if (page === 'sales') {
    // ‚úÖ Navigate to sales and load data
    navigateToSales();
  } else if (page === 'purchases') {
    // ‚úÖ Navigate to purchases and load data
    navigateToPurchases();
  } else if (page === 'invoices') {
    window.location.href = 'invoices.html';
  } else {
    console.error('‚ùå Unknown page:', page);
  }
}

/**
 * ==========================================
 * NAVIGATE TO SALES - NEW FUNCTION
 * ==========================================
 */
function navigateToSales() {
  console.log('üõí Navigating to Sales');
  
  // Your existing code to show sales page
  // (If you don't have a separate sales page, this might go to homepage)
  
  // ‚úÖ AUTO-LOAD SALES
  if (typeof loadRecentSales === 'function') {
    loadRecentSales().catch(err => {
      console.error('‚ùå Failed to load sales:', err.message);
    });
  }
  
  console.log('‚úÖ Sales page displayed');
}

/**
 * ==========================================
 * NAVIGATE TO PURCHASES - NEW FUNCTION
 * ==========================================
 */
function navigateToPurchases() {
  console.log('üì¶ Navigating to Purchases');
  
  // Your existing code to show purchases page
  // (If you don't have a separate purchases page, this might go to homepage)
  
  // ‚úÖ AUTO-LOAD PURCHASES
  if (typeof loadRecentPurchases === 'function') {
    loadRecentPurchases().catch(err => {
      console.error('‚ùå Failed to load purchases:', err.message);
    });
  }
  
  console.log('‚úÖ Purchases page displayed');
}



// Navigate to Group Detail - FIXED
function navigateToGroupDetail(groupId, groupName) {
  console.log('üì¶ Navigating to Group Detail:', groupName);
  
  currentPage = 'groupDetail';
  currentGroupId = groupId;
  
  const mainApp = document.getElementById('mainApp');
  const allProductsPage = document.getElementById('allProductsPage');
  const productGroupsPage = document.getElementById('productGroupsPage');
  const groupDetailPage = document.getElementById('groupDetailPage');
  
  // HIDE the main dashboard
  if (mainApp) {
    mainApp.style.display = 'none';
  }
  
  // ‚úÖ HIDE THE BLUE NAVBAR
  const navbar = document.querySelector('.navbar');
  if (navbar) {
    navbar.style.display = 'none';
  }
  
  // SHOW Group Detail page
  if (groupDetailPage) {
    groupDetailPage.classList.add('active');
  }
  
  if (allProductsPage) allProductsPage.classList.remove('active');
  if (productGroupsPage) productGroupsPage.classList.remove('active');
  
  // Set group title
  const groupTitleEl = document.getElementById('groupDetailTitle');
  if (groupTitleEl) {
    groupTitleEl.textContent = groupName;
  }
  
  // Load variants
  if (typeof syncGroupVariants === 'function') {
    syncGroupVariants(groupId);
  }
  
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Get product icon based on category
function getProductIcon(category) {
  const icons = {
    'Tiles': 'üî≤',
    'Sanitaryware': 'üöø',
    'Accessories': 'üîß',
    'Custom': 'üì¶',
    'Photo Products': 'üì∏'
  };
  return icons[category] || 'üì¶';
}





window.addEventListener('DOMContentLoaded', () => {
  // Wait longer for data to fully load
  setTimeout(() => {
    const urlParams = new URLSearchParams(window.location.search);
    const page = urlParams.get('page');
    
    if (!page) {
      console.log('‚úÖ No page parameter - Normal page load');
      return;
    }
    
    console.log('üîç URL page parameter detected:', page);
    
    // Route to appropriate page based on parameter
    switch(page) {
      case 'allProducts':
        console.log('üìç Routing: Invoices ‚Üí All Products');
        if (typeof navigateToAllProducts === 'function') {
          navigateToAllProducts();
        } else {
          console.error('‚ùå navigateToAllProducts function not found');
        }
        break;
        
      case 'productGroups':
        console.log('üìç Routing: Invoices ‚Üí Product Groups');
        if (typeof navigateToProductGroups === 'function') {
          navigateToProductGroups();
        } else {
          console.error('‚ùå navigateToProductGroups function not found');
        }
        break;
        
      case 'customers':
        console.log('üìç Routing: Invoices ‚Üí Customers');
        if (typeof navigateToCustomers === 'function') {
          navigateToCustomers();
        } else {
          console.error('‚ùå navigateToCustomers function not found');
        }
        break;
      
      case 'brands':
        console.log('üìç Routing: Invoices ‚Üí Brands');
        if (typeof navigateToBrands === 'function') {
          navigateToBrands();
        } else {
          console.error('‚ùå navigateToBrands function not found');
        }
        break;
        
      default:
        console.warn('‚ö†Ô∏è Unknown page parameter:', page);
    }
    
    // === ‚úÖ CLEAN URL AFTER NAVIGATION ===
    // Remove the query parameter so it doesn't persist on reload
    window.history.replaceState({}, document.title, window.location.pathname);
    console.log('üßπ URL cleaned - page parameter removed');
    
  }, 800);  // Wait 800ms for data to fully load
});

// Navigate to Purchase Orders page
function navigateToPurchaseOrders() {
  // Close sidebar
  closeSidebar();
  
  // Redirect to purchase page
  window.location.href = 'purchase.html';
}



/**
 * ==========================================
 * SHARE INVOICE DROPDOWN FIX
 * ==========================================
 */

document.addEventListener('DOMContentLoaded', function() {
  console.log('üöÄ Initializing Share Invoice dropdown...');
  
  // Find all share invoice buttons
  const shareButtons = document.querySelectorAll('[data-bs-toggle="dropdown"]');
  console.log('üìä Found', shareButtons.length, 'dropdown buttons');
  
  shareButtons.forEach((btn, index) => {
    // Add click handler to each button
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      e.stopPropagation();
      
      console.log('üîò Share button clicked');
      
      // Find the next dropdown menu
      let menu = this.nextElementSibling;
      
      // If next sibling isn't a dropdown, search for it
      if (!menu || !menu.classList.contains('dropdown-menu')) {
        menu = this.parentElement.querySelector('.dropdown-menu');
      }
      
      if (menu) {
        // Toggle the dropdown
        menu.classList.toggle('show');
        console.log('‚úÖ Dropdown toggled:', menu.classList.contains('show'));
        
        // Force styles
        if (menu.classList.contains('show')) {
          menu.style.display = 'block';
          menu.style.visibility = 'visible';
          menu.style.opacity = '1';
        } else {
          menu.style.display = 'none';
        }
      } else {
        console.warn('‚ö†Ô∏è Dropdown menu not found');
      }
    });
  });
  
  // Close dropdowns when clicking outside
  document.addEventListener('click', function(e) {
    const menus = document.querySelectorAll('.dropdown-menu.show');
    menus.forEach(menu => {
      const btn = menu.previousElementSibling;
      if (btn && !btn.contains(e.target) && !menu.contains(e.target)) {
        menu.classList.remove('show');
        menu.style.display = 'none';
        console.log('‚úÖ Dropdown closed');
      }
    });
  });
  
  console.log('‚úÖ Share Invoice dropdown initialized');
});

    


/**
 * ==========================================
 * AUTO-LOAD SALES & PURCHASES ON PAGE LOAD
 * ==========================================
 */

// Simple auto-load that works with your existing auth system
window.addEventListener('load', function() {
  console.log('üîÑ Page loaded, initializing sales & purchases...');
  
  // Wait for user to be authenticated (check every 500ms)
  const checkAndLoadInterval = setInterval(() => {
    const user = window.auth?.currentUser;
    
    if (user) {
      console.log('‚úÖ User authenticated:', user.email);
      clearInterval(checkAndLoadInterval);
      
      // Load sales and purchases after a short delay
      setTimeout(() => {
        console.log('üì¶ Auto-loading sales and purchases...');
        
        // Load purchases
        if (typeof loadRecentPurchases === 'function') {
          loadRecentPurchases().catch(err => {
            console.error('‚ùå Failed to load purchases:', err.message);
          });
        }
        
        // Load sales
        if (typeof loadRecentSales === 'function') {
          loadRecentSales().catch(err => {
            console.error('‚ùå Failed to load sales:', err.message);
          });
        }
        
        console.log('‚úÖ Auto-load initiated');
      }, 1000);
    }
  }, 500);
  
  // Stop checking after 15 seconds
  setTimeout(() => {
    clearInterval(checkAndLoadInterval);
    console.log('‚è±Ô∏è Stopped checking for authentication');
  }, 15000);
});

/**
 * ==========================================
 * LOAD RECENT SALES FROM FIRESTORE
 * ==========================================
 */
async function loadRecentSales() {
  console.log('üõí Loading recent sales from Firestore...');
  
  const user = window.auth?.currentUser;
  if (!user) {
    console.error('‚ùå User not authenticated');
    return;
  }
  
  const tbody = document.getElementById('salesList');
  
  if (!tbody) {
    console.error('‚ùå Sales table not found');
    return;
  }
  
  tbody.innerHTML = `
    <tr>
      <td colspan="5" style="text-align: center; padding: 20px;">
        <span class="spinner-border spinner-border-sm"></span> Loading sales...
      </td>
    </tr>
  `;
  
  try {
    const { collection, getDocs } = window.firebaseImports;
    
    // ‚úÖ REMOVE orderBy - just get all sales
    const salesRef = collection(window.db, 'tenants', user.uid, 'sales');
    const snapshot = await getDocs(salesRef);
    
    console.log(`‚úÖ Got ${snapshot.size} sales from Firestore`);
    
    const sales = [];
    snapshot.forEach((doc) => {
      sales.push({
        id: doc.id,
        ...doc.data()
      });
    });
    
    // Sort by date in JavaScript (more flexible)
    sales.sort((a, b) => {
      const dateA = a.date ? new Date(a.date).getTime() : 0;
      const dateB = b.date ? new Date(b.date).getTime() : 0;
      return dateB - dateA; // Newest first
    });
    
    console.log('‚úÖ Sales loaded and sorted:', sales.length);
    
    displayRecentSales(sales);
    window.cachedSales = sales;
    
  } catch (error) {
    console.error('‚ùå Error loading sales:', error);
    tbody.innerHTML = `
      <tr>
        <td colspan="5" style="text-align: center; padding: 20px; color: #dc3545;">
          <i class="bi bi-exclamation-triangle"></i> Failed to load sales<br>
          <small>${error.message}</small>
        </td>
      </tr>
    `;
  }
}

/**
 * Display sales in Recent Sales table - FIXED
 */
function displayRecentSales(sales) {
  const tbody = document.getElementById('salesList');
  
  if (!tbody) {
    console.error('‚ùå Sales table not found');
    return;
  }
  
  if (!sales || sales.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="5" style="text-align: center; padding: 20px; color: #999;">
          <i class="bi bi-inbox"></i> No sales recorded yet
        </td>
      </tr>
    `;
    return;
  }
  
  let html = '';
  
  sales.forEach((sale) => {
    // ‚úÖ FIXED: Handle date properly
    let dateStr = '-';
    if (sale.date) {
      try {
        const date = new Date(sale.date);
        if (!isNaN(date.getTime())) {
          dateStr = date.toLocaleString('en-IN', {
            day: '2-digit',
            month: 'short',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
        }
      } catch (e) {
        console.error('Invalid date:', sale.date);
      }
    } else if (sale.createdAt) {
      try {
        const date = new Date(sale.createdAt);
        if (!isNaN(date.getTime())) {
          dateStr = date.toLocaleString('en-IN', {
            day: '2-digit',
            month: 'short',
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          });
        }
      } catch (e) {
        console.error('Invalid createdAt:', sale.createdAt);
      }
    }
    
    // ‚úÖ FIXED: Extract product info from multiple possible structures
    let productsStr = '-';
    let totalQty = 0;
    let unit = 'pcs';
    
    // Check different possible product data structures
    if (sale.products && Array.isArray(sale.products) && sale.products.length > 0) {
      // Structure 1: Array of product objects
      const productNames = sale.products
        .map(p => {
          // Get product name from various possible fields
          const name = p.name || p.product || p.productName || 'Unknown';
          const qty = p.quantity || p.qty || 0;
          totalQty += Number(qty);
          
          // Get unit type
          if (p.unitType || p.unit) {
            unit = p.unitType || p.unit;
          }
          
          return name;
        })
        .filter(n => n && n !== 'Unknown');
      
      if (productNames.length > 2) {
        productsStr = productNames.slice(0, 2).join(', ') + `... (+${productNames.length - 2} more)`;
      } else if (productNames.length > 0) {
        productsStr = productNames.join(', ');
      }
    } else if (sale.productName) {
      // Structure 2: Single product in productName field
      productsStr = sale.productName;
      totalQty = sale.quantity || 0;
      unit = sale.unitType || 'pcs';
    } else if (typeof sale.products === 'string') {
      // Structure 3: Products as string
      productsStr = sale.products;
      totalQty = sale.quantity || 0;
    }
    
    // ‚úÖ FIXED: Get amount from multiple possible fields
    const amount = sale.totalAmount || sale.grandTotal || sale.amount || 0;
    
    html += `
      <tr onclick="viewSaleDetail('${sale.id}')" style="cursor: pointer; transition: background 0.2s;">
        <td style="white-space: nowrap;">${dateStr}</td>
        <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" 
            title="${escapeHtml(productsStr)}">
          ${escapeHtml(productsStr)}
        </td>
        <td style="text-align: center;">${totalQty}</td>
        <td>${unit}</td>
        <td style="font-weight: 600; color: #28a745;">‚Çπ${Number(amount).toFixed(2)}</td>
      </tr>
    `;
  });
  
  tbody.innerHTML = html;
  
  console.log('‚úÖ Displayed', sales.length, 'sales in Recent Sales table');
}
/**
 * ==========================================
 * VIEW SALE DETAIL - FIXED FOR BOTH STRUCTURES
 * ==========================================
 */
function viewSaleDetail(saleId) {
  console.log('üìÑ Viewing sale detail:', saleId);
  
  const sale = window.cachedSales?.find(s => s.id === saleId);
  
  if (!sale) {
    alert('‚ùå Sale not found');
    return;
  }
  
  console.log('üìä Sale data:', sale); // Debug log
  
  // ‚úÖ Extract products from different possible structures
  let products = [];
  
  if (Array.isArray(sale.products) && sale.products.length > 0) {
    // Structure 1: Array of products
    products = sale.products;
  } else if (sale.productName) {
    // Structure 2: Single product fields (productName, quantity, etc.)
    products = [{
      name: sale.productName,
      product: sale.productName,
      quantity: sale.quantity,
      qty: sale.quantity,
      unitType: sale.unitType,
      unit: sale.unitType,
      price: sale.unitPrice || (sale.totalAmount / (sale.quantity || 1)),
      unitPrice: sale.unitPrice
    }];
  } else if (typeof sale.products === 'string') {
    // Structure 3: Products as string
    products = [{
      name: sale.products,
      product: sale.products,
      quantity: sale.quantity || 1,
      qty: sale.quantity || 1,
      unitType: sale.unitType || 'pcs',
      unit: sale.unitType || 'pcs',
      price: sale.totalAmount || 0,
      unitPrice: sale.unitPrice || 0
    }];
  }
  
  console.log('üì¶ Extracted products:', products);
  
  // ‚úÖ Get total amount
  const totalAmount = sale.totalAmount || sale.grandTotal || sale.amount || 0;
  
  // Build detail HTML
  let html = `
    <div style="padding: 15px;">
      <div class="card mb-3">
        <div class="card-header bg-primary text-white">
          <strong>Sale Information</strong>
        </div>
        <div class="card-body">
          <div class="row mb-2">
            <div class="col-6"><strong>Date:</strong></div>
            <div class="col-6">${new Date(sale.date || sale.createdAt).toLocaleString('en-IN')}</div>
          </div>
          <div class="row mb-2">
            <div class="col-6"><strong>Total Amount:</strong></div>
            <div class="col-6" style="font-size: 1.3rem; color: #28a745; font-weight: 700;">
              ‚Çπ${Number(totalAmount).toFixed(2)}
            </div>
          </div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-header bg-primary text-white">
          <strong>Products</strong>
        </div>
        <div class="card-body">
  `;
  
  if (products.length > 0) {
    html += `
          <table class="table table-sm table-bordered">
            <thead class="table-light">
              <tr>
                <th>Product</th>
                <th>Qty</th>
                <th>Unit</th>
                <th>Price</th>
                <th>Total</th>
              </tr>
            </thead>
            <tbody>
    `;
    
    products.forEach(p => {
      const qty = Number(p.quantity || p.qty || 1);
      const price = Number(p.unitPrice || p.price || 0);
      const total = qty * price;
      const productName = p.name || p.product || p.productName || 'Unknown Product';
      const unit = p.unitType || p.unit || 'pcs';
      
      html += `
        <tr>
          <td>${escapeHtml(productName)}</td>
          <td>${qty}</td>
          <td>${unit}</td>
          <td>‚Çπ${price.toFixed(2)}</td>
          <td style="font-weight: 600;">‚Çπ${total.toFixed(2)}</td>
        </tr>
      `;
    });
    
    html += `
            </tbody>
          </table>
    `;
  } else {
    html += `
          <p class="text-muted text-center mb-0">No product details available</p>
    `;
  }
  
  html += `
        </div>
      </div>
      
      <div class="text-center mt-3">
        <button class="btn btn-danger" onclick="confirmDeleteSale('${sale.id}')">
          <i class="bi bi-trash"></i> Delete Sale
        </button>
      </div>
    </div>
  `;
  
  // Create or update modal
  let modal = document.getElementById('saleDetailModal');
  if (!modal) {
    modal = document.createElement('div');
    modal.className = 'modal fade';
    modal.id = 'saleDetailModal';
    modal.innerHTML = `
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header bg-primary text-white">
            <h5 class="modal-title">
              <i class="bi bi-receipt"></i> Sale Details
            </h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body" id="saleDetailContent"></div>
        </div>
      </div>
    `;
    document.body.appendChild(modal);
  }
  
  document.getElementById('saleDetailContent').innerHTML = html;
  
  const bsModal = new bootstrap.Modal(modal);
  bsModal.show();
}

/**
 * Confirm delete sale
 */
async function confirmDeleteSale(saleId) {
  if (!confirm('Are you sure you want to delete this sale? This cannot be undone.')) {
    return;
  }
  
  const user = window.auth?.currentUser;
  if (!user) {
    alert('Please sign in first');
    return;
  }
  
  try {
    const { doc, deleteDoc } = window.firebaseImports;
    
    const saleDoc = doc(window.db, 'tenants', user.uid, 'sales', saleId);
    await deleteDoc(saleDoc);
    
    alert('‚úÖ Sale deleted successfully!');
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('saleDetailModal'));
    if (modal) modal.hide();
    
    // Reload sales list
    await loadRecentSales();
    
  } catch (error) {
    console.error('‚ùå Error deleting sale:', error);
    alert('‚ùå Failed to delete sale: ' + error.message);
  }
}




  

/**
 * ==========================================
 * MAKE ALL FUNCTIONS GLOBAL FOR BUTTONS
 * ==========================================
 */

// Make functions available globally for onclick attributes
window.generateInvoice = generateInvoice;
window.openRecordPurchaseModal = openRecordPurchaseModal;
window.showAllProducts = showAllProducts;
window.showPhotoProducts = showPhotoProducts;
window.toggleSidebar = toggleSidebar;
window.openSalesModal = openSalesModal;
window.openAddProduct = openAddProduct;
window.openProductByPhotoModal = openProductByPhotoModal;

// Navigation functions
window.navigateToHome = navigateToHome;
window.navigateToProducts = navigateToProducts;
window.navigateToSales = navigateToSales;
window.navigateToInvoices = navigateToInvoices;
window.navigateToPurchases = navigateToPurchases;
window.navigateToCustomers = navigateToCustomers;
window.navigateToBrands = navigateToBrands;

// Modal functions
window.saveProduct = saveProduct;
window.saveSale = saveSale;
window.saveInvoice = saveInvoice;
window.savePurchase = savePurchase;
window.saveCustomer = saveCustomer;

// Close functions
window.closeAddProductModal = closeAddProductModal;
window.closeRecordSaleModal = closeRecordSaleModal;
window.closeGenerateInvoiceModal = closeGenerateInvoiceModal;
window.closeRecordPurchaseModal = closeRecordPurchaseModal;

// Other functions
window.deleteProduct = deleteProduct;
window.editProduct = editProduct;
window.deleteSale = deleteSale;
window.deleteInvoice = deleteInvoice;
window.deletePurchase = deletePurchase;
window.deleteCustomer = deleteCustomer;

console.log('‚úÖ All functions made globally available');




    /**
 * ==========================================
 * MAKE PURCHASE FUNCTIONS GLOBAL
 * ==========================================
 */
window.submitPurchaseEntry = submitPurchaseEntry;
window.loadRecentPurchases = loadRecentPurchases;
window.openRecordPurchaseModal = openRecordPurchaseModal;
window.closeRecordPurchaseModal = closeRecordPurchaseModal;
window.addPurchaseProductRow = addPurchaseProductRow;
window.removePurchaseProductRow = removePurchaseProductRow;
window.calculatePurchaseRowAmount = calculatePurchaseRowAmount;
window.viewPurchaseDetail = viewPurchaseDetail;
window.confirmDeletePurchase = confirmDeletePurchase;
window.handlePurchasePhotoUpload = handlePurchasePhotoUpload;
window.clearPurchasePhoto = clearPurchasePhoto;
window.openPurchaseCamera = openPurchaseCamera;
window.togglePaymentSection = togglePaymentSection;
window.triggerPhotoInput = triggerPhotoInput;
window.viewPurchasePhotoPreview = viewPurchasePhotoPreview;
window.openPurchasePhotoLightbox = openPurchasePhotoLightbox;
window.togglePaymentModeCheckmark = togglePaymentModeCheckmark;

console.log('‚úÖ Purchase functions made globally available');


    /**
 * ==========================================
 * MAKE FUNCTIONS GLOBALLY AVAILABLE
 * ==========================================
 */
window.navigateToHome = navigateToHome;
window.navigateTo = navigateTo;
window.navigateToSales = navigateToSales;
window.navigateToPurchases = navigateToPurchases;
window.navigateToAllProducts = navigateToAllProducts;
window.navigateToCustomers = navigateToCustomers;
window.navigateToProductGroups = navigateToProductGroups;
window.navigateToBrands = navigateToBrands;
window.loadRecentSales = loadRecentSales;
window.loadRecentPurchases = loadRecentPurchases;

console.log('‚úÖ Navigation functions made globally available');

/**
 * Make sales functions globally available
 */
window.loadRecentSales = loadRecentSales;
window.displayRecentSales = displayRecentSales;
window.saveSaleToSheet = saveSaleToSheet;
window.viewSaleDetail = viewSaleDetail;
window.confirmDeleteSale = confirmDeleteSale;

console.log('‚úÖ Sales functions made globally available');

    
  </script>

 <!-- √É¬¢√Ö‚Äú√¢‚Ç¨¬¶ NEW: Change Password Modal -->
  <div id="changePasswordModal" class="modal fade" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">
            <i class="bi bi-key me-2"></i>Change Password
          </h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <!-- Step 1: Verify Current Password -->
          <div id="verifyPasswordStep">
            <p class="text-muted">Enter your current password to continue</p>
            <div class="mb-3">
              <label class="form-label">Current Password</label>
              <input 
                type="password" 
                id="currentPasswordInput" 
                class="form-control" 
                placeholder="Enter current password"
                required
              >
            </div>
            <div class="d-grid">
              <button class="btn btn-primary" onclick="verifyCurrentPassword()">
                Continue
              </button>
            </div>
          </div>
          
          <!-- Step 2: Enter New Password -->
          <div id="newPasswordStep" style="display: none;">
            <p class="text-muted">Choose a new password (minimum 6 characters)</p>
            <div class="mb-3">
              <label class="form-label">New Password</label>
              <input 
                type="password" 
                id="newPasswordInput" 
                class="form-control" 
                placeholder="Enter new password"
                minlength="6"
                required
              >
            </div>
            <div class="mb-3">
              <label class="form-label">Confirm New Password</label>
              <input 
                type="password" 
                id="confirmPasswordInput" 
                class="form-control" 
                placeholder="Re-enter new password"
                minlength="6"
                required
              >
            </div>
            <div class="d-grid">
              <button class="btn btn-success" onclick="submitNewPassword()">
                <i class="bi bi-check-circle me-2"></i>Change Password
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<!-- √¢≈ì‚Ä¶ NEW: WhatsApp Number Input Modal -->
<div class="modal fade" id="whatsappNumberModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">
          <i class="bi bi-whatsapp"></i> Share Invoice on WhatsApp
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div class="alert alert-info">
          <i class="bi bi-info-circle"></i> Enter the recipient's WhatsApp number (with country code)
        </div>
        
        <div class="mb-3">
          <label class="form-label">WhatsApp Number</label>
          <div class="input-group">
            <span class="input-group-text">+91</span>
            <input type="tel" 
                   class="form-control" 
                   id="whatsappNumberInput" 
                   placeholder="9876543210" 
                   maxlength="10"
                   pattern="[0-9]{10}"
                   required>
          </div>
          <small class="text-muted">Enter 10-digit mobile number (without +91)</small>
        </div>
        
        <div class="form-check mb-3">
          <input class="form-check-input" type="checkbox" id="saveWhatsAppNumber">
          <label class="form-check-label" for="saveWhatsAppNumber">
            Remember this number for next time
          </label>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Cancel
        </button>
        <button type="button" class="btn btn-success" onclick="sendInvoiceToWhatsApp()">
          <i class="bi bi-whatsapp"></i> Send to WhatsApp
        </button>
      </div>
    </div>
  </div>
</div>
<!-- Product Detail Modal -->
<div class="modal fade" id="productDetailModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Product Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="productDetailModalBody">
        <!-- Content will be inserted here -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<!-- ‚úÖ‚úÖ‚úÖ CUSTOMER MODAL (Add/Edit) ‚úÖ‚úÖ‚úÖ -->
<div class="modal fade" id="customerModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="customerFormTitle">Add Customer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="customerForm">
          <input type="hidden" id="customerId">
          
          <!-- Customer Type -->
          <div class="mb-3">
            <label class="form-label">Customer Type *</label>
            <div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="customerType" id="typeBusiness" value="Business" checked>
                <label class="form-check-label" for="typeBusiness">
                  üè¢ Business
                </label>
              </div>
              <div class="form-check form-check-inline">
                <input class="form-check-input" type="radio" name="customerType" id="typeIndividual" value="Individual">
                <label class="form-check-label" for="typeIndividual">
                  üë§ Individual
                </label>
              </div>
            </div>
          </div>
          
          <!-- Customer Name -->
          <div class="mb-3">
            <label for="customerName" class="form-label">Customer Name *</label>
            <input type="text" class="form-control" id="customerName" required>
          </div>
          
          <!-- Advanced Options Toggle -->
          <div class="mb-3">
            <a href="javascript:void(0)" onclick="toggleAdvancedOptions()" class="text-primary">
              <i class="bi bi-chevron-down"></i> Advanced Options
            </a>
          </div>
          
          <!-- Advanced Options Container (Hidden by default) -->
          <div id="advancedOptionsContainer" style="display:none;">
            <!-- Phone Number -->
            <div class="mb-3">
              <label for="customerPhone" class="form-label">Phone Number</label>
              <input type="tel" class="form-control" id="customerPhone" placeholder="+91-9876543210">
            </div>
            
            <!-- Email -->
            <div class="mb-3">
              <label for="customerEmail" class="form-label">Email Address</label>
              <input type="email" class="form-control" id="customerEmail" placeholder="customer@example.com">
            </div>
            
            <!-- Address -->
            <div class="mb-3">
              <label for="customerAddress" class="form-label">Billing/Shipping Address</label>
              <textarea class="form-control" id="customerAddress" rows="3" placeholder="Enter complete address"></textarea>
            </div>
            
            <!-- Other Info -->
            <div class="mb-3">
              <label for="customerOtherInfo" class="form-label">Any Other Information</label>
              <textarea class="form-control" id="customerOtherInfo" rows="2" placeholder="Additional notes, preferences, etc."></textarea>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveCustomer()">Save Customer</button>
      </div>
    </div>
  </div>
</div>
<!-- ‚úÖ‚úÖ‚úÖ CUSTOMER DETAIL MODAL ‚úÖ‚úÖ‚úÖ -->
<div class="modal fade" id="customerDetailModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="detailCustomerName">Customer Details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <!-- Tab Navigation -->
        <ul class="nav nav-tabs mb-3">
          <li class="nav-item">
            <a class="nav-link active customer-tab-btn" href="javascript:void(0)" onclick="showCustomerTab('info')">
              <i class="bi bi-info-circle"></i> Info
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link customer-tab-btn" href="javascript:void(0)" onclick="showCustomerTab('transactions')">
              <i class="bi bi-receipt"></i> Transactions
            </a>
          </li>
          <li class="nav-item">
            <a class="nav-link customer-tab-btn" href="javascript:void(0)" onclick="showCustomerTab('invoices')">
              <i class="bi bi-file-text"></i> Invoices
            </a>
          </li>
        </ul>
        
        <!-- Tab Content -->
        <div id="customerInfoTab">
          <table class="table">
            <tr>
              <th width="30%">Type:</th>
              <td id="detailCustomerType">-</td>
            </tr>
            <tr>
              <th>Phone:</th>
              <td id="detailCustomerPhone">-</td>
            </tr>
            <tr>
              <th>Email:</th>
              <td id="detailCustomerEmail">-</td>
            </tr>
            <tr>
              <th>Address:</th>
              <td id="detailCustomerAddress">-</td>
            </tr>
          </table>
        </div>
        
        <div id="customerTransactionsTab" style="display:none;">
          <div id="customerTransactionsList">
            <p class="text-center text-muted">Loading transactions...</p>
          </div>
        </div>
        
        <div id="customerInvoicesTab" style="display:none;">
          <div id="customerInvoicesList">
            <p class="text-center text-muted">No invoices yet</p>
          </div>
          <button class="btn btn-success mt-3" onclick="createInvoiceForCustomer()">
            <i class="bi bi-plus-lg"></i> Create New Invoice
          </button>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" onclick="openEditCustomerModal(currentCustomerId)">
          <i class="bi bi-pencil"></i> Edit
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Add Brands Modal -->
<div class="modal fade" id="addBrandsModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">‚ûï Add New Brands</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        
        <!-- Instructions -->
        <p style="color: #666; margin-bottom: 15px; font-size: 14px;">
          Enter brand names below. Press <strong>Enter</strong> or <strong>Comma (,)</strong> after each brand:
        </p>
        
        <!-- Input Field -->
        <input id="brandInput" type="text" class="form-control" placeholder="e.g., Somany"
          onkeydown="handleBrandInputKeydown(event)">
        
        <!-- Preview Section -->
        <div style="margin-top: 20px;">
          <p style="font-weight: bold; margin-bottom: 10px; font-size: 14px;" id="previewCount">
            üìù Brands to Save (0):
          </p>
          <div id="brandPreviewList" style="
            background: #f8f9fa; border: 1px solid #e0e0e0;
            border-radius: 5px; max-height: 200px; overflow-y: auto;
            min-height: 60px; padding: 10px;
          ">
            <div style="padding: 10px; color: #999; text-align: center; font-size: 14px;">
              No brands added yet
            </div>
          </div>
        </div>
        
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="saveAllBrands()">üíæ Save All</button>
      </div>
    </div>
  </div>
</div>



<!-- BULK MODAL FOR INVOICE -->
<div class="modal fade" id="bulkAddModal" tabindex="-1" backdrop="static">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-info text-white">
        <h5 class="modal-title">
          <i class="bi bi-collection"></i> Add Items in Bulk - Invoice
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      
      <div class="modal-body">
        <input type="text" class="form-control mb-3" id="bulkSearchInput" 
               placeholder="Type to search products..."
               oninput="filterBulkProducts(this.value)">
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-height: 400px;">
          <div>
            <h6 class="border-bottom pb-2"><i class="bi bi-box"></i> Products</h6>
            <div id="bulkProductsList" style="overflow-y: auto; max-height: 350px; border: 1px solid #ddd; border-radius: 4px; background: white;"></div>
          </div>
          <div>
            <h6 class="border-bottom pb-2">
              <i class="bi bi-check-circle"></i> Selected 
              <span class="badge bg-info" id="bulkSelectedCount">0</span>
            </h6>
            <div style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">
              Total Qty: <strong id="bulkTotalQty">0</strong>
            </div>
            <div id="bulkSelectedItems" style="overflow-y: auto; max-height: 320px; border: 1px solid #ddd; border-radius: 4px; background: #f9f9f9;"></div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-info" onclick="addBulkProductsToInvoice()">
          <i class="bi bi-plus-circle"></i> Add Items
        </button>
      </div>
    </div>
  </div>
</div>












  

<!-- BULK MODAL FOR SALE -->
<div class="modal fade" id="bulkAddModalForSale" tabindex="-1" backdrop="static">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title">
          <i class="bi bi-collection"></i> Add Items in Bulk - Sale
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      
      <div class="modal-body">
        <input type="text" class="form-control mb-3" id="bulkSearchInputSale" 
               placeholder="Type to search products..."
               oninput="filterBulkProductsSale(this.value)">
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-height: 400px;">
          <div>
            <h6 class="border-bottom pb-2"><i class="bi bi-box"></i> Products</h6>
            <div id="bulkProductsListSale" style="overflow-y: auto; max-height: 350px; border: 1px solid #ddd; border-radius: 4px; background: white;"></div>
          </div>
          <div>
            <h6 class="border-bottom pb-2">
              <i class="bi bi-check-circle"></i> Selected 
              <span class="badge bg-primary" id="bulkSelectedCountSale">0</span>
            </h6>
            <div style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">
              Total Qty: <strong id="bulkTotalQtySale">0</strong>
            </div>
            <div id="bulkSelectedItemsSale" style="overflow-y: auto; max-height: 320px; border: 1px solid #ddd; border-radius: 4px; background: #f9f9f9;"></div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-primary" onclick="addBulkProductsToSale()">
          <i class="bi bi-plus-circle"></i> Add Items
        </button>
      </div>
    </div>
  </div>
</div>



  

<!-- BULK MODAL -->
<div class="modal fade" id="bulkAddModalForPurchase" tabindex="-1" backdrop="static">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-success text-white">
        <h5 class="modal-title">
          <i class="bi bi-collection"></i> Add Items in Bulk
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      
      <div class="modal-body">
        <input type="text" class="form-control mb-3" id="bulkSearchInputPurchase" 
               placeholder="Type to search products..."
               oninput="filterBulkProductsPurchase(this.value)">
        
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-height: 400px;">
          <div>
            <h6 class="border-bottom pb-2"><i class="bi bi-box"></i> Products</h6>
            <div id="bulkProductsListPurchase" style="overflow-y: auto; max-height: 350px; border: 1px solid #ddd; border-radius: 4px; background: white;"></div>
          </div>
          <div>
            <h6 class="border-bottom pb-2">
              <i class="bi bi-check-circle"></i> Selected 
              <span class="badge bg-primary" id="bulkSelectedCountPurchase">0</span>
            </h6>
            <div style="font-size: 0.9rem; color: #666; margin-bottom: 10px;">
              Total Qty: <strong id="bulkTotalQtyPurchase">0</strong>
            </div>
            <div id="bulkSelectedItemsPurchase" style="overflow-y: auto; max-height: 320px; border: 1px solid #ddd; border-radius: 4px; background: #f9f9f9;"></div>
          </div>
        </div>
      </div>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" onclick="addBulkProductsToPurchase()">
          <i class="bi bi-plus-circle"></i> Add Items
        </button>
      </div>
    </div>
  </div>
</div>



  

<!-- ==========================================
     RECORD PURCHASE MODAL (FINAL)
     ========================================== -->
<div class="modal fade" id="recordPurchaseModal" tabindex="-1" backdrop="static" keyboard="false">
  <div class="modal-dialog modal-fullscreen">
    <div class="modal-content">
      
      <!-- Header -->
      <div class="modal-header" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 8px 12px;">
        <h6 class="modal-title" style="font-size: 0.95rem; font-weight: 600; margin: 0;">
          üì¶ RECORD PURCHASE
        </h6>
        <button type="button" class="btn-close btn-close-white btn-sm" onclick="closeRecordPurchaseModal()" style="padding: 4px;"></button>
      </div>
      
      <!-- Body -->
      <div class="modal-body" style="background: #fff; padding: 10px; overflow-y: auto;">
        
     <!-- Styles -->
<style>
  #recordPurchaseModal .form-label {
    font-size: 11px;
    font-weight: 700;
    color: #333;
    margin: 0 0 3px 0;
    display: block;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  #recordPurchaseModal .form-control,
  #recordPurchaseModal .form-select {
    font-size: 14px;
    padding: 5px 8px;
    border: 1px solid #ccc;
    border-radius: 3px;
    height: 32px;
  }
  #recordPurchaseModal .form-control:focus,
  #recordPurchaseModal .form-select:focus {
    border-color: #28a745;
    box-shadow: 0 0 0 0.15rem rgba(40, 167, 69, 0.2);
    outline: none;
  }
  #recordPurchaseModal .btn-sm {
    font-size: 12px;
    padding: 4px 10px;
    height: 28px;
  }
  #recordPurchaseModal .section-gap {
    height: 8px;
  }
  #purchasePhotoPreview {
    border: 1.5px dashed #ccc;
    border-radius: 4px;
    padding: 6px;
    text-align: center;
    background: #fafafa;
    cursor: pointer;
    min-height: 50px;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
  }
  #purchasePhotoPreview i {
    font-size: 1.5rem;
    color: #999;
  }
  #purchasePhotoPreview p {
    font-size: 10px;
    color: #666;
    margin: 2px 0 0 0;
  }
  /* Product rows - DARKER GRAY */
  .purchase-product-row {
    padding: 8px 0;
    margin-bottom: 10px;
    background: #e0e0e0;
    border: 1px solid #bdbdbd;
    border-radius: 5px;
    position: relative;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  /* Mobile: 3 separate lines */
  @media (max-width: 767px) {
    .purchase-product-row {
      display: block;
      padding: 8px;
    }
    .product-name-line { margin-bottom: 6px; }
    .product-details-line {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 6px;
      margin-bottom: 6px;
    }
    .product-amount-line { display: block; }
    .purchase-field-label {
      font-size: 9px; font-weight: 600; color: #666; margin-bottom: 2px; text-transform: uppercase;
    }
    .purchase-remove-btn {
      position: absolute; top: 4px; right: 4px; width: 24px; height: 24px; padding: 0; font-size: 14px; border-radius: 3px;
    }
  }
  /* Desktop - FORCE WIDE GRID & CONTAINER */
  @media (min-width: 768px) {
    #recordPurchaseModal .modal-dialog {
      max-width: 1400px !important;
      min-width: 900px !important;
      width: 95vw !important;
      margin: 1.75rem auto !important;
    }
    #recordPurchaseModal .modal-content,
    #recordPurchaseModal .modal-body {
      width: 100% !important;
      min-width: 0 !important;
      box-sizing: border-box !important;
      padding: 16px 30px !important;
    }
    .purchase-product-row {
      display: grid;
      grid-template-columns: 7fr 2fr 2fr 2.2fr 2.2fr 80px;
      gap: 16px;
      align-items: center;
      padding: 10px 12px;
      width: 100% !important;
      max-width: 100% !important;
      box-sizing: border-box !important;
    }
    .purchase-field-label { display: none; }
    .product-name-line,
    .product-details-line,
    .product-amount-line { display: contents; }
    /* All product row inputs full width */
    .purchase-product-row input,
    .purchase-product-row select {
      width: 100% !important;
      min-width: 0 !important;
      max-width: none !important;
    }
    /* Product grid container and parent always full width */
    #purchaseProductRows,
    .desktop-product-layout,
    .desktop-product-layout > div {
      width: 100% !important;
      min-width: 0 !important;
      max-width: 100% !important;
      box-sizing: border-box !important;
    }
    /* Desktop header columns - match exactly */
    .desktop-header > div {
      display: grid !important;
      grid-template-columns: 7fr 2fr 2fr 2.2fr 2.2fr 80px !important;
      gap: 16px !important;
      width: 100% !important;
      box-sizing: border-box !important;
    }
  }
  /* Payment hidden by default */
  #paymentSection { display: none; }
  #paymentSection.show { display: block; }
  .payment-toggle {
    font-size: 12px; color: #28a745; cursor: pointer; text-decoration: underline; margin-top: 4px; display: inline-block;
  }
</style>

        
      <!-- Photo -->
<label class="form-label">üì∑ Photo (Optional)</label>
<div id="purchasePhotoPreview" onclick="triggerPhotoInput()" style="
  border: 2px dashed #ccc;
  padding: 20px;
  text-align: center;
  cursor: pointer;
  border-radius: 8px;
  background: #f8f9fa;
  transition: all 0.2s;
  min-height: 120px;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
">
  <i class="bi bi-camera" style="font-size: 2rem; color: #999;"></i>
  <p style="color: #999; margin: 8px 0 0 0; font-size: 0.9rem;">Tap or paste photo</p>
</div>

<input type="file" id="purchasePhotoInput" accept="image/*" style="display: none;" onchange="handlePurchasePhotoUpload(this)">

<div style="margin-top: 8px; display: flex; gap: 8px;">
  <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearPurchasePhoto()" id="clearPurchasePhotoBtn" style="display: none;">
    <i class="bi bi-x"></i> Remove
  </button>
</div>

<div class="section-gap"></div>

<!-- Vendor -->
<label class="form-label">üè¢ Vendor Name</label>
<input type="text" class="form-control" id="purchaseVendorName" placeholder="Vendor name">

        <div class="section-gap"></div>
        
        <!-- Products -->
        <label class="form-label">üì¶ Products Purchased</label>
        <div id="purchaseProductRows" style="margin-bottom: 6px;">
          <!-- Dynamic rows -->
        </div>
        <div style="display: flex; gap: 4px;">
          <button type="button" class="btn btn-sm btn-outline-primary" onclick="addPurchaseProductRow()">
            <i class="bi bi-plus"></i> Row
          </button>

<button type="button" class="btn btn-success" onclick="openBulkAddModalForPurchase()">
  <i class="bi bi-box-seam"></i> Bulk
</button>


          
        </div>
        
        <div class="section-gap"></div>
        
        <!-- Total -->
        <label class="form-label">üí∞ Total Amount</label>
        <div class="input-group input-group-sm">
          <span class="input-group-text" style="padding: 5px 8px; font-size: 13px;">‚Çπ</span>
          <input type="number" class="form-control" id="purchaseTotalAmount" placeholder="0.00" step="0.01" min="0" style="font-weight: 600;">
        </div>
        
        <!-- Optional Payment Toggle -->
        <span class="payment-toggle" onclick="togglePaymentSection()">+ Add payment details</span>
        
        <!-- Payment Section (Hidden) -->
        <div id="paymentSection">
          <div class="section-gap"></div>
          <label class="form-label">üí≥ Payment Mode (Optional)</label>
          
          <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px;">
            <div style="position: relative; flex-shrink: 0;">
              <input type="checkbox" id="purchasePaymentCash" 
                     onchange="togglePaymentModeCheckmark(this, 'cashCheckmark')"
                     style="width: 20px; height: 20px; cursor: pointer; accent-color: #28a745;">
              <span id="cashCheckmark" style="display: none; position: absolute; top: 1px; left: 3px; font-size: 15px; color: white; pointer-events: none;">‚úì</span>
            </div>
            <label for="purchasePaymentCash" style="flex: 0 0 50px; font-size: 12px; font-weight: 600; margin: 0;">Cash</label>
            <div style="flex: 1; display: flex;">
              <span style="padding: 5px 8px; background: #f5f5f5; border: 1px solid #ccc; border-right: none; border-radius: 3px 0 0 3px; font-size: 13px;">‚Çπ</span>
              <input type="number" class="form-control" id="purchasePaymentCashAmount" placeholder="0" step="0.01" min="0" style="border-radius: 0 3px 3px 0; flex: 1;">
            </div>
          </div>
          
          <div style="display: flex; align-items: center; gap: 6px; margin-bottom: 6px;">
            <div style="position: relative; flex-shrink: 0;">
              <input type="checkbox" id="purchasePaymentOnline"
                     onchange="togglePaymentModeCheckmark(this, 'onlineCheckmark')"
                     style="width: 20px; height: 20px; cursor: pointer; accent-color: #28a745;">
              <span id="onlineCheckmark" style="display: none; position: absolute; top: 1px; left: 3px; font-size: 15px; color: white; pointer-events: none;">‚úì</span>
            </div>
            <label for="purchasePaymentOnline" style="flex: 0 0 50px; font-size: 12px; font-weight: 600; margin: 0;">Online</label>
            <div style="flex: 1; display: flex;">
              <span style="padding: 5px 8px; background: #f5f5f5; border: 1px solid #ccc; border-right: none; border-radius: 3px 0 0 3px; font-size: 13px;">‚Çπ</span>
              <input type="number" class="form-control" id="purchasePaymentOnlineAmount" placeholder="0" step="0.01" min="0" style="border-radius: 0 3px 3px 0; flex: 1;">
            </div>
          </div>
          
          <div style="display: flex; align-items: center; gap: 6px;">
            <div style="position: relative; flex-shrink: 0;">
              <input type="checkbox" id="purchasePaymentCredit"
                     onchange="togglePaymentModeCheckmark(this, 'creditCheckmark')"
                     style="width: 20px; height: 20px; cursor: pointer; accent-color: #28a745;">
              <span id="creditCheckmark" style="display: none; position: absolute; top: 1px; left: 3px; font-size: 15px; color: white; pointer-events: none;">‚úì</span>
            </div>
            <label for="purchasePaymentCredit" style="flex: 0 0 50px; font-size: 12px; font-weight: 600; margin: 0;">Credit</label>
            <div style="flex: 1; display: flex;">
              <span style="padding: 5px 8px; background: #f5f5f5; border: 1px solid #ccc; border-right: none; border-radius: 3px 0 0 3px; font-size: 13px;">‚Çπ</span>
              <input type="number" class="form-control" id="purchasePaymentCreditAmount" placeholder="0" step="0.01" min="0" style="border-radius: 0 3px 3px 0; flex: 1;">
            </div>
          </div>
          
          <div class="section-gap"></div>
          
          <!-- Notes -->
          <label class="form-label">üìù Notes</label>
          <textarea class="form-control" id="purchaseOtherInfo" rows="2" placeholder="Optional" style="font-size: 13px; padding: 5px 8px; resize: none;"></textarea>
        </div>
        
      </div>
      
      <!-- Footer -->
      <div class="modal-footer" style="padding: 6px 10px; gap: 6px; background: #f8f9fa; border-top: 1px solid #ddd;">
        <button type="button" class="btn btn-sm btn-secondary" onclick="closeRecordPurchaseModal()" style="flex: 1; height: 32px;">
          Cancel
        </button>
        <button type="button" class="btn btn-sm btn-success" onclick="submitPurchaseEntry()" style="flex: 1; height: 32px;">
          <i class="bi bi-check"></i> Submit
        </button>
      </div>
      
    </div>
  </div>
</div>

                       




  
</body>
</html>




































































































































































































































































































































































































































































